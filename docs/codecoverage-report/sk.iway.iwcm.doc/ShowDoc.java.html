<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShowDoc.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.doc</a> &gt; <span class="el_source">ShowDoc.java</span></div><h1>ShowDoc.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.doc;

import static sk.iway.iwcm.common.DocTools.testXss;

import java.io.File;
import java.io.IOException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.Enumeration;
import java.util.List;
import java.util.StringTokenizer;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.commons.lang.StringUtils;

import net.sourceforge.stripes.controller.StripesConstants;
import net.sourceforge.stripes.util.CryptoUtil;
import sk.iway.iwcm.Adminlog;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.InitServlet;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.PageLng;
import sk.iway.iwcm.PathFilter;
import sk.iway.iwcm.RequestBean;
import sk.iway.iwcm.SetCharacterEncodingFilter;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.common.BlogTools;
import sk.iway.iwcm.common.DocTools;
import sk.iway.iwcm.common.FileBrowserTools;
import sk.iway.iwcm.common.LogonTools;
import sk.iway.iwcm.components.response_header.rest.ResponseHeaderService;
import sk.iway.iwcm.doc.ninja.Amp;
import sk.iway.iwcm.doc.ninja.Ninja;
import sk.iway.iwcm.editor.service.WebpagesService;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.io.IwcmFile;
import sk.iway.iwcm.stat.BrowserDetector;
import sk.iway.iwcm.stat.StatDB;
import sk.iway.iwcm.system.ntlm.AuthenticationFilter;
import sk.iway.iwcm.system.spring.WebjetComponentParserInterface;
import sk.iway.iwcm.system.spring.events.WebjetEvent;
import sk.iway.iwcm.system.spring.events.WebjetEventType;
import sk.iway.iwcm.tags.CombineTag;
import sk.iway.iwcm.users.UserDetails;
import sk.iway.iwcm.users.UserGroupsDB;
import sk.iway.iwcm.users.UsersDB;

@WebServlet(name = &quot;ShowDoc2&quot;,
            urlPatterns = {&quot;/showdoc.do&quot;}
            )
<span class="fc" id="L62">public class ShowDoc extends HttpServlet {</span>

    private static final long serialVersionUID = 1L;

    public static final String REMAP_STRING_START = &quot;!REMAP_PAGE(&quot;;
    public static final String REMAP_STRING_END = &quot;)!&quot;;

    /**
     * sem sa uklada hash o aktualnom userovi, kontroluje to ShowDocAction
     * (ak sa v url nachadza id pouzivatela pre jeho prihlasenie)
     */
<span class="fc" id="L73">    public static String ACTUAL_USER_HASH = null;</span>

    /**
     * Skontroluje, ci parametre neobsahuju naznaky XSS, ak ano,
     * vrati redirect na URL bez skodlivych parametrov
     * inak vrati null
     * @param request HttpServletRequest
     * @return String
     */
    public static String getXssRedirectUrl(HttpServletRequest request)
    {
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">        if (!Constants.getBoolean(&quot;xssProtection&quot;)) {</span>
<span class="nc" id="L85">            return null;</span>
        }

        //umozni vypnut ochranu ak sa ide cez PreviewAction
<span class="fc bfc" id="L89" title="All 2 branches covered.">        if (&quot;true&quot;.equals(request.getAttribute(&quot;xssTestDisabled&quot;))) return null;</span>

        //skontroluj vynimky
<span class="fc" id="L92">        String constantName = &quot;xssProtectionStrictGetUrlException&quot;;</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">        if (&quot;post&quot;.equalsIgnoreCase(request.getMethod())) constantName = &quot;xssProtectionStrictPostUrlException&quot;;</span>
<span class="fc" id="L94">        String path = PathFilter.getOrigPath(request);</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">        if (DocTools.isXssStrictUrlException(path, constantName)) return null;</span>

<span class="fc" id="L97">        boolean hasXss = false;</span>
<span class="fc" id="L98">        StringBuilder redirectUrl = new StringBuilder();</span>

<span class="fc" id="L100">        Enumeration&lt;String&gt; parameters = request.getParameterNames();</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">        while (parameters.hasMoreElements())</span>
        {
<span class="fc" id="L103">           String name = parameters.nextElement();</span>
<span class="pc bpc" id="L104" title="3 of 6 branches missed.">           if (testXss(name) || name.indexOf('&quot;')!=-1 || name.indexOf('\'')!=-1)</span>
           {
<span class="nc" id="L106">               hasXss = true;</span>
<span class="nc" id="L107">               continue;</span>
           }
<span class="fc" id="L109">           String[] values = request.getParameterValues(name);</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">            for (String s : values) {</span>
<span class="fc" id="L111">                String value = s;</span>

                //robime este tu, aby sa nedalo nastavit do docid, ktore preskakujem
<span class="fc" id="L114">                boolean valueHasXss = testXss(value);</span>
                //podvrhnuty parameter _sourcePage=http://www.google.sk
<span class="pc bpc" id="L116" title="4 of 10 branches missed.">                if (!valueHasXss &amp;&amp; StripesConstants.URL_KEY_SOURCE_PAGE.equals(name) &amp;&amp; (Tools.isNotEmpty(value) &amp;&amp; CryptoUtil.decrypt(value) != null &amp;&amp; !CryptoUtil.decrypt(value).startsWith(&quot;/components/maybe&quot;)))</span>
<span class="nc" id="L117">                    valueHasXss = true;</span>
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">                if (valueHasXss) hasXss = true;</span>

                //docid nam do URL netreba
<span class="pc bpc" id="L121" title="1 of 4 branches missed.">                if (Constants.getInt(&quot;linkType&quot;) == Constants.LINK_TYPE_HTML &amp;&amp; &quot;docid&quot;.equals(name)) continue;</span>

                //pridaj parameter do URL
<span class="fc bfc" id="L124" title="All 2 branches covered.">                if (redirectUrl.length() != 0) redirectUrl.append('&amp;');</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">                if (valueHasXss) {</span>
                    //hodnotu parametra vyhodime
<span class="nc" id="L127">                    redirectUrl.append(name).append('=');</span>
                } else {
                    //vyhadzujeme niektore value, napr. password a podobne, musi to byt contains, lebo v regforme to moze byt usr.password a podobne
                    //nechceme, aby to bolo potom vidno v access logoch a podobne
<span class="fc bfc" id="L131" title="All 8 branches covered.">                    if (name.contains(&quot;password&quot;) || name.contains(&quot;email&quot;) || name.contains(&quot;phone&quot;) || name.contains(&quot;login&quot;)) {</span>
<span class="fc" id="L132">                        value = &quot;&quot;;</span>
                    }

                    //pridame celu hodnotu parametra
<span class="fc" id="L136">                    redirectUrl.append(name).append('=').append(Tools.URLEncode(value));</span>
                }
            }
<span class="fc" id="L139">        }</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">        if (hasXss)</span>
        {
<span class="nc" id="L142">            String redirUrl = PathFilter.getOrigPath(request) +&quot;?&quot;+ redirectUrl;</span>
<span class="nc" id="L143">            return Tools.sanitizeHttpHeaderParam(redirUrl);</span>
        }

<span class="fc" id="L146">        return null;</span>
    }

    /**
     *  aktualizuje kody v texte
     *
     *@param  user - identita pouzivatela
     *@param  text - text
     *@param  currentDocId - aktualne doc id
     *@param  request - aktualny request
     *@param  servletContext - ServletContext
     *@return String
     */
    public static String updateCodes(Identity user, String text, int currentDocId, HttpServletRequest request, ServletContext servletContext)
    {
<span class="fc" id="L161">        StringBuilder sb = new StringBuilder(text);</span>
<span class="fc" id="L162">        return DocTools.updateCodes(user, sb, currentDocId, request, servletContext).toString();</span>
    }

    /**
     * Nastavi do requestu rozne hodnoty z docDetails objektu (okrem data)
     * @param doc DocDetails
     * @param group GroupDetails
     * @param docDB DocDB
     * @param groupsDB GroupsDB
     * @param request HttpServletRequest
     */
    public static void setRequestData(DocDetails doc, GroupDetails group, DocDB docDB, GroupsDB groupsDB, HttpServletRequest request)
    {
<span class="fc" id="L175">        request.setAttribute(&quot;docDetails&quot;, doc);</span>

<span class="fc" id="L177">        RequestBean rb = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">        if(rb != null) {</span>
<span class="fc" id="L179">            rb.setDocId(doc.getDocId());</span>
<span class="fc" id="L180">            rb.setGroupId(doc.getGroupId());</span>
        }

<span class="fc" id="L183">        request.setAttribute(&quot;group_id&quot;, Integer.toString(doc.getGroupId()));</span>

<span class="fc" id="L185">        request.setAttribute(&quot;author_id&quot;, Integer.toString(doc.getAuthorId()));</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">        if (!Constants.getBoolean(&quot;docAuthorLazyLoad&quot;))</span>
        {
<span class="fc" id="L188">            request.setAttribute(&quot;author_name&quot;, doc.getAuthorName());</span>
<span class="fc" id="L189">            request.setAttribute(&quot;author_email&quot;, doc.getAuthorEmail());</span>
<span class="fc" id="L190">            request.setAttribute(&quot;doc_author_name&quot;, doc.getAuthorName());</span>
        }

<span class="fc" id="L193">        request.setAttribute(&quot;doc_id&quot;, doc.getDocId());</span>
<span class="fc" id="L194">        request.setAttribute(&quot;doc_title&quot;, doc.getTitle());</span>
<span class="fc" id="L195">        request.setAttribute(&quot;doc_title_original&quot;, doc.getTitle());</span>
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">        if (Constants.getBoolean(&quot;docTitleIncludePath&quot;))</span>
        {
<span class="nc" id="L198">            request.setAttribute(&quot;doc_title&quot;, DocDB.getTitleWithPath(doc));</span>
        }
<span class="fc" id="L200">        request.setAttribute(&quot;doc_navbar&quot;, doc.getNavbar());</span>
<span class="fc" id="L201">        request.setAttribute(&quot;html_head&quot;, doc.getHtmlHead());</span>
<span class="fc" id="L202">        request.setAttribute(&quot;html_data&quot;, doc.getHtmlData());</span>
<span class="fc" id="L203">        request.setAttribute(&quot;perex_data&quot;, doc.getPerex());</span>
<span class="fc" id="L204">        request.setAttribute(&quot;perex_pre&quot;, doc.getPerexPre());</span>
<span class="fc" id="L205">        request.setAttribute(&quot;perex_place&quot;, doc.getPerexPlace());</span>
<span class="fc" id="L206">        request.setAttribute(&quot;perex_image&quot;, doc.getPerexImage());</span>

<span class="pc bpc" id="L208" title="1 of 4 branches missed.">        if (doc.getPublishStartString() != null &amp;&amp; doc.getPublishStartString().length() &gt; 1)</span>
        {
<span class="fc" id="L210">            request.setAttribute(&quot;doc_publish_start&quot;, doc.getPublishStartString());</span>
        }
<span class="pc bpc" id="L212" title="1 of 4 branches missed.">        if (doc.getPublishStartTimeString() != null &amp;&amp; doc.getPublishStartTimeString().length() &gt; 1)</span>
        {
<span class="fc" id="L214">            request.setAttribute(&quot;doc_publish_start_time&quot;, doc.getPublishStartTimeString());</span>
        }
<span class="pc bpc" id="L216" title="1 of 4 branches missed.">        if (doc.getPublishEndString() != null &amp;&amp; doc.getPublishEndString().length() &gt; 1)</span>
        {
<span class="fc" id="L218">            request.setAttribute(&quot;doc_publish_end&quot;, doc.getPublishEndString());</span>
        }
<span class="pc bpc" id="L220" title="1 of 4 branches missed.">        if (doc.getPublishEndTimeString() != null &amp;&amp; doc.getPublishEndTimeString().length() &gt; 1)</span>
        {
<span class="fc" id="L222">            request.setAttribute(&quot;doc_publish_end_time&quot;, doc.getPublishEndTimeString());</span>
        }
<span class="pc bpc" id="L224" title="1 of 4 branches missed.">        if (doc.getDateCreatedString() != null &amp;&amp; doc.getDateCreatedString().length() &gt; 1)</span>
        {
<span class="fc" id="L226">            request.setAttribute(&quot;doc_date_created&quot;, doc.getDateCreatedString());</span>
        }
<span class="pc bpc" id="L228" title="1 of 4 branches missed.">        if (doc.getTimeCreatedString() != null &amp;&amp; doc.getTimeCreatedString().length() &gt; 1)</span>
        {
<span class="fc" id="L230">            request.setAttribute(&quot;doc_time_created&quot;, doc.getTimeCreatedString());</span>
        }
<span class="pc bpc" id="L232" title="1 of 4 branches missed.">        if (doc.getEventDateString() != null &amp;&amp; doc.getEventDateString().length() &gt; 1)</span>
        {
<span class="fc" id="L234">            request.setAttribute(&quot;doc_event_date&quot;, doc.getEventDateString());</span>
        }
<span class="pc bpc" id="L236" title="1 of 4 branches missed.">        if (doc.getEventTimeString() != null &amp;&amp; doc.getEventTimeString().length() &gt; 1)</span>
        {
<span class="fc" id="L238">            request.setAttribute(&quot;doc_event_time&quot;, doc.getEventTimeString());</span>
        }

<span class="fc" id="L241">        request.setAttribute(&quot;doc_temp_id&quot;, doc.getTempId());</span>

<span class="fc" id="L243">        request.setAttribute(&quot;field_a&quot;, doc.getFieldA());</span>
<span class="fc" id="L244">        request.setAttribute(&quot;field_b&quot;, doc.getFieldB());</span>
<span class="fc" id="L245">        request.setAttribute(&quot;field_c&quot;, doc.getFieldC());</span>
<span class="fc" id="L246">        request.setAttribute(&quot;field_d&quot;, doc.getFieldD());</span>
<span class="fc" id="L247">        request.setAttribute(&quot;field_e&quot;, doc.getFieldE());</span>
<span class="fc" id="L248">        request.setAttribute(&quot;field_f&quot;, doc.getFieldF());</span>
<span class="fc" id="L249">        request.setAttribute(&quot;field_g&quot;, doc.getFieldG());</span>
<span class="fc" id="L250">        request.setAttribute(&quot;field_h&quot;, doc.getFieldH());</span>
<span class="fc" id="L251">        request.setAttribute(&quot;field_i&quot;, doc.getFieldI());</span>
<span class="fc" id="L252">        request.setAttribute(&quot;field_j&quot;, doc.getFieldJ());</span>
<span class="fc" id="L253">        request.setAttribute(&quot;field_k&quot;, doc.getFieldK());</span>
<span class="fc" id="L254">        request.setAttribute(&quot;field_l&quot;, doc.getFieldL());</span>
<span class="fc" id="L255">        request.setAttribute(&quot;forum_count&quot;, doc.getForumCount());</span>

<span class="fc" id="L257">        request.setAttribute(&quot;field_m&quot;, doc.getFieldM());</span>
<span class="fc" id="L258">        request.setAttribute(&quot;field_n&quot;, doc.getFieldN());</span>
<span class="fc" id="L259">        request.setAttribute(&quot;field_o&quot;, doc.getFieldO());</span>
<span class="fc" id="L260">        request.setAttribute(&quot;field_p&quot;, doc.getFieldP());</span>
<span class="fc" id="L261">        request.setAttribute(&quot;field_q&quot;, doc.getFieldQ());</span>
<span class="fc" id="L262">        request.setAttribute(&quot;field_r&quot;, doc.getFieldR());</span>
<span class="fc" id="L263">        request.setAttribute(&quot;field_s&quot;, doc.getFieldS());</span>
<span class="fc" id="L264">        request.setAttribute(&quot;field_t&quot;, doc.getFieldT());</span>

        //set navbar
<span class="fc" id="L267">        String navbar = doc.getNavbar();</span>
        String navbar2;
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">        if (&quot;rdf&quot;.equalsIgnoreCase(Constants.getString(&quot;navbarDefaultType&quot;)))</span>
        {
<span class="nc" id="L271">            navbar2 = groupsDB.getNavbarRDF(doc.getGroupId(), doc.getDocId(), request.getSession());</span>
        }
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">        else if (&quot;schema.org&quot;.equalsIgnoreCase(Constants.getString(&quot;navbarDefaultType&quot;)))</span>
        {
<span class="nc" id="L275">            navbar2 = groupsDB.getNavbarSchema(doc.getGroupId(), doc.getDocId(), request.getSession());</span>
        }
        else
        {
<span class="fc" id="L279">            navbar2 = groupsDB.getNavbar(doc.getGroupId(), doc.getDocId(), request.getSession());</span>
        }
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">        if (navbar2.length() &gt; 2)</span>
        {
<span class="fc" id="L283">            navbar = navbar2;</span>
            //ak to nie je default doc pre grupu tak sprav linku
<span class="fc bfc" id="L285" title="All 2 branches covered.">            if (doc.getDocId() != group.getDefaultDocId())</span>
            {
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">                if (doc.getNavbar().length() &gt; 2)</span>
                {
<span class="pc bpc" id="L289" title="3 of 4 branches missed.">                    if (&quot;rdf&quot;.equalsIgnoreCase(Constants.getString(&quot;navbarDefaultType&quot;)) &amp;&amp; navbar.contains(&quot;&lt;/div&gt;&quot;))</span>
                    {
<span class="nc" id="L291">                        navbar = navbar.substring(0, navbar.length()-6) + &quot; &quot; + Constants.getString(&quot;navbarSeparator&quot;)+&quot; &lt;span&gt;&quot;+doc.getNavbar()+&quot;&lt;/span&gt;&lt;/div&gt;&quot;;</span>
                    }
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">                    else if (&quot;schema.org&quot;.equalsIgnoreCase(Constants.getString(&quot;navbarDefaultType&quot;)))</span>
                    {
<span class="nc" id="L295">                        int counter = StringUtils.countMatches(navbar, &quot;&lt;li&quot;) + 1;</span>
<span class="nc" id="L296">                        String link = docDB.getDocLink(doc.getDocId(), doc.getExternalLink(), request);</span>
<span class="nc" id="L297">                        navbar = navbar.substring(0, navbar.length() - 5);</span>
<span class="nc" id="L298">                        navbar = navbar + &quot; &lt;li class=\&quot;is-item\&quot; itemprop=\&quot;itemListElement\&quot; itemscope=\&quot;\&quot; itemtype=\&quot;http://schema.org/ListItem\&quot;&gt;&lt;a href=\&quot;&quot; + link + &quot;\&quot; class=\&quot;navbar\&quot; itemprop=\&quot;item\&quot;&gt;&lt;span itemprop=\&quot;name\&quot;&gt;&quot; + Tools.convertToHtmlTags(doc.getNavbar()) + &quot;&lt;/span&gt;&lt;/a&gt;&lt;meta itemprop=\&quot;position\&quot; content=\&quot;&quot; + counter + &quot;\&quot;&gt;&lt;/li&gt;&quot;;</span>
<span class="nc" id="L299">                        navbar += &quot;\n&lt;/ol&gt;&quot;;</span>
<span class="nc" id="L300">                    }</span>
                    else
                    {
<span class="fc" id="L303">                        navbar = navbar + &quot; &quot; + Constants.getString(&quot;navbarSeparator&quot;) + &quot; &quot; + Tools.convertToHtmlTags(doc.getNavbar());</span>
                    }
                }
            }
        }
<span class="fc" id="L308">        request.setAttribute(&quot;navbar&quot;, navbar);</span>
<span class="fc" id="L309">    }</span>

    public static void setRequestData(GroupDetails group, GroupsDB groupsDB, HttpServletRequest request)
    {
<span class="fc" id="L313">        request.setAttribute(&quot;pageGroupDetails&quot;, group);</span>

<span class="fc" id="L315">        request.setAttribute(&quot;group_name&quot;, group.getGroupName());</span>
<span class="fc" id="L316">        request.setAttribute(&quot;group_navbar&quot;, group.getNavbar());</span>
<span class="fc" id="L317">        request.setAttribute(&quot;group_htmlhead&quot;, group.getHtmlHead());</span>
<span class="fc" id="L318">        request.setAttribute(&quot;group_htmlhead_recursive&quot;, groupsDB.getHtmlHeadRecursive(group.getGroupId()));</span>
<span class="fc" id="L319">        request.setAttribute(&quot;group_field_a&quot;, group.getFieldA());</span>
<span class="fc" id="L320">        request.setAttribute(&quot;group_field_b&quot;, group.getFieldB());</span>
<span class="fc" id="L321">        request.setAttribute(&quot;group_field_c&quot;, group.getFieldC());</span>
<span class="fc" id="L322">        request.setAttribute(&quot;group_field_d&quot;, group.getFieldD());</span>
<span class="fc" id="L323">        request.setAttribute(&quot;group_lng&quot;, group.getLng());</span>
<span class="fc" id="L324">    }</span>

    /**
* Ak zadane CSS obsahuje novy riadok alebo ciarku spravi z neho automaticky Combine
* @param cssStyle String
* @return String
*/
private static String combineCss(String cssStyle)
{
<span class="fc" id="L333">       cssStyle = Tools.replace(cssStyle, &quot;\n&quot;, &quot;,&quot;);</span>
<span class="fc" id="L334">        cssStyle = Tools.replace(cssStyle, &quot;\r&quot;, &quot;&quot;);</span>

<span class="pc bpc" id="L336" title="1 of 2 branches missed.">        if (cssStyle.contains(&quot;,&quot;))</span>
        {
<span class="nc" id="L338">            return &quot;/components/_common/combine.jsp?t=css&amp;f=&quot;+cssStyle+&quot;&amp;v=&quot;+CombineTag.getVersion();</span>
        }

<span class="fc" id="L341">        return cssStyle;</span>
}

    public static void setRequestData(TemplateDetails temp, HttpServletRequest request)
	{
<span class="fc" id="L346">		request.setAttribute(&quot;templateDetails&quot;, temp);</span>

<span class="fc" id="L348">		long tempGroupId = temp.getTemplatesGroupId();</span>
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">		if (tempGroupId &gt; 0)</span>
        {
<span class="fc" id="L351">            TemplatesGroupBean tgb = TemplatesGroupDB.getInstance().getById(temp.getTemplatesGroupId());</span>
<span class="pc bpc" id="L352" title="1 of 2 branches missed.">            if (tgb != null)</span>
            {
<span class="fc" id="L354">                request.setAttribute(&quot;templatesGroupDetails&quot;, tgb);</span>

<span class="pc bpc" id="L356" title="1 of 2 branches missed.">                if (Tools.isNotEmpty(tgb.getKeyPrefix()))</span>
                {
<span class="nc" id="L358">                    RequestBean.addTextKeyPrefix(tgb.getKeyPrefix(), false);</span>
                }
            }
<span class="fc" id="L361">            request.setAttribute(&quot;templates_group_id&quot;, tempGroupId);</span>
        }

<span class="fc" id="L364">		request.setAttribute(&quot;doc_temp_name&quot;, temp.getTempName());</span>
<span class="fc" id="L365">		request.setAttribute(&quot;template_id&quot;, Integer.toString(temp.getTempId()));</span>
<span class="fc" id="L366">		request.setAttribute(&quot;template_name&quot;, temp.getTempName());</span>
<span class="fc" id="L367">		request.setAttribute(&quot;after_body&quot;, temp.getAfterBodyData());</span>
<span class="fc" id="L368">		request.setAttribute(&quot;base_css_link&quot;, combineCss(temp.getBaseCssPath()));</span>
<span class="fc" id="L369">        request.setAttribute(&quot;base_css_link_nocombine&quot;, temp.getBaseCssPath());</span>
<span class="fc" id="L370">		request.setAttribute(&quot;base_css_link_noext&quot;, Tools.replace(temp.getBaseCssPath(), &quot;.css&quot;, &quot;&quot;));</span>
<span class="pc bpc" id="L371" title="2 of 4 branches missed.">		if (temp.getCss() != null &amp;&amp; temp.getCss().length() &gt; 1)</span>
		{
<span class="nc" id="L373">			request.setAttribute(&quot;css_link&quot;, combineCss(temp.getCss()));</span>
<span class="nc" id="L374">            request.setAttribute(&quot;css_link_nocombine&quot;, temp.getCss());</span>
<span class="nc" id="L375">			request.setAttribute(&quot;css_link_noext&quot;, Tools.replace(temp.getCss(), &quot;.css&quot;, &quot;&quot;));</span>
		}

<span class="fc" id="L378">        Ninja.includeNinja(request);</span>
<span class="fc" id="L379">	}</span>

    /**
     *  Aktualizuje kody pouzivatela !LOGGED_USER_XXX! v texte
     *
     *@param  user  Description of the Parameter
     *@param  text  Description of the Parameter
     *@return       Description of the Return Value
     */
    public static String updateUserCodes(Identity user, String text)
    {
<span class="nc" id="L390">        StringBuilder sb = new StringBuilder(text);</span>
<span class="nc" id="L391">        return DocTools.updateUserCodes(user, sb).toString();</span>
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
<span class="fc" id="L397">        Logger.println(ShowDoc.class,&quot;ShowDoc SERVLET CALLED - GET&quot;);</span>
<span class="fc" id="L398">        execute(request,response);</span>
<span class="fc" id="L399">    }</span>

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
<span class="fc" id="L404">        Logger.println(ShowDoc.class,&quot;ShowDoc SERVLET CALLED - POST&quot;);</span>
<span class="fc" id="L405">        execute(request,response);</span>
<span class="fc" id="L406">    }</span>


    /**
     *  Description of the Method
     *
     * @param  request               Description of the Parameter
     * @param  response              Description of the Parameter
     * @exception  IOException       Description of the Exception
     * @exception ServletException   Description of the Exception
     */

    private void execute(
                                 HttpServletRequest request,
                                 HttpServletResponse response)
            throws IOException, ServletException
    {
<span class="fc" id="L423">        int doc_id = 1;</span>
<span class="fc" id="L424">        Prop prop = Prop.getInstance(Constants.getString(&quot;defaultLanguage&quot;));</span>


        //update stranok podla casov

        //get session
<span class="fc" id="L430">        HttpSession session = request.getSession();</span>
<span class="pc bpc" id="L431" title="1 of 2 branches missed.">        if (session == null)</span>
        {
<span class="nc" id="L433">            request.getRequestDispatcher(&quot;index&quot;).forward(request,response);</span>
<span class="nc" id="L434">            return;</span>
        }

        //over licenciu
<span class="fc bfc" id="L438" title="All 2 branches covered.">        if (session.getAttribute(&quot;license_checked&quot;) == null)</span>
        {
<span class="pc bpc" id="L440" title="1 of 2 branches missed.">            if (!InitServlet.verify(request))</span>
            {
<span class="nc" id="L442">                response.sendRedirect(&quot;https://www.interway.sk&quot;);</span>
<span class="nc" id="L443">                return;</span>
            }
        }
<span class="fc" id="L446">        session.setAttribute(&quot;license_checked&quot;, &quot;true&quot;);</span>

<span class="fc" id="L448">        Identity user = (Identity) session.getAttribute(Constants.USER_KEY);</span>
<span class="fc bfc" id="L449" title="All 2 branches covered.">        if (user == null)</span>
        {
<span class="fc" id="L451">            user = new Identity();</span>
        }

        try
        {
<span class="pc bpc" id="L456" title="1 of 2 branches missed.">            if (session.getAttribute(&quot;setCookie&quot;) != null)</span>
            {
<span class="nc" id="L458">                Cookie myCookie = (Cookie) session.getAttribute(&quot;setCookie&quot;);</span>
<span class="nc" id="L459">                Logger.println(this,&quot;setting cookie: &quot; + myCookie.getName());</span>
<span class="nc" id="L460">                Tools.addCookie(myCookie, response,request);</span>

<span class="nc" id="L462">                session.removeAttribute(&quot;setCookie&quot;);</span>
            }
        }
<span class="nc" id="L465">        catch (Exception ex)</span>
        {
<span class="nc" id="L467">            sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L468">        }</span>

<span class="fc" id="L470">        String doShowdocAction = request.getParameter(&quot;doShowdocAction&quot;);</span>
<span class="fc bfc" id="L471" title="All 2 branches covered.">        if (isDoShowdocActionAllowed(doShowdocAction))</span>
        {
            //submitujeme sa akoze na /showdoc.do, ale chceme vykonat nejaku akciu
<span class="fc" id="L474">            Logger.println(this,&quot;doShowdocAction: &quot; + doShowdocAction);</span>

<span class="fc" id="L476">            String doShowdocActionCycle = (String)request.getAttribute(&quot;doShowdocActionCycle&quot;);</span>
<span class="fc bfc" id="L477" title="All 2 branches covered.">            if (doShowdocAction.equals(doShowdocActionCycle))</span>
            {
<span class="fc" id="L479">                Logger.println(this,&quot;doShowdocActionCycle - rekurzia, preskakujem!!!!!&quot;);</span>
            }
            else
            {
                //aby sme sa nezacyklili
<span class="fc" id="L484">                request.setAttribute(&quot;doShowdocActionCycle&quot;, doShowdocAction);</span>

<span class="fc" id="L486">                request.getRequestDispatcher(doShowdocAction).forward(request, response);</span>
<span class="fc" id="L487">                return;</span>
            }
        }

<span class="fc" id="L491">        String dmail = request.getHeader(&quot;dmail&quot;);</span>

<span class="pc bpc" id="L493" title="1 of 4 branches missed.">        if (dmail != null || request.getParameter(&quot;isDmail&quot;)!=null)</span>
        {
            //vypis vsetky headre
<span class="fc" id="L496">            Enumeration&lt;String&gt; e2 = request.getHeaderNames();</span>
<span class="fc bfc" id="L497" title="All 2 branches covered.">            while (e2.hasMoreElements())</span>
            {
<span class="fc" id="L499">                String name = e2.nextElement();</span>
<span class="fc" id="L500">                String value = request.getHeader(name);</span>
<span class="fc" id="L501">                Logger.debug(ShowDoc.class, &quot;headers: &quot;+name+&quot;=&quot;+value);</span>
<span class="fc" id="L502">            }</span>
            //porovnaj to s ulozenou hodnotou
<span class="pc bpc" id="L504" title="5 of 6 branches missed.">            if (dmail!=null &amp;&amp; dmail.equals(ACTUAL_USER_HASH) &amp;&amp; request.getParameter(&quot;userid&quot;)!=null)</span>
            {
<span class="nc" id="L506">                request.setAttribute(&quot;NO WJTOOLBAR&quot;, &quot;true&quot;);</span>
<span class="nc" id="L507">                Connection db_conn = null;</span>
<span class="nc" id="L508">                PreparedStatement ps = null;</span>
<span class="nc" id="L509">                ResultSet db_result = null;</span>
                try
                {
<span class="nc" id="L512">                    int userId = Integer.parseInt(request.getParameter(&quot;userid&quot;));</span>

                    //ziskaj usera z DB
<span class="nc" id="L515">                    db_conn = DBPool.getConnection(request);</span>
<span class="nc" id="L516">                    ps = db_conn.prepareStatement(&quot;SELECT * FROM  users WHERE user_id=?&quot;);</span>
<span class="nc" id="L517">                    ps.setInt(1, userId);</span>
<span class="nc" id="L518">                    db_result = ps.executeQuery();</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">                    if (db_result.next())</span>
                    {
<span class="nc" id="L521">                        UsersDB.fillUserDetails(user, db_result);</span>
<span class="nc" id="L522">                        LogonTools.setUserToSession(session, user);</span>
<span class="nc" id="L523">                        session.setMaxInactiveInterval(30);</span>
                    }
                    else
                    {
<span class="nc" id="L527">                        Logger.error(this,&quot;user neexistuje&quot;);</span>
                    }

<span class="nc" id="L530">                    db_result.close();</span>
<span class="nc" id="L531">                    ps.close();</span>
<span class="nc" id="L532">                    db_conn.close();</span>
<span class="nc" id="L533">                    db_result = null;</span>
<span class="nc" id="L534">                    ps = null;</span>
<span class="nc" id="L535">                    db_conn = null;</span>
                }
<span class="nc" id="L537">                catch (Exception ex)</span>
                {
<span class="nc" id="L539">                    Logger.error(ShowDoc.class, ex);</span>
                }
                finally
                {
                    try
                    {
<span class="nc bnc" id="L545" title="All 2 branches missed.">                        if (db_result != null)</span>
<span class="nc" id="L546">                            db_result.close();</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">                        if (ps != null)</span>
<span class="nc" id="L548">                            ps.close();</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">                        if (db_conn != null)</span>
<span class="nc" id="L550">                            db_conn.close();</span>
                    }
<span class="nc" id="L552">                    catch (Exception ignored)</span>
                    {
                        //
<span class="nc" id="L555">                    }</span>
                }
            }
        }

        //ochrana pred XSS utokom
<span class="fc" id="L561">        String xssRedirectUrl = getXssRedirectUrl(request);</span>
<span class="pc bpc" id="L562" title="1 of 2 branches missed.">        if (xssRedirectUrl != null)</span>
        {
<span class="nc" id="L564">            response.sendRedirect(xssRedirectUrl);</span>
<span class="nc" id="L565">            return;</span>
        }

<span class="fc" id="L568">        GroupsDB groupsDB = GroupsDB.getInstance();</span>

<span class="fc" id="L570">        int historyId = -1;</span>
        try
        {
            //origdocid vyluka je kvoli zobrazeniu logon formu
<span class="pc bpc" id="L574" title="1 of 4 branches missed.">            if (request.getParameter(&quot;historyid&quot;) != null &amp;&amp; request.getParameter(&quot;origDocId&quot;)==null)</span>
            {
<span class="fc" id="L576">                historyId = Integer.parseInt(request.getParameter(&quot;historyid&quot;));</span>
<span class="pc bpc" id="L577" title="3 of 4 branches missed.">                if (!user.isAdmin() &amp;&amp; Constants.getBoolean(&quot;docBlockPublicHistory&quot;))</span>
                {
                    //vynimka pre umoznenia preview. Je potrebne mat ale zadefinovane conf. premenne showDocExceptionIPs a showDocExceptionUserId
<span class="nc" id="L580">                    String allowIps = Constants.getString(&quot;showDocExceptionIPs&quot;); //povoleny pristup z konkretnych IP, zaciatkoch IP oddelenych ciarkami</span>
<span class="nc" id="L581">                    int showDocUserId = Tools.getIntValue(Constants.getString(&quot;showDocExceptionUserId&quot;),-1); //pouzivatel, ktoreho mam prihlasit pre preview</span>
<span class="nc" id="L582">                    boolean haveToLogon = true;</span>
<span class="nc bnc" id="L583" title="All 4 branches missed.">                    if(Tools.isNotEmpty(allowIps) &amp;&amp; showDocUserId &gt; 0)</span>
                    {
<span class="nc" id="L585">                        boolean ret = true;</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">                        if (allowIps.length() &gt; 1)</span>
                        {
<span class="nc" id="L588">                            ret = false;</span>
<span class="nc" id="L589">                            StringTokenizer st = new StringTokenizer(allowIps, &quot;,&quot;);</span>
                            String ip;
<span class="nc" id="L591">                            String myIP = Tools.getRemoteIP(request);</span>
<span class="nc" id="L592">                            Logger.debug(ShowDoc.class,&quot;ShowDoc: Checking: &quot; + myIP + &quot; vs &quot; + allowIps);</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">                            while (st.hasMoreTokens())</span>
                            {
<span class="nc" id="L595">                                ip = st.nextToken();</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">                                if (myIP.startsWith(ip.trim()))</span>
                                {
<span class="nc" id="L598">                                    ret = true;</span>
<span class="nc" id="L599">                                    break;</span>
                                }
                            }
                        }
<span class="nc bnc" id="L603" title="All 2 branches missed.">                        if(ret)</span>
                        {
<span class="nc" id="L605">                            UserDetails ud = UsersDB.getUser(showDocUserId);</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">                            if(ud.getUserId() &gt; 0)</span>
                            {
<span class="nc" id="L608">                                user = new Identity(ud);</span>
<span class="nc" id="L609">                                haveToLogon = false;</span>
                            }
                        }

                    }
                    //dovolime to aj inym ludom, aby sa na to mohol pozriet aj klient alebo niekto
<span class="nc bnc" id="L615" title="All 2 branches missed.">                    if(haveToLogon) request.getRequestDispatcher(&quot;logon_admin&quot;).forward(request,response);</span>
<span class="nc" id="L616">                    return;</span>
                }
            }
        }
<span class="nc" id="L620">        catch (Exception ignored)</span>
        {
            //
<span class="fc" id="L623">        }</span>

        try
        {
<span class="fc bfc" id="L627" title="All 2 branches covered.">            if (historyId &lt; 0)</span>
            {
                //skus ziskat default doc_id ku grupe
<span class="pc bpc" id="L630" title="1 of 2 branches missed.">                if (request.getParameter(&quot;groupid&quot;) != null)</span>
                {
                    try
                    {
<span class="nc" id="L634">                        int group_id = Integer.parseInt(request.getParameter(&quot;groupid&quot;));</span>
<span class="nc" id="L635">                        GroupDetails group = groupsDB.getGroup(group_id);</span>
<span class="nc" id="L636">                        doc_id = group.getDefaultDocId();</span>
                    }
<span class="nc" id="L638">                    catch (Exception ignored)</span>
                    {
                        //
<span class="nc" id="L641">                    }</span>
                }
                //ak stale nemam doc_id ziskaj ho
                //0 je vtedy ked v DB v tabulke groups je default doc null
<span class="pc bpc" id="L645" title="3 of 4 branches missed.">                if (doc_id == 1 || doc_id == 0)</span>
                {
<span class="pc bpc" id="L647" title="1 of 2 branches missed.">                    if (request.getParameter(&quot;docid&quot;) != null)</span>
                    {
<span class="fc" id="L649">                        String docidParam = request.getParameter(&quot;docid&quot;);</span>
<span class="fc" id="L650">                        int indexOfSharp = docidParam.indexOf('#');</span>
<span class="pc bpc" id="L651" title="1 of 2 branches missed.">                        if (indexOfSharp!=-1)</span>
                        {
<span class="nc" id="L653">                            docidParam = docidParam.substring(0, indexOfSharp);</span>
                        }
<span class="fc" id="L655">                        doc_id = Integer.parseInt(docidParam);</span>
<span class="fc" id="L656">                    }</span>
                    else
                    {
<span class="nc" id="L659">                        doc_id = Integer.parseInt((String) request.getAttribute(&quot;docid&quot;));</span>
                    }
                }
            }
        }
<span class="nc" id="L664">        catch (Exception ex)</span>
        {
<span class="nc" id="L666">            StatDB.addError(request.getRequestURI()+&quot;?&quot;+request.getQueryString(), prop.getText(&quot;admin.showdoc_error_message&quot;)+&quot; 1&quot;);</span>
<span class="nc" id="L667">            request.setAttribute(&quot;err_msg&quot;, prop.getText(&quot;admin.showdoc_default_error_message&quot;));</span>
<span class="nc" id="L668">            request.getRequestDispatcher(&quot;error&quot;).forward(request,response);</span>
<span class="nc" id="L669">            return;</span>
<span class="fc" id="L670">        }</span>

        //TODO: check rights?

<span class="fc" id="L674">        DocDB docDB = DocDB.getInstance();</span>
<span class="fc" id="L675">        TemplatesDB tempDB = TemplatesDB.getInstance();</span>
        TemplateDetails temp;

<span class="fc" id="L678">        DocDetails doc = null;</span>
<span class="pc bpc" id="L679" title="1 of 6 branches missed.">        boolean inlineEditorAdmin = user != null &amp;&amp; user.isAdmin() &amp;&amp; &quot;true&quot;.equals(request.getParameter(&quot;inlineEditorAdmin&quot;));</span>

<span class="fc" id="L681">        int group_id = -1;</span>
        try
        {
<span class="fc bfc" id="L684" title="All 2 branches covered.">            if (session.getAttribute(Constants.SESSION_GROUP_ID) != null)</span>
            {
<span class="fc" id="L686">                group_id = Integer.parseInt((String) session.getAttribute(Constants.SESSION_GROUP_ID));</span>
            }
        }
<span class="nc" id="L689">        catch (Exception ex)</span>
        {
<span class="nc bnc" id="L691" title="All 2 branches missed.">            if (doc_id == -1)</span>
            {
<span class="nc" id="L693">                doc_id = -2;</span>
            }
<span class="fc" id="L695">        }</span>

<span class="fc" id="L697">        ShowDocBean showDocBean = new ShowDocBean();</span>
<span class="fc" id="L698">        showDocBean.setRequest(request);</span>
<span class="fc" id="L699">        showDocBean.setResponse(response);</span>
<span class="fc" id="L700">        showDocBean.setDoc(null);</span>
<span class="fc" id="L701">        showDocBean.setDocId(doc_id);</span>
<span class="fc" id="L702">        showDocBean.setHistoryId(historyId);</span>
<span class="fc" id="L703">        WebjetEvent&lt;ShowDocBean&gt; showdocEvent = new WebjetEvent&lt;&gt;(showDocBean, WebjetEventType.ON_START);</span>
<span class="fc" id="L704">		showdocEvent.publishEvent();</span>

<span class="fc bfc" id="L706" title="All 2 branches covered.">        if (request.getAttribute(&quot;ShowdocAction.showDocData&quot;)!=null)</span>
        {
<span class="fc" id="L708">            doc = (DocDetails)request.getAttribute(&quot;ShowdocAction.showDocData&quot;);</span>
<span class="pc bpc" id="L709" title="1 of 2 branches missed.">            if (doc != null) Logger.println(this,&quot;----&gt; IDEM Z PREVIEW, docid=&quot;+doc.getDocId()+&quot; path=&quot;+doc.getVirtualPath());</span>
        }
<span class="pc bpc" id="L711" title="1 of 2 branches missed.">        else if (showDocBean.getForceShowDoc()!=null)</span>
        {
            //vystupny doc objekt z eventu, ak sa nastavi, pouzije sa ako doc objekt pre zobrazenie web stranky cez /showdoc.do
<span class="nc" id="L714">            doc = showDocBean.getForceShowDoc();</span>
        }
        else
        {
<span class="pc bpc" id="L718" title="1 of 2 branches missed.">            if (doc_id &lt; 0)</span>
            {
                //ak je to admin
<span class="nc bnc" id="L721" title="All 4 branches missed.">                if (user.isAdmin() &amp;&amp; doc_id &lt; -1)</span>
                {
                    try
                    {
<span class="nc" id="L725">                        doc = docDB.getDoc(-doc_id);</span>
<span class="nc" id="L726">                        doc_id = -1;</span>
                    }
<span class="nc" id="L728">                    catch (Exception ignored)</span>
                    {
                        //ignore
<span class="nc" id="L731">                    }</span>
                }

<span class="nc bnc" id="L734" title="All 2 branches missed.">                if (doc == null)</span>
                {
<span class="nc" id="L736">                    doc = new DocDetails();</span>
<span class="nc" id="L737">                    doc.setDocId(-1);</span>
<span class="nc" id="L738">                    doc.setGroupId(group_id);</span>
<span class="nc" id="L739">                    doc.setData(&quot;&lt;html&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
<span class="nc" id="L740">                    doc.setTitle(&quot;novy dokument&quot;);</span>

<span class="nc" id="L742">                    doc.setNavbar(&quot;&quot;);</span>
                }
            }
            else
            {
<span class="fc bfc" id="L747" title="All 2 branches covered.">                if (historyId &gt; 0)</span>
                {
<span class="fc" id="L749">                    doc = docDB.getDoc(-1, historyId);</span>
                }
                else
                {
                    try
                    {
<span class="fc" id="L755">                        boolean useCache = true;</span>
<span class="fc bfc" id="L756" title="All 2 branches covered.">                        if (inlineEditorAdmin) useCache = false;</span>
<span class="fc" id="L757">                        doc = docDB.getDoc(doc_id, -1, useCache);</span>
                    }
<span class="nc" id="L759">                    catch (NullPointerException npe)</span>
                    {
                        //nastala chyba pripojenia do DB - vypisme chybu
<span class="nc" id="L762">                        SetCharacterEncodingFilter.printDbErrorMessage(PathFilter.getOrigPath(request), request, response);</span>

<span class="nc" id="L764">                        return;</span>
<span class="fc" id="L765">                    }</span>
                }
            }
        }

<span class="pc bpc" id="L770" title="1 of 2 branches missed.">        if (doc == null)</span>
        {
<span class="nc" id="L772">            Logger.debug(ShowDoc.class, &quot;404 (doc is null)&quot;);</span>
<span class="nc" id="L773">            request.getRequestDispatcher(&quot;/404.jsp&quot;).forward(request, response);</span>
<span class="nc" id="L774">            return;</span>
        }

        //	premapovanie web stranky na iny dokument
<span class="fc" id="L778">        int remapStart = doc.getData().indexOf(REMAP_STRING_START);</span>
<span class="pc bpc" id="L779" title="1 of 2 branches missed.">        if (remapStart!=-1)</span>
        {
            try
            {
<span class="nc" id="L783">                int remapEnd = doc.getData().indexOf(REMAP_STRING_END);</span>
<span class="nc" id="L784">                remapStart += REMAP_STRING_START.length();</span>
<span class="nc" id="L785">                int remapDocId = Tools.getIntValue(doc.getData().substring(remapStart, remapEnd), -1);</span>
<span class="nc" id="L786">                Logger.println(ShowDoc.class, &quot;remap doc id=&quot;+remapDocId);</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">                if (remapDocId &gt; 0)</span>
                {
<span class="nc" id="L789">                    DocDetails remapDoc = docDB.getDoc(remapDocId);</span>
<span class="nc bnc" id="L790" title="All 2 branches missed.">                    if (remapDoc != null)</span>
                    {
<span class="nc" id="L792">                        Logger.println(ShowDoc.class, &quot;RempaDocTitle: &quot; + remapDoc.getTitle());</span>

<span class="nc" id="L794">                        request.setAttribute(&quot;remapDocOriginal&quot;, doc);</span>

<span class="nc" id="L796">                        remapDoc.setTitle(doc.getTitle());</span>
<span class="nc" id="L797">                        remapDoc.setNavbar(doc.getNavbar());</span>
<span class="nc" id="L798">                        remapDoc.setGroupId(doc.getGroupId());</span>
<span class="nc" id="L799">                        remapDoc.setTempId(doc.getTempId());</span>

<span class="nc" id="L801">                        doc = remapDoc;</span>
                    }
                    else
                    {
<span class="nc" id="L805">                        Logger.debug(ShowDoc.class, &quot;404 (remapdoc is null)&quot;);</span>
<span class="nc" id="L806">                        request.getRequestDispatcher(&quot;/404.jsp&quot;).forward(request, response);</span>
<span class="nc" id="L807">                        return;</span>
                    }
                }
            }
<span class="nc" id="L811">            catch (Exception ex)</span>
            {
<span class="nc" id="L813">                Logger.error(ShowDoc.class, ex);</span>
<span class="nc" id="L814">            }</span>
        }

<span class="pc bpc" id="L817" title="2 of 8 branches missed.">        if (!user.isAdmin() &amp;&amp; !doc.isAvailable() &amp;&amp; historyId &lt; 0 &amp;&amp; !BlogTools.isEditable(doc.getGroupId(), user))</span>
        {
<span class="fc" id="L819">            Logger.debug(ShowDoc.class, &quot;404 (doc is not available)&quot;);</span>
<span class="fc" id="L820">            request.getRequestDispatcher(&quot;/404.jsp&quot;).forward(request, response);</span>
<span class="fc" id="L821">            return;</span>
        }

        //ak nie je pouzivatel admin a showOnlyActualPublishedDoc=true, tak zobrazi len aktualne platny clanok vid. docDB.canBeShown(doc)
<span class="pc bpc" id="L825" title="3 of 6 branches missed.">        if (!user.isAdmin() &amp;&amp; Constants.getBoolean(&quot;showOnlyActualPublishedDoc&quot;) &amp;&amp; !docDB.canBeShown(doc))</span>
        {
<span class="nc" id="L827">            String canBeShownForUserAgent = Constants.getString(&quot;canBeShownForUserAgent&quot;);</span>
<span class="nc" id="L828">            boolean found = false;</span>
<span class="nc" id="L829">            String ua = request.getHeader(&quot;User-Agent&quot;);</span>
<span class="nc bnc" id="L830" title="All 4 branches missed.">            if (Tools.isNotEmpty(canBeShownForUserAgent) &amp;&amp; ua != null)</span>
            {
<span class="nc" id="L832">                String[] canBeShownForUserAgentTokens = Tools.getTokens(canBeShownForUserAgent, &quot;,|&quot;, true);</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">                for(String t : canBeShownForUserAgentTokens)</span>
                {
<span class="nc bnc" id="L835" title="All 2 branches missed.">                    if(ua.contains(t))</span>
                    {
<span class="nc" id="L837">                        found = true;</span>
<span class="nc" id="L838">                        break;</span>
                    }
                }
            }

<span class="nc bnc" id="L843" title="All 2 branches missed.">            if(!found)</span>
            {
<span class="nc" id="L845">                Logger.debug(ShowDoc.class, &quot;404 (doc is not available)&quot;);</span>
<span class="nc" id="L846">                request.getRequestDispatcher(&quot;/404.jsp&quot;).forward(request, response);</span>
<span class="nc" id="L847">                return;</span>
            }
        }

        //httpS presmerovanie
<span class="pc bpc" id="L852" title="1 of 4 branches missed.">        if (Constants.getBoolean(&quot;httpsAvailable&quot;) &amp;&amp; &quot;GET&quot;.equalsIgnoreCase(request.getMethod()))</span>
        {
<span class="pc bpc" id="L854" title="3 of 4 branches missed.">            if (doc.isRequireSsl() &amp;&amp; !Tools.isSecure(request))</span>
            {
                //presmerovanie NON SSL na SSL
<span class="nc" id="L857">                String baseHref = Tools.getBaseHref(request);</span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">                if (baseHref.startsWith(&quot;http:&quot;)) baseHref = &quot;https:&quot;+baseHref.substring(5);</span>

<span class="nc" id="L860">                StringBuilder sb = new StringBuilder(baseHref);</span>
<span class="nc" id="L861">                sb.append(PathFilter.getOrigPath(request));</span>
<span class="nc" id="L862">                String qs = (String)request.getAttribute(&quot;path_filter_query_string&quot;);</span>
<span class="nc bnc" id="L863" title="All 2 branches missed.">                if (Tools.isNotEmpty(qs))</span>
                {
<span class="nc" id="L865">                    sb.append('?').append(qs);</span>
                }

<span class="nc" id="L868">                Logger.debug(ShowDoc.class, &quot;Redirecting to SSL:&quot;+ sb);</span>

<span class="nc" id="L870">                response.sendRedirect(sb.toString());</span>
<span class="nc" id="L871">                return;</span>
            }
<span class="pc bpc" id="L873" title="8 of 10 branches missed.">            if (!doc.isRequireSsl() &amp;&amp; Tools.isSecure(request) &amp;&amp; Tools.isNotEmpty(Constants.getString(&quot;httpsRedirectToNonSSLNodeNames&quot;)) &amp;&amp; (&quot;*&quot;.equals(Constants.getString(&quot;httpsRedirectToNonSSLNodeNames&quot;)) || Constants.getString(&quot;httpsRedirectToNonSSLNodeNames&quot;).contains(Constants.getString(&quot;clusterMyNodeName&quot;))))</span>
            {
                //presmerovanie SSL na NON SSL
<span class="nc" id="L876">                String baseHref = Tools.getBaseHref(request);</span>
<span class="nc bnc" id="L877" title="All 2 branches missed.">                if (baseHref.startsWith(&quot;https:&quot;)) baseHref = &quot;http:&quot;+baseHref.substring(6);</span>

<span class="nc" id="L879">                StringBuilder sb = new StringBuilder(baseHref);</span>
<span class="nc" id="L880">                sb.append(PathFilter.getOrigPath(request));</span>
<span class="nc" id="L881">                String qs = (String)request.getAttribute(&quot;path_filter_query_string&quot;);</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">                if (Tools.isNotEmpty(qs))</span>
                {
<span class="nc" id="L884">                    sb.append('?').append(qs);</span>
                }

<span class="nc" id="L887">                Logger.debug(ShowDoc.class, &quot;Redirecting to NON SSL:&quot;+ sb);</span>

<span class="nc" id="L889">                response.sendRedirect(sb.toString());</span>
<span class="nc" id="L890">                return;</span>
            }
        }

        //kontrola pristupovych prav

        //najskor zisti ako je na tom adresar
<span class="fc" id="L897">        GroupDetails group = groupsDB.getGroup(doc.getGroupId());</span>
        //akoze posledna zachrana
<span class="pc bpc" id="L899" title="1 of 2 branches missed.">        if (group == null) group = new GroupDetails();</span>

<span class="pc bpc" id="L901" title="2 of 6 branches missed.">        if (!Constants.getBoolean(&quot;webpagesAvailableInInternalFolders&quot;) &amp;&amp; !user.isAdmin() &amp;&amp; group.isInternal())</span>
        {
            //ak je stranka v internom adresari nezobraz ju
<span class="nc" id="L904">            Logger.println(ShowDoc.class, &quot;404 (doc is not available) - is in internal folder&quot;);</span>
<span class="nc" id="L905">            Adminlog.add(Adminlog.TYPE_XSS, &quot;Page is in internal folder, is not available for public: &quot;+doc.getDocId(), doc.getDocId(), doc.getTempId());</span>
<span class="nc" id="L906">            request.getRequestDispatcher(&quot;/404.jsp&quot;).forward(request, response);</span>
<span class="nc" id="L907">            return;</span>
        }

<span class="fc" id="L910">        setRequestData(group, groupsDB, request);</span>

<span class="fc bfc" id="L912" title="All 4 branches covered.">        if (Tools.isNotEmpty(group.getPasswordProtected()) &amp;&amp; Tools.isEmpty(doc.getPasswordProtected()))</span>
        {
<span class="fc" id="L914">            doc.setPasswordProtected(group.getPasswordProtected());</span>
        }

        //zaheslovanie vsetkeho (bez potreby nastavovania v admin casti)
<span class="fc" id="L918">        String passwordProtectedAutoId = Constants.getString(&quot;passwordProtectedAutoId&quot;);</span>
<span class="pc bpc" id="L919" title="1 of 2 branches missed.">        if (Tools.isNotEmpty(passwordProtectedAutoId))</span>
        {
<span class="nc bnc" id="L921" title="All 2 branches missed.">            if (Tools.isEmpty(doc.getPasswordProtected()))</span>
            {
<span class="nc" id="L923">                doc.setPasswordProtected(passwordProtectedAutoId);</span>
            }
            // else odstraneny
            //tie co su zaheslovane nenastavujeme, inak sa tam vzdy dostane (lebo staci jedna vyhovujuca skupina)!!!
            //doc.setPasswordProtected(passwordProtectedAutoId+&quot;,&quot;+doc.getPasswordProtected());
        }

<span class="fc" id="L930">        request.setAttribute(&quot;groupParentIds&quot;, &quot;,&quot; + groupsDB.getParents(group.getGroupId()));</span>

<span class="pc bpc" id="L932" title="1 of 2 branches missed.">        if (doc.getPasswordProtected() != null)</span>
        {
            //zisti ci dany user ma pravo na skupinu pre web stranku
<span class="fc" id="L935">            boolean canAccess = DocDB.canAccess(doc, user);</span>

            //	rekurzivne dozadu najdi LogonPageDocId
<span class="fc" id="L938">            int logonPageDocId = groupsDB.getRecursiveLogonPageDocId(group.getGroupId());</span>
<span class="pc bpc" id="L939" title="1 of 4 branches missed.">            if (logonPageDocId &gt; 0 &amp;&amp; doc.getLogonPageDocId() &lt; 1)</span>
            {
<span class="fc" id="L941">                doc.setLogonPageDocId(logonPageDocId);</span>
            }

<span class="fc bfc" id="L944" title="All 4 branches covered.">            if (doc.getLogonPageDocId() &gt; 0 &amp;&amp; doc.getLogonPageDocId() == doc_id)</span>
            {
<span class="fc" id="L946">                Logger.debug(ShowDoc.class, &quot;som logon stranka, zobrazujem&quot;);</span>
                //je to rekurzia, stranka pre prihlasenie je tiez zaheslovana,
                //takze ju musime zobrazit !!!!
<span class="fc" id="L949">                canAccess = true;</span>
            }

<span class="pc bpc" id="L952" title="1 of 4 branches missed.">            if (!canAccess &amp;&amp; Tools.isNotEmpty(AuthenticationFilter.getForbiddenURL()))</span>
            {
<span class="nc" id="L954">                StringBuilder fullPath = new StringBuilder((String)request.getAttribute(&quot;path_filter_orig_path&quot;));</span>
<span class="nc" id="L955">                String qs = (String)request.getAttribute(&quot;path_filter_query_string&quot;);</span>
<span class="nc bnc" id="L956" title="All 2 branches missed.">                if (Tools.isNotEmpty(qs)) fullPath.append('?').append(qs);</span>


<span class="nc" id="L959">                Logger.debug(ShowDoc.class, &quot;testujem forbidden URL: &quot;+ AuthenticationFilter.getForbiddenURL()+&quot; fullPath=&quot;+fullPath);</span>
<span class="nc bnc" id="L960" title="All 2 branches missed.">                if (AuthenticationFilter.getForbiddenURL().equals(fullPath.toString()))</span>
                {
<span class="nc" id="L962">                    canAccess = true;</span>
                }
            }

<span class="fc bfc" id="L966" title="All 2 branches covered.">            if (!canAccess)</span>
            {
<span class="fc" id="L968">                Logger.debug(ShowDoc.class, &quot;canAccess == false logonDocid=&quot;+doc.getLogonPageDocId()+&quot; docId=&quot;+doc.getDocId());</span>
<span class="fc" id="L969">                UserGroupsDB userGroupsDB = UserGroupsDB.getInstance();</span>
<span class="fc" id="L970">                request.setAttribute(&quot;password_protected&quot;, userGroupsDB.convertIdsToNames(doc.getPasswordProtected()));</span>
<span class="fc" id="L971">                request.setAttribute(&quot;password_protected_ids&quot;, doc.getPasswordProtected());</span>

<span class="fc" id="L973">                String domainController = Constants.getString(&quot;NTLMDomainController&quot;);</span>
<span class="pc bpc" id="L974" title="1 of 2 branches missed.">                if (Tools.isNotEmpty(domainController))</span>
                {
<span class="nc bnc" id="L976" title="All 2 branches missed.">                    if (Tools.isNotEmpty(AuthenticationFilter.getForbiddenURL()))</span>
                    {
                        //uz je prihlaseny, dame forbidden
<span class="nc" id="L979">                        StringBuilder fullPath = new StringBuilder((String)request.getAttribute(&quot;path_filter_orig_path&quot;));</span>
<span class="nc" id="L980">                        String qs = (String)request.getAttribute(&quot;path_filter_query_string&quot;);</span>
<span class="nc bnc" id="L981" title="All 2 branches missed.">                        if (Tools.isNotEmpty(qs)) fullPath.append('?').append(qs);</span>

<span class="nc" id="L983">                        response.sendRedirect(Tools.addParameterToUrlNoAmp(AuthenticationFilter.getForbiddenURL(), &quot;origUrl&quot;, fullPath.toString()));</span>
<span class="nc" id="L984">                        return;</span>
                    }
<span class="nc" id="L986">                    Logger.debug(ShowDoc.class, &quot;spustam NTLM LOGON ACTION&quot;);</span>
<span class="nc" id="L987">                    response.sendRedirect(&quot;/ntlm/logon.do?origDocId=&quot;+doc_id);</span>
<span class="nc" id="L988">                    return;</span>
                }

<span class="pc bpc" id="L991" title="1 of 2 branches missed.">                if (doc.getLogonPageDocId() &gt; 0)</span>
                {
                    //forwardni sa na stranku s prihlasovacim dialogom
<span class="fc" id="L994">                    request.setAttribute(&quot;docDetailsOriginal&quot;, doc);</span>
<span class="fc" id="L995">                    request.removeAttribute(&quot;docid&quot;);</span>
<span class="fc" id="L996">                    request.getRequestDispatcher(&quot;/showdoc.do?docid=&quot;+doc.getLogonPageDocId()+&quot;&amp;origDocId=&quot;+doc.getDocId()).forward(request, response);</span>
<span class="fc" id="L997">                    return;</span>
                }
                else
                {
                    //	toto vytvori pseudo prihlasovaciu stranku
<span class="nc" id="L1002">                    request.setAttribute(&quot;docDetailsOriginal&quot;, doc);</span>
<span class="nc" id="L1003">                    DocDetails origDoc = doc;</span>
<span class="nc" id="L1004">                    doc = new DocDetails();</span>

                    //kopirovanie properties - je to tu rucne aby sa neskopirovalo nieco co sa nema (inak by sa dalo pouzit BeanUtils)
<span class="nc" id="L1007">                    doc.setAvailable(origDoc.isAvailable());</span>
<span class="nc" id="L1008">                    doc.setTitle(origDoc.getTitle());</span>
<span class="nc" id="L1009">                    doc.setNavbar(origDoc.getNavbar());</span>

<span class="nc" id="L1011">                    doc.setTempId(origDoc.getTempId());</span>
<span class="nc" id="L1012">                    doc.setHeaderDocId(origDoc.getHeaderDocId());</span>
<span class="nc" id="L1013">                    doc.setFooterDocId(origDoc.getFooterDocId());</span>
<span class="nc" id="L1014">                    doc.setMenuDocId(origDoc.getMenuDocId());</span>
<span class="nc" id="L1015">                    doc.setRightMenuDocId(origDoc.getRightMenuDocId());</span>

<span class="nc" id="L1017">                    doc.setData(&quot;!INCLUDE(/components/user/logon.jsp)!&quot;);</span>
                }
            }
            //ak sme az tu, dokument je pre usera pristupny
        }

        //tento parameter tam nastavuje login dialog pre priame stiahnutie suboru
        //vtedy neupdatujem last_doc_id, pretoze sa prepise na hodnotu login dialogu
        //pozri PathFilter.java
<span class="fc bfc" id="L1026" title="All 2 branches covered.">        if (request.getParameter(&quot;dontUpdateLastDocId&quot;)==null)</span>
        {
<span class="fc" id="L1028">            session.setAttribute(&quot;last_doc_id&quot;, doc_id);</span>
        }

        //NOVA STATISTIKA
        try
        {
<span class="pc bpc" id="L1034" title="1 of 2 branches missed.">            if (!Constants.getBoolean(&quot;nginxProxyMode&quot;))</span>
            {
                //statistika to potrebuje
<span class="fc" id="L1037">                request.setAttribute(&quot;group_id&quot;, Integer.toString(doc.getGroupId()));</span>
<span class="fc" id="L1038">                StatDB.add(session, request, response, doc_id);</span>
            }
        }
<span class="nc" id="L1041">        catch (Exception ex)</span>
        {
<span class="nc" id="L1043">            Logger.error(ShowDoc.class, ex);</span>
<span class="fc" id="L1044">        }</span>

<span class="pc bpc" id="L1046" title="1 of 2 branches missed.">        if (Constants.getBoolean(&quot;nginxProxyMode&quot;))</span>
        {
            //setujeme iba ked sa negeneruje nocache cookie
<span class="nc bnc" id="L1049" title="All 2 branches missed.">            if (!PathFilter.isNoCacheCookieRequired(request)) {</span>
                //v rezime nginx proxy vygenerujeme cache hlavicku
<span class="nc" id="L1051">                int cacheTime = Constants.getInt(&quot;nginxProxyModePageCacheTime&quot;);</span>
<span class="nc bnc" id="L1052" title="All 6 branches missed.">                if (cacheTime&gt;0 &amp;&amp; &quot;GET&quot;.equalsIgnoreCase(request.getMethod()) &amp;&amp; request.getAttribute(&quot;is404&quot;)==null)</span>
                {
<span class="nc" id="L1054">                    PathFilter.setCacheHeaders(cacheTime, response);</span>
                }
            }
        }

<span class="fc" id="L1059">        boolean skipExternalLink = false;</span>
<span class="fc bfc" id="L1060" title="All 2 branches covered.">        if (inlineEditorAdmin) {</span>
            //ak editujeme stranku v inline nevykonaj presmerovanie
<span class="fc" id="L1062">            skipExternalLink = true;</span>
        }

        //ak to nie je urcene pre editor a mame nastavene presmerovanie na externu linku
<span class="pc bpc" id="L1066" title="2 of 8 branches missed.">        if (skipExternalLink==false &amp;&amp; request.getParameter(&quot;approveNoRedirect&quot;)==null &amp;&amp; request.getParameter(&quot;notemp&quot;) == null &amp;&amp; Tools.isNotEmpty(doc.getExternalLink()))</span>
        {
<span class="fc" id="L1068">            String externalLink = doc.getExternalLink();</span>
<span class="fc" id="L1069">            String qs = (String)request.getAttribute(&quot;path_filter_query_string&quot;);</span>
<span class="pc bpc" id="L1070" title="5 of 6 branches missed.">            if (Tools.isNotEmpty(qs) &amp;&amp; externalLink.indexOf('?')==-1 &amp;&amp; !qs.contains(&quot;docid&quot;)) externalLink += &quot;?&quot;+qs;</span>

<span class="pc bpc" id="L1072" title="2 of 4 branches missed.">            if (externalLink.startsWith(&quot;http://&quot;) || externalLink.startsWith(&quot;https://&quot;))</span>
            {
<span class="nc" id="L1074">                response.sendRedirect(externalLink);</span>
<span class="nc" id="L1075">                return ;</span>
            }
            else
            {
<span class="fc" id="L1079">                response.setStatus(301);</span>
<span class="fc" id="L1080">                externalLink = Tools.getBaseHref(request)+externalLink;</span>
<span class="fc" id="L1081">                response.setHeader(&quot;Location&quot;, externalLink);</span>
<span class="fc" id="L1082">                return ;</span>
            }
        }

        //ak mame nejake proxy data a stranka je prazdna, tak nastavme tie proxy data
<span class="fc" id="L1087">        String proxyOutputData = (String)request.getAttribute(&quot;proxyOutputData&quot;);</span>
<span class="pc bpc" id="L1088" title="5 of 6 branches missed.">        if (proxyOutputData!=null &amp;&amp; (Tools.isEmpty(doc.getData()) || doc.getData().length()&lt;20))</span>
        {
<span class="nc" id="L1090">            doc.setData(proxyOutputData);</span>
        }

<span class="pc bpc" id="L1093" title="3 of 4 branches missed.">        if (&quot;open&quot;.equals(request.getParameter(&quot;forum&quot;)) &amp;&amp; request.getAttribute(&quot;docDetailsOriginal&quot;)==null)</span>
        {
<span class="nc" id="L1095">            String type = request.getParameter(&quot;type&quot;);</span>
<span class="nc bnc" id="L1096" title="All 2 branches missed.">            if (&quot;iframe&quot;.equals(type))</span>
            {
                //request.setAttribute(&quot;doc_data&quot;, doc.getData());
<span class="nc" id="L1099">                StringBuilder iframe = new StringBuilder(&quot;&lt;iframe class='forumIframe' width='100%' height='190' &quot;);</span>
<span class="nc" id="L1100">                iframe.append(&quot;src='/showdoc.do?forumiframe=yes&amp;docid=&quot;).append(doc.getDocId()).append(&quot;'&gt;&lt;/iframe&gt;&quot;);</span>

                try
                {
<span class="nc" id="L1104">                    int start = doc.getData().indexOf(&quot;!INCLUDE(/components/forum/forum.jsp&quot;);</span>
<span class="nc bnc" id="L1105" title="All 2 branches missed.">                    if (start != -1)</span>
                    {
<span class="nc" id="L1107">                        int end = doc.getData().indexOf(&quot;)!&quot;, start);</span>
<span class="nc bnc" id="L1108" title="All 2 branches missed.">                        if (end &gt; start)</span>
                        {
<span class="nc" id="L1110">                            iframe.append(doc.getData(), start, end+2);</span>
                        }
                    }
                }
<span class="nc" id="L1114">                catch (Exception ex)</span>
                {
<span class="nc" id="L1116">                    Logger.error(ShowDoc.class, ex);</span>
<span class="nc" id="L1117">                }</span>


<span class="nc" id="L1120">                request.setAttribute(&quot;doc_data&quot;, iframe.toString());</span>
<span class="nc" id="L1121">            }</span>
<span class="nc bnc" id="L1122" title="All 2 branches missed.">            else if (&quot;perex&quot;.equals(type))</span>
            {

<span class="nc" id="L1125">                String perex = doc.getPerex();</span>
<span class="nc" id="L1126">                removeForumFromPerex(request, doc, perex);</span>
<span class="nc" id="L1127">            }</span>
<span class="nc bnc" id="L1128" title="All 2 branches missed.">            else if (&quot;none&quot;.equals(type))</span>
            {
<span class="nc" id="L1130">                String data = &quot;&quot;;</span>
<span class="nc" id="L1131">                removeForumFromPerex(request, doc, data);</span>
<span class="nc" id="L1132">            }</span>
            else
            {
<span class="nc" id="L1135">                request.setAttribute(&quot;doc_data&quot;, doc.getData());</span>
            }
<span class="nc" id="L1137">        }</span>
        else
        {
<span class="fc" id="L1140">            request.setAttribute(&quot;doc_data&quot;, doc.getData());</span>
        }

<span class="pc bpc" id="L1143" title="3 of 4 branches missed.">        if (&quot;1&quot;.equals(request.getParameter(&quot;blogEdit&quot;)) &amp;&amp; user.getUserId() &gt; 0)</span>
        {
<span class="nc" id="L1145">            boolean canEdit = BlogTools.isEditable(group.getGroupId(), user);</span>
<span class="nc bnc" id="L1146" title="All 2 branches missed.">            if (canEdit)</span>
            {
                //request.setAttribute(&quot;doc_data&quot;, &quot;!INCLUDE(/components/blog/blog_user_toolbar.jsp)!&quot;);
<span class="nc" id="L1149">                request.setAttribute(&quot;doc_data_blog&quot;, doc.getData());</span>
            }
        }

<span class="fc" id="L1153">        setRequestData(doc, group, docDB, groupsDB, request);</span>

<span class="pc bpc" id="L1155" title="1 of 4 branches missed.">        if (Tools.isNotEmpty(doc.getVirtualPath()) &amp;&amp; doc.getVirtualPath().contains(&quot;404.html&quot;))</span>
        {
<span class="nc" id="L1157">            request.setAttribute(&quot;404.allready.generated&quot;, &quot;true&quot;);</span>
<span class="nc" id="L1158">            response.setStatus(404);</span>
        }

<span class="pc bpc" id="L1161" title="1 of 6 branches missed.">        if (group.isForceTheUseOfGroupTemplate() || (inlineEditorAdmin &amp;&amp; &quot;true&quot;.equals(request.getParameter(&quot;inlineEditingNewPage&quot;)))) {</span>
<span class="fc" id="L1162">            doc.setTempId(group.getTempId());</span>
        }
<span class="fc" id="L1164">        temp = tempDB.getTemplate(doc.getTempId());</span>

<span class="pc bpc" id="L1166" title="1 of 2 branches missed.">        if (temp == null)</span>
        {
<span class="nc" id="L1168">            StatDB.addError(request.getRequestURI()+&quot;?&quot;+request.getQueryString(), prop.getText(&quot;admin.showdoc_error_message.template_error&quot;));</span>
<span class="nc" id="L1169">            request.setAttribute(&quot;err_msg&quot;, prop.getText(&quot;admin.showdoc_default_error_message&quot;));</span>
            //request.setAttribute(&quot;err_msg&quot;, &quot;Požadovaný dokument neexistuje - template error&quot;);
<span class="nc" id="L1171">            Adminlog.add(Adminlog.TYPE_RUNTIME_ERROR, &quot;Missing template for page: &quot;+doc.getDocId()+&quot;, required template id: &quot;+doc.getTempId(), doc.getDocId(), doc.getTempId());</span>
<span class="nc" id="L1172">            request.getRequestDispatcher(&quot;/404.jsp&quot;).forward(request, response);</span>
<span class="nc" id="L1173">            return;</span>
        }

        TemplateDetails tempBrowserDetector;
<span class="fc" id="L1177">        BrowserDetector bd = BrowserDetector.getInstance(request);</span>
        //skus najst sablonu podla BrowserDetector
<span class="fc" id="L1179">        tempBrowserDetector = tempDB.getTemplate(temp, bd);</span>
<span class="fc bfc" id="L1180" title="All 2 branches covered.">        if (tempBrowserDetector!=null)</span>
        {
            //ak existuje sablona napr. Homepage-phone, pouzi ju
<span class="fc" id="L1183">            temp = tempBrowserDetector;</span>
        }

<span class="fc" id="L1186">        doc.setTempName(temp.getTempName());</span>

        //nastavujem ContentLanguage podla sablony stranky
<span class="fc bfc" id="L1189" title="All 2 branches covered.">        String lng = Tools.isNotEmpty(group.getLng()) ? group.getLng() : temp.getLng();</span>

<span class="fc" id="L1191">        PageLng.setUserLng(request, response, lng);</span>
        //force:false to allow owerwrite content-language by ResponseHeaders app
<span class="fc" id="L1193">        ResponseHeaderService.setContentLanguageHeader(PageLng.getUserLngIso(lng), false, request, response);</span>

<span class="fc" id="L1195">        setRequestData(temp, request);</span>

<span class="fc" id="L1197">        Logger.debug(this,&quot;normal temp=&quot;+temp.getTempId()+&quot; &quot;+temp.getTempName());</span>

<span class="pc bpc" id="L1199" title="1 of 2 branches missed.">        if (temp.getTempName().startsWith(&quot;nochange&quot;))</span>
        {
            try
            {
<span class="nc" id="L1203">                Integer iTempId = (Integer)session.getAttribute(&quot;last_temp_id&quot;);</span>
<span class="nc bnc" id="L1204" title="All 2 branches missed.">                if (iTempId!=null)</span>
                {
<span class="nc" id="L1206">                    TemplateDetails temp2 = tempDB.getTemplate(iTempId);</span>
<span class="nc bnc" id="L1207" title="All 2 branches missed.">                    if (temp2!=null)</span>
                    {
<span class="nc" id="L1209">                        temp = temp2;</span>

<span class="nc bnc" id="L1211" title="All 2 branches missed.">                        if (temp.getTempName().startsWith(&quot;mainpage&quot;))</span>
                        {
<span class="nc" id="L1213">                            String name = temp.getTempName().substring(temp.getTempName().indexOf(' '));</span>
<span class="nc" id="L1214">                            temp2 = tempDB.getTemplate(name);</span>
<span class="nc" id="L1215">                            temp = temp2;</span>
                        }

                    }
                }
            }
<span class="nc" id="L1221">            catch (Exception ignored)</span>
            {
                //
<span class="nc" id="L1224">            }</span>
        }
        else
        {
            //popup okno si nepamatame...
<span class="pc bpc" id="L1229" title="1 of 2 branches missed.">            if (!temp.getTempName().startsWith(&quot;popup&quot;))</span>
            {
<span class="fc" id="L1231">                session.setAttribute(&quot;last_temp_id&quot;, temp.getTempId());</span>
            }
        }

        //Logger.println(this,&quot;session temp=&quot;+temp.getTempId()+&quot; &quot;+temp.getTempName());
<span class="fc" id="L1236">        List&lt;DocDetails&gt; localDocsInGroup = null;</span>

<span class="pc bpc" id="L1238" title="3 of 4 branches missed.">        if(Constants.getBoolean(&quot;templatesUseRecursiveSystemFolder&quot;) &amp;&amp; Constants.getBoolean(&quot;templatesUseDomainLocalSystemFolder&quot;))</span>
<span class="nc" id="L1239">            Logger.println(this,&quot;POZOR: templatesUseDomainLocalSystemFolder=true je ignorovane, vypni templatesUseDomainLocalSystemFolder&quot;);</span>

<span class="pc bpc" id="L1241" title="1 of 2 branches missed.">        if (Constants.getBoolean(&quot;templatesUseDomainLocalSystemFolder&quot;))</span>
        {
<span class="fc" id="L1243">            GroupDetails localSystemGroup = GroupsDB.getInstance().getLocalSystemGroup();</span>
<span class="pc bpc" id="L1244" title="1 of 2 branches missed.">            if (localSystemGroup != null)</span>
            {
                //najdi rovnaky v aktualnom local priecinku
<span class="fc" id="L1247">                localDocsInGroup = WebpagesService.getBasicDocDetailsByGroupRecursive(localSystemGroup.getGroupId(), false);</span>
            }
<span class="fc" id="L1249">        }</span>
<span class="nc bnc" id="L1250" title="All 2 branches missed.">        else if(Constants.getBoolean(&quot;templatesUseRecursiveSystemFolder&quot;))</span>
        {
<span class="nc" id="L1252">            GroupDetails systemFolder = GroupsDB.getInstance().getSystemGroupRecursive(doc.getGroupId());</span>
<span class="nc bnc" id="L1253" title="All 2 branches missed.">            Logger.debug(ShowDoc.class, &quot;recursiveSystemFolder=&quot;+(systemFolder != null ? systemFolder.getGroupId() : &quot;null&quot;));</span>
<span class="nc bnc" id="L1254" title="All 2 branches missed.">            if (systemFolder != null)</span>
            {
<span class="nc" id="L1256">                localDocsInGroup = WebpagesService.getBasicDocDetailsByGroupRecursive(systemFolder.getGroupId(), false);</span>
<span class="nc bnc" id="L1257" title="All 2 branches missed.">                Logger.debug(ShowDoc.class, &quot;localDocsInGroup=&quot;+(localDocsInGroup != null ? localDocsInGroup.size() : &quot;null&quot;));</span>
            }
        }

<span class="pc bpc" id="L1261" title="3 of 4 branches missed.">        if (localDocsInGroup == null &amp;&amp; Tools.isNotEmpty(group.getLng())) {</span>
            //aj pre nelokalny system skus nacitat zoznam stranok v system/header a system/footer
<span class="nc" id="L1263">            localDocsInGroup = WebpagesService.getBasicDocDetailsByGroupRecursive(Constants.getInt(&quot;headerFooterGroupId&quot;), false);</span>
<span class="nc" id="L1264">            localDocsInGroup.addAll(WebpagesService.getBasicDocDetailsByGroupRecursive(Constants.getInt(&quot;menuGroupId&quot;), false));</span>
        }

<span class="fc" id="L1267">        setRequestDocData(&quot;doc_header&quot;, temp.getHeaderDocId(), temp.getHeaderDocData(), localDocsInGroup, request);</span>

<span class="fc" id="L1269">        setRequestDocData(&quot;doc_footer&quot;, temp.getFooterDocId(), temp.getFooterDocData(), localDocsInGroup, request);</span>
<span class="fc" id="L1270">        setRequestDocData(&quot;doc_menu&quot;, temp.getMenuDocId(), temp.getMenuDocData(), localDocsInGroup, request);</span>
<span class="fc" id="L1271">        setRequestDocData(&quot;doc_right_menu&quot;, temp.getRightMenuDocId(), temp.getRightMenuDocData(), localDocsInGroup, request);</span>
<span class="fc" id="L1272">        setRequestDocData(&quot;template_object_a&quot;, temp.getObjectADocId(), temp.getObjectADocData(), localDocsInGroup, request);</span>
<span class="fc" id="L1273">        setRequestDocData(&quot;template_object_b&quot;, temp.getObjectBDocId(), temp.getObjectBDocData(), localDocsInGroup, request);</span>
<span class="fc" id="L1274">        setRequestDocData(&quot;template_object_c&quot;, temp.getObjectCDocId(), temp.getObjectCDocData(), localDocsInGroup, request);</span>
<span class="fc" id="L1275">        setRequestDocData(&quot;template_object_d&quot;, temp.getObjectDDocId(), temp.getObjectDDocData(), localDocsInGroup, request);</span>


<span class="fc bfc" id="L1278" title="All 2 branches covered.">        if (doc.getHeaderDocId() &gt; 0)</span>
        {
<span class="fc" id="L1280">            DocDetails dd_header = docDB.getDoc(doc.getHeaderDocId());</span>
<span class="pc bpc" id="L1281" title="1 of 2 branches missed.">            if (dd_header != null)</span>
            {
<span class="fc" id="L1283">                request.setAttribute(&quot;doc_header&quot;, dd_header.getData());</span>
            }
<span class="pc bpc" id="L1285" title="1 of 2 branches missed.">        } else if (doc.getHeaderDocId()==-2) {</span>
<span class="nc" id="L1286">            request.setAttribute(&quot;doc_header&quot;, &quot;&quot;);</span>
        }

<span class="pc bpc" id="L1289" title="1 of 2 branches missed.">        if (doc.getFooterDocId() &gt; 0)</span>
        {
<span class="nc" id="L1291">            DocDetails dd_footer = docDB.getDoc(doc.getFooterDocId());</span>
<span class="nc bnc" id="L1292" title="All 2 branches missed.">            if (dd_footer != null)</span>
            {
<span class="nc" id="L1294">                request.setAttribute(&quot;doc_footer&quot;, dd_footer.getData());</span>
            }
<span class="pc bpc" id="L1296" title="1 of 2 branches missed.">        } else if (doc.getFooterDocId()==-2) {</span>
<span class="nc" id="L1297">            request.setAttribute(&quot;doc_footer&quot;, &quot;&quot;);</span>
        }

<span class="pc bpc" id="L1300" title="1 of 2 branches missed.">        if (doc.getMenuDocId() &gt; 0)</span>
        {
<span class="nc" id="L1302">            DocDetails dd_menu = docDB.getDoc(doc.getMenuDocId());</span>
<span class="nc bnc" id="L1303" title="All 2 branches missed.">            if (dd_menu != null)</span>
            {
<span class="nc" id="L1305">                request.setAttribute(&quot;doc_menu&quot;, dd_menu.getData());</span>
            }
<span class="pc bpc" id="L1307" title="1 of 2 branches missed.">        } else if (doc.getMenuDocId()==-2) {</span>
<span class="nc" id="L1308">            request.setAttribute(&quot;doc_menu&quot;, &quot;&quot;);</span>
        }

<span class="pc bpc" id="L1311" title="1 of 2 branches missed.">        if (doc.getRightMenuDocId() &gt; 0)</span>
        {
<span class="nc" id="L1313">            DocDetails dd_menu = docDB.getDoc(doc.getRightMenuDocId());</span>
<span class="nc bnc" id="L1314" title="All 2 branches missed.">            if (dd_menu != null)</span>
            {
<span class="nc" id="L1316">                request.setAttribute(&quot;doc_right_menu&quot;, dd_menu.getData());</span>
            }
<span class="pc bpc" id="L1318" title="1 of 2 branches missed.">        } else if (doc.getRightMenuDocId()==-2) {</span>
<span class="nc" id="L1319">            request.setAttribute(&quot;doc_right_menu&quot;, &quot;&quot;);</span>
        }

        //firni event
<span class="fc" id="L1323">        showDocBean.setDoc(doc);</span>
<span class="fc" id="L1324">        showdocEvent = new WebjetEvent&lt;&gt;(showDocBean, WebjetEventType.ON_END);</span>
<span class="fc" id="L1325">		showdocEvent.publishEvent();</span>

        //uprav headre a footre
<span class="pc bpc" id="L1328" title="1 of 2 branches missed.">        if (request.getParameter(&quot;notemp&quot;) == null)</span>
        {
<span class="fc" id="L1330">            updateCodes(request, null, doc_id);</span>
        }

<span class="fc bfc" id="L1333" title="All 2 branches covered.">        if (!doc.isSearchable())</span>
        {
<span class="fc" id="L1335">            PathFilter.setXRobotsTagValue(&quot;NOT_SEARCHABLE_PAGE&quot;, response);</span>
        }

<span class="fc" id="L1338">        String forward = temp.getForward();</span>

<span class="pc bpc" id="L1340" title="1 of 2 branches missed.">        if (request.getParameter(&quot;print&quot;) != null)</span>
        {
<span class="nc" id="L1342">            forward = &quot;tmp_print&quot;;</span>
        }

<span class="pc bpc" id="L1345" title="1 of 2 branches missed.">        if (request.getParameter(&quot;forumiframe&quot;) != null)</span>
        {
<span class="nc" id="L1347">            forward = &quot;forumiframe&quot;;</span>
        }

<span class="pc bpc" id="L1350" title="3 of 4 branches missed.">        if (request.getParameter(&quot;forward&quot;) != null &amp;&amp; request.getParameter(&quot;forward&quot;).endsWith(&quot;.jsp&quot;))</span>
        {
<span class="nc" id="L1352">            forward = request.getParameter(&quot;forward&quot;);</span>
        }

<span class="pc bpc" id="L1355" title="1 of 2 branches missed.">        if (request.getParameter(&quot;forwarddoccompare&quot;) != null)</span>
        {
<span class="nc" id="L1357">            forward = &quot;docCompareBlank&quot;;</span>
        }

<span class="pc bpc" id="L1360" title="1 of 2 branches missed.">        if (request.getParameter(&quot;notemp&quot;) != null)</span>
        {
<span class="nc" id="L1362">            forward = &quot;no_temp&quot;;</span>
        }

<span class="pc bpc" id="L1365" title="1 of 2 branches missed.">        if (Constants.getBoolean(&quot;springEnableShowdoc&quot;))</span>
        {
<span class="fc" id="L1367">            RequestBean requestBean = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="pc bpc" id="L1368" title="1 of 2 branches missed.">            if (requestBean != null) {</span>
<span class="fc" id="L1369">                WebjetComponentParserInterface webjetComponentParser = requestBean.getSpringBean(&quot;webjetComponentParser&quot;, WebjetComponentParserInterface.class);</span>
<span class="pc bpc" id="L1370" title="1 of 2 branches missed.">                if (webjetComponentParser != null) {</span>
<span class="fc" id="L1371">                    webjetComponentParser.run(request, response);</span>
<span class="pc bpc" id="L1372" title="1 of 2 branches missed.">                    if (webjetComponentParser.isRedirected(response)) {</span>
<span class="nc" id="L1373">                        return;</span>
                    }
                }
            }
        }

<span class="fc" id="L1379">        BrowserDetector browser = BrowserDetector.getInstance(request);</span>
<span class="pc bpc" id="L1380" title="1 of 2 branches missed.">        if (browser.isAmp()) {</span>
<span class="nc" id="L1381">            Amp amp = new Amp(request);</span>
<span class="nc" id="L1382">            amp.replaceInRequest();</span>
        }

<span class="fc bfc" id="L1385" title="All 2 branches covered.">        if (inlineEditorAdmin) fixDataForInlineEditingAdmin(request, prop);</span>

        //forward na JSP s designom
<span class="pc bpc" id="L1388" title="1 of 4 branches missed.">        if (forward.toLowerCase().endsWith(&quot;.jsp&quot;) || forward.toLowerCase().endsWith(&quot;.html&quot;))</span>
        {
            //otestuj na nepovolene znaky
<span class="pc bpc" id="L1391" title="1 of 2 branches missed.">            if ( FileBrowserTools.hasForbiddenSymbol(forward) )</span>
            {
<span class="nc" id="L1393">                forward = &quot;tmp_generic.jsp&quot;;</span>
            }

<span class="fc" id="L1396">            request.setAttribute(&quot;template_forward&quot;, forward);</span>
<span class="pc bpc" id="L1397" title="1 of 2 branches missed.">            if (!temp.getForward().startsWith(&quot;/&quot;))</span>
            {
                //skontroluj, ci sablona skutocne existuje

<span class="fc" id="L1401">                forward = getForward(request, prop, tempBrowserDetector, bd, forward);</span>
<span class="pc bpc" id="L1402" title="1 of 2 branches missed.">                if (forward == null) return;</span>

<span class="fc" id="L1404">                Logger.debug(this,&quot;forward=&quot;+forward);</span>
            }

<span class="pc bpc" id="L1407" title="1 of 2 branches missed.">            if (!forward.startsWith(&quot;/templates&quot;)) {</span>
<span class="nc" id="L1408">                forward = &quot;/templates/&quot;+forward;</span>
            }

<span class="fc" id="L1411">            IwcmFile forwardFile = getTemplateFile(forward);</span>
<span class="pc bpc" id="L1412" title="1 of 2 branches missed.">            if (!forwardFile.isFile())</span>
            {
<span class="nc" id="L1414">                Adminlog.add(Adminlog.TYPE_RUNTIME_ERROR, &quot;Missing template for page: &quot;+doc.getDocId()+&quot;, required template file: &quot;+forward, doc.getDocId(), doc.getTempId());</span>
<span class="nc" id="L1415">                forward = &quot;/404.jsp&quot;;</span>
            }

<span class="fc bfc" id="L1418" title="All 2 branches covered.">            if (forward.toLowerCase().endsWith(&quot;.html&quot;)) {</span>
<span class="fc" id="L1419">                request.setAttribute(&quot;thymeleafTemplateFile&quot;, forwardFile.getVirtualPath());</span>
<span class="fc" id="L1420">                forward = &quot;/thymeleaf/showdoc&quot;;</span>
            }

<span class="fc" id="L1423">            request.getRequestDispatcher(forward).forward(request, response);</span>
        }
<span class="fc" id="L1425">    }</span>

    /**
     * Modifikuje existujuce request objekty pre inline editaciu v administracii
     * @param request
     */
    private void fixDataForInlineEditingAdmin(HttpServletRequest request, Prop prop) {
<span class="fc bfc" id="L1432" title="All 2 branches covered.">        if (&quot;true&quot;.equals(request.getParameter(&quot;inlineEditingNewPage&quot;))) {</span>
            //jedna sa o novu stranku, ale fejkujeme to hlavnou strankou adresara
            //zmazeme povodne doc_data
<span class="fc" id="L1435">            request.setAttribute(&quot;doc_data&quot;, &quot;&quot;);</span>
<span class="fc" id="L1436">            request.setAttribute(&quot;title&quot;, prop.getText(&quot;editor.newDocumentName&quot;));</span>
        }
        //toto nepotrebujeme posielat, injectuje sa to v inline_page_toolbar.jsp
<span class="fc" id="L1439">        request.setAttribute(&quot;doc_data&quot;, &quot;&quot;);</span>
<span class="fc" id="L1440">        request.setAttribute(&quot;doc_header&quot;, &quot;&quot;);</span>
<span class="fc" id="L1441">        request.setAttribute(&quot;doc_footer&quot;, &quot;&quot;);</span>
<span class="fc" id="L1442">        request.setAttribute(&quot;doc_menu&quot;, &quot;&quot;);</span>
<span class="fc" id="L1443">        request.setAttribute(&quot;doc_right_menu&quot;, &quot;&quot;);</span>
<span class="fc" id="L1444">        request.setAttribute(&quot;template_object_a&quot;, &quot;&quot;);</span>
<span class="fc" id="L1445">        request.setAttribute(&quot;template_object_b&quot;, &quot;&quot;);</span>
<span class="fc" id="L1446">        request.setAttribute(&quot;template_object_c&quot;, &quot;&quot;);</span>
<span class="fc" id="L1447">        request.setAttribute(&quot;template_object_d&quot;, &quot;&quot;);</span>
<span class="fc" id="L1448">        request.setAttribute(&quot;perex_data&quot;, &quot;&quot;);</span>
<span class="fc" id="L1449">    }</span>

    private void removeForumFromPerex(HttpServletRequest request, DocDetails doc, String perex) {
        try
        {
<span class="nc" id="L1454">            int start = doc.getData().indexOf(&quot;!INCLUDE(/components/forum/forum.jsp&quot;);</span>
<span class="nc bnc" id="L1455" title="All 2 branches missed.">            if (start != -1)</span>
            {
<span class="nc" id="L1457">                int end = doc.getData().indexOf(&quot;)!&quot;, start);</span>
<span class="nc bnc" id="L1458" title="All 2 branches missed.">                if (end &gt; start)</span>
                {
<span class="nc" id="L1460">                    perex += doc.getData().substring(start, end+2);</span>
                }
            }
        }
<span class="nc" id="L1464">        catch (Exception ex)</span>
        {
<span class="nc" id="L1466">            Logger.error(ShowDoc.class, ex);</span>
<span class="nc" id="L1467">        }</span>

<span class="nc" id="L1469">        request.setAttribute(&quot;doc_data&quot;, perex);</span>
<span class="nc" id="L1470">    }</span>

    private String getForward(HttpServletRequest request, Prop prop, TemplateDetails tempBrowserDetector, BrowserDetector bd, String forward) {
        try {
            //ak mame sablonu pre browserDevice, uz nehladame iny JSP subor pre forward
<span class="pc bpc" id="L1475" title="1 of 4 branches missed.">            if (tempBrowserDetector != null &amp;&amp; tempBrowserDetector.getTempId() &gt; 0) bd = null;</span>

<span class="pc bpc" id="L1477" title="1 of 2 branches missed.">            if (Tools.isNotEmpty(Constants.getLogInstallName()))</span>
            {
<span class="nc" id="L1479">                File f = TemplatesDB.getDeviceTemplateFile(new File(Tools.getRealPath(&quot;/templates/&quot; + Constants.getLogInstallName())), forward, bd);</span>
<span class="nc bnc" id="L1480" title="All 2 branches missed.">                if (f.exists()) {</span>
<span class="nc" id="L1481">                    Logger.debug(ShowDoc.class, &quot;___FORWARDFILE (logInstallName)=&quot;+ f.getAbsolutePath());</span>
<span class="nc" id="L1482">                    return &quot;/templates/&quot; + Constants.getLogInstallName() + &quot;/&quot; + forward;</span>
                }
            }

<span class="fc" id="L1486">            File f = TemplatesDB.getDeviceTemplateFile(new File(Tools.getRealPath(&quot;/templates/&quot; + Constants.getInstallName())), forward, bd);</span>
<span class="pc bpc" id="L1487" title="1 of 2 branches missed.">            if (f.exists()) {</span>
<span class="fc" id="L1488">                Logger.debug(ShowDoc.class, &quot;___FORWARDFILE (installName)=&quot;+ f.getAbsolutePath());</span>
<span class="fc" id="L1489">                return &quot;/templates/&quot; + Constants.getInstallName() + &quot;/&quot; + forward;</span>
            }

<span class="nc" id="L1492">            f = TemplatesDB.getDeviceTemplateFile(new File(Tools.getRealPath(&quot;/templates/&quot;)), forward, bd);</span>
<span class="nc bnc" id="L1493" title="All 2 branches missed.">            if (!f.exists()) {</span>
<span class="nc" id="L1494">                StatDB.addError(request.getRequestURI() + &quot;?&quot; + request.getQueryString(), prop.getText(&quot;admin.showdoc_error_message.template&quot;) + &quot; &quot; + forward + &quot; &quot; + prop.getText(&quot;admin.showdoc_error_message.not_exists&quot;) + &quot;!&quot;);</span>
<span class="nc" id="L1495">                Logger.error(this, prop.getText(&quot;admin.showdoc_error_message.template&quot;) + &quot; /templates/&quot; + forward + &quot; &quot; + prop.getText(&quot;admin.showdoc_error_message.not_exists=&quot;) + &quot;!&quot;);</span>
                //sablona neexistuje, asi som na testovacom serveri u jeeffa...

<span class="nc" id="L1498">                forward = &quot;tmp_generic.jsp&quot;;</span>
            }
            // else zrusene, aby islo zadat forward aj s adresarom forward = f.getName();
<span class="nc" id="L1501">        } catch (Exception e) {</span>
<span class="nc" id="L1502">            Logger.error(ShowDoc.class, e);</span>
<span class="nc" id="L1503">        }</span>
<span class="nc" id="L1504">        return forward;</span>
    }


    /**
     * Vrati lokalne doc_data pre zadane doc_id (hlada napr. hlavicku v lokalnom System adresari pre danu domenu)
     */
    private static void setRequestDocData(String name, int defaultDocId, String defaultData, List&lt;DocDetails&gt; localDocsInGroup, HttpServletRequest request)
    {
<span class="fc" id="L1513">        DocDB docDB = DocDB.getInstance();</span>
<span class="fc" id="L1514">        DocDetails originalDoc = docDB.getBasicDocDetails(defaultDocId, false);</span>

<span class="pc bpc" id="L1516" title="1 of 4 branches missed.">        if (originalDoc != null &amp;&amp; localDocsInGroup != null)</span>
        {
<span class="fc" id="L1518">            String groupLng = (String)request.getAttribute(&quot;group_lng&quot;);</span>

<span class="fc" id="L1520">            DocDetails foundDoc = null;</span>
<span class="fc bfc" id="L1521" title="All 2 branches covered.">            if (Tools.isNotEmpty(groupLng))</span>
            {
                //ak je nastaveny jazyk adresara, tak najprv kontrolujem jazykovu zhodu bud ako prefix jazyk + medzera napr. &quot;EN header&quot;, alebo ako suffix pomlcka+jazyk napr. &quot;header-DE&quot;
<span class="fc bfc" id="L1524" title="All 2 branches covered.">                for (DocDetails localDoc : localDocsInGroup)</span>
                {
<span class="pc bpc" id="L1526" title="1 of 2 branches missed.">                    if (localDoc.getTitle().equalsIgnoreCase(groupLng+&quot; &quot;+originalDoc.getTitle()) ||</span>
<span class="pc bpc" id="L1527" title="1 of 2 branches missed.">                            localDoc.getTitle().equalsIgnoreCase(groupLng+&quot;-&quot;+originalDoc.getTitle()) ||</span>
<span class="pc bpc" id="L1528" title="1 of 2 branches missed.">                            localDoc.getTitle().equalsIgnoreCase(originalDoc.getTitle()+&quot;-&quot;+groupLng))</span>
                    {
<span class="nc" id="L1530">                        foundDoc = localDoc;</span>
<span class="nc" id="L1531">                        break;</span>
                    }
                    //ak mame nastavenu SK-Default hlavicka, skus odstranit SK- a porovnat ako EN-Default hlavicka
<span class="fc" id="L1534">                    String originalTitle = originalDoc.getTitle();</span>
<span class="pc bpc" id="L1535" title="4 of 6 branches missed.">                    if (originalTitle.length()&gt;4 &amp;&amp; originalTitle.charAt(2)=='-' &amp;&amp; localDoc.getTitle().equalsIgnoreCase(groupLng+&quot;-&quot;+originalTitle.substring(3))) {</span>
<span class="nc" id="L1536">                        foundDoc = localDoc;</span>
<span class="nc" id="L1537">                        break;</span>
                    }
<span class="fc" id="L1539">                }</span>
            }

            //ak nie je nastaveny jazyk, postupujem ako predtym a hladam na zaklade zhody titulov stranok
<span class="pc bpc" id="L1543" title="1 of 2 branches missed.">            if(foundDoc == null)</span>
            {
<span class="fc bfc" id="L1545" title="All 2 branches covered.">                for (DocDetails localDoc : localDocsInGroup)</span>
                {
<span class="pc bpc" id="L1547" title="1 of 4 branches missed.">                    if(localDoc.getDocId()!=defaultDocId &amp;&amp; localDoc.getTitle().equalsIgnoreCase(originalDoc.getTitle()))</span>
                    {
<span class="nc" id="L1549">                        foundDoc = localDoc;</span>
<span class="nc" id="L1550">                        break;</span>
                    }
<span class="fc" id="L1552">                }</span>
            }

<span class="pc bpc" id="L1555" title="1 of 2 branches missed.">            if(foundDoc != null)</span>
            {
<span class="nc" id="L1557">                String docData = foundDoc.getData();</span>
<span class="nc bnc" id="L1558" title="All 2 branches missed.">                if (Tools.isEmpty(docData))</span>
                {
<span class="nc" id="L1560">                    foundDoc = docDB.getDocAndAddToCacheIfNot(foundDoc.getDocId());</span>
<span class="nc" id="L1561">                    docData = foundDoc.getData();</span>
                }
<span class="nc bnc" id="L1563" title="All 4 branches missed.">                if (Tools.isNotEmpty(docData) || &quot;cloud&quot;.equals(Constants.getInstallName()))</span>
                {
                    //v cloude chceme zobrazit userovu paticku aj ked v nej zmazal text (chce ju mat prazdnu)
<span class="nc" id="L1566">                    defaultData = docData;</span>
<span class="nc" id="L1567">                    defaultDocId = foundDoc.getDocId();</span>
<span class="nc" id="L1568">                    request.setAttribute(name+&quot;-docDetails&quot;, foundDoc);</span>
                }
            }
        }

<span class="fc bfc" id="L1573" title="All 2 branches covered.">        if (request.getSession().getAttribute(Constants.USER_KEY)!=null)</span>
        {
            //ak je prihlaseny user setni objekt aby isla inline editacia inych objektov ako doc_data
<span class="fc" id="L1576">            request.setAttribute(name+&quot;-docDetails&quot;, originalDoc);</span>
        }

        //nastav aj hodnotu docId pre inline editaciu
<span class="fc" id="L1580">        request.setAttribute(name, defaultData);</span>
<span class="fc" id="L1581">        request.setAttribute(name+&quot;-docId=&quot;, defaultDocId);</span>
<span class="fc" id="L1582">    }</span>


    /**
     *  Aktualizuje kody v request (doc_header, doc_footer, doc_menu, doc_data)
     *
     *@param  request HttpServletRequest
     *@param  servletContext ServletContext
     *@param  docId int
     */
    public static void updateCodes(HttpServletRequest request, ServletContext servletContext, int docId)
    {
        try
        {
<span class="fc" id="L1596">            HttpSession session = request.getSession();</span>
<span class="fc" id="L1597">            Identity user = null;</span>
            try
            {
                //ziskaj meno lognuteho usera
<span class="fc bfc" id="L1601" title="All 2 branches covered.">                if (session.getAttribute(Constants.USER_KEY) != null)</span>
                {
<span class="fc" id="L1603">                    user = (Identity) session.getAttribute(Constants.USER_KEY);</span>
                }
            }
<span class="nc" id="L1606">            catch (Exception ex)</span>
            {
<span class="nc" id="L1608">                Logger.error(ShowDoc.class, ex);</span>
<span class="fc" id="L1609">            }</span>

            // ------------ HEADER
<span class="fc" id="L1612">            String text = (String) request.getAttribute(&quot;doc_header&quot;);</span>
<span class="pc bpc" id="L1613" title="1 of 2 branches missed.">            if (text != null)</span>
            {
<span class="fc" id="L1615">                text = ShowDoc.updateCodes(user, text, docId, request, servletContext);</span>
            }

<span class="fc" id="L1618">            request.setAttribute(&quot;doc_header&quot;, text);</span>

            // ------------------ FOOTER
<span class="fc" id="L1621">            text = (String) request.getAttribute(&quot;doc_footer&quot;);</span>
<span class="pc bpc" id="L1622" title="1 of 2 branches missed.">            if (text != null)</span>
            {
<span class="fc" id="L1624">                text = ShowDoc.updateCodes(user, text, docId, request, servletContext);</span>
            }
<span class="fc" id="L1626">            request.setAttribute(&quot;doc_footer&quot;, text);</span>

            // ------------------ MENU
<span class="fc" id="L1629">            text = (String) request.getAttribute(&quot;doc_menu&quot;);</span>
<span class="pc bpc" id="L1630" title="1 of 2 branches missed.">            if (text != null)</span>
            {
<span class="fc" id="L1632">                text = ShowDoc.updateCodes(user, text, docId, request, servletContext);</span>
            }
<span class="fc" id="L1634">            request.setAttribute(&quot;doc_menu&quot;, text);</span>

            // ------------------ MENU RIGHT
<span class="fc" id="L1637">            text = (String) request.getAttribute(&quot;doc_right_menu&quot;);</span>
<span class="pc bpc" id="L1638" title="1 of 2 branches missed.">            if (text != null)</span>
            {
<span class="fc" id="L1640">                text = ShowDoc.updateCodes(user, text, docId, request, servletContext);</span>
            }
<span class="fc" id="L1642">            request.setAttribute(&quot;doc_right_menu&quot;, text);</span>

            // ------------------ html_data
<span class="fc" id="L1645">            text = (String) request.getAttribute(&quot;html_data&quot;);</span>
<span class="pc bpc" id="L1646" title="1 of 2 branches missed.">            if (text != null)</span>
            {
<span class="fc" id="L1648">                text = ShowDoc.updateCodes(user, text, docId, request, servletContext);</span>
            }
<span class="fc" id="L1650">            request.setAttribute(&quot;html_data&quot;, text);</span>

            // ------------------ DOC
<span class="fc" id="L1653">            text = (String) request.getAttribute(&quot;doc_data&quot;);</span>
<span class="pc bpc" id="L1654" title="1 of 2 branches missed.">            if (text != null)</span>
            {
<span class="fc" id="L1656">                text = ShowDoc.updateCodes(user, text, docId, request, servletContext);</span>
            }

<span class="fc" id="L1659">            request.setAttribute(&quot;doc_data&quot;, text);</span>
        }
<span class="nc" id="L1661">        catch (Exception ignored)</span>
        {
            //
<span class="fc" id="L1664">        }</span>
<span class="fc" id="L1665">    }</span>




    private IwcmFile getTemplateFile(String template)
    {
<span class="fc" id="L1672">        return new IwcmFile(Tools.getRealPath(template));</span>
    }

    public static void setActualUserHash(String hash) {
<span class="nc" id="L1676">        ShowDoc.ACTUAL_USER_HASH = hash;</span>
<span class="nc" id="L1677">    }</span>

    /**
     * Test if doShowdocAction request parameter is allowed/valid
     * @param doShowdocAction
     * @return
     */
    public static boolean isDoShowdocActionAllowed(String doShowdocAction) {
<span class="pc bpc" id="L1685" title="4 of 10 branches missed.">        if (doShowdocAction != null &amp;&amp; doShowdocAction.length()&gt;3 &amp;&amp; !doShowdocAction.contains(&quot;WEB-INF&quot;) &amp;&amp; doShowdocAction.endsWith(&quot;.do&quot;) &amp;&amp; !doShowdocAction.contains(&quot;/admin/&quot;)) {</span>
<span class="fc" id="L1686">         return true;</span>
        }
<span class="fc" id="L1688">        return false;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>