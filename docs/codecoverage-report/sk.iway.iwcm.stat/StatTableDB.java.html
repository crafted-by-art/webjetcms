<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StatTableDB.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.stat</a> &gt; <span class="el_source">StatTableDB.java</span></div><h1>StatTableDB.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.stat;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DB;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.InitServlet;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.doc.DocDB;
import sk.iway.iwcm.doc.DocDetails;
import sk.iway.iwcm.doc.GroupsDB;
import sk.iway.iwcm.i18n.Prop;

/**
 *
 *  StatTableDB.java
 *
 *@Title        WebJET
 *@Company      Interway s.r.o. (www.interway.sk)
 *@Copyright    Interway s.r.o. (c) 2001-2005
 *@author       $Author: jeeff $
 *@version      $Revision: 1.29 $
 *@created      Date: 10.12.2005 14:34:04
 */
public class StatTableDB {

<span class="nc" id="L40">	protected StatTableDB() {</span>
		//utility class
<span class="nc" id="L42">	}</span>

	public static List&lt;Column&gt; getCountry(int maxRows, java.util.Date from, java.util.Date to, String groupIdsQuery)
	{
<span class="nc" id="L46">		return getCountry( maxRows, from, to, groupIdsQuery, false);</span>
	}

	/**
	 *  statistika pristupov podla krajin usporiadana podla views
	 *
	 *@param  max_size  Description of the Parameter
	 *@param  from      Description of the Parameter
	 *@param  to        Description of the Parameter
	 *@return           The country value
	 */
	public static List&lt;Column&gt; getCountry(int maxRows, java.util.Date from, java.util.Date to, String groupIdsQuery, boolean withoutBots)
	{
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">		if (groupIdsQuery == null)</span>
		{
<span class="nc" id="L61">			groupIdsQuery = &quot;&quot;;</span>
		}

<span class="fc" id="L64">		Map&lt;String, Number&gt; map = new HashMap&lt;&gt;();</span>

<span class="fc" id="L66">		String whitelistedQuery = &quot;&quot;;</span>
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">		if(withoutBots)</span>
<span class="nc" id="L68">			whitelistedQuery = StatNewDB.getWhiteListedUAQuery();</span>

<span class="fc" id="L70">		String[] suffixes = StatNewDB.getTableSuffix(null, from.getTime(), to.getTime());</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="fc" id="L73">			Connection db_conn = null;</span>
<span class="fc" id="L74">			PreparedStatement ps = null;</span>
<span class="fc" id="L75">			ResultSet rs = null;</span>
			try
			{
<span class="fc" id="L78">				String sql = &quot;SELECT DISTINCT country, count(country) as views FROM stat_views&quot;+suffixes[s]+&quot; WHERE view_time&gt;=? AND view_time&lt;? &quot; + groupIdsQuery + whitelistedQuery + &quot; GROUP BY country&quot;;</span>
<span class="fc" id="L79">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L80">				ps = StatNewDB.prepareStatement(db_conn, sql);</span>
<span class="fc" id="L81">				ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="fc" id="L82">				ps.setTimestamp(2, new Timestamp(to.getTime()));</span>
<span class="fc" id="L83">				rs = ps.executeQuery();</span>
				//iteruj cez riadky
<span class="fc bfc" id="L85" title="All 2 branches covered.">				while (rs.next())</span>
				{
<span class="fc" id="L87">					String key = rs.getString(&quot;country&quot;);</span>

<span class="pc bpc" id="L89" title="2 of 4 branches missed.">					if (key==null || &quot;unk&quot;.equals(key)) key = &quot;unkn&quot;;</span>

<span class="fc" id="L91">					Number currentValue = map.get(key);</span>

<span class="pc bpc" id="L93" title="1 of 2 branches missed.">					if (currentValue == null) map.put(key, Integer.valueOf(rs.getInt(&quot;views&quot;)));</span>
<span class="nc" id="L94">					else map.put(key, Integer.valueOf(rs.getInt(&quot;views&quot;)+currentValue.intValue()));</span>
<span class="fc" id="L95">				}</span>
<span class="fc" id="L96">				rs.close();</span>
<span class="fc" id="L97">				ps.close();</span>
<span class="fc" id="L98">				db_conn.close();</span>
<span class="fc" id="L99">				rs = null;</span>
<span class="fc" id="L100">				ps = null;</span>
<span class="fc" id="L101">				db_conn = null;</span>
			}
<span class="nc" id="L103">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L105" title="All 2 branches missed.">				if (ex.getMessage().indexOf(&quot;Invalid&quot;)==-1)</span>
				{
<span class="nc" id="L107">					sk.iway.iwcm.Logger.error(ex);</span>
				}
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L115">						rs.close();</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L117">						ps.close();</span>
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L119">						db_conn.close();</span>
				}
<span class="nc" id="L121">				catch (Exception ex2)</span>
				{
<span class="nc" id="L123">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L124">				}</span>
			}
		}

<span class="fc" id="L128">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L130">		map = StatDB.sortByValue(map);</span>

<span class="fc" id="L132">		Iterator&lt;Map.Entry&lt;String, Number&gt;&gt; iter = map.entrySet().iterator();</span>
		Map.Entry&lt;String, Number&gt; me;
<span class="fc" id="L134">		int i = 0;</span>
<span class="pc bpc" id="L135" title="1 of 4 branches missed.">		while (iter.hasNext() &amp;&amp; i++&lt;maxRows)</span>
		{
<span class="fc" id="L137">			me = iter.next();</span>
<span class="fc" id="L138">			String key = me.getKey();</span>
<span class="fc" id="L139">			Number value = me.getValue();</span>

			//Logger.debug(StatDB.class, &quot;getCountry: key=&quot;+key+&quot; value=&quot;+value);

<span class="fc" id="L143">			Column col = new Column();</span>
<span class="fc" id="L144">			col.setColumn1(key);</span>
<span class="fc" id="L145">			col.setIntColumn2(value.intValue());</span>
<span class="fc" id="L146">			ret.add(col);</span>
<span class="fc" id="L147">		}</span>

<span class="fc" id="L149">		return (ret);</span>
	}

	public static List&lt;Column&gt; getNamedCountries(int max_size, java.util.Date from, java.util.Date to, String groupIdsQuery, String language)
	{
<span class="nc" id="L154">		return getNamedCountries(max_size, from, to, groupIdsQuery, language, false);</span>
	}

	/**
	 * The same as getCountry, except in country name terms.
	 * The countries are not returned as a top level domain codes, but rather as
	 * a localized country name. In case such a TLD is not recognized, or in case
	 * it is a generic TLD( .com, .net, .org, .info,...) the TLD is returned.
	 *
	 */

	public static List&lt;Column&gt; getNamedCountries(int max_size, java.util.Date from, java.util.Date to, String groupIdsQuery, String language, boolean withoutBots)
	{
<span class="fc" id="L167">		List&lt;Column&gt; ret = getCountry(max_size, from, to, groupIdsQuery, withoutBots);</span>
		//skus najst mapovanie TLD na nazov krajiny...ak sa nepodari, ponechaj povodnu
<span class="fc bfc" id="L169" title="All 2 branches covered.">		for (Column countryStatRow : ret)</span>
		{
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">			if (!(&quot;stat.countries.tld.&quot;+(countryStatRow).getColumn1()).     equals(Prop.getInstance(language).getText( &quot;stat.countries.tld.&quot;+(countryStatRow).getColumn1()) ))</span>
<span class="fc" id="L172">				(countryStatRow).setColumn1( Prop.getInstance(language).getText(&quot;stat.countries.tld.&quot;+(countryStatRow).getColumn1()) );</span>
<span class="fc" id="L173">		}</span>

<span class="fc" id="L175">		return ret;</span>
	}

	public static List&lt;Column&gt; getBrowser(int maxRows, java.util.Date from, java.util.Date to, String groupIdsQuery)
	{
<span class="nc" id="L180">		return getBrowser( maxRows, from, to, groupIdsQuery, false);</span>
	}

	/**
	 * Vrati zoznam prehliadacov a platforiem usporiadany podla poctu videni
	 * @param maxRows
	 * @param from
	 * @param to
	 * @param groupIdsQuery
	 * @return
	 */
	public static List&lt;Column&gt; getBrowser(int maxRows, java.util.Date from, java.util.Date to, String groupIdsQuery, boolean withoutBots)
	{
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">		if (groupIdsQuery == null)</span>
		{
<span class="nc" id="L195">			groupIdsQuery = &quot;&quot;;</span>
		}

<span class="fc" id="L198">		Map&lt;String, Number&gt; map = new HashMap&lt;&gt;();</span>

<span class="fc" id="L200">		String whitelistedQuery = &quot;&quot;;</span>
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">		if(withoutBots)</span>
<span class="nc" id="L202">			whitelistedQuery = StatNewDB.getWhiteListedUAQuery();</span>

<span class="fc" id="L204">		String[] suffixes = StatNewDB.getTableSuffix(null, from.getTime(), to.getTime());</span>
<span class="fc bfc" id="L205" title="All 2 branches covered.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="fc" id="L207">			Connection db_conn = null;</span>
<span class="fc" id="L208">			PreparedStatement ps = null;</span>
<span class="fc" id="L209">			ResultSet rs = null;</span>
			try
			{
<span class="fc" id="L212">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L213">				String sql = &quot;SELECT DISTINCT browser_ua_id, platform_id, count(browser_ua_id) as views FROM stat_views&quot;+suffixes[s]+&quot; WHERE view_time&gt;=? AND view_time&lt;? &quot; + groupIdsQuery + whitelistedQuery + &quot; GROUP BY browser_ua_id, platform_id&quot;;</span>
<span class="fc" id="L214">				ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L215">				ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="fc" id="L216">				ps.setTimestamp(2, new Timestamp(to.getTime()));</span>
<span class="fc" id="L217">				rs = ps.executeQuery();</span>
				//iteruj cez riadky
<span class="fc bfc" id="L219" title="All 2 branches covered.">				while (rs.next())</span>
				{
<span class="fc" id="L221">					String key = rs.getInt(&quot;browser_ua_id&quot;)+&quot;;&quot;+rs.getInt(&quot;platform_id&quot;);</span>
<span class="fc" id="L222">					Number currentValue = map.get(key);</span>

<span class="pc bpc" id="L224" title="1 of 2 branches missed.">					if (currentValue == null) map.put(key, Integer.valueOf(rs.getInt(&quot;views&quot;)));</span>
<span class="nc" id="L225">					else map.put(key, Integer.valueOf(rs.getInt(&quot;views&quot;)+currentValue.intValue()));</span>
<span class="fc" id="L226">				}</span>
<span class="fc" id="L227">				rs.close();</span>
<span class="fc" id="L228">				ps.close();</span>
<span class="fc" id="L229">				db_conn.close();</span>
<span class="fc" id="L230">				db_conn = null;</span>
<span class="fc" id="L231">				rs = null;</span>
<span class="fc" id="L232">				ps = null;</span>
			}
<span class="nc" id="L234">			catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
			finally{
				try{
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">					if (rs != null) rs.close();</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">					if (ps != null) ps.close();</span>
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">					if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L240">				}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
			}
		}

<span class="fc" id="L244">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L246">		map = StatDB.sortByValue(map);</span>

<span class="fc" id="L248">		Iterator&lt;Map.Entry&lt;String, Number&gt;&gt; iter = map.entrySet().iterator();</span>
		Map.Entry&lt;String, Number&gt; me;
<span class="fc" id="L250">		int i = 0;</span>
<span class="pc bpc" id="L251" title="1 of 4 branches missed.">		while (iter.hasNext() &amp;&amp; i++&lt;maxRows)</span>
		{
<span class="fc" id="L253">			me = iter.next();</span>
<span class="fc" id="L254">			String key = me.getKey();</span>
<span class="fc" id="L255">			Number value = me.getValue();</span>

			//Logger.debug(StatDB.class, &quot;getBrowser: key=&quot;+key+&quot; value=&quot;+value);

<span class="fc" id="L259">			Column col = new Column();</span>
<span class="fc" id="L260">			String[] values = key.split(&quot;;&quot;);</span>
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">			if (values.length==2)</span>
			{
<span class="fc" id="L263">				col.setIntColumn1(Tools.getIntValue(values[0], -1));</span>
<span class="fc" id="L264">				col.setColumn1(StatDB.getStatKeyValue(col.getIntColumn1()));</span>

<span class="fc" id="L266">				col.setIntColumn2(Tools.getIntValue(values[1], -1));</span>
<span class="fc" id="L267">				col.setColumn2(StatDB.getStatKeyValue(col.getIntColumn2()));</span>

<span class="fc" id="L269">				col.setIntColumn3(value.intValue());</span>
<span class="fc" id="L270">				ret.add(col);</span>
			}
<span class="fc" id="L272">		}</span>

<span class="fc" id="L274">		return (ret);</span>
	}


	/**
	 * Zoznam prihlaseni jednotlivych pouzivatelov zgrupenych podla pouzivatela.
	 * Dalej obsahuje zosumovane minuty jeho prihlasenia, scitane pocty prihlaseni a datum posledneho loginu.
	 *
	 * @param max_size	Maximalny pocet zaznamov, ktore sa vratia
	 * @param from			Datum, od ktoreho sa filtruju prihlasenia
	 * @param to			Datum, do ktoreho sa filtruju prihlasenia
	 *
	 * @return				Zoznam jednotlivych prihlaseni zgrupenych podla pouzivatela, ak sa citanie z databazy podari. Inak vrati prazdny zoznam.
	 */

	public static List&lt;Column&gt; getUsrlogon(int max_size, java.util.Date from, java.util.Date to)
	{
<span class="fc" id="L291">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L293">		Connection db_conn = null;</span>
<span class="fc" id="L294">		PreparedStatement ps = null;</span>
<span class="fc" id="L295">		ResultSet rs = null;</span>


<span class="fc" id="L298">		String sql = &quot;SELECT DISTINCT u.user_id, u.title as u_title, u.first_name, u.last_name, u.company, u.city, u.last_logon, u.is_admin, &quot; +</span>
		 				 &quot;sum(s.views) as views, sum(s.view_minutes) as view_minutes, count(s.views) as views_count &quot; +
		 				 &quot;FROM stat_userlogon s,  users u &quot; +
		 				 &quot;WHERE s.user_id = u.user_id AND s.logon_time &gt;= ? AND s.logon_time &lt;= ? &quot;;

<span class="pc bpc" id="L303" title="1 of 2 branches missed.">		if (InitServlet.isTypeCloud())</span>
		{
<span class="nc" id="L305">			sql += CloudToolsForCore.getDomainIdSqlWhere(true, &quot;u&quot;);</span>
		}

<span class="fc" id="L308">		sql += &quot;GROUP BY u.user_id, u.is_admin, u.title, u.first_name, u.last_name, u.company, u.city, u.last_logon &quot;;</span>
<span class="fc" id="L309">		sql+= &quot;ORDER BY u.is_admin DESC, view_minutes DESC&quot;;</span>

		try
		{
<span class="fc" id="L313">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L314">			ps = db_conn.prepareStatement(sql);</span>

<span class="fc" id="L316">			ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="fc" id="L317">			ps.setTimestamp(2, new Timestamp(to.getTime()));</span>

<span class="fc" id="L319">			rs = ps.executeQuery();</span>

			Column col;
<span class="fc" id="L322">			int count = 0;</span>
<span class="pc bpc" id="L323" title="1 of 4 branches missed.">			while (rs.next() &amp;&amp; count &lt; max_size)</span>
			{
<span class="fc" id="L325">				col = new Column();</span>

<span class="fc" id="L327">				col.setColumn1(Integer.toString(rs.getInt(&quot;user_id&quot;)));</span>
<span class="fc" id="L328">				col.setColumn2(DB.getFullName(rs));</span>
<span class="fc" id="L329">				col.setColumn3(DB.getDbString(rs, &quot;company&quot;));</span>
<span class="fc" id="L330">				col.setColumn4(DB.getDbString(rs, &quot;city&quot;));</span>
<span class="fc" id="L331">				col.setIntColumn5(rs.getInt(&quot;views_count&quot;));			// pocet novych prihlaseni. To su take, pri ktorych sa vytvorila nova session</span>
<span class="fc" id="L332">				col.setIntColumn6(rs.getInt(&quot;view_minutes&quot;));		// pocet minut, ktore bol pouzivatel prihlaseny</span>
<span class="fc" id="L333">				col.setIntColumn7(rs.getInt(&quot;views&quot;));					// pocet vsetkych prihlaseni, nielen tych pri ktorych sa vytvorila nova session</span>
<span class="fc" id="L334">				col.setDateColumn1(rs.getTimestamp(&quot;last_logon&quot;));</span>
<span class="fc" id="L335">				col.setColumn8(Integer.toString(rs.getInt(&quot;views&quot;)));</span>
<span class="fc" id="L336">				col.setBooleanColumn1(rs.getBoolean(&quot;is_admin&quot;));</span>

<span class="fc" id="L338">				ret.add(col);</span>
<span class="fc" id="L339">				count++;</span>
			}

<span class="fc" id="L342">			rs.close();</span>
<span class="fc" id="L343">			ps.close();</span>
<span class="fc" id="L344">			db_conn.close();</span>

<span class="fc" id="L346">			rs = null;</span>
<span class="fc" id="L347">			ps = null;</span>
<span class="fc" id="L348">			db_conn = null;</span>
		}
<span class="nc" id="L350">		catch (Exception ex)</span>
		{
<span class="nc" id="L352">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L359">					rs.close();</span>
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L361">					ps.close();</span>
<span class="pc bpc" id="L362" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L363">					db_conn.close();</span>
			}
<span class="nc" id="L365">			catch (Exception ex2)</span>
			{
<span class="nc" id="L367">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L368">			}</span>
		}

<span class="fc" id="L371">		return (ret);</span>
	}

	/**
	 * Vrati zoznam prihlaseni pre daneho pouzivatela a pre dane casove obdobie
	 *
	 * @param max_size	Maximalny pocet zaznamov, ktore sa vratia. Aj ked select z tabulky ich vrati viac, system nacita iba maximalne max_size.
	 * @param userId		Identifikator pouzivatela, ktoreho zaznamy prihlaseni chceme ziskat.
	 * @param from			Zaciatok casoveho useku, od ktoreho chceme zaznamy prihlaseni.
	 * @param to			Koniec casoveho useku, do ktoreho chceme zaznamy prihlaseni.
	 *
	 * @return				Zoznam prihlaseni daneho pouzivatela s polozkami - cas prihlasenia(DateColumn1), pocet minut(IntColumn2) a meno pocitaca, z ktoreho sa prihlasil(hostname)
	 */
	public static List&lt;Column&gt; getUsrlogonDetails(int max_size, int userId, java.util.Date from, java.util.Date to)
	{
<span class="fc" id="L386">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L388">		Connection db_conn = null;</span>
<span class="fc" id="L389">		PreparedStatement ps = null;</span>
<span class="fc" id="L390">		ResultSet rs = null;</span>

<span class="fc" id="L392">		String sql = &quot;SELECT * FROM stat_userlogon WHERE user_id=? AND logon_time &gt;= ? AND logon_time &lt;= ? ORDER BY logon_time DESC&quot;;</span>

		try
		{
<span class="fc" id="L396">			db_conn = DBPool.getConnection();</span>

<span class="fc" id="L398">			ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L399">			ps.setInt(1, userId);</span>
<span class="fc" id="L400">			ps.setTimestamp(2, new Timestamp(from.getTime()));</span>
<span class="fc" id="L401">			ps.setTimestamp(3, new Timestamp(to.getTime()));</span>

<span class="fc" id="L403">			rs = ps.executeQuery();</span>

			Column col;
<span class="fc" id="L406">			int count = 0;</span>
<span class="pc bpc" id="L407" title="1 of 4 branches missed.">			while (rs.next() &amp;&amp; count &lt; max_size)</span>
			{
<span class="fc" id="L409">				col = new Column();</span>
<span class="fc" id="L410">				col.setDateColumn1(rs.getTimestamp(&quot;logon_time&quot;));</span>
<span class="fc" id="L411">				col.setIntColumn2(rs.getInt(&quot;view_minutes&quot;));</span>
<span class="fc" id="L412">				col.setColumn3(DB.getDbString(rs, &quot;hostname&quot;));</span>

<span class="fc" id="L414">				ret.add(col);</span>
<span class="fc" id="L415">				count++;</span>
			}

<span class="fc" id="L418">			rs.close();</span>
<span class="fc" id="L419">			ps.close();</span>
<span class="fc" id="L420">			db_conn.close();</span>

<span class="fc" id="L422">			rs = null;</span>
<span class="fc" id="L423">			ps = null;</span>
<span class="fc" id="L424">			db_conn = null;</span>
		}
<span class="nc" id="L426">		catch (Exception ex)</span>
		{
<span class="nc" id="L428">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L434" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L435">					rs.close();</span>
<span class="pc bpc" id="L436" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L437">					ps.close();</span>
<span class="pc bpc" id="L438" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L439">					db_conn.close();</span>
			}
<span class="nc" id="L441">			catch (Exception ex2)</span>
			{
<span class="nc" id="L443">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L444">			}</span>
		}

<span class="fc" id="L447">		return (ret);</span>
	}

	/**
	 * Funkcia, ktora vrati chybne stranky ulozene v tabulke stat_error podla zadanych kriterii a parametrov
	 *
	 * @param max_size	maximalny pocet riadkov, ktore sa maju vratit
	 * @param from			datum, od ktoreho sa maju stranky filtrovat
	 * @param to			datum, do ktoreho sa maju stranky filtrovat
	 * @param url			cast Url, ktore obsahuje atribut url. Ak pouzivatel zada tento udaj, vyfiltruju sa vsetky stranky, ktore obsahuju zadanu url
	 *
	 * @return				Vrati sa zoznam stranok, ktore zodpovedaju filtrovacim parametrom, ak citanie z databazy prebehne v poriadku. Inak sa vrati prazdny zoznam.
	 */
	public static List&lt;Column&gt; getErrorPages(int max_size, java.util.Date from, java.util.Date to, String url)
	{
<span class="fc" id="L462">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L464">		String[] suffixes = StatNewDB.getTableSuffix(&quot;stat_error&quot;, from.getTime(), to.getTime());</span>
<span class="fc bfc" id="L465" title="All 2 branches covered.">		for (int s=(suffixes.length-1); s&gt;=0; s--)</span>
		{

<span class="fc" id="L468">			Connection db_conn = null;</span>
<span class="fc" id="L469">			PreparedStatement ps = null;</span>
<span class="fc" id="L470">			ResultSet rs = null;</span>

<span class="fc" id="L472">			String sql = &quot;SELECT DISTINCT year, week, url, query_string, sum(count) as count FROM stat_error&quot;+suffixes[s]+&quot; &quot;;</span>
<span class="fc" id="L473">			sql += StatDB.getYearTimeSQL(from, to, true);</span>

<span class="pc bpc" id="L475" title="1 of 2 branches missed.">			if(Tools.isNotEmpty(url))</span>
<span class="nc" id="L476">				sql += &quot; AND url LIKE ? &quot;;</span>

<span class="pc bpc" id="L478" title="2 of 4 branches missed.">			if (InitServlet.isTypeCloud() || Constants.getBoolean(&quot;enableStaticFilesExternalDir&quot;)==true)</span>
			{
<span class="fc" id="L480">				sql += &quot; AND (domain_id=0 OR domain_id=&quot;+CloudToolsForCore.getDomainId()+&quot;) &quot;;</span>
			}

<span class="fc" id="L483">			sql += &quot; GROUP BY url, year, week, query_string ORDER BY year DESC, week DESC, count DESC&quot;;</span>

<span class="fc" id="L485">			Logger.debug(StatTableDB.class, &quot;getErrorPages sql:&quot;+sql);</span>

			try
			{
<span class="fc" id="L489">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L490">				ps = db_conn.prepareStatement(sql);</span>

<span class="pc bpc" id="L492" title="1 of 2 branches missed.">				if(Tools.isNotEmpty(url))</span>
<span class="nc" id="L493">					ps.setString(1, &quot;%&quot; + url + &quot;%&quot;);</span>

<span class="fc" id="L495">				rs = ps.executeQuery();</span>

				Column col;
<span class="fc" id="L498">				int count = 0;</span>

<span class="pc bpc" id="L500" title="1 of 4 branches missed.">				while (rs.next() &amp;&amp; count &lt; max_size)</span>
				{
<span class="fc" id="L502">					col = new Column();</span>
<span class="fc" id="L503">					col.setIntColumn1(rs.getInt(&quot;year&quot;));</span>
<span class="fc" id="L504">					col.setIntColumn2(rs.getInt(&quot;week&quot;));</span>
<span class="fc" id="L505">					col.setColumn3(DB.getDbString(rs, &quot;url&quot;));</span>
<span class="fc" id="L506">					col.setColumn4(DB.getDbString(rs, &quot;query_string&quot;));</span>
<span class="fc" id="L507">					col.setIntColumn5(rs.getInt(&quot;count&quot;));</span>
<span class="fc" id="L508">					ret.add(col);</span>
<span class="fc" id="L509">					count++;</span>
				}

<span class="fc" id="L512">				rs.close();</span>
<span class="fc" id="L513">				ps.close();</span>
<span class="fc" id="L514">				db_conn.close();</span>

<span class="fc" id="L516">				rs = null;</span>
<span class="fc" id="L517">				ps = null;</span>
<span class="fc" id="L518">				db_conn = null;</span>
			}
<span class="nc" id="L520">			catch (Exception ex)</span>
			{
<span class="nc" id="L522">				logError(ex);</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L528" title="1 of 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L529">						rs.close();</span>
<span class="pc bpc" id="L530" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L531">						ps.close();</span>
<span class="pc bpc" id="L532" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L533">						db_conn.close();</span>
				}
<span class="nc" id="L535">				catch (Exception ex2)</span>
				{
<span class="nc" id="L537">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L538">				}</span>
			}
		}

<span class="fc" id="L542">		return (ret);</span>
	}

	public static List&lt;Column&gt; getSearchEnginesQuery(int maxRows, java.util.Date from, java.util.Date to, String groupIdsQuery)
	{
<span class="pc bpc" id="L547" title="1 of 2 branches missed.">		if (groupIdsQuery == null)</span>
<span class="nc" id="L548">			groupIdsQuery = &quot;&quot;;</span>

<span class="fc" id="L550">		Map&lt;String, Number&gt; map = new HashMap&lt;&gt;();</span>

		String[] suffixes;
<span class="pc bpc" id="L553" title="2 of 4 branches missed.">		if (from != null &amp;&amp; to != null) suffixes = StatNewDB.getTableSuffix(&quot;stat_searchengine&quot;, from.getTime(), to.getTime());</span>
<span class="nc" id="L554">		else suffixes = StatNewDB.getTableSuffix(&quot;stat_searchengine&quot;, 0, Tools.getNow());</span>

<span class="fc bfc" id="L556" title="All 2 branches covered.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{

<span class="fc" id="L559">			Connection db_conn = null;</span>
<span class="fc" id="L560">			PreparedStatement ps = null;</span>
<span class="fc" id="L561">			ResultSet rs = null;</span>

			try
			{
<span class="fc" id="L565">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L566">				String sql = &quot;SELECT s.query, COUNT(s.query) AS total FROM stat_searchengine&quot;+suffixes[s]+&quot; s WHERE s.doc_id&gt;=0 &quot;;</span>
<span class="pc bpc" id="L567" title="2 of 4 branches missed.">				if (from != null &amp;&amp; to != null)</span>
				{
<span class="fc" id="L569">				   sql += &quot; AND search_date &gt;= ? AND search_date &lt;= ? &quot;;</span>
				}
<span class="fc" id="L571">				sql += groupIdsQuery;</span>

<span class="pc bpc" id="L573" title="1 of 2 branches missed.">				if (sql.toLowerCase().indexOf(&quot;group by&quot;)==-1) sql += &quot;GROUP BY s.query&quot;;</span>

<span class="fc" id="L575">				ps = db_conn.prepareStatement(sql);</span>
<span class="pc bpc" id="L576" title="2 of 4 branches missed.">				if (from != null &amp;&amp; to != null)</span>
				{
<span class="fc" id="L578">					ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="fc" id="L579">					ps.setTimestamp(2, new Timestamp(to.getTime()));</span>
				}
<span class="fc" id="L581">				rs = ps.executeQuery();</span>
				//iteruj cez riadky
<span class="fc bfc" id="L583" title="All 2 branches covered.">				while (rs.next() )</span>
				{
<span class="fc" id="L585">					String key = DB.getDbString(rs, &quot;query&quot;);</span>
<span class="fc" id="L586">					Number currentValue = map.get(key);</span>

<span class="pc bpc" id="L588" title="1 of 2 branches missed.">					if (currentValue == null) map.put(key, Integer.valueOf(rs.getInt(&quot;total&quot;)));</span>
<span class="nc" id="L589">					else map.put(key, Integer.valueOf(rs.getInt(&quot;total&quot;)+currentValue.intValue()));</span>
<span class="fc" id="L590">				}</span>
<span class="fc" id="L591">				rs.close();</span>
<span class="fc" id="L592">				ps.close();</span>
<span class="fc" id="L593">				db_conn.close();</span>
<span class="fc" id="L594">				rs = null;</span>
<span class="fc" id="L595">				ps = null;</span>
<span class="fc" id="L596">				db_conn = null;</span>
			}
<span class="nc" id="L598">			catch (Exception ex)</span>
			{
<span class="nc" id="L600">				sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L606" title="1 of 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L607">						rs.close();</span>
<span class="pc bpc" id="L608" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L609">						ps.close();</span>
<span class="pc bpc" id="L610" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L611">						db_conn.close();</span>
				}
<span class="nc" id="L613">				catch (Exception ex2)</span>
				{
<span class="nc" id="L615">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L616">				}</span>
			}
		}

<span class="fc" id="L620">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

		//je mozne, ze tam mame viac ako max zaznamov, upracme a povazujme to za &quot;ostatne&quot;
<span class="fc" id="L623">		map = StatDB.sortByValue(map);</span>

<span class="fc" id="L625">		Iterator&lt;Map.Entry&lt;String, Number&gt;&gt; iter = map.entrySet().iterator();</span>
		Map.Entry&lt;String, Number&gt; me;
<span class="fc" id="L627">		int i = 0;</span>
<span class="fc bfc" id="L628" title="All 4 branches covered.">		while (iter.hasNext() &amp;&amp; i++&lt;maxRows)</span>
		{
<span class="fc" id="L630">			me = iter.next();</span>
<span class="fc" id="L631">			String key = me.getKey();</span>
<span class="fc" id="L632">			Number value = me.getValue();</span>

			//Logger.debug(StatDB.class, &quot;getSearchEnginesQuery: key=&quot;+key+&quot; value=&quot;+value);

<span class="fc" id="L636">			Column col = new Column();</span>
<span class="fc" id="L637">			col.setColumn3(key);</span>
<span class="fc" id="L638">			col.setColumn2(col.getColumn3());</span>
<span class="fc" id="L639">			col.setIntColumn1(value.intValue());</span>

<span class="fc" id="L641">			ret.add(col);</span>
<span class="fc" id="L642">		}</span>

<span class="fc" id="L644">		return (ret);</span>

	}

	/**
	 *  statistika pristupov podla nazvu servera
	 *
	 *@return   List s nazvom servera a poctom pristupov
	 */
	public static List&lt;Column&gt; getSearchEnginesCount(int max_size, java.util.Date from, java.util.Date to, String groupIdsQuery)
	{
<span class="fc" id="L655">		return (StatTableDB.getSearchEnginesCount(max_size, from, to, groupIdsQuery, &quot;&quot;));</span>
	}

	/**
	 *  statistika pristupov podla nazvu servera
	 *
	 *@return   List s nazvom servera a poctom pristupov
	 */
	public static List&lt;Column&gt; getSearchEnginesCount(int maxRows, java.util.Date from, java.util.Date to, String groupIdsQuery, String seoKeyword)
	{
<span class="fc" id="L665">		Map&lt;String, Number&gt; map = new HashMap&lt;&gt;();</span>

		String[] suffixes;
<span class="pc bpc" id="L668" title="2 of 4 branches missed.">		if (from != null &amp;&amp; to != null) suffixes = StatNewDB.getTableSuffix(&quot;stat_searchengine&quot;, from.getTime(), to.getTime());</span>
<span class="nc" id="L669">		else suffixes = StatNewDB.getTableSuffix(&quot;stat_searchengine&quot;, 0, Tools.getNow());</span>
<span class="fc bfc" id="L670" title="All 2 branches covered.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="fc" id="L672">			Connection db_conn = null;</span>
<span class="fc" id="L673">			PreparedStatement ps = null;</span>
<span class="fc" id="L674">			ResultSet rs = null;</span>

			try
			{
<span class="pc bpc" id="L678" title="1 of 2 branches missed.">				if (groupIdsQuery == null)</span>
<span class="nc" id="L679">					groupIdsQuery = &quot;&quot;;</span>

<span class="fc" id="L681">				db_conn = DBPool.getConnection();</span>

<span class="fc" id="L683">				String sql = &quot;SELECT server, COUNT(server) AS total FROM stat_searchengine&quot;+suffixes[s]+&quot; WHERE doc_id &gt;= 0 &quot; + groupIdsQuery;</span>

<span class="pc bpc" id="L685" title="2 of 4 branches missed.">				if (from != null &amp;&amp; to != null)</span>
<span class="fc" id="L686">				   sql += &quot; AND search_date &gt;= ? AND search_date &lt;= ? &quot;;</span>

<span class="pc bpc" id="L688" title="2 of 4 branches missed.">				if (seoKeyword != null &amp;&amp; Tools.isNotEmpty(seoKeyword))</span>
<span class="nc" id="L689">					sql += &quot; AND query = ? &quot;;</span>

<span class="fc" id="L691">				sql += &quot; GROUP BY server&quot;;</span>
<span class="fc" id="L692">				sql += &quot; ORDER BY total DESC&quot;;</span>

<span class="fc" id="L694">				ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L695">				int psCount = 1;</span>
<span class="pc bpc" id="L696" title="2 of 4 branches missed.">				if (from != null &amp;&amp; to != null)</span>
				{
<span class="fc" id="L698">					ps.setTimestamp(psCount++, new Timestamp(from.getTime()));</span>
<span class="fc" id="L699">					ps.setTimestamp(psCount++, new Timestamp(to.getTime()));</span>
				}
<span class="pc bpc" id="L701" title="2 of 4 branches missed.">				if (seoKeyword != null &amp;&amp; Tools.isNotEmpty(seoKeyword))</span>
<span class="nc" id="L702">					ps.setString(psCount++, seoKeyword);</span>

<span class="fc" id="L704">				rs = ps.executeQuery();</span>
				//iteruj cez riadky
<span class="fc bfc" id="L706" title="All 2 branches covered.">				while (rs.next())</span>
				{
<span class="fc" id="L708">					String key = DB.prepareString(DB.getDbString(rs, &quot;server&quot;), 25);</span>
<span class="fc" id="L709">					Number currentValue = map.get(key);</span>

<span class="fc bfc" id="L711" title="All 2 branches covered.">					if (currentValue == null) map.put(key, Integer.valueOf(rs.getInt(&quot;total&quot;)));</span>
<span class="fc" id="L712">					else map.put(key, Integer.valueOf(rs.getInt(&quot;total&quot;)+currentValue.intValue()));</span>
<span class="fc" id="L713">				}</span>
<span class="fc" id="L714">				rs.close();</span>
<span class="fc" id="L715">				ps.close();</span>
<span class="fc" id="L716">				db_conn.close();</span>

<span class="fc" id="L718">				rs = null;</span>
<span class="fc" id="L719">				ps = null;</span>
<span class="fc" id="L720">				db_conn = null;</span>
			}
<span class="nc" id="L722">			catch (Exception ex)</span>
			{
<span class="nc" id="L724">				sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L730" title="1 of 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L731">						rs.close();</span>
<span class="pc bpc" id="L732" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L733">						ps.close();</span>
<span class="pc bpc" id="L734" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L735">						db_conn.close();</span>
				}
<span class="nc" id="L737">				catch (Exception ex2)</span>
				{
<span class="nc" id="L739">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L740">				}</span>
			}
		}

<span class="fc" id="L744">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L746">		map = StatDB.sortByValue(map);</span>

<span class="fc" id="L748">		Iterator&lt;Map.Entry&lt;String, Number&gt;&gt; iter = map.entrySet().iterator();</span>
		Map.Entry&lt;String, Number&gt; me;
<span class="fc" id="L750">		int i = 0;</span>
<span class="pc bpc" id="L751" title="1 of 4 branches missed.">		while (iter.hasNext() &amp;&amp; i++&lt;maxRows)</span>
		{
<span class="fc" id="L753">			me = iter.next();</span>
<span class="fc" id="L754">			String key = me.getKey();</span>
<span class="fc" id="L755">			Number value = me.getValue();</span>

			//Logger.debug(StatDB.class, &quot;getSearchEnginesCount: key=&quot;+key+&quot; value=&quot;+value);

<span class="fc" id="L759">			Column col = new Column();</span>
<span class="fc" id="L760">			col.setColumn1(key);</span>
<span class="fc" id="L761">			col.setColumn2(col.getColumn1());</span>
<span class="fc" id="L762">			col.setIntColumn2(value.intValue());</span>
<span class="fc" id="L763">			ret.add(col);</span>
<span class="fc" id="L764">		}</span>

<span class="fc" id="L766">		return (ret);</span>
	}

	/**
	 *	Vrati list, v ktorom budu ulozene bean s hodnotou datetime vyhladavania a pozicie
	 *
	 *	@param 	maxSize			maximalne kolko poslednych vyhladavani sa pouzije
	 *	@param	from				od ktoreho datumu vyberame zaznamy
	 *	@param	to					do ktoreho datumu vyberame zaznamy
	 *	@param	seoKeywordId	identifikator klucoveho slova, pre ktore chceme vyfiltrovat zaznamy
	 *
	 *	@return  List s beanmi, ktore obsahuju datetime vyhladavania a poziciu pre poslednych maxSize vyhladavani
	 */
	public static List&lt;Column&gt; getGooglePositionsList(int maxSize, java.util.Date from, java.util.Date to, int seoKeywordId)
	{
<span class="nc" id="L781">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L783">		Connection db_conn = null;</span>
<span class="nc" id="L784">		PreparedStatement ps = null;</span>
<span class="nc" id="L785">		ResultSet rs = null;</span>

		try
		{
<span class="nc" id="L789">			db_conn = DBPool.getConnection();</span>

<span class="nc" id="L791">			String sql = &quot;SELECT position, search_datetime FROM seo_google_position WHERE seo_google_position_id &gt;= 0 &quot;;</span>

<span class="nc bnc" id="L793" title="All 4 branches missed.">			if (from != null &amp;&amp; to != null)</span>
<span class="nc" id="L794">			   sql += &quot; AND search_datetime &gt;= ? AND search_datetime &lt;= ? &quot;;</span>

<span class="nc bnc" id="L796" title="All 2 branches missed.">			if (seoKeywordId != 0)</span>
<span class="nc" id="L797">				sql += &quot; AND keyword_id = ? &quot;;</span>

<span class="nc" id="L799">			sql += &quot; ORDER BY search_datetime DESC&quot;;</span>

<span class="nc" id="L801">			ps = db_conn.prepareStatement(sql);</span>

<span class="nc" id="L803">			int psCount = 1;</span>
<span class="nc bnc" id="L804" title="All 4 branches missed.">			if (from != null &amp;&amp; to != null)</span>
			{
<span class="nc" id="L806">				ps.setTimestamp(psCount++, new Timestamp(from.getTime()));</span>
<span class="nc" id="L807">				ps.setTimestamp(psCount++, new Timestamp(to.getTime()));</span>
			}
<span class="nc bnc" id="L809" title="All 2 branches missed.">			if (seoKeywordId != 0)</span>
<span class="nc" id="L810">				ps.setInt(psCount++, seoKeywordId);</span>

<span class="nc" id="L812">			rs = ps.executeQuery();</span>
			//iteruj cez riadky
			Column col;
<span class="nc" id="L815">			int count = 0;</span>
<span class="nc bnc" id="L816" title="All 4 branches missed.">			while (rs.next() &amp;&amp; count &lt; maxSize)</span>
			{
<span class="nc" id="L818">				col = new Column();</span>
<span class="nc" id="L819">				col.setDateColumn1(rs.getDate(&quot;search_datetime&quot;));</span>
<span class="nc" id="L820">				col.setIntColumn1(rs.getInt(&quot;position&quot;));</span>
<span class="nc" id="L821">				ret.add(col);</span>
<span class="nc" id="L822">				count++;</span>
			}

<span class="nc" id="L825">			rs.close();</span>
<span class="nc" id="L826">			ps.close();</span>
<span class="nc" id="L827">			db_conn.close();</span>

<span class="nc" id="L829">			rs = null;</span>
<span class="nc" id="L830">			ps = null;</span>
<span class="nc" id="L831">			db_conn = null;</span>
		}
<span class="nc" id="L833">		catch (Exception ex)</span>
		{
<span class="nc" id="L835">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L841" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L842">					rs.close();</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L844">					ps.close();</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L846">					db_conn.close();</span>
			}
<span class="nc" id="L848">			catch (Exception ex2)</span>
			{
<span class="nc" id="L850">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L851">			}</span>
		}

<span class="nc" id="L854">		return (ret);</span>
	}

	/**
	 *  zoznam vsetkych serverov pre docId
	 *
	 *@return   List s nazvom servera a poctom pristupov
	 */
	public static List&lt;Column&gt; getSearchEnginesNames(int docId, java.util.Date from, java.util.Date to, String groupIdsQuery)
	{
<span class="nc" id="L864">		List&lt;String&gt; map = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L866">		String[] suffixes = StatNewDB.getTableSuffix(&quot;stat_searchengine&quot;, from.getTime(), to.getTime());</span>
<span class="nc bnc" id="L867" title="All 2 branches missed.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="nc" id="L869">			Connection db_conn = null;</span>
<span class="nc" id="L870">			PreparedStatement ps = null;</span>
<span class="nc" id="L871">			ResultSet rs = null;</span>
			try
			{
<span class="nc" id="L874">				db_conn = DBPool.getConnection();</span>

<span class="nc" id="L876">				String sql = &quot;SELECT DISTINCT server FROM stat_searchengine&quot;+suffixes[s]+&quot; WHERE doc_id &gt;= 0 &quot; + groupIdsQuery;</span>

<span class="nc" id="L878">			   sql += &quot; AND search_date &gt;= ? AND search_date &lt;= ? &quot;;</span>

<span class="nc bnc" id="L880" title="All 2 branches missed.">				if(docId!=-1)</span>
<span class="nc" id="L881">					sql += &quot;AND doc_id = &quot;+docId;</span>

<span class="nc" id="L883">				sql += &quot; ORDER BY server&quot;;</span>

<span class="nc" id="L885">				ps = db_conn.prepareStatement(sql);</span>


<span class="nc" id="L888">				ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="nc" id="L889">				ps.setTimestamp(2, new Timestamp(to.getTime()));</span>


<span class="nc" id="L892">				rs = ps.executeQuery();</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">				while (rs.next())</span>
				{
<span class="nc" id="L895">					String server = DB.getDbString(rs, &quot;server&quot;);</span>
<span class="nc bnc" id="L896" title="All 2 branches missed.">					if (map.contains(server)==false) map.add(server);</span>
<span class="nc" id="L897">				}</span>
<span class="nc" id="L898">				rs.close();</span>
<span class="nc" id="L899">				ps.close();</span>
<span class="nc" id="L900">				db_conn.close();</span>
<span class="nc" id="L901">				db_conn = null;</span>
<span class="nc" id="L902">				rs = null;</span>
<span class="nc" id="L903">				ps = null;</span>
			}
<span class="nc" id="L905">			catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
			finally{
				try{
<span class="nc bnc" id="L908" title="All 2 branches missed.">					if (rs != null) rs.close();</span>
<span class="nc bnc" id="L909" title="All 2 branches missed.">					if (ps != null) ps.close();</span>
<span class="nc bnc" id="L910" title="All 2 branches missed.">					if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L911">				}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
			}
		}

<span class="nc" id="L915">		Collections.sort(map);</span>

<span class="nc" id="L917">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L918" title="All 2 branches missed.">		for (String server : map)</span>
		{
<span class="nc" id="L920">			Column col = new Column();</span>
<span class="nc" id="L921">			col.setColumn1(server);</span>
<span class="nc" id="L922">			ret.add(col);</span>
<span class="nc" id="L923">		}</span>

<span class="nc" id="L925">		return (ret);</span>
	}
	/**
	 *  zoznam vsetkych docId a title k nim
	 *
	 *@return   List s nazvom servera a poctom pristupov
	 */
	public static List&lt;Column&gt; getSearchDocId(java.util.Date from, java.util.Date to, String server, String groupIdsQuery)
	{
<span class="nc" id="L934">		groupIdsQuery = Tools.replace(groupIdsQuery, &quot;group_id&quot;, &quot;s.group_id&quot;);</span>

<span class="nc" id="L936">		Map&lt;String, Number&gt; map = new HashMap&lt;&gt;();</span>

		String[] suffixes;
<span class="nc bnc" id="L939" title="All 4 branches missed.">		if (from != null &amp;&amp; to != null) suffixes = StatNewDB.getTableSuffix(&quot;stat_searchengine&quot;, from.getTime(), to.getTime());</span>
<span class="nc" id="L940">		else suffixes = StatNewDB.getTableSuffix(&quot;stat_searchengine&quot;, 0, Tools.getNow());</span>

<span class="nc bnc" id="L942" title="All 2 branches missed.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{

<span class="nc" id="L945">			Connection db_conn = null;</span>
<span class="nc" id="L946">			PreparedStatement ps = null;</span>
<span class="nc" id="L947">			ResultSet rs = null;</span>
			try
			{
<span class="nc" id="L950">				db_conn = DBPool.getConnection();</span>

<span class="nc" id="L952">				String sql = &quot;SELECT DISTINCT s.doc_id, d.title FROM stat_searchengine&quot;+suffixes[s]+&quot; s, documents d WHERE s.doc_id = d.doc_id &quot; + groupIdsQuery;</span>

<span class="nc bnc" id="L954" title="All 4 branches missed.">				if (from != null &amp;&amp; to != null)</span>
				{
<span class="nc" id="L956">				   sql += &quot; AND search_date &gt;= ? AND search_date &lt;= ? &quot;;</span>
				}
<span class="nc bnc" id="L958" title="All 4 branches missed.">				if(server!=null&amp;&amp;!server.equals(&quot;&quot;))</span>
<span class="nc" id="L959">					sql += &quot;AND s.server = ? &quot;;</span>

<span class="nc" id="L961">				sql += &quot; ORDER BY d.title&quot;;</span>

<span class="nc" id="L963">				ps = db_conn.prepareStatement(sql);</span>

<span class="nc bnc" id="L965" title="All 4 branches missed.">				if (from != null &amp;&amp; to != null)</span>
				{
<span class="nc" id="L967">					ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="nc" id="L968">					ps.setTimestamp(2, new Timestamp(to.getTime()));</span>
				}
<span class="nc bnc" id="L970" title="All 4 branches missed.">				if(server!=null&amp;&amp;!server.equals(&quot;&quot;))</span>
<span class="nc" id="L971">					ps.setString(3, server);</span>

<span class="nc" id="L973">				rs = ps.executeQuery();</span>
				//iteruj cez riadky
<span class="nc bnc" id="L975" title="All 2 branches missed.">				while (rs.next())</span>
				{
<span class="nc" id="L977">					String key = DB.getDbString(rs, &quot;title&quot;);</span>
<span class="nc" id="L978">					Number value = rs.getInt(&quot;doc_id&quot;);</span>

<span class="nc bnc" id="L980" title="All 2 branches missed.">					if (map.containsValue(value)==false) map.put(key, value);</span>
<span class="nc" id="L981">				}</span>
<span class="nc" id="L982">				rs.close();</span>
<span class="nc" id="L983">				ps.close();</span>
<span class="nc" id="L984">				db_conn.close();</span>
<span class="nc" id="L985">				db_conn = null;</span>
<span class="nc" id="L986">				rs = null;</span>
<span class="nc" id="L987">				ps = null;</span>
			}
<span class="nc" id="L989">			catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
			finally{
				try{
<span class="nc bnc" id="L992" title="All 2 branches missed.">					if (rs != null) rs.close();</span>
<span class="nc bnc" id="L993" title="All 2 branches missed.">					if (ps != null) ps.close();</span>
<span class="nc bnc" id="L994" title="All 2 branches missed.">					if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L995">				}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
			}
		}

<span class="nc" id="L999">		map = StatDB.sortByKey(map);</span>

<span class="nc" id="L1001">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L1003">		Set&lt;Map.Entry&lt;String, Number&gt;&gt; set = map.entrySet();</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">		for (Map.Entry&lt;String, Number&gt; me : set){</span>
<span class="nc" id="L1005">			String key = me.getKey();</span>
<span class="nc" id="L1006">			Number value = me.getValue();</span>

			//Logger.debug(StatDB.class, &quot;getSearchDocId: key=&quot;+key+&quot; value=&quot;+value);

<span class="nc" id="L1010">			Column col = new Column();</span>
<span class="nc" id="L1011">			col.setColumn2(key);</span>
<span class="nc" id="L1012">			col.setColumn1(value.toString());</span>
<span class="nc" id="L1013">			col.setIntColumn1(value.intValue());</span>
<span class="nc" id="L1014">			ret.add(col);</span>
<span class="nc" id="L1015">		}</span>

<span class="nc" id="L1017">		return (ret);</span>
	}

	/**
	 * Funkcia, ktora vrati zoznam vsetkych existujucich docId a title k nim
	 *
	 *	@return   List s docId a title
	 */
	public static List&lt;Column&gt; getDocTitleId(String groupIdsQuery)
	{
<span class="nc" id="L1027">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1028">		Connection db_conn = null;</span>
<span class="nc" id="L1029">		PreparedStatement ps = null;</span>
<span class="nc" id="L1030">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L1033">			db_conn = DBPool.getConnection();</span>

<span class="nc" id="L1035">			String sql = &quot;SELECT doc_id, title FROM documents WHERE doc_id &gt; 0&quot; + groupIdsQuery;</span>

<span class="nc" id="L1037">			sql += &quot; ORDER BY title&quot;;</span>

<span class="nc" id="L1039">			ps = db_conn.prepareStatement(sql);</span>

<span class="nc" id="L1041">			rs = ps.executeQuery();</span>
			//iteruj cez riadky
			Column col;
<span class="nc bnc" id="L1044" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L1046">				col = new Column();</span>
<span class="nc" id="L1047">				col.setColumn2(DB.getDbString(rs, &quot;title&quot;));</span>
<span class="nc" id="L1048">				col.setColumn1(DB.getDbString(rs, &quot;doc_id&quot;));</span>
<span class="nc" id="L1049">				ret.add(col);</span>
			}
<span class="nc" id="L1051">			rs.close();</span>
<span class="nc" id="L1052">			ps.close();</span>
<span class="nc" id="L1053">			db_conn.close();</span>
<span class="nc" id="L1054">			db_conn = null;</span>
<span class="nc" id="L1055">			rs = null;</span>
<span class="nc" id="L1056">			ps = null;</span>
		}
<span class="nc" id="L1058">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L1061" title="All 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="nc bnc" id="L1062" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L1063" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L1064">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="nc" id="L1066">		return (ret);</span>
	}

	/**
	 *  zoznam vyhladavani pre danne query
	 *
	 *@return   List s nazvom servera a poctom pristupov
	 */
	public static List&lt;Column&gt; getQueries(java.util.Date from, java.util.Date to, String query)
	{
<span class="fc" id="L1076">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L1078">		String[] suffixes = StatNewDB.getTableSuffix(&quot;stat_searchengine&quot;, from.getTime(), to.getTime());</span>
<span class="fc bfc" id="L1079" title="All 2 branches covered.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="fc" id="L1081">			Connection db_conn = null;</span>
<span class="fc" id="L1082">			PreparedStatement ps = null;</span>
<span class="fc" id="L1083">			ResultSet rs = null;</span>
			try
			{
<span class="fc" id="L1086">				db_conn = DBPool.getConnection();</span>

<span class="fc" id="L1088">				String sql = &quot;SELECT * FROM stat_searchengine&quot;+suffixes[s]+&quot; s WHERE &quot;+DB.fixAiCiCol(&quot;s.query&quot;)+&quot; = ?&quot;;</span>


<span class="fc" id="L1091">				sql += &quot; AND search_date &gt;= ? AND search_date &lt;= ? &quot;;</span>


<span class="fc" id="L1094">				sql += &quot;ORDER BY search_date ASC&quot;;</span>

<span class="fc" id="L1096">				ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L1097">				ps.setString(1, DB.fixAiCiValue(query));</span>

<span class="fc" id="L1099">				ps.setTimestamp(2, new Timestamp(from.getTime()));</span>
<span class="fc" id="L1100">				ps.setTimestamp(3, new Timestamp(to.getTime()));</span>


<span class="fc" id="L1103">				rs = ps.executeQuery();</span>
				//iteruj cez riadky
				Column col;
<span class="fc" id="L1106">				GroupsDB groupsDB = GroupsDB.getInstance();</span>
				int docId;
<span class="fc" id="L1108">				DocDB docDB = DocDB.getInstance();</span>
				DocDetails bdd;
<span class="fc bfc" id="L1110" title="All 2 branches covered.">				while (rs.next())</span>
				{
<span class="fc" id="L1112">					col = new Column();</span>

<span class="fc" id="L1114">					docId = rs.getInt(&quot;doc_id&quot;);</span>
<span class="fc" id="L1115">					bdd = docDB.getBasicDocDetails(docId, true);</span>
<span class="fc" id="L1116">					col.setDateColumn1(rs.getTimestamp(&quot;search_date&quot;));</span>
<span class="fc" id="L1117">					col.setColumn1(rs.getString(&quot;server&quot;));</span>
<span class="fc" id="L1118">					col.setColumn2(groupsDB.getPath(bdd.getGroupId())+&quot;/&quot;+bdd.getTitle());</span>
<span class="fc" id="L1119">					col.setColumn3(rs.getString(&quot;remote_host&quot;));</span>

<span class="fc" id="L1121">					ret.add(col);</span>

				}
<span class="fc" id="L1124">				rs.close();</span>
<span class="fc" id="L1125">				ps.close();</span>
<span class="fc" id="L1126">				db_conn.close();</span>
<span class="fc" id="L1127">				db_conn = null;</span>
<span class="fc" id="L1128">				rs = null;</span>
<span class="fc" id="L1129">				ps = null;</span>
			}
<span class="nc" id="L1131">			catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
			finally{
				try{
<span class="pc bpc" id="L1134" title="1 of 2 branches missed.">					if (rs != null) rs.close();</span>
<span class="pc bpc" id="L1135" title="1 of 2 branches missed.">					if (ps != null) ps.close();</span>
<span class="pc bpc" id="L1136" title="1 of 2 branches missed.">					if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L1137">				}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
			}
		}
<span class="fc" id="L1140">		return (ret);</span>
	}

	private static void logError(Exception ex) {
<span class="nc" id="L1144">		String message = ex.getMessage();</span>
<span class="nc bnc" id="L1145" title="All 6 branches missed.">		if (message.contains(&quot;Invalid object name&quot;) || message.contains(&quot;Invalid column name&quot;) || message.contains(&quot;ORA-00942&quot;) ||</span>
<span class="nc bnc" id="L1146" title="All 6 branches missed.">			message.contains(&quot;Unknown column&quot;) || message.contains(&quot;doesn't exist&quot;) || ex.getLocalizedMessage().contains(&quot;doesn't exist&quot;))</span>
		{
			//table doesn't exists, do not log error
		} else {
<span class="nc" id="L1150">			Logger.error(StatTableDB.class, ex);</span>
		}
<span class="nc" id="L1152">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>