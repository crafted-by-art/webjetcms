<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdminLogonController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.logon</a> &gt; <span class="el_source">AdminLogonController.java</span></div><h1>AdminLogonController.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.logon;

import java.util.Hashtable;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.struts.util.ResponseUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;

import sk.iway.Password;
import sk.iway.iwcm.Adminlog;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.InitServlet;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.PageLng;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.common.LogonTools;
import sk.iway.iwcm.components.users.userdetail.UserDetailsService;
import sk.iway.iwcm.doc.DocDB;
import sk.iway.iwcm.doc.DocDetails;
import sk.iway.iwcm.doc.GroupDetails;
import sk.iway.iwcm.doc.GroupsDB;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.stat.StatDB;
import sk.iway.iwcm.system.googleauth.GoogleAuthenticator;
import sk.iway.iwcm.system.googleauth.GoogleAuthenticatorKey;
import sk.iway.iwcm.system.googleauth.GoogleAuthenticatorQRGenerator;
import sk.iway.iwcm.system.ntlm.AuthenticationFilter;
import sk.iway.iwcm.system.spring.SpringUrlMapping;
import sk.iway.iwcm.users.PasswordSecurity;
import sk.iway.iwcm.users.UsersDB;

/**
 * LogonController.java
 *
 * Class LogonController is used for
 *
 *
 * Title        webjet8
 * Company      Interway a.s. (www.interway.sk)
 * Copyright    Interway a.s. (c) 2001-2018
 * @author      $Author: mhruby $
 * @version     $Revision: 1.0 $
 * created      14.9.2018 10:55
 * modified     14.9.2018 10:55
 */

@Controller
@RequestMapping(&quot;/admin/&quot;)
public class AdminLogonController {

    private static final String LOGON_FORM = &quot;/admin/skins/webjet8/logon-spring&quot;;
    private static final String CHANGE_PASSWORD_FORM = &quot;/admin/skins/webjet8/logon-spring-change-password&quot;;
    private static final String TWOFA_PASSWORD_FORM = &quot;/admin/skins/webjet8/logon-spring-2fa&quot;;
    private static final String LICENSE = &quot;/wjerrorpages/setup/license&quot;;

    @SuppressWarnings(&quot;unused&quot;)
    private final AuthenticationManager authenticationManager;

    @Autowired
<span class="fc" id="L74">    public AdminLogonController(AuthenticationManager authenticationManager) {</span>
<span class="fc" id="L75">        this.authenticationManager = authenticationManager;</span>
<span class="fc" id="L76">    }</span>


    @PostMapping(&quot;logon/changePassword&quot;)
    public String edit(@ModelAttribute(&quot;userForm&quot;) UserForm userForm, ModelMap model, HttpServletRequest request, HttpServletResponse response, HttpSession session) {
<span class="fc" id="L81">        Identity user = (Identity)session.getAttribute(Constants.USER_KEY+&quot;_changepassword&quot;);</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        if (user == null) {</span>
            // zaskodnik tu nema co robit
<span class="nc" id="L84">            return LOGON_FORM;</span>
        }
<span class="fc" id="L86">        Prop prop = Prop.getInstance(request.getServletContext(), request);</span>
<span class="fc" id="L87">        model.addAttribute(&quot;userForm&quot;, userForm);</span>

        // je tam daco a je to rovnake?
<span class="pc bpc" id="L90" title="2 of 6 branches missed.">        if(Tools.isEmpty(userForm.getNewPassword()) || Tools.isEmpty(userForm.getRetypeNewPassword()) || !(userForm.getNewPassword().equals(userForm.getRetypeNewPassword()))) {</span>
<span class="fc" id="L91">            model.addAttribute(&quot;errors&quot;, prop.getText(&quot;logon.change_password.password_not_match&quot;));</span>
<span class="fc" id="L92">            return CHANGE_PASSWORD_FORM;</span>
        }

<span class="pc bpc" id="L95" title="3 of 6 branches missed.">        if (Constants.getBoolean(&quot;passwordUseHash&quot;) &amp;&amp; user.getPassword().equals(PasswordSecurity.calculateHash(userForm.getNewPassword(), user.getSalt())) || user.getPassword().equals(userForm.getNewPassword())) {</span>
            // povodne heslo je rovnake ako nove heslo
<span class="nc" id="L97">            model.addAttribute(&quot;errors&quot;, prop.getText(&quot;logon.change_password.old_password_match_new&quot;));</span>
<span class="nc" id="L98">            return CHANGE_PASSWORD_FORM;</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">        } else if (Password.checkPassword(true, userForm.getNewPassword(), true, user.getUserId(), session, null)){</span>
<span class="fc" id="L100">            user.setPasswordPlain(userForm.getNewPassword());</span>
            //UsersDB.saveUser(user);
<span class="fc" id="L102">            UserDetailsService.savePassword(userForm.getNewPassword(), user.getUserId());</span>
<span class="fc" id="L103">            Adminlog.add(Adminlog.TYPE_USER_CHANGE_PASSWORD, user.getUserId(), &quot;UsrLogonAction - user (&quot;+user.getLogin()+&quot;) successfully changed password&quot;, -1, -1);</span>
<span class="fc" id="L104">            session.removeAttribute(Constants.USER_KEY+&quot;_changepassword&quot;);</span>
<span class="fc" id="L105">            LogonTools.setUserToSession(session, user);</span>
<span class="fc" id="L106">            this.determineLanguage(session, request, response);</span>
<span class="fc" id="L107">            this.determineDefaultWebPagesDirectory(user, session);</span>
<span class="fc" id="L108">            this.checkForNewHelp(session, user);</span>
<span class="fc" id="L109">            this.determineRootWebPageDirectory(session, user);</span>
<span class="fc" id="L110">            String forwardAfterToken = (String)session.getAttribute(&quot;adminAfterLogonRedirect&quot;);</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">            if (Tools.isEmpty(forwardAfterToken))</span>
<span class="fc" id="L112">                return &quot;redirect:/admin/v9/&quot;;</span>
<span class="nc" id="L113">            return &quot;redirect:&quot; + forwardAfterToken;</span>
        } else {
<span class="fc" id="L115">            return CHANGE_PASSWORD_FORM;</span>
        }
    }

    @GetMapping(&quot;logon.struts&quot;)
    @PostMapping(&quot;logon.struts&quot;)
    //presmerovanie stareho Struts volania /admin/logon.do na novy form
    public String logonDoRedirect() {
<span class="fc" id="L123">        return &quot;redirect:/admin/logon/&quot;;</span>
    }

    @GetMapping(&quot;logon/&quot;)
    public String showForm(UserForm userForm, HttpServletRequest request, HttpSession session)
    {
<span class="fc" id="L129">        Identity user = UsersDB.getCurrentUser(session);</span>
<span class="fc bfc" id="L130" title="All 4 branches covered.">        if (user != null &amp;&amp; user.isAdmin())</span>
        {
            //user je uz prihlaseny, preforwardnime ho na /admin/
<span class="fc" id="L133">            return &quot;redirect:/admin/v9/&quot;;</span>
        }

        //--------------Prihlasenie prebieha cez NTLM, nema sa co prihlasovat cez formularik-----------
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">        if (AuthenticationFilter.weTrustIIS())</span>
        {
<span class="nc" id="L139">            return &quot;redirect:&quot;+ AuthenticationFilter.getForbiddenURL();</span>
        }

<span class="pc bpc" id="L142" title="1 of 6 branches missed.">        if  (request.getParameter(&quot;language&quot;)==null &amp;&amp; request.getSession().getAttribute(Prop.SESSION_I18N_PROP_LNG)==null &amp;&amp; Tools.isNotEmpty(Constants.getString(&quot;defaultLanguage&quot;)))</span>
        {
<span class="nc" id="L144">            request.getSession().setAttribute(Prop.SESSION_I18N_PROP_LNG, Constants.getString(&quot;defaultLanguage&quot;));</span>
        }

<span class="fc" id="L147">        String adminHost = Constants.getString(&quot;multiDomainAdminHost&quot;);</span>
//out.println(&quot;adminHost=&quot;+adminHost+&quot; domain=&quot;+DocDB.getDomain(request));

<span class="fc" id="L150">        String serverName = Tools.getServerName(request);</span>
<span class="pc bpc" id="L151" title="7 of 8 branches missed.">        if ((&quot;iwcm.interway.sk&quot;.equals(request.getServerName())==false &amp;&amp; &quot;localhost&quot;.equals(request.getServerName())==false) &amp;&amp; Tools.isNotEmpty(adminHost) &amp;&amp; (&quot;,&quot;+adminHost+&quot;,&quot;).indexOf(&quot;,&quot;+serverName+&quot;,&quot;)==-1)</span>
        {
<span class="nc bnc" id="L153" title="All 2 branches missed.">            if (Constants.getBoolean(&quot;adminLogonShowSimpleErrorMessage&quot;))</span>
            {
<span class="nc" id="L155">                return &quot;/404.jsp&quot;;</span>
            }
            else
            {
<span class="nc" id="L159">                String[] hosts = Tools.getTokens(adminHost, &quot;,&quot;);</span>
<span class="nc" id="L160">                return &quot;redirect:&quot;+request.getScheme()+&quot;://&quot;+hosts[0]+&quot;/admin/&quot;;</span>
            }
        }

<span class="pc bpc" id="L164" title="1 of 2 branches missed.">        if (Tools.isNotEmpty(Constants.getString(&quot;defaultLanguage&quot;))) userForm.setLanguage(Constants.getString(&quot;defaultLanguage&quot;));</span>

<span class="fc" id="L166">        String language = request.getParameter(&quot;language&quot;);</span>
<span class="pc bpc" id="L167" title="1 of 4 branches missed.">        if (Tools.isNotEmpty(language) &amp;&amp; language.length()==2)</span>
        {
<span class="fc" id="L169">            userForm.setLanguage(language);</span>
        }

<span class="fc" id="L172">        LogonTools.saveAfterLogonRedirect(request);</span>

<span class="pc bpc" id="L174" title="1 of 2 branches missed.">        if(request.getParameter(&quot;loginName&quot;) != null)</span>
        {
<span class="nc" id="L176">            String loginName = request.getParameter(&quot;loginName&quot;);</span>
<span class="nc" id="L177">            UsersDB.sendPassword(request,loginName);</span>
        }

<span class="fc" id="L180">        return LOGON_FORM;</span>
    }

    @PostMapping(&quot;logon/&quot;)
    public String submit(@ModelAttribute(&quot;userForm&quot;) UserForm userForm, BindingResult result, ModelMap model, HttpServletRequest request, HttpServletResponse response) {
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">        if (InitServlet.verify(request) == false)</span>
<span class="nc" id="L186">            return SpringUrlMapping.redirect(LICENSE);</span>

        //session fixation ochrana
<span class="fc" id="L189">        LogonTools.invalidateSessionOnFirstPost(request);</span>
<span class="fc" id="L190">        HttpSession session = request.getSession();</span>

<span class="fc" id="L192">        Prop prop = Prop.getInstance(request.getServletContext(), request);</span>

<span class="fc" id="L194">        String twoFaRedirect = verify2FaKey(request);</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">        if (Tools.isNotEmpty(twoFaRedirect)) return twoFaRedirect;</span>

<span class="fc" id="L197">        Identity user = new Identity();</span>
<span class="fc" id="L198">        Map&lt;String, String&gt; errors = new Hashtable&lt;&gt;();</span>
<span class="fc" id="L199">        LogonTools.logon(userForm.getUsername(), userForm.getPassword(), user, errors, request, prop);</span>

<span class="fc bfc" id="L201" title="All 2 branches covered.">        if (errors.get(&quot;ERROR_KEY&quot;)!=null) {</span>
<span class="fc" id="L202">            Logger.error(this,&quot;su nejake chyby v logovacom formulari&quot;);</span>
<span class="fc" id="L203">            model.addAttribute(&quot;errors&quot;, errors.get(&quot;ERROR_KEY&quot;));</span>
<span class="fc" id="L204">            return LOGON_FORM;</span>
        }

        // Save our logged-in userForm in the session
<span class="fc" id="L208">        user.setLoginName(userForm.getUsername());</span>
<span class="fc" id="L209">        user.setValid(true);</span>

        // pouzivatel je prihlaseny
<span class="fc" id="L212">        LogonTools.setUserToSession(session, user);</span>

<span class="fc bfc" id="L214" title="All 2 branches covered.">        if (!(Password.checkPassword(true, userForm.getPassword(), user.isAdmin(), user.getUserId(), session, null))) {</span>
            // ma slabe heslo
<span class="fc" id="L216">            session.removeAttribute(Constants.USER_KEY);</span>
<span class="fc" id="L217">            session.setAttribute(Constants.USER_KEY+&quot;_changepassword&quot;, user);</span>
<span class="fc" id="L218">            userForm.setPassword(userForm.getPassword().replace(&quot;.&quot;, &quot;*&quot;)); // bezpecny placeholder</span>
<span class="fc" id="L219">            model.addAttribute(&quot;userForm&quot;, userForm);</span>
<span class="fc" id="L220">            model.addAttribute(&quot;isAdmin&quot;, user.isAdmin());</span>
<span class="fc" id="L221">            return CHANGE_PASSWORD_FORM;</span>
        }

<span class="fc" id="L224">		twoFaRedirect = set2FaAuthForm(user, request);</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">        if (Tools.isNotEmpty(twoFaRedirect)) return twoFaRedirect;</span>


<span class="fc" id="L228">        this.determineLanguage(session, request, response);</span>
<span class="fc" id="L229">        this.determineDefaultWebPagesDirectory(user, session);</span>
<span class="fc" id="L230">        this.checkForNewHelp(session, user);</span>
<span class="fc" id="L231">        this.determineRootWebPageDirectory(session, user);</span>
<span class="fc" id="L232">        StatDB.addAdmin(request);</span>

<span class="fc" id="L234">        String adminAfterLogonRedirect = (String)session.getAttribute(&quot;adminAfterLogonRedirect&quot;);</span>
<span class="fc bfc" id="L235" title="All 2 branches covered.">        if (Tools.isNotEmpty(adminAfterLogonRedirect)) {</span>
<span class="pc bpc" id="L236" title="5 of 6 branches missed.">            if (adminAfterLogonRedirect.startsWith(&quot;/admin/v9/&quot;) || (adminAfterLogonRedirect.startsWith(&quot;/apps/&quot;) &amp;&amp; adminAfterLogonRedirect.contains(&quot;/admin/&quot;))) {</span>
<span class="fc" id="L237">                return &quot;redirect:&quot; + adminAfterLogonRedirect;</span>
            }
        }

<span class="fc" id="L241">        return &quot;redirect:/admin/v9/&quot;;</span>
    }



    private void determineLanguage(HttpSession session, HttpServletRequest request, HttpServletResponse response) {
<span class="fc" id="L247">        String lng = ResponseUtils.filter(request.getParameter(&quot;language&quot;));</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">        if (Tools.isEmpty(lng)) lng = Constants.getString(&quot;defaultLanguage&quot;);</span>
<span class="fc" id="L249">        PageLng.setUserLng(request, response, lng);</span>
<span class="fc" id="L250">        session.setAttribute(Prop.SESSION_I18N_PROP_LNG, lng);</span>
<span class="fc" id="L251">    }</span>

    private void determineDefaultWebPagesDirectory(Identity user, HttpSession session) {
        //nastav predvoleny adresar na Moje Stranky
<span class="pc bpc" id="L255" title="2 of 6 branches missed.">        if (user.getEditablePages()!=null &amp;&amp; user.getEditablePages().length()&gt;0 &amp;&amp; user.isDisabledItem(&quot;menuUsers&quot;))</span>
<span class="fc" id="L256">            session.setAttribute(Constants.SESSION_GROUP_ID, Constants.getInt(&quot;systemPagesMyPages&quot;));</span>

        //nastav predvoleny adresar Na Schalenie
<span class="fc" id="L259">        DocDB docDB = DocDB.getInstance();</span>
<span class="fc" id="L260">        List&lt;DocDetails&gt; docsToApprove = docDB.getDocsForApprove(user.getUserId());</span>
<span class="pc bpc" id="L261" title="1 of 4 branches missed.">        if (docsToApprove!=null &amp;&amp; docsToApprove.size()&gt;0)</span>
<span class="fc" id="L262">            session.setAttribute(Constants.SESSION_GROUP_ID, Integer.toString(Constants.getInt(&quot;systemPagesDocsToApprove&quot;)));</span>
<span class="fc" id="L263">    }</span>


    private void determineRootWebPageDirectory(HttpSession session, Identity user) {
<span class="fc bfc" id="L267" title="All 2 branches covered.">        if (Tools.isNotEmpty(user.getEditableGroups())) {</span>
            //prestav v session default host na prvy z editable groups
<span class="fc" id="L269">            int groupId = getUserFirstEditableGroup(user);</span>
<span class="pc bpc" id="L270" title="1 of 2 branches missed.">            if (groupId &gt; 0)</span>
<span class="fc" id="L271">                setSessionGroup(groupId, session);</span>
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">        } else if (Constants.getBoolean(&quot;enableStaticFilesExternalDir&quot;)) {</span>
<span class="fc" id="L273">            int groupId = Constants.getInt(&quot;rootGroupId&quot;);</span>
<span class="fc" id="L274">            setSessionGroup(groupId, session);</span>
        }
<span class="fc" id="L276">    }</span>

    private void checkForNewHelp(HttpSession session, Identity user) {
        //ziskaj datum posledneho prihlasenia a datum najnovsej novinky
        /*try
        {
            IwcmFile[] newHelpFiles = (new IwcmFile(Tools.getRealPath(&quot;/admin/help/sk/new&quot;))).listFiles();
            Arrays.sort(newHelpFiles,
                    new Comparator&lt;IwcmFile&gt;()
                    {
                        @Override
                        public int compare(IwcmFile f1, IwcmFile f2)
                        {
                            if (f1.isDirectory())
                            {
                                //return(-1);
                            }
                            if (f2.isDirectory())
                            {
                                //return(1);
                            }

                            int lm1 = 0;
                            int lm2 = 0;

                            try
                            {
                                if (f1.isFile()) lm1 = Tools.getIntValue(f1.getName().substring(0, f1.getName().indexOf('.')), -1);
                                if (f2.isFile()) lm2 = Tools.getIntValue(f2.getName().substring(0, f2.getName().indexOf('.')), -1);
                            }
                            catch (Exception e)
                            {
                                //ignoruj
                            }

                            //Logger.println(this,&quot;compare: &quot; + lm1 + &quot; &quot; + f1.getName() + &quot; vs &quot; + lm2 + &quot; &quot; + f2.getName());

                            if (lm1 == lm2) return(0);
                            else if (lm1 &gt; lm2) return(-1);
                            else return(1);
                        }
                    });

            //najnovsi je na pozicii 0
            IwcmFile newestHelpFile = newHelpFiles[0];
            //Logger.println(this,&quot;NEWEST: &quot; + newestHelpFile.getName());

            //skontroluj, ci uz videl tento subor
            long lastSeenDate = Adminlog.getLastDate(Adminlog.TYPE_HELP_LAST_SEEN, user.getUserId());

            if (lastSeenDate &lt; newestHelpFile.lastModified())
            {
                //este nevidel, treba mu zobrazit
                session.setAttribute(&quot;show_help_file_after_logon&quot;, newestHelpFile.getName());
                Adminlog.add(Adminlog.TYPE_HELP_LAST_SEEN, user.getUserId(), &quot;helpfile: &quot; + newestHelpFile.getName(), -1, -1);
            }
        }
        catch (Exception e)
        {
            Logger.error(AdminLogonController.class, e);
        }*/
<span class="fc" id="L337">    }</span>

    /**
     * Nastavi session ID adresara web stranok a preview domenu
     * @param groupId
     * @param session
     */
    private static void setSessionGroup(int groupId, HttpSession session)
    {
<span class="fc" id="L346">        session.setAttribute(Constants.SESSION_GROUP_ID, String.valueOf(groupId));</span>

<span class="fc" id="L348">        GroupDetails root = GroupsDB.getInstance().getGroup(groupId);</span>
<span class="pc bpc" id="L349" title="1 of 4 branches missed.">        if (root != null &amp;&amp; Tools.isNotEmpty(root.getDomainName()))</span>
        {
<span class="fc" id="L351">            session.setAttribute(&quot;preview.editorDomainName&quot;, root.getDomainName());</span>
        }
<span class="fc" id="L353">    }</span>

    /**
     * Overi odoslanu hodnotu 2FA cisla, ak je nespravna vrati linku na formular, inak presmerovanie do administracie
     * Vrati NULL ak 2FA nie je aktivovana
     * @param request
     * @return
     */
    private static String verify2FaKey(HttpServletRequest request) {
<span class="fc" id="L362">        HttpSession session = request.getSession();</span>
<span class="pc bpc" id="L363" title="1 of 2 branches missed.">        if (session.getAttribute(&quot;token&quot;)!=null)</span>
		{
			//ocakava sa token
<span class="nc" id="L366">			String generatedToken = (String)session.getAttribute(&quot;token&quot;);</span>

			try{

<span class="nc" id="L370">				String insertedCodeString = request.getParameter(&quot;token&quot;);</span>
<span class="nc" id="L371">				int insertedCode = Integer.parseInt(insertedCodeString);</span>

<span class="nc" id="L373">				GoogleAuthenticator gAuth = new GoogleAuthenticator();</span>

<span class="nc" id="L375">				int generatedCode = gAuth.getTotpPassword(generatedToken);</span>

<span class="nc" id="L377">				Logger.debug(AdminLogonController.class,&quot;userToken : &quot; + insertedCode + &quot;\n token : &quot;+gAuth.getTotpPassword(generatedToken)+ &quot;\n code : &quot;+generatedCode );</span>

<span class="nc bnc" id="L379" title="All 2 branches missed.">				if (insertedCode == generatedCode)</span>
				{
<span class="nc" id="L381">					session.removeAttribute(&quot;token&quot;);</span>
<span class="nc" id="L382">					Identity sessionUserAfterToken = (Identity)session.getAttribute(&quot;adminUser_waitingForToken&quot;);</span>
<span class="nc" id="L383">					session.removeAttribute(&quot;adminUser_waitingForToken&quot;);</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">					if (sessionUserAfterToken!=null) LogonTools.setUserToSession(session, sessionUserAfterToken);</span>

<span class="nc" id="L386">					return &quot;redirect:/admin/v9/&quot;;</span>
				}

<span class="nc" id="L389">			}catch (NumberFormatException e){</span>
                //asi nebolo zadane cislo, cize kod je zly
<span class="nc" id="L391">			}</span>
			//ak nie znova vrat logon
<span class="nc" id="L393">			request.setAttribute(&quot;errors&quot;, &quot;wrongCode&quot;);</span>
			//wrongCode
<span class="nc" id="L395">			return TWOFA_PASSWORD_FORM;</span>
		}
<span class="fc" id="L397">        return null;</span>
    }

    /**
     * Overi ci je zapnute 2FA, ak ano, vrati linku na formular
     * @param user
     * @param session
     * @return
     */
    private String set2FaAuthForm(Identity user, HttpServletRequest request) {

        //ak je aktivovana dvojfaktorova autentifikacia a user ma nastaveny devicekey
<span class="pc bpc" id="L409" title="1 of 4 branches missed.">        if (Tools.isNotEmpty(user.getMobileDevice()) || Constants.getBoolean(&quot;isGoogleAuthRequiredForAdmin&quot;) ) {</span>
<span class="fc" id="L410">            HttpSession session = request.getSession();</span>

<span class="pc bpc" id="L412" title="1 of 2 branches missed.">            if (Tools.isEmpty(user.getMobileDevice())) {  // - je forced gauth ^ cfg premennou</span>
<span class="nc" id="L413">                GoogleAuthenticator gAuth = new GoogleAuthenticator();</span>
<span class="nc" id="L414">                final GoogleAuthenticatorKey key = gAuth.createCredentials();</span>
<span class="nc" id="L415">                session.setAttribute(&quot;token&quot;, key.getKey());	// hodime si do session novo vygenerovane credentials</span>
<span class="nc" id="L416">                session.setAttribute(&quot;QRURL&quot;, GoogleAuthenticatorQRGenerator.getOtpAuthURL(&quot;WebJET &quot; + Constants.getInstallName() + &quot; (&quot; + Tools.getServerName(request) + &quot;)&quot;, user.getLogin(), key));</span>
<span class="nc" id="L417">                session.setAttribute(&quot;scratchcode&quot;, key.getScratchCodes().get(0).toString());</span>
<span class="nc" id="L418">            }else{</span>
<span class="fc" id="L419">                session.setAttribute(&quot;token&quot;, user.getMobileDevice());</span>
            }

            // Google Authenticator
            //String token = RandomStringUtils.random(4, false, true);
            //sendToken(user.getMobileDevice(), token);
<span class="fc" id="L425">            session.setAttribute(&quot;adminUser_waitingForToken&quot;, user);</span>
<span class="fc" id="L426">            session.removeAttribute(Constants.USER_KEY);</span>
            //Logger.debug(LogonAction.class, &quot;LogonAction dualFactorToken: &quot;+user.getMobileDevice());
            // zobraz naspat admin
<span class="fc" id="L429">            return TWOFA_PASSWORD_FORM;</span>

        }

<span class="fc" id="L433">        return null;</span>
    }

    public static int getUserFirstEditableGroup(Identity user)
	{
<span class="fc" id="L438">		int[] editableGroups = Tools.getTokensInt(user.getEditableGroups(), &quot;,&quot;);</span>
<span class="pc bpc" id="L439" title="2 of 4 branches missed.">		if (editableGroups!=null &amp;&amp; editableGroups.length&gt;0)</span>
		{
<span class="pc bpc" id="L441" title="1 of 2 branches missed.">			for (int groupId : editableGroups)</span>
			{
<span class="pc bpc" id="L443" title="1 of 2 branches missed.">				if (groupId &gt; 0)</span>
				{
<span class="fc" id="L445">					return groupId;</span>
				}
			}
		}
<span class="nc" id="L449">		return -1;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>