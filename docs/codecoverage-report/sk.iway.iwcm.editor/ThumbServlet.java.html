<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ThumbServlet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.editor</a> &gt; <span class="el_source">ThumbServlet.java</span></div><h1>ThumbServlet.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.editor;

import java.io.BufferedInputStream;
import java.io.IOException;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.servlet.ServletException;
import javax.servlet.ServletOutputStream;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import sk.iway.iwcm.Constants;
import sk.iway.iwcm.FileTools;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.PathFilter;
import sk.iway.iwcm.SpamProtection;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.common.DocTools;
import sk.iway.iwcm.common.GalleryDBTools;
import sk.iway.iwcm.common.WriteTagToolsForCore;
import sk.iway.iwcm.filebrowser.EditForm;
import sk.iway.iwcm.gallery.GalleryBean;
import sk.iway.iwcm.gallery.GalleryDB;
import sk.iway.iwcm.io.IwcmFile;
import sk.iway.iwcm.io.IwcmInputStream;
import sk.iway.iwcm.system.context.ContextFilter;
import sk.iway.iwcm.system.multidomain.MultiDomainFilter;
import sk.iway.iwcm.users.UsersDB;

/**
 *  Vytvara a cachuje nahladove obrazky pre editor
 *
 *@Title        WebJET
 *@Company      Interway s.r.o. (www.interway.sk)
 *@Copyright    Interway s.r.o. (c) 2001-2002
 *@author       $Author: jeeff $
 *@version      $Revision: $
 *@created      Nedela, 2004, apr 18
 *@modified     $Date: $
 */
@SuppressWarnings({&quot;java:S1075&quot;, &quot;java:S1989&quot;})
@WebServlet(name = &quot;thumbServlet&quot;, urlPatterns = {&quot;/admin/thumb/*&quot;, &quot;/thumb/*&quot;, &quot;/tumbn/*&quot;})
<span class="fc" id="L50">public class ThumbServlet extends HttpServlet</span>
{
	private static final String FILL_COLOR_DEFAULT = &quot;ffffff&quot;;

	/**
	 * Comment for &lt;code&gt;serialVersionUID&lt;/code&gt;
	 */
	private static final long serialVersionUID = -8491779689090189385L;

<span class="fc" id="L59">	private static Pattern pattern = Pattern.compile(&quot;[a-z\\-_0-9A-Z]*-(\\d+)x(\\d+)(ip(\\d))?(c([\\da-f]+))?(q(\\d+))?\\.[a-z]{3,4}\\b&quot;);</span>

	//public static final String CACHE_DIR = &quot;/WEB-INF/imgcache/&quot;;


	@Override
	public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException
	{
<span class="fc" id="L67">		String path = (String) request.getAttribute(&quot;path_filter_orig_path&quot;);</span>

<span class="pc bpc" id="L69" title="2 of 4 branches missed.">        if (Tools.isEmpty(path) || path.length()&lt;9)</span>
        {
<span class="nc" id="L71">            sk.iway.iwcm.Encoding.setResponseEnc(request, response, &quot;text/html&quot;);</span>
<span class="nc" id="L72">            response.setStatus(404);</span>
<span class="nc" id="L73">            response.getWriter().print(&quot;&lt;html&gt;&lt;body&gt;404 - not found&lt;/body&gt;&lt;/html&gt;&quot;);</span>
<span class="nc" id="L74">            return;</span>
        }

<span class="pc bpc" id="L77" title="1 of 2 branches missed.">		if (path.startsWith(&quot;/admin/thumb/&quot;)){</span>
<span class="nc" id="L78">			path = path.substring(13);</span>
		}else{
<span class="fc" id="L80">			path = path.substring(7);</span>
		}

<span class="fc" id="L83">		path = Tools.replace(path, &quot;%20&quot;, &quot; &quot;);</span>

<span class="fc" id="L85">		getThumbImage(path, request, response);</span>
<span class="fc" id="L86">	}</span>

 //na metodu sa nic neodkazuje nie je potrebna
//	public static void getThumbImage(String imagePath, HttpServletResponse response) throws IOException, ServletException
//	{
//		getThumbImage(imagePath, null, response);
//	}

	public static void getThumbImage(String imagePath, HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException
	{
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">		if (Tools.isEmpty(imagePath))</span>
		{
<span class="nc" id="L98">			sk.iway.iwcm.Encoding.setResponseEnc(request, response, &quot;text/html&quot;);</span>
<span class="nc" id="L99">			response.setStatus(404);</span>
<span class="nc" id="L100">			response.getWriter().print(&quot;&lt;html&gt;&lt;body&gt;404 - not found&lt;/body&gt;&lt;/html&gt;&quot;);</span>
<span class="nc" id="L101">			return;</span>
		}
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">		if (imagePath.startsWith(&quot;//&quot;)) imagePath = imagePath.substring(2);</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">		if (imagePath.startsWith(&quot;/&quot;)) imagePath = imagePath.substring(1);</span>

<span class="pc bpc" id="L106" title="3 of 4 branches missed.">		if (ContextFilter.isRunning(request) &amp;&amp; imagePath.length()&gt;request.getContextPath().length()+3)</span>
		{
<span class="nc" id="L108">			imagePath = ContextFilter.removeContextPath(request.getContextPath(), &quot;/&quot;+imagePath).substring(1);</span>
		}

<span class="pc bpc" id="L111" title="2 of 4 branches missed.">		if (Constants.getBoolean(&quot;multiDomainEnabled&quot;) &amp;&amp; Constants.getBoolean(&quot;enableStaticFilesExternalDir&quot;)==false)</span>
		{
<span class="nc" id="L113">			String origPath = imagePath;</span>
<span class="nc" id="L114">			imagePath = MultiDomainFilter.rewriteUrlToLocal(&quot;/&quot;+imagePath, request).substring(1);</span>
<span class="nc bnc" id="L115" title="All 4 branches missed.">			if (FileTools.isFile(&quot;/&quot;+imagePath)==false &amp;&amp; FileTools.isFile(&quot;/&quot;+origPath))</span>
			{
				//if imagePath doesn't exists and origPath yes, use origPath (probably it's not multidomain folder)
<span class="nc" id="L118">				imagePath = origPath;</span>
			}
		}

<span class="fc" id="L122">		String ext = FileTools.getFileExtension(imagePath).toLowerCase();</span>
<span class="pc bpc" id="L123" title="2 of 10 branches missed.">		if (ext.equals(&quot;jpg&quot;)==false &amp;&amp; ext.equals(&quot;jpeg&quot;)==false &amp;&amp; ext.equals(&quot;gif&quot;)==false &amp;&amp; ext.equals(&quot;png&quot;)==false &amp;&amp; ext.equals(&quot;bmp&quot;)==false)</span>
		{
			//sk.iway.iwcm.Encoding.setResponseEnc(request, response, &quot;text/html&quot;);
<span class="fc" id="L126">			response.setStatus(302);</span>
<span class="fc" id="L127">			response.setHeader(&quot;Location&quot;, &quot;/&quot;+imagePath);</span>
<span class="fc" id="L128">			response.getWriter().print(&quot;&lt;html&gt;&lt;body&gt;404 - not found&lt;/body&gt;&lt;/html&gt;&quot;);</span>
<span class="fc" id="L129">			return;</span>
		}

<span class="pc bpc" id="L132" title="8 of 16 branches missed.">		if ( (imagePath.startsWith(&quot;images/&quot;)==false &amp;&amp; imagePath.startsWith(&quot;files/&quot;)==false &amp;&amp; imagePath.startsWith(&quot;shared/&quot;)==false &amp;&amp; imagePath.startsWith(&quot;video/&quot;)==false &amp;&amp; imagePath.startsWith(&quot;templates/&quot;)==false &amp;&amp; imagePath.indexOf(&quot;grideditor&quot;)==-1 &amp;&amp; imagePath.indexOf(&quot;thumb&quot;)==-1) || imagePath.indexOf(&quot;..&quot;)!=-1)</span>
		{
<span class="nc" id="L134">			sk.iway.iwcm.Encoding.setResponseEnc(request, response, &quot;text/html&quot;);</span>
<span class="nc" id="L135">			response.setStatus(404);</span>
<span class="nc" id="L136">			response.getWriter().print(&quot;&lt;html&gt;&lt;body&gt;404  - not found&lt;/body&gt;&lt;/html&gt;&quot;);</span>
<span class="nc" id="L137">			return;</span>
		}

		//ak nemame zadanu width ako parameter budeme resizovat z maleho obrazku (ak existuje), je to rychlejsie
<span class="fc" id="L141">		int sessionIdIndex = imagePath.indexOf(&quot;;jsessionid&quot;);</span>
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">		if (sessionIdIndex != -1)</span>
		{
<span class="nc" id="L144">			imagePath = imagePath.substring(0, sessionIdIndex);</span>
		}

<span class="pc bpc" id="L147" title="2 of 4 branches missed.">		if (imagePath != null &amp;&amp; imagePath.length()&gt;3)</span>
		{
			//pridaj installName (ak cesta neobsahuje) ak je to asset v /templates adresari
<span class="fc bfc" id="L150" title="All 2 branches covered.">         if (imagePath.startsWith(&quot;templates/&quot;)) imagePath = WriteTagToolsForCore.getCustomPage(&quot;/&quot;+imagePath, request).substring(1);</span>

			//kontrolujem prava
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">			EditForm ef = PathFilter.isPasswordProtected(imagePath.startsWith(&quot;/&quot;) == false ? &quot;/&quot;+imagePath : imagePath, request, request.getSession());</span>
<span class="fc" id="L154">			Identity user = UsersDB.getCurrentUser(request);</span>
<span class="pc bpc" id="L155" title="2 of 6 branches missed.">			if (ef != null &amp;&amp; (user == null || ef.isAccessibleFor(user)==false))</span>
			{
<span class="nc bnc" id="L157" title="All 4 branches missed.">				if (PathFilter.doFileForbiddenRedirect(ef, user, imagePath.startsWith(&quot;/&quot;) == false ? &quot;/&quot;+imagePath : imagePath, request, response)) return;</span>
			}

			//Logger.debug(ThumbServlet.class, &quot;imagePath=&quot;+imagePath+&quot; realPath&quot;+realPath);

			//nie je v cache, vygeneruj
<span class="fc" id="L163">			int width = Constants.getInt(&quot;imageThumbsWidth&quot;);</span>
<span class="fc" id="L164">			int height = Constants.getInt(&quot;imageThumbsHeight&quot;);</span>

<span class="fc" id="L166">			int ip = -1;</span>
<span class="fc" id="L167">			String fillColor = null;</span>
<span class="fc" id="L168">			int q = -1;</span>

			//if nie je potrebny triedy, metody referencovane na tuto metodu ho posielaju
			//if (request != null )
<span class="fc" id="L172">			boolean parsedFromName = false;</span>
<span class="pc bpc" id="L173" title="6 of 8 branches missed.">			if (request.getRequestURI().startsWith(&quot;/tumbn&quot;) || (request.getParameter(&quot;w&quot;)==null &amp;&amp; imagePath.indexOf(&quot;x&quot;)!=-1 &amp;&amp; imagePath.indexOf(&quot;-&quot;)!=-1))</span>
			{
<span class="nc" id="L175">				Logger.debug(ThumbServlet.class, &quot;Parsing file name &quot; + imagePath);</span>
				//skus to parsnut
				try
				{
<span class="nc" id="L179">					Matcher matcher = pattern.matcher(imagePath.substring(imagePath.lastIndexOf(&quot;/&quot;)+1));</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">					if (matcher.find())</span>
					{

<span class="nc" id="L183">						Logger.debug(ThumbServlet.class, &quot;Group count: &quot;+matcher.groupCount());</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">						for (int i=1; i &lt;= matcher.groupCount(); i++)</span>
						{
							//out.println(i+&quot;: &quot; + matcher.group());
<span class="nc" id="L187">							Logger.debug(ThumbServlet.class, &quot;Matcher: &quot;+i+&quot;: &quot; + matcher.group(i));</span>
						}


<span class="nc bnc" id="L191" title="All 2 branches missed.">						if (matcher.groupCount()==8)</span>
						{
<span class="nc" id="L193">							width = Tools.getIntValue(matcher.group(1), width);</span>
<span class="nc" id="L194">							height = Tools.getIntValue(matcher.group(2), height);</span>

<span class="nc" id="L196">							ip = Tools.getIntValue(matcher.group(4), -1);</span>
<span class="nc" id="L197">							fillColor = matcher.group(6);</span>

<span class="nc" id="L199">							q = Tools.getIntValue(matcher.group(8), -1);</span>

<span class="nc" id="L201">							parsedFromName = true;</span>

							//nastav korektny image path na povodny obrazok
<span class="nc" id="L204">							imagePath = imagePath.substring(0, imagePath.lastIndexOf(&quot;-&quot;)) + &quot;.&quot; + ext;</span>
						}
					}
				}
<span class="nc" id="L208">				catch (Exception e)</span>
				{
<span class="nc" id="L210">					sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L211">				}</span>
			}

<span class="fc" id="L214">			String realPath = PathFilter.getRealPath(&quot;/&quot;+imagePath);</span>
<span class="fc" id="L215">			IwcmFile imageFile = new IwcmFile(realPath);</span>
<span class="fc bfc" id="L216" title="All 2 branches covered.">			if (imageFile.exists()==false)</span>
			{
				//kukni ci neexistuje presmerovanie k danemu obrazku, pouzitie thumbServletMissingImg_/images/cesta/ibrazok.jpg je stary format,
				//je potrebne pouzit konstantu thumbServletMissingImg kde na kazdom riadku je cesta|cesta-k-obrazku.jpg
<span class="fc" id="L220">				boolean return404 = true;</span>
<span class="fc" id="L221">				String imgDirPath = &quot;/&quot;+imagePath.substring(0, imagePath.lastIndexOf(&quot;/&quot;)+1);</span>
<span class="fc" id="L222">				String replaceForMissingPath = Constants.getString(&quot;thumbServletMissingImg_&quot;+imgDirPath);</span>

<span class="pc bpc" id="L224" title="1 of 2 branches missed.">				if (Tools.isEmpty(replaceForMissingPath)) {</span>
					//skus novy format, kde v konf. premennej thumbServletMissingImg je na novom riadku definovane URL ktore sa hladaju
<span class="fc" id="L226">					String thumbServletMissingImg = Constants.getString(&quot;thumbServletMissingImg&quot;);</span>
<span class="fc" id="L227">					String bestMatch = null;</span>
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">					if (Tools.isNotEmpty(thumbServletMissingImg)) {</span>
						//eviduje vyraz ktory drzime, aby sa urcil best match
<span class="nc" id="L230">						int maxLenght = 0;</span>
<span class="nc" id="L231">						String[] urls = Tools.getTokens(thumbServletMissingImg, &quot;\n&quot;);</span>
<span class="nc bnc" id="L232" title="All 4 branches missed.">						if (urls!=null &amp;&amp; urls.length&gt;0) {</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">							for (String pair : urls) {</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">								if (Tools.isEmpty(pair)) continue;</span>
<span class="nc" id="L235">								String[] pairArray = pair.split(&quot;\\|&quot;);</span>
<span class="nc bnc" id="L236" title="All 4 branches missed.">								if (pairArray==null || pairArray.length!=2) continue;</span>

<span class="nc bnc" id="L238" title="All 4 branches missed.">								if (imgDirPath.startsWith(pairArray[0]) &amp;&amp; pairArray[0].length()&gt;maxLenght) {</span>
<span class="nc" id="L239">									bestMatch = pairArray[1];</span>
<span class="nc" id="L240">									maxLenght = pairArray[0].length();</span>
								}
							}
						}
					}
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">					if (bestMatch != null) {</span>
						//nafejkuj, ze tento obrazo mame nastaveny a existuje, potom z neho normalne spravi thumb
<span class="nc" id="L247">						imagePath = bestMatch.substring(1); //odstran prve lomitko, taky je format</span>
<span class="nc" id="L248">						realPath = PathFilter.getRealPath(&quot;/&quot;+imagePath);</span>
<span class="nc" id="L249">						imageFile = new IwcmFile(realPath);</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">						if (imageFile.exists()) return404 = false;</span>
					}
<span class="fc" id="L252">				}</span>
				else
				{
<span class="nc" id="L255">					Logger.debug(ThumbServlet.class, &quot;Replace for missing path '&quot;+imgDirPath+&quot;' - '&quot;+replaceForMissingPath+&quot;'&quot;);</span>

<span class="nc" id="L257">					IwcmFile replaceForMissingFile = new IwcmFile(PathFilter.getRealPath(&quot;/&quot;+replaceForMissingPath));</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">					if (replaceForMissingFile.exists())</span>
					{
<span class="nc" id="L260">						Logger.debug(ThumbServlet.class, &quot;Replace image found.&quot;);</span>

<span class="nc" id="L262">						imageFile = replaceForMissingFile;</span>
<span class="nc" id="L263">						imagePath = replaceForMissingPath;</span>
<span class="nc" id="L264">						realPath = Tools.replace(PathFilter.getRealPath(&quot;/&quot;+replaceForMissingPath), &quot;//&quot;, &quot;/&quot;);</span>
<span class="nc" id="L265">						return404 = false;</span>
					}
					else
					{
<span class="nc" id="L269">						Logger.debug(ThumbServlet.class, &quot;replace image is missing. path=&quot;+replaceForMissingFile.getVirtualPath()+&quot;;realPath=&quot;+replaceForMissingFile.getAbsolutePath());</span>
					}
				}

				//
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">				if (return404)</span>
				{
<span class="fc" id="L276">					Logger.debug(ThumbServlet.class, &quot;Image doesn't exists, imagePath=&quot;+imagePath+&quot; realPath=&quot;+realPath+&quot; qs=&quot;+request.getQueryString()+&quot; uri=&quot;+request.getRequestURI());</span>
<span class="fc" id="L277">					sk.iway.iwcm.Encoding.setResponseEnc(request, response, &quot;text/html&quot;);</span>
<span class="fc" id="L278">					response.setStatus(404);</span>
<span class="fc" id="L279">					response.getWriter().print(&quot;&lt;html&gt;&lt;body&gt;404  -  not found&lt;/body&gt;&lt;/html&gt;&quot;);</span>
<span class="fc" id="L280">					return;</span>
				}
			}

			//nie je v cache, vygeneruj
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">			if (parsedFromName == false)</span>
			{
<span class="fc" id="L287">				width = Tools.getIntValue(request.getParameter(&quot;w&quot;), width);</span>
<span class="fc" id="L288">				height = Tools.getIntValue(request.getParameter(&quot;h&quot;),height);</span>

<span class="fc" id="L290">				ip = Tools.getIntValue(request.getParameter(&quot;ip&quot;), -1);</span>
<span class="fc" id="L291">				fillColor = request.getParameter(&quot;c&quot;);</span>
<span class="fc" id="L292">				q = Tools.getIntValue(request.getParameter(&quot;q&quot;), -1);</span>
			}

<span class="pc bpc" id="L295" title="2 of 6 branches missed.">			if (fillColor==null || Tools.isEmpty(fillColor) || fillColor.trim().length()!=6) fillColor = FILL_COLOR_DEFAULT;</span>
<span class="fc" id="L296">			fillColor = DocTools.removeChars(fillColor).toLowerCase().trim();</span>
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">			if (fillColor.length()!=6) fillColor = FILL_COLOR_DEFAULT;</span>

<span class="fc" id="L299">			Logger.debug(ThumbServlet.class, &quot;Farba: &quot;+fillColor);</span>
			//osetrenie stavov
<span class="pc bpc" id="L301" title="5 of 10 branches missed.">			if (width &gt; Constants.getInt(&quot;imageMaxThumbsWidth&quot;) || height &gt; Constants.getInt(&quot;imageMaxThumbsHeight&quot;) || width &lt; 1 || height &lt; 1 || fillColor.length()!=6)</span>
			{
<span class="nc" id="L303">				response.setStatus(HttpServletResponse.SC_BAD_REQUEST);</span>
<span class="nc" id="L304">				return;</span>
			}

<span class="fc" id="L307">			String realPathSmall = realPathSmall(imagePath, width, height, ip, fillColor, q);</span>

			//skontroluj cache
<span class="fc" id="L310">			IwcmFile smallImageFile = new IwcmFile(realPathSmall);</span>

<span class="pc bpc" id="L312" title="3 of 4 branches missed.">			boolean fileExists = imageFile.exists() || smallImageFile.exists();</span>

			//Logger.debug(ThumbServlet.class, &quot;imagePath=&quot;+imagePath+&quot; small=&quot;+realPathSmall+&quot; imageFile=&quot;+imageFile.getAbsolutePath()+&quot; exists=&quot;+fileExists);

<span class="pc bpc" id="L316" title="1 of 2 branches missed.">			if (!fileExists)</span>
			{
<span class="nc" id="L318">				realPathSmall = realPathSmall(&quot;/components/_common/mime/big_unknown.gif&quot;, width, height, -1, null, q);</span>
<span class="nc" id="L319">				realPath = Tools.getRealPath(&quot;/components/_common/mime/big_unknown.gif&quot;);</span>
<span class="nc" id="L320">				imageFile = new IwcmFile(realPath);</span>
<span class="nc" id="L321">				smallImageFile = new IwcmFile(realPathSmall);</span>
			}

<span class="fc" id="L324">			String imgPath = null;</span>

<span class="pc bpc" id="L326" title="1 of 4 branches missed.">			if (smallImageFile.exists() &amp;&amp; imageFile.lastModified() &lt; smallImageFile.lastModified())</span>
			{
				//pouzijeme cache
<span class="fc" id="L329">				imgPath = realPathSmall;</span>
			}


<span class="fc bfc" id="L333" title="All 2 branches covered.">			if (imgPath == null)</span>
			{
<span class="fc" id="L335">				boolean canPost = SpamProtection.canPost(&quot;ThumbServlet&quot;, realPathSmall, request);</span>
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">				if (canPost == false)</span>
				{
					//pre cloud mame kvoli screenshoteru vynimku
<span class="nc" id="L339">					canPost = CloudToolsForCore.isInternalIp(request);</span>
				}
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">				if (canPost == false)</span>
				{
					//ak je to admin nekontroluj pocet requestov
<span class="nc bnc" id="L344" title="All 4 branches missed.">					if (user != null &amp;&amp; user.isAdmin()) canPost = true;</span>
				}

				//ochrana pred DOS utokom
<span class="pc bpc" id="L348" title="5 of 6 branches missed.">				if ( canPost == false &amp;&amp; (user==null || user.isAdmin()==false) )</span>
				{
<span class="nc" id="L350">					response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);</span>
<span class="nc" id="L351">					return;</span>
				}

<span class="fc" id="L354">				String thumbWriteServer = Constants.getString(&quot;thumbWriteServer&quot;);</span>
<span class="fc" id="L355">				String thumbWriteNodeName = Constants.getString(&quot;thumbWriteNodeName&quot;);</span>
<span class="pc bpc" id="L356" title="5 of 6 branches missed.">				if (Tools.isNotEmpty(thumbWriteServer) &amp;&amp; Tools.isNotEmpty(thumbWriteNodeName) &amp;&amp; thumbWriteNodeName.equals(Constants.getString(&quot;clusterMyNodeName&quot;))==false)</span>
				{
					//toto sa deje na sport24 kde public nody nemaju write pravo, musim teda spravit get na CMS nod aby sa obrazok vygeneroval
					//sprav get na thumb servlet
<span class="nc" id="L360">					String url = thumbWriteServer + imagePath + &quot;?&quot; + request.getQueryString();</span>
<span class="nc" id="L361">					downloadFromAdminNode(imagePath, url, request, response);</span>
<span class="nc" id="L362">					return;</span>
				}
				else
				{
					// ziskaj odkaz na originalny obrazok
<span class="fc" id="L367">					int ret = -1;</span>
<span class="fc bfc" id="L368" title="All 2 branches covered.">					if (ip &lt; 1)</span>
					{
<span class="fc" id="L370">						ret = GalleryDB.resizePicture(realPath, realPathSmall, width, height);</span>
					}
					else
					{
<span class="fc" id="L374">						String testPath = &quot;/&quot;+imagePath;</span>

<span class="fc" id="L376">						GalleryBean bean = GalleryDB.getGalleryBean(&quot;/&quot;+imagePath, request);</span>

						//ziskajme orig obrazok, kedze v galerii sa nastavuje crop na orig obrazku
<span class="fc" id="L379">						String origPath = GalleryDB.getImagePathOriginal(&quot;/&quot;+imagePath);</span>
<span class="fc" id="L380">						IwcmFile origPathFile = new IwcmFile(Tools.getRealPath(origPath));</span>
<span class="pc bpc" id="L381" title="1 of 2 branches missed.">						if (origPathFile.exists())</span>
						{
<span class="fc" id="L383">							imageFile = origPathFile;</span>
<span class="fc" id="L384">							testPath = origPath;</span>
						}

<span class="fc" id="L387">						int imageQuality = GalleryDB.getImageQuality(request, width);</span>

<span class="fc" id="L389">						int cleft = 0;</span>
<span class="fc" id="L390">						int ctop = 0;</span>
						//w a h urcime na zaklade aktualneho obrazku (akoze zvoleny cely obrazok)
<span class="fc" id="L392">						int[] imageSize = GalleryDBTools.getImageSize(new IwcmFile(PathFilter.getRealPath(testPath)));</span>

<span class="fc" id="L394">						int cwidth = imageSize[0];</span>
<span class="fc" id="L395">						int cheight = imageSize[1];</span>

<span class="fc" id="L397">						int imgwidth = imageSize[0];</span>
<span class="fc" id="L398">						int imgheight = imageSize[1];</span>

<span class="pc bpc" id="L400" title="3 of 8 branches missed.">						if (&quot;true&quot;.equals(request.getParameter(&quot;noip&quot;))==false &amp;&amp; bean != null &amp;&amp; bean.getSelectedWidth()&gt;5 &amp;&amp; bean.getSelectedHeight()&gt;5)</span>
						{
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">							if (bean.getSelectedX()&gt;0) cleft = bean.getSelectedX();</span>
<span class="pc bpc" id="L403" title="1 of 2 branches missed.">							if (bean.getSelectedY()&gt;0) ctop = bean.getSelectedY();</span>
<span class="pc bpc" id="L404" title="1 of 2 branches missed.">							if (bean.getSelectedWidth()&gt;0) cwidth = bean.getSelectedWidth();</span>
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">							if (bean.getSelectedHeight()&gt;0) cheight = bean.getSelectedHeight();</span>
						}

<span class="pc bpc" id="L408" title="1 of 2 branches missed.">						if (ip==1)</span>
						{
							//mame zadany len parameter w, h dopocitame podla pomeru stran povodneho vyrezu
							//http://iwcm.interway.sk:8080/thumb/images/gallery/19-24-mesiacov/DSC06443.JPG?w=200&amp;ip=1
<span class="nc" id="L412">							double pomer = (double)cwidth / (double) cheight;</span>
<span class="nc" id="L413">							height = (int)Math.round(width / pomer);</span>

<span class="nc" id="L415">							Logger.debug(ThumbServlet.class, &quot;vypocitany h=&quot;+height);</span>

<span class="nc" id="L417">							ret = GalleryDBTools.cropAndResize(imageFile, cwidth, cheight, cleft, ctop, width, height, null, true, smallImageFile, imageQuality, 1);</span>
<span class="nc" id="L418">						}</span>
<span class="pc bpc" id="L419" title="1 of 2 branches missed.">						else if (ip==2)</span>
						{
							//mame zadany len parameter h, w dopocitame podla pomeru stran povodneho vyrezu
							//http://iwcm.interway.sk:8080/thumb/images/gallery/19-24-mesiacov/DSC06443.JPG?h=200&amp;ip=2
<span class="nc" id="L423">							double pomer = (double)cwidth / (double) cheight;</span>
<span class="nc" id="L424">							width = (int)Math.round(height * pomer);</span>

<span class="nc" id="L426">							Logger.debug(ThumbServlet.class, &quot;vypocitany w=&quot;+width);</span>

<span class="nc" id="L428">							ret = GalleryDBTools.cropAndResize(imageFile, cwidth, cheight, cleft, ctop, width, height, null, true, smallImageFile, imageQuality, 2);</span>
<span class="nc" id="L429">						}</span>
<span class="pc bpc" id="L430" title="1 of 2 branches missed.">						else if (ip == 3)</span>
						{
							//vyrez sa zmesti cely do zvolenej velkosti w a h ale nemusi vyplnat celu velkost (realne je mensi ako zadane w a h)
							//http://iwcm.interway.sk:8080/thumb/images/gallery/19-24-mesiacov/DSC06443.JPG?w=200&amp;h=200&amp;ip=3
<span class="nc" id="L434">							ret = GalleryDBTools.cropAndResize(imageFile, cwidth, cheight, cleft, ctop, width, height, null, true, smallImageFile, imageQuality, 3);</span>
						}
<span class="fc bfc" id="L436" title="All 2 branches covered.">						else if (ip == 4)</span>
						{
							//vyrez sa zmesti cely do zvolenej velkosti w a h je vycentrovany a zvysok je zafarbeny farbou z parametra c (default biela)
							//http://iwcm.interway.sk:8080/thumb/images/gallery/19-24-mesiacov/DSC06443.JPG?w=200&amp;h=200&amp;ip=4&amp;c=ff0000

							//exactSize - musi byt false, inak sa farba nedoplni
<span class="fc" id="L442">							ret = GalleryDBTools.cropAndResize(imageFile, cwidth, cheight, cleft, ctop, width, height, fillColor, false, smallImageFile, imageQuality, 4);</span>
						}
<span class="pc bpc" id="L444" title="1 of 2 branches missed.">						else if (ip == 5)</span>
						{
							//zmensi vyrez a vycentruj tak, aby bol dodrzany pomer stran pozadovanej velkosti
							//vyrez moze byt 400x300 a my chceme 300x300, cize ho posunieme o 50 doprava a zmensime na 300x300
							//http://iwcm.interway.sk:8080/thumb/images/gallery/19-24-mesiacov/DSC06443.JPG?w=200&amp;h=200&amp;ip=5

<span class="fc" id="L450">							Logger.debug(ThumbServlet.class, &quot;\n\nURCI OREZ\n width=&quot;+width+&quot; height=&quot;+height+&quot; cleft=&quot;+cleft+&quot; ctop=&quot;+ctop+&quot; cwidth=&quot;+cwidth+&quot; cheight=&quot;+cheight);</span>

							//pomer stran urcim ako pomer sirok jednotlivych elementov
<span class="fc" id="L453">							double pomer = (double)cwidth / (double) width;</span>
<span class="fc" id="L454">							int novycheight = (int)Math.round(height * pomer);</span>

<span class="fc" id="L456">							Logger.debug(ThumbServlet.class, &quot;pomer=&quot;+pomer+&quot; novycheight=&quot;+novycheight);</span>

<span class="pc bpc" id="L458" title="1 of 2 branches missed.">							if (novycheight &gt; cheight)</span>
							{
								//presiahlo nam to blok, musime cele urcit pomocou height
<span class="fc" id="L461">								Logger.debug(ThumbServlet.class, &quot;Urcujem podla height&quot;);</span>

<span class="fc" id="L463">								pomer = (double)cheight / (double) height;</span>
								//urcime novu sirku
<span class="fc" id="L465">								int novycwidth = (int)Math.round(width * pomer);</span>

<span class="fc" id="L467">								int rozdiel = (int)Math.round( ((cwidth - novycwidth) / 2d) );</span>

<span class="fc" id="L469">								cwidth = novycwidth;</span>
<span class="fc" id="L470">								cleft = cleft + rozdiel;</span>
<span class="fc" id="L471">							}</span>
							else
							{
<span class="nc" id="L474">								int rozdiel = (int)Math.round( ((cheight - novycheight) / 2d) );</span>

<span class="nc" id="L476">								cheight = novycheight;</span>
<span class="nc" id="L477">								ctop = ctop + rozdiel;</span>
							}

<span class="fc" id="L480">							Logger.debug(ThumbServlet.class, &quot;OREZ: cleft=&quot;+cleft+&quot; ctop=&quot;+ctop+&quot; cwidth=&quot;+cwidth+&quot; cheight=&quot;+cheight);</span>

<span class="fc" id="L482">							ret = GalleryDBTools.cropAndResize(imageFile, cwidth, cheight, cleft, ctop, width, height, null, true, smallImageFile, imageQuality, 5);</span>
<span class="fc" id="L483">						}</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">						else if (ip == 6)</span>
						{
							//zvoleny vyrez bude komplet vo vysledku ale celkovo sa vyrez zvacsi podla pomeru stran pozadovaneho obrazku
							//http://iwcm.interway.sk:8080/thumb/images/gallery/19-24-mesiacov/DSC06443.JPG?w=200&amp;h=200&amp;ip=6

<span class="nc" id="L489">							Logger.debug(ThumbServlet.class, &quot;\n\nURCI OREZ\n width=&quot;+width+&quot; height=&quot;+height+&quot; cleft=&quot;+cleft+&quot; ctop=&quot;+ctop+&quot; cwidth=&quot;+cwidth+&quot; cheight=&quot;+cheight+&quot; imgwidth=&quot;+imgwidth+&quot; imgheight=&quot;+imgheight);</span>

							//len pre kontrolu
<span class="nc" id="L492">							double pomerStran = (double)width / (double)height;</span>
<span class="nc" id="L493">							Logger.debug(ThumbServlet.class, &quot;pomerStran=&quot;+pomerStran);</span>


							//pomer stran urcim ako pomer sirok jednotlivych elementov
<span class="nc" id="L497">							double pomer = (double)cwidth / (double) width;</span>
<span class="nc" id="L498">							int novycheight = (int)Math.round(height * pomer);</span>
<span class="nc" id="L499">							int novycwidth = cwidth;</span>

<span class="nc" id="L501">							Logger.debug(ThumbServlet.class, &quot;pomer=&quot;+pomer+&quot; novycheight=&quot;+novycheight);</span>

<span class="nc bnc" id="L503" title="All 2 branches missed.">							if (novycheight &lt; cheight)</span>
							{
								//nepresiahlo nam to blok, musime cele urcit pomocou height (chceme tam mat cely vyznaceny blok)
<span class="nc" id="L506">								Logger.debug(ThumbServlet.class, &quot;Urcujem podla height&quot;);</span>

<span class="nc" id="L508">								pomer = (double)cheight / (double) height;</span>
								//urcime novu sirku
<span class="nc" id="L510">								novycwidth = (int)Math.round(width * pomer);</span>
<span class="nc" id="L511">								novycheight = cheight;</span>
							}

							//posunieme left a top o rozdiely
<span class="nc" id="L515">							int posunLeft = (int)Math.round( ((novycwidth - cwidth) / 2d) );</span>
<span class="nc" id="L516">							int posunTop = (int)Math.round( ((novycheight - cheight) / 2d) );</span>

<span class="nc" id="L518">							cleft = cleft - posunLeft;</span>
<span class="nc" id="L519">							ctop = ctop - posunTop;</span>

<span class="nc bnc" id="L521" title="All 2 branches missed.">							if (cleft &lt; 0) cleft = 0;</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">							if (ctop &lt; 0) ctop = 0;</span>

<span class="nc" id="L524">							cwidth = novycwidth;</span>
<span class="nc" id="L525">							cheight = novycheight;</span>

<span class="nc" id="L527">							Logger.debug(ThumbServlet.class, &quot;OREZ: cleft=&quot;+cleft+&quot; ctop=&quot;+ctop+&quot; cwidth=&quot;+cwidth+&quot; cheight=&quot;+cheight);</span>

<span class="nc bnc" id="L529" title="All 2 branches missed.">							if (cwidth + cleft &gt; imgwidth)</span>
							{
<span class="nc bnc" id="L531" title="All 2 branches missed.">								if (cwidth &lt;= imgwidth)</span>
								{
									//posunieme left
<span class="nc" id="L534">									posunLeft = (cwidth+cleft) - imgwidth;</span>
<span class="nc" id="L535">									cleft = cleft - posunLeft;</span>
								}
								else
								{
									//musime cele zmensit
<span class="nc" id="L540">									cwidth = imgwidth;</span>
<span class="nc" id="L541">									cheight = (int)Math.round(cwidth / pomerStran);</span>
								}
							}

<span class="nc" id="L545">							Logger.debug(ThumbServlet.class, &quot;OREZ: cleft=&quot;+cleft+&quot; ctop=&quot;+ctop+&quot; cwidth=&quot;+cwidth+&quot; cheight=&quot;+cheight);</span>

<span class="nc bnc" id="L547" title="All 2 branches missed.">							if (cheight + ctop &gt; imgheight)</span>
							{
<span class="nc bnc" id="L549" title="All 2 branches missed.">								if (cheight &lt;= imgheight)</span>
								{
									//posunieme top
<span class="nc" id="L552">									posunTop = (cheight+ctop) - imgheight;</span>
<span class="nc" id="L553">									ctop = ctop - posunTop;</span>
								}
								else
								{
									//musime cele zmensit
<span class="nc" id="L558">									cheight = imgheight;</span>
<span class="nc" id="L559">									cwidth = (int)Math.round(cheight * pomerStran);</span>
								}
							}

							//len pre kontrolu
<span class="nc" id="L564">							double cPomerStran = (double)cwidth / (double)cheight;</span>
<span class="nc" id="L565">							Logger.debug(ThumbServlet.class, &quot;cpomerStran=&quot;+cPomerStran);</span>

<span class="nc" id="L567">							Logger.debug(ThumbServlet.class, &quot;OREZ: cleft=&quot;+cleft+&quot; ctop=&quot;+ctop+&quot; cwidth=&quot;+cwidth+&quot; cheight=&quot;+cheight);</span>

<span class="nc" id="L569">							ret = GalleryDBTools.cropAndResize(imageFile, cwidth, cheight, cleft, ctop, width, height, null, true, smallImageFile, imageQuality, 6);</span>
<span class="nc" id="L570">						}</span>
						else
						{
<span class="nc" id="L573">							response.setStatus(HttpServletResponse.SC_BAD_REQUEST);</span>
<span class="nc" id="L574">							return;</span>
						}
					}
<span class="fc" id="L577">					Logger.debug(ThumbServlet.class, &quot;ret=&quot; + ret);</span>
<span class="pc bpc" id="L578" title="3 of 4 branches missed.">					if (ret == 0 || ret == 1)</span>
					{
<span class="fc" id="L580">						imgPath = realPathSmall;</span>
					}
					else
					{
<span class="nc" id="L584">						imgPath = Tools.getRealPath(&quot;/components/_common/mime/big_unknown.gif&quot;);</span>
					}
				}
			}

<span class="fc" id="L589">			Logger.debug(ThumbServlet.class, &quot;imgPath=&quot;+imgPath);</span>
<span class="fc" id="L590">			IwcmFile inFile = null;</span>
<span class="pc bpc" id="L591" title="1 of 2 branches missed.">         if (imgPath != null)</span>
         {
<span class="fc" id="L593">            inFile = new IwcmFile(imgPath);</span>
         }
<span class="pc bpc" id="L595" title="2 of 4 branches missed.">         if (inFile != null &amp;&amp; inFile.exists())</span>
         {
            //response.setHeader(&quot;Pragma&quot;, &quot;No-Cache&quot;);
            //response.setDateHeader(&quot;Expires&quot;, 0);
            //response.setHeader(&quot;Cache-Control&quot;, &quot;no-Cache&quot;);

<span class="fc" id="L601">            String mimeType = Constants.getServletContext().getMimeType(imagePath.toLowerCase());</span>
<span class="pc bpc" id="L602" title="1 of 2 branches missed.">            if (Tools.isEmpty(mimeType)) mimeType = &quot;application/octet-stream&quot;;</span>
<span class="fc" id="L603">            response.setContentType(mimeType);</span>

<span class="fc" id="L605">            PathFilter.setStaticContentHeaders(imagePath, UsersDB.getCurrentUser(request), request, response);</span>

<span class="fc" id="L607">            ServletOutputStream out = response.getOutputStream();</span>
<span class="fc" id="L608">            byte[] buff = new byte[64000];</span>
<span class="fc" id="L609">            IwcmInputStream fis = new IwcmInputStream(inFile);</span>
            int len;
<span class="fc bfc" id="L611" title="All 2 branches covered.">            while ((len = fis.read(buff)) != -1)</span>
            {
<span class="fc" id="L613">               out.write(buff, 0, len);</span>
            }
<span class="fc" id="L615">            fis.close();</span>
            //out.close();
            //return;
<span class="fc" id="L618">         }</span>
         else
         {
<span class="nc" id="L621">         	response.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
         }
		}
<span class="fc" id="L624">	}</span>

	private static boolean downloadFromAdminNode(String imagePath, String url, HttpServletRequest request, HttpServletResponse response)
	{
<span class="nc bnc" id="L628" title="All 4 branches missed.">		if (url.startsWith(&quot;http://&quot;) || url.startsWith(&quot;https://&quot;))</span>
		{
			try
			{
<span class="nc" id="L632">				url = Tools.natUrl(url);</span>

<span class="nc bnc" id="L634" title="All 2 branches missed.">				if (url.startsWith(&quot;https://&quot;))</span>
				{
<span class="nc" id="L636">					Tools.doNotVerifyCertificates();</span>
				}

<span class="nc" id="L639">				Logger.debug(Tools.class, &quot;DownloadUrl: &quot; + url);</span>

				//body obsahuje URL adresu, ktoru je treba stiahnut
<span class="nc" id="L642">				HttpURLConnection conn = null;</span>
<span class="nc" id="L643">				URL urlObj = new URL(url);</span>
<span class="nc" id="L644">				conn = (HttpURLConnection) urlObj.openConnection();</span>

<span class="nc" id="L646">				conn.setAllowUserInteraction(false);</span>
<span class="nc" id="L647">				conn.setDoInput(true);</span>
<span class="nc" id="L648">				conn.setDoOutput(false);</span>
<span class="nc" id="L649">				conn.connect();</span>

<span class="nc" id="L651">				String mimeType = Constants.getServletContext().getMimeType(&quot;/&quot;+imagePath.toLowerCase());</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">            if (Tools.isEmpty(mimeType)) mimeType = &quot;application/octet-stream&quot;;</span>
<span class="nc" id="L653">            response.setContentType(mimeType);</span>

<span class="nc" id="L655">            PathFilter.setStaticContentHeaders(&quot;/&quot;+imagePath, null, request, response);</span>

<span class="nc" id="L657">				BufferedInputStream is = new BufferedInputStream(conn.getInputStream());</span>
<span class="nc" id="L658">				ServletOutputStream os = response.getOutputStream();</span>

<span class="nc" id="L660">				byte[] buffer = new byte[8000];</span>
<span class="nc" id="L661">				int n = 0;</span>
				while (true)
				{
<span class="nc" id="L664">					 n = is.read(buffer);</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">					 if (n &lt; 1) break;</span>
<span class="nc" id="L666">					 os.write(buffer, 0, n);</span>
				}
<span class="nc" id="L668">				is.close();</span>
<span class="nc" id="L669">				os.close();</span>

<span class="nc" id="L671">				return true;</span>
			}
<span class="nc" id="L673">			catch (Exception ex)</span>
			{
<span class="nc" id="L675">				Logger.error(ThumbServlet.class,&quot;ERROR downloadUrl(&quot;+url+&quot;)&quot;);</span>
<span class="nc" id="L676">				sk.iway.iwcm.Logger.error(ex);</span>
			}
		}
<span class="nc" id="L679">		return false;</span>
	}

	/**
	 * vrati cestu k obrazku v pripade ak ide o obrazov pre bod zaujmu
	 * @param imagePath
	 * @param width
	 * @param height
	 * @return
	 */
	private static String realPathSmall(String imagePath, int width, int height, int ip, String fillColor, int quality)
	{
<span class="fc" id="L691">		String realPathSmall = Tools.getRealPath(Constants.getString(&quot;thumbServletCacheDir&quot;)+imagePath);</span>

<span class="fc" id="L693">		return getImagePathCache(realPathSmall, width, height, ip, fillColor, quality);</span>
	}

	/**
	 * Vrati cestu k suboru v cache upravenu o rozmer, ip, farbu a qualitu
	 * @param realPathSmall
	 * @param width
	 * @param height
	 * @param ip
	 * @param fillColor
	 * @param quality
	 * @return
	 */
	public static String getImagePathCache(String realPathSmall, int width, int height, int ip, String fillColor, int quality)
	{
		//uprav cache nazov
		try
		{
<span class="fc" id="L711">			String qualityName = &quot;&quot;;</span>
<span class="pc bpc" id="L712" title="1 of 4 branches missed.">			if (quality &gt; 10 &amp;&amp; quality &lt;=100) qualityName = &quot;q&quot;+quality;</span>

<span class="fc" id="L714">			String fillColorName = &quot;&quot;;</span>
<span class="pc bpc" id="L715" title="2 of 4 branches missed.">			if (Tools.isNotEmpty(fillColor) &amp;&amp; FILL_COLOR_DEFAULT.equals(fillColor)==false) fillColorName = &quot;c&quot;+fillColor;</span>

<span class="fc" id="L717">			String ipName = &quot;&quot;;</span>
<span class="fc bfc" id="L718" title="All 2 branches covered.">			if (ip&gt;0) ipName = &quot;ip&quot;+ip;</span>

			//najdi poslednu bodku v nazve suboru
<span class="fc" id="L721">			int i = realPathSmall.lastIndexOf('.');</span>
			//ak bodka v nazve nie je, tak vrat rovno subor, je to nezmysel
<span class="pc bpc" id="L723" title="1 of 2 branches missed.">			if (i == -1) return realPathSmall;</span>

			//nemame zadany parameter ip, toto mozu byt napr. thumb obrazky v admin casti kde sa pouziva len w a h parameter
<span class="fc" id="L726">			realPathSmall = realPathSmall.substring(0, i) + &quot;-&quot;+width+&quot;x&quot;+height+ipName+fillColorName+qualityName+realPathSmall.substring(i);</span>

		}
<span class="nc" id="L729">		catch (Exception e)</span>
		{
<span class="nc" id="L731">			sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L732">		}</span>
<span class="fc" id="L733">		return realPathSmall;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>