<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GalleryDB.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.gallery</a> &gt; <span class="el_source">GalleryDB.java</span></div><h1>GalleryDB.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.gallery;

import static sk.iway.iwcm.Tools.isEmpty;

import java.awt.Dimension;
import java.awt.Graphics2D;
import java.awt.Image;
import java.awt.image.BufferedImage;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.Enumeration;
import java.util.HashSet;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Random;
import java.util.StringTokenizer;

import javax.imageio.IIOImage;
import javax.imageio.ImageIO;
import javax.imageio.ImageWriteParam;
import javax.imageio.ImageWriter;
import javax.imageio.plugins.jpeg.JPEGImageWriteParam;
import javax.imageio.stream.ImageOutputStream;
import javax.servlet.ServletContext;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import com.drew.imaging.ImageMetadataReader;
import com.drew.metadata.Directory;
import com.drew.metadata.Metadata;
import com.drew.metadata.Tag;

import org.apache.commons.io.FileUtils;
import org.apache.commons.lang.StringUtils;
import org.apache.struts.util.ResponseUtils;

import sk.iway.iwcm.Adminlog;
import sk.iway.iwcm.Cache;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DB;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.FileTools;
import sk.iway.iwcm.InitServlet;
import sk.iway.iwcm.LabelValueDetails;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.RequestBean;
import sk.iway.iwcm.SetCharacterEncodingFilter;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.common.GalleryDBTools;
import sk.iway.iwcm.common.GalleryToolsForCore;
import sk.iway.iwcm.database.ComplexQuery;
import sk.iway.iwcm.database.Mapper;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.doc.DebugTimer;
import sk.iway.iwcm.editor.EditorDB;
import sk.iway.iwcm.filebrowser.FileDirBean;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.io.IwcmFile;
import sk.iway.iwcm.io.IwcmFileFilter;
import sk.iway.iwcm.io.IwcmFsDB;
import sk.iway.iwcm.io.IwcmInputStream;
import sk.iway.iwcm.io.IwcmOutputStream;
import sk.iway.iwcm.stat.StatDB;
import sk.iway.iwcm.system.metadata.MetadataCleaner;
import sk.iway.spirit.MediaDB;

/**
 * Praca s FotoGaleriou
 *
 *@Title WebJET
 *@Company Interway s.r.o. (www.interway.sk)
 *@Copyright Interway s.r.o. (c) 2001-2002
 *@author unascribed
 *@version 1.0
 *@created Nedeďż˝e, 2003, mďż˝j 18
 *@modified $Date: 2004/03/12 10:16:32 $
 */
public class GalleryDB
{

<span class="fc" id="L102">	public static final List&lt;String&gt; LANGUAGES = Arrays.asList(&quot;sk&quot;, &quot;cz&quot;, &quot;de&quot;, &quot;en&quot;, &quot;pl&quot;, &quot;ru&quot;, &quot;cho&quot;, &quot;esp&quot;, &quot;hu&quot;); //NOSONAR</span>
	public static final String DATE_FROM_SESSION_FILTER = &quot;date_from_filter&quot;;
	public static final String DATE_TO_SESSION_FILTER = &quot;date_to_filter&quot;;

<span class="fc" id="L106">	private static final Random rand = new Random();</span>

<span class="nc" id="L108">	protected GalleryDB() {</span>
		//utility class
<span class="nc" id="L110">	}</span>

<span class="fc" id="L112">	private static final Mapper&lt;GalleryDimension&gt; dimensionMapper = new Mapper&lt;GalleryDimension&gt;()</span>
<span class="fc" id="L113">	{</span>
		@Override
		public GalleryDimension map(ResultSet rs) throws SQLException
		{
<span class="nc" id="L117">			GalleryDimension gallery = new GalleryDimension();</span>

<span class="nc" id="L119">			gallery.setGalleryId(rs.getInt(&quot;dimension_id&quot;));</span>
<span class="nc" id="L120">			gallery.setGalleryPath(rs.getString(&quot;image_path&quot;));</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">			gallery.setGalleryName((rs.getString(&quot;gallery_name&quot;) != null) ? (rs.getString(&quot;gallery_name&quot;)) : &quot;&quot;);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">			gallery.setGalleryPerex((rs.getString(&quot;gallery_perex&quot;) != null) ? (rs.getString(&quot;gallery_perex&quot;)) : &quot;&quot;);</span>
<span class="nc" id="L123">			gallery.setGalleryDate(rs.getTimestamp(&quot;create_date&quot;));</span>
<span class="nc" id="L124">			gallery.setGalleryViews(rs.getInt(&quot;views&quot;));</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">			gallery.setAuthor((rs.getString(&quot;author&quot;) != null) ? (rs.getString(&quot;author&quot;)) : &quot;&quot;);</span>
<span class="nc" id="L126">			gallery.setWatermark(rs.getString(&quot;watermark&quot;));</span>
<span class="nc" id="L127">			gallery.setWatermarkPlacement(rs.getString(&quot;watermark_placement&quot;));</span>
<span class="nc" id="L128">			gallery.setWatermarkSaturation(rs.getInt(&quot;watermark_saturation&quot;));</span>
<span class="nc" id="L129">			return gallery;</span>
		}
	};

	/**
	 * ziska z jazyka priponu pre nacitanie z databazy
	 *
	 * @param lng
	 * @param request
	 * @return
	 */
	public static String getLngAdd(String lng, HttpServletRequest request)
	{
<span class="fc" id="L142">		String lngAdd = &quot;_sk&quot;;</span>
<span class="pc bpc" id="L143" title="5 of 8 branches missed.">		if (lng == null || (lng.length() != 2 &amp;&amp; !&quot;esp&quot;.equals(lng) &amp;&amp; !&quot;cho&quot;.equals(lng)) )</span>
		{
<span class="fc" id="L145">			lng = Constants.getString(&quot;defaultLanguage&quot;);</span>
		}
<span class="fc" id="L147">		lng = lng.replace('\'', ' ');</span>
<span class="fc" id="L148">		lng = lng.replace(';', ' ');</span>
		// podpora je iba pre tieto jazyky
<span class="fc bfc" id="L150" title="All 2 branches covered.">		if (!LANGUAGES.contains(lng) )</span>
		{
<span class="fc" id="L152">			lng = &quot;sk&quot;;</span>
		}
<span class="pc bpc" id="L154" title="3 of 4 branches missed.">		if (lng.length() == 2 || lng.length() == 3)</span>
		{
<span class="fc" id="L156">			lngAdd = &quot;_&quot; + lng.toLowerCase();</span>
		}
<span class="fc" id="L158">		return (lngAdd);</span>
	}

	public static Collection&lt;IwcmFile&gt; getImagesFromDir(String basePath, boolean alsoSubfolders){
<span class="nc" id="L162">			return getFilesFromDir(basePath, alsoSubfolders, listFiles(basePath));</span>
	}

	/**
	 * Pripravi zoznam suborov v adresari, aby sa to dalo opakovane pouzit
	 * @param basePath
	 * @return
	 */
	private static IwcmFile[] listFiles(String basePath)
	{
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">		if (basePath.endsWith(&quot;/&quot;))</span>
		{
<span class="nc" id="L174">			basePath = basePath.substring(0, basePath.length() - 1);</span>
		}

<span class="fc" id="L177">		String realPath = Tools.getRealPath(basePath);</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">		if (realPath != null)</span>
		{
<span class="fc" id="L180">			IwcmFile file = new IwcmFile(realPath);</span>
			try
			{
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">				if (isDirectoryFast(file))</span>
				{
<span class="fc" id="L185">					IwcmFile[] files = file.listFiles(new IwcmFileFilter()</span>
<span class="fc" id="L186">					{</span>
						@Override
						public boolean accept(IwcmFile file)
						{
<span class="pc bpc" id="L190" title="1 of 4 branches missed.">							return (isImageFast(file) || isDirectoryFast(file));</span>
						}
					});
<span class="fc" id="L193">					return files;</span>
				}
			}
<span class="nc" id="L196">			catch (Exception e)</span>
			{
<span class="nc" id="L198">				sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L199">			}</span>
		}

<span class="nc" id="L202">		return new IwcmFile[0];</span>
	}

	/**
	 * Rekurzivne prehlada adresare a naplni Map s File objektami
	 *
	 *@param mainDir - adresar, ktory chceme rekurzivne prehladat
	 *@param hTable - Map, do ktorej budu pridane vsetky subory obrazkov z podadresarov
	 *@return
	 */
	private static List&lt;IwcmFile&gt; getFilesFromDir(String basePath, boolean alsoSubfolders, IwcmFile[] files)
	{
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">		if (basePath.endsWith(&quot;/&quot;))</span>
		{
<span class="nc" id="L216">			basePath = basePath.substring(0, basePath.length() - 1);</span>
		}

<span class="fc" id="L219">		boolean noMiniatures = false;</span>
<span class="fc" id="L220">		String resizeMode = getResizeMode(basePath, true);</span>
<span class="pc bpc" id="L221" title="2 of 4 branches missed.">		if(resizeMode!=null &amp;&amp; resizeMode.equals(&quot;N&quot;))</span>
<span class="nc" id="L222">			noMiniatures = true;</span>

<span class="fc" id="L224">		List&lt;IwcmFile&gt; fileList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L225">		HashSet&lt;String&gt; origFileNames = new HashSet&lt;&gt;();</span>
<span class="fc" id="L226">		int size = files.length;</span>

		//ak sa nemaju nachadzat zmenseniny, nepotrebujeme kontrolovat origName
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">		if(!noMiniatures)</span>
		{
<span class="fc bfc" id="L231" title="All 2 branches covered.">			for (int i = 0; i &lt; size; i++)</span>
			{
<span class="fc" id="L233">				IwcmFile file = files[i];</span>
<span class="fc bfc" id="L234" title="All 4 branches covered.">				if (isDirectoryFast(file)==false &amp;&amp; file.getName().startsWith(&quot;o_&quot;))</span>
				{
<span class="fc" id="L236">					origFileNames.add(file.getName());</span>
				}
			}
		}

<span class="fc bfc" id="L241" title="All 2 branches covered.">		for (int i = 0; i &lt; size; i++)</span>
		{
<span class="fc" id="L243">			IwcmFile file = files[i];</span>
<span class="pc bpc" id="L244" title="3 of 4 branches missed.">			if (alsoSubfolders &amp;&amp; isDirectoryFast(file))</span>
			{
<span class="nc" id="L246">				String subDir = basePath + &quot;/&quot; + file.getName();</span>
<span class="nc" id="L247">				fileList.addAll(getFilesFromDir(subDir, alsoSubfolders, listFiles(subDir)));</span>
<span class="nc" id="L248">			}</span>
			else
			{
				//ak vyberame o_image.jpg namiesto image.jpg
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">				if(noMiniatures)</span>
				{
<span class="nc bnc" id="L254" title="All 2 branches missed.">					if (isImageFast(file))</span>
					{
<span class="nc" id="L256">						fileList.add(file);</span>
					}
				}
<span class="pc bpc" id="L259" title="1 of 6 branches missed.">				else if (file.getName().startsWith(&quot;s_&quot;)==false &amp;&amp; file.getName().startsWith(&quot;o_&quot;)==false &amp;&amp; file.getName().startsWith(&quot;_tmp_o_&quot;)==false)</span>
				{
					//pridame iba obrazky ktore maju o_ verziu
<span class="pc bpc" id="L262" title="3 of 6 branches missed.">					if (isImageFast(file) &amp;&amp; (origFileNames.contains(&quot;o_&quot;+file.getName()) || Constants.getBoolean(&quot;imageAlwaysCreateGalleryBean&quot;) ))</span>
					{
<span class="fc" id="L264">						fileList.add(file);</span>
					}
				}
			}
		}

<span class="fc" id="L270">		return fileList;</span>
	}

	/**
	 * Vrati HashTabluku so zaznamami z databazy pre zadany adresar a jeho podadresare
	 * @param dir
	 * @return
	 */
	public static Map&lt;String, GalleryBean&gt; getGalleryBeanTable(String dir, String lng, boolean alsoSubfolders)
	{
<span class="pc bpc" id="L280" title="2 of 4 branches missed.">		if (dir.length()&gt;2 &amp;&amp; dir.endsWith(&quot;/&quot;))</span>
		{
			//odstran koncove lomitko
<span class="nc" id="L283">			dir = dir.substring(0, dir.length()-1);</span>
		}

<span class="fc" id="L286">		Map&lt;String, GalleryBean&gt; gBeanTable = new Hashtable&lt;&gt;();</span>
		GalleryBean gBean;
<span class="fc" id="L288">		Connection db_conn = null;</span>
<span class="fc" id="L289">		PreparedStatement ps = null;</span>
<span class="fc" id="L290">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L293">			db_conn = DBPool.getConnection();</span>

<span class="fc bfc" id="L295" title="All 2 branches covered.">			if (alsoSubfolders)</span>
			{
<span class="fc" id="L297">				ps = db_conn.prepareStatement(&quot;SELECT * FROM gallery WHERE image_path LIKE ? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L298">				ps.setString(1, dir + &quot;%&quot;);</span>
			}
			else
			{
<span class="fc" id="L302">				ps = db_conn.prepareStatement(&quot;SELECT * FROM gallery WHERE image_path=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L303">				ps.setString(1, dir);</span>
			}
<span class="fc" id="L305">			rs = ps.executeQuery();</span>
<span class="fc bfc" id="L306" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="fc" id="L308">				gBean = new GalleryBean();</span>
<span class="fc" id="L309">				gBean.setImageId(rs.getInt(&quot;image_id&quot;));</span>
<span class="fc" id="L310">				gBean.setImageName(DB.getDbString(rs, &quot;image_name&quot;));</span>
<span class="fc" id="L311">				gBean.setImagePath(DB.getDbString(rs, &quot;image_path&quot;));</span>
<span class="fc" id="L312">				gBean.setLongDescription(DB.getDbString(rs, &quot;l_description&quot; + lng));</span>
<span class="fc" id="L313">				gBean.setShortDescription(DB.getDbString(rs, &quot;s_description&quot; + lng));</span>
<span class="fc" id="L314">				gBean.setAuthor(rs.getString(&quot;author&quot;));</span>
<span class="fc" id="L315">				gBean.setSendCount(rs.getInt(&quot;send_count&quot;));</span>
<span class="fc" id="L316">				gBean.setAllowedDomains(rs.getString(&quot;allowed_domains&quot;));</span>
<span class="fc" id="L317">				gBean.setPerexGroup(convertPerexGroupString(rs.getString(&quot;perex_group&quot;)));</span>
<span class="fc" id="L318">				gBean.setUploadDate(DB.getDate(rs, &quot;upload_datetime&quot;));</span>
<span class="fc" id="L319">				gBean.setSortPriority(rs.getInt(&quot;sort_priority&quot;));</span>
<span class="fc" id="L320">				gBeanTable.put(gBean.getImageUrl(), gBean);</span>
			}

<span class="fc" id="L323">			rs.close();</span>
<span class="fc" id="L324">			ps.close();</span>
<span class="fc" id="L325">			db_conn.close();</span>
<span class="fc" id="L326">			rs = null;</span>
<span class="fc" id="L327">			ps = null;</span>
<span class="fc" id="L328">			db_conn = null;</span>
		}
<span class="nc" id="L330">		catch (Exception ex)</span>
		{
<span class="nc" id="L332">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L338" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L339">					rs.close();</span>
<span class="pc bpc" id="L340" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L341">					ps.close();</span>
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L343">					db_conn.close();</span>
			}
<span class="nc" id="L345">			catch (Exception ex2)</span>
			{
<span class="nc" id="L347">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L348">			}</span>
		}

<span class="fc" id="L351">		return gBeanTable;</span>
	}

	/**
	 * Skonvertuje list suborov na list GalleryBeanov, ak pre zadanu cestu nenajde GalleryBean z databazy spravi prazdny
	 * @param fileList
	 * @param gBeanTable
	 * @return
	 */
	private static List&lt;GalleryBean&gt; convertFilesToGbean(List&lt;IwcmFile&gt; fileList, Map&lt;String, GalleryBean&gt; gBeanTable)
	{
<span class="fc" id="L362">		List&lt;GalleryBean&gt; gBeanList = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L364" title="All 2 branches covered.">		for (IwcmFile file : fileList)</span>
		{
<span class="fc" id="L366">			String virtualPath = file.getVirtualPath();</span>
<span class="fc" id="L367">			String fileName = file.getName();</span>
<span class="pc bpc" id="L368" title="3 of 4 branches missed.">			if(fileName.startsWith(&quot;o_&quot;) &amp;&amp; fileName.length()&gt;2)</span>
			{
<span class="nc" id="L370">				int index = virtualPath.lastIndexOf(fileName);</span>
<span class="nc" id="L371">				virtualPath = new StringBuilder(virtualPath).replace(index, index+fileName.length()+1,fileName.substring(2)).toString();</span>
			}
<span class="fc" id="L373">			GalleryBean gb = gBeanTable.get(virtualPath);</span>
<span class="fc bfc" id="L374" title="All 2 branches covered.">			if (gb == null)</span>
			{
<span class="fc" id="L376">				gb = new GalleryBean();</span>
<span class="fc" id="L377">				gb.setImageId(-1);</span>
<span class="fc" id="L378">				gb.setAuthor(&quot;&quot;);</span>
<span class="fc" id="L379">				gb.setImageName(file.getName());</span>
<span class="fc" id="L380">				gb.setImagePath(file.getVirtualParent());</span>
<span class="fc" id="L381">				gb.setLongDescription(&quot;&quot;);</span>
<span class="fc" id="L382">				gb.setShortDescription(&quot;&quot;);</span>
<span class="pc bpc" id="L383" title="1 of 2 branches missed.">				if (Constants.getBoolean(&quot;galleryUseFastLoading&quot;)==false) gb.setUploadDate(new Date(file.lastModified()));</span>
			}
<span class="pc bpc" id="L385" title="1 of 2 branches missed.">			else if (file.getName().startsWith(&quot;o_&quot;))</span>
			{
<span class="nc" id="L387">				gb.setImageName(file.getName());</span>
			}
<span class="fc" id="L389">			gBeanList.add(gb);</span>
<span class="fc" id="L390">		}</span>

<span class="fc" id="L392">		return gBeanList;</span>
	}

	private static List&lt;GalleryBean&gt; filterByPerexGroups(List&lt;GalleryBean&gt; gBeanList, String perexGroupIds)
	{
<span class="pc bpc" id="L397" title="1 of 2 branches missed.">		if (Tools.isEmpty(perexGroupIds)) return gBeanList;</span>

<span class="nc" id="L399">		List&lt;GalleryBean&gt; filtered = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L401">		String[] pgids = convertPerexGroupString(perexGroupIds);</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">		for (GalleryBean gb : gBeanList)</span>
		{
<span class="nc bnc" id="L404" title="All 4 branches missed.">			if (gb.getPerexGroup()==null || gb.getPerexGroup().length==0) continue;</span>

<span class="nc bnc" id="L406" title="All 2 branches missed.">			if (Tools.containsOneItem(pgids, gb.getPerexGroup()))</span>
			{
<span class="nc" id="L408">				filtered.add(gb);</span>
			}
<span class="nc" id="L410">		}</span>

<span class="nc" id="L412">		return filtered;</span>
	}

	/**
	 * @deprecated pouzite getImages
	 * @param dir
	 * @param servletContext
	 * @param request
	 * @param lng
	 * @return
	 */
	@Deprecated
	public static List&lt;GalleryBean&gt; getImagesFromDir(String dir, ServletContext servletContext, HttpServletRequest request, String lng)
	{
<span class="nc" id="L426">		return getImages(dir, false, lng, null, &quot;title&quot;, &quot;asc&quot;, request);</span>
	}


	/**
	 * Nacita obrazky zo zadaneho adresara a spravi filtraciu a sortovanie na zaklade zadanych parametrov
	 * @param dir
	 * @param alsoSubfolders
	 * @param lng
	 * @param perexGroupIds
	 * @param orderBy
	 * @param orderDirection
	 * @param request
	 * @return
	 */
	public static List&lt;GalleryBean&gt; getImages(String dir, boolean alsoSubfolders, String lng, String perexGroupIds, String orderBy, String orderDirection, HttpServletRequest request)
	{
<span class="fc" id="L443">		return getImages(dir, alsoSubfolders, lng, perexGroupIds, orderBy, orderDirection, null, request);</span>
	}

	/**
	 * Nacita obrazky zo zadaneho adresara a spravi filtraciu a sortovanie na zaklade zadanych parametrov
	 * @param dir
	 * @param alsoSubfolders
	 * @param lng
	 * @param perexGroupIds
	 * @param orderBy
	 * @param orderDirection
	 * @param saveDirsRequestName - meno request premennej do ktorej vlozi zoznam pod adresarov (pouziva sa pre admin cast)
	 * @param request
	 * @return
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public static List&lt;GalleryBean&gt; getImages(String dir, boolean alsoSubfolders, String lng, String perexGroupIds, String orderBy, String orderDirection, String saveDirsRequestName, HttpServletRequest request)
	{
<span class="fc" id="L461">		int galleryCacheResultMinutes = Constants.getInt(&quot;galleryCacheResultMinutes&quot;);</span>
<span class="fc" id="L462">		Cache c = Cache.getInstance();</span>
		List&lt;GalleryBean&gt; galleryList;
<span class="fc" id="L464">		String CACHE_KEY = null;</span>
<span class="fc" id="L465">		String CACHE_KEY_DIRLIST = null;</span>

<span class="pc bpc" id="L467" title="5 of 6 branches missed.">		if (galleryCacheResultMinutes &gt; 0 &amp;&amp; alsoSubfolders==false &amp;&amp; Tools.isEmpty(perexGroupIds))</span>
		{
			//cachovanie zoznamu fotiek na zaklade lastmodified adresara
<span class="nc" id="L470">			IwcmFile galleryDir = new IwcmFile(Tools.getRealPath(dir));</span>
<span class="nc" id="L471">			CACHE_KEY =         &quot;GalleryDB.getImages-&quot;    +dir+&quot;-&quot;+lng+&quot;-&quot;+orderBy+&quot;-&quot;+orderDirection+&quot;-&quot;+galleryDir.lastModified();</span>
<span class="nc" id="L472">			CACHE_KEY_DIRLIST = &quot;GalleryDB.getImagesDirs-&quot;+dir+&quot;-&quot;+lng+&quot;-&quot;+orderBy+&quot;-&quot;+orderDirection+&quot;-&quot;+galleryDir.lastModified();</span>

<span class="nc" id="L474">			galleryList = (List&lt;GalleryBean&gt;) c.getObject(CACHE_KEY);</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">			if (galleryList != null)</span>
			{
<span class="nc bnc" id="L477" title="All 2 branches missed.">				if (Tools.isNotEmpty(saveDirsRequestName))</span>
				{
<span class="nc" id="L479">					List&lt;FileDirBean&gt; dirList = (List&lt;FileDirBean&gt;)c.getObject(CACHE_KEY_DIRLIST);</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">					if (dirList != null)</span>
					{
<span class="nc" id="L482">						request.setAttribute(saveDirsRequestName, dirList);</span>
					}
					else
					{
						//nemozeme vratit cachovany zoznam, pretoze nemame dirList
<span class="nc" id="L487">						galleryList = null;</span>
					}
				}

<span class="nc bnc" id="L491" title="All 2 branches missed.">				if (galleryList != null)</span>
				{
<span class="nc" id="L493">					Logger.debug(GalleryDB.class, &quot;Vraciam cachovany vystup galerie, key=&quot;+CACHE_KEY+&quot; velkost=&quot;+galleryList.size());</span>
<span class="nc" id="L494">					return galleryList;</span>
				}
			}
		}

<span class="fc" id="L499">		galleryList = getImagesImpl(dir, alsoSubfolders, lng, perexGroupIds, orderBy, orderDirection, saveDirsRequestName, request);</span>

<span class="pc bpc" id="L501" title="3 of 4 branches missed.">		if (galleryCacheResultMinutes &gt; 0 &amp;&amp; CACHE_KEY != null)</span>
		{
			//uloz vystup do cache
<span class="nc" id="L504">			c.setObjectSeconds(CACHE_KEY, galleryList, galleryCacheResultMinutes*60, true);</span>

<span class="nc bnc" id="L506" title="All 2 branches missed.">			if (Tools.isNotEmpty(saveDirsRequestName))</span>
			{
<span class="nc" id="L508">				List&lt;FileDirBean&gt; dirList = (List&lt;FileDirBean&gt;)request.getAttribute(saveDirsRequestName);</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">				if (dirList != null)</span>
				{
<span class="nc" id="L511">					c.setObjectSeconds(CACHE_KEY_DIRLIST, dirList, galleryCacheResultMinutes*60, true);</span>
				}
			}
		}

<span class="fc" id="L516">		return galleryList;</span>
	}

	/**
	 * Nacita obrazky zo zadaneho adresara a spravi filtraciu a sortovanie na zaklade zadanych parametrov
	 * @param dir
	 * @param alsoSubfolders
	 * @param lng
	 * @param perexGroupIds
	 * @param orderBy
	 * @param orderDirection
	 * @param saveDirsRequestName - meno request premennej do ktorej vlozi zoznam pod adresarov (pouziva sa pre admin cast)
	 * @param request
	 * @return
	 */
	private static List&lt;GalleryBean&gt; getImagesImpl(String dir, boolean alsoSubfolders, String lng, String perexGroupIds, String orderBy, String orderDirection, String saveDirsRequestName, HttpServletRequest request)
	{
<span class="fc" id="L533">		DebugTimer dt = new DebugTimer(&quot;GalleryDB.getImages, dir=&quot;+dir);</span>

<span class="fc" id="L535">		HttpSession session = request.getSession();</span>

<span class="fc" id="L537">		String lngAdd = getLngAdd(lng, request);</span>

		//ziskaj beany
<span class="fc" id="L540">		Map&lt;String, GalleryBean&gt; gBeanTable = getGalleryBeanTable(dir, lngAdd, alsoSubfolders);</span>

<span class="fc" id="L542">		dt.diff(&quot;After gBeanTable&quot;);</span>

		//ziskaj subory

<span class="fc" id="L546">		IwcmFile[] filesInDir = listFiles(dir);</span>
<span class="fc" id="L547">		dt.diff(&quot;After fileList&quot;);</span>

<span class="pc bpc" id="L549" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(saveDirsRequestName))</span>
		{
<span class="nc" id="L551">			request.setAttribute(saveDirsRequestName, GalleryDB.getDirs(dir, filesInDir));</span>
<span class="nc" id="L552">			dt.diff(&quot;After get dirs&quot;);</span>
		}

<span class="fc" id="L555">		List&lt;IwcmFile&gt; fileList = getFilesFromDir(dir, alsoSubfolders, filesInDir);</span>
<span class="fc" id="L556">		dt.diff(&quot;After getFilesFromDir&quot;);</span>

		//skonvertuj na pole gbeanov
<span class="fc" id="L559">		List&lt;GalleryBean&gt; gBeanList = convertFilesToGbean(fileList, gBeanTable);</span>

<span class="fc" id="L561">		dt.diff(&quot;After convert&quot;);</span>

		//skontroluj perex skupiny
<span class="fc" id="L564">		gBeanList = filterByPerexGroups(gBeanList, perexGroupIds);</span>

<span class="fc" id="L566">		dt.diff(&quot;After filter perex group&quot;);</span>

		//filtrovanie na zaklade datumu
<span class="pc bpc" id="L569" title="2 of 4 branches missed.">		String filterDateFrom = session != null &amp;&amp; session.getAttribute(DATE_FROM_SESSION_FILTER) != null ? (String)session.getAttribute(DATE_FROM_SESSION_FILTER) : null;</span>
<span class="pc bpc" id="L570" title="2 of 4 branches missed.">		String filterDateTo = session != null &amp;&amp; session.getAttribute(DATE_TO_SESSION_FILTER) != null ? (String)session.getAttribute(DATE_TO_SESSION_FILTER) : null;</span>

<span class="pc bpc" id="L572" title="2 of 4 branches missed.">		if(Tools.isNotEmpty(filterDateFrom) || Tools.isNotEmpty(filterDateTo))</span>
		{
<span class="nc" id="L574">			Calendar dateFrom = null;</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">			if(Tools.isNotEmpty(filterDateFrom))</span>
			{
<span class="nc" id="L577">				dateFrom = Calendar.getInstance();</span>
<span class="nc" id="L578">				dateFrom.setTimeInMillis(DB.getTimestamp(filterDateFrom, &quot;00:00:00&quot;));</span>
			}
<span class="nc" id="L580">			Calendar dateTo = null;</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">			if(Tools.isNotEmpty(filterDateTo))</span>
			{
<span class="nc" id="L583">				dateTo = Calendar.getInstance();</span>
<span class="nc" id="L584">				dateTo.setTimeInMillis(DB.getTimestamp(filterDateTo, &quot;23:59:59&quot;));</span>
			}
<span class="nc" id="L586">			List&lt;GalleryBean&gt; filtered = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L588" title="All 4 branches missed.">			if(gBeanList != null &amp;&amp; gBeanList.size() &gt; 0)</span>
			{
<span class="nc bnc" id="L590" title="All 2 branches missed.">				for (GalleryBean gb : gBeanList)</span>
				{
<span class="nc bnc" id="L592" title="All 2 branches missed.">					if(gb.getUploadDate() != null)</span>
					{
<span class="nc bnc" id="L594" title="All 4 branches missed.">						if(dateFrom != null &amp;&amp; dateTo == null)</span>
						{
<span class="nc bnc" id="L596" title="All 2 branches missed.">							if(gb.getUploadDate().getTime() &gt;= dateFrom.getTimeInMillis())</span>
<span class="nc" id="L597">								filtered.add(gb);</span>
						}
<span class="nc bnc" id="L599" title="All 4 branches missed.">						else if(dateTo != null &amp;&amp; dateFrom == null)</span>
						{
<span class="nc bnc" id="L601" title="All 2 branches missed.">							if(gb.getUploadDate().getTime() &lt;= dateTo.getTimeInMillis())</span>
<span class="nc" id="L602">								filtered.add(gb);</span>
						}
<span class="nc bnc" id="L604" title="All 4 branches missed.">						else if (dateFrom != null &amp;&amp; dateTo != null)</span>
						{
<span class="nc bnc" id="L606" title="All 4 branches missed.">							if(gb.getUploadDate().getTime() &gt;= dateFrom.getTimeInMillis() &amp;&amp; gb.getUploadDate().getTime() &lt;= dateTo.getTimeInMillis())</span>
<span class="nc" id="L607">								filtered.add(gb);</span>
						}
					}
<span class="nc" id="L610">				}</span>
			}
<span class="nc" id="L612">			gBeanList = filtered;</span>
		}
		//END filtrovanie na zaklade datumu

<span class="fc" id="L616">		dt.diff(&quot;After filter datum&quot;);</span>

		//usortuj
<span class="fc" id="L619">		sort(gBeanList, orderBy, orderDirection);</span>

<span class="fc" id="L621">		dt.diff(&quot;After sort&quot;);</span>

<span class="fc" id="L623">		List&lt;GalleryBean&gt; returnList = new ArrayList&lt;&gt;();</span>
		try
		{
<span class="fc" id="L626">			int page = 1;</span>
<span class="fc" id="L627">			int pSize = -1;</span>
<span class="pc bpc" id="L628" title="1 of 2 branches missed.">			if (request.getAttribute(&quot;disablegPage&quot;) == null)</span>
			{
<span class="pc bpc" id="L630" title="1 of 2 branches missed.">				if (request.getParameter(&quot;gpage&quot;) != null) page = Tools.getIntValue(request.getParameter(&quot;gpage&quot;), -1);</span>
<span class="pc bpc" id="L631" title="1 of 2 branches missed.">				else if (request.getAttribute(&quot;gpage&quot;) != null) page = Tools.getIntValue((String) request.getAttribute(&quot;gpage&quot;), -1);</span>
			}
<span class="fc" id="L633">			request.removeAttribute(&quot;disablegPage&quot;);</span>
<span class="pc bpc" id="L634" title="1 of 2 branches missed.">			if (session!=null) session.setAttribute(&quot;galleryActualPage&quot;, Integer.toString(page));</span>
<span class="pc bpc" id="L635" title="2 of 4 branches missed.">			if (request.getAttribute(&quot;disablegPage&quot;) == null &amp;&amp; request.getParameter(&quot;gpsize&quot;) != null) pSize = Tools.getIntValue(request.getParameter(&quot;gpsize&quot;), -1);</span>
<span class="pc bpc" id="L636" title="1 of 2 branches missed.">			else if (request.getAttribute(&quot;gpsize&quot;) != null) pSize = Tools.getIntValue((String) request.getAttribute(&quot;gpsize&quot;), -1);</span>

<span class="fc" id="L638">			int start = 0;</span>
<span class="fc" id="L639">			int end = gBeanList.size();</span>
<span class="fc" id="L640">			request.setAttribute(&quot;gTotalImages&quot;, Integer.toString(end));</span>

<span class="pc bpc" id="L642" title="1 of 2 branches missed.">			if (pSize &gt; 0)</span>
			{
				// vytvor strankovanie
<span class="nc" id="L645">				List&lt;LabelValueDetails&gt; pages = new ArrayList&lt;&gt;();</span>
				try
				{
<span class="nc" id="L648">					StringBuilder params = new StringBuilder(&quot;gpsize=&quot; + pSize);</span>
<span class="nc" id="L649">					Enumeration&lt;String&gt; paramsEnum = request.getParameterNames();</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">					while (paramsEnum.hasMoreElements())</span>
					{
<span class="nc" id="L652">						String param = paramsEnum.nextElement();</span>
					   // tieto ignorujem, nastavim neskor
<span class="nc bnc" id="L654" title="All 4 branches missed.">						if (param.equals(&quot;gpage&quot;) || param.equals(&quot;gpsize&quot;)) continue;</span>
<span class="nc bnc" id="L655" title="All 4 branches missed.">						if (Constants.getInt(&quot;linkType&quot;) == Constants.LINK_TYPE_HTML &amp;&amp; param.equals(&quot;docid&quot;)) continue;</span>

<span class="nc" id="L657">						params.append(&quot;&amp;amp;&quot;).append(ResponseUtils.filter(param)).append('=').append(ResponseUtils.filter(request.getParameter(param)));</span>
<span class="nc" id="L658">					}</span>
<span class="nc" id="L659">					int counter = 1;</span>
<span class="nc bnc" id="L660" title="All 2 branches missed.">					while (start &lt; end)</span>
					{
<span class="nc" id="L662">						LabelValueDetails lvd = new LabelValueDetails(Integer.toString(counter), &quot;&quot;);</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">						if (counter != page)	lvd.setValue(params.toString() + &quot;&amp;amp;gpage=&quot; + counter);</span>
<span class="nc" id="L664">						pages.add(lvd);</span>
<span class="nc" id="L665">						counter++;</span>
<span class="nc" id="L666">						start += pSize;</span>
<span class="nc" id="L667">					}</span>
				}
<span class="nc" id="L669">				catch (Exception ex)</span>
				{
<span class="nc" id="L671">					sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L672">				}</span>

<span class="nc bnc" id="L674" title="All 2 branches missed.">				if (pages.size() &gt; 1)</span>
				{
<span class="nc" id="L676">					request.setAttribute(&quot;gPages&quot;, pages);</span>
				}

<span class="nc" id="L679">				start = (page - 1) * pSize;</span>
<span class="nc" id="L680">				end = start + pSize;</span>
			}
<span class="pc bpc" id="L682" title="1 of 2 branches missed.">			if (start &lt; 0) start = 0;</span>
<span class="pc bpc" id="L683" title="2 of 4 branches missed.">			if (end &gt; gBeanList.size() || Boolean.TRUE.equals(request.getAttribute(&quot;returnAllPages&quot;)))</span>
			{
<span class="nc" id="L685">				end = gBeanList.size();</span>
			}

			//cache nastaveni adresara galerie (pre FSDB nezistujem rozmery obrazka presne, ale pouzijem nastavenie galerie)
<span class="fc" id="L689">			Map&lt;String, Dimension[]&gt; dimensionDirTable = new Hashtable&lt;&gt;();</span>
<span class="fc bfc" id="L690" title="All 2 branches covered.">			for (int i = start; i &lt; end; i++)</span>
			{
<span class="fc" id="L692">				GalleryBean gBean = gBeanList.get(i);</span>

<span class="pc bpc" id="L694" title="1 of 2 branches missed.">				if (gBeanList.size()&gt;1)</span>
				{
					try
					{
<span class="fc bfc" id="L698" title="All 2 branches covered.">						if (i &gt; 0) gBean.setPrevImage(gBeanList.get(i-1).getImageUrl());</span>
<span class="fc" id="L699">						else gBean.setPrevImage(gBeanList.get(gBeanList.size()-1).getImageUrl());</span>

<span class="fc bfc" id="L701" title="All 2 branches covered.">						if (i &lt; (gBeanList.size()-1))	gBean.setNextImage(gBeanList.get(i+1).getImageUrl());</span>
<span class="fc" id="L702">						else gBean.setNextImage(gBeanList.get(0).getImageUrl());</span>
					}
<span class="nc" id="L704">					catch (Exception e)</span>
					{
<span class="nc" id="L706">						sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L707">					}</span>
				}

				try
				{
					// testni ci existuje originalImage
<span class="fc" id="L713">					String originalImage = Tools.getRealPath(gBean.getImagePath() + File.separatorChar + &quot;o_&quot; + gBean.getImageName());</span>
<span class="fc" id="L714">					IwcmFile file = new IwcmFile(originalImage);</span>
<span class="pc bpc" id="L715" title="1 of 2 branches missed.">					if (isImageFast(file))</span>
					{
<span class="fc" id="L717">						gBean.setOriginalImage(file.getVirtualPath());</span>
					}
				}
<span class="nc" id="L720">				catch (Exception ex)</span>
				{
<span class="nc" id="L722">					sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L723">				}</span>

				// ziskaj velky obrazok a ziskaj jeho rozmer a velkost
				try
				{
<span class="fc" id="L728">					IwcmFile bigImageFile = new IwcmFile(Tools.getRealPath(gBean.getImageUrl()));</span>
<span class="pc bpc" id="L729" title="2 of 4 branches missed.">					if (Constants.getBoolean(&quot;galleryUseFastLoading&quot;) || bigImageFile.exists())</span>
					{
<span class="pc bpc" id="L731" title="1 of 2 branches missed.">						if (Constants.getBoolean(&quot;galleryUseFastLoading&quot;)==false) gBean.setBigLength(FileTools.getFormatFileSize(bigImageFile.length(), false));</span>
<span class="pc bpc" id="L732" title="1 of 2 branches missed.">						if (Constants.getBoolean(&quot;galleryUseFastLoading&quot;))</span>
						{
<span class="nc" id="L734">							Dimension[] dims = dimensionDirTable.get(gBean.getImagePath());</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">							if (dims == null)</span>
							{
<span class="nc" id="L737">								Logger.debug(GalleryDB.class, &quot;getting dims for: &quot;+gBean.getImagePath());</span>
<span class="nc" id="L738">								dims = getDimension(gBean.getImagePath());</span>
<span class="nc" id="L739">								dimensionDirTable.put(gBean.getImagePath(), dims);</span>
							}
<span class="nc bnc" id="L741" title="All 4 branches missed.">							if (dims != null &amp;&amp; dims.length&gt;1)</span>
							{
<span class="nc" id="L743">								gBean.setBigDimension(dims[1].width+&quot;x&quot;+dims[1].height);</span>
							}
<span class="nc" id="L745">						}</span>
						else
						{
<span class="fc" id="L748">							int[] dims = GalleryDBTools.getImageSize(bigImageFile);</span>
<span class="fc" id="L749">							gBean.setBigDimension(dims[0]+&quot;x&quot;+dims[1]);</span>
						}
					}
					// timer.diff(&quot;mam: &quot; + fName);
				}
<span class="nc" id="L754">				catch (Exception ex)</span>
				{
<span class="nc" id="L756">					sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L757">				}</span>
<span class="fc" id="L758">				returnList.add(gBean);</span>
			}
		}
<span class="nc" id="L761">		catch (Exception ex)</span>
		{
<span class="nc" id="L763">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L764">		}</span>

<span class="fc" id="L766">		dt.diff(&quot;Returning&quot;);</span>

<span class="fc" id="L768">		return returnList;</span>
	}

	private static void sort(List&lt;GalleryBean&gt; list, String orderBy, String orderDirection)
	{
<span class="pc bpc" id="L773" title="1 of 2 branches missed.">		if(&quot;asc&quot;.equals(orderDirection))</span>
		{

<span class="pc bpc" id="L776" title="1 of 2 branches missed.">			if(orderBy.equalsIgnoreCase(&quot;priority&quot;))</span>
<span class="nc" id="L777">				Collections.sort(list, new Comparator&lt;GalleryBean&gt;() {</span>
				    @Override
					public int compare(GalleryBean gb1, GalleryBean gb2) {
<span class="nc bnc" id="L780" title="All 2 branches missed.">				        return (gb1.getSortPriority() - gb2.getSortPriority()) == 0?gb1.getImageName().compareTo(gb2.getImageName()):(gb1.getSortPriority() - gb2.getSortPriority());</span>
				    }
				});
			else
<span class="pc bpc" id="L784" title="1 of 2 branches missed.">			if(orderBy.equalsIgnoreCase(&quot;date&quot;))</span>
<span class="nc" id="L785">				Collections.sort(list, new Comparator&lt;GalleryBean&gt;() {</span>
				    @Override
					public int compare(GalleryBean gb1, GalleryBean gb2) {
<span class="nc" id="L788">				        int dateCmp = gb1.getUploadDate().compareTo(gb2.getUploadDate());</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">				        if (dateCmp != 0)</span>
<span class="nc" id="L790">				            return dateCmp;</span>
<span class="nc" id="L791">				        return gb1.getImageName().compareTo(gb2.getImageName());</span>
				    }
				});
			else
<span class="fc" id="L795">				Collections.sort(list, new Comparator&lt;GalleryBean&gt;() {</span>
				    @Override
					public int compare(GalleryBean gb1, GalleryBean gb2) {
<span class="fc" id="L798">				       int stringCmp = gb1.getImageName().compareTo(gb2.getImageName());</span>
<span class="pc bpc" id="L799" title="1 of 2 branches missed.">				       if (stringCmp != 0)</span>
<span class="fc" id="L800">				            return stringCmp;</span>
<span class="nc" id="L801">				       return gb1.getUploadDate().compareTo(gb2.getUploadDate());</span>
				    }
				});
		}
		else
		{
<span class="nc bnc" id="L807" title="All 2 branches missed.">			if(orderBy.equalsIgnoreCase(&quot;priority&quot;))</span>
<span class="nc" id="L808">				Collections.sort(list, new Comparator&lt;GalleryBean&gt;() {</span>
				    @Override
					public int compare(GalleryBean gb1, GalleryBean gb2) {
<span class="nc bnc" id="L811" title="All 2 branches missed.">				   	 return (gb2.getSortPriority() - gb1.getSortPriority()) == 0?gb2.getImageName().compareTo(gb1.getImageName()):(gb2.getSortPriority() - gb1.getSortPriority());</span>
				    }
				});
			else
<span class="nc bnc" id="L815" title="All 2 branches missed.">			if(orderBy.equalsIgnoreCase(&quot;date&quot;))</span>
<span class="nc" id="L816">				Collections.sort(list, new Comparator&lt;GalleryBean&gt;() {</span>
				    @Override
					public int compare(GalleryBean gb1, GalleryBean gb2)
				    {
<span class="nc" id="L820">				        int dateCmp = gb2.getUploadDate().compareTo(gb1.getUploadDate());</span>
<span class="nc" id="L821">				        Logger.debug(GalleryDB.class, &quot;Comparing: &quot;+gb1.getImageName()+&quot; (&quot;+Tools.formatDate(gb1.getUploadDate())+&quot;) vs &quot;+gb2.getImageName()+&quot; (&quot;+Tools.formatDate(gb2.getUploadDate())+&quot;) ret=&quot;+dateCmp);</span>
<span class="nc bnc" id="L822" title="All 2 branches missed.">				        if (dateCmp != 0)</span>
<span class="nc" id="L823">				            return dateCmp;</span>
<span class="nc" id="L824">				        return gb2.getImageName().compareTo(gb1.getImageName());</span>
				    }
				});
			else
<span class="nc" id="L828">				Collections.sort(list, new Comparator&lt;GalleryBean&gt;() {</span>
				    @Override
					public int compare(GalleryBean gb1, GalleryBean gb2) {
<span class="nc" id="L831">				       int stringCmp = gb2.getImageName().compareTo(gb1.getImageName());</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">				       if (stringCmp != 0)</span>
<span class="nc" id="L833">				            return stringCmp;</span>
<span class="nc" id="L834">				       return gb2.getUploadDate().compareTo(gb1.getUploadDate());</span>
				    }
				});
		}
<span class="fc" id="L838">	}</span>

	/**
	 * Vrati nahodny obrazok z galerie, pricom si ho pamata zadany pocet minut
	 *
	 *@param dir
	 *@param rememberMinutes
	 *           - pocet minut, pocas ktorych si zapamata obrazok a negeneruje ho
	 *           znova
	 *@param servletContext
	 *@param request
	 *@return
	 */
	public static GalleryBean getRandomImageFromDir(String dir, int rememberMinutes, ServletContext servletContext,
				HttpServletRequest request)
	{
<span class="nc" id="L854">		String scImage = &quot;GALLERY_RANDOM_IMAGE&quot;;</span>
<span class="nc" id="L855">		String scImageTime = &quot;GALLERY_RANDOM_IMAGE_TIME&quot;;</span>
<span class="nc" id="L856">		GalleryBean randomImage = null;</span>
<span class="nc" id="L857">		long now = (new java.util.Date()).getTime();</span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">		if (rememberMinutes &gt; 0)</span>
		{
			// najskor zisti, ci uz obrazok nemame a ci nie je platny
<span class="nc" id="L861">			randomImage = (GalleryBean) servletContext.getAttribute(scImage);</span>
<span class="nc" id="L862">			Long imageTime = (Long) servletContext.getAttribute(scImageTime);</span>
<span class="nc" id="L863">			now = now - (rememberMinutes * 60L * 1000);</span>
<span class="nc bnc" id="L864" title="All 6 branches missed.">			if (randomImage != null &amp;&amp; imageTime != null &amp;&amp; imageTime.longValue() &gt; now)</span>
			{
<span class="nc" id="L866">				return (randomImage);</span>
			}
		}
		// obrazok neexistuje, alebo je stary, ziskaj zoznam a nahodne vyber
<span class="nc" id="L870">		request.setAttribute(&quot;disablegPage&quot;, &quot;true&quot;);</span>
<span class="nc" id="L871">		List&lt;GalleryBean&gt; images = getImages(dir, false, null, null, &quot;title&quot;, &quot;asc&quot;, request);</span>
<span class="nc" id="L872">		request.removeAttribute(&quot;disablegPage&quot;);</span>
<span class="nc" id="L873">		int maxSize = images.size();</span>
<span class="nc bnc" id="L874" title="All 2 branches missed.">		if (maxSize &lt; 1)</span>
		{
<span class="nc" id="L876">			return (new GalleryBean());</span>
		}
		// posledne vygenerovany obrazok
<span class="nc" id="L879">		String lastImageName = null;</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">		if (randomImage != null)</span>
		{
<span class="nc" id="L882">			lastImageName = randomImage.getImageName();</span>
		}
		// vygeneruj nahodne cislo
		int index;
<span class="nc" id="L886">		int counter = 0;</span>
<span class="nc" id="L887">		GalleryBean newImage = null;</span>
<span class="nc bnc" id="L888" title="All 2 branches missed.">		while (counter &lt; 10)</span>
		{
			try
			{
<span class="nc" id="L892">				index = rand.nextInt(maxSize);</span>
<span class="nc" id="L893">				newImage = images.get(index);</span>
<span class="nc bnc" id="L894" title="All 4 branches missed.">				if (lastImageName == null || newImage.getImageName().compareTo(lastImageName) != 0)</span>
				{
<span class="nc" id="L896">					break;</span>
				}
			}
<span class="nc" id="L899">			catch (Exception ex)</span>
			{
<span class="nc" id="L901">				sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L902">			}</span>
<span class="nc" id="L903">			counter++;</span>
		}
		// ok, mali by sme mat obrazok
<span class="nc bnc" id="L906" title="All 2 branches missed.">		if (newImage != null)</span>
		{
			// uloz to do servlet contextu
<span class="nc" id="L909">			servletContext.setAttribute(scImage, newImage);</span>
<span class="nc" id="L910">			now = (new java.util.Date()).getTime();</span>
<span class="nc" id="L911">			servletContext.setAttribute(scImageTime, Long.valueOf(now));</span>
<span class="nc" id="L912">			return (newImage);</span>
		}
<span class="nc" id="L914">		return (new GalleryBean());</span>
	}

	/**
	 * Vrati celkovy pocet obrazkov v zadanom adresari, berie do uvahy len
	 *  small verzie obrazkov (pocita len obrazky s predponou &quot;s_&quot;)
	 *
	 *@param dir
	 *           - adresar s obrazkami
	 *@return
	 */
	public static int getTotalImagesInDir(String dir)
	{
<span class="fc" id="L927">		int ret = 0;</span>
		try
		{
<span class="fc" id="L930">			String realPath = Tools.getRealPath(dir);</span>
<span class="fc" id="L931">			IwcmFile file = new IwcmFile(realPath);</span>
<span class="fc" id="L932">			IwcmFile[] fileList = file.listFiles(new IwcmFileFilter()</span>
<span class="fc" id="L933">			{</span>
				@Override
				public boolean accept(IwcmFile pathname)
				{
<span class="pc bpc" id="L937" title="1 of 2 branches missed.">					return (isImageFast(pathname))</span>
<span class="pc bpc" id="L938" title="1 of 4 branches missed.">								&amp;&amp; (pathname.getName().startsWith(&quot;o_&quot;)==false &amp;&amp; pathname.getName().startsWith(&quot;s_&quot;)==false);</span>
				}
			});
<span class="fc" id="L941">			ret = fileList.length;</span>
		}
<span class="nc" id="L943">		catch (Exception ex)</span>
		{
<span class="nc" id="L945">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L946">		}</span>
<span class="fc" id="L947">		return (ret);</span>
	}

	/**
	 * Gets the imageByID attribute of the GalleryDB class
	 *
	 *@param iIDString
	 *           Description of the Parameter
	 *@param request
	 *           Description of the Parameter
	 *@return The imageByID value
	 */
	public static GalleryBean getImageByID(String iIDString, HttpServletRequest request, String lng)
	{
<span class="nc" id="L961">		return getImageByID(Integer.parseInt(iIDString), request, lng);</span>
	}

	/**
	 * Gets the imageByID attribute of the GalleryDB class
	 *
	 *@param iID
	 *           Description of the Parameter
	 *@param request
	 *           Description of the Parameter
	 *@return The imageByID value
	 */
	public static GalleryBean getImageByID(int iID, HttpServletRequest request, String lng)
	{
<span class="nc" id="L975">		java.sql.Connection db_conn = null;</span>
<span class="nc" id="L976">		java.sql.PreparedStatement ps = null;</span>
<span class="nc" id="L977">		java.sql.ResultSet rs = null;</span>
<span class="nc" id="L978">		GalleryBean gBean = null;</span>
<span class="nc" id="L979">		String sql = &quot;SELECT * FROM gallery WHERE image_id=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
<span class="nc" id="L980">		String lngAdd = getLngAdd(lng, request);</span>
		try
		{
<span class="nc" id="L983">			db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="nc" id="L984">			ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L985">			ps.setInt(1, iID);</span>
<span class="nc" id="L986">			rs = ps.executeQuery();</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L989">				gBean = new GalleryBean();</span>
<span class="nc" id="L990">				gBean.setImageId(rs.getInt(&quot;image_id&quot;));</span>
<span class="nc" id="L991">				gBean.setImageName(DB.getDbString(rs, &quot;image_name&quot;));</span>
<span class="nc" id="L992">				gBean.setImagePath(DB.getDbString(rs, &quot;image_path&quot;));</span>
<span class="nc" id="L993">				gBean.setLongDescription(DB.getDbString(rs, &quot;l_description&quot; + lngAdd));</span>
<span class="nc" id="L994">				gBean.setShortDescription(DB.getDbString(rs, &quot;s_description&quot; + lngAdd));</span>
<span class="nc" id="L995">				gBean.setPerexGroup(convertPerexGroupString(DB.getDbString(rs, &quot;perex_group&quot;)));</span>
			}
<span class="nc" id="L997">			rs.close();</span>
<span class="nc" id="L998">			ps.close();</span>
<span class="nc" id="L999">			db_conn.close();</span>
<span class="nc" id="L1000">			db_conn = null;</span>
<span class="nc" id="L1001">			rs = null;</span>
<span class="nc" id="L1002">			ps = null;</span>
		}
<span class="nc" id="L1004">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L1007" title="All 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="nc bnc" id="L1008" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L1009" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L1010">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="nc" id="L1012">		return gBean;</span>
	}

	/**
	 * Ulozi informacie o obrazku do DB, vrati id obrazku
	 *
	 *@param gBean
	 *           The feature to be added to the Image attribute
	 *@param request
	 *           The feature to be added to the Image attribute
	 */
	public static int setImage(HttpServletRequest request)
	{
<span class="nc" id="L1025">		java.sql.Connection db_conn = null;</span>
<span class="nc" id="L1026">		java.sql.PreparedStatement ps = null;</span>
<span class="nc" id="L1027">		ResultSet rs = null;</span>

<span class="nc" id="L1029">		int iID = -1;</span>

		try
		{
<span class="nc" id="L1033">			String dir = request.getParameter(&quot;dir&quot;);</span>
<span class="nc" id="L1034">			String name = request.getParameter(&quot;name&quot;);</span>

<span class="nc" id="L1036">			GalleryBean gBean = GalleryDB.getGalleryBean(dir, name, request, &quot;sk&quot;);</span>

<span class="nc bnc" id="L1038" title="All 2 branches missed.">			if (gBean != null) iID = gBean.getImageId();</span>

<span class="nc" id="L1040">			Logger.debug(GalleryDB.class, &quot;setImage iID=&quot;+iID+&quot; dir=&quot;+dir+&quot; name=&quot;+name);</span>

<span class="nc" id="L1042">			String sql = &quot;INSERT INTO gallery (image_path,image_name,s_description_sk,l_description_sk,s_description_en,l_description_en,s_description_cz,l_description_cz,s_description_de,l_description_de,&quot;+</span>
				&quot;s_description_pl,l_description_pl,s_description_hu,l_description_hu,s_description_ru,l_description_ru,s_description_esp,l_description_esp,s_description_cho,l_description_cho,author,allowed_domains, perex_group, upload_datetime,sort_priority, domain_id)&quot;+
				&quot; VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;;

<span class="nc bnc" id="L1046" title="All 2 branches missed.">			if (iID &gt; 0)</span>
			{
<span class="nc" id="L1048">				Logger.debug(GalleryDB.class, &quot;UPDATE&quot;);</span>
<span class="nc" id="L1049">				sql = &quot;UPDATE gallery SET image_path=?,image_name=?,s_description_sk=?,l_description_sk=?,s_description_en=?,l_description_en=?,s_description_cz=?,l_description_cz=?,s_description_de=?,l_description_de=?,&quot;</span>
<span class="nc" id="L1050">					+&quot;s_description_pl=?,l_description_pl=?,s_description_hu=?,l_description_hu=?,s_description_ru=?,l_description_ru=?,s_description_esp=?,l_description_esp=?,s_description_cho=?,l_description_cho=?,author=?,allowed_domains=?,perex_group=?, upload_datetime = ?, sort_priority=?, domain_id=? WHERE image_id=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
			}

<span class="nc" id="L1053">			db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="nc" id="L1054">			ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L1055">			int parameterIndex = 1;</span>
<span class="nc" id="L1056">			ps.setString(parameterIndex++, dir);</span>
<span class="nc" id="L1057">			ps.setString(parameterIndex++, name);</span>
<span class="nc" id="L1058">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_sk&quot;)));</span>
<span class="nc" id="L1059">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_sk&quot;)));</span>
<span class="nc" id="L1060">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_en&quot;)));</span>
<span class="nc" id="L1061">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_en&quot;)));</span>
<span class="nc" id="L1062">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_cz&quot;)));</span>
<span class="nc" id="L1063">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_cz&quot;)));</span>
<span class="nc" id="L1064">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_de&quot;)));</span>
<span class="nc" id="L1065">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_de&quot;)));</span>
<span class="nc" id="L1066">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_pl&quot;)));</span>
<span class="nc" id="L1067">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_pl&quot;)));</span>
<span class="nc" id="L1068">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_hu&quot;)));</span>
<span class="nc" id="L1069">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_hu&quot;)));</span>
<span class="nc" id="L1070">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_ru&quot;)));</span>
<span class="nc" id="L1071">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_ru&quot;)));</span>
<span class="nc" id="L1072">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_esp&quot;)));</span>
<span class="nc" id="L1073">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_esp&quot;)));</span>
<span class="nc" id="L1074">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_cho&quot;)));</span>
<span class="nc" id="L1075">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_cho&quot;)));</span>
<span class="nc" id="L1076">			ps.setString(parameterIndex++, request.getParameter(&quot;author&quot;));</span>
<span class="nc" id="L1077">			ps.setString(parameterIndex++, request.getParameter(&quot;allowed_domains&quot;));</span>
<span class="nc" id="L1078">			ps.setString(parameterIndex++, convertPerexGroupString(request.getParameterValues(&quot;perexGroup&quot;)));</span>

			// formatovanie datumov do stringu kvoli rozdeleniu casu a datumu na dve polozky
<span class="nc" id="L1081">	      String requestDate = Tools.getStringValue(request.getParameter(&quot;uploadDate&quot;), &quot;01.01.2000&quot;);</span>
<span class="nc" id="L1082">	      String requestTime = Tools.getStringValue(request.getParameter(&quot;uploadTime&quot;), &quot;00:00:00&quot;);</span>

<span class="nc" id="L1084">			ps.setTimestamp(parameterIndex++, new Timestamp(DB.getTimestamp(requestDate, requestTime)));</span>

<span class="nc" id="L1086">			int priority = 0;</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">			if(Tools.getIntValue(request.getParameter(&quot;sort_priority&quot;), 0) == 0)</span>
<span class="nc" id="L1088">				priority = getNewPriority(dir);</span>
			else
<span class="nc" id="L1090">				priority = Tools.getIntValue(request.getParameter(&quot;sort_priority&quot;),Integer.MAX_VALUE);</span>
<span class="nc" id="L1091">			ps.setInt(parameterIndex++,priority);</span>

<span class="nc" id="L1093">			ps.setInt(parameterIndex++, CloudToolsForCore.getDomainId());</span>

<span class="nc bnc" id="L1095" title="All 2 branches missed.">			if (iID &gt; 0)</span>
<span class="nc" id="L1096">				ps.setInt(parameterIndex++, iID);</span>

<span class="nc" id="L1098">			ps.execute();</span>
<span class="nc" id="L1099">			ps.close();</span>
<span class="nc bnc" id="L1100" title="All 2 branches missed.">			if (iID &lt;= 0)</span>
			{
				// ziskaj ID z databazy
<span class="nc" id="L1103">				ps = db_conn.prepareStatement(&quot;SELECT image_id FROM gallery WHERE image_path = ? AND image_name = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L1104">				ps.setString(1, dir);</span>
<span class="nc" id="L1105">				ps.setString(2, name);</span>
<span class="nc" id="L1106">				rs = ps.executeQuery();</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">				if (rs.next())</span>
				{
<span class="nc" id="L1109">					iID = rs.getInt(&quot;image_id&quot;);</span>
				}
<span class="nc" id="L1111">				rs.close();</span>
<span class="nc" id="L1112">				ps.close();</span>
			}

			//kvoli bugu s oblastou zaujmu nam vznikali duplicity, zmaz
<span class="nc" id="L1116">			ps = db_conn.prepareStatement(&quot;DELETE FROM gallery WHERE image_path = ? AND image_name = ? AND image_id != ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L1117">			ps.setString(1, dir);</span>
<span class="nc" id="L1118">			ps.setString(2, name);</span>
<span class="nc" id="L1119">			ps.setInt(3, iID);</span>
<span class="nc" id="L1120">			ps.execute();</span>
<span class="nc" id="L1121">			ps.close();</span>
<span class="nc" id="L1122">			db_conn.close();</span>
<span class="nc" id="L1123">			db_conn = null;</span>
<span class="nc" id="L1124">			rs = null;</span>
<span class="nc" id="L1125">			ps = null;</span>
		}
<span class="nc" id="L1127">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L1130" title="All 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="nc bnc" id="L1131" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L1132" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L1133">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="nc" id="L1135">		return iID;</span>
	}


	/**
	 * Metoda vypocita prioritu zobrazenia obrazku pre dany adresar.
	 * @param dir
	 * @return
	 */
	public static int getNewPriority(String dir)
	{
<span class="fc" id="L1146">		return getTotalImagesInDir(dir) * 10 +10;</span>
	}

	/**
	 * Metoda vypocita pre obrazok tak ze najde
	 * najvyssiu hodnotu pola sortPriority  v danom adresari
	 * a pripocita 10
	 * @param dir
	 * @return
	 */
	public static int getUpdatePriority(String dir)
	{
<span class="nc" id="L1158">		return getMaxPriority(dir) +10;</span>
	}

	/**
	 * Vrati najvyssiu hodnotu priority pre dany directory
	 * @param dir
	 * @return
	 */
	private static int getMaxPriority(String dir)
	{
<span class="nc" id="L1168">		int result = DB.queryForInt(&quot;Select max(sort_priority) from gallery where image_path = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), dir);</span>
<span class="nc" id="L1169">		return result;</span>
	}

	/**
	 * Uvodne ulozenie obrazku do tabulky gallery, vytvori sa novy zaznam pre obrazok s aktualnym datumom uploadu. &lt;br /&gt;
	 * Ak uz taky obrazok existuje, ale nema nastaveny datum uploadu, tak sa mu nastavi datum poslednej modifikacie suboru (Spatne to zistit nevieme). &lt;br /&gt;
	 *
	 *
	 * @param 	dir	Nazov virtualneho adresara, v ktorom je obrazok ulozeny napr. /images/gallery
	 * @param 	name	Nazov obrazka s priponou napr. obrazok.jpg
	 *
	 * @return	Vrati identifikator obrazka, ktory bol prave ulozeny do tabulky. Ak uz taky obrazok existuje, vrati jeho id. Ak nastal nejaky problem s DB, vrati -1.
	 */
	public static int setImage(String dir, String name)
	{
<span class="fc" id="L1184">		IwcmFile imageFile = new IwcmFile(dir + File.separator + name);</span>

<span class="fc" id="L1186">		SimpleQuery query = new SimpleQuery();</span>
<span class="fc" id="L1187">		int imageId = 0;</span>

		try
		{
<span class="fc" id="L1191">			imageId = query.forInt(&quot;SELECT image_id FROM gallery WHERE image_path = ? AND image_name = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), dir, name);</span>
<span class="fc bfc" id="L1192" title="All 2 branches covered.">			if (GalleryDB.getUploadDateImage(dir, name) == null)</span>
<span class="fc" id="L1193">				GalleryDB.setUploadDateImage(dir, name, imageFile.lastModified());</span>

		}
<span class="nc" id="L1196">		catch (Exception e)</span>
		{
<span class="nc bnc" id="L1198" title="All 2 branches missed.">			if (imageId &gt; 0)</span>
<span class="nc" id="L1199">				return imageId;</span>
<span class="fc" id="L1200">		}</span>
<span class="fc bfc" id="L1201" title="All 2 branches covered.">		if (imageId &gt; 0)</span>
<span class="fc" id="L1202">			return imageId;</span>


<span class="fc" id="L1205">		int priority = getNewPriority(dir);</span>

<span class="fc" id="L1207">		query.execute(&quot;INSERT INTO gallery (image_path, image_name, upload_datetime, sort_priority, domain_id) VALUES(?, ?, ?, ?, ?)&quot;, dir, name, new Timestamp(Tools.getNow()),priority, CloudToolsForCore.getDomainId());</span>
		try
		{
<span class="fc" id="L1210">			return query.forInt(&quot;SELECT image_id FROM gallery WHERE image_path = ? AND image_name = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), dir, name);</span>
		}
<span class="nc" id="L1212">		catch (Exception e)</span>
		{
<span class="nc" id="L1214">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L1215">			return -1;</span>
		}
	}

	/**
	 * Ulozi do tabulky gallery_dimension novy zaznam pre galeriu.
	 *
	 * @param 	dir	Nazov virtualneho adresara, v ktorom bude galeria ulozena napr. /images/gallery/new
	 * @author kmarton
	 *
	 * @return	Vrati identifikator galerie, ktora bola prave ulozena do tabulky. Ak uz taka galeria existuje, vrati jeho id. Ak nastal nejaky problem s DB, vrati -1.
	 */
	public static int setGallery(String dir)
	{
<span class="nc" id="L1229">		SimpleQuery query = new SimpleQuery();</span>
<span class="nc" id="L1230">		int galleryId = 0;</span>

		try
		{
<span class="nc" id="L1234">			galleryId = query.forInt(&quot;SELECT dimension_id FROM gallery_dimension WHERE image_path= ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), dir);</span>
		}
<span class="nc" id="L1236">		catch (Exception e)</span>
		{
			//
<span class="nc" id="L1239">		}</span>
<span class="nc bnc" id="L1240" title="All 2 branches missed.">		if (galleryId &gt; 0)</span>
<span class="nc" id="L1241">			return galleryId;</span>

<span class="nc" id="L1243">		Dimension[] dims = getDimension(dir);</span>

<span class="nc" id="L1245">		query.execute(&quot;INSERT INTO gallery_dimension (image_path, image_width, image_height, normal_width, normal_height, resize_mode, create_date, domain_id) VALUES(?, ?, ?, ?, ?, ?, ?, ?)&quot;,</span>
<span class="nc" id="L1246">					dir,dims[0].width, dims[0].height, dims[1].width, dims[1].height, GalleryDB.getResizeMode(dir, true), new Timestamp(Tools.getNow()), CloudToolsForCore.getDomainId());</span>
		try
		{
<span class="nc" id="L1249">			return query.forInt(&quot;SELECT dimension_id FROM gallery_dimension WHERE image_path= ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), dir);</span>
		}
<span class="nc" id="L1251">		catch (Exception e)</span>
		{
<span class="nc" id="L1253">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L1254">			return -1;</span>
		}
	}

	/**
	 * Vrati identifikator obrazka z tabulky gallery podla jeho virtualnej cesty a mena
	 *
	 * @param 	dir	Nazov virtualneho adresara, v ktorom je obrazok ulozeny napr. /images/gallery
	 * @param 	name	Nazov obrazka s priponou napr. obrazok.jpg
	 *
	 * @return	Vrati identifikator obrazka podla jeho cesty a mena. Ak nastal nejaky problem pri spojeni s DB, prip. taky obrazok neexistuje, vrati -1
	 */
	public static int getImageId(String dir, String name)
	{
		try
		{
<span class="nc" id="L1270">			return new SimpleQuery().forInt(&quot;SELECT image_id FROM gallery WHERE image_path= ? AND image_name= ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), dir, name);</span>
		}
<span class="nc" id="L1272">		catch (Exception e)</span>
		{
<span class="nc" id="L1274">			return -1;</span>
		}
	}

	/**
	 * Description of the Method
	 *
	 *@param dir
	 *           Description of the Parameter
	 *@param name
	 *           Description of the Parameter
	 *@param request
	 *           Description of the Parameter
	 *@param imageId
	 *           Description of the Parameter
	 *@param servletContext
	 *           Description of the Parameter
	 */
	public static void removeImage(String imageId, String dir, String name, ServletContext servletContext,
				HttpServletRequest request)
	{
<span class="nc" id="L1295">		int iID = Tools.getIntValue(imageId, -1);</span>
<span class="nc" id="L1296">		removeImage(iID, dir, name, servletContext, request);</span>
<span class="nc" id="L1297">	}</span>

	/**
	 * Description of the Method
	 *
	 *@param imageId
	 *           Description of the Parameter
	 *@param dir
	 *           Description of the Parameter
	 *@param name
	 *           Description of the Parameter
	 *@param request
	 *           Description of the Parameter
	 *@param servletContext
	 *           Description of the Parameter
	 */
	public static void removeImage(int imageId, String dir, String name, ServletContext servletContext, HttpServletRequest request)
	{
<span class="nc" id="L1315">		java.sql.Connection db_conn = null;</span>
<span class="nc" id="L1316">		java.sql.PreparedStatement ps = null;</span>
<span class="nc" id="L1317">		IwcmFile file = null;</span>
<span class="nc" id="L1318">		String sql = &quot;DELETE FROM gallery WHERE image_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>

<span class="nc bnc" id="L1320" title="All 2 branches missed.">		if (dir.startsWith(&quot;/&quot;)==false) dir = &quot;/&quot;+dir;</span>
<span class="nc bnc" id="L1321" title="All 2 branches missed.">		if (name.startsWith(&quot;/&quot;)) name = name.substring(1);</span>

<span class="nc bnc" id="L1323" title="All 2 branches missed.">		if (imageId &lt; 1) imageId = getImageId(dir, name);</span>

<span class="nc" id="L1325">		String path = Tools.getRealPath(dir);</span>
		try
		{
<span class="nc bnc" id="L1328" title="All 2 branches missed.">			if (imageId &gt; 0)</span>
			{
<span class="nc" id="L1330">				db_conn = DBPool.getConnection();</span>
<span class="nc" id="L1331">				ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L1332">				ps.setInt(1, imageId);</span>
<span class="nc" id="L1333">				ps.execute();</span>
<span class="nc" id="L1334">				ps.close();</span>
<span class="nc" id="L1335">				db_conn.close();</span>
<span class="nc" id="L1336">				ps = null;</span>
<span class="nc" id="L1337">				db_conn = null;</span>
			}
<span class="nc" id="L1339">			file = new IwcmFile(path + File.separator + name);</span>
<span class="nc bnc" id="L1340" title="All 2 branches missed.">			if (file.exists())</span>
			{
<span class="nc" id="L1342">				boolean ok = file.delete();</span>
<span class="nc" id="L1343">				Logger.debug(GalleryDB.class, &quot;Deleting file=&quot;+file.getAbsolutePath()+&quot; ok=&quot;+ok);</span>
			}
<span class="nc" id="L1345">			file = new IwcmFile(path + File.separator + &quot;s_&quot; + name);</span>
<span class="nc bnc" id="L1346" title="All 2 branches missed.">			if (file.exists())</span>
			{
<span class="nc" id="L1348">				boolean ok = file.delete();</span>
<span class="nc" id="L1349">				Logger.debug(GalleryDB.class, &quot;Deleting file=&quot;+file.getAbsolutePath()+&quot; ok=&quot;+ok);</span>
			}
<span class="nc" id="L1351">			file = new IwcmFile(path + File.separator + &quot;o_&quot; + name);</span>
<span class="nc bnc" id="L1352" title="All 2 branches missed.">			if (file.exists())</span>
			{
<span class="nc" id="L1354">				boolean ok = file.delete();</span>
<span class="nc" id="L1355">				Logger.debug(GalleryDB.class, &quot;Deleting file=&quot;+file.getAbsolutePath()+&quot; ok=&quot;+ok);</span>
			}
		}
<span class="nc" id="L1358">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L1361" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L1362" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L1363">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="nc" id="L1365">	}</span>

	/**
	 * ziska info o obrazku z databazy
	 *
	 * @param src
	 * @param request
	 * @return
	 */
	public static GalleryBean getGalleryBean(String src, HttpServletRequest request)
	{
<span class="fc" id="L1376">		return (getGalleryBean(src, request, null));</span>
	}

	/**
	 * Ziska info o obrazku z databazy podla jazykovej mutacie
	 *
	 * @param src
	 * @param request
	 * @param lng
	 * @return
	 */
	public static GalleryBean getGalleryBean(String src, HttpServletRequest request, String lng)
	{
<span class="fc" id="L1389">		String dir = &quot;/&quot;;</span>
<span class="fc" id="L1390">		String name = src;</span>
<span class="fc" id="L1391">		int i = src.lastIndexOf('/');</span>
<span class="pc bpc" id="L1392" title="1 of 2 branches missed.">		if (i &gt; 0)</span>
		{
<span class="fc" id="L1394">			dir = src.substring(0, i);</span>
<span class="fc" id="L1395">			name = src.substring(i + 1, src.length()).trim();</span>
		}
<span class="fc" id="L1397">		return (getGalleryBean(dir, name, request, lng));</span>
	}

	/**
	 * Ziska info o obrazku z databazy
	 *
	 *@param dir
	 *           Description of the Parameter
	 *@param name
	 *           Description of the Parameter
	 *@param request
	 *           Description of the Parameter
	 *@return The l_S_Description value
	 */
	public static GalleryBean getGalleryBean(String dir, String name, HttpServletRequest request)
	{
<span class="nc" id="L1413">		return (getGalleryBean(dir, name, request, null));</span>
	}

	/**
	 * Ziska info o obrazku z databazy pre danu jazykovu mutaciu
	 *
	 * @param dir
	 * @param name
	 * @param request
	 * @param lng
	 * @return
	 */
	public static GalleryBean getGalleryBean(String dir, String name, HttpServletRequest request, String lng)
	{
<span class="fc" id="L1427">		java.sql.Connection db_conn = null;</span>
<span class="fc" id="L1428">		java.sql.PreparedStatement ps = null;</span>
<span class="fc" id="L1429">		java.sql.ResultSet rs = null;</span>
		//order je tu kvoli bugu z duplicitou obrazkov
<span class="fc" id="L1431">		String sql = &quot;SELECT * FROM gallery WHERE image_path=? AND image_name=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true)+&quot; ORDER BY image_id ASC&quot;;</span>
<span class="fc" id="L1432">		boolean cyclicViewing = true;</span>
<span class="fc" id="L1433">		GalleryBean gBean = null;</span>
		IwcmFile file;
		try
		{
<span class="pc bpc" id="L1437" title="1 of 2 branches missed.">			if (&quot;false&quot;.equals(request.getParameter(&quot;cyclicViewing&quot;)))</span>
			{
<span class="nc" id="L1439">				cyclicViewing = false;</span>
			}
<span class="pc bpc" id="L1441" title="2 of 4 branches missed.">			if (!dir.equals(&quot;&quot;) &amp;&amp; !name.equals(&quot;&quot;))</span>
			{
<span class="pc bpc" id="L1443" title="1 of 2 branches missed.">				if (dir.startsWith(&quot;/&quot;)==false) dir = &quot;/&quot;+dir;</span>

<span class="fc" id="L1445">				gBean = new GalleryBean();</span>
<span class="pc bpc" id="L1446" title="1 of 2 branches missed.">				if (name.startsWith(&quot;s_&quot;))</span>
				{
<span class="nc" id="L1448">					name = name.substring(2, name.length());</span>
				}

<span class="fc" id="L1451">				request.setAttribute(&quot;imageURL&quot;, dir + &quot;/&quot; + name);</span>

<span class="fc bfc" id="L1453" title="All 2 branches covered.">				if (name.startsWith(&quot;o_&quot;))</span>
				{
					//toto mame kvoli najdeniu dat, ktore su pre normal image, ak ale clovek chcel o_ obrazok je nastavenie imageURL pred tymto blokom naschval
<span class="fc" id="L1456">					name = name.substring(2, name.length());</span>
				}

				// testni ci existuje originalImage
<span class="pc bpc" id="L1460" title="1 of 2 branches missed.">				if (Constants.getBoolean(&quot;galleryUseFastLoading&quot;))</span>
				{
					//kvoli pluske prepnute na lazy testovanie o_ obrazku
<span class="nc" id="L1463">					gBean.setOriginalImage(null);</span>
				}
				else
				{
					try
					{
<span class="fc" id="L1469">						String originalImage = dir + &quot;/o_&quot; + name;</span>
<span class="fc" id="L1470">						file = new IwcmFile(Tools.getRealPath(originalImage));</span>
<span class="pc bpc" id="L1471" title="2 of 4 branches missed.">						if (file.exists() &amp;&amp; isImageFast(file))</span>
						{
<span class="fc" id="L1473">							gBean.setOriginalImage(originalImage);</span>
						}
					}
<span class="nc" id="L1476">					catch (Exception ex)</span>
					{
<span class="fc" id="L1478">					}</span>
				}

<span class="fc" id="L1481">				gBean.setImagePath(dir);</span>
<span class="fc" id="L1482">				gBean.setImageName(name);</span>

<span class="fc" id="L1484">				String lngAdd = getLngAdd(lng, request);</span>
<span class="fc" id="L1485">				db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="fc" id="L1486">				ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L1487">				ps.setString(1, dir);</span>
<span class="fc" id="L1488">				ps.setString(2, name);</span>
<span class="fc" id="L1489">				rs = ps.executeQuery();</span>
<span class="pc bpc" id="L1490" title="1 of 2 branches missed.">				if (rs.next())</span>
				{
<span class="fc" id="L1492">					gBean.setImageId(rs.getInt(&quot;image_id&quot;));</span>
<span class="fc" id="L1493">					gBean.setImageName(DB.getDbString(rs, &quot;image_name&quot;));</span>
<span class="fc" id="L1494">					gBean.setImagePath(DB.getDbString(rs, &quot;image_path&quot;));</span>
<span class="fc" id="L1495">					gBean.setLongDescription(DB.getDbString(rs, &quot;l_description&quot; + lngAdd));</span>
<span class="fc" id="L1496">					gBean.setShortDescription(DB.getDbString(rs, &quot;s_description&quot; + lngAdd));</span>
<span class="fc" id="L1497">					gBean.setAuthor(DB.getDbString(rs, &quot;author&quot;));</span>
<span class="fc" id="L1498">					gBean.setSendCount(rs.getInt(&quot;send_count&quot;));</span>
<span class="fc" id="L1499">					gBean.setAllowedDomains(DB.getDbString(rs, &quot;allowed_domains&quot;));</span>
<span class="fc" id="L1500">					gBean.setPerexGroup(convertPerexGroupString(DB.getDbString(rs, &quot;perex_group&quot;)));</span>
<span class="fc" id="L1501">					gBean.setSelectedX(rs.getInt(&quot;selected_x&quot;));</span>
<span class="fc" id="L1502">					gBean.setSelectedY(rs.getInt(&quot;selected_y&quot;));</span>
<span class="fc" id="L1503">					gBean.setSelectedWidth(rs.getInt(&quot;selected_width&quot;));</span>
<span class="fc" id="L1504">					gBean.setSelectedHeight(rs.getInt(&quot;selected_height&quot;));</span>
<span class="fc" id="L1505">					gBean.setUploadDate(rs.getTimestamp(&quot;upload_datetime&quot;));</span>
<span class="fc" id="L1506">					gBean.setSortPriority(rs.getInt(&quot;sort_priority&quot;));</span>
				}
<span class="fc" id="L1508">				rs.close();</span>
<span class="fc" id="L1509">				ps.close();</span>
<span class="fc" id="L1510">				db_conn.close();</span>
<span class="fc" id="L1511">				rs = null;</span>
<span class="fc" id="L1512">				ps = null;</span>
<span class="fc" id="L1513">				db_conn = null;</span>
			}
<span class="pc bpc" id="L1515" title="1 of 2 branches missed.">			if (gBean != null) gBean.setCyclicViewing(cyclicViewing);</span>
		}
<span class="nc" id="L1517">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="pc bpc" id="L1520" title="1 of 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="pc bpc" id="L1521" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L1522" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L1523">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="fc" id="L1525">		return (gBean);</span>
	}

	public static void fillPrevNextLink(GalleryBean gBean, boolean cyclicViewing)
	{
		try
		{
<span class="nc" id="L1532">			String dir = gBean.getImagePath();</span>
<span class="nc" id="L1533">			String name = gBean.getImageName();</span>
<span class="nc bnc" id="L1534" title="All 4 branches missed.">			if (Tools.isEmpty(dir) &amp;&amp; Tools.isNotEmpty(gBean.getOriginalImage()))</span>
			{
<span class="nc" id="L1536">				dir = gBean.getOriginalImage().substring(0, gBean.getOriginalImage().lastIndexOf(&quot;/&quot;));</span>
<span class="nc" id="L1537">				name = gBean.getOriginalImage().substring(gBean.getOriginalImage().lastIndexOf(&quot;/&quot;)+1);</span>
			}

<span class="nc bnc" id="L1540" title="All 2 branches missed.">			if (Tools.isEmpty(dir)) return;</span>

			// ziskaj linku na predchadzajuci a nasledujuci obrazok
<span class="nc" id="L1543">			String realPath = Tools.getRealPath(dir);</span>
<span class="nc" id="L1544">			IwcmFile file = new IwcmFile(realPath);</span>
<span class="nc" id="L1545">			IwcmFile[] fileList = file.listFiles(new IwcmFileFilter()</span>
<span class="nc" id="L1546">			{</span>
				@Override
				public boolean accept(IwcmFile pathname)
				{
<span class="nc bnc" id="L1550" title="All 2 branches missed.">					return (isImageFast(pathname))</span>
<span class="nc bnc" id="L1551" title="All 2 branches missed.">								&amp;&amp; pathname.getName().startsWith(&quot;s_&quot;);</span>
				}
			});
			try
			{
<span class="nc" id="L1556">				Arrays.sort(fileList, new Comparator&lt;IwcmFile&gt;()</span>
<span class="nc" id="L1557">				{</span>
					@Override
					public int compare(IwcmFile f1, IwcmFile f2)
					{
<span class="nc" id="L1561">						return (f1.getName().compareTo(f2.getName()));</span>
					}
				});
			}
<span class="nc" id="L1565">			catch (Exception ex)</span>
			{
<span class="nc" id="L1567">				sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L1568">			}</span>
<span class="nc bnc" id="L1569" title="All 2 branches missed.">			if (!name.startsWith(&quot;s_&quot;))</span>
			{
<span class="nc" id="L1571">				name = &quot;s_&quot; + name;</span>
			}
<span class="nc" id="L1573">			int i = 0;</span>
<span class="nc" id="L1574">			int end = fileList.length;</span>
<span class="nc bnc" id="L1575" title="All 2 branches missed.">			for (i = 0; i &lt; end; i++)</span>
			{
<span class="nc" id="L1577">				file = fileList[i];</span>
<span class="nc bnc" id="L1578" title="All 2 branches missed.">				if (file.getName().equals(name))</span>
				{
<span class="nc bnc" id="L1580" title="All 2 branches missed.">					if (i &gt; 0)</span>
					{
<span class="nc" id="L1582">						file = fileList[i - 1];</span>
						// meno suboru je s_nieco.jpg
<span class="nc" id="L1584">						gBean.setPrevImage(dir + &quot;/&quot; + file.getName().substring(2));</span>
					}
<span class="nc bnc" id="L1586" title="All 2 branches missed.">					else if (i == 0)</span>
					{
<span class="nc bnc" id="L1588" title="All 4 branches missed.">						if (cyclicViewing &amp;&amp; end &gt; 1)</span>
						{
<span class="nc" id="L1590">							file = fileList[end - 1];</span>
							// meno suboru je s_nieco.jpg
<span class="nc" id="L1592">							gBean.setPrevImage(dir + &quot;/&quot; + file.getName().substring(2));</span>
						}
						else
						{
<span class="nc" id="L1596">							gBean.setPrevImage(null);</span>
						}
					}
<span class="nc bnc" id="L1599" title="All 2 branches missed.">					if (i &lt; (end - 1))</span>
					{
<span class="nc" id="L1601">						file = fileList[i + 1];</span>
<span class="nc" id="L1602">						gBean.setNextImage(dir + &quot;/&quot; + file.getName().substring(2));</span>
					}
					else
					{
<span class="nc bnc" id="L1606" title="All 4 branches missed.">						if (cyclicViewing &amp;&amp; end &gt; 1)</span>
						{
<span class="nc" id="L1608">							file = fileList[0];</span>
<span class="nc" id="L1609">							gBean.setNextImage(dir + &quot;/&quot; + file.getName().substring(2));</span>
						}
						else
						{
<span class="nc" id="L1613">							gBean.setNextImage(null);</span>
						}
					}
<span class="nc" id="L1616">					break;</span>
				}
			}
		}
<span class="nc" id="L1620">		catch (Exception e)</span>
		{
<span class="nc" id="L1622">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L1623">		}</span>
<span class="nc" id="L1624">	}</span>

	/**
	 * Vrati zoznam adresarov v zadanom adresari
	 *
	 *@param dir
	 *           Description of the Parameter
	 *@return The dirs value
	 */
	public static List&lt;FileDirBean&gt; getDirs(String dir)
	{
<span class="nc" id="L1635">		return getDirs(dir, listFiles(dir));</span>
	}
	/**
	 * Vrati zoznam adresarov v zadanom adresari
	 * @param dir
	 * @param fileList
	 * @return
	 */
	public static List&lt;FileDirBean&gt; getDirs(String dir, IwcmFile[] fileList)
	{
<span class="nc" id="L1645">		DebugTimer dt = new DebugTimer(&quot;GalleryDB.getDirs&quot;);</span>

<span class="nc bnc" id="L1647" title="All 4 branches missed.">		if (dir == null || dir.length() == 0)</span>
		{
<span class="nc bnc" id="L1649" title="All 2 branches missed.">			if (Constants.getString(&quot;imagesRootDir&quot;).length() &gt; 1)</span>
			{
<span class="nc" id="L1651">				dir = Constants.getString(&quot;imagesRootDir&quot;) + &quot;/&quot; + Constants.getString(&quot;galleryDirName&quot;);</span>
			}
			else
			{
<span class="nc" id="L1655">				dir = &quot;/&quot;;</span>
			}
		}
<span class="nc" id="L1658">		List&lt;FileDirBean&gt; aList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1659">		FileDirBean fBean = null;</span>
		try
		{
<span class="nc" id="L1662">				fBean = new FileDirBean();</span>
<span class="nc" id="L1663">				int index = dir.lastIndexOf('/');</span>
<span class="nc" id="L1664">				fBean.setName(&quot;..&quot;);</span>
<span class="nc" id="L1665">				fBean.setIcon(&quot;/components/_common/mime/folderback.gif&quot;);</span>
<span class="nc bnc" id="L1666" title="All 2 branches missed.">				if (index &gt; 0)</span>
				{
<span class="nc" id="L1668">					fBean.setPath(dir.substring(0, index));</span>
				}
				else
				{
<span class="nc" id="L1672">					fBean.setPath(&quot;/&quot;);</span>
				}
<span class="nc bnc" id="L1674" title="All 2 branches missed.">				if (dir.length() &gt; 1)</span>
				{
<span class="nc" id="L1676">					aList.add(fBean);</span>
				}

				try
				{
					// usortuj to podla abecedy
<span class="nc" id="L1682">					Arrays.sort(fileList, new Comparator&lt;IwcmFile&gt;()</span>
<span class="nc" id="L1683">					{</span>
						@Override
						public int compare(IwcmFile f1, IwcmFile f2)
						{
<span class="nc" id="L1687">							return (f1.getName().toLowerCase().compareTo(f2.getName().toLowerCase()));</span>
						}
					});
				}
<span class="nc" id="L1691">				catch (Exception ex)</span>
				{
<span class="nc" id="L1693">					sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L1694">				}</span>

<span class="nc" id="L1696">				dt.diff(&quot;after compare&quot;);</span>

				int imgCount;
				String name;
<span class="nc bnc" id="L1700" title="All 2 branches missed.">				for (int i = 0; i &lt; fileList.length; i++)</span>
				{
<span class="nc bnc" id="L1702" title="All 2 branches missed.">					if (isDirectoryFast(fileList[i]))</span>
					{
<span class="nc" id="L1704">						fBean = new FileDirBean();</span>
						// ziskaj pocet obrazkov v danom adresari
<span class="nc bnc" id="L1706" title="All 2 branches missed.">						if (Constants.getBoolean(&quot;galleryUseFastLoading&quot;)) imgCount = 0;</span>
<span class="nc" id="L1707">						else imgCount = getTotalImagesInDir(dir + &quot;/&quot; + fileList[i].getName());</span>

<span class="nc bnc" id="L1709" title="All 2 branches missed.">						if (imgCount &gt; 0)</span>
						{
<span class="nc" id="L1711">							fBean.setImagesInDir(Integer.toString(imgCount));</span>
						}

<span class="nc" id="L1714">						fBean.setName(fileList[i].getName());</span>
<span class="nc" id="L1715">						fBean.setIcon(&quot;/components/_common/mime/folder.gif&quot;);</span>
<span class="nc" id="L1716">						fBean.setPath(dir + &quot;/&quot; + fileList[i].getName());</span>

<span class="nc" id="L1718">						name = fBean.getPath() + &quot;/&quot;;</span>

<span class="nc bnc" id="L1720" title="All 6 branches missed.">						if (name.startsWith(&quot;/WEB-INF/&quot;) || name.startsWith(&quot;/admin/&quot;) || name.startsWith(&quot;/templates/&quot;)</span>
<span class="nc bnc" id="L1721" title="All 6 branches missed.">									|| name.startsWith(&quot;/components/&quot;) || name.startsWith(&quot;/css/&quot;) || name.startsWith(&quot;/jscripts/&quot;)</span>
<span class="nc bnc" id="L1722" title="All 6 branches missed.">									|| name.startsWith(&quot;/CVS/&quot;) || name.startsWith(&quot;/META-INF/&quot;) || name.indexOf(&quot;.svn&quot;) != -1)</span>
						{
							// Logger.println(GalleryDB.class,&quot;som web inf&quot;);
<span class="nc" id="L1725">							continue;</span>
						}
<span class="nc" id="L1727">						aList.add(fBean);</span>
					}
				}

<span class="nc" id="L1731">				dt.diff(&quot;after total images&quot;);</span>
		}
<span class="nc" id="L1733">		catch (Exception ex)</span>
		{
<span class="nc" id="L1735">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L1736">		}</span>
<span class="nc" id="L1737">		return aList;</span>
	}

	/**
	 * Description of the Method
	 *
	 *@param request
	 *           Description of the Parameter
	 *@param servletContext
	 *           Description of the Parameter
	 */
	public static void changeDimension(ServletContext servletContext, HttpServletRequest request, PrintWriter out, Prop prop)
	{
<span class="nc" id="L1750">		Dimension dim = new Dimension();</span>
<span class="nc" id="L1751">		Dimension normalDim = new Dimension();</span>
<span class="nc" id="L1752">		String dir = request.getParameter(&quot;dir&quot;);</span>
		try
		{
			try
			{
<span class="nc" id="L1757">				dim.width = Integer.parseInt(request.getParameter(&quot;imageWidth&quot;));</span>
			}
<span class="nc" id="L1759">			catch (Exception ex)</span>
			{
<span class="nc" id="L1761">				dim.width = 160;</span>
<span class="nc" id="L1762">			}</span>
			try
			{
<span class="nc" id="L1765">				dim.height = Integer.parseInt(request.getParameter(&quot;imageHeight&quot;));</span>
			}
<span class="nc" id="L1767">			catch (Exception ex)</span>
			{
<span class="nc" id="L1769">				dim.height = 120;</span>
<span class="nc" id="L1770">			}</span>
			try
			{
<span class="nc" id="L1773">				normalDim.width = Integer.parseInt(request.getParameter(&quot;imageWidthNormal&quot;));</span>
			}
<span class="nc" id="L1775">			catch (Exception ex)</span>
			{
<span class="nc" id="L1777">				normalDim.width = 0;</span>
<span class="nc" id="L1778">			}</span>
			try
			{
<span class="nc" id="L1781">				normalDim.height = Integer.parseInt(request.getParameter(&quot;imageHeightNormal&quot;));</span>
			}
<span class="nc" id="L1783">			catch (Exception ex)</span>
			{
<span class="nc" id="L1785">				normalDim.height = 0;</span>
<span class="nc" id="L1786">			}</span>
<span class="nc" id="L1787">			changeDimension(servletContext, dir, dim, normalDim, request, out, prop);</span>
		}
<span class="nc" id="L1789">		catch (NumberFormatException nfe)</span>
		{
<span class="nc" id="L1791">			sk.iway.iwcm.Logger.error(nfe);</span>
<span class="nc" id="L1792">		}</span>
<span class="nc" id="L1793">	}</span>

	/**
	 * Description of the Method
	 *
	 *@param request
	 *           Description of the Parameter
	 *@param servletContext
	 *           Description of the Parameter
	 */
	public static void changeDimension(ServletContext servletContext, String dir, HttpServletRequest request, PrintWriter out,
				Prop prop)
	{
<span class="nc" id="L1806">		Dimension dim = new Dimension();</span>
<span class="nc" id="L1807">		Dimension normalDim = new Dimension();</span>
		try
		{
			try
			{
<span class="nc" id="L1812">				dim.width = Integer.parseInt(request.getParameter(&quot;imageWidth&quot;));</span>
			}
<span class="nc" id="L1814">			catch (Exception ex)</span>
			{
<span class="nc" id="L1816">				dim.width = 160;</span>
<span class="nc" id="L1817">			}</span>
			try
			{
<span class="nc" id="L1820">				dim.height = Integer.parseInt(request.getParameter(&quot;imageHeight&quot;));</span>
			}
<span class="nc" id="L1822">			catch (Exception ex)</span>
			{
<span class="nc" id="L1824">				dim.height = 120;</span>
<span class="nc" id="L1825">			}</span>
			try
			{
<span class="nc" id="L1828">				normalDim.width = Integer.parseInt(request.getParameter(&quot;imageWidthNormal&quot;));</span>
			}
<span class="nc" id="L1830">			catch (Exception ex)</span>
			{
<span class="nc" id="L1832">				normalDim.width = 0;</span>
<span class="nc" id="L1833">			}</span>
			try
			{
<span class="nc" id="L1836">				normalDim.height = Integer.parseInt(request.getParameter(&quot;imageHeightNormal&quot;));</span>
			}
<span class="nc" id="L1838">			catch (Exception ex)</span>
			{
<span class="nc" id="L1840">				normalDim.height = 0;</span>
<span class="nc" id="L1841">			}</span>
<span class="nc" id="L1842">			changeDimension(servletContext, dir, dim, normalDim, request, out, prop);</span>
		}
<span class="nc" id="L1844">		catch (NumberFormatException nfe)</span>
		{
<span class="nc" id="L1846">			sk.iway.iwcm.Logger.error(nfe);</span>
<span class="nc" id="L1847">		}</span>
<span class="nc" id="L1848">	}</span>

	public static void changeDimension(ServletContext servletContext, String dir, Dimension dim, Dimension dimNormal,
				HttpServletRequest request)
	{
<span class="nc" id="L1853">		changeDimension(servletContext, dir, dim, dimNormal, request, null, null);</span>
<span class="nc" id="L1854">	}</span>

	public static void println(PrintWriter out, String message)
	{
<span class="nc" id="L1858">		out.println(message + &quot;&lt;br&gt;&quot;);</span>
<span class="nc" id="L1859">		out.flush();</span>
<span class="nc" id="L1860">	}</span>

	public static void printlnError(PrintWriter out, String message)
	{
<span class="nc" id="L1864">		out.println(&quot;&lt;font color='red'&gt;&quot; + message + &quot;&lt;/font&gt;&lt;br&gt;&quot;);</span>
<span class="nc" id="L1865">		out.flush();</span>
<span class="nc" id="L1866">	}</span>

	/**
	 * Description of the Method
	 *
	 *@param dir
	 *           Description of the Parameter
	 *@param dim
	 *           Description of the Parameter
	 *@param request
	 *           Description of the Parameter
	 *@param servletContext
	 *           Description of the Parameter
	 *@param dimNormal
	 *           Description of the Parameter
	 */
	public static void changeDimension(ServletContext servletContext, String dir, Dimension dim, Dimension dimNormal,
				HttpServletRequest request, PrintWriter out, Prop prop)
	{
<span class="nc" id="L1885">		java.sql.Connection db_conn = null;</span>
<span class="nc" id="L1886">		java.sql.PreparedStatement ps = null;</span>

		//oprava 9.8.2012, povodny stav:
		//Date createDate = new Date(DB.getTimestamp(request.getParameter(&quot;createdDate&quot;), request.getParameter(&quot;time&quot;)));
		Date createDate;

<span class="nc" id="L1892">		String resizeMode = &quot;&quot;;</span>
<span class="nc" id="L1893">		String galleryName = &quot;&quot;;</span>
<span class="nc" id="L1894">		String galleryPerex = &quot;&quot;;</span>
<span class="nc" id="L1895">		String author = &quot;&quot;;</span>
<span class="nc bnc" id="L1896" title="All 2 branches missed.">		if (request != null)</span>
		{
<span class="nc" id="L1898">			resizeMode = request.getParameter(&quot;resizeMode&quot;);</span>
<span class="nc" id="L1899">			galleryName = request.getParameter(&quot;galleryName&quot;);</span>
<span class="nc" id="L1900">			galleryPerex = request.getParameter(&quot;galleryPerex&quot;);</span>
<span class="nc" id="L1901">			author = request.getParameter(&quot;author&quot;);</span>
			//novy stav
<span class="nc" id="L1903">			createDate = new Date(DB.getTimestamp(request.getParameter(&quot;createdDate&quot;), request.getParameter(&quot;time&quot;)));</span>
		}
		else
			//novy stav
<span class="nc" id="L1907">			createDate = Calendar.getInstance().getTime();</span>
		try
		{
<span class="nc bnc" id="L1910" title="All 2 branches missed.">			if (!dir.equals(&quot;&quot;))</span>
			{
<span class="nc" id="L1912">				db_conn = DBPool.getConnection();</span>
<span class="nc" id="L1913">				ps = db_conn.prepareStatement(&quot;DELETE FROM gallery_dimension WHERE image_path=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L1914">				ps.setString(1, normalizeDir(dir));</span>
<span class="nc" id="L1915">				ps.execute();</span>
<span class="nc" id="L1916">				ps.close();</span>
<span class="nc" id="L1917">				ps = db_conn</span>
<span class="nc" id="L1918">					.prepareStatement(&quot;INSERT INTO gallery_dimension (image_width, image_height, image_path, normal_width, normal_height, resize_mode,&quot; +</span>
							&quot;gallery_name, gallery_perex, create_date, author, watermark, watermark_saturation, watermark_placement, domain_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;);
<span class="nc" id="L1920">				ps.setInt(1, dim.width);</span>
<span class="nc" id="L1921">				ps.setInt(2, dim.height);</span>
<span class="nc" id="L1922">				ps.setString(3, normalizeDir(dir));</span>
<span class="nc" id="L1923">				ps.setInt(4, dimNormal.width);</span>
<span class="nc" id="L1924">				ps.setInt(5, dimNormal.height);</span>
<span class="nc" id="L1925">				ps.setString(6, resizeMode);</span>
<span class="nc" id="L1926">				ps.setString(7, galleryName);</span>
<span class="nc" id="L1927">				ps.setString(8, galleryPerex);</span>
<span class="nc" id="L1928">				ps.setTimestamp(9, new Timestamp(createDate.getTime()));</span>
<span class="nc" id="L1929">				ps.setString(10, author);</span>
<span class="nc bnc" id="L1930" title="All 2 branches missed.">				if (request != null)</span>
				{
<span class="nc" id="L1932">					ps.setString(11, StringUtils.abbreviate(request.getParameter(&quot;watermark&quot;), 255));</span>
<span class="nc" id="L1933">					ps.setInt(12, Tools.getIntValue(request.getParameter(&quot;watermarkSaturation&quot;), 0));</span>
<span class="nc" id="L1934">					ps.setString(13, request.getParameter(&quot;watermarkPlacement&quot;));</span>
				}
				else
				{
<span class="nc" id="L1938">					ps.setString(11, &quot;&quot;);</span>
<span class="nc" id="L1939">					ps.setInt(12, 0);</span>
<span class="nc" id="L1940">					ps.setString(13, &quot;&quot;);</span>
				}
<span class="nc" id="L1942">				ps.setInt(14, CloudToolsForCore.getDomainId());</span>
<span class="nc" id="L1943">				ps.execute();</span>
<span class="nc" id="L1944">				ps.close();</span>
<span class="nc" id="L1945">				db_conn.close();</span>
<span class="nc" id="L1946">				db_conn = null;</span>
<span class="nc" id="L1947">				ps = null;</span>
			}

<span class="nc bnc" id="L1950" title="All 4 branches missed.">			if(request == null || request.getAttribute(&quot;notGenerateAgain&quot;) == null) // ak sa nieco zmenilo v dimenziach, pregeneruj gallery opat</span>
			{
<span class="nc" id="L1952">				boolean recursive = true;</span>
<span class="nc bnc" id="L1953" title="All 2 branches missed.">				if (request != null) recursive = &quot;true&quot;.equals(request.getParameter(&quot;recursive&quot;));</span>
<span class="nc bnc" id="L1954" title="All 2 branches missed.">				if(recursive) updateDirectoryDim(dir, dim, dimNormal, resizeMode, recursive);</span>

<span class="nc" id="L1956">				resizePicturesInDirectory(dir, out, prop, resizeMode, recursive);</span>
			}
		}
<span class="nc" id="L1959">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L1962" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L1963" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L1964">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="nc" id="L1966">	}</span>

	/**
	 * Upravi fyzicku velkost obrazkov v zadanom adresari
	 * @param dir - URL adresa adresara s obrazkami
	 * @param recursive - ak je true, aplikuje sa aj na podadresare
	 * @param prop - Prop objekt s prekladmi pre vypis informacie
	 * @param out - vystupny objekt pre vypis sprav, moze byt NULL
	 */
	public static void resizePicturesInDirectory(String dir, boolean recursive, Prop prop, PrintWriter out) {
<span class="fc" id="L1976">		String resizeMode = getResizeMode(dir, true);</span>
<span class="fc" id="L1977">		resizePicturesInDirectory(dir, out, prop, resizeMode, recursive);</span>
<span class="fc" id="L1978">	}</span>

	/**
	 * Upravi velkost obrazkov v zadanom adresari podla zadaneho rezimu
	 * @param dir
	 * @param out
	 * @param prop
	 * @param resizeMode
	 * @param recursive
	 */
	private static void resizePicturesInDirectory(String dir, PrintWriter out, Prop prop, String resizeMode, boolean recursive)
	{
<span class="pc bpc" id="L1990" title="1 of 2 branches missed.">		if (null != out)</span>
		{
<span class="nc" id="L1992">			out.println(prop.getText(&quot;components.gallery.resizing_images_in&quot;, dir));</span>
		}
<span class="fc" id="L1994">		Dimension[] dims = getDimension(dir);</span>
<span class="fc" id="L1995">		dir = Tools.replace(dir, &quot;/&quot;, File.separator);</span>
<span class="fc" id="L1996">		IwcmFile directory = IwcmFile.fromVirtualPath(&quot;/&quot; + dir);</span>
<span class="pc bpc" id="L1997" title="2 of 4 branches missed.">		if (directory.exists() &amp;&amp; directory.isDirectory())</span>
		{
<span class="fc" id="L1999">			IwcmFile[] fileList = directory.listFiles();</span>
<span class="fc bfc" id="L2000" title="All 2 branches covered.">			for (IwcmFile file : fileList)</span>
			{
<span class="pc bpc" id="L2002" title="1 of 4 branches missed.">				if (recursive &amp;&amp; file.isDirectory())</span>
<span class="fc" id="L2003">					resizePicturesInDirectory(file.getVirtualPath(), out, prop, resizeMode, recursive);</span>
<span class="fc bfc" id="L2004" title="All 6 branches covered.">				if (file.isFile() &amp;&amp; !file.getName().startsWith(&quot;s_&quot;) &amp;&amp; !file.getName().startsWith(&quot;o_&quot;))</span>
				{
<span class="fc" id="L2006">					resizePictureImpl(dims, file.getAbsolutePath(), out, prop, resizeMode);</span>
				}
			}
		}
<span class="fc" id="L2010">	}</span>

	/**
	 * Skopiruje subor oldFilePath na newFilePath
	 *
	 *@param oldFilePath
	 *           Description of the Parameter
	 *@param newFilePath
	 *           Description of the Parameter
	 *@return Description of the Return Value
	 */
	public static boolean copyFile(String oldFilePath, String newFilePath)
	{
<span class="fc" id="L2023">		Logger.debug(GalleryDB.class, &quot;copyFile &quot; + oldFilePath + &quot;-&gt;&quot; + newFilePath);</span>
<span class="pc bpc" id="L2024" title="1 of 2 branches missed.">		if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(oldFilePath)))</span>
		{
<span class="nc" id="L2026">			IwcmFsDB.copyTo(new IwcmFile(oldFilePath), new IwcmFile(newFilePath));</span>
<span class="nc" id="L2027">			return true;</span>
		}
		try
		{
<span class="fc" id="L2031">			File newFile = new File(newFilePath);</span>
<span class="fc" id="L2032">			File oldFile = new File(oldFilePath);</span>
<span class="fc bfc" id="L2033" title="All 2 branches covered.">			if (newFile.exists()==false)</span>
			{
<span class="pc bpc" id="L2035" title="1 of 2 branches missed.">				if(newFile.createNewFile() == false) return false;</span>
				//if(newFile.delete() == false) return false;
			}
<span class="fc" id="L2038">			FileInputStream inStream = new FileInputStream(oldFile);</span>
<span class="fc" id="L2039">			FileOutputStream out = new FileOutputStream(newFile);</span>
			int c;
<span class="fc" id="L2041">			byte[] buff = new byte[150000];</span>
<span class="fc bfc" id="L2042" title="All 2 branches covered.">			while ((c = inStream.read(buff)) != -1)</span>
			{
<span class="fc" id="L2044">				out.write(buff, 0, c);</span>
			}
<span class="fc" id="L2046">			out.close();</span>
<span class="fc" id="L2047">			inStream.close();</span>
<span class="fc" id="L2048">			return (true);</span>
		}
<span class="nc" id="L2050">		catch (Exception ex)</span>
		{
<span class="nc" id="L2052">			sk.iway.iwcm.Logger.error(ex);</span>
		}
<span class="nc" id="L2054">		return (false);</span>
	}

	public static Dimension[] getDimension(String dir)
	{
<span class="fc" id="L2059">		return (getDimension(dir, true));</span>
	}

	public static Dimension[] getDimension(String dir, boolean recursive)
	{
<span class="fc" id="L2064">		return (getDimension(dir, recursive, true));</span>
	}

	/**
	 * Ziskanie velkosti foldra
	 * @param dir
	 * @param recursive
	 * @param returnDefault - ak sa nic nenajde a doiteruje sa k root foldru vratia sa default hodnoty
	 * @return
	 */
	public static Dimension[] getDimension(String dir, boolean recursive, boolean returnDefault)
	{
<span class="fc" id="L2076">		java.sql.Connection db_conn = null;</span>
<span class="fc" id="L2077">		java.sql.PreparedStatement ps = null;</span>
<span class="fc" id="L2078">		ResultSet rs = null;</span>
<span class="fc" id="L2079">		Dimension dim = null;</span>
<span class="fc" id="L2080">		Dimension dimNormal = null;</span>
<span class="fc" id="L2081">		dir = dir.replace('\\', '/');</span>
		try
		{
<span class="pc bpc" id="L2084" title="1 of 2 branches missed.">			if (!dir.equals(&quot;&quot;))</span>
			{
<span class="fc" id="L2086">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L2087">				ps = db_conn.prepareStatement(&quot;SELECT * FROM gallery_dimension WHERE image_path=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L2088">				ps.setString(1, normalizeDir(dir));</span>
<span class="fc" id="L2089">				rs = ps.executeQuery();</span>
<span class="fc bfc" id="L2090" title="All 2 branches covered.">				if (rs.next())</span>
				{
<span class="fc" id="L2092">					dim = new Dimension(rs.getInt(&quot;image_width&quot;), rs.getInt(&quot;image_height&quot;));</span>
<span class="fc" id="L2093">					dimNormal = new Dimension(rs.getInt(&quot;normal_width&quot;), rs.getInt(&quot;normal_height&quot;));</span>
				}
<span class="fc" id="L2095">				rs.close();</span>
<span class="fc" id="L2096">				ps.close();</span>
<span class="fc" id="L2097">				db_conn.close();</span>
<span class="fc" id="L2098">				db_conn = null;</span>
<span class="fc" id="L2099">				ps = null;</span>
<span class="fc" id="L2100">				rs = null;</span>
			}
		}
<span class="nc" id="L2103">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="pc bpc" id="L2106" title="1 of 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="pc bpc" id="L2107" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L2108" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L2109">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="pc bpc" id="L2111" title="2 of 6 branches missed.">		if (recursive &amp;&amp; (dim == null || dimNormal == null))</span>
		{
<span class="fc" id="L2113">			int index = dir.lastIndexOf('/');</span>
<span class="fc bfc" id="L2114" title="All 2 branches covered.">			if (index &gt; 1)</span>
			{
<span class="fc" id="L2116">				String parent = dir.substring(0, index);</span>
<span class="fc" id="L2117">				Logger.debug(GalleryDB.class, &quot;Testujem gallery size parent: &quot; + parent);</span>
<span class="fc" id="L2118">				return (getDimension(parent, recursive, returnDefault));</span>
			}
<span class="pc bpc" id="L2120" title="1 of 2 branches missed.">			else if (returnDefault)</span>
			{
<span class="nc" id="L2122">				dim = new Dimension(160, 120);</span>
<span class="nc" id="L2123">				dimNormal = new Dimension(750, 560);</span>
			}
		}
<span class="fc" id="L2126">		Dimension[] dims = new Dimension[2];</span>
<span class="fc" id="L2127">		dims[0] = dim;</span>
<span class="fc" id="L2128">		dims[1] = dimNormal;</span>
<span class="fc" id="L2129">		return (dims);</span>
	}

	public static String getResizeMode(String dir, boolean recursive)
	{
<span class="fc" id="L2134">		java.sql.Connection db_conn = null;</span>
<span class="fc" id="L2135">		java.sql.PreparedStatement ps = null;</span>
<span class="fc" id="L2136">		ResultSet rs = null;</span>
<span class="fc" id="L2137">		dir = dir.replace('\\', '/');</span>
<span class="fc" id="L2138">		String resizeMode = null;</span>
		try
		{
<span class="pc bpc" id="L2141" title="1 of 2 branches missed.">			if (!dir.equals(&quot;&quot;))</span>
			{
<span class="fc" id="L2143">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L2144">				ps = db_conn.prepareStatement(&quot;SELECT * FROM gallery_dimension WHERE image_path=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L2145">				ps.setString(1, normalizeDir(dir));</span>
<span class="fc" id="L2146">				rs = ps.executeQuery();</span>
<span class="fc bfc" id="L2147" title="All 2 branches covered.">				if (rs.next())</span>
				{
<span class="fc" id="L2149">					resizeMode = rs.getString(&quot;resize_mode&quot;);</span>
				}
<span class="fc" id="L2151">				rs.close();</span>
<span class="fc" id="L2152">				ps.close();</span>
<span class="fc" id="L2153">				db_conn.close();</span>
<span class="fc" id="L2154">				db_conn = null;</span>
<span class="fc" id="L2155">				ps = null;</span>
<span class="fc" id="L2156">				rs = null;</span>
			}
		}
<span class="nc" id="L2159">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="pc bpc" id="L2162" title="1 of 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="pc bpc" id="L2163" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L2164" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L2165">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="pc bpc" id="L2167" title="1 of 4 branches missed.">		if (recursive &amp;&amp; (Tools.isEmpty(resizeMode)))</span>
		{
<span class="fc" id="L2169">			int index = dir.lastIndexOf('/');</span>
<span class="pc bpc" id="L2170" title="1 of 2 branches missed.">			if (index &gt; 1)</span>
			{
<span class="fc" id="L2172">				String parent = dir.substring(0, index);</span>
<span class="fc" id="L2173">				Logger.debug(GalleryDB.class, &quot;Testujem gallery size parent: &quot; + parent);</span>
<span class="fc" id="L2174">				return (getResizeMode(parent, recursive));</span>
			}
			else
			{
<span class="nc" id="L2178">				resizeMode = null;</span>
			}
		}
<span class="fc" id="L2181">		return (resizeMode);</span>
	}

	public static String getResizeMode(String dir)
	{
<span class="fc" id="L2186">		java.sql.Connection db_conn = null;</span>
<span class="fc" id="L2187">		java.sql.PreparedStatement ps = null;</span>
<span class="fc" id="L2188">		ResultSet rs = null;</span>
<span class="fc" id="L2189">		String ret = null;</span>
<span class="fc" id="L2190">		dir = dir.replace('\\', '/');</span>
		try
		{
<span class="pc bpc" id="L2193" title="1 of 2 branches missed.">			if (!dir.equals(&quot;&quot;))</span>
			{
<span class="fc" id="L2195">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L2196">				ps = db_conn.prepareStatement(&quot;SELECT resize_mode FROM gallery_dimension WHERE image_path=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L2197">				ps.setString(1, normalizeDir(dir));</span>
<span class="fc" id="L2198">				rs = ps.executeQuery();</span>
<span class="fc bfc" id="L2199" title="All 2 branches covered.">				if (rs.next())</span>
				{
<span class="fc" id="L2201">					ret = rs.getString(&quot;resize_mode&quot;);</span>
				}
<span class="fc" id="L2203">				rs.close();</span>
<span class="fc" id="L2204">				ps.close();</span>
<span class="fc" id="L2205">				db_conn.close();</span>

<span class="fc" id="L2207">				rs = null;</span>
<span class="fc" id="L2208">				ps = null;</span>
<span class="fc" id="L2209">				db_conn = null;</span>
			}
		}
<span class="nc" id="L2212">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="pc bpc" id="L2215" title="1 of 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="pc bpc" id="L2216" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L2217" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L2218">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="fc" id="L2220">		return ret;</span>
	}

	/**
	 * Zo zadanďż˝ho obrďż˝zku na serveri pripravi nahladovy a normalny obrazok
	 *
	 *@param realPath
	 *           cesta k obrazku na serveri
	 *@param dir
	 *           cesta k adresaru s nastavenim velkosti obrazkov galerie
	 *@param request
	 *           Description of the Parameter
	 */
	public static void resizePicture(String realPath, String dir)
	{
<span class="fc" id="L2235">		Dimension[] dims = getDimension(dir);</span>
<span class="fc" id="L2236">		String resizeMode = getResizeMode(dir, true);</span>
<span class="fc" id="L2237">		resizePictureImpl(dims, realPath, null, null, resizeMode);</span>
<span class="fc" id="L2238">	}</span>

	/**
	 * @param dims
	 * @param realPath
	 * @param out
	 * @param prop
	 * @return
	 */
	public static boolean resizePictureImpl(Dimension[] dims, String realPath, PrintWriter out, Prop prop)
	{
<span class="nc" id="L2249">		IwcmFile actualDir = new IwcmFile(realPath);</span>
<span class="nc" id="L2250">		return resizePictureImpl(dims, realPath, out, prop, GalleryDB.getResizeMode(actualDir.getVirtualParent()));</span>
	}

	/**
	 * mody: S - shrink to fit C - crop to fit A - presne rozmery W - presna
	 * sirka H - presna vyska iny - shrink to fit fyzicka zmena velkosti obrazka
	 *
	 * @param dims
	 * @param realPath
	 * @param out
	 */
	public static boolean resizePictureImpl(Dimension[] dims, String realPath, PrintWriter out, Prop prop, String resizeMode)
	{
<span class="fc" id="L2263">		boolean ret = true;</span>
<span class="fc" id="L2264">		File img = new File(realPath);</span>

		//uprava pre fotky zacinajuce na o_ alebo s_
<span class="fc" id="L2267">		String imageName = img.getName();</span>
<span class="pc bpc" id="L2268" title="2 of 4 branches missed.">		while(imageName.startsWith(&quot;o_&quot;) || imageName.startsWith(&quot;s_&quot;))</span>
		{
<span class="nc" id="L2270">			imageName = imageName.substring(2);</span>
		}
<span class="pc bpc" id="L2272" title="1 of 2 branches missed.">		if(!imageName.equals(img.getName()))</span>
		{
<span class="nc" id="L2274">			File renamedFile = new File(img.getParent()+File.separator+imageName);</span>
<span class="nc bnc" id="L2275" title="All 2 branches missed.">			if(img.renameTo(renamedFile))</span>
			{
<span class="nc" id="L2277">				img = renamedFile;</span>
<span class="nc" id="L2278">				realPath = img.getParent()+File.separator+imageName;</span>
			}
		}
		//koniec upravy

<span class="fc" id="L2283">		String imgNameLC = img.getName().toLowerCase();</span>

<span class="pc bpc" id="L2285" title="1 of 6 branches missed.">		if (!imgNameLC.endsWith(&quot;.jpg&quot;) &amp;&amp; !imgNameLC.endsWith(&quot;.gif&quot;) &amp;&amp; !imgNameLC.endsWith(&quot;.png&quot;)</span>
<span class="pc bpc" id="L2286" title="1 of 2 branches missed.">					&amp;&amp; !imgNameLC.endsWith(&quot;.jpeg&quot;))</span>
		{
<span class="nc" id="L2288">			return (false);</span>
		}
<span class="fc" id="L2290">		String realPathSmall = Tools.replace(realPath, img.getName(), &quot;s_&quot; + img.getName());</span>
<span class="fc" id="L2291">		String realPathOrig = Tools.replace(realPath, img.getName(), &quot;o_&quot; + img.getName());</span>
<span class="fc" id="L2292">		String resizeFrom = realPathOrig;</span>
<span class="fc" id="L2293">		Dimension dim = dims[0];</span>
<span class="fc" id="L2294">		Dimension dimNormal = dims[1];</span>

<span class="fc" id="L2296">		IwcmFile normal = new IwcmFile(realPath);</span>

		//ak sa negeneruju miniatury, nevypisem hlasky o ich &quot;generovani&quot;
<span class="fc" id="L2299">		boolean miniatures = true;</span>
<span class="pc bpc" id="L2300" title="2 of 4 branches missed.">		if(resizeMode!=null &amp;&amp; resizeMode.equals(&quot;N&quot;))</span>
<span class="nc" id="L2301">			miniatures = false;</span>


<span class="pc bpc" id="L2304" title="3 of 4 branches missed.">		if (dimNormal.width != 0 || dimNormal.height != 0)</span>
		{
			// zisti ci mame original obrazok
<span class="fc" id="L2307">			IwcmFile original = new IwcmFile(realPathOrig);</span>
<span class="pc bpc" id="L2308" title="2 of 6 branches missed.">			if ((original.exists() == false || original.length()&lt;1) &amp;&amp; miniatures)</span>
			{
				// skopiruj ho
<span class="fc" id="L2311">				copyFile(realPath, realPathOrig);</span>
			}
<span class="pc bpc" id="L2313" title="5 of 6 branches missed.">			if (out != null &amp;&amp; prop != null &amp;&amp; miniatures)</span>
			{
<span class="nc" id="L2315">				println(out, prop.getText(&quot;gallery.resizing.normal&quot;) + &quot;: &quot; + normal.getName());</span>
			}
			// resizni
<span class="fc" id="L2318">			int status = resizePicture(realPathOrig, realPath, dimNormal.getWidth(), dimNormal.getHeight(), resizeMode);</span>
<span class="fc bfc" id="L2319" title="All 2 branches covered.">			if (status &gt; 0)</span>
			{
<span class="fc" id="L2321">				ret = false;</span>
<span class="pc bpc" id="L2322" title="3 of 4 branches missed.">				if (out != null &amp;&amp; prop != null)</span>
				{
<span class="nc" id="L2324">					println(out, normal.getName() + &quot;: &lt;span class='error'&gt;&quot; + prop.getText(&quot;gallery.resizing.error_&quot; + status)</span>
								+ &quot;&lt;/span&gt;&quot;);
				}
			}
<span class="fc" id="L2328">		}</span>
		else
		{
			// zisti ci mame original obrazok
<span class="nc" id="L2332">			IwcmFile original = new IwcmFile(realPathOrig);</span>
<span class="nc bnc" id="L2333" title="All 4 branches missed.">			if (original.exists() == true &amp;&amp; original.length()&gt;0)</span>
			{
				// skopiruj original na normal
<span class="nc" id="L2336">				copyFile(realPathOrig, realPath);</span>
<span class="nc" id="L2337">				resizeFrom = realPath;</span>
			}
			else
			{
				// vytvorim ho ako kopia normal do original
<span class="nc" id="L2342">				copyFile(realPath, realPathOrig);</span>
			}
<span class="nc bnc" id="L2344" title="All 6 branches missed.">			if (out != null &amp;&amp; prop != null &amp;&amp; miniatures)</span>
			{
<span class="nc" id="L2346">				println(out, prop.getText(&quot;gallery.resizing.normal&quot;) + &quot;: &quot; + normal.getName());</span>
			}
		}
<span class="pc bpc" id="L2349" title="5 of 6 branches missed.">		if (out != null &amp;&amp; prop != null &amp;&amp; miniatures)</span>
		{
<span class="nc" id="L2351">			println(out, prop.getText(&quot;gallery.resizing.preview&quot;) + &quot;: s_&quot; + normal.getName());</span>
		}
<span class="fc" id="L2353">		int status = resizePicture(resizeFrom, realPathSmall, dim.getWidth(), dim.getHeight(), resizeMode);</span>
<span class="pc bpc" id="L2354" title="1 of 2 branches missed.">		if (status &gt; 0)</span>
		{
<span class="nc" id="L2356">			ret = false;</span>
<span class="nc bnc" id="L2357" title="All 4 branches missed.">			if (out != null &amp;&amp; prop != null)</span>
			{
<span class="nc" id="L2359">				println(out, normal.getName() + &quot;: &lt;span class='error'&gt;&quot; + prop.getText(&quot;gallery.resizing.error_&quot; + status)</span>
							+ &quot;&lt;/span&gt;&quot;);
			}
		}

<span class="pc bpc" id="L2364" title="2 of 4 branches missed.">		if(resizeMode!=null &amp;&amp; resizeMode.equals(&quot;N&quot;))</span>
		{
<span class="nc" id="L2366">			IwcmFile small = new IwcmFile(realPathSmall);</span>
<span class="nc bnc" id="L2367" title="All 2 branches missed.">			if(small.exists())</span>
<span class="nc bnc" id="L2368" title="All 4 branches missed.">				ret = small.delete() &amp;&amp; ret;</span>
<span class="nc" id="L2369">			IwcmFile original = new IwcmFile(realPathOrig);</span>
<span class="nc bnc" id="L2370" title="All 2 branches missed.">			if(original.exists())</span>
<span class="nc bnc" id="L2371" title="All 4 branches missed.">				ret = original.delete() &amp;&amp; ret;</span>
		}

<span class="fc" id="L2374">		return (ret);</span>
	}

	/**
	 * fyzicka zmena velkosti obrazka
	 *
	 * @param dims
	 * @param realPath
	 * @param out
	 */
	public static boolean resizePictureEdit(Dimension[] dims, String realPathOrig, PrintWriter out, Prop prop)
	{
<span class="nc" id="L2386">		boolean ret = true;</span>
<span class="nc" id="L2387">		IwcmFile img = new IwcmFile(realPathOrig);</span>

<span class="nc" id="L2389">		String realPathSmall = Tools.replace(realPathOrig, img.getName(), &quot;s_&quot; + img.getName().substring(2));</span>
		// odstran o_
<span class="nc" id="L2391">		String realPath = Tools.replace(realPathOrig, img.getName(), img.getName().substring(2));</span>
<span class="nc" id="L2392">		String resizeFrom = realPath;</span>
<span class="nc" id="L2393">		Dimension dim = dims[0];</span>
<span class="nc" id="L2394">		Dimension dimNormal = dims[1];</span>
<span class="nc bnc" id="L2395" title="All 4 branches missed.">		if (dimNormal.width != 0 &amp;&amp; dimNormal.height != 0)</span>
		{
			// zisti ci mame original obrazok
<span class="nc" id="L2398">			IwcmFile original = new IwcmFile(realPathOrig);</span>
<span class="nc bnc" id="L2399" title="All 2 branches missed.">			if (original.exists() == false)</span>
			{
				// skopiruj ho
<span class="nc" id="L2402">				copyFile(realPathOrig, realPath);</span>
			}
<span class="nc bnc" id="L2404" title="All 4 branches missed.">			if (out != null &amp;&amp; prop != null)</span>
			{
				// println(out, prop.getText(&quot;gallery.resizing.normal&quot;) + &quot;: &quot; +
				// normal.getName());
			}
			// resizni
<span class="nc" id="L2410">			int status = resizePicture(realPathOrig, realPath, dimNormal.getWidth(), dimNormal.getHeight());</span>
<span class="nc bnc" id="L2411" title="All 2 branches missed.">			if (status &gt; 0)</span>
			{
<span class="nc" id="L2413">				ret = false;</span>
<span class="nc bnc" id="L2414" title="All 4 branches missed.">				if (out != null &amp;&amp; prop != null)</span>
				{
					// println(out, normal.getName() + &quot;: &lt;span class='error'&gt;&quot; +
					// prop.getText(&quot;gallery.resizing.error_&quot; + status)+&quot;&lt;/span&gt;&quot;);
				}
			}
<span class="nc" id="L2420">			resizeFrom = realPathOrig;</span>
<span class="nc" id="L2421">		}</span>
		else
		{
<span class="nc" id="L2424">			resizeFrom = realPathOrig;</span>
			// skopiruj original na normal
<span class="nc" id="L2426">			IwcmFile original = new IwcmFile(realPathOrig);</span>
<span class="nc bnc" id="L2427" title="All 2 branches missed.">			if (original.exists() == true)</span>
			{
				// skopiruj ho
<span class="nc" id="L2430">				copyFile(realPathOrig, realPath);</span>
			}
		}
<span class="nc bnc" id="L2433" title="All 4 branches missed.">		if (out != null &amp;&amp; prop != null)</span>
		{
			// println(out, prop.getText(&quot;gallery.resizing.preview&quot;) + &quot;: s_&quot; +
			// normal.getName());
		}
<span class="nc" id="L2438">		int status = resizePicture(resizeFrom, realPathSmall, dim.getWidth(), dim.getHeight());</span>
<span class="nc bnc" id="L2439" title="All 2 branches missed.">		if (status &gt; 0)</span>
		{
<span class="nc" id="L2441">			ret = false;</span>
<span class="nc bnc" id="L2442" title="All 4 branches missed.">			if (out != null &amp;&amp; prop != null)</span>
			{
				// println(out, normal.getName() + &quot;: &lt;span class='error'&gt;&quot; +
				// prop.getText(&quot;gallery.resizing.error_&quot; + status)+&quot;&lt;/span&gt;&quot;);
			}
		}

<span class="nc" id="L2449">		String resizeMode = getResizeMode(img.getVirtualParent(), true);</span>
<span class="nc bnc" id="L2450" title="All 4 branches missed.">		if(resizeMode!=null &amp;&amp; resizeMode.equals(&quot;N&quot;))</span>
		{
<span class="nc" id="L2452">			IwcmFile small = new IwcmFile(realPathSmall);</span>
<span class="nc" id="L2453">			IwcmFile normal = new IwcmFile(realPath);</span>
<span class="nc bnc" id="L2454" title="All 2 branches missed.">			if(small.exists())</span>
<span class="nc bnc" id="L2455" title="All 4 branches missed.">				ret = small.delete() &amp;&amp; ret;</span>
<span class="nc bnc" id="L2456" title="All 2 branches missed.">			if(normal.exists())</span>
<span class="nc bnc" id="L2457" title="All 4 branches missed.">				ret = normal.delete() &amp;&amp; ret;</span>
		}

<span class="nc" id="L2460">		return (ret);</span>
	}

	/**
	 * Resizne obrazok, vrati: 0-vsetko je OK 1-obrazok je uz teraz mensi
	 * 2-nepodarilo sa ulozit obrazok 3-nastala neznama chyba 4-obrazok je v
	 * nepodporovanom formate
	 *
	 *@param realPath
	 *           Description of the Parameter
	 *@param realPathSmall
	 *           Description of the Parameter
	 *@param width
	 *           Description of the Parameter
	 *@param height
	 *           Description of the Parameter
	 */
	public static int resizePicture(String realPath, String realPathSmall, double width, double height)
	{
<span class="fc" id="L2479">		int status = resizePicture(realPath, realPathSmall, width, height, &quot;&quot;);</span>
<span class="fc" id="L2480">		return status;</span>
	}

	/**
	 * Prida vodotlac
	 *
	 * @param realPath Absolutna cesta k obrazku, nad ktorym sa bude prevadzat vodotlac
	 */
	private static void performWatermarking(String realPath)
	{
		//o_ stands for original image
<span class="nc bnc" id="L2491" title="All 6 branches missed.">		boolean shouldPerformWatermarking = (!realPath.contains(&quot;/o_&quot;) &amp;&amp; existImageMagickCompositeCommand()) &amp;&amp; Constants.getBoolean(&quot;galleryEnableWatermarking&quot;);</span>
<span class="nc bnc" id="L2492" title="All 2 branches missed.">		if (shouldPerformWatermarking)</span>
		{
<span class="nc" id="L2494">			String galleryPath = new IwcmFile(realPath).getVirtualParent();</span>
<span class="nc" id="L2495">			GalleryDimension galleryContainingImage = getGalleryInfo(galleryPath, -1);</span>
<span class="nc bnc" id="L2496" title="All 2 branches missed.">			if (galleryContainingImage!=null) {</span>
<span class="nc" id="L2497">				GalleryDimension watermark = findWaterMarkFor(galleryContainingImage);</span>
<span class="nc bnc" id="L2498" title="All 2 branches missed.">				if (watermark.getWatermark() != null)</span>
<span class="nc" id="L2499">					addWatermarkSignature(realPath, watermark);</span>
			}
		}
<span class="nc" id="L2502">	}</span>

	private static boolean existImageMagickCompositeCommand()
	{
<span class="fc" id="L2506">		return new IwcmFile(Constants.getString(&quot;imageMagickDir&quot;), &quot;composite&quot;).exists();</span>
	}

	/**
	 * Najde vodotlac aj s nastaveniami sytosti farieb a polohy. Hlada
	 * v zadanom adresari a vsetkych nadadresaroch az kym dosiahne /images/gallery
	 */
	public static GalleryDimension findWaterMarkFor(GalleryDimension leaf)
	{
<span class="nc" id="L2515">		Logger.debug(GalleryDB.class, String.format(&quot;Watermark lookup for %s&quot;, leaf.getGalleryPath()));</span>
<span class="nc" id="L2516">		List&lt;GalleryDimension&gt; dirs = getDirectoriesToGalleryRoot(leaf);</span>

<span class="nc bnc" id="L2518" title="All 2 branches missed.">		for (GalleryDimension dir : dirs)</span>
		{
<span class="nc bnc" id="L2520" title="All 4 branches missed.">			if (dir.getWatermark() == null || isEmpty(dir.getGalleryPath()))</span>
<span class="nc" id="L2521">				continue;</span>
<span class="nc bnc" id="L2522" title="All 2 branches missed.">			if (dir.getWatermark().exists())</span>
			{
<span class="nc" id="L2524">				Logger.debug(GalleryDB.class, String.format(&quot;Watermark found: %s&quot;, dir.getWatermark().getVirtualPath()));</span>
<span class="nc" id="L2525">				return dir;</span>
			}
<span class="nc" id="L2527">		}</span>

<span class="nc" id="L2529">		Logger.debug(GalleryDB.class, &quot;No watermark found&quot;);</span>
		//default if nothing is found
<span class="nc" id="L2531">		GalleryDimension nullWatermark = new GalleryDimension();</span>
<span class="nc" id="L2532">		nullWatermark.setWatermarkPlacement(Constants.getString(&quot;galleryWatermarkGravity&quot;));</span>
<span class="nc" id="L2533">		nullWatermark.setWatermarkSaturation(Constants.getInt(&quot;galleryWatermarkSaturation&quot;));</span>
<span class="nc" id="L2534">		nullWatermark.setGalleryPath(&quot;/images/gallery&quot;);</span>
<span class="nc" id="L2535">		return nullWatermark;</span>
	}

	private static List&lt;GalleryDimension&gt; getDirectoriesToGalleryRoot(GalleryDimension dir)
	{
<span class="nc" id="L2540">		String pathToGallery = &quot;/images/gallery&quot;; //NOSONAR</span>
<span class="nc" id="L2541">		List&lt;GalleryDimension&gt; upDirs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2542">		GalleryDimension currentDir = dir;</span>
<span class="nc bnc" id="L2543" title="All 4 branches missed.">		while(currentDir != null &amp;&amp; currentDir.getGalleryPath().startsWith(pathToGallery))</span>
		{
<span class="nc" id="L2545">			upDirs.add(currentDir);</span>
<span class="nc" id="L2546">			String nextGalleryPath = IwcmFile.fromVirtualPath(currentDir.getGalleryPath()).getVirtualParent();</span>
<span class="nc" id="L2547">			currentDir = getGalleryInfo(nextGalleryPath, -1);</span>
<span class="nc" id="L2548">		}</span>
<span class="nc" id="L2549">		return upDirs;</span>
	}


	/**
	 * Samotny kod, ktory sposobi pridanie vodotlace do obrazku. Spolieha
	 * sa na kniznicu imageMagick a jej program &quot;composite&quot; s parametrom &quot;-watermark&quot;
	 * Cely prikaz vyzera podobne ako:
	 *  /usr/bin/composite -watermark 70x70 /watermark.png -gravity SouthWest /dest.jpg /dest.jpg
	 */
	private static void addWatermarkSignature(String realPath, GalleryDimension watermark)
	{
<span class="nc" id="L2561">		List&lt;String&gt; args = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2562">		String command = new IwcmFile(Constants.getString(&quot;imageMagickDir&quot;), &quot;composite&quot;).getAbsolutePath();</span>

<span class="nc" id="L2564">		String watermarkPath = watermark.getWatermark().getAbsolutePath();</span>
<span class="nc" id="L2565">		IwcmFile imageFile = new IwcmFile(realPath);</span>
<span class="nc" id="L2566">		Logger.debug(GalleryDB.class, &quot;imageFile=&quot;+imageFile.getName());</span>
<span class="nc bnc" id="L2567" title="All 2 branches missed.">		if (imageFile.getName().startsWith(&quot;s_&quot;))</span>
		{
			//skus najst s_watermark subor
<span class="nc" id="L2570">			watermarkPath = Tools.getRealPath(getImagePathSmall(watermark.getWatermark().getVirtualPath()));</span>
<span class="nc" id="L2571">			Logger.debug(GalleryDB.class, &quot;testing S_watermark: &quot;+watermarkPath);</span>
		}

<span class="nc" id="L2574">		args.add(command);</span>
<span class="nc" id="L2575">		args.add(&quot;-dissolve&quot;);</span>
<span class="nc" id="L2576">		args.add(watermark.getWatermarkSaturation()+&quot;%&quot;);</span>

<span class="nc bnc" id="L2578" title="All 2 branches missed.">		if (watermarkPath.endsWith(&quot;.svg&quot;))</span>
		{
			//je to SVG obrazok, musime zistit rozmer orig obrazku a prepocitat velkost watermarku
<span class="nc" id="L2581">			ImageInfo ii = new ImageInfo(imageFile);</span>
<span class="nc" id="L2582">			int originalHeight = ii.getHeight();</span>
<span class="nc" id="L2583">			int svgHeight = (int)Math.round(originalHeight * (Constants.getInt(&quot;galleryWatermarkSvgSizePercent&quot;)/100d));</span>
<span class="nc bnc" id="L2584" title="All 2 branches missed.">			if (svgHeight &lt; Constants.getInt(&quot;galleryWatermarkSvgMinHeight&quot;)) svgHeight = Constants.getInt(&quot;galleryWatermarkSvgMinHeight&quot;);</span>

			//pockaj na GFS
<span class="nc" id="L2587">			MetadataCleaner.waitForGfs();</span>

<span class="nc" id="L2589">			args.add(&quot;-geometry&quot;);</span>
<span class="nc" id="L2590">			args.add(&quot;x&quot;+svgHeight+&quot;+0&quot;);</span>
<span class="nc" id="L2591">			args.add(&quot;-background&quot;);</span>
<span class="nc" id="L2592">			args.add(&quot;none&quot;);</span>
		}


<span class="nc" id="L2596">		args.add(watermarkPath);</span>
<span class="nc" id="L2597">		args.add(&quot;-gravity&quot;);</span>
<span class="nc" id="L2598">		args.add(watermark.getWatermarkPlacement());</span>
<span class="nc" id="L2599">		args.add(realPath); //zdrojovy subor</span>
<span class="nc" id="L2600">		args.add(realPath); //cielovy subor</span>
<span class="nc" id="L2601">		Logger.debug(GalleryDB.class, &quot;Watermark executing:\n&quot; + StringUtils.join(args.iterator(), ' '));</span>

		try
		{
<span class="nc" id="L2605">			Process pr = Runtime.getRuntime().exec(args.toArray(new String[0]));</span>
<span class="nc" id="L2606">			pr.waitFor();</span>
		}
<span class="nc" id="L2608">		catch (Exception e){sk.iway.iwcm.Logger.error(e);}</span>

		//pridaj vodotlac aj do originalneho suboru, nielen do s_
<span class="nc bnc" id="L2611" title="All 2 branches missed.">		if (imageFile.getName().startsWith(&quot;s_&quot;))</span>
		{
<span class="nc" id="L2613">			String originalPath = imageFile.getParent()+File.separatorChar+imageFile.getName().replace(&quot;s_&quot;, &quot;&quot;);</span>
<span class="nc" id="L2614">			addWatermarkSignature(originalPath, watermark);</span>
		}
<span class="nc" id="L2616">	}</span>

	/**
	 * Resizne obrazok, vrati: 0-vsetko je OK 1-obrazok je uz teraz mensi
	 * 2-nepodarilo sa ulozit obrazok 3-nastala neznama chyba 4-obrazok je v
	 * nepodporovanom formate
	 *
	 *@param realPath
	 *@param realPathSmall
	 *@param width
	 *@param height
	 *@param resizeMode
	 */
	public static int resizePicture(String realPath, String realPathSmall, double width, double height, String resizeMode)
	{
<span class="pc bpc" id="L2631" title="2 of 4 branches missed.">		if(resizeMode!=null &amp;&amp; resizeMode.equals(&quot;N&quot;))</span>
		{
<span class="nc" id="L2633">			IwcmFile fOrigImg = new IwcmFile(realPath);</span>
<span class="nc" id="L2634">			String imageName = fOrigImg.getName();</span>
<span class="nc bnc" id="L2635" title="All 4 branches missed.">			if (imageName.startsWith(&quot;s_&quot;) || imageName.startsWith(&quot;o_&quot;))</span>
<span class="nc" id="L2636">				imageName = imageName.substring(2);</span>
<span class="nc" id="L2637">			GalleryDB.setImage(fOrigImg.getVirtualParent(), imageName);</span>
<span class="nc" id="L2638">			return (0);</span>
		}

<span class="fc" id="L2641">		width = limitMaxSize(width);</span>
<span class="fc" id="L2642">		height = limitMaxSize(height);</span>

<span class="fc" id="L2644">		Logger.debug(GalleryDB.class, &quot;resizePicture(&quot; + realPath + &quot;,&quot; + realPathSmall + &quot;,&quot; + width + &quot;,&quot; + height+&quot;, &quot;+resizeMode);</span>
<span class="fc" id="L2645">		IwcmInputStream input=null;</span>
		try
		{
<span class="fc" id="L2648">			IwcmFile fSmallImg = new IwcmFile(realPathSmall);</span>
<span class="fc" id="L2649">			IwcmFile fOrigImg = new IwcmFile(realPath);</span>

<span class="fc bfc" id="L2651" title="All 2 branches covered.">			if (Tools.isEmpty(resizeMode))</span>
			{
				//skus vydedkukovat
<span class="fc" id="L2654">				String dir = fOrigImg.getVirtualParent();</span>
<span class="fc" id="L2655">				resizeMode = getResizeMode(dir);</span>
<span class="fc" id="L2656">				Logger.debug(GalleryDB.class, &quot;Forcing resize mode to:&quot;+resizeMode+&quot; for dir:&quot;+dir);</span>
			}

<span class="fc" id="L2659">			String imageName = fOrigImg.getName();</span>
<span class="fc bfc" id="L2660" title="All 4 branches covered.">			if (imageName.startsWith(&quot;s_&quot;) || imageName.startsWith(&quot;o_&quot;))</span>
<span class="fc" id="L2661">				imageName = imageName.substring(2);</span>
<span class="fc bfc" id="L2662" title="All 2 branches covered.">			if (realPathSmall.indexOf(Tools.replace(Constants.getString(&quot;thumbServletCacheDir&quot;), &quot;/&quot;, String.valueOf(File.separatorChar) ))==-1)</span>
			{
				//toto vykoname len ak sa nejedna o thumb obrazok
				//ulozi obrazok do tabulky gallery, ak je uz ulozeny a nema nastaveny upload_datetime, tak ho nastavi
<span class="fc" id="L2666">				GalleryDB.setImage(fOrigImg.getVirtualParent(), imageName);</span>
			}

<span class="fc" id="L2669">			String realPathLC = realPath.toLowerCase();</span>
<span class="pc bpc" id="L2670" title="2 of 4 branches missed.">			if (fOrigImg.isFile() &amp;&amp; FileTools.isImage(realPathLC))</span>
			{
<span class="fc" id="L2672">				double scaleFactor = 0.3;</span>
				// opener = new Opener();
				// imp = opener.openImage(realPath);
<span class="fc" id="L2675">				ImageInfo originalImage = new ImageInfo();</span>
<span class="fc" id="L2676">				input=new IwcmInputStream(realPath);</span>
<span class="fc" id="L2677">				originalImage.setInput(input);</span>
<span class="fc" id="L2678">				originalImage.check();</span>
<span class="pc bpc" id="L2679" title="2 of 4 branches missed.">				if (originalImage.getWidth() &lt; 1 || originalImage.getHeight() &lt; 1)</span>
<span class="nc" id="L2680">					return (-4);</span>
				// BufferedImage originalImage = ImageIO.read(fOrigImg);
<span class="fc" id="L2682">				IwcmFile fDestDir = (new IwcmFile(realPathSmall)).getParentFile();</span>
<span class="fc bfc" id="L2683" title="All 2 branches covered.">				if (fDestDir.exists() == false)</span>
<span class="fc" id="L2684">					fDestDir.mkdirs();</span>
<span class="fc" id="L2685">				int w = (int) width;</span>
<span class="fc" id="L2686">				int h = (int) height;</span>
				// u crop suradnice laveho horneho rohu
<span class="fc" id="L2688">				int x = 0;</span>
<span class="fc" id="L2689">				int y = 0;</span>
<span class="fc" id="L2690">				int pom_w = 0;</span>
<span class="fc" id="L2691">				int pom_h = 0;</span>
<span class="fc" id="L2692">				double pomer = (double) originalImage.getWidth() / (double) originalImage.getHeight();</span>
<span class="fc" id="L2693">				boolean resizeAndCrop = false;</span>
<span class="fc bfc" id="L2694" title="All 2 branches covered.">				if (&quot;A&quot;.equals(resizeMode))</span>
				{// presny rozmer
				}
<span class="fc bfc" id="L2697" title="All 2 branches covered.">				else if (&quot;C&quot;.equals(resizeMode))</span>
				{
					// crop
<span class="pc bpc" id="L2700" title="1 of 4 branches missed.">					if (originalImage.getWidth() &gt; w &amp;&amp; originalImage.getHeight() &gt; h)</span>
					{
						// zmensit a orezat
<span class="fc" id="L2703">						pom_w = w;</span>
<span class="fc" id="L2704">						pom_h = h;</span>
<span class="fc" id="L2705">						resizeAndCrop = true;</span>
<span class="fc" id="L2706">						h = (int) Math.round(w * 1 / pomer);</span>
<span class="fc bfc" id="L2707" title="All 2 branches covered.">						if (h &lt; pom_h)</span>
						{
<span class="fc" id="L2709">							h = pom_h;</span>
<span class="fc" id="L2710">							w = (int) Math.round(h * pomer);</span>
							// orezeme so sirky
<span class="fc" id="L2712">							y = 0;</span>
<span class="fc" id="L2713">							x = (w - pom_w) / 2;</span>
						}
						else
						{
							// orezeme s vysky
<span class="fc" id="L2718">							x = 0;</span>
<span class="fc" id="L2719">							y = (h - pom_h) / 2;</span>
						}
					}
<span class="pc bpc" id="L2722" title="1 of 4 branches missed.">					else if (w &gt; originalImage.getWidth() &amp;&amp; h &lt;= originalImage.getHeight())</span>
					{
						// orezat z vysky
<span class="fc" id="L2725">						x = 0;</span>
<span class="fc" id="L2726">						w = originalImage.getWidth();</span>
<span class="fc" id="L2727">						y = (originalImage.getHeight() - h) / 2;</span>
					}
<span class="pc bpc" id="L2729" title="3 of 4 branches missed.">					else if (w &lt;= originalImage.getWidth() &amp;&amp; h &gt; originalImage.getHeight())</span>
					{
						// orezat so sirky
<span class="nc" id="L2732">						y = 0;</span>
<span class="nc" id="L2733">						h = originalImage.getHeight();</span>
<span class="nc" id="L2734">						x = (originalImage.getWidth() - w) / 2;</span>
					}
					else
					{

<span class="fc" id="L2739">						copyFile(realPath, realPathSmall);</span>
						//convertCmykToRgb(realPathSmall);
<span class="fc" id="L2741">						stripExif(realPathSmall);</span>

<span class="fc" id="L2743">						return (1);</span>
					}
					/*
					 * } else { w = originalImage.getWidth(); }
					 * if(originalImage.getHeight() &gt; h) { y =
					 * (originalImage.getHeight() - h)/2; } else { h =
					 * originalImage.getHeight(); }
					 */
				}
<span class="pc bpc" id="L2752" title="1 of 2 branches missed.">				else if (&quot;W&quot;.equals(resizeMode))</span>
				{// presna sirka
<span class="nc" id="L2754">					h = (int) Math.round(w * 1 / pomer);</span>
				}
<span class="pc bpc" id="L2756" title="1 of 2 branches missed.">				else if (&quot;H&quot;.equals(resizeMode))</span>
				{// presna vyska
<span class="nc" id="L2758">					w = (int) Math.round(h * pomer);</span>
				}
				else
				{
					// ak je obrazok uz teraz mensi, nerob nic
<span class="pc bpc" id="L2763" title="3 of 4 branches missed.">					if (originalImage.getWidth() &lt; w &amp;&amp; originalImage.getHeight() &lt; h)</span>
					{

						// skopiruj original na novy (ak bola nejaka operacia v
						// ImageTools)
<span class="nc" id="L2768">						copyFile(realPath, realPathSmall);</span>
						// skonvertuj do RGB ak treba a je nastavene
						//convertCmykToRgb(realPathSmall);

<span class="nc" id="L2772">						stripExif(realPathSmall);</span>
<span class="nc" id="L2773">						return (1);</span>
					}
<span class="pc bpc" id="L2775" title="3 of 4 branches missed.">					if (width &lt; 0 &amp;&amp; height &lt; 0)</span>
					{
<span class="nc" id="L2777">						w = (int) -width;</span>
<span class="nc" id="L2778">						h = (int) -height;</span>
					}
<span class="pc bpc" id="L2780" title="2 of 4 branches missed.">					else if (width &gt; 1 &amp;&amp; height &gt; 1)</span>
					{
<span class="fc" id="L2782">						scaleFactor = (width * 1.0) / (originalImage.getWidth() * 1.0);</span>
<span class="fc" id="L2783">						int newHeight = (int) (originalImage.getHeight() * scaleFactor);</span>
<span class="fc bfc" id="L2784" title="All 2 branches covered.">						if (newHeight &gt; height)</span>
						{
<span class="fc" id="L2786">							scaleFactor = (height * 1.0) / (originalImage.getHeight() * 1.0);</span>
<span class="fc" id="L2787">							w = (int) (originalImage.getWidth() * scaleFactor);</span>
<span class="fc" id="L2788">							h = (int) height;</span>
						}
						else
						{
<span class="fc" id="L2792">							w = (int) width;</span>
<span class="fc" id="L2793">							h = (int) (originalImage.getHeight() * scaleFactor);</span>
						}
<span class="fc" id="L2795">					}</span>
<span class="nc bnc" id="L2796" title="All 2 branches missed.">					else if (width &gt; 1)</span>
					{
<span class="nc" id="L2798">						scaleFactor = (width * 1.0) / (originalImage.getWidth() * 1.0);</span>
						// Logger.println(GalleryDB.class,&quot;scaleFactor: &quot; +
						// scaleFactor);
<span class="nc" id="L2801">						w = (int) width;</span>
<span class="nc" id="L2802">						h = (int) (originalImage.getHeight() * scaleFactor);</span>
					}
<span class="nc bnc" id="L2804" title="All 2 branches missed.">					else if (height &gt; 1)</span>
					{
<span class="nc" id="L2806">						scaleFactor = (height * 1.0) / (originalImage.getHeight() * 1.0);</span>
<span class="nc" id="L2807">						w = (int) (originalImage.getWidth() * scaleFactor);</span>
<span class="nc" id="L2808">						h = (int) height;</span>
					}
				}

<span class="fc" id="L2812">				w = GalleryDBTools.limitMaxSize(w);</span>
<span class="fc" id="L2813">				h = GalleryDBTools.limitMaxSize(h);</span>

<span class="fc bfc" id="L2815" title="All 2 branches covered.">				if (fSmallImg.exists())</span>
				{
					//netreba, convert subor prepise fSmallImg.delete();
				}
<span class="fc" id="L2819">				String imageMagickDir = getImageMagicDir();</span>
				// mame ho aj dostupny
<span class="fc" id="L2821">				boolean convertExists = false;</span>
<span class="fc" id="L2822">				String runtimeFile = getRuntimeFile();</span>

<span class="pc bpc" id="L2824" title="1 of 2 branches missed.">				if (Tools.isNotEmpty(imageMagickDir))</span>
				{
<span class="fc" id="L2826">					File f = new File(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="pc bpc" id="L2827" title="3 of 4 branches missed.">					if (f.exists() &amp;&amp; f.canRead())</span>
					{
<span class="nc" id="L2829">						convertExists = true;</span>
					}
				}
<span class="pc bpc" id="L2832" title="1 of 2 branches missed.">				if (Tools.isNotEmpty(imageMagickDir)</span>
<span class="fc bfc" id="L2833" title="All 4 branches covered.">							&amp;&amp; (originalImage.getWidth() &gt; 500 || originalImage.getHeight() &gt; 500 || Constants</span>
<span class="pc bpc" id="L2834" title="2 of 4 branches missed.">										.getBoolean(&quot;galleryAlwaysUseImageMagick&quot;)) &amp;&amp; convertExists)</span>
				{
<span class="nc" id="L2836">					Logger.debug(GalleryDB.class, &quot;executing image magick: &quot; + imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="nc" id="L2837">					Runtime rt = Runtime.getRuntime();</span>
<span class="nc" id="L2838">					File resizePomFile = null;</span>
<span class="nc" id="L2839">					List&lt;String&gt; args = null;</span>
<span class="nc" id="L2840">					boolean galleryStripExif = Constants.getBoolean(&quot;galleryStripExif&quot;);</span>

<span class="nc" id="L2842">					String pripona = realPathSmall.substring(realPathSmall.lastIndexOf('.'));</span>

<span class="nc bnc" id="L2844" title="All 2 branches missed.">					if (&quot;C&quot;.equals(resizeMode))</span>
					{
						// crop image
<span class="nc bnc" id="L2847" title="All 2 branches missed.">						if (resizeAndCrop)</span>
						{
							// zmensit a orezat
							// longCmd = imageMagickDir + File.separatorChar +
							// runtimeFile + &quot; '&quot; + realPath + &quot;' -resize &quot; + w + &quot;x&quot; +
							// h + &quot;! '&quot; + realPathSmall+&quot;_pomresize'&quot;;
<span class="nc" id="L2853">							String pomresize = Tools.replace(realPathSmall, pripona, &quot;.pomresize&quot; + pripona);</span>
<span class="nc" id="L2854">							args = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L2856" title="All 2 branches missed.">							if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(realPath)))</span>
							{
<span class="nc" id="L2858">								IwcmFsDB.writeFileToDisk(new File(realPath),new File(IwcmFsDB.getTempFilePath(realPath)));</span>
<span class="nc" id="L2859">								args.add(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="nc" id="L2860">								args.add(IwcmFsDB.getTempFilePath(realPath));</span>
<span class="nc" id="L2861">								args.add(&quot;-resize&quot;);</span>
<span class="nc" id="L2862">								args.add(w + &quot;x&quot; + h + &quot;!&quot;);</span>
<span class="nc bnc" id="L2863" title="All 2 branches missed.">								if (galleryStripExif) args.add(&quot;-strip&quot;);</span>
<span class="nc bnc" id="L2864" title="All 2 branches missed.">								if (&quot;gif&quot;.equalsIgnoreCase(pripona)) args.add(&quot;+repage&quot;);</span>
<span class="nc" id="L2865">								args.add(IwcmFsDB.getTempFilePath(pomresize));</span>
							}
							else
							{
<span class="nc" id="L2869">								args.add(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="nc" id="L2870">								args.add(realPath);</span>
<span class="nc" id="L2871">								args.add(&quot;-resize&quot;);</span>
<span class="nc" id="L2872">								args.add(w + &quot;x&quot; + h + &quot;!&quot;);</span>
<span class="nc bnc" id="L2873" title="All 2 branches missed.">								if (galleryStripExif) args.add(&quot;-strip&quot;);</span>
<span class="nc bnc" id="L2874" title="All 2 branches missed.">								if (&quot;gif&quot;.equalsIgnoreCase(pripona)) args.add(&quot;+repage&quot;);</span>
<span class="nc" id="L2875">								args.add(pomresize);</span>
							}

<span class="nc" id="L2878">							StringBuilder params = new StringBuilder();</span>
<span class="nc bnc" id="L2879" title="All 2 branches missed.">							if (args != null)</span>
							{
<span class="nc bnc" id="L2881" title="All 2 branches missed.">								for (int i = 0; i &lt; args.size(); i++)</span>
								{
<span class="nc" id="L2883">									params.append(' ').append(args.get(i));</span>
								}
							}
<span class="nc" id="L2886">							Logger.debug(GalleryDB.class, &quot;LONGCMD:\n&quot; + params);</span>
<span class="nc" id="L2887">							Process proc = rt.exec(args.toArray(new String[0]));</span>
<span class="nc" id="L2888">							InputStream stderr = proc.getErrorStream();</span>
<span class="nc" id="L2889">							BufferedReader br = new BufferedReader(new InputStreamReader(stderr, Constants.FILE_ENCODING));</span>
<span class="nc" id="L2890">							String line = null;</span>
<span class="nc bnc" id="L2891" title="All 2 branches missed.">							while ((line = br.readLine()) != null)</span>
							{
<span class="nc" id="L2893">								Logger.debug(GalleryDB.class, line);</span>
							}
<span class="nc" id="L2895">							br.close();</span>
<span class="nc" id="L2896">							int exitValue = proc.waitFor();</span>
<span class="nc" id="L2897">							Logger.debug(GalleryDB.class, &quot;ExitValue: &quot; + exitValue);</span>
							// longCmd = imageMagickDir + File.separatorChar +
							// runtimeFile +&quot; '&quot; + realPathSmall+&quot;_pomresize&quot; + &quot;' '&quot; +
							// realPath + &quot;' -crop &quot; + w + &quot;x&quot; + h + &quot;+&quot;+ x + &quot;+&quot; + y +
							// &quot; -crop &quot; + w + &quot;x&quot; + h + &quot;-&quot;+ x + &quot;-&quot; + y +&quot; '&quot;+
							// realPathSmall+&quot;'&quot;;

<span class="nc" id="L2904">							args = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2905" title="All 2 branches missed.">							if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(realPath)))</span>
							{
<span class="nc" id="L2907">								args.add(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="nc" id="L2908">								args.add(IwcmFsDB.getTempFilePath(pomresize));</span>
<span class="nc" id="L2909">								args.add(&quot;-crop&quot;);</span>
<span class="nc" id="L2910">								args.add((int) width + &quot;x&quot; + (int) height + &quot;+&quot; + x + &quot;+&quot; + y);</span>
<span class="nc bnc" id="L2911" title="All 2 branches missed.">								if (galleryStripExif) args.add(&quot;-strip&quot;);</span>
<span class="nc bnc" id="L2912" title="All 2 branches missed.">								if (&quot;gif&quot;.equalsIgnoreCase(pripona)) args.add(&quot;+repage&quot;);</span>
<span class="nc" id="L2913">								args.add(IwcmFsDB.getTempFilePath(realPathSmall));</span>
							}
							else
							{
<span class="nc" id="L2917">								args.add(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="nc" id="L2918">								args.add(pomresize);</span>
								// args[2] = realPath;
<span class="nc" id="L2920">								args.add(&quot;-crop&quot;);</span>
<span class="nc" id="L2921">								args.add((int) width + &quot;x&quot; + (int) height + &quot;+&quot; + x + &quot;+&quot; + y);</span>
								// args[5] = &quot;-crop&quot;;
								// args[6] = w + &quot;x&quot; + h + &quot;-&quot;+ x + &quot;-&quot; + y;
<span class="nc bnc" id="L2924" title="All 2 branches missed.">								if (galleryStripExif) args.add(&quot;-strip&quot;);</span>
<span class="nc bnc" id="L2925" title="All 2 branches missed.">								if (&quot;gif&quot;.equalsIgnoreCase(pripona)) args.add(&quot;+repage&quot;);</span>
<span class="nc" id="L2926">								args.add(realPathSmall);</span>
							}
<span class="nc" id="L2928">							resizePomFile = new File(pomresize);</span>
<span class="nc" id="L2929">						}</span>
						else
						{
							// iba orezat
							// longCmd = imageMagickDir + File.separatorChar +
							// runtimeFile + &quot; '&quot; + realPath + &quot;' -crop &quot; +
							// originalImage.getWidth() + &quot;x&quot; +
							// originalImage.getHeight() + &quot;+&quot;+ x + &quot;+&quot; + y + &quot; -crop &quot;
							// + originalImage.getWidth() + &quot;x&quot; +
							// originalImage.getHeight() + &quot;-&quot;+ x + &quot;-&quot; + y +&quot; '&quot;+
							// realPathSmall+&quot;'&quot;;
<span class="nc" id="L2940">							args = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2941" title="All 2 branches missed.">							if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(realPath)))</span>
							{
<span class="nc" id="L2943">								IwcmFsDB.writeFileToDisk(new File(realPath),new File(IwcmFsDB.getTempFilePath(realPath)));</span>
<span class="nc" id="L2944">								args.add(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="nc" id="L2945">								args.add(IwcmFsDB.getTempFilePath(realPath));</span>
<span class="nc" id="L2946">								args.add(&quot;-crop&quot;);</span>
<span class="nc" id="L2947">								args.add((int) width + &quot;x&quot; + (int) height + &quot;+&quot; + x + &quot;+&quot; + y);</span>
<span class="nc bnc" id="L2948" title="All 2 branches missed.">								if (galleryStripExif) args.add(&quot;-strip&quot;);</span>
<span class="nc bnc" id="L2949" title="All 2 branches missed.">								if (&quot;gif&quot;.equalsIgnoreCase(pripona)) args.add(&quot;+repage&quot;);</span>
<span class="nc" id="L2950">								args.add(IwcmFsDB.getTempFilePath(realPathSmall));</span>
							}
							else
							{
<span class="nc" id="L2954">								args.add(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="nc" id="L2955">								args.add(realPath);</span>
<span class="nc" id="L2956">								args.add(&quot;-crop&quot;);</span>
<span class="nc" id="L2957">								args.add((int) width + &quot;x&quot; + (int) height + &quot;+&quot; + x + &quot;+&quot; + y);</span>
								// args[5] = &quot;-crop&quot;;
								// args[6] = originalImage.getWidth() + &quot;x&quot; +
								// originalImage.getHeight() + &quot;-&quot;+ x + &quot;-&quot; + y;
<span class="nc bnc" id="L2961" title="All 2 branches missed.">								if (galleryStripExif) args.add(&quot;-strip&quot;);</span>
<span class="nc bnc" id="L2962" title="All 2 branches missed.">								if (&quot;gif&quot;.equalsIgnoreCase(pripona)) args.add(&quot;+repage&quot;);</span>
<span class="nc" id="L2963">								args.add(realPathSmall);</span>
							}
						}
					}
					else
					{
						// longCmd = imageMagickDir + File.separatorChar + runtimeFile
						// + &quot; '&quot; + realPath + &quot;' -resize &quot; + w + &quot;x&quot; + h + &quot;! '&quot; +
						// realPathSmall+&quot;'&quot;;
<span class="nc" id="L2972">						args = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2973" title="All 2 branches missed.">						if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(realPath)))</span>
						{
<span class="nc" id="L2975">							IwcmFsDB.writeFileToDisk(new File(realPath),new File(IwcmFsDB.getTempFilePath(realPath)));</span>
<span class="nc" id="L2976">							args.add(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="nc" id="L2977">							args.add(IwcmFsDB.getTempFilePath(realPath));</span>
<span class="nc" id="L2978">							args.add(&quot;-resize&quot;);</span>
<span class="nc" id="L2979">							args.add(w + &quot;x&quot; + h + &quot;!&quot;);</span>
<span class="nc bnc" id="L2980" title="All 2 branches missed.">							if (galleryStripExif) args.add(&quot;-strip&quot;);</span>
<span class="nc bnc" id="L2981" title="All 2 branches missed.">							if (&quot;gif&quot;.equalsIgnoreCase(pripona)) args.add(&quot;+repage&quot;);</span>
<span class="nc bnc" id="L2982" title="All 2 branches missed.">							if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(realPathSmall))) args.add(IwcmFsDB.getTempFilePath(realPathSmall));</span>
<span class="nc" id="L2983">							else args.add(realPathSmall);</span>
						}
						else
						{
<span class="nc" id="L2987">							args.add(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="nc" id="L2988">							args.add(realPath);</span>
<span class="nc" id="L2989">							args.add(&quot;-resize&quot;);</span>
<span class="nc" id="L2990">							args.add(w + &quot;x&quot; + h + &quot;!&quot;);</span>
<span class="nc bnc" id="L2991" title="All 2 branches missed.">							if (galleryStripExif) args.add(&quot;-strip&quot;);</span>
<span class="nc bnc" id="L2992" title="All 2 branches missed.">							if (&quot;gif&quot;.equalsIgnoreCase(pripona)) args.add(&quot;+repage&quot;);</span>
<span class="nc" id="L2993">							args.add(realPathSmall);</span>
						}
					}
<span class="nc" id="L2996">					String params = &quot;&quot;;</span>
<span class="nc bnc" id="L2997" title="All 2 branches missed.">					if (args != null)</span>
					{
<span class="nc" id="L2999">						StringBuilder buf = new StringBuilder();</span>
<span class="nc bnc" id="L3000" title="All 2 branches missed.">						for (int i = 0; i &lt; args.size(); i++)</span>
						{
<span class="nc" id="L3002">							buf.append(' ').append(args.get(i));</span>
						}
<span class="nc" id="L3004">						params = buf.toString();</span>
					}
<span class="nc" id="L3006">					Logger.debug(GalleryDB.class, &quot;LONGCMD:\n&quot; + params);</span>
<span class="nc" id="L3007">					Process proc = rt.exec(args.toArray(new String[0]));</span>
<span class="nc" id="L3008">					Logger.debug(GalleryDB.class, &quot;executed&quot;);</span>
<span class="nc" id="L3009">					InputStream stderr = proc.getErrorStream();</span>
<span class="nc" id="L3010">					BufferedReader br = new BufferedReader(new InputStreamReader(stderr, Constants.FILE_ENCODING));</span>
<span class="nc" id="L3011">					String line = null;</span>
<span class="nc bnc" id="L3012" title="All 2 branches missed.">					while ((line = br.readLine()) != null)</span>
					{
<span class="nc" id="L3014">						Logger.debug(GalleryDB.class, line);</span>
					}
<span class="nc" id="L3016">					br.close();</span>
<span class="nc" id="L3017">					int exitValue = proc.waitFor();</span>
<span class="nc" id="L3018">					Logger.debug(GalleryDB.class, &quot;ExitValue: &quot; + exitValue);</span>

<span class="nc bnc" id="L3020" title="All 2 branches missed.">					if (resizePomFile != null)</span>
<span class="nc bnc" id="L3021" title="All 2 branches missed.">						if(resizePomFile.delete() == false) return 3;</span>

<span class="nc bnc" id="L3023" title="All 2 branches missed.">					if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(realPathSmall)))</span>
					{
<span class="nc" id="L3025">						IwcmFsDB.writeFileToDB(new File(IwcmFsDB.getTempFilePath(realPathSmall)), new File(realPathSmall));</span>
<span class="nc bnc" id="L3026" title="All 2 branches missed.">						if(new File(IwcmFsDB.getTempFilePath(realPathSmall)).delete() == false) return 3;</span>
<span class="nc bnc" id="L3027" title="All 2 branches missed.">						if(new File(IwcmFsDB.getTempFilePath(realPath)).delete() == false) return 3;</span>
					}

<span class="nc bnc" id="L3030" title="All 2 branches missed.">					if (exitValue == 0)</span>
					{
<span class="nc" id="L3032">						performWatermarking(realPathSmall);</span>
<span class="nc" id="L3033">						return (0);</span>
					}
					else
<span class="nc" id="L3036">						return (3);</span>
				}
				else
				{
<span class="fc" id="L3040">					IwcmInputStream iwStream =  new IwcmInputStream(fOrigImg.getPath(), false);</span>
<span class="fc" id="L3041">					BufferedImage originalBufferedImage = ImageIO.read(iwStream);</span>
<span class="fc" id="L3042">					iwStream.close();</span>
					// Logger.println(GalleryDB.class,&quot;w=&quot;+w+&quot; h=&quot;+h);
<span class="fc" id="L3044">					int scaleType = Image.SCALE_AREA_AVERAGING;</span>
<span class="fc bfc" id="L3045" title="All 2 branches covered.">					if (originalImage.getWidth() &gt; 1000)</span>
					{
<span class="fc" id="L3047">						Logger.debug(GalleryDB.class, &quot;smooth resize&quot;);</span>
<span class="fc" id="L3048">						scaleType = Image.SCALE_SMOOTH;</span>
					}
					// toto je pre ThumbServlet
<span class="fc bfc" id="L3051" title="All 2 branches covered.">					if (realPathSmall.indexOf(Constants.getString(&quot;thumbServletCacheDir&quot;)) != -1)</span>
<span class="fc" id="L3052">						scaleType = Image.SCALE_FAST;</span>
<span class="pc bpc" id="L3053" title="1 of 2 branches missed.">					if (originalImage.getWidth() &gt; 2000)</span>
					{
						// Logger.debug(GalleryDB.class,&quot;smooth fast&quot;);
						// scaleType = Image.SCALE_FAST;
					}
<span class="fc" id="L3058">					DebugTimer timer = new DebugTimer(&quot;ImageResize&quot;);</span>
<span class="fc" id="L3059">					timer.diff(&quot;starting: &quot; + scaleType);</span>
<span class="fc" id="L3060">					Image smallImage = null;</span>
<span class="fc bfc" id="L3061" title="All 2 branches covered.">					if (&quot;C&quot;.equals(resizeMode))</span>
					{// crop image
<span class="fc bfc" id="L3063" title="All 2 branches covered.">						if (resizeAndCrop)</span>
						{// zmensit a orezat
<span class="fc" id="L3065">							smallImage = originalBufferedImage.getScaledInstance(w, h, scaleType);</span>
<span class="fc" id="L3066">							BufferedImage bi = new BufferedImage(w, h, BufferedImage.TYPE_INT_RGB);</span>
<span class="fc" id="L3067">							Graphics2D g = bi.createGraphics();</span>
<span class="fc" id="L3068">							g.drawImage(smallImage, 0, 0, null);</span>
<span class="fc" id="L3069">							smallImage = bi.getSubimage(x, y, pom_w, pom_h);</span>
<span class="fc" id="L3070">							w = pom_w;</span>
<span class="fc" id="L3071">							h = pom_h;</span>
<span class="fc" id="L3072">						}</span>
						else
						{// iba orezat
<span class="fc" id="L3075">							smallImage = originalBufferedImage.getSubimage(x, y, w, h);</span>
						}
					}
					else
					{
<span class="fc" id="L3080">						smallImage = originalBufferedImage.getScaledInstance(w, h, scaleType);</span>
					}
<span class="fc" id="L3082">					timer.diff(&quot;scaled&quot;);</span>
<span class="fc" id="L3083">					BufferedImage bufSmall = new BufferedImage(w, h, BufferedImage.TYPE_INT_RGB);</span>
<span class="fc" id="L3084">					timer.diff(&quot;buf created&quot;);</span>
					// bufSmall.getGraphics().drawImage(smallImage, 0, 0, null);
<span class="fc" id="L3086">					bufSmall.createGraphics().drawImage(smallImage, 0, 0, null);</span>
<span class="fc" id="L3087">					timer.diff(&quot;image drawed&quot;);</span>
<span class="fc" id="L3088">					bufSmall.getGraphics().dispose();</span>
<span class="fc" id="L3089">					timer.diff(&quot;disposed&quot;);</span>
					try
					{
<span class="fc" id="L3092">						ImageWriteParam iwparam = null;</span>
						// ImageIO.write(bufSmall, format,iwparam, fSmallImg);
						// Jimi.putImage(&quot;image/&quot; + type, image, realPathSmall);
<span class="fc" id="L3095">						ImageWriter writer = null;</span>

<span class="fc" id="L3097">						String format = &quot;jpg&quot;;</span>
<span class="fc bfc" id="L3098" title="All 2 branches covered.">                        if (realPathLC.endsWith(&quot;.png&quot;))</span>
                        {
<span class="fc" id="L3100">                            format = &quot;png&quot;;</span>
                        }
                        else
                        {
<span class="fc" id="L3104">                            iwparam = new JPEGImageWriteParam(null);</span>
<span class="fc" id="L3105">                            iwparam.setCompressionMode(ImageWriteParam.MODE_EXPLICIT);</span>
<span class="fc" id="L3106">                            iwparam.setCompressionQuality(0.85F);</span>
                        }

<span class="fc" id="L3109">						Iterator&lt;ImageWriter&gt; iter = ImageIO.getImageWritersByFormatName(format);</span>
<span class="pc bpc" id="L3110" title="1 of 2 branches missed.">						if (iter.hasNext())</span>
						{
<span class="fc" id="L3112">							writer = iter.next();</span>
						}
<span class="pc bpc" id="L3114" title="1 of 2 branches missed.">						if (writer != null) {</span>
							// Prepare output file
<span class="fc" id="L3116">							IwcmOutputStream out = new IwcmOutputStream(fSmallImg.getPath());</span>
<span class="fc" id="L3117">							ImageOutputStream ios = ImageIO.createImageOutputStream(out);</span>
<span class="fc" id="L3118">							writer.setOutput(ios);</span>
<span class="fc" id="L3119">							timer.diff(&quot;write start&quot;);</span>
							// Write the image
<span class="fc" id="L3121">							writer.write(null, new IIOImage(bufSmall, null, null), iwparam);</span>
<span class="fc" id="L3122">							timer.diff(&quot;writed to file&quot;);</span>
							// Cleanup
<span class="fc" id="L3124">							ios.flush();</span>
<span class="fc" id="L3125">							writer.dispose();</span>
<span class="fc" id="L3126">							ios.close();</span>
<span class="fc" id="L3127">							out.close();</span>
						}
<span class="fc" id="L3129">						return (0);</span>
					}
<span class="nc" id="L3131">					catch (Exception ex)</span>
					{
<span class="nc" id="L3133">						sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L3134">						return (2);</span>
					}
				}
			}
		}
<span class="nc" id="L3139">		catch (javax.imageio.IIOException ex)</span>
		{
<span class="nc" id="L3141">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L3142">			return (4);</span>
		}
<span class="nc" id="L3144">		catch (Exception ex)</span>
		{
<span class="nc" id="L3146">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
<span class="pc bpc" id="L3150" title="1 of 2 branches missed.">			if (input!=null)</span>
			{
				try
				{
<span class="fc" id="L3154">				input.close();</span>
				}
<span class="nc" id="L3156">				catch (Exception e) {</span>
<span class="nc" id="L3157">					sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L3158">				}</span>
			}
		}
<span class="nc" id="L3161">		return (3);</span>
	}

	/**
	 * @param runtimeFile
	 * @return
	 */
	public static String getRuntimeFile()
	{
<span class="fc" id="L3170">		String result = &quot;convert&quot;;</span>
<span class="pc bpc" id="L3171" title="1 of 2 branches missed.">		if (System.getProperty(&quot;os.name&quot;).indexOf(&quot;Windows&quot;) != -1)</span>
		{
<span class="nc" id="L3173">			result  = &quot;convert.exe&quot;;</span>
		}
<span class="fc" id="L3175">		return result ;</span>
	}

	public static String getImageMagicDir()
	{
<span class="fc" id="L3180">		return Constants.getString(&quot;imageMagickDir&quot;);</span>
	}

	/**
	 * Vrati linku na obrazok so zadanym prefixom
	 *
	 * @param prefix
	 * @param fullPath
	 * @return
	 */
	public static String getImagePathPrefix(String prefix, String fullPath)
	{
<span class="nc" id="L3192">		return GalleryToolsForCore.getImagePathPrefix(prefix,fullPath);</span>
	}

	/**
	 * Vrati malu verziu obrazku z galerie (ak existuje)
	 *
	 * @param fullPath
	 * @return
	 */
	public static String getImagePathSmall(String fullPath)
	{
<span class="nc" id="L3203">		return GalleryToolsForCore.getImagePathSmall(fullPath);</span>
	}

	/**
	 * Vrati velku verziu obrazku z galerie (ak existuje)
	 *
	 * @param fullPath
	 * @return
	 */
	public static String getImagePathNormal(String fullPath)
	{
<span class="nc" id="L3214">		return GalleryToolsForCore.getImagePathNormal(fullPath);</span>
	}

	public static String getImagePathOriginal(String fullPath)
	{
<span class="fc" id="L3219">		return GalleryToolsForCore.getImagePathOriginal(fullPath);</span>
	}

	/**
	 * Normalizuje cestu k adresaru (v DB v tabulke gallery_dimension), odstrani
	 * koncove lomitko
	 *
	 * @param url
	 * @return
	 */
	private static String normalizeDir(String url)
	{
<span class="pc bpc" id="L3231" title="1 of 2 branches missed.">		if (url.endsWith(&quot;/&quot;))</span>
<span class="nc" id="L3232">			return (url.substring(0, url.length() - 1));</span>
<span class="fc" id="L3233">		return (url);</span>
	}

	/**
	 * Vytvori adresar galerie so zadanymi rozmermi (nastavi ich do databazy)
	 *
	 * @param url
	 * @param width
	 * @param height
	 * @param normalWidth
	 * @param normalHeight
	 * @return
	 */
	public static boolean createGalleryFolder(String url, int width, int height, int normalWidth, int normalHeight)
	{
<span class="nc" id="L3248">		IwcmFile f = new IwcmFile(Tools.getRealPath(url));</span>
<span class="nc" id="L3249">		f.mkdirs();</span>
<span class="nc" id="L3250">		Adminlog.add(Adminlog.TYPE_GALLERY, &quot;Create gallery folder: url= &quot; + url + &quot; w=&quot; + width + &quot; h=&quot; + height + &quot; nw=&quot; + normalWidth + &quot; nh=&quot; + normalHeight, -1, -1);</span>
<span class="nc" id="L3251">		Dimension dim = new Dimension(width, height);</span>
<span class="nc" id="L3252">		Dimension normalDim = new Dimension(normalWidth, normalHeight);</span>
<span class="nc" id="L3253">		changeDimension(Constants.getServletContext(), url, dim, normalDim, null, null, null);</span>
<span class="nc" id="L3254">		return (false);</span>
	}

	/**
	 * Otestuje, ci zadany adresar je galeria
	 *
	 * @param galleryFolderUrl
	 * @return
	 */
	public static boolean isGalleryFolder(String galleryFolderUrl)
	{
<span class="fc" id="L3265">		galleryFolderUrl = galleryFolderUrl.replace('\\', '/');</span>
<span class="fc bfc" id="L3266" title="All 2 branches covered.">		if (galleryFolderUrl.indexOf(&quot;/&quot; + Constants.getString(&quot;galleryDirName&quot;)) != -1)</span>
<span class="fc" id="L3267">			return (true);</span>
		// skus zistit, ci mame dany adresar v databaze
<span class="fc" id="L3269">		Dimension[] dim = getDimension(galleryFolderUrl, true, false);</span>
<span class="pc bpc" id="L3270" title="3 of 4 branches missed.">		if (dim[0] != null &amp;&amp; dim[1] != null)</span>
<span class="nc" id="L3271">			return (true);</span>
<span class="fc" id="L3272">		return (false);</span>
	}
	/**
	 * Increments send_count for image identified by imgPath
	 * @param imgPath
	 */
	public static void incSendCount(HttpServletRequest request, String imgPath)
	{


<span class="nc" id="L3282">		java.sql.Connection db_conn = null;</span>
<span class="nc" id="L3283">		java.sql.PreparedStatement ps = null;</span>

<span class="nc" id="L3285">		ResultSet rs  = null;</span>
<span class="nc" id="L3286">		int imageId = -1;</span>
		try
		{

<span class="nc" id="L3290">			db_conn = DBPool.getConnection();</span>
<span class="nc" id="L3291">			ps = db_conn.prepareStatement(&quot;select image_id from gallery where image_path = ? and image_name = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L3292">			ps.setString(1,imgPath.substring(0,imgPath.lastIndexOf('/')));</span>
<span class="nc" id="L3293">			ps.setString(2, imgPath.substring(imgPath.lastIndexOf('/')+1));</span>
<span class="nc" id="L3294">			rs=ps.executeQuery();</span>

<span class="nc bnc" id="L3296" title="All 2 branches missed.">			if (rs.next())</span>
			{
<span class="nc" id="L3298">				imageId=rs.getInt(&quot;image_id&quot;);</span>
			}
<span class="nc" id="L3300">			rs.close();</span>
<span class="nc" id="L3301">			rs = null;</span>
<span class="nc" id="L3302">			ps.close();</span>
<span class="nc bnc" id="L3303" title="All 2 branches missed.">			if (imageId&gt;0) //ak existuje robime update</span>
			{
<span class="nc" id="L3305">				ps = db_conn.prepareStatement(&quot;update gallery set send_count = send_count + 1 where image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L3306">				ps.setInt(1, imageId);</span>
<span class="nc" id="L3307">				ps.executeUpdate();</span>
			}
			else //inak insert noveho zaznamu
			{
<span class="nc" id="L3311">				ps = db_conn.prepareStatement(&quot;insert into gallery  (image_path,image_name,send_count, domain_id) values (?,?,1,?)&quot;);</span>

<span class="nc" id="L3313">				ps.setString(1, imgPath.substring(0,imgPath.lastIndexOf('/')));</span>
<span class="nc" id="L3314">				ps.setString(2, imgPath.substring(imgPath.lastIndexOf('/')+1));</span>
<span class="nc" id="L3315">				ps.setInt(3, CloudToolsForCore.getDomainId());</span>
<span class="nc" id="L3316">				ps.executeUpdate();</span>
			}

<span class="nc" id="L3319">			ps.close();</span>
<span class="nc" id="L3320">			db_conn.close();</span>
<span class="nc" id="L3321">			ps = null;</span>
<span class="nc" id="L3322">			db_conn = null;</span>
		}
<span class="nc" id="L3324">		catch (Exception ex)</span>
		{
<span class="nc" id="L3326">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L3332" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L3333">					rs.close();</span>
<span class="nc bnc" id="L3334" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L3335">					ps.close();</span>
<span class="nc bnc" id="L3336" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L3337">					db_conn.close();</span>
			}
<span class="nc" id="L3339">			catch (Exception ex2)</span>
			{
<span class="nc" id="L3341">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L3342">			}</span>
		}
<span class="nc" id="L3344">	}</span>

	/**
	 * Test, ci je mozne pohladnicu poslat na zadany email
	 * @param email - email adresa prijemcu
	 * @param gBean - gallery bean
	 * @return
	 */
	public static boolean canSendToEmail(String email, GalleryBean gBean)
	{
<span class="nc bnc" id="L3354" title="All 2 branches missed.">		if (Tools.isEmail(email)==false) return false;</span>
<span class="nc bnc" id="L3355" title="All 2 branches missed.">		if (gBean == null) return false;</span>
<span class="nc bnc" id="L3356" title="All 2 branches missed.">		if (Tools.isEmpty(gBean.getAllowedDomains())) return true;</span>

<span class="nc" id="L3358">		email = email.toLowerCase();</span>
<span class="nc" id="L3359">		StringTokenizer st = new StringTokenizer(gBean.getAllowedDomains(), &quot;,+\n&quot;);</span>
<span class="nc bnc" id="L3360" title="All 2 branches missed.">		while (st.hasMoreTokens())</span>
		{
<span class="nc" id="L3362">			String domain = st.nextToken().toLowerCase();</span>
<span class="nc bnc" id="L3363" title="All 2 branches missed.">			if (email.endsWith(domain)) return true;</span>
<span class="nc" id="L3364">		}</span>

<span class="nc" id="L3366">		return false;</span>
	}

	/**
	 * Vrati atribut perex_group obrazka s identifikatorom imageId v String tvare, cize nieco ako ,45,12,13, kde cisla su identifikatory perex skupin
	 * @author kmarton
	 *
	 * @param imageId	identifikator obrazka, pre ktory chceme zistit jeho perex skupiny. Musi byt vacsi ako 0.
	 * @return
	 */
	public static String getImagePerexGroupString(int imageId)
	{
<span class="nc" id="L3378">		return (new SimpleQuery().forString(&quot;SELECT perex_group FROM gallery WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), imageId));</span>
	}

	/**
	 * Nastavi atribut perex_group podla perexGroupString obrazku s identifikatorom imageId
	 * @author kmarton
	 *
	 * @param perexGroupString		retazec v tvare ,perexGroupId,perexGroupId,perexGroupId... nieco ako ,15,16,7,
	 * @param imageId					identifikator obrazku, ktoremu chceme nastavit pozadovany perexGroupString
	 */
	public static void setImagePerexGroupString(String perexGroupString, int imageId)
	{
<span class="nc bnc" id="L3390" title="All 2 branches missed.">		if (imageId &lt; 1)</span>
<span class="nc" id="L3391">			return;</span>
		try
		{
<span class="nc" id="L3394">			new SimpleQuery().execute(&quot;UPDATE gallery SET perex_group = ? WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), perexGroupString, imageId);</span>
		}
<span class="nc" id="L3396">		catch (Exception e)</span>
		{
<span class="nc" id="L3398">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L3399">		}</span>
<span class="nc" id="L3400">	}</span>

	/**
	 * Prida existujucemu obrazku s identifikatorom taggedImageInt identifikator perex skupiny tagPerexGroupId.
	 * Obsahuje kontrolu, ci uz obrazok perexGroupu nahodou neobsahuje. Ak ano, tak ju nepridava.
	 *
	 * @author kmarton
	 *
	 * @param 	taggedImageInt	Identifikator obrazka, ktoremu sa doplni perex skupina
	 * @param 	tagPerexGroupId	Identifikator perex skupiny, ktora sa doplni k uz existujucim perex skupina obrazka
	 *
	 * @return	Vrati true ak sa operacia podarila, inak vrati false
	 */
	public static boolean addPerexGroup(int taggedImageInt, int tagPerexGroupId)
	{
		try
		{
<span class="nc" id="L3417">   		String existPerexGroupString = GalleryDB.getImagePerexGroupString(taggedImageInt);</span>
<span class="nc bnc" id="L3418" title="All 2 branches missed.">   		if (Tools.isEmpty(existPerexGroupString))</span>
<span class="nc" id="L3419">   			existPerexGroupString = &quot;,&quot;;</span>
<span class="nc bnc" id="L3420" title="All 2 branches missed.">   		if (existPerexGroupString.indexOf(&quot;,&quot; + tagPerexGroupId + &quot;,&quot;) == -1)	 //kontrola, ci uz danu perexGroupu nahodou neobsahuje. Ak ano, tak nepridavam</span>
<span class="nc" id="L3421">   			GalleryDB.setImagePerexGroupString((existPerexGroupString + tagPerexGroupId + &quot;,&quot;), taggedImageInt);</span>
<span class="nc" id="L3422">   		return true;</span>
		}
<span class="nc" id="L3424">		catch (Exception ex)</span>
		{
<span class="nc" id="L3426">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L3427">			return false;</span>
		}
	}

	/**
	 * Odoberie existujucemu obrazku s identifikatorom taggedImageInt identifikator perex skupiny tagPerexGroupId.
	 * Ak obrazok danu perex skupinu neobsahuje, nevykona sa nic a vrati sa true.
	 *
	 * @author kmarton
	 *
	 * @param 	taggedImageInt	Identifikator obrazka, ktoremu sa odoberie perex skupina
	 * @param 	tagPerexGroupId	Identifikator perex skupiny, ktora sa odoberie z uz existujucich perex skupina obrazka
	 *
	 * @return	Vrati true ak sa operacia podarila, inak vrati false
	 */
	public static boolean removePerexGroup(int taggedImageInt, int tagPerexGroupId)
	{
		try
		{
<span class="nc" id="L3446">   		String existPerexGroupString = GalleryDB.getImagePerexGroupString(taggedImageInt);</span>
<span class="nc bnc" id="L3447" title="All 2 branches missed.">   		if (Tools.isEmpty(existPerexGroupString))</span>
<span class="nc" id="L3448">   			return true;</span>

<span class="nc bnc" id="L3450" title="All 2 branches missed.">   		if (existPerexGroupString.indexOf(&quot;,&quot; + tagPerexGroupId + &quot;,&quot;) != -1)	 //odstrani skupinu, len ak ju obsahuje</span>
<span class="nc" id="L3451">   			GalleryDB.setImagePerexGroupString((existPerexGroupString.replace(tagPerexGroupId + &quot;,&quot;, &quot;&quot;)), taggedImageInt);</span>
<span class="nc bnc" id="L3452" title="All 2 branches missed.">   		if (GalleryDB.getImagePerexGroupString(taggedImageInt).length() &lt; 3)// ak bola nastavena iba jedna skupina, zmaz vsetky zvysne ciarky</span>
<span class="nc" id="L3453">   			GalleryDB.setImagePerexGroupString(&quot;&quot;, taggedImageInt);</span>
<span class="nc" id="L3454">   		return true;</span>
		}
<span class="nc" id="L3456">		catch (Exception ex)</span>
		{
<span class="nc" id="L3458">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L3459">			return false;</span>
		}
	}

	/**
	 * Funkcia vrati nazov perex skupiny podla jeho identifikatora
	 *
	 * @param perexGroupId	identifikator skupiny, ktorej nazov chceme zistit
	 * @return
	 */
	public static String getPerexGroupName(int perexGroupId)
	{
<span class="nc" id="L3471">		return new SimpleQuery().forString(&quot;SELECT perex_group_name FROM perex_groups WHERE perex_group_id = ?&quot;, perexGroupId);</span>
	}

	/**
	 * Funkcia, ktora z retazca identifikatorov perex skupin (v tvare napr. ,12,15,78,2,) vrati retazec ich zodpovedajucich nazvov (interway, auto, kvety)
	 *
	 * @param perexGroupString retazec pozostavajuci z identifikatorov jednotlivych perex skupin oddelenych ciarkami - napr. ,12,15,78,2,
	 * @return
	 */
	public static String getPerexGroupNameString(String perexGroupString)
	{
<span class="nc" id="L3482">		StringBuilder retValue = new StringBuilder();</span>
<span class="nc" id="L3483">		String[] perexGroups = convertPerexGroupString(perexGroupString);</span>
<span class="nc bnc" id="L3484" title="All 4 branches missed.">		if (perexGroups != null &amp;&amp; perexGroups.length &gt; 0)</span>
<span class="nc bnc" id="L3485" title="All 2 branches missed.">      	for (String perexGroup : perexGroups)</span>
<span class="nc" id="L3486">      		retValue.append(GalleryDB.getPerexGroupName(Tools.getIntValue(perexGroup, -1))).append(&quot;, &quot;);</span>

<span class="nc" id="L3488">		return retValue.substring(0, (retValue.length()-2));		//odreze poslednu medzeru a ciarku na konci</span>
	}

	public static String convertPerexGroupString(String[] perexGroup)
	{
<span class="nc" id="L3493">		StringBuilder ret = new StringBuilder();</span>
		try
		{
<span class="nc bnc" id="L3496" title="All 2 branches missed.">			if (perexGroup!=null)</span>
			{
<span class="nc" id="L3498">				int size = perexGroup.length;</span>
				int i;
<span class="nc bnc" id="L3500" title="All 2 branches missed.">				for (i=0; i&lt;size; i++)</span>
				{
<span class="nc" id="L3502">					ret.append(&quot;,&quot;).append(perexGroup[i]);</span>
				}
<span class="nc" id="L3504">				ret.append(&quot;,&quot;);</span>
			}
		}
<span class="nc" id="L3507">		catch (Exception ex)</span>
		{
<span class="nc" id="L3509">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L3510">		}</span>

		//Logger.println(GalleryBean.class, &quot;getPerexGroupString = &quot; + ret);

<span class="nc" id="L3514">		return(ret.toString());</span>
	}

	public static String[] convertPerexGroupString(String perexGroupString)
	{
<span class="fc" id="L3519">		String[] perexGroup = null;</span>

<span class="fc bfc" id="L3521" title="All 2 branches covered.">		if (perexGroupString == null)</span>
<span class="fc" id="L3522">			perexGroupString = &quot;&quot;;</span>

<span class="fc" id="L3524">		StringTokenizer st = new StringTokenizer(perexGroupString, &quot;,+_&quot;);</span>

		try
		{
<span class="fc" id="L3528">			perexGroup = new String[st.countTokens()];</span>
<span class="fc" id="L3529">			int i=0;</span>
<span class="pc bpc" id="L3530" title="1 of 2 branches missed.">			while (st.hasMoreTokens())</span>
			{
<span class="nc" id="L3532">				int pGroupId = Tools.getIntValue(st.nextToken().trim(), -1);</span>
<span class="nc" id="L3533">				perexGroup[i++] = Integer.toString(pGroupId);</span>
<span class="nc" id="L3534">			}</span>
		}
<span class="nc" id="L3536">		catch (Exception ex)</span>
		{
<span class="nc" id="L3538">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L3539">		}</span>

<span class="fc" id="L3541">		return perexGroup;</span>
	}

	public static void updateSelectedInfo(int imageId, int selectedX, int selectedY, int selectedWidht, int selectedHeight)
	{
<span class="nc" id="L3546">		Connection db_conn = null;</span>
<span class="nc" id="L3547">		PreparedStatement ps = null;</span>
		try
		{
<span class="nc" id="L3550">			db_conn = DBPool.getConnection();</span>
<span class="nc" id="L3551">			ps = db_conn.prepareStatement(&quot;UPDATE gallery SET selected_x=?, selected_y=?, selected_width=?, selected_height=? WHERE image_id=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L3552">			int index = 1;</span>
<span class="nc" id="L3553">			ps.setInt( index++,selectedX);</span>
<span class="nc" id="L3554">			ps.setInt( index++,selectedY);</span>
<span class="nc" id="L3555">			ps.setInt( index++,selectedWidht);</span>
<span class="nc" id="L3556">			ps.setInt(index++,selectedHeight);</span>
<span class="nc" id="L3557">			ps.setInt(index++,imageId);</span>
<span class="nc" id="L3558">			ps.execute();</span>
<span class="nc" id="L3559">			ps.close();</span>
<span class="nc" id="L3560">			db_conn.close();</span>
<span class="nc" id="L3561">			ps = null;</span>
<span class="nc" id="L3562">			db_conn = null;</span>
		}
<span class="nc" id="L3564">		catch (Exception ex)</span>
		{
<span class="nc" id="L3566">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L3572" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L3573">					ps.close();</span>
<span class="nc bnc" id="L3574" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L3575">					db_conn.close();</span>
			}
<span class="nc" id="L3577">			catch (Exception ex2)</span>
			{
<span class="nc" id="L3579">			}</span>
		}
<span class="nc" id="L3581">	}</span>

	/**
	 * Sprav crop z obrazka &quot;from&quot; podla zadanych parametrov a zapise ho do  &quot;to&quot;
	 * POZOR: Ignoruje DB storage
	 * @param from
	 * @param width
	 * @param height
	 * @param left
	 * @param top
	 * @param to
	 * @return
	 */
	public static int crop(IwcmFile from, int width,int height,int left,int top,IwcmFile to)
	{
<span class="nc bnc" id="L3596" title="All 2 branches missed.">		if (!to.getParentFile().exists())</span>
		{
<span class="nc" id="L3598">			to.getParentFile().mkdirs();</span>
		}

<span class="nc" id="L3601">		String[] args = new String[5];</span>
<span class="nc" id="L3602">		args[1]=from.getAbsolutePath();</span>
<span class="nc" id="L3603">		args[2]=&quot;-crop&quot;;</span>
<span class="nc" id="L3604">		args[3]=width+&quot;x&quot;+height+&quot;+&quot;+left+&quot;+&quot;+top;</span>
<span class="nc" id="L3605">		args[4]=to.getAbsolutePath();</span>
<span class="nc" id="L3606">		return executeImageMagickCommand(args);</span>
	}


	/**
	 * Spusti imageMagic s parametrami v args, args[0] sa nastavi automaticky podla cesty k ImageMagic
	 * @param args
	 */
	public static int executeImageMagickCommand(String[] args)
	{
<span class="nc" id="L3616">		args[0] = getImageMagicDir()+File.separatorChar+getRuntimeFile();</span>
<span class="nc" id="L3617">		Runtime rt = Runtime.getRuntime();</span>
<span class="nc" id="L3618">		Process process = null;</span>
		try
		{
			//odstraneny if nie je potrebny
<span class="nc" id="L3622">			StringBuilder params = new StringBuilder();</span>
//			if (args != null)
//			{
<span class="nc bnc" id="L3625" title="All 2 branches missed.">				for (int i = 0; i &lt; args.length; i++)</span>
				{
<span class="nc" id="L3627">					params.append(' ').append(args[i]);</span>
				}
//			}
<span class="nc" id="L3630">			Logger.debug(GalleryDB.class, &quot;LONGCMD:\n&quot; + params);</span>

<span class="nc" id="L3632">			process= rt.exec(args);</span>

<span class="nc" id="L3634">			InputStream stderr = process.getErrorStream();</span>
<span class="nc" id="L3635">			BufferedReader br = new BufferedReader(new InputStreamReader(stderr, Constants.FILE_ENCODING));</span>
<span class="nc" id="L3636">			String line = null;</span>
<span class="nc bnc" id="L3637" title="All 2 branches missed.">			while ((line = br.readLine()) != null)</span>
			{
<span class="nc" id="L3639">				Logger.debug(GalleryDB.class, line);</span>
			}
<span class="nc" id="L3641">			br.close();</span>

<span class="nc" id="L3643">			int ret = process.waitFor();</span>
			//convert vrati 1 namiesto 0 lebo pri -debug hlasi, ze destination subor neexistuje/nepozna .new priponu
<span class="nc bnc" id="L3645" title="All 2 branches missed.">			if (ret==1) ret = 0;</span>

<span class="nc" id="L3647">			return ret;</span>
		}
<span class="nc" id="L3649">		catch (Exception e)</span>
		{
<span class="nc" id="L3651">			sk.iway.iwcm.Logger.error(e);</span>
		}
<span class="nc" id="L3653">		return -1;</span>
	}

	/**
	 * Matoda, ktora zmeni urcitu vlastnost obrazka, ak obrazok neexistuje, vytvori novy s pozadovanymi hodnotami
	 *
	 * @author kmarton
	 *
	 * @param imageId	identifikator obrazka, ktoreho vlastnosti chceme zmenit
	 * @param item		vlastnost obrazka, ktoru chceme zmenit prepisanim starej hodnoty na novu value
	 * @param value	hodnota, ktoru chceme zapisat do vlastnosti item obrazka
	 */
	public static boolean updateImageItem(int imageId, String item, String value, String imagePath, String imageName, String lng)
	{
		//System.out.println(&quot;IMAGEID NA ZMENU::: &quot; + imageId +&quot; - &quot; + imagePath + &quot; - &quot; + imageName);
		//System.out.println(&quot;DEBUG: JAZYK NA ZMENU::: &quot; + imageId +&quot; - &quot; + lng);

<span class="nc bnc" id="L3670" title="All 4 branches missed.">		if(item == null || value == null)</span>
<span class="nc" id="L3671">			return false;</span>

<span class="nc bnc" id="L3673" title="All 2 branches missed.">		if (imageId &lt; 0)</span>
<span class="nc" id="L3674">			imageId = GalleryDB.setImage(imagePath, imageName);</span>

<span class="nc bnc" id="L3676" title="All 2 branches missed.">		if (imageId &lt; 0)</span>
<span class="nc" id="L3677">			return false;</span>

		try
		{
<span class="nc bnc" id="L3681" title="All 2 branches missed.">			if (&quot;short&quot;.equals(item))</span>
<span class="nc" id="L3682">				new SimpleQuery().execute(&quot;UPDATE gallery SET s_description_&quot; + lng + &quot; = ? WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), DB.prepareString(EditorDB.escapeInvalidCharacters(value), 255), imageId);</span>
<span class="nc bnc" id="L3683" title="All 2 branches missed.">			else if (&quot;long&quot;.equals(item))</span>
<span class="nc" id="L3684">				new SimpleQuery().execute(&quot;UPDATE gallery SET l_description_&quot; + lng + &quot; = ? WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), EditorDB.escapeInvalidCharacters(value), imageId);</span>
<span class="nc bnc" id="L3685" title="All 2 branches missed.">			else if (&quot;author&quot;.equals(item))</span>
<span class="nc" id="L3686">				new SimpleQuery().execute(&quot;UPDATE gallery SET author = ? WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), DB.prepareString(value, 255), imageId);</span>
<span class="nc bnc" id="L3687" title="All 2 branches missed.">			else if (&quot;priority&quot;.equals(item))</span>
<span class="nc" id="L3688">				new SimpleQuery().execute(&quot;UPDATE gallery SET sort_priority = ? WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), Integer.parseInt(value), imageId);</span>
<span class="nc bnc" id="L3689" title="All 2 branches missed.">			else if (&quot;upload&quot;.equals(item))</span>
<span class="nc" id="L3690">				new SimpleQuery().execute(&quot;UPDATE gallery SET upload_datetime = ? WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), new Timestamp(Long.parseLong(value)), imageId);</span>

<span class="nc" id="L3692">			return true;</span>
		}
<span class="nc" id="L3694">		catch (Exception e)</span>
		{
<span class="nc" id="L3696">			sk.iway.iwcm.Logger.error(e);</span>
		}

<span class="nc" id="L3699">		return false;</span>
	}

	/**
	 * Matoda, ktora zmeni urcitu vlastnost galerie
	 *
	 * @author kmarton
	 *
	 * @param path	identifikator galerie - cesta k jej priecinku, ktorej vlastnosti chceme zmenit
	 * @param item		vlastnost galerie, ktoru chceme zmenit prepisanim starej hodnoty na novu value
	 * @param value	hodnota, ktoru chceme zapisat do vlastnosti item galerie
	 */
	public static boolean updateGalleryItem(String path, String item, String value)
	{
		//System.out.println(&quot;IMAGEID NA ZMENU::: &quot; + imageId +&quot; - &quot; + imagePath + &quot; - &quot; + imageName);
		//System.out.println(&quot;DEBUG: JAZYK NA ZMENU::: &quot; + imageId +&quot; - &quot; + lng);

<span class="nc bnc" id="L3716" title="All 4 branches missed.">		if(item == null || value == null)</span>
<span class="nc" id="L3717">			return false;</span>

<span class="nc bnc" id="L3719" title="All 2 branches missed.">		if (Tools.isEmpty(path))</span>
<span class="nc" id="L3720">			return false;</span>

<span class="nc" id="L3722">		int galleryId = GalleryDB.setGallery(path);</span>

<span class="nc bnc" id="L3724" title="All 2 branches missed.">		if (galleryId &gt; 0)</span>
		{
   		try
   		{
<span class="nc bnc" id="L3728" title="All 2 branches missed.">   			if (&quot;short&quot;.equals(item))</span>
<span class="nc" id="L3729">   				new SimpleQuery().execute(&quot;UPDATE gallery_dimension SET gallery_name = ? WHERE dimension_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), DB.prepareString(value, 255), galleryId);</span>
<span class="nc bnc" id="L3730" title="All 2 branches missed.">   			else if (&quot;long&quot;.equals(item))</span>
<span class="nc" id="L3731">   				new SimpleQuery().execute(&quot;UPDATE gallery_dimension SET gallery_perex = ? WHERE dimension_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), value, galleryId);</span>
<span class="nc bnc" id="L3732" title="All 2 branches missed.">   			else if (&quot;author&quot;.equals(item))</span>
<span class="nc" id="L3733">   				new SimpleQuery().execute(&quot;UPDATE gallery_dimension SET author = ? WHERE dimension_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), DB.prepareString(value, 255), galleryId);</span>

   		}
<span class="nc" id="L3736">   		catch (Exception e)</span>
   		{
<span class="nc" id="L3738">   			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L3739">   			return false;</span>
<span class="nc" id="L3740">   		}</span>

<span class="nc" id="L3742">   		return true;</span>
		}
<span class="nc" id="L3744">		return false;</span>
	}

	/**
	 * Vrati hodnotu obrazka v galerii, ktora uz existuju v tabulke na zaklade jazyka
	 *
	 * @param imageId identifikator obrazka
	 * @param item		polozka, vlastnost, ktoru chceme zistit
	 * @param lng		jazyk
	 *
	 *	@author kmarton
	 * @return
	 */
	public static String getDescriptionLng(int imageId, String item, String lng)
	{
<span class="nc" id="L3759">		String retValue = &quot;&quot;;</span>
		try
		{
<span class="nc bnc" id="L3762" title="All 2 branches missed.">   		if (&quot;short&quot;.equals(item))</span>
<span class="nc" id="L3763">   			retValue = new SimpleQuery().forString(&quot;SELECT s_description_&quot; + lng + &quot; FROM gallery WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), imageId);</span>
<span class="nc bnc" id="L3764" title="All 2 branches missed.">   		if (&quot;long&quot;.equals(item))</span>
<span class="nc" id="L3765">   			retValue = new SimpleQuery().forString(&quot;SELECT l_description_&quot; + lng + &quot; FROM gallery WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), imageId);</span>
   	}
<span class="nc" id="L3767">   	catch (Exception e)</span>
   	{
<span class="nc" id="L3769">   	}</span>
<span class="nc bnc" id="L3770" title="All 2 branches missed.">   	if (retValue == null)</span>
<span class="nc" id="L3771">   		retValue = &quot;&quot;;</span>

<span class="nc" id="L3773">   	return retValue;</span>
	}


	/**
	 * malo by sa pouzivat getGalleryInfo(String galleryPath, int dimensionId)
	 *
	 *@deprecated
	 */
	@Deprecated
	public static GalleryDimension getGalleryInfo(String galleryPath)
	{
<span class="nc" id="L3785">		return getGalleryInfo(galleryPath, -1);</span>
	}

	/**
	 * upravil bhric, aby sa dali ziskat info aj pomocou ID galerie
	 *
	 * Metoda vrati informacie o galerie presnejsie jej nazov, id, perex, datum vytvorenia, pocet videni a autorovi
	 *
	 * @author kmarton
	 *
	 * @param galleryPath	cesta k priecinku fotogalerie, podla ktorej sa identifikuje
	 * @param dimensionId	ID galerie, zhodne s dimension_id - pokial je mensie ako 1, tak vyhlada podla galleryPath
	 * @return vrati bean GalleryDimension naplneny informaciami
	 */
	public static GalleryDimension getGalleryInfo(String galleryPath, int dimensionId)
	{
<span class="nc" id="L3801">		GalleryDimension emptyDimensionIfNothingIsFound = new GalleryDimension();</span>
<span class="nc" id="L3802">		emptyDimensionIfNothingIsFound.setGalleryPath(galleryPath);</span>
<span class="nc" id="L3803">		String sql = &quot;&quot;;</span>
<span class="nc bnc" id="L3804" title="All 2 branches missed.">		if(dimensionId &gt; 0)</span>
<span class="nc" id="L3805">			sql = &quot;SELECT * FROM gallery_dimension WHERE dimension_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
<span class="nc bnc" id="L3806" title="All 2 branches missed.">		else if(Tools.isNotEmpty(galleryPath))</span>
<span class="nc" id="L3807">			sql = &quot;SELECT * FROM gallery_dimension WHERE image_path = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
		else
<span class="nc" id="L3809">			return null;</span>

<span class="nc" id="L3811">		ComplexQuery query = new ComplexQuery().setSql(sql);</span>
<span class="nc bnc" id="L3812" title="All 2 branches missed.">		if (dimensionId &gt; 0)</span>
<span class="nc" id="L3813">			query.setParams(dimensionId);</span>
		else
<span class="nc" id="L3815">			query.setParams(galleryPath);</span>

<span class="nc" id="L3817">		List&lt;GalleryDimension&gt; dimensions = query.list(dimensionMapper);</span>
<span class="nc bnc" id="L3818" title="All 2 branches missed.">		return dimensions.size() &gt; 0 ? dimensions.get(0) : emptyDimensionIfNothingIsFound;</span>
	}

	/**
	 * Metoda vrati informacie o count poslednych galeriach
	 *
	 * @author kmarton
	 *
	 * @param count pocet fotogalerii, ktore sa ma vratit
	 * @return vrati List GalleryDimension naplneny informaciami
	 */
	public static List&lt;GalleryDimension&gt; getLastGalleriesInfo(int count)
	{
<span class="nc" id="L3831">		String sql = null;</span>

<span class="nc bnc" id="L3833" title="All 5 branches missed.">		switch (Constants.DB_TYPE)</span>
		{
<span class="nc" id="L3835">			case Constants.DB_MYSQL : sql = &quot;SELECT * FROM gallery_dimension WHERE create_date IS NOT NULL&quot;+CloudToolsForCore.getDomainIdSqlWhere(true)+&quot; ORDER BY create_date DESC LIMIT &quot;+count;</span>
<span class="nc" id="L3836">				break;</span>
<span class="nc" id="L3837">			case Constants.DB_PGSQL : sql = &quot;SELECT * FROM gallery_dimension WHERE create_date IS NOT NULL&quot;+CloudToolsForCore.getDomainIdSqlWhere(true)+&quot; ORDER BY create_date DESC LIMIT &quot;+count;</span>
<span class="nc" id="L3838">				break;</span>
<span class="nc" id="L3839">			case Constants.DB_MSSQL : sql = &quot;SELECT TOP &quot;+count+&quot; * FROM gallery_dimension WHERE create_date IS NOT NULL&quot;+CloudToolsForCore.getDomainIdSqlWhere(true)+&quot; ORDER BY create_date DESC&quot;;</span>
<span class="nc" id="L3840">				break;</span>
<span class="nc" id="L3841">			case Constants.DB_ORACLE : sql = &quot;SELECT GD.*, ROWNUM FROM gallery_dimension GD WHERE create_date IS NOT NULL&quot;+CloudToolsForCore.getDomainIdSqlWhere(true)+&quot; AND ROWNUM &lt; &quot;+count+&quot; ORDER BY create_date DESC&quot;;</span>
<span class="nc" id="L3842">				break;</span>
<span class="nc" id="L3843">			default: throw new IllegalStateException(&quot;Unknown database type&quot;);</span>
		}

<span class="nc" id="L3846">		return new ComplexQuery().setSql(sql).list(dimensionMapper);</span>
	}

	/**
	 * Funkcia vrati GalleryDimensionBeany, ktore obsahuju aspon jednu fotku otagovanu danou perex skupinou a tie budu usporiadane podla datumu vytvorenia
	 *
	 * @param perexGroupId	identifikator skupiny, ktorej aspon jedna fotka sa ma v galerii vyskytovat
	 * @param count			pocet galerii, ktore sa maju vratit
	 *
	 * @return
	 */
	public static List&lt;GalleryDimension&gt; getGalleriesPathByPerexGroup(int perexGroupId, int count)
	{
<span class="nc" id="L3859">		List&lt;GalleryDimension&gt; retList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L3860">		String perexGroupSql = &quot;%,&quot; + perexGroupId + &quot;,%&quot;;</span>

		try
		{
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L3865">			List&lt;String&gt; galleriesPaths = new SimpleQuery().forList(&quot;SELECT DISTINCT image_path FROM gallery WHERE gallery.perex_group LIKE ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), perexGroupSql);</span>
<span class="nc bnc" id="L3866" title="All 2 branches missed.">			for (String galleryPath : galleriesPaths)</span>
			{
<span class="nc" id="L3868">				GalleryDimension gd = getGalleryInfo(galleryPath, -1);</span>
<span class="nc" id="L3869">				retList.add(gd);</span>
<span class="nc" id="L3870">			}</span>

		}
<span class="nc" id="L3873">		catch (Exception e)</span>
		{
<span class="nc" id="L3875">		}</span>

		try
		{
<span class="nc" id="L3879">			Collections.sort(retList, new Comparator&lt;GalleryDimension&gt;()</span>
<span class="nc" id="L3880">			{</span>
				@Override
				public int compare(GalleryDimension gd1, GalleryDimension gd2)
				{
<span class="nc" id="L3884">					return (gd2.getGalleryDate().compareTo(gd1.getGalleryDate()));</span>
				}
			});
		}
<span class="nc" id="L3888">		catch (Exception ex)</span>
		{
			//sk.iway.iwcm.Logger.error(ex);
<span class="nc" id="L3891">		}</span>

<span class="nc bnc" id="L3893" title="All 2 branches missed.">		if (retList.isEmpty())</span>
<span class="nc" id="L3894">			return retList;</span>

<span class="nc bnc" id="L3896" title="All 2 branches missed.">		if (count &gt; retList.size())</span>
<span class="nc" id="L3897">			return retList;</span>

<span class="nc" id="L3899">		return retList.subList(0, count);</span>
	}

	/**
	 * Funkcia vrati GalleryBean prveho obrazka, ktory patri do zadanej fotogalerie podla jej identifikatora
	 *
	 * @param galleryPath	cesta galerie, z ktorej sa ma vybrat prvy obrazok na zaklade abecedneho poradia
	 *
	 * @return
	 */
	public static GalleryBean getFirstImageFromGalleryByPerexGroupFromDB(String galleryPath)
	{
<span class="nc" id="L3911">		GalleryBean firstImage = new GalleryBean();</span>

<span class="nc" id="L3913">		Connection db_conn = null;</span>
<span class="nc" id="L3914">		PreparedStatement ps = null;</span>
<span class="nc" id="L3915">		ResultSet rs = null;</span>

<span class="nc" id="L3917">		String limitSQLAfter = &quot;&quot;;</span>
<span class="nc" id="L3918">		String limitSqlBefore = &quot;&quot;;</span>
<span class="nc" id="L3919">		String whereCondition = &quot;&quot;;</span>

<span class="nc bnc" id="L3921" title="All 4 branches missed.">		if(Constants.DB_TYPE == Constants.DB_MYSQL || Constants.DB_TYPE==Constants.DB_PGSQL)</span>
<span class="nc" id="L3922">			limitSQLAfter = &quot; LIMIT 1&quot;;</span>

<span class="nc bnc" id="L3924" title="All 2 branches missed.">		else if(Constants.DB_TYPE == Constants.DB_MSSQL)</span>
<span class="nc" id="L3925">			limitSqlBefore = &quot; TOP &quot; + 1;</span>

<span class="nc bnc" id="L3927" title="All 2 branches missed.">		else if(Constants.DB_TYPE == Constants.DB_ORACLE)</span>
<span class="nc" id="L3928">			whereCondition = &quot; AND LINENUM BETWEEN 0 AND 1&quot;;</span>

		try
		{
<span class="nc" id="L3932">			db_conn = DBPool.getConnection();</span>

<span class="nc" id="L3934">			ps = db_conn.prepareStatement(&quot;SELECT&quot;+limitSqlBefore+&quot; image_id, image_path, image_name FROM gallery WHERE image_path = ?&quot;+whereCondition+CloudToolsForCore.getDomainIdSqlWhere(true)+&quot; ORDER BY image_name ASC &quot; + limitSQLAfter);</span>
<span class="nc" id="L3935">			int psCounter = 1;</span>
<span class="nc" id="L3936">			ps.setString(psCounter++, galleryPath);</span>

<span class="nc" id="L3938">			rs = ps.executeQuery();</span>

<span class="nc bnc" id="L3940" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L3942">				firstImage.setImageId(rs.getInt(&quot;image_id&quot;));</span>
<span class="nc" id="L3943">				firstImage.setImagePath(rs.getString(&quot;image_path&quot;));</span>
<span class="nc" id="L3944">				firstImage.setImageName(rs.getString(&quot;image_name&quot;));</span>
			}

<span class="nc" id="L3947">			rs.close();</span>
<span class="nc" id="L3948">			ps.close();</span>
<span class="nc" id="L3949">			db_conn.close();</span>

<span class="nc" id="L3951">			rs = null;</span>
<span class="nc" id="L3952">			ps = null;</span>
<span class="nc" id="L3953">			db_conn = null;</span>
		}
<span class="nc" id="L3955">		catch (Exception ex)</span>
		{
<span class="nc" id="L3957">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L3963" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L3964">					rs.close();</span>
<span class="nc bnc" id="L3965" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L3966">					ps.close();</span>
<span class="nc bnc" id="L3967" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L3968">					db_conn.close();</span>
			}
<span class="nc" id="L3970">			catch (Exception ex2)</span>
			{
<span class="nc" id="L3972">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L3973">			}</span>
		}

<span class="nc" id="L3976">		return firstImage;</span>
	}

	/**
	 * Funkcia vrati GalleryBean prveho obrazka, ktory patri do zadanej fotogalerie na zaklade jej adresara
	 *
	 * @param galleryPath	cesta galerie, z ktorej sa ma vybrat prvy obrazok na zaklade abecedneho poradia
	 *
	 * @return
	 */
	public static GalleryBean getFirstImageFromGalleryByPerexGroupFromDir(String galleryPath)
	{
<span class="nc" id="L3988">		GalleryBean firstImage = new GalleryBean();</span>

<span class="nc" id="L3990">		String realPath = sk.iway.iwcm.Tools.getRealPath(galleryPath);</span>
		IwcmFile[] fileList;
<span class="nc" id="L3992">		IwcmFile file = null;</span>

<span class="nc" id="L3994">		file = new IwcmFile(realPath);</span>
<span class="nc" id="L3995">		fileList = file.listFiles(new IwcmFileFilter()</span>
<span class="nc" id="L3996">		{</span>
			@Override
			public boolean accept(IwcmFile pathname)
			{
<span class="nc bnc" id="L4000" title="All 2 branches missed.">				return (isImageFast(pathname))</span>
<span class="nc bnc" id="L4001" title="All 2 branches missed.">							&amp;&amp; pathname.getName().startsWith(&quot;s_&quot;);</span>
			}
		});

<span class="nc bnc" id="L4005" title="All 2 branches missed.">   	if (fileList == null)</span>
<span class="nc" id="L4006">   		fileList = new IwcmFile[0];</span>
   	try
   	{
<span class="nc" id="L4009">   		Arrays.sort(fileList, new Comparator&lt;IwcmFile&gt;()</span>
<span class="nc" id="L4010">   		{</span>
   			@Override
				public int compare(IwcmFile f1, IwcmFile f2)
   			{
<span class="nc" id="L4014">   				return (f1.getName().compareTo(f2.getName()));</span>
   			}
   		});
   	}
<span class="nc" id="L4018">   	catch (Exception ex)</span>
   	{
<span class="nc" id="L4020">   		sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L4021">   	}</span>

<span class="nc bnc" id="L4023" title="All 2 branches missed.">   	if (fileList.length &gt; 0)</span>
   	{
<span class="nc" id="L4025">   		firstImage.setImagePath(fileList[0].getVirtualParent());</span>
<span class="nc" id="L4026">   		firstImage.setImageName(fileList[0].getName().substring(2));</span>
   	}
   	else
<span class="nc" id="L4029">   		return null;</span>

<span class="nc" id="L4031">   	return firstImage;</span>
   	}

   /**
	 * zvysi pocet videni o jeden
	 * @param dimId - zhodne s dimension_id
	 */
	public static void addGalleryViews(int dimId)
	{
<span class="nc" id="L4040">		int views = 0;</span>
<span class="nc" id="L4041">		GalleryDimension info = getGalleryInfo(null, dimId);</span>
<span class="nc bnc" id="L4042" title="All 4 branches missed.">		if(info == null || info.getGalleryId() &lt; 1)</span>
<span class="nc" id="L4043">			return;</span>
		try
		{
<span class="nc" id="L4046">			views = DB.queryForInt(&quot;SELECT views FROM gallery_dimension WHERE dimension_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), Integer.valueOf(dimId));</span>
<span class="nc" id="L4047">			++views;</span>
		}
<span class="nc" id="L4049">		catch (IllegalStateException e)</span>
		{
<span class="nc" id="L4051">			views = 1;</span>
<span class="nc" id="L4052">		}</span>
<span class="nc" id="L4053">		DB.execute(&quot;UPDATE gallery_dimension SET views = ? WHERE dimension_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), Integer.valueOf(views), Integer.valueOf(dimId));</span>
<span class="nc" id="L4054">	}</span>

	public static void stripExif(String filePath)
	{
<span class="pc bpc" id="L4058" title="1 of 2 branches missed.">		if (Constants.getBoolean(&quot;galleryStripExif&quot;) == false) return;</span>

<span class="fc" id="L4060">		String imageMagickDir = getImageMagicDir();</span>
<span class="fc" id="L4061">		boolean convertExists = false;</span>
<span class="fc" id="L4062">		String runtimeFile = getRuntimeFile();</span>

		try
		{
<span class="pc bpc" id="L4066" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(imageMagickDir))</span>
			{
<span class="fc" id="L4068">				File f = new File(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="pc bpc" id="L4069" title="3 of 4 branches missed.">				if (f.exists() &amp;&amp; f.canRead())</span>
				{
<span class="nc" id="L4071">					convertExists = true;</span>
				}
			}
<span class="pc bpc" id="L4074" title="2 of 4 branches missed.">			if (Tools.isNotEmpty(imageMagickDir) &amp;&amp; convertExists)</span>
			{
<span class="nc" id="L4076">				Logger.debug(GalleryDB.class, &quot;executing image magick: &quot; + imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="nc" id="L4077">				Runtime rt = Runtime.getRuntime();</span>

<span class="nc" id="L4079">				String[] args = new String[4];</span>

<span class="nc bnc" id="L4081" title="All 2 branches missed.">				if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(filePath)))</span>
				{
<span class="nc" id="L4083">					IwcmFsDB.writeFileToDisk(new File(filePath),new File(IwcmFsDB.getTempFilePath(filePath)));</span>
<span class="nc" id="L4084">					args[0] = imageMagickDir + File.separatorChar + runtimeFile;</span>
<span class="nc" id="L4085">					args[1] = IwcmFsDB.getTempFilePath(filePath);</span>
<span class="nc" id="L4086">					args[2] = &quot;-strip&quot;;</span>
<span class="nc" id="L4087">					args[3] = IwcmFsDB.getTempFilePath(filePath);</span>
				}
				else
				{
<span class="nc" id="L4091">					args[0] = imageMagickDir + File.separatorChar + runtimeFile;</span>
<span class="nc" id="L4092">					args[1] = filePath;</span>
<span class="nc" id="L4093">					args[2] = &quot;-strip&quot;;</span>
<span class="nc" id="L4094">					args[3] = filePath;</span>
				}

<span class="nc" id="L4097">				StringBuilder params = new StringBuilder();</span>
<span class="nc bnc" id="L4098" title="All 2 branches missed.">				for (int i = 0; i &lt; args.length; i++)</span>
				{
<span class="nc" id="L4100">					params.append(' ').append(args[i]);</span>
				}
<span class="nc" id="L4102">				Logger.debug(GalleryDB.class, &quot;LONGCMD:\n&quot; + params);</span>
<span class="nc" id="L4103">				Process proc = rt.exec(args);</span>
<span class="nc" id="L4104">				InputStream stderr = proc.getErrorStream();</span>
<span class="nc" id="L4105">				BufferedReader br = new BufferedReader(new InputStreamReader(stderr, Constants.FILE_ENCODING));</span>
<span class="nc" id="L4106">				String line = null;</span>
<span class="nc bnc" id="L4107" title="All 2 branches missed.">				while ((line = br.readLine()) != null)</span>
				{
<span class="nc" id="L4109">					Logger.debug(GalleryDB.class, line);</span>
				}
<span class="nc" id="L4111">				br.close();</span>
<span class="nc" id="L4112">				int exitValue = proc.waitFor();</span>
<span class="nc" id="L4113">				Logger.debug(GalleryDB.class, &quot;ExitValue: &quot; + exitValue);</span>
			}

		}
<span class="nc" id="L4117">		catch (Exception ex)</span>
		{
<span class="nc" id="L4119">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L4120">		}</span>
<span class="fc" id="L4121">	}</span>
	/**
	 * Vrati statistiku odoslani obrazkov
	 *
	 * @param imagePath	cesta obrazka, ktory sa ma vyhladat
	 * @param alsoEmpty  ci ma vratit aj nulove pocty
	 * @return zoznam objektov GalleryBean
	 */
	public static List&lt;GalleryBean&gt; getAllSendCount(String imagePath,boolean alsoEmpty)
	{
<span class="nc" id="L4131">		List&lt;Object&gt; params = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L4133">   	StringBuilder sql = new StringBuilder();</span>
<span class="nc" id="L4134">		sql.append(&quot;SELECT image_name, send_count, image_path, image_id, image_path FROM gallery WHERE image_id &gt; 0&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>

<span class="nc bnc" id="L4136" title="All 2 branches missed.">   	if (Tools.isNotEmpty(imagePath))</span>
   	{
<span class="nc" id="L4138">   		sql.append(&quot; AND image_path LIKE ?&quot;);</span>
<span class="nc" id="L4139">   		params.add(&quot;%&quot; + imagePath + &quot;%&quot;);</span>
   	}
<span class="nc bnc" id="L4141" title="All 2 branches missed.">   	if(!alsoEmpty){</span>
<span class="nc" id="L4142">   		sql.append(&quot; AND send_count &gt; 0 &quot;);</span>
   	}
<span class="nc" id="L4144">   	sql.append(&quot; ORDER BY send_count DESC&quot;);</span>

<span class="nc" id="L4146">      List&lt;GalleryBean&gt; imageBeans = new ComplexQuery().setSql(sql.toString()).setParams(params.toArray()).list(new Mapper&lt;GalleryBean&gt;()</span>
<span class="nc" id="L4147">      {</span>
         @Override
			public GalleryBean map(ResultSet rs) throws SQLException
         {
<span class="nc" id="L4151">         	GalleryBean imageBean = new GalleryBean();</span>

<span class="nc" id="L4153">         	imageBean.setImagePath(rs.getString(&quot;image_path&quot;));</span>
<span class="nc" id="L4154">         	imageBean.setImageName(rs.getString(&quot;image_name&quot;));</span>
<span class="nc" id="L4155">				imageBean.setImageId(rs.getInt(&quot;image_id&quot;));</span>
<span class="nc" id="L4156">				imageBean.setSendCount(rs.getInt(&quot;send_count&quot;));</span>

<span class="nc" id="L4158">         	return imageBean;</span>
         }
      });

<span class="nc" id="L4162">		return imageBeans;</span>
	}

	/**
	 * Vrati statistiku odoslani obrazkov, aj tie ktore maju pocet odoslani 0
	 * @param imagePath	cesta obrazka, ktory sa ma vyhladat
	 * @return zoznam objektov GalleryBean
	 */
	public static List&lt;GalleryBean&gt; getAllSendCount(String imagePath)
	{
<span class="nc" id="L4172">		return getAllSendCount(imagePath,true);</span>
	}

	/**
	 * Vrati datum a cas uploadu obrazku z fotogalerie na server
	 *
	 * @param dir	adresar, v ktorom sa obrazok nachadza
	 * @param name	nazov obrazka aj s priponou
	 *
	 * @return datum a cas nahratia obrazku na server, null vrati v pripade, ze sa nepodari spojenie s DB alebo obrazok nema nastaveny upload_datetime
	 */
	public static Date getUploadDateImage(String dir, String name)
	{
		try
		{
<span class="fc" id="L4187">			return new SimpleQuery().forDate(&quot;SELECT upload_datetime FROM gallery WHERE image_path = ? AND image_name = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), dir, name);</span>
		}
<span class="nc" id="L4189">		catch (Exception e)</span>
		{
<span class="nc" id="L4191">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L4192">			return null;</span>
		}
	}

	/**
	 * Nastavi obrazku, ktory nema ulozeny datum uploadu, datum poslednej modifikacie suboru
	 *
	 * @param dir			adresar obrazka
	 * @param name			meno obrazka
	 * @param uploadDate	datum, ktory sa ma nastavit ako datum uploadu
	 *
	 * @return true ak sa operacia podarila, inak false
	 */
	public static boolean setUploadDateImage(String dir, String name, long uploadDate)
	{
		try
		{
<span class="fc" id="L4209">			new SimpleQuery().execute(&quot;UPDATE gallery SET upload_datetime = ? WHERE image_path = ? AND image_name = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), new Timestamp(uploadDate), dir, name);</span>
<span class="fc" id="L4210">			return true;</span>
		}
<span class="nc" id="L4212">		catch (Exception e)</span>
		{
<span class="nc" id="L4214">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L4215">			return false;</span>
		}
	}

	/**
	 * Konvertuje obrazok na JPG
	 * @param f
	 */
	public static void convertToJPG(IwcmFile f)
	{
<span class="nc" id="L4225">		String[] args = new String[]{&quot;imagemagick&quot;, &quot;from&quot;, &quot;to&quot;};</span>
<span class="nc" id="L4226">		String filePath = f.getAbsolutePath();</span>
<span class="nc" id="L4227">		String extension = FileTools.getFileExtension(filePath);</span>
		try
		{
<span class="nc bnc" id="L4230" title="All 2 branches missed.">			if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(filePath)))</span>
			{
<span class="nc" id="L4232">				IwcmFsDB.writeFileToDisk(new File(filePath), new File(IwcmFsDB.getTempFilePath(filePath)));</span>
<span class="nc" id="L4233">				args[1] = IwcmFsDB.getTempFilePath(filePath);</span>
<span class="nc" id="L4234">				args[2] = IwcmFsDB.getTempFilePath(filePath.replace(&quot;.&quot; + extension, &quot;.jpg&quot;));</span>
			}
			else
			{
<span class="nc" id="L4238">				args[1] = filePath;</span>
<span class="nc" id="L4239">				args[2] = filePath.replace(&quot;.&quot; + extension, &quot;.jpg&quot;);</span>
			}
<span class="nc" id="L4241">			executeImageMagickCommand(args);</span>
		}
<span class="nc" id="L4243">		catch (Exception e)</span>
		{
<span class="nc" id="L4245">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L4246">		}</span>
<span class="nc" id="L4247">	}</span>

	/**
	 * pokus o ziskanie datumu vytvorenia JPG fotky z EXIF metadat
	 * @param waitForBytes
	 * @return - v pripade ze nenejade, vrati aktualny datum/cas
	 */
	public static Date getExifDateOriginal(IwcmFile file)
	{
<span class="pc bpc" id="L4256" title="1 of 2 branches missed.">		if (Constants.getBoolean(&quot;galleryEnableExifDate&quot;)==false) return null;</span>

		try
		{
<span class="pc bpc" id="L4260" title="1 of 6 branches missed.">			if(file != null &amp;&amp; (file.getName().toLowerCase().endsWith(&quot;jpg&quot;) || file.getName().toLowerCase().endsWith(&quot;jpeg&quot;)))</span>
			{
<span class="fc" id="L4262">				Metadata metadata = null;</span>
<span class="pc bpc" id="L4263" title="1 of 2 branches missed.">				if(file != null)</span>
				{
					try
					{
<span class="fc" id="L4267">						IwcmInputStream is = new IwcmInputStream(file);</span>
<span class="fc" id="L4268">						metadata = ImageMetadataReader.readMetadata(is);</span>
<span class="fc" id="L4269">						is.close();</span>
						//metadata = ImageMetadataReader.readMetadata(bis, waitForBytes);
					}
<span class="nc" id="L4272">					catch (Exception ex2)</span>
					{
<span class="nc" id="L4274">						sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L4275">						metadata = null;</span>
<span class="fc" id="L4276">					}</span>
				}

<span class="pc bpc" id="L4279" title="1 of 2 branches missed.">				if(metadata != null)</span>
				{
<span class="fc bfc" id="L4281" title="All 2 branches covered.">					for(Directory dir : metadata.getDirectories())</span>
					{
						//adredar ktory drzi EXIF metedata
<span class="pc bpc" id="L4284" title="1 of 2 branches missed.">						if(&quot;Exif SubIFD&quot;.equals(dir.getName()))</span>
						{
<span class="nc bnc" id="L4286" title="All 2 branches missed.">							for(Tag tag : dir.getTags())</span>
							{
<span class="nc bnc" id="L4288" title="All 2 branches missed.">								if(&quot;Date/Time Original&quot;.equals(tag.getTagName()))</span>
								{
									//datum je v tvare 2002:07:13 15:58:28, takze to musime rozparsovat a dat do spravneho tvaru. teda 13.07.2002 15:58:28
<span class="nc" id="L4291">									String[] dateTime = Tools.getTokens(tag.getDescription(), &quot; &quot;);</span>
<span class="nc bnc" id="L4292" title="All 4 branches missed.">									if(dateTime != null &amp;&amp; dateTime.length == 2)</span>
									{
<span class="nc" id="L4294">										String[] datum = Tools.getTokens(dateTime[0], &quot;:&quot;);</span>
<span class="nc bnc" id="L4295" title="All 10 branches missed.">										if(datum != null &amp;&amp; datum.length == 3 &amp;&amp; Tools.getIntValue(datum[2],-1) != -1 &amp;&amp; Tools.getIntValue(datum[1],-1) != -1 &amp;&amp; Tools.getIntValue(datum[0],-1) != -1)</span>
										{
<span class="nc" id="L4297">											Date date = new Date(DB.getTimestamp(datum[2]+datum[1]+datum[0], dateTime[1]));</span>
<span class="nc" id="L4298">											return date;</span>
										}
									}
								}
<span class="nc" id="L4302">							}</span>
						}
<span class="fc" id="L4304">					}</span>
				}
			}
		}
<span class="nc" id="L4308">		catch (Exception e)</span>
		{
<span class="nc" id="L4310">			sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L4311">		}</span>

<span class="fc" id="L4313">		return null;</span>
	}

	public static boolean existsImageMagickConvertCommand()
	{
<span class="nc" id="L4318">		String imageMagickDir = getImageMagicDir();</span>
<span class="nc" id="L4319">		boolean convertExists = false;</span>
<span class="nc" id="L4320">		String runtimeFile = getRuntimeFile();</span>

<span class="nc bnc" id="L4322" title="All 2 branches missed.">		if (Tools.isNotEmpty(imageMagickDir))</span>
		{
<span class="nc" id="L4324">			File f = new File(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="nc bnc" id="L4325" title="All 4 branches missed.">			if (f.exists() &amp;&amp; f.canRead())</span>
			{
<span class="nc" id="L4327">				convertExists = true;</span>
			}
		}
<span class="nc" id="L4330">		return convertExists;</span>
	}

	/**
	 * Vrati hodnotu pre parameter quality z ImageMagick convert prikazu, hodnota sa preberie bud z parametra q alebo z konstanty galleryImageQuality
	 * Vrati -1 ak sa ma pouzit automaticky mod (parameter quality pre convert sa nenastavi)
	 * @param request
	 * @param imageWidth
	 * @return
	 */
	public static int getImageQuality(HttpServletRequest request, int imageWidth)
	{
<span class="fc" id="L4342">		int imageQuality = -1;</span>

<span class="pc bpc" id="L4344" title="1 of 2 branches missed.">		if (request != null)</span>
		{
<span class="fc" id="L4346">			int qParam = Tools.getIntValue(request.getParameter(&quot;q&quot;), -1);</span>
<span class="pc bpc" id="L4347" title="1 of 4 branches missed.">			if (qParam &gt; 10 &amp;&amp; qParam &lt;= 100) imageQuality = qParam;</span>
		}

<span class="fc bfc" id="L4350" title="All 2 branches covered.">		if (imageQuality == -1)</span>
		{
<span class="fc" id="L4352">			String galleryImageQuality = Constants.getString(&quot;galleryImageQuality&quot;);</span>
<span class="pc bpc" id="L4353" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(galleryImageQuality))</span>
			{
<span class="nc" id="L4355">				StringTokenizer st = new StringTokenizer(galleryImageQuality, &quot;;&quot;);</span>
<span class="nc bnc" id="L4356" title="All 2 branches missed.">				while (st.hasMoreTokens())</span>
				{
<span class="nc" id="L4358">					String token = st.nextToken();</span>
					try
					{
<span class="nc" id="L4361">						int index = token.indexOf(':');</span>
<span class="nc bnc" id="L4362" title="All 2 branches missed.">						if (index != -1)</span>
						{
<span class="nc" id="L4364">							int w = Tools.getIntValue(token.substring(0, index), -1);</span>
<span class="nc" id="L4365">							int q = Tools.getIntValue(token.substring(index+1), -1);</span>
<span class="nc bnc" id="L4366" title="All 6 branches missed.">							if (w &gt; 0 &amp;&amp; q &gt; 0 &amp;&amp; w &lt;= imageWidth)</span>
							{
<span class="nc" id="L4368">								imageQuality = q;</span>
							}
						}
<span class="nc" id="L4371">					} catch (Exception ex)</span>
					{
<span class="nc" id="L4373">						sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L4374">					}</span>
<span class="nc" id="L4375">				}</span>
			}
		}

<span class="fc" id="L4379">		return imageQuality;</span>
	}

	public static boolean isVideo(GalleryBean gBean)
	{
<span class="nc" id="L4384">		String fileName=gBean.getImageName();</span>
<span class="nc" id="L4385">		int index = fileName.lastIndexOf(&quot;.&quot;);</span>
<span class="nc" id="L4386">		String videoName = gBean.getImagePath()+&quot;/&quot;+fileName.substring(0,index)+&quot;.mp4&quot;;</span>
		//File f = new File(gBean.getImagePath()+&quot;/&quot;+videoName);
<span class="nc" id="L4388">		IwcmFile f = new IwcmFile(Tools.getRealPath(videoName));</span>
<span class="nc bnc" id="L4389" title="All 2 branches missed.">		if (f.exists())</span>
		{
<span class="nc" id="L4391">			return true;</span>
		}
<span class="nc" id="L4393">		return false;</span>
	}

	/**
	 * Premenuje obrazok v galerii vratane upravy databazy (tabulka gallery a media) a pridania presmerovania
	 * @param originalUrl
	 * @param newUrl
	 * @return
	 */
	public static boolean renameFile(String originalUrl, String newUrl)
	{
<span class="nc" id="L4404">		Logger.debug(GalleryDB.class, &quot;renameFile orig=&quot;+originalUrl+&quot; new=&quot;+newUrl);</span>

		//skontroluj priponu
<span class="nc" id="L4407">		String origExtension = FileTools.getFileExtension(originalUrl).toLowerCase();</span>
<span class="nc" id="L4408">		String newExtension = FileTools.getFileExtension(newUrl).toLowerCase();</span>

<span class="nc bnc" id="L4410" title="All 2 branches missed.">		if (origExtension.equalsIgnoreCase(newExtension)==false)</span>
		{
<span class="nc" id="L4412">			newUrl = newUrl + &quot;.&quot; + origExtension;</span>
<span class="nc" id="L4413">			Logger.debug(GalleryDB.class, &quot;Adding extension: &quot;+origExtension+&quot; newUrl=&quot;+newUrl);</span>
		}

<span class="nc" id="L4416">		boolean moved = false;</span>
		try
		{
<span class="nc" id="L4419">			moved = FileTools.moveFile(originalUrl, newUrl);</span>
<span class="nc bnc" id="L4420" title="All 2 branches missed.">			if (moved)</span>
			{
<span class="nc" id="L4422">				Adminlog.add(Adminlog.TYPE_GALLERY, &quot;Rename file from=&quot;+originalUrl+&quot; to=&quot;+newUrl, -1, -1);</span>

				//presun subor iba ak existuje
<span class="nc bnc" id="L4425" title="All 2 branches missed.">				if (GalleryDB.getImagePathOriginal(originalUrl).startsWith(&quot;o_&quot;)) FileTools.moveFile(GalleryDB.getImagePathOriginal(originalUrl), GalleryDB.getImagePathPrefix(&quot;o_&quot;, newUrl));</span>
<span class="nc bnc" id="L4426" title="All 2 branches missed.">				if (GalleryDB.getImagePathSmall(originalUrl).startsWith(&quot;s_&quot;)) FileTools.moveFile(GalleryDB.getImagePathSmall(originalUrl), GalleryDB.getImagePathPrefix(&quot;s_&quot;, newUrl));</span>

				//otestuj aj video subory
<span class="nc" id="L4429">				String videoFileName = FileTools.getFilePathWithoutExtension(originalUrl)+&quot;.mp4&quot;;</span>
<span class="nc" id="L4430">				IwcmFile f = new IwcmFile(Tools.getRealPath(videoFileName));</span>
<span class="nc bnc" id="L4431" title="All 2 branches missed.">				if (f.exists())</span>
				{
<span class="nc" id="L4433">					FileTools.moveFile(videoFileName, FileTools.getFilePathWithoutExtension(newUrl)+&quot;.mp4&quot;);</span>
				}
<span class="nc" id="L4435">				videoFileName = FileTools.getFilePathWithoutExtension(originalUrl)+&quot;.flv&quot;;</span>
<span class="nc" id="L4436">				f = new IwcmFile(Tools.getRealPath(videoFileName));</span>
<span class="nc bnc" id="L4437" title="All 2 branches missed.">				if (f.exists())</span>
				{
<span class="nc" id="L4439">					FileTools.moveFile(videoFileName, FileTools.getFilePathWithoutExtension(newUrl)+&quot;.flv&quot;);</span>
				}

				//presun data v databaze
<span class="nc" id="L4443">				updateGalleryBeanLinkInDatabase(originalUrl, newUrl);</span>

<span class="nc bnc" id="L4445" title="All 2 branches missed.">				if ( isGalleryFolder(newUrl) )</span>
				{
<span class="nc" id="L4447">					String BASE_DIR = newUrl.substring(0, newUrl.lastIndexOf(&quot;/&quot;)+1);</span>
<span class="nc" id="L4448">					Prop prop = Prop.getInstance();</span>
<span class="nc" id="L4449">					Dimension[] dims = GalleryDB.getDimension(BASE_DIR);</span>
<span class="nc" id="L4450">					GalleryDB.resizePictureImpl(dims, Tools.getRealPath(newUrl), null, prop, GalleryDB.getResizeMode(BASE_DIR));</span>
				}
			}
		}
<span class="nc" id="L4454">		catch (Exception ex)</span>
		{
<span class="nc" id="L4456">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L4457">		}</span>
<span class="nc" id="L4458">		return moved;</span>
	}

	private static void updateGalleryBeanLinkInDatabase(String originalUrl, String newUrl)
	{
<span class="nc" id="L4463">		String originalDir = originalUrl.substring(0, originalUrl.lastIndexOf(&quot;/&quot;));</span>
<span class="nc" id="L4464">		String originalFile = originalUrl.substring(originalUrl.lastIndexOf(&quot;/&quot;)+1);</span>

<span class="nc" id="L4466">		String newDir = newUrl.substring(0, newUrl.lastIndexOf(&quot;/&quot;));</span>
<span class="nc" id="L4467">		String newFile = newUrl.substring(newUrl.lastIndexOf(&quot;/&quot;)+1);</span>

<span class="nc" id="L4469">		(new SimpleQuery()).execute(&quot;DELETE FROM gallery WHERE image_path=? AND image_name=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), newDir, newFile);</span>
<span class="nc" id="L4470">		(new SimpleQuery()).execute(&quot;UPDATE gallery SET image_path=?, image_name=? WHERE image_path=? AND image_name=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), newDir, newFile, originalDir, originalFile);</span>
<span class="nc bnc" id="L4471" title="All 2 branches missed.">		(new SimpleQuery()).execute(&quot;UPDATE documents SET perex_image=? WHERE perex_image=?&quot;+(InitServlet.isTypeCloud() ? (&quot; &quot;+StatDB.getRootGroupWhere(&quot;group_id&quot;, CloudToolsForCore.getDomainId())) : &quot;&quot;), newDir+&quot;/&quot;+newFile, originalDir+&quot;/&quot;+originalFile);</span>
<span class="nc bnc" id="L4472" title="All 2 branches missed.">		(new SimpleQuery()).execute(&quot;UPDATE documents SET perex_image=? WHERE perex_image=?&quot;+(InitServlet.isTypeCloud() ? (&quot; &quot;+StatDB.getRootGroupWhere(&quot;group_id&quot;, CloudToolsForCore.getDomainId())) : &quot;&quot;), GalleryDB.getImagePathPrefix(&quot;o_&quot;, newDir+&quot;/&quot;+newFile), GalleryDB.getImagePathPrefix(&quot;o_&quot;, originalDir+&quot;/&quot;+originalFile));</span>
<span class="nc bnc" id="L4473" title="All 2 branches missed.">		(new SimpleQuery()).execute(&quot;UPDATE documents SET perex_image=? WHERE perex_image=?&quot;+(InitServlet.isTypeCloud() ? (&quot; &quot;+StatDB.getRootGroupWhere(&quot;group_id&quot;, CloudToolsForCore.getDomainId())) : &quot;&quot;), GalleryDB.getImagePathPrefix(&quot;s_&quot;, newDir+&quot;/&quot;+newFile), GalleryDB.getImagePathPrefix(&quot;s_&quot;, originalDir+&quot;/&quot;+originalFile));</span>

<span class="nc" id="L4475">		MediaDB.updateLink(originalUrl, newUrl);</span>
<span class="nc" id="L4476">		MediaDB.updateThumb(originalUrl, newUrl);</span>
<span class="nc" id="L4477">		EditorDB.replaceUrl(originalUrl, newUrl, null);</span>

<span class="nc" id="L4479">		MediaDB.updateLink(GalleryDB.getImagePathPrefix(&quot;o_&quot;, originalUrl), GalleryDB.getImagePathPrefix(&quot;o_&quot;, newUrl));</span>
<span class="nc" id="L4480">		MediaDB.updateThumb(GalleryDB.getImagePathPrefix(&quot;o_&quot;, originalUrl), GalleryDB.getImagePathPrefix(&quot;o_&quot;, newUrl));</span>
<span class="nc" id="L4481">		EditorDB.replaceUrl(GalleryDB.getImagePathPrefix(&quot;o_&quot;, originalUrl), GalleryDB.getImagePathPrefix(&quot;o_&quot;, newUrl), null);</span>

<span class="nc" id="L4483">		MediaDB.updateLink(GalleryDB.getImagePathPrefix(&quot;s_&quot;, originalUrl), GalleryDB.getImagePathPrefix(&quot;s_&quot;, newUrl));</span>
<span class="nc" id="L4484">		MediaDB.updateThumb(GalleryDB.getImagePathPrefix(&quot;s_&quot;, originalUrl), GalleryDB.getImagePathPrefix(&quot;s_&quot;, newUrl));</span>
<span class="nc" id="L4485">		EditorDB.replaceUrl(GalleryDB.getImagePathPrefix(&quot;s_&quot;, originalUrl), GalleryDB.getImagePathPrefix(&quot;s_&quot;, newUrl), null);</span>
<span class="nc" id="L4486">	}</span>

	/**
	 * Pomocna metoda na test suboru, ci sa jedna o obrazok, testuje na zaklade pripony
	 * ak je zapnute galleryUseFastLoading netestuje, ci sa realne jedna o subor alebo adresar, testuje len priponu
	 * pouziva sa pri clustri a pripojenom pomalom NAS
	 * @param file
	 * @return
	 */
	private static boolean isImageFast(IwcmFile file)
	{
		//ak je vypnute fast otestuj, ci sa nejedna o adresar, ak ano, nemoze to byt obrazok
<span class="pc bpc" id="L4498" title="1 of 4 branches missed.">		if (Constants.getBoolean(&quot;galleryUseFastLoading&quot;)==false &amp;&amp; file.isFile()==false) return false;</span>

<span class="fc" id="L4500">		String suffix = FileTools.getFileExtension(file.getName()).toLowerCase();</span>
<span class="pc bpc" id="L4501" title="3 of 8 branches missed.">		if (&quot;png&quot;.equals(suffix) || &quot;jpg&quot;.equals(suffix) || &quot;jpeg&quot;.equals(suffix) || &quot;gif&quot;.equals(suffix))</span>
		{
<span class="fc" id="L4503">			return true;</span>
		}
<span class="nc" id="L4505">		return false;</span>
	}

	/**
	 * Pomocna metoda na test suboru, ci sa jedna o adresar
	 * ak je zapnute galleryUseFastLoading netestuje, ci sa realne jedna o subor alebo adresar, testuje len priponu
	 * pouziva sa pri clustri a pripojenom pomalom NAS
	 * @param file
	 * @return
	 */
	private static boolean isDirectoryFast(IwcmFile file)
	{
		//ak je vypnute fast vratime rovno ci je to adresar
<span class="pc bpc" id="L4518" title="1 of 2 branches missed.">		if (Constants.getBoolean(&quot;galleryUseFastLoading&quot;)==false) return file.isDirectory();</span>

<span class="nc" id="L4520">		String suffix = FileTools.getFileExtension(file.getName()).toLowerCase();</span>
<span class="nc bnc" id="L4521" title="All 12 branches missed.">		if (&quot;png&quot;.equals(suffix) || &quot;jpg&quot;.equals(suffix) || &quot;jpeg&quot;.equals(suffix) || &quot;gif&quot;.equals(suffix) || &quot;bmp&quot;.equals(suffix) || &quot;zip&quot;.equals(suffix))</span>
		{
<span class="nc" id="L4523">			return false;</span>
		}
<span class="nc" id="L4525">		return file.isDirectory();</span>
	}

	private static double limitMaxSize(double size)
	{
<span class="pc bpc" id="L4530" title="1 of 2 branches missed.">		if (size &gt; 5000) return 5000;</span>
<span class="fc" id="L4531">		return size;</span>
	}

	/**
	 * Metoda zmaze celu galeriu vratane podadresarov a vsetkych medii v ramci aktualnej domeny
	 * @param path cesta ku galerii (napr /images/gallery/nejakaGaleria)
	 * @return true ak sa podari zmazat vsetky media a vratane podadresarov, inak false
	 * @throws IllegalArgumentException if path is empty or null
	 * @author mhalas
	 */
	public static boolean deleteGallery(String path)
	{
<span class="fc" id="L4543">		boolean success = false;</span>
<span class="pc bpc" id="L4544" title="1 of 2 branches missed.">		if(Tools.isEmpty(path)) throw new IllegalArgumentException(&quot;path can't be empty&quot;);</span>
<span class="fc" id="L4545">		String galleryRootFolder = getGalleryRootFolder();</span>
<span class="pc bpc" id="L4546" title="1 of 2 branches missed.">		if(path.equals(galleryRootFolder))</span>
		{
<span class="nc" id="L4548">			Logger.debug(GalleryDB.class,&quot;Root gallery folder, skipping...&quot;);</span>
<span class="nc" id="L4549">			return success;</span>
		}
<span class="pc bpc" id="L4551" title="1 of 2 branches missed.">		if(isGalleryFolder(path))</span>
		{
<span class="fc" id="L4553">			Logger.debug(GalleryDB.class, &quot;Deleting gallery &quot; + path + &quot; ...&quot;);</span>
<span class="fc" id="L4554">			Map&lt;String, GalleryBean&gt; beans = getGalleryBeanTable(path, &quot;_sk&quot;, true);</span>
<span class="fc" id="L4555">			Logger.debug(GalleryDB.class, &quot;Deleting images...&quot;);</span>
<span class="fc bfc" id="L4556" title="All 2 branches covered.">			for(GalleryBean b : beans.values())</span>
			{
<span class="fc" id="L4558">				removeImage(b);</span>
<span class="fc" id="L4559">			}</span>
<span class="fc" id="L4560">			Logger.debug(GalleryDB.class, &quot;Deleted &quot; + beans.size() + &quot; images&quot;);</span>
<span class="fc" id="L4561">			new SimpleQuery().execute(&quot;DELETE from gallery_dimension WHERE image_path LIKE ? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true), path+&quot;%&quot;);</span>
			try{
<span class="fc" id="L4563">				Logger.debug(GalleryDB.class, &quot;Deleting directory: &quot; + Tools.getRealPath(path));</span>
<span class="fc" id="L4564">				FileUtils.deleteDirectory(new File(Tools.getRealPath(path)));</span>
<span class="fc" id="L4565">				success = true;</span>
<span class="fc" id="L4566">				Logger.debug(GalleryDB.class, &quot;Gallery &quot;+path+&quot; deleted&quot;);</span>
			}
<span class="nc" id="L4568">			catch(IOException e){</span>
<span class="nc" id="L4569">				Logger.debug(GalleryDB.class, &quot;Failed to delete gallery &quot; + path + &quot; reason: &quot;+e.getMessage());</span>
<span class="fc" id="L4570">			}</span>
<span class="fc" id="L4571">		}</span>
		else
		{
<span class="nc" id="L4574">			Logger.debug(GalleryDB.class, path + &quot; is not a gallery folder, skipping...&quot;);</span>
		}
<span class="fc" id="L4576">		return success;</span>
	}

	/**
	 * Vrati relative path to root adresar galerie
	 * @return
	 * @author mhalas
	 */
	public static String getGalleryRootFolder()
	{
<span class="fc" id="L4586">		return Constants.getString(&quot;imagesRootDir&quot;) + &quot;/&quot; + Constants.getString(&quot;galleryDirName&quot;);</span>
	}

	/**
	 * Vymaze gallery bean z DB aj fyzicky subory vo vsetkych velkostiach
	 * @param b
	 * @author mhalas
	 */
	private static void removeImage(GalleryBean b)
	{
<span class="fc" id="L4596">		java.sql.Connection db_conn = null;</span>
<span class="fc" id="L4597">		java.sql.PreparedStatement ps = null;</span>
<span class="fc" id="L4598">		IwcmFile file = null;</span>
<span class="fc" id="L4599">		String sql = &quot;DELETE FROM gallery WHERE image_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
<span class="fc" id="L4600">		String dir = b.getImagePath();</span>
<span class="fc" id="L4601">		String name = b.getImageName();</span>
<span class="fc" id="L4602">		int imageId = b.getImageId();</span>
<span class="pc bpc" id="L4603" title="1 of 2 branches missed.">		if (dir.startsWith(&quot;/&quot;)==false) dir = &quot;/&quot;+dir;</span>
<span class="pc bpc" id="L4604" title="1 of 2 branches missed.">		if (name.startsWith(&quot;/&quot;)) name = name.substring(1);</span>

<span class="pc bpc" id="L4606" title="1 of 2 branches missed.">		if (imageId &lt; 1) imageId = getImageId(dir, name);</span>

<span class="fc" id="L4608">		String path = Tools.getRealPath(dir);</span>
		try
		{
<span class="pc bpc" id="L4611" title="1 of 2 branches missed.">			if (imageId &gt; 0)</span>
			{
<span class="fc" id="L4613">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L4614">				ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L4615">				ps.setInt(1, imageId);</span>
<span class="fc" id="L4616">				ps.execute();</span>
<span class="fc" id="L4617">				ps.close();</span>
<span class="fc" id="L4618">				db_conn.close();</span>
<span class="fc" id="L4619">				ps = null;</span>
<span class="fc" id="L4620">				db_conn = null;</span>
			}
<span class="fc" id="L4622">			file = new IwcmFile(path + File.separator + name);</span>
<span class="pc bpc" id="L4623" title="1 of 2 branches missed.">			if (file.exists())</span>
			{
<span class="fc" id="L4625">				boolean ok = file.delete();</span>
<span class="fc" id="L4626">				Logger.debug(GalleryDB.class, &quot;Deleting file=&quot;+file.getAbsolutePath()+&quot; ok=&quot;+ok);</span>
			}
<span class="fc" id="L4628">			file = new IwcmFile(path + File.separator + &quot;s_&quot; + name);</span>
<span class="pc bpc" id="L4629" title="1 of 2 branches missed.">			if (file.exists())</span>
			{
<span class="fc" id="L4631">				boolean ok = file.delete();</span>
<span class="fc" id="L4632">				Logger.debug(GalleryDB.class, &quot;Deleting file=&quot;+file.getAbsolutePath()+&quot; ok=&quot;+ok);</span>
			}
<span class="fc" id="L4634">			file = new IwcmFile(path + File.separator + &quot;o_&quot; + name);</span>
<span class="pc bpc" id="L4635" title="1 of 2 branches missed.">			if (file.exists())</span>
			{
<span class="fc" id="L4637">				boolean ok = file.delete();</span>
<span class="fc" id="L4638">				Logger.debug(GalleryDB.class, &quot;Deleting file=&quot;+file.getAbsolutePath()+&quot; ok=&quot;+ok);</span>
			}
		}
<span class="nc" id="L4641">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="pc bpc" id="L4644" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L4645" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L4646">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="fc" id="L4648">	}</span>

	/**
	 * V databaze nastavi rozmer a rezim zmeny velkosti podadresarom podla nastaveneho adresara
	 * @param dir
	 * @param recursive
	 */
	public static void updateDirectoryDimToSubfolders(String dir) {
<span class="fc" id="L4656">		Dimension[] dims = getDimension(dir, true);</span>
<span class="fc" id="L4657">		String resizeMode = getResizeMode(dir, true);</span>
<span class="fc" id="L4658">		updateDirectoryDim(dir, dims[0], dims[1], resizeMode, true);</span>
<span class="fc" id="L4659">	}</span>

	private static void updateDirectoryDim(String dir, Dimension dim, Dimension dimNormal, String resizeMode, boolean recursive)
	{
<span class="fc" id="L4663">		IwcmFile directory = IwcmFile.fromVirtualPath(&quot;/&quot; + dir);</span>
<span class="pc bpc" id="L4664" title="2 of 4 branches missed.">		if (directory.exists() &amp;&amp; directory.isDirectory())</span>
		{
<span class="fc" id="L4666">			IwcmFile[] fileList = directory.listFiles();</span>
<span class="fc bfc" id="L4667" title="All 2 branches covered.">			for (IwcmFile file : fileList)</span>
			{
<span class="fc bfc" id="L4669" title="All 2 branches covered.">				if (file.isDirectory())</span>
				{
<span class="fc" id="L4671">					java.sql.Connection db_conn = null;</span>
<span class="fc" id="L4672">					java.sql.PreparedStatement ps = null;</span>

					try
					{
<span class="pc bpc" id="L4676" title="1 of 2 branches missed.">						if (!dir.equals(&quot;&quot;))</span>
						{
<span class="fc" id="L4678">							db_conn = DBPool.getConnection();</span>
<span class="fc" id="L4679">							ps = db_conn</span>
<span class="fc" id="L4680">								.prepareStatement(&quot;UPDATE gallery_dimension SET image_width=?, image_height=?, normal_width=?, normal_height=?, resize_mode=? WHERE image_path=?&quot;);</span>
<span class="fc" id="L4681">							ps.setInt(1, dim.width);</span>
<span class="fc" id="L4682">							ps.setInt(2, dim.height);</span>
<span class="fc" id="L4683">							ps.setInt(3, dimNormal.width);</span>
<span class="fc" id="L4684">							ps.setInt(4, dimNormal.height);</span>
<span class="fc" id="L4685">							ps.setString(5, resizeMode);</span>
<span class="fc" id="L4686">							ps.setString(6, normalizeDir(file.getVirtualPath()));</span>
<span class="fc" id="L4687">							ps.execute();</span>
<span class="fc" id="L4688">							ps.close();</span>
<span class="fc" id="L4689">							db_conn.close();</span>
<span class="fc" id="L4690">							db_conn = null;</span>
<span class="fc" id="L4691">							ps = null;</span>
						}
					}
<span class="nc" id="L4694">					catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
					finally{
						try{
<span class="pc bpc" id="L4697" title="1 of 2 branches missed.">							if (ps != null) ps.close();</span>
<span class="pc bpc" id="L4698" title="1 of 2 branches missed.">							if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L4699">						}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
					}

<span class="pc bpc" id="L4702" title="1 of 2 branches missed.">					if(recursive)</span>
<span class="fc" id="L4703">						updateDirectoryDim(normalizeDir(file.getVirtualPath()), dim, dimNormal, resizeMode, recursive);</span>
				}
			}
		}
<span class="fc" id="L4707">	}</span>

	/**
	 * aplikuje na &quot;obrazok&quot; vodotlac podla domeny
	 * @param obrazok
	 */
	public static void applyWatermarkOnUpload(IwcmFile obrazok)
	{
<span class="pc bpc" id="L4715" title="2 of 4 branches missed.">		if(obrazok == null || obrazok.exists() == false) return;</span>
<span class="fc" id="L4716">		String suffix = FileTools.getFileExtension(obrazok.getName().toLowerCase());</span>
<span class="pc bpc" id="L4717" title="3 of 4 branches missed.">		boolean shouldPerformWatermarking = existImageMagickCompositeCommand() &amp;&amp; Constants.getBoolean(&quot;galleryWatermarkApplyOnUpload&quot;)</span>
<span class="pc bnc" id="L4718" title="All 6 branches missed.">														&amp;&amp; (&quot;png&quot;.equals(suffix) || &quot;jpg&quot;.equals(suffix) || &quot;jpeg&quot;.equals(suffix));</span>

<span class="fc" id="L4720">		String[] exceptions = Tools.getTokens(Constants.getString(&quot;galleryWatermarkApplyOnUploadExceptions&quot;), &quot;,&quot;);</span>
<span class="pc bpc" id="L4721" title="2 of 4 branches missed.">		if (exceptions != null &amp;&amp; exceptions.length&gt;0)</span>
		{
<span class="fc bfc" id="L4723" title="All 2 branches covered.">			for (String exception : exceptions)</span>
			{
<span class="pc bpc" id="L4725" title="1 of 2 branches missed.">				if (obrazok.getAbsolutePath().contains(exception))	shouldPerformWatermarking = false;</span>
			}
		}

<span class="pc bpc" id="L4729" title="1 of 2 branches missed.">		if (shouldPerformWatermarking)</span>
		{
<span class="nc" id="L4731">			Logger.debug(GalleryDB.class, &quot;(applyWatermarkOnUpload) absolutePath=&quot;+obrazok.getAbsolutePath());</span>
<span class="nc" id="L4732">			GalleryDimension watermark = new GalleryDimension();</span>
<span class="nc" id="L4733">			watermark.setWatermarkPlacement(Constants.getString(&quot;galleryWatermarkGravity&quot;));</span>
<span class="nc" id="L4734">			watermark.setWatermarkSaturation(Constants.getInt(&quot;galleryWatermarkSaturation&quot;));</span>

<span class="nc" id="L4736">			RequestBean rb = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="nc" id="L4737">			String galleryWatermarkApplyOnUploadDir = Constants.getStringExecuteMacro(&quot;galleryWatermarkApplyOnUploadDir&quot;);</span>
<span class="nc bnc" id="L4738" title="All 2 branches missed.">			if(galleryWatermarkApplyOnUploadDir.endsWith(&quot;/&quot;) == false) galleryWatermarkApplyOnUploadDir += &quot;/&quot;;</span>
			//skusim skontrolovat obrazok pre vodotlac podla domeny
<span class="nc" id="L4740">			IwcmFile wmFile = new IwcmFile(Tools.getRealPath(galleryWatermarkApplyOnUploadDir+rb.getDomain()+&quot;.svg&quot;));</span>
			//ak nemam domenovy, pouzijem default
<span class="nc bnc" id="L4742" title="All 2 branches missed.">			if(wmFile.exists() == false) wmFile = new IwcmFile(Tools.getRealPath(galleryWatermarkApplyOnUploadDir+&quot;default.svg&quot;));</span>
<span class="nc bnc" id="L4743" title="All 2 branches missed.">			if(wmFile.exists() == false)</span>
			{
<span class="nc" id="L4745">				Logger.debug(GalleryDB.class, &quot;(applyWatermarkOnUpload) nemam watermark obrazok {domena=&quot;+rb.getDomain()+&quot;}: &quot;+wmFile.getVirtualPath());</span>
<span class="nc" id="L4746">				return;</span>
			}
<span class="nc" id="L4748">			watermark.setWatermark(wmFile.getVirtualPath());</span>
<span class="nc" id="L4749">			addWatermarkSignature(obrazok.getAbsolutePath(), watermark);</span>
		}
<span class="fc" id="L4751">	}</span>

	/**
	 * @deprecated - use GalleryDBTools.getImageSize
	 */
	@Deprecated
	public static int[] getImageSize(IwcmFile imageFile){
<span class="nc" id="L4758">		return GalleryDBTools.getImageSize(imageFile);</span>
    }

	/**
	 * @deprecated - use GalleryDBTools.cropAndResize
	 */
    @Deprecated
	public static int cropAndResize(IwcmFile from, int cwidth, int cheight, int cleft, int ctop, int finalWidth, int finalHeight, String fillColor, boolean exactFinalSize, IwcmFile to, int imageQuality, int ip)
	{
<span class="nc" id="L4767">		return GalleryDBTools.cropAndResize(from,cwidth,cheight,cleft,ctop,finalWidth,finalHeight,fillColor,exactFinalSize,to,imageQuality,ip);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>