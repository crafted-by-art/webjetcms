<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Documents.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.system.fulltext.indexed</a> &gt; <span class="el_source">Documents.java</span></div><h1>Documents.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.system.fulltext.indexed;

import static sk.iway.iwcm.system.fulltext.lucene.LuceneUtils.dateToLucene;
import static sk.iway.iwcm.system.fulltext.lucene.LuceneUtils.nvl;

import java.io.IOException;
import java.io.Writer;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.Collection;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.LinkedBlockingQueue;
import java.util.concurrent.TimeUnit;

import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.collections4.Predicate;
import org.apache.commons.collections4.Transformer;
import org.apache.lucene.document.Document;
import org.apache.lucene.document.Field;
import org.apache.lucene.document.NumericField;
import org.apache.lucene.index.IndexWriter;
import org.apache.lucene.index.IndexWriterConfig;
import org.apache.lucene.index.IndexWriterConfig.OpenMode;
import org.apache.lucene.index.Term;
import org.apache.lucene.util.Version;
import org.jsoup.Jsoup;
import org.jsoup.select.Elements;

import sk.iway.Html2Text;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DB;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.common.SearchTools;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.doc.DocDB;
import sk.iway.iwcm.doc.DocDetails;
import sk.iway.iwcm.doc.GroupDetails;
import sk.iway.iwcm.doc.GroupsDB;
import sk.iway.iwcm.doc.TemplateDetails;
import sk.iway.iwcm.doc.TemplatesDB;
import sk.iway.iwcm.editor.EditorDB;
import sk.iway.iwcm.editor.EditorForm;
import sk.iway.iwcm.system.fulltext.FulltextSearch;
import sk.iway.iwcm.system.fulltext.lucene.AnalyzerFactory;
import sk.iway.iwcm.system.fulltext.lucene.IndexSearcherBuilder;
import sk.iway.iwcm.system.fulltext.lucene.IndexingMapper;
import sk.iway.iwcm.system.fulltext.lucene.Lemmas;
import sk.iway.iwcm.system.fulltext.lucene.LuceneUtils;

/**
 * Documents.java
 *
 *@Title webjet7
 *@Company Interway s.r.o. (www.interway.sk)
 *@Copyright Interway s.r.o. (c) 2001-2011
 *@author $Author: jeeff thaber $
 *@version $Revision: 1.3 $
 *@created Date: 6.4.2011 18:04:19
 *@modified $Date: 2004/08/16 06:26:11 $
 */
public class Documents extends Indexed
{
<span class="fc" id="L70">	private static final String SELECTING_SQL = &quot;SELECT * FROM documents WHERE available=&quot;+DB.getBooleanSql(true)+&quot; and searchable=&quot;+DB.getBooleanSql(true)+&quot; AND (external_link IS NULL OR external_link NOT LIKE '/files/protected%') &quot;;</span>
<span class="fc" id="L71">	private static final String TOTAL_SQL = &quot;SELECT count(doc_id) FROM documents WHERE available=&quot;+DB.getBooleanSql(true)+&quot; and searchable=&quot;+DB.getBooleanSql(true)+&quot; AND (external_link IS NULL OR external_link NOT LIKE '/files/protected%') &quot;;</span>
	private String language;
	private Collection&lt;String&gt; paths;

	/**
	 *
	 */
	public Documents(final String language)
<span class="fc" id="L79">	{</span>
<span class="fc" id="L80">		this.language = language;</span>
<span class="fc" id="L81">		final GroupsDB gdb = GroupsDB.getInstance();</span>
<span class="fc" id="L82">		final String defaultLanguage = Constants.getString(&quot;defaultLanguage&quot;);</span>
<span class="fc" id="L83">		Collection&lt;String&gt; newPaths = CollectionUtils.collect(GroupsDB.getRootGroups(), new Transformer&lt;GroupDetails, String&gt;()</span>
<span class="fc" id="L84">		{</span>
			@Override
			public String transform(GroupDetails gd)
			{
<span class="fc bfc" id="L88" title="All 2 branches covered.">				if (&quot;system&quot;.equals(DB.internationalToEnglish(gd.getGroupName().toLowerCase())))</span>
<span class="fc" id="L89">					return null;</span>

<span class="fc" id="L91">				TemplateDetails template = TemplatesDB.getInstance().getTemplate(gd.getTempId());</span>
<span class="fc" id="L92">				String tempLng = defaultLanguage;</span>
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">				if (template != null) tempLng = template.getLng();</span>
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">				if (Tools.isEmpty(tempLng)) tempLng = &quot;sk&quot;;</span>

<span class="pc bpc" id="L96" title="1 of 2 branches missed.">				if (language.equals(tempLng))</span>
<span class="fc" id="L97">					return gdb.getGroupNamePath(gd.getGroupId());</span>

<span class="nc" id="L99">				return null;</span>
			}
		});
<span class="fc" id="L102">		this.paths = CollectionUtils.select(newPaths, new Predicate&lt;String&gt;()</span>
<span class="fc" id="L103">		{</span>
			@Override
			public boolean evaluate(String path)
			{
<span class="fc bfc" id="L107" title="All 2 branches covered.">				if (path != null)</span>
<span class="fc" id="L108">					return true;</span>
<span class="fc" id="L109">				return false;</span>
			}
		});
<span class="fc" id="L112">	}</span>

	public static String parseHeadings(String html) {

<span class="fc" id="L116">		StringBuilder headings = new StringBuilder();</span>
<span class="pc bpc" id="L117" title="2 of 4 branches missed.">		if (html != null &amp;&amp; html.length()&lt;30000000) {</span>
<span class="fc" id="L118">			org.jsoup.nodes.Document jsoup = Jsoup.parse(html);</span>
<span class="fc" id="L119">			Elements htags = jsoup.select(&quot;h1, h2, h3, h4, h5, h6&quot;);</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">			for (String heading : htags.eachText()) {</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">				if (headings.length()&gt;0) headings.append(&quot; &quot;);</span>
<span class="fc" id="L122">				headings.append(heading);</span>
<span class="fc" id="L123">			}</span>
		}
<span class="fc" id="L125">		return headings.toString();</span>
	}

	/**
     * Vrati Document na zaklade dodaneho ResultSet
     *
     * @param rs
     * @throws SQLException
     */
    public static Document toLuceneDocument(ResultSet rs, String language) throws SQLException
    {
<span class="fc" id="L136">        Document document = new Document();</span>
        try
        {
<span class="fc" id="L139">            int docId = rs.getInt(&quot;doc_id&quot;);</span>
<span class="fc" id="L140">            Logger.debug(Documents.class, &quot;toLuceneDocument, docid=&quot;+docId);</span>

<span class="fc" id="L142">				int groupId = rs.getInt(&quot;group_id&quot;);</span>
<span class="fc" id="L143">				int tempId = rs.getInt(&quot;temp_id&quot;);</span>

<span class="fc" id="L145">				String docLng = getDocumentLanguage(groupId, tempId);</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">				if (language.equals(docLng)==false)</span>
				{
<span class="fc" id="L148">					Logger.debug(Documents.class, docId+&quot; nesedi jazyk doc=&quot;+docLng+&quot; indexed language=&quot;+language);</span>
<span class="fc" id="L149">					return null;</span>
				}

<span class="fc" id="L152">            DocDB docDB = DocDB.getInstance();</span>

<span class="fc" id="L154">            document.add(new Field(&quot;doc_id&quot;, nvl(rs.getString(&quot;doc_id&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L155">            Field title = new Field(&quot;title&quot;, nvl(rs.getString(&quot;title&quot;))+&quot; &quot;+Lemmas.get(language, nvl(rs.getString(&quot;title&quot;))), Field.Store.YES, Field.Index.ANALYZED, Field.TermVector.WITH_POSITIONS_OFFSETS);</span>
<span class="fc" id="L156">            title.setBoost(10.0f);</span>
<span class="fc" id="L157">            document.add(title);</span>

            //doplnit to co sa pridava do DataASC - fulltextIncludeKeywords a fulltextIncludePerex a fulltextIncludeAttributes
<span class="fc" id="L160">            String dataDB = rs.getString(&quot;data&quot;);</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">            if (dataDB != null) Logger.debug(Documents.class, &quot;toLuceneDocument, dataDB size = &quot;+dataDB.length());</span>
<span class="nc" id="L162">            else Logger.debug(Documents.class, &quot;toLuceneDocument, dataDB is null&quot;);</span>

				//vykonaj !DOC_TITLE! znacky v texte
<span class="fc" id="L165">				dataDB = Tools.replace(dataDB, &quot;!DOC_TITLE!&quot;, nvl(rs.getString(&quot;title&quot;)));</span>

            String plainText;
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">            if (dataDB.length()&lt;2000000) plainText = SearchTools.htmlToPlain(dataDB);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">            else if (dataDB.length()&lt;30000000) plainText = Html2Text.html2text(dataDB);</span>
<span class="nc" id="L170">            else plainText = dataDB;</span>

<span class="fc" id="L172">            DocDetails doc = docDB.getDoc(docId);</span>
<span class="fc" id="L173">            EditorForm ef = new EditorForm(doc);</span>

<span class="fc" id="L175">            String data = EditorDB.getDataAsc(plainText, ef, true);</span>

<span class="fc" id="L177">            String htmlData = SearchTools.htmlToPlain(rs.getString(&quot;html_data&quot;));</span>

<span class="fc" id="L179">				Field headings = new Field(&quot;headings&quot;, Lemmas.get(language, parseHeadings(dataDB)), Field.Store.YES, Field.Index.ANALYZED, Field.TermVector.WITH_POSITIONS_OFFSETS);</span>
<span class="fc" id="L180">				headings.setBoost(5.0f);</span>

<span class="fc" id="L182">				document.add(headings);</span>
<span class="fc" id="L183">            document.add(new Field(&quot;data&quot;, nvl(data), Field.Store.YES, Field.Index.ANALYZED, Field.TermVector.WITH_POSITIONS_OFFSETS));</span>
<span class="fc" id="L184">            document.add(new Field(&quot;external_link&quot;, nvl(rs.getString(&quot;external_link&quot;)), Field.Store.NO, Field.Index.ANALYZED));</span>
<span class="fc" id="L185">            document.add(new Field(&quot;date_created&quot;, nvl(dateToLucene(rs.getTimestamp(&quot;date_created&quot;))), Field.Store.YES, Field.Index.ANALYZED));</span>

<span class="fc" id="L187">            Timestamp publishStart = rs.getTimestamp(&quot;publish_start&quot;);</span>
<span class="fc bfc" id="L188" title="All 2 branches covered.">            if (publishStart == null) publishStart = rs.getTimestamp(&quot;date_created&quot;);</span>

<span class="fc" id="L190">            document.add(new Field(&quot;publish_start&quot;, nvl(dateToLucene(publishStart)), Field.Store.YES,	Field.Index.ANALYZED));</span>
<span class="fc" id="L191">            document.add(new Field(&quot;publish_end&quot;, nvl(dateToLucene(rs.getTimestamp(&quot;publish_end&quot;))), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L192">            document.add(new NumericField(&quot;author_id&quot;, Field.Store.YES, true).setIntValue(rs.getInt(&quot;author_id&quot;)));</span>
<span class="fc" id="L193">            document.add(new NumericField(&quot;group_id&quot;, Field.Store.NO, true).setIntValue(rs.getInt(&quot;group_id&quot;)));</span>
<span class="fc" id="L194">            document.add(new NumericField(&quot;temp_id&quot;, Field.Store.NO, true).setIntValue(rs.getInt(&quot;temp_id&quot;)));</span>
<span class="fc" id="L195">            document.add(new Field(&quot;file_name&quot;, nvl(GroupsDB.getInstance().getGroupNamePath(rs.getInt(&quot;group_id&quot;))), Field.Store.NO, Field.Index.ANALYZED));</span>
<span class="fc" id="L196">            document.add(new NumericField(&quot;sort_priority&quot;, Field.Store.YES, true).setIntValue(rs.getInt(&quot;sort_priority&quot;))); //store.yes potrebujeme kvoli sortovaniu</span>
<span class="fc" id="L197">            addMultiValueField(rs.getString(&quot;password_protected&quot;), &quot;password_protected&quot;, document);</span>
<span class="fc" id="L198">            document.add(new Field(&quot;html_head&quot;, nvl(rs.getString(&quot;html_head&quot;)), Field.Store.NO, Field.Index.ANALYZED));</span>
<span class="fc" id="L199">            document.add(new Field(&quot;html_data&quot;, nvl(htmlData), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L200">            document.add(new Field(&quot;perex_place&quot;, nvl(rs.getString(&quot;perex_place&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L201">            document.add(new Field(&quot;perex_image&quot;, nvl(rs.getString(&quot;perex_image&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L202">            addStringValueField(rs.getString(&quot;perex_group&quot;), &quot;perex_group&quot;, document);</span>
<span class="fc" id="L203">            document.add(new Field(&quot;event_date&quot;, nvl(dateToLucene(rs.getTimestamp(&quot;event_date&quot;))), Field.Store.YES, Field.Index.ANALYZED));</span>

<span class="fc" id="L205">            document.add(new Field(&quot;field_a&quot;, nvl(rs.getString(&quot;field_a&quot;)), Field.Store.NO, Field.Index.ANALYZED));</span>
<span class="fc" id="L206">            document.add(new Field(&quot;field_b&quot;, nvl(rs.getString(&quot;field_b&quot;)), Field.Store.NO, Field.Index.ANALYZED));</span>
<span class="fc" id="L207">            document.add(new Field(&quot;field_c&quot;, nvl(rs.getString(&quot;field_c&quot;)), Field.Store.NO, Field.Index.ANALYZED));</span>
<span class="fc" id="L208">            document.add(new Field(&quot;field_d&quot;, nvl(rs.getString(&quot;field_d&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L209">            document.add(new Field(&quot;field_e&quot;, nvl(rs.getString(&quot;field_e&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L210">            document.add(new Field(&quot;field_f&quot;, nvl(rs.getString(&quot;field_f&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L211">            document.add(new Field(&quot;field_g&quot;, nvl(rs.getString(&quot;field_g&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L212">            document.add(new Field(&quot;field_h&quot;, nvl(rs.getString(&quot;field_h&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L213">            document.add(new Field(&quot;field_i&quot;, nvl(rs.getString(&quot;field_i&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L214">            document.add(new Field(&quot;field_j&quot;, nvl(rs.getString(&quot;field_j&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L215">            document.add(new Field(&quot;field_k&quot;, nvl(rs.getString(&quot;field_k&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L216">            document.add(new Field(&quot;field_l&quot;, nvl(rs.getString(&quot;field_l&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L217">				document.add(new Field(&quot;field_m&quot;, nvl(rs.getString(&quot;field_m&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L218">				document.add(new Field(&quot;field_n&quot;, nvl(rs.getString(&quot;field_n&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L219">				document.add(new Field(&quot;field_o&quot;, nvl(rs.getString(&quot;field_o&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L220">				document.add(new Field(&quot;field_p&quot;, nvl(rs.getString(&quot;field_p&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L221">				document.add(new Field(&quot;field_q&quot;, nvl(rs.getString(&quot;field_q&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L222">				document.add(new Field(&quot;field_r&quot;, nvl(rs.getString(&quot;field_r&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L223">				document.add(new Field(&quot;field_s&quot;, nvl(rs.getString(&quot;field_s&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>
<span class="fc" id="L224">				document.add(new Field(&quot;field_t&quot;, nvl(rs.getString(&quot;field_t&quot;)), Field.Store.YES, Field.Index.ANALYZED));</span>

<span class="fc" id="L226">            document.add(typeField(&quot;documents&quot;));</span>
<span class="fc" id="L227">            String url = DocDB.getInstance().getDocLink(rs.getInt(&quot;doc_id&quot;));</span>
<span class="fc" id="L228">            document.add(urlField(url));</span>

<span class="fc" id="L230">            Logger.debug(Documents.class, &quot;toLuceneDocument DONE, docid=&quot;+rs.getString(&quot;doc_id&quot;));</span>
        }
<span class="nc" id="L232">        catch (Exception e)</span>
        {
<span class="nc" id="L234">            sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L235">        }</span>
<span class="fc" id="L236">        return document;</span>
    }

	public static void addMultiValueField(String value, String name, Document document)
    {
<span class="fc bfc" id="L241" title="All 2 branches covered.">        if (Tools.isNotEmpty(value))</span>
        {
<span class="fc bfc" id="L243" title="All 2 branches covered.">            for (String part : value.split(&quot;,&quot;))</span>
            {
<span class="fc bfc" id="L245" title="All 2 branches covered.">                if (Tools.isNotEmpty(part))</span>
                {
<span class="fc" id="L247">                    document.add(new NumericField(name, Field.Store.YES, true).setIntValue(Integer.parseInt(part)));</span>
                }
            }
        }
        else
        {
            //document.add(new Field(name, LuceneUtils.EMPTY, Field.Store.YES, Field.Index.ANALYZED));
            //jeeff: nemozeme kombinovat numeric a non numeric fieldy, zle to potom hlada
<span class="fc" id="L255">            document.add(new NumericField(name, Field.Store.YES, true).setIntValue(0));</span>
        }
<span class="fc" id="L257">    }</span>

	private static void addStringValueField(String value, String name, Document document)
    {
<span class="fc bfc" id="L261" title="All 2 branches covered.">        if (Tools.isNotEmpty(value))</span>
        {
<span class="fc bfc" id="L263" title="All 2 branches covered.">            for (String part : value.split(&quot;,&quot;))</span>
            {
<span class="fc bfc" id="L265" title="All 2 branches covered.">                if (Tools.isNotEmpty(part))</span>
                {
<span class="fc" id="L267">                    document.add(new Field(name, part, Field.Store.YES, Field.Index.ANALYZED));</span>
                }
            }
        }
        else
        {
<span class="fc" id="L273">            document.add(new Field(name, LuceneUtils.EMPTY, Field.Store.YES, Field.Index.ANALYZED));</span>
        }
<span class="fc" id="L275">    }</span>

	public static Field typeField(String indexed){
<span class="fc" id="L278">        return new Field(&quot;type&quot;,indexed,Field.Store.YES,</span>
                    Field.Index.ANALYZED);
    }

	public static Field urlField(String url){
<span class="fc" id="L283">        return new Field(&quot;url&quot;,nvl(url),Field.Store.YES,</span>
                    Field.Index.NO);
    }

	@Override
	public String language()
	{
<span class="fc" id="L290">		return this.language;</span>
	}

<span class="fc" id="L293">	private ExecutorService executor = Executors.newFixedThreadPool(5);// indexWriter umoznuje pristup max 5 vlakien naraz, opravene je to az v 4.0</span>
<span class="fc" id="L294">	private BlockingQueue&lt;Document&gt; queue = new LinkedBlockingQueue&lt;&gt;(50);</span>
<span class="fc" id="L295">	private WriterThread save = new WriterThread();</span>

	static final class DocumentsIndexingMapper extends IndexingMapper {

		private Documents documents;

		/**
		 * @param writer
		 */
		public DocumentsIndexingMapper(IndexWriter writer, Documents documents, Writer log)
		{
<span class="fc" id="L306">			super(writer,log);</span>
<span class="fc" id="L307">			this.documents = documents;</span>
<span class="fc" id="L308">			documents.save.setIndexed(documents);</span>
<span class="fc" id="L309">			documents.save.setQueue(documents.queue);</span>
<span class="fc" id="L310">			documents.save.setWriter(writer);</span>
<span class="fc" id="L311">			documents.save.setLog(log);</span>
<span class="fc" id="L312">		}</span>

		@Override
		public Void map(ResultSet rs) throws SQLException
		{
			try
			{
<span class="fc" id="L319">				final Document document = toLuceneDocument(rs, documents.language);</span>
<span class="fc bfc" id="L320" title="All 2 branches covered.">				if (document != null) documents.queue.put(document);</span>
<span class="fc" id="L321">				documents.executor.execute(documents.save);</span>
			}
<span class="nc" id="L323">			catch (SQLException|InterruptedException e)</span>
			{
<span class="nc" id="L325">				sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L326">			}</span>
<span class="fc" id="L327">			return null;</span>
		}
	}

<span class="fc" id="L331">	static final class WriterThread implements Runnable {</span>

		private IndexWriter writer;
		private BlockingQueue&lt;Document&gt; queue;
		private Indexed indexed;
		private Writer log;



		/**
		 * @param indexed The indexed to set.
		 */
		public void setIndexed(Indexed indexed)
		{
<span class="fc" id="L345">			this.indexed = indexed;</span>
<span class="fc" id="L346">		}</span>


		/**
		 * @param log The log to set.
		 */
		public void setLog(Writer log)
		{
<span class="fc" id="L354">			this.log = log;</span>
<span class="fc" id="L355">		}</span>

		/**
		 * @param writer The writer to set.
		 */
		public void setWriter(IndexWriter writer)
		{
<span class="fc" id="L362">			this.writer = writer;</span>
<span class="fc" id="L363">		}</span>

		/**
		 * @param queue The queue to set.
		 */
		public void setQueue(BlockingQueue&lt;Document&gt; queue)
		{
<span class="fc" id="L370">			this.queue = queue;</span>
<span class="fc" id="L371">		}</span>

<span class="fc" id="L373">		int count = 0;</span>
		@Override
		public void run()
		{
			try
			{
<span class="fc" id="L379">				Thread.currentThread().setName(&quot;Documents&quot;);</span>
<span class="fc" id="L380">				Document document = queue.poll(100, TimeUnit.MILLISECONDS);</span>
<span class="fc bfc" id="L381" title="All 2 branches covered.">				if (document != null)</span>
				{
<span class="fc" id="L383">					writer.addDocument(document);</span>
<span class="fc" id="L384">					count++;</span>
<span class="fc bfc" id="L385" title="All 2 branches covered.">					if (count % 100 == 0)</span>
					{
<span class="fc" id="L387">						FulltextSearch.log(Documents.class, &quot;Indexed &quot; + count + &quot; documents, last doc_id=&quot;+document.get(&quot;doc_id&quot;)+&quot; title=&quot;+document.get(&quot;title&quot;), log);</span>
					}
				}
			}
<span class="nc" id="L391">			catch (IOException|InterruptedException e)</span>
			{
<span class="nc" id="L393">				sk.iway.iwcm.Logger.error(e);</span>
			}
			finally{
<span class="fc" id="L396">				indexed.proccessed();</span>
			}
<span class="fc" id="L398">		}</span>
	}


	@Override
	public IndexingMapper mapper(IndexWriter writer,Writer log)
	{
<span class="fc" id="L405">		return new DocumentsIndexingMapper(writer, this,log);</span>
	}

	private String pathsLikeString()
	{
<span class="fc" id="L410">		StringBuilder pathsLike = new StringBuilder();</span>
<span class="pc bpc" id="L411" title="1 of 2 branches missed.">		if (paths.size() &gt; 0)</span>
		{
<span class="fc" id="L413">			String prefix = &quot; AND ( &quot;;</span>
<span class="fc" id="L414">			pathsLike.append(prefix);</span>
<span class="fc bfc" id="L415" title="All 2 branches covered.">			for (String p : paths)</span>
			{
				// not the first
<span class="fc bfc" id="L418" title="All 2 branches covered.">				if (pathsLike.length() != prefix.length())</span>
				{
<span class="fc" id="L420">					pathsLike.append(&quot; OR &quot;);</span>
				}
<span class="fc" id="L422">				pathsLike.append(&quot; file_name like '&quot;);</span>
<span class="fc" id="L423">				pathsLike.append(p);</span>
<span class="fc" id="L424">				pathsLike.append(&quot;%'&quot;);</span>
<span class="fc" id="L425">			}</span>
<span class="fc" id="L426">			pathsLike.append(&quot; ) &quot;);</span>
		}
<span class="fc" id="L428">		return pathsLike.toString();</span>
	}

	/* THA verzia
	private static Document toLuceneDocument(ResultSet rs) throws SQLException
	{
		Document document = new Document();
		try
		{
			DocDB docDB = DocDB.getInstance();
			document.add(new Field(&quot;doc_id&quot;, nvl(rs.getString(&quot;doc_id&quot;)), Field.Store.YES, Field.Index.ANALYZED));
			document.add(new NumericField(&quot;temp_id&quot;, Field.Store.NO, true).setIntValue(rs.getInt(&quot;temp_id&quot;)));
			document.add(new NumericField(&quot;sort_priority&quot;, Field.Store.NO, true).setIntValue(rs.getInt(&quot;sort_priority&quot;)));
			document.add(new NumericField(&quot;group_id&quot;, Field.Store.YES, true).setIntValue(rs.getInt(&quot;group_id&quot;)));
			document.add(new Field(&quot;html_head&quot;, nvl(rs.getString(&quot;html_head&quot;)), Field.Store.NO, Field.Index.ANALYZED));

			//doplnit to co sa pridava do DataASC - fulltextIncludeKeywords a fulltextIncludePerex a fulltextIncludeAttributes

			StringBuilder data = new StringBuilder(rs.getString(&quot;data&quot;));

			String perexGroup = rs.getString(&quot;perex_group&quot;);
			if (Constants.getBoolean(&quot;fulltextIncludeKeywords&quot;) &amp;&amp; Tools.isNotEmpty(perexGroup))
			{
				String perexGroupIds[] = Tools.getTokens(perexGroup, &quot;,&quot;);
				if (perexGroupIds != null)
				{
					String keywords = null;
					for (String keyword : perexGroupIds)
					{
						keyword = docDB.convertPerexGroupIdToName(Tools.getIntValue(keyword, -1));
						if (Tools.isEmpty(keyword) || keyword.startsWith(&quot;#&quot;)) continue;
						if (keywords == null) keywords = keyword;
						else keywords += &quot;, &quot;+keyword;
					}
					if (Tools.isNotEmpty(keywords))
					{
						data.append(&quot; &quot;).append(DB.internationalToEnglish(keywords).trim().toLowerCase());
					}
				}
			}

			String htmlData = SearchAction.htmlToPlain(rs.getString(&quot;html_data&quot;));
			if (Constants.getBoolean(&quot;fulltextIncludePerex&quot;))
			{
				data.append(&quot; &quot;).append(htmlData);
			}

			//ak treba dopln atributy
			if (Constants.getBoolean(&quot;fulltextIncludeAttributes&quot;))
			{
				try
				{
					List&lt;AtrBean&gt; attrs = AtrDB.getAtributes(rs.getInt(&quot;doc_id&quot;), null, null);	//ziskam vsetky atributy pre danu stranku
					if (attrs != null &amp;&amp; attrs.size() &gt; 0)
					{
						String attributes = null;
						for (AtrBean attr : attrs)
						{
							if (attr == null) continue;
							if(Tools.isNotEmpty(attr.getAtrName()) &amp;&amp; Tools.isNotEmpty(attr.getValueString()))
							{
								if (attributes == null) attributes = attr.getAtrName() + &quot;=&quot; + attr.getValueString();
								else attributes += &quot;, &quot;+attr.getAtrName() + &quot;=&quot; + attr.getValueString();
							}
						}

						if (Tools.isNotEmpty(attributes))
						{
							data.append(&quot; &quot;).append(DB.internationalToEnglish(attributes).trim().toLowerCase());
						}
					}
				} catch (Exception ex) {}
			}

			document.add(new Field(&quot;data&quot;, nvl(data.toString()), Field.Store.YES, Field.Index.ANALYZED,
						TermVector.WITH_POSITIONS_OFFSETS));
			document.add(new Field(&quot;html_data&quot;, nvl(htmlData), Field.Store.YES,
						Field.Index.ANALYZED));
			document.add(new Field(&quot;field_a&quot;, nvl(rs.getString(&quot;field_a&quot;)), Field.Store.YES, Field.Index.ANALYZED));
			document.add(new Field(&quot;field_b&quot;, nvl(rs.getString(&quot;field_b&quot;)), Field.Store.YES, Field.Index.ANALYZED));
			document.add(new Field(&quot;field_c&quot;, nvl(rs.getString(&quot;field_c&quot;)), Field.Store.YES, Field.Index.ANALYZED));
			document.add(new Field(&quot;field_d&quot;, nvl(rs.getString(&quot;field_d&quot;)), Field.Store.YES, Field.Index.ANALYZED));
			document.add(new Field(&quot;field_e&quot;, nvl(rs.getString(&quot;field_e&quot;)), Field.Store.YES, Field.Index.ANALYZED));
			document.add(new Field(&quot;field_f&quot;, nvl(rs.getString(&quot;field_f&quot;)), Field.Store.NO, Field.Index.ANALYZED));
			document.add(new Field(&quot;field_g&quot;, nvl(rs.getString(&quot;field_g&quot;)), Field.Store.NO, Field.Index.ANALYZED));
			document.add(new Field(&quot;field_h&quot;, nvl(rs.getString(&quot;field_h&quot;)), Field.Store.NO, Field.Index.ANALYZED));
			document.add(new Field(&quot;field_i&quot;, nvl(rs.getString(&quot;field_i&quot;)), Field.Store.NO, Field.Index.ANALYZED));
			document.add(new Field(&quot;field_j&quot;, nvl(rs.getString(&quot;field_j&quot;)), Field.Store.NO, Field.Index.ANALYZED));
			document.add(new Field(&quot;field_k&quot;, nvl(rs.getString(&quot;field_k&quot;)), Field.Store.NO, Field.Index.ANALYZED));
			document.add(new Field(&quot;field_l&quot;, nvl(rs.getString(&quot;field_l&quot;)), Field.Store.NO, Field.Index.ANALYZED));
			document.add(new Field(&quot;publish_start&quot;, nvl(dateToLucene(rs.getDate(&quot;publish_start&quot;))), Field.Store.YES,	Field.Index.ANALYZED));
			document.add(new Field(&quot;publish_end&quot;, nvl(dateToLucene(rs.getDate(&quot;publish_end&quot;))), Field.Store.YES, Field.Index.ANALYZED));
			document.add(new Field(&quot;perex_place&quot;, nvl(rs.getString(&quot;perex_place&quot;)), Field.Store.YES, Field.Index.ANALYZED));
			Field title = new Field(&quot;title&quot;, nvl(rs.getString(&quot;title&quot;)), Field.Store.YES, Field.Index.ANALYZED, TermVector.WITH_POSITIONS_OFFSETS);
			title.setBoost(2.0f);
			document.add(title);
			document.add(new Field(&quot;date_created&quot;, nvl(dateToLucene(rs.getDate(&quot;date_created&quot;))), Field.Store.YES, Field.Index.ANALYZED));
			document.add(new Field(&quot;file_name&quot;, nvl(GroupsDB.getInstance().getGroupNamePath(rs.getInt(&quot;group_id&quot;))), Field.Store.NO, Field.Index.ANALYZED));
			document.add(new Field(&quot;external_link&quot;, nvl(rs.getString(&quot;external_link&quot;)), Field.Store.YES, Field.Index.ANALYZED));
			addMultiValueField(rs.getString(&quot;password_protected&quot;), &quot;password_protected&quot;, document);
			addStringValueField(rs.getString(&quot;perex_group&quot;), &quot;perex_group&quot;, document);
			document.add(typeField(&quot;documents&quot;));
			String url = DocDB.getInstance().getDocLink(rs.getInt(&quot;doc_id&quot;));
			document.add(urlField(url));
		}
		catch (Exception e){
			sk.iway.iwcm.Logger.error(e);
		}
		return document;
	}
	*/


<span class="fc" id="L541">	static int  count = 0;</span>
	@Override
	public String sql()
	{
<span class="fc" id="L545">		return SELECTING_SQL + pathsLikeString();</span>
	}

	@Override
	public String name()
	{
<span class="fc" id="L551">		return &quot;documents&quot;;</span>
	}


	@Override
	public int numberOfDocuments()
	{
<span class="fc" id="L558">		return new SimpleQuery().forInt(TOTAL_SQL + pathsLikeString());</span>
	}

	/*
	 * (non-Javadoc)
	 *
	 * @see sk.iway.iwcm.system.fulltext.Indexed#close()
	 */
	@Override
	public void close()
	{
<span class="fc" id="L569">		executor.shutdownNow();</span>
<span class="fc" id="L570">	}</span>

	/**
	 * Obnovi v indexe dokument
	 *
	 * @param docId
	 */
	public static void updateSingleDocument(int docId)
	{
<span class="pc bpc" id="L579" title="1 of 2 branches missed.">		if (Constants.getBoolean(&quot;luceneIncrementalDocumentIndexing&quot;))</span>
		{
<span class="fc" id="L581">			Connection db_conn = null;</span>
<span class="fc" id="L582">			PreparedStatement ps = null;</span>
<span class="fc" id="L583">			ResultSet rs = null;</span>
<span class="fc" id="L584">			IndexWriter writer = null;</span>
			try
			{
<span class="fc" id="L587">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L588">				ps = db_conn.prepareStatement(&quot;SELECT * FROM documents WHERE doc_id = ? &quot;);</span>
<span class="fc" id="L589">				ps.setInt(1, docId);</span>
<span class="fc" id="L590">				rs = ps.executeQuery();</span>
<span class="pc bpc" id="L591" title="1 of 2 branches missed.">				if (rs.next())</span>
				{
<span class="fc" id="L593">					int groupId = rs.getInt(&quot;group_id&quot;);</span>
<span class="fc" id="L594">					int tempId = rs.getInt(&quot;temp_id&quot;);</span>
<span class="fc" id="L595">					String lng = getDocumentLanguage(groupId, tempId);</span>

<span class="fc" id="L597">					IndexWriterConfig config = new IndexWriterConfig(Version.LUCENE_31, AnalyzerFactory.getAnalyzer(Version.LUCENE_31, lng));</span>
<span class="fc" id="L598">					config.setOpenMode(OpenMode.APPEND);</span>
<span class="fc" id="L599">					writer = new IndexWriter(FulltextSearch.getIndexDirectory(lng), config);</span>
<span class="pc bpc" id="L600" title="1 of 6 branches missed.">					if(rs.getBoolean(&quot;available&quot;) == false || rs.getBoolean(&quot;searchable&quot;) == false || isProtectedFile(rs.getString(&quot;external_link&quot;)))</span>
					{
<span class="fc" id="L602">						writer.deleteDocuments(new Term(&quot;doc_id&quot;, Integer.toString(docId)));</span>
					}
					else
					{
<span class="fc" id="L606">						Document luceneDoc = toLuceneDocument(rs, lng);</span>
<span class="pc bpc" id="L607" title="1 of 2 branches missed.">						if (luceneDoc == null) writer.deleteDocuments(new Term(&quot;doc_id&quot;, Integer.toString(docId)));</span>
<span class="fc" id="L608">						else writer.updateDocument(new Term(&quot;doc_id&quot;, Integer.toString(docId)), luceneDoc);</span>
					}
<span class="fc" id="L610">					writer.commit();</span>
<span class="fc" id="L611">					writer.close();</span>
<span class="fc" id="L612">					writer = null;</span>
<span class="fc" id="L613">					IndexSearcherBuilder.refresh();</span>
				}
<span class="fc" id="L615">				rs.close();</span>
<span class="fc" id="L616">				ps.close();</span>
<span class="fc" id="L617">				db_conn.close();</span>
<span class="fc" id="L618">				rs = null;</span>
<span class="fc" id="L619">				ps = null;</span>
<span class="fc" id="L620">				db_conn = null;</span>
			}
<span class="fc" id="L622">			catch (Exception ex)</span>
			{
<span class="fc" id="L624">				sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="fc bfc" id="L630" title="All 2 branches covered.">					if (rs != null)</span>
<span class="fc" id="L631">						rs.close();</span>
<span class="fc bfc" id="L632" title="All 2 branches covered.">					if (ps != null)</span>
<span class="fc" id="L633">						ps.close();</span>
<span class="fc bfc" id="L634" title="All 2 branches covered.">					if (db_conn != null)</span>
<span class="fc" id="L635">						db_conn.close();</span>
				}
<span class="nc" id="L637">				catch (Exception ex2)</span>
				{
<span class="fc" id="L639">				}</span>
				try
				{
<span class="pc bpc" id="L642" title="1 of 2 branches missed.">					if (writer != null) writer.close();</span>
				}
<span class="nc" id="L644">				catch (Exception e)</span>
				{
<span class="fc" id="L646">				}</span>
			}
		}


<span class="fc" id="L651">	}</span>

	/**
	 * Zmaze dokument z indexu
	 *
	 * @param docId
	 */
	public static void deleteSingleDocument(int docId)
	{
<span class="pc bpc" id="L660" title="1 of 2 branches missed.">		if (Constants.getBoolean(&quot;luceneIncrementalDocumentIndexing&quot;))</span>
		{
<span class="fc" id="L662">			Connection db_conn = null;</span>
<span class="fc" id="L663">			PreparedStatement ps = null;</span>
<span class="fc" id="L664">			ResultSet rs = null;</span>
			try
			{
<span class="fc" id="L667">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L668">				ps = db_conn.prepareStatement(&quot;SELECT * FROM documents WHERE doc_id = ? &quot;);</span>
<span class="fc" id="L669">				ps.setInt(1, docId);</span>
<span class="fc" id="L670">				rs = ps.executeQuery();</span>
<span class="pc bpc" id="L671" title="1 of 2 branches missed.">				while (rs.next())</span>
				{
<span class="nc" id="L673">					int tempId = GroupsDB.getInstance().getGroup(rs.getInt(&quot;group_id&quot;)).getTempId();</span>
<span class="nc" id="L674">					String lng = TemplatesDB.getInstance().getTemplate(tempId).getLng();</span>
<span class="nc" id="L675">					IndexWriterConfig config = new IndexWriterConfig(Version.LUCENE_31, AnalyzerFactory.getAnalyzer(Version.LUCENE_31, lng));</span>
<span class="nc" id="L676">					config.setOpenMode(OpenMode.APPEND);</span>
<span class="nc" id="L677">					IndexWriter writer = new IndexWriter(FulltextSearch.getIndexDirectory(lng), config);</span>
<span class="nc" id="L678">					writer.deleteDocuments(new Term(&quot;doc_id&quot;, Integer.toString(docId)));</span>
<span class="nc" id="L679">					writer.commit();</span>
<span class="nc" id="L680">					writer.close();</span>
<span class="nc" id="L681">					IndexSearcherBuilder.refresh();</span>
<span class="nc" id="L682">				}</span>
<span class="fc" id="L683">				rs.close();</span>
<span class="fc" id="L684">				ps.close();</span>
<span class="fc" id="L685">				db_conn.close();</span>
<span class="fc" id="L686">				rs = null;</span>
<span class="fc" id="L687">				ps = null;</span>
<span class="fc" id="L688">				db_conn = null;</span>
			}
<span class="nc" id="L690">			catch (Exception ex)</span>
			{
<span class="nc" id="L692">				sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L698" title="1 of 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L699">						rs.close();</span>
<span class="pc bpc" id="L700" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L701">						ps.close();</span>
<span class="pc bpc" id="L702" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L703">						db_conn.close();</span>
				}
<span class="nc" id="L705">				catch (Exception ex2)</span>
				{
<span class="fc" id="L707">				}</span>
			}
		}
<span class="fc" id="L710">	}</span>

	/**
	 * Vrati jazyk dokumentu pre zadane id priecinku a sablony
	 * @param groupId
	 * @param tempId
	 * @return
	 */
	private static String getDocumentLanguage(int groupId, int tempId)
	{
<span class="fc" id="L720">		GroupDetails group = GroupsDB.getInstance().getGroup(groupId);</span>
<span class="fc" id="L721">		TemplateDetails temp = TemplatesDB.getInstance().getTemplate(tempId);</span>
<span class="fc bfc" id="L722" title="All 4 branches covered.">		if (group != null &amp;&amp; Tools.isNotEmpty(group.getLng()))</span>
		{
<span class="fc" id="L724">			return group.getLng();</span>
		}
<span class="pc bpc" id="L726" title="2 of 4 branches missed.">		if (temp != null &amp;&amp; Tools.isNotEmpty(temp.getLng()))</span>
		{
<span class="fc" id="L728">			return temp.getLng();</span>
		}
<span class="nc" id="L730">		String defaultLanguage = Constants.getString(&quot;defaultLanguage&quot;);</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">		if (Tools.isEmpty(defaultLanguage)) defaultLanguage = &quot;sk&quot;;</span>

<span class="nc" id="L733">		return defaultLanguage;</span>
	}

	private static boolean isProtectedFile(String externalLink) {
<span class="pc bpc" id="L737" title="1 of 4 branches missed.">		if (Tools.isNotEmpty(externalLink) &amp;&amp; externalLink.startsWith(&quot;/files/protected&quot;)) return true;</span>
<span class="fc" id="L738">		return false;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>