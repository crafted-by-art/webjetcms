<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SyncDirAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.stripes</a> &gt; <span class="el_source">SyncDirAction.java</span></div><h1>SyncDirAction.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.stripes;

import java.beans.XMLDecoder;
import java.io.BufferedOutputStream;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.nio.charset.StandardCharsets;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Timestamp;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Comparator;
import java.util.ConcurrentModificationException;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.StringTokenizer;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

import javax.servlet.http.HttpServletRequest;

import org.apache.commons.beanutils.BeanUtils;
import org.json.JSONArray;
import org.json.JSONObject;
import org.slf4j.LoggerFactory;

import net.sourceforge.stripes.action.ActionBeanContext;
import net.sourceforge.stripes.action.ForwardResolution;
import net.sourceforge.stripes.action.Resolution;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.FileTools;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.PathFilter;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.common.SearchTools;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.doc.DocDB;
import sk.iway.iwcm.doc.DocDetails;
import sk.iway.iwcm.doc.GroupDetails;
import sk.iway.iwcm.doc.GroupsDB;
import sk.iway.iwcm.doc.PerexGroupBean;
import sk.iway.iwcm.doc.TemplateDetails;
import sk.iway.iwcm.doc.TemplatesDB;
import sk.iway.iwcm.editor.DocNoteBean;
import sk.iway.iwcm.editor.EditorDB;
import sk.iway.iwcm.editor.EditorForm;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.io.IwcmFile;
import sk.iway.iwcm.io.IwcmInputStream;
import sk.iway.iwcm.io.IwcmOutputStream;
import sk.iway.iwcm.sync.WarningListener;
import sk.iway.iwcm.sync.export.Content;
import sk.iway.iwcm.sync.inport.BannerImporter;
import sk.iway.iwcm.sync.inport.ContentBannerBean;
import sk.iway.iwcm.sync.inport.ContentFileBean;
import sk.iway.iwcm.sync.inport.ContentGalleryBean;
import sk.iway.iwcm.sync.inport.ContentInquiryBean;
import sk.iway.iwcm.sync.inport.GalleryImporter;
import sk.iway.iwcm.sync.inport.InquiryImporter;
import sk.iway.iwcm.sync.inport.Numbered;
import sk.iway.iwcm.system.stripes.WebJETActionBean;
import sk.iway.iwcm.users.UserGroupDetails;
import sk.iway.iwcm.users.UserGroupsDB;
import sk.iway.iwcm.users.UsersDB;
import sk.iway.spirit.MediaDB;
import sk.iway.spirit.model.Media;

/**
 *  SyncDirAction.java - synchronizacia adresara a web stranok zo vzdialeneho servera
 *
 *@Title        webjet4
 *@Company      Interway s.r.o. (www.interway.sk)
 *@Copyright    Interway s.r.o. (c) 2001-2007
 *@author       $Author: jeeff $
 *@version      $Revision: 1.11 $
 *@created      Date: 8.11.2007 13:37:13
 *@modified     $Date: 2010/02/09 09:02:04 $
 */
<span class="fc" id="L94">public class SyncDirAction extends WebJETActionBean</span>
{
<span class="fc" id="L96">	private static org.slf4j.Logger log = LoggerFactory.getLogger(SyncDirAction.class);</span>

	private int localGroupId;
	private int remoteGroupId;
	private String localDomain;

<span class="fc" id="L102">	private List&lt;GroupDetails&gt; remoteGroups = null;</span>
<span class="fc" id="L103">	private List&lt;DocDetails&gt; remoteDocs = null;</span>
<span class="fc" id="L104">	private List&lt;TemplateDetails&gt; remoteTemps = null;</span>
<span class="fc" id="L105">	private List&lt;UserGroupDetails&gt; remoteUserGroups = null;</span>
<span class="fc" id="L106">	private List&lt;PerexGroupBean&gt; remotePerexGroups = null;</span>
<span class="fc" id="L107">	private List&lt;Media&gt; remoteMedia = null;</span>
<span class="fc" id="L108">	private Content remoteContent = null;</span>

<span class="fc" id="L110">	private String remoteRootPath = null;</span>
<span class="fc" id="L111">	private GroupDetails localRootGroup = null;</span>

<span class="fc" id="L113">	private boolean createMissingTemplates = true;</span>
<span class="fc" id="L114">	private boolean createMissingUserGroups = true;</span>

<span class="fc" id="L116">	private String syncDir = null; // if null use remoteServer else use local files for sync</span>

<span class="fc" id="L118">	private Map&lt;Integer, DocNoteBean&gt; remoteNotesMap = null;</span>

<span class="fc" id="L120">	private List&lt;String&gt; errorMessages = new ArrayList&lt;&gt;();</span>

	/**
	 * Nacita data zo vzdialeneho servera
	 * @return
	 */
	public Resolution btnLoadData()
	{
		//aby sa nam vymazala cache (ak je pouzita)
<span class="fc" id="L129">		remoteGroups = null;</span>
<span class="fc" id="L130">		remoteDocs = null;</span>
<span class="fc" id="L131">		Logger.debug(SyncDirAction.class, &quot;btnLoadData Reading remote groups&quot;);</span>

		try
		{
<span class="fc" id="L135">			remoteGroups = getRemoteGroups();</span>
<span class="fc" id="L136">			remoteDocs = getRemoteDocs();</span>
		}
<span class="nc" id="L138">		catch (Exception e)</span>
		{
<span class="nc" id="L140">			sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L141">		}</span>

<span class="fc" id="L143">		Logger.debug(SyncDirAction.class, &quot;btnLoadData Remote groups=&quot;+remoteGroups);</span>
<span class="pc bpc" id="L144" title="2 of 4 branches missed.">		if (remoteGroups == null || remoteDocs == null)</span>
		{
<span class="nc" id="L146">			context.getRequest().setAttribute(&quot;errorText&quot;, Prop.getInstance(getRequest()).getText(&quot;components.sync.errorReadingZipFile&quot;, getErrorMessagesHtml()));</span>
		}
<span class="fc" id="L148">		remoteContent = getRemoteContent();</span>

<span class="fc" id="L150">		return new ForwardResolution(&quot;/components/maybeError.jsp&quot;);</span>
	}

	/**
	 * Vykonanie synchronizacie adresarov a stranok z remote servera na local
	 * @return
	 */
	public Resolution btnSync()
	{
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">		if (isAdminLogged()==false) return new ForwardResolution(RESOLUTION_NOT_LOGGED);</span>

		try
		{
<span class="fc" id="L163">			HttpServletRequest request = context.getRequest();</span>
			//UPOZORNENIE: ziadnym sposobom nemodifikovat remote objekty!
			// ak je to nutne je potrebne nasledne vratit povodne hodnoty

<span class="fc" id="L167">			GroupDetails localGroup = getLocalRootGroup();</span>
<span class="pc bpc" id="L168" title="2 of 4 branches missed.">			if (localGroup != null &amp;&amp; Tools.isNotEmpty(localGroup.getDomainName()))</span>
			{
<span class="fc" id="L170">				setLocalDomain(localGroup.getDomainName());</span>
			}

			//sync adresarov
<span class="fc" id="L174">			List&lt;Integer&gt; historyGroupsIds = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L175">			Date start = new Date();</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">			for (GroupDetails remoteGroup : getRemoteGroups())</span>
			{
<span class="pc bpc" id="L178" title="2 of 4 branches missed.">				if (request.getParameter(&quot;group_&quot; + remoteGroup.getGroupId()) != null || request.getAttribute(&quot;syncAll&quot;) != null)</span>
				{
<span class="nc" id="L180">					createLocalGroup(remoteGroup);</span>
				}
<span class="fc" id="L182">			}</span>
<span class="fc" id="L183">			historyGroupsIds = getNewGroups(start);</span>

<span class="fc" id="L185">			List&lt;Integer&gt; historyIds = new ArrayList&lt;&gt;();</span>
			//sync stranok
<span class="fc bfc" id="L187" title="All 2 branches covered.">			for (DocDetails remoteDoc : getRemoteDocs())</span>
			{
<span class="pc bpc" id="L189" title="1 of 4 branches missed.">				if (request.getParameter(&quot;doc_&quot; + remoteDoc.getDocId()) != null || request.getAttribute(&quot;syncAll&quot;) != null)</span>
				{
<span class="fc" id="L191">					int historyId = createLocalDoc(remoteDoc);</span>
<span class="fc" id="L192">					historyIds.add(historyId);</span>
				}
<span class="fc" id="L194">			}</span>
<span class="fc" id="L195">			saveRollbackJson(historyIds, historyGroupsIds);</span>

<span class="fc" id="L197">			Content content = getRemoteContent();</span>

			// import suborov
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">			if (content != null)</span>
			{
<span class="fc bfc" id="L202" title="All 2 branches covered.">				for (Numbered&lt;Content.File&gt; file : Numbered.list(content.getFiles()))</span>
				{
<span class="pc bpc" id="L204" title="2 of 4 branches missed.">					if (null != request.getParameter(&quot;file_&quot; + file.number) || request.getAttribute(&quot;syncAll&quot;) != null)</span>
					{
<span class="nc" id="L206">						createLocalContentFile(file.item);</span>
					}
<span class="fc" id="L208">				}</span>
			}

			// import komponentov
<span class="fc" id="L212">			BannerImporter.importBanners(request, content);</span>
<span class="fc" id="L213">			InquiryImporter.importInquiries(request, content);</span>
<span class="fc" id="L214">			GalleryImporter.importGalleries(request, content);</span>
		}
<span class="nc" id="L216">		catch (Exception ex)</span>
		{
<span class="nc" id="L218">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L219">			getRequest().setAttribute(&quot;errorText&quot;, &quot;ERROR: &quot;+ex.getMessage());</span>
<span class="fc" id="L220">		}</span>

<span class="pc bpc" id="L222" title="2 of 4 branches missed.">		if (remoteGroups == null || remoteDocs == null)</span>
		{
<span class="nc" id="L224">			context.getRequest().setAttribute(&quot;errorText&quot;, Prop.getInstance(getRequest()).getText(&quot;components.sync.errorReadingZipFile&quot;, getErrorMessagesHtml()));</span>
		}

<span class="fc" id="L227">		return new ForwardResolution(&quot;/components/maybeError.jsp&quot;);</span>
	}

	private String getErrorMessagesHtml()
	{
<span class="nc" id="L232">		StringBuilder html = new StringBuilder();</span>

<span class="nc bnc" id="L234" title="All 2 branches missed.">		if (errorMessages.size()&gt;0)</span>
		{
<span class="nc" id="L236">			html.append(&quot;&lt;ul&gt;\n&quot;);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">			for (String error : errorMessages)</span>
			{
<span class="nc" id="L239">				html.append(&quot;&lt;li&gt;&quot;).append(error).append(&quot;&lt;/li&gt;\n&quot;);</span>
<span class="nc" id="L240">			}</span>
<span class="nc" id="L241">			html.append(&quot;&lt;/ul&gt;\n&quot;);</span>
		}

<span class="nc" id="L244">		return html.toString();</span>
	}


	/**
	 * Vytvori adresar na lokalnom serveri
	 * @param remoteGroup
	 * @return
	 */
	private boolean createLocalGroup(GroupDetails remoteGroup)
	{
<span class="nc" id="L255">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="nc" id="L256">		String localPath = getLocalPath(remoteGroup);</span>
<span class="nc" id="L257">		GroupDetails localGroup = groupsDB.getGroupByPath(localPath);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">		if (localGroup == null)</span>
		{
			//treba ulozit, ziskaj parenta
<span class="nc" id="L261">			int i = localPath.lastIndexOf('/');</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">			if (i&gt;0)</span>
			{
<span class="nc" id="L264">				String localParentPath = localPath.substring(0, i);</span>
<span class="nc" id="L265">				Logger.debug(SyncDirAction.class, &quot;localPath: &quot;+localPath+&quot; localParentPath: &quot;+localParentPath+&quot; remotePath: &quot;+remoteGroup.getFullPath());</span>
<span class="nc" id="L266">				GroupDetails localParentGroup = groupsDB.getCreateGroup(localParentPath);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">				if (localParentGroup!=null)</span>
				{
					//uprav mapovanie user group skupin
<span class="nc" id="L270">					String localUserGroups = convertUserGroupIdsToLocal(remoteGroup);</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">					if (localUserGroups==null) return false;</span>

<span class="nc" id="L273">					int oGroupId = remoteGroup.getGroupId();</span>
<span class="nc" id="L274">					int oParentGroupId = remoteGroup.getParentGroupId();</span>
<span class="nc" id="L275">					int oTempId = remoteGroup.getTempId();</span>
<span class="nc" id="L276">					String oUserGroups = remoteGroup.getPasswordProtected();</span>
<span class="nc" id="L277">					String oFullPath = remoteGroup.getFullPath();</span>
<span class="nc" id="L278">					String oNavbar = null;</span>
<span class="nc" id="L279">					String oDomain = remoteGroup.getDomainName();</span>
<span class="nc" id="L280">					int oDefaultDocId = remoteGroup.getDefaultDocId();</span>

<span class="nc" id="L282">					remoteGroup.setGroupId(-1);</span>
<span class="nc" id="L283">					remoteGroup.setParentGroupId(localParentGroup.getGroupId());</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">					if (remoteGroup.getNavbarName().indexOf(&quot;href=&quot;)!=-1)</span>
					{
						//uz prenasame navbarName, kvoli spetnej kompatibilite ale mame tento backfix
<span class="nc" id="L287">						oNavbar = remoteGroup.getNavbar();</span>
<span class="nc" id="L288">						remoteGroup.setNavbar(SearchTools.htmlToPlain(oNavbar));</span>
					}
<span class="nc" id="L290">					remoteGroup.setDefaultDocId(-1);</span>

<span class="nc" id="L292">					remoteGroup.setTempId(localRootGroup.getTempId());</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">					if (createMissingTemplates)</span>
					{
						//uprav mapovanie sablon
<span class="nc" id="L296">						int localTempId = getCreateTemplate(oTempId);</span>
<span class="nc" id="L297">						Logger.debug(SyncDirAction.class, &quot;Setting localTempId to:&quot;+localTempId+&quot; for group &quot;+remoteGroup.getGroupIdName());</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">						if (localTempId&gt;0) remoteGroup.setTempId(localTempId);</span>
					}
<span class="nc" id="L300">					remoteGroup.setPasswordProtected(localUserGroups);</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">					if(Tools.isNotEmpty(localDomain))</span>
<span class="nc" id="L302">						remoteGroup.setDomainName(localDomain);</span>

<span class="nc bnc" id="L304" title="All 2 branches missed.">					if(&quot;cloud&quot;.equals(Constants.getInstallName()))</span>
					{
<span class="nc" id="L306">						String lng = getLocalLng();</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">						if (Tools.isNotEmpty(lng))</span>
						{
<span class="nc" id="L309">							Logger.debug(getClass(), &quot;Cloud, translating to: &quot; + lng);</span>
<span class="nc" id="L310">							remoteGroup.setGroupName(CloudToolsForCore.translate(lng, remoteGroup.getGroupName()));</span>
<span class="nc" id="L311">							remoteGroup.setNavbar(SearchTools.htmlToPlain(CloudToolsForCore.translate(lng, remoteGroup.getNavbar())));</span>
<span class="nc" id="L312">							remoteGroup.setUrlDirName(CloudToolsForCore.translate(lng, remoteGroup.getGroupName()));</span>
						}
					}

<span class="nc" id="L316">					groupsDB.setGroup(remoteGroup);</span>

					//vrat do povodneho stavu
<span class="nc" id="L319">					remoteGroup.setGroupId(oGroupId);</span>
<span class="nc" id="L320">					remoteGroup.setParentGroupId(oParentGroupId);</span>
<span class="nc" id="L321">					remoteGroup.setTempId(oTempId);</span>
<span class="nc" id="L322">					remoteGroup.setPasswordProtected(oUserGroups);</span>
<span class="nc" id="L323">					remoteGroup.setFullPath(oFullPath);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">					if (oNavbar != null) remoteGroup.setNavbar(oNavbar);</span>
<span class="nc" id="L325">					remoteGroup.setDomainName(oDomain);</span>
<span class="nc" id="L326">					remoteGroup.setDefaultDocId(oDefaultDocId);</span>

<span class="nc" id="L328">					return true;</span>
				}
			}
<span class="nc" id="L331">		}</span>
		else
		{
			//chceme prepisat data, toto musi zostat zachovane
<span class="nc" id="L335">			int groupId = localGroup.getGroupId();</span>
<span class="nc" id="L336">			int parentGroupId = localGroup.getParentGroupId();</span>
<span class="nc" id="L337">			int defaultDocId = localGroup.getDefaultDocId();</span>
<span class="nc" id="L338">			int tempId = localGroup.getTempId();</span>
<span class="nc" id="L339">			String domainName = localGroup.getDomainName();</span>
<span class="nc" id="L340">			String userGroups = localGroup.getPasswordProtected();</span>
			try
			{
			    //skopiruj data
<span class="nc" id="L344">				BeanUtils.copyProperties(localGroup, remoteGroup);</span>

				//obnov zachovane data
<span class="nc" id="L347">				localGroup.setGroupId(groupId);</span>
<span class="nc" id="L348">				localGroup.setParentGroupId(parentGroupId);</span>
<span class="nc" id="L349">				localGroup.setDefaultDocId(defaultDocId);</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">                if (createMissingTemplates) localGroup.setTempId(getCreateTemplate(remoteGroup.getTempId()));</span>
<span class="nc" id="L351">                else localGroup.setTempId(tempId);</span>
<span class="nc" id="L352">                localGroup.setDomainName(domainName);</span>

<span class="nc" id="L354">                String localUserGroups = convertUserGroupIdsToLocal(remoteGroup);</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">                if (localUserGroups!=null) localGroup.setPasswordProtected(localUserGroups);</span>
<span class="nc" id="L356">				else localGroup.setPasswordProtected(userGroups);</span>

<span class="nc" id="L358">				groupsDB.setGroup(localGroup);</span>
			}
<span class="nc" id="L360">			catch (Exception ex)</span>
			{
<span class="nc" id="L362">			    sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L363">			}</span>
		}
<span class="nc" id="L365">		return false;</span>
	}

    /**
     * Skonvertuje ID pouzivatelskych skupin z remote grupy na lokalne IDecka, vrati NULL ak nastane chyba
     * @param remoteGroup
     * @return
     */
	private String convertUserGroupIdsToLocal(GroupDetails remoteGroup)
    {
<span class="nc" id="L375">        StringBuilder localUserGroups = null;</span>
<span class="nc bnc" id="L376" title="All 4 branches missed.">        if (Tools.isNotEmpty(remoteGroup.getPasswordProtected()) &amp;&amp; createMissingUserGroups)</span>
        {
<span class="nc" id="L378">            StringTokenizer st = new StringTokenizer(remoteGroup.getPasswordProtected(), &quot;,&quot;);</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">            while (st.hasMoreTokens())</span>
            {
<span class="nc" id="L381">                int remoteUserGroupId = Tools.getIntValue(st.nextToken(), -1);</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">                if (remoteUserGroupId&gt;0)</span>
                {
<span class="nc" id="L384">                    String remoteUserGroupName = getRemoteUserGroupName(remoteUserGroupId);</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">                    if (Tools.isEmpty(remoteUserGroupName))</span>
                    {
<span class="nc" id="L387">                        context.getRequest().setAttribute(&quot;errorText&quot;, &quot;Neexistuje remote user group &quot;+remoteUserGroupId);</span>
<span class="nc" id="L388">                        Logger.debug(SyncDirAction.class, &quot;Neexistuje remote user group &quot;+remoteUserGroupId);</span>
<span class="nc" id="L389">                        return null;</span>
                    }
<span class="nc" id="L391">                    int localUserGroupId = getCreateUserGroup(remoteUserGroupId);</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">                    if (localUserGroupId&lt;1)</span>
                    {
<span class="nc" id="L394">                        context.getRequest().setAttribute(&quot;errorText&quot;, &quot;Neexistuje pouzivatelska skupina &quot;+remoteUserGroupName);</span>
<span class="nc" id="L395">                        Logger.debug(SyncDirAction.class, &quot;Neexistuje pouzivatelska skupina &quot;+remoteUserGroupName);</span>
<span class="nc" id="L396">                        return null;</span>
                    }
<span class="nc bnc" id="L398" title="All 2 branches missed.">                    if (localUserGroups==null) localUserGroups = new StringBuilder(Integer.toString(localUserGroupId));</span>
<span class="nc" id="L399">                    else localUserGroups.append(&quot;,&quot;).append(localUserGroupId);</span>
                }
<span class="nc" id="L401">            }</span>
        }
<span class="nc bnc" id="L403" title="All 2 branches missed.">		if (localUserGroups==null) return &quot;&quot;;</span>

<span class="nc" id="L405">		return localUserGroups.toString();</span>
	 }

	 /**
	  * Convert string of remote group ids like 40,47,57 to local group ids, filter not/yet existing
	  * @param groupIds
	  * @return
	  */
	 private String convertGroupIdsToLocalFilter(String groupIds) {
		//ak export neobsahuje skupiny, tak vrat povodne
<span class="nc bnc" id="L415" title="All 2 branches missed.">		if (Tools.isEmpty(groupIds)) return groupIds;</span>

<span class="nc" id="L417">		StringBuilder localGroups = new StringBuilder();</span>
		try {
<span class="nc" id="L419">			int[] ids = Tools.getTokensInt(groupIds, &quot;,&quot;);</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">			for (int remoteGroupId : ids) {</span>
<span class="nc" id="L421">				GroupDetails localGroup = getLocalGroup(remoteGroupId);</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">				if (localGroup != null) {</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">					if (localGroups.length()&gt;0) localGroups.append(&quot;,&quot;);</span>
<span class="nc" id="L424">					localGroups.append(String.valueOf(localGroup.getGroupId()));</span>
				}
			}
<span class="nc" id="L427">		} catch (Exception ex) {</span>
<span class="nc" id="L428">			sk.iway.iwcm.Logger.error(ex);</span>
			//ak to padlo, nastav povodne
<span class="nc bnc" id="L430" title="All 2 branches missed.">			if (Tools.isEmpty(localGroups)) localGroups.append(groupIds);</span>
<span class="nc" id="L431">		}</span>
<span class="nc" id="L432">		return localGroups.toString();</span>
	 }

	 /**
     * Skonvertuje ID perex skupin z remote doc na lokalne IDecka, vrati NULL ak nastane chyba
     * @param remoteGroup
     * @return
     */
		private String convertPerexGroupIdsToLocal(String perexGroupIds) {
<span class="fc" id="L441">			StringBuilder localPerexGroups = new StringBuilder();</span>
			try {
<span class="fc" id="L443">				List&lt;PerexGroupBean&gt; perexGroups = getRemotePerexGroups();</span>
				//ak export neobsahuje perex grupy, tak vrat povodne
<span class="pc bpc" id="L445" title="2 of 4 branches missed.">				if (perexGroups == null || perexGroups.size()&lt;1) return perexGroupIds;</span>

<span class="pc bpc" id="L447" title="3 of 4 branches missed.">				if (Tools.isNotEmpty(perexGroupIds) &amp;&amp; createMissingUserGroups) {</span>
<span class="nc" id="L448">					StringTokenizer st = new StringTokenizer(perexGroupIds, &quot;,&quot;);</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">					while (st.hasMoreTokens()) {</span>

<span class="nc" id="L451">						int remotePerexGroupId = Tools.getIntValue(st.nextToken(), -1);</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">						if (remotePerexGroupId &gt; 0) {</span>
<span class="nc" id="L453">							String remotePerexGroupName = getRemotePerexGroupName(remotePerexGroupId);</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">							if (Tools.isEmpty(remotePerexGroupName)) {</span>
<span class="nc" id="L455">								context.getRequest().setAttribute(&quot;errorText&quot;, &quot;Neexistuje remote perex group &quot; + remotePerexGroupId);</span>
<span class="nc" id="L456">								Logger.debug(SyncDirAction.class, &quot;Neexistuje remote perex group &quot; + remotePerexGroupId);</span>
<span class="nc" id="L457">								continue;</span>
							}

<span class="nc" id="L460">							int localPerexGroupId = getCreatePerexGroup(remotePerexGroupId);</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">							if (localPerexGroupId &lt; 1) {</span>
<span class="nc" id="L462">								context.getRequest().setAttribute(&quot;errorText&quot;, &quot;Neexistuje perex skupina &quot; + remotePerexGroupName);</span>
<span class="nc" id="L463">								Logger.debug(SyncDirAction.class, &quot;Neexistuje perex skupina &quot; + remotePerexGroupName);</span>
								//ak sa nepodarilo vytvorit, ponechaj povodne IDecko
<span class="nc" id="L465">								localPerexGroupId = remotePerexGroupId;</span>
							}

<span class="nc bnc" id="L468" title="All 2 branches missed.">							if (localPerexGroups.length()&gt;0) localPerexGroups.append(&quot;,&quot;);</span>
<span class="nc" id="L469">							localPerexGroups.append(Integer.toString(localPerexGroupId));</span>
						}
<span class="nc" id="L471">					}</span>
				}
<span class="nc" id="L473">			} catch (Exception ex) {</span>
<span class="nc" id="L474">				sk.iway.iwcm.Logger.error(ex);</span>
				//ak to padlo, nastav povodne
<span class="nc bnc" id="L476" title="All 2 branches missed.">				if (Tools.isEmpty(localPerexGroups)) localPerexGroups.append(perexGroupIds);</span>
<span class="fc" id="L477">			}</span>
<span class="fc" id="L478">			return localPerexGroups.toString();</span>
		}

	/**
	 * Vytvori stranku na lokalnom serveri
	 * @param remoteDoc
	 * @return
	 */
	private int createLocalDoc(DocDetails remoteDoc)
	{
<span class="fc" id="L488">		Logger.debug(SyncDirAction.class, &quot;createLocalDoc, remoteDoc=&quot;+remoteDoc.getDocId()+&quot; title=&quot;+remoteDoc.getTitle());</span>

<span class="fc" id="L490">		GroupDetails localGroup = getLocalGroup(remoteDoc.getGroupId());</span>
<span class="pc bpc" id="L491" title="1 of 2 branches missed.">		if (localGroup==null)</span>
		{
			//asi nezaskrtol, ze sa ma syncnut aj adresar
<span class="nc" id="L494">			createLocalGroup(getRemoteGroup(remoteDoc.getGroupId()));</span>
<span class="nc" id="L495">			localGroup = getLocalGroup(remoteDoc.getGroupId());</span>
		}
<span class="pc bpc" id="L497" title="1 of 2 branches missed.">		if (localGroup!=null)</span>
		{
			//najdi lokalnu verziu
<span class="fc" id="L500">			DocDetails localDoc = getLocalDoc(remoteDoc);</span>

			//uprav mapovanie sablon!!!
<span class="fc" id="L503">			int localTempId = getCreateTemplate(remoteDoc.getTempId());</span>
<span class="pc bpc" id="L504" title="1 of 2 branches missed.">			if (localTempId&lt;1) return -1;</span>

			//uprav mapovanie user group skupin
<span class="fc" id="L507">			StringBuilder localUserGroups = null;</span>
<span class="pc bpc" id="L508" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(remoteDoc.getPasswordProtected()))</span>
			{
<span class="nc" id="L510">				StringTokenizer st = new StringTokenizer(remoteDoc.getPasswordProtected(), &quot;,&quot;);</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">				while (st.hasMoreTokens())</span>
				{
<span class="nc" id="L513">					int remoteUserGroupId = Tools.getIntValue(st.nextToken(), -1);</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">					if (remoteUserGroupId&gt;0)</span>
					{
<span class="nc" id="L516">						int localUserGroupId = getCreateUserGroup(remoteUserGroupId);</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">						if (localUserGroupId&lt;1)</span>
						{
<span class="nc" id="L519">							return -1;</span>
						}
<span class="nc bnc" id="L521" title="All 2 branches missed.">						if (localUserGroups==null) localUserGroups = new StringBuilder(Integer.toString(localUserGroupId));</span>
<span class="nc" id="L522">						else localUserGroups.append(&quot;,&quot;).append(localUserGroupId);</span>
					}
<span class="nc" id="L524">				}</span>
			}

<span class="fc" id="L527">			EditorForm ef = new EditorForm(remoteDoc);</span>

<span class="fc" id="L529">			Logger.debug(SyncDirAction.class, &quot;createLocalDoc: IN=&quot;+Constants.getInstallName()+&quot; is Cloud=&quot;+(&quot;cloud&quot;.equals(Constants.getInstallName())));</span>
<span class="pc bpc" id="L530" title="1 of 2 branches missed.">			if(&quot;cloud&quot;.equals(Constants.getInstallName()))</span>
			{
<span class="nc" id="L532">				String lng = getLocalLng();</span>
<span class="nc" id="L533">				Logger.debug(SyncDirAction.class, &quot;createLocalDoc: lng=&quot;+lng);</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">				if (Tools.isNotEmpty(lng))</span>
				{
<span class="nc" id="L536">					Logger.debug(getClass(), &quot;Cloud, translating remote docid &quot;+ remoteDoc.getDocId() +&quot; title: &quot;+ remoteDoc.getTitle() +&quot; to: &quot; + lng);</span>
<span class="nc" id="L537">					ef = CloudToolsForCore.translate(lng, ef, localGroup);</span>
				}
			}

<span class="pc bpc" id="L541" title="1 of 2 branches missed.">			if (localDoc != null) ef.setDocId(localDoc.getDocId());</span>
<span class="fc" id="L542">			else ef.setDocId(-1);</span>

<span class="fc" id="L544">			ef.setData(fixGroupIdsInContent(ef.getData()));</span>

<span class="fc" id="L546">			ef.setGroupId(localGroup.getGroupId());</span>
<span class="fc" id="L547">			ef.setPublish(&quot;1&quot;);</span>
<span class="fc" id="L548">			ef.setTempId(localTempId);</span>
<span class="fc" id="L549">			ef.setPasswordProtectedString(Tools.toString(localUserGroups));</span>
<span class="fc" id="L550">			ef.setPerexGroupString(convertPerexGroupIdsToLocal(remoteDoc.getPerexGroupIdsString()));</span>

<span class="fc" id="L552">			Identity user = UsersDB.getCurrentUser(getContext());</span>
<span class="fc" id="L553">			ef.setAuthorId(user.getUserId());</span>

			//nastavime poznamku pre redaktora
<span class="fc" id="L556">			DocNoteBean note = getRemoteDocsNotes().get(remoteDoc.getDocId());</span>
<span class="pc bpc" id="L557" title="1 of 2 branches missed.">			if(note!=null)</span>
			{
<span class="nc" id="L559">				ef.setNote(note.getNote());</span>
			}

<span class="fc" id="L562">			int docid = EditorDB.saveEditorForm(ef, context.getRequest());</span>

<span class="fc" id="L564">			EditorDB.cleanSessionData(context.getRequest());</span>

			//skontroluj, ci remoteDoc nie je nejake default doc a nastav na local group
<span class="fc" id="L567">			fixDefaultDocId(remoteDoc, ef.getDocId());</span>

			//syncni media
<span class="fc" id="L570">			List&lt;Media&gt; media = getRemoteMedia();</span>
<span class="pc bpc" id="L571" title="1 of 2 branches missed.">			if (media != null)</span>
			{
				//toto su media co uz mam
<span class="fc" id="L574">				List&lt;Media&gt; mediaLocal = MediaDB.getMedia(getSession(), &quot;documents&quot;, ef.getDocId(), null, 0, false);</span>
				//toto je set medii ktore som prepisal z remote, ostatne budem musiet premazat
<span class="fc" id="L576">				Set&lt;String&gt; mediaLinks = new HashSet&lt;&gt;();</span>

<span class="fc" id="L578">				MediaDB mediaDB = new MediaDB();</span>
<span class="fc bfc" id="L579" title="All 2 branches covered.">				for (Media m : media)</span>
				{
<span class="pc bpc" id="L581" title="2 of 4 branches missed.">					if (m.getMediaFkId()!=null &amp;&amp; m.getMediaFkId().intValue()==remoteDoc.getDocId())</span>
					{
<span class="nc" id="L583">						Media mLocal = getMediaByLink(mediaLocal, m.getMediaLink());</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">						if (mLocal == null) mLocal = new Media();</span>

<span class="nc" id="L586">						mLocal.setMediaFkId(Integer.valueOf(ef.getDocId()));</span>
<span class="nc" id="L587">						mLocal.setMediaFkTableName(m.getMediaFkTableName());</span>
<span class="nc" id="L588">						mLocal.setMediaTitleSk(m.getMediaTitleSk());</span>
<span class="nc" id="L589">						mLocal.setMediaTitleCz(m.getMediaTitleCz());</span>
<span class="nc" id="L590">						mLocal.setMediaTitleEn(m.getMediaTitleEn());</span>
<span class="nc" id="L591">						mLocal.setMediaTitleDe(m.getMediaTitleDe());</span>
<span class="nc" id="L592">						mLocal.setMediaLink(m.getMediaLink());</span>
<span class="nc" id="L593">						mLocal.setMediaThumbLink(m.getMediaThumbLink());</span>
<span class="nc" id="L594">						mLocal.setMediaGroup(m.getMediaGroup());</span>
<span class="nc" id="L595">						mLocal.setMediaInfoSk(m.getMediaInfoSk());</span>
<span class="nc" id="L596">						mLocal.setMediaInfoCz(m.getMediaInfoCz());</span>
<span class="nc" id="L597">						mLocal.setMediaInfoEn(m.getMediaInfoEn());</span>
<span class="nc" id="L598">						mLocal.setMediaInfoDe(m.getMediaInfoDe());</span>
<span class="nc" id="L599">						mLocal.setMediaSortOrder(m.getMediaSortOrder());</span>
<span class="nc" id="L600">						mLocal.setLastUpdate(m.getLastUpdate());</span>

<span class="nc" id="L602">						Logger.debug(SyncDirAction.class, &quot;Saving media: &quot;+mLocal.getMediaId()+&quot; title=&quot;+mLocal.getMediaTitleSk()+&quot; link=&quot;+mLocal.getMediaLink());</span>
<span class="nc" id="L603">						mediaDB.save(mLocal);</span>

<span class="nc" id="L605">						mediaLinks.add(m.getMediaLink());</span>
					}
<span class="fc" id="L607">				}</span>

				//pomaz media, ktore neboli aktualizovane
<span class="pc bpc" id="L610" title="1 of 2 branches missed.">				for (Media mLocal : mediaLocal)</span>
				{
<span class="nc bnc" id="L612" title="All 2 branches missed.">					if (mediaLinks.contains(mLocal.getMediaLink())) continue;</span>

<span class="nc" id="L614">					Logger.debug(SyncDirAction.class, &quot;Deleting media: &quot;+mLocal.getMediaId()+&quot; title=&quot;+mLocal.getMediaTitleSk()+&quot; link=&quot;+mLocal.getMediaLink());</span>
<span class="nc" id="L615">					mediaDB.delete(mLocal);</span>
<span class="nc" id="L616">				}</span>
			}


<span class="fc" id="L620">			return docid;</span>
		}
<span class="nc" id="L622">		return -1;</span>
	}

	private Media getMediaByLink(List&lt;Media&gt; media, String mediaLink)
	{
<span class="nc bnc" id="L627" title="All 2 branches missed.">		for (Media m : media)</span>
		{
<span class="nc bnc" id="L629" title="All 2 branches missed.">			if (m.getMediaLink().equals(mediaLink)) return m;</span>
<span class="nc" id="L630">		}</span>
<span class="nc" id="L631">		return null;</span>
	}

	private void fixDefaultDocId(DocDetails remoteDoc, int localDocId)
	{
<span class="fc bfc" id="L636" title="All 2 branches covered.">		for (GroupDetails remoteGroup : getRemoteGroups())</span>
		{
<span class="pc bpc" id="L638" title="2 of 4 branches missed.">			if (remoteGroup != null &amp;&amp; remoteGroup.getDefaultDocId()==remoteDoc.getDocId())</span>
			{
<span class="nc" id="L640">				GroupDetails localGroup = getLocalGroup(remoteGroup);</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">				if (localGroup != null)</span>
				{
<span class="nc" id="L643">					localGroup.setDefaultDocId(localDocId);</span>
<span class="nc" id="L644">					GroupsDB.getInstance().setGroup(localGroup);</span>
				}
			}
<span class="fc" id="L647">		}</span>
<span class="fc" id="L648">	}</span>

	private boolean createLocalContentFile(Content.File remoteFile)
	{
<span class="nc" id="L652">		String tempPath = Tools.getRealPath(syncDir + &quot;/content/&quot; + remoteFile.getZipPath());</span>
<span class="nc" id="L653">		String localPath = Tools.getRealPath(remoteFile.getVirtualPath());</span>
<span class="nc" id="L654">		IwcmFile tempFile = new IwcmFile(tempPath);</span>
<span class="nc" id="L655">		IwcmFile localFile = new IwcmFile(localPath);</span>
		try
		{
<span class="nc" id="L658">			FileTools.copyFile(tempFile, localFile);</span>
<span class="nc" id="L659">			localFile.setLastModified(remoteFile.getTime());</span>
<span class="nc" id="L660">			return true;</span>
		}
<span class="nc" id="L662">		catch (Exception ex)</span>
		{
<span class="nc" id="L664">			return false;</span>
		}
	}

	/**
	 * Ziska ID lokalnej sablony pre ID vzdialenej sablony
	 * ak sablona neexistuje a je zvolene, ze sa ma vytvorit, tak sa vytvori
	 * @param remoteTempId
	 * @return
	 */
	public int getCreateTemplate(int remoteTempId)
	{
<span class="pc bpc" id="L676" title="1 of 2 branches missed.">		if (createMissingTemplates==false) return localRootGroup.getTempId();</span>

<span class="fc" id="L678">		TemplateDetails remoteTemp = getRemoteTemp(remoteTempId);</span>
<span class="pc bpc" id="L679" title="1 of 2 branches missed.">		if (remoteTemp==null)</span>
		{
<span class="nc" id="L681">			context.getRequest().setAttribute(&quot;errorText&quot;, &quot;Neexistuje remote sablona pre tempId=&quot;+remoteTempId);</span>
<span class="nc" id="L682">			Logger.debug(SyncDirAction.class, &quot;Neexistuje remote sablona pre tempId=&quot;+remoteTempId);</span>
<span class="nc" id="L683">			return -1;</span>
		}
<span class="fc" id="L685">		int localTempId = getLocalTempId(remoteTemp.getTempName());</span>
<span class="pc bpc" id="L686" title="3 of 4 branches missed.">		if (localTempId &lt; 1 &amp;&amp; createMissingTemplates)</span>
		{
<span class="nc" id="L688">			int oTempId = remoteTemp.getTempId();</span>
<span class="nc" id="L689">			String oTempName = remoteTemp.getTempName();</span>
<span class="nc" id="L690">			String oTempLng = remoteTemp.getLng();</span>
<span class="nc" id="L691">			int oTempHeaderDocId = remoteTemp.getHeaderDocId();</span>
<span class="nc" id="L692">			int oTempFooterDocId = remoteTemp.getFooterDocId();</span>
<span class="nc" id="L693">			int oTempMenuDocId = remoteTemp.getMenuDocId();</span>
<span class="nc" id="L694">			String oAvailableGroups = remoteTemp.getAvailableGroups();</span>

<span class="nc bnc" id="L696" title="All 2 branches missed.">			if(remoteDocs == null) getRemoteDocs();</span>

			//DocDetails header = selectFirst(remoteDocs,having(on(DocDetails.class).getDocId(),equalTo(remoteTemp.getHeaderDocId())));
<span class="nc bnc" id="L699" title="All 2 branches missed.">			DocDetails header = remoteDocs.stream().filter(d -&gt; d.getDocId() == remoteTemp.getHeaderDocId()).findFirst().orElse(null);</span>
			//DocDetails footer = selectFirst(remoteDocs,having(on(DocDetails.class).getDocId(),equalTo(remoteTemp.getFooterDocId())));
<span class="nc bnc" id="L701" title="All 2 branches missed.">			DocDetails footer = remoteDocs.stream().filter(d -&gt; d.getDocId() == remoteTemp.getFooterDocId()).findFirst().orElse(null);</span>
			//DocDetails menu = selectFirst(remoteDocs,having(on(DocDetails.class).getDocId(),equalTo(remoteTemp.getMenuDocId())));
<span class="nc bnc" id="L703" title="All 2 branches missed.">			DocDetails menu = remoteDocs.stream().filter(d -&gt; d.getDocId() == remoteTemp.getMenuDocId()).findFirst().orElse(null);</span>

			//save them to global /System
<span class="nc" id="L706">			int globalHeaderFooterGroupId = Constants.getInt(&quot;headerFooterGroupId&quot;);</span>
<span class="nc" id="L707">			int globalMenuGroupId = Constants.getInt(&quot;menuGroupId&quot;);</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">			if(header!=null) remoteTemp.setHeaderDocId(createLocalDoc(header, globalHeaderFooterGroupId));</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">			if(footer!=null) remoteTemp.setFooterDocId(createLocalDoc(footer, globalHeaderFooterGroupId));</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">			if(menu != null) remoteTemp.setMenuDocId(createLocalDoc(menu, globalMenuGroupId));</span>

<span class="nc bnc" id="L712" title="All 2 branches missed.">			if (&quot;cloud&quot;.equals(Constants.getInstallName()))</span>
			{
<span class="nc" id="L714">				String lng = getLocalLng();</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">				if (Tools.isNotEmpty(lng))</span>
				{
<span class="nc" id="L717">					remoteTemp.setTempName(oTempName + &quot;-&quot;+lng);</span>
<span class="nc" id="L718">					remoteTemp.setLng(lng);</span>
				}
			}

<span class="nc" id="L722">			remoteTemp.setTempId(-1);</span>

			//replace available groups for local groups
<span class="nc" id="L725">			remoteTemp.setAvailableGroups(convertGroupIdsToLocalFilter(remoteTemp.getAvailableGroups()));</span>

<span class="nc" id="L727">			TemplatesDB.getInstance().saveTemplate(remoteTemp);</span>
<span class="nc" id="L728">			localTempId = remoteTemp.getTempId();</span>

<span class="nc" id="L730">			remoteTemp.setTempId(oTempId);</span>
<span class="nc" id="L731">			remoteTemp.setTempName(oTempName);</span>
<span class="nc" id="L732">			remoteTemp.setLng(oTempLng);</span>
<span class="nc" id="L733">			remoteTemp.setHeaderDocId(oTempHeaderDocId);</span>
<span class="nc" id="L734">			remoteTemp.setFooterDocId(oTempFooterDocId);</span>
<span class="nc" id="L735">			remoteTemp.setMenuDocId(oTempMenuDocId);</span>
<span class="nc" id="L736">			remoteTemp.setAvailableGroups(oAvailableGroups);</span>
		}
<span class="pc bpc" id="L738" title="1 of 2 branches missed.">		if (localTempId &lt; 1)</span>
		{
<span class="nc" id="L740">			context.getRequest().setAttribute(&quot;errorText&quot;, &quot;Neexistuje lokálna šablóna &quot;+remoteTemp.getTempName());</span>
<span class="nc" id="L741">			Logger.debug(SyncDirAction.class, &quot;Neexistuje local sablona &quot;+remoteTemp.getTempName());</span>
<span class="nc" id="L742">			return -1;</span>
		}
<span class="fc" id="L744">		return localTempId;</span>
	}

	/**
	 * Vytvori local doc s tym ze neberie ohlad na to v akom adresari bol povodne
	 * ale vytvori ho v adresari s groupid z parametra (vytvori ho len ak tam taky doc este nie je, zistuje sa podla title)
	 * @param doc
	 * @param forceLocalGroupId
	 * @author mhalas
	 * @return
	 */
	private int createLocalDoc(DocDetails doc, int forceLocalGroupId)
	{
<span class="nc" id="L757">		int docid = new SimpleQuery().forInt(&quot;Select doc_id from documents where group_id = ? and title = ?&quot;, forceLocalGroupId,doc.getTitle());</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">		if(docid &lt;= 0)</span>
		{
<span class="nc" id="L760">			int oGroupId = doc.getGroupId();</span>
<span class="nc" id="L761">			doc.setGroupId(forceLocalGroupId);</span>
<span class="nc" id="L762">			docid = createLocalDoc(doc);</span>
<span class="nc" id="L763">			doc.setGroupId(oGroupId);</span>
		}
<span class="nc" id="L765">		return docid;</span>
	}

	private Content getRemoteContent()
	{
<span class="fc bfc" id="L770" title="All 2 branches covered.">		if (null == remoteContent)</span>
		{
<span class="fc" id="L772">			remoteContent = (Content) getLocalFile(&quot;content.xml&quot;);</span>
		}
<span class="fc" id="L774">		return remoteContent;</span>
	}

	/**
	 * Vrati zoznam importovanych suborov, vo formate vhodnom na vypisanie.
	 * Vacsina funkcie sa tyka nastavenia spravneho statusu (neexistuje, je starsi, je novsi, je iny, je rovnaky).
	 *
	 * @return
	 */
	public List&lt;ContentFileBean&gt; getRemoteContentFiles()
	{
<span class="fc" id="L785">		List&lt;ContentFileBean&gt; fileBeans = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L786">		Content content = getRemoteContent();</span>
<span class="pc bpc" id="L787" title="1 of 2 branches missed.">		if (null == content) return fileBeans;</span>

<span class="fc bfc" id="L789" title="All 2 branches covered.">		for (Numbered&lt;Content.File&gt; numFile : Numbered.list(content.getFiles()))</span>
		{
<span class="fc" id="L791">			Content.File file = numFile.item;</span>
<span class="fc" id="L792">			String path = file.getVirtualPath();</span>
<span class="fc" id="L793">			int status = ContentFileBean.STATUS_MISSING;</span>
<span class="fc" id="L794">			String localPath = Tools.getRealPath(path);</span>
<span class="fc" id="L795">			IwcmFile localFile = new IwcmFile(localPath);</span>
<span class="pc bpc" id="L796" title="1 of 2 branches missed.">			if (localFile.exists())</span>
			{
<span class="fc" id="L798">				long remoteTime = file.getTime();</span>
<span class="fc" id="L799">				long localTime = localFile.lastModified();</span>
<span class="pc bpc" id="L800" title="1 of 2 branches missed.">				if (remoteTime &gt; localTime)</span>
				{
<span class="nc" id="L802">					status = ContentFileBean.STATUS_NEWER;</span>
				}
<span class="pc bpc" id="L804" title="1 of 2 branches missed.">				else if (remoteTime &lt; localTime)</span>
				{
<span class="nc" id="L806">					status = ContentFileBean.STATUS_OLDER;</span>
				}
				else
				{
<span class="pc bpc" id="L810" title="1 of 2 branches missed.">					status = (localFile.length() == file.getSize()) ? ContentFileBean.STATUS_CURRENT_SAME : ContentFileBean.STATUS_CURRENT_DIFFERENT;</span>
				}
			}
<span class="fc" id="L813">			ContentFileBean fileBean = new ContentFileBean(numFile.number, path, status);</span>
<span class="fc" id="L814">			fileBeans.add(fileBean);</span>
<span class="fc" id="L815">		}</span>
<span class="fc" id="L816">		return fileBeans;</span>
	}

	/**
	 * Vrati zoznam importovanych bannerov, vo formate vhodnom na vypisanie.
	 *
	 * @return
	 */
	public List&lt;ContentBannerBean&gt; getRemoteContentBanners()
	{
<span class="fc" id="L826">		return BannerImporter.getBanners(getRemoteContent());</span>
	}

	/**
	 * Vrati zoznam importovanych ankiet, vo formate vhodnom na vypisanie.
	 *
	 * @return
	 */
	public List&lt;ContentInquiryBean&gt; getRemoteContentInquiries()
	{
<span class="fc" id="L836">		return InquiryImporter.getInquiries(getRemoteContent(), context.getRequest());</span>
	}

	/**
	 * Vrati zoznam importovanych adresarov galerii, vo formate vhodnom na vypisanie.
	 *
	 * @return
	 */
	public List&lt;ContentGalleryBean.Info&gt; getRemoteContentGalleryInfos()
	{
<span class="fc" id="L846">		return GalleryImporter.getGalleryInfos(getRemoteContent());</span>
	}

	/**
	 * Vrati zoznam importovanych obrazkov galerie, vo formate vhodnom na vypisanie.
	 *
	 * @return
	 */
	public List&lt;ContentGalleryBean.Image&gt; getRemoteContentGalleryImages()
	{
<span class="nc" id="L856">		return GalleryImporter.getGalleryImages(getRemoteContent(), context.getRequest());</span>
	}

	/**
	 * Vrati zoznam remote adresarov
	 * @return
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public List&lt;GroupDetails&gt; getRemoteGroups()
	{
<span class="fc" id="L866">		Logger.debug(SyncDirAction.class, &quot;getRemoteGroups, remoteGroups=&quot;+remoteGroups+&quot; syncDir=&quot;+syncDir);</span>
<span class="pc bpc" id="L867" title="1 of 4 branches missed.">		if (remoteGroups==null &amp;&amp; remoteGroupId&gt;0)</span>
		{
<span class="fc" id="L869">			remoteGroups = (List&lt;GroupDetails&gt;) getLocalFile(&quot;groups.xml&quot;);</span>
		}

<span class="fc" id="L872">		return remoteGroups;</span>
	}

	/**
	 * Vrati remote adresar na zaklade jeho ID
	 * @param remoteGroupId
	 * @return
	 */
	public GroupDetails getRemoteGroup(int remoteGroupId)
	{
<span class="pc bpc" id="L882" title="1 of 2 branches missed.">		for (GroupDetails remoteGroup : getRemoteGroups())</span>
		{
<span class="pc bpc" id="L884" title="1 of 2 branches missed.">			if (remoteGroup.getGroupId()==remoteGroupId)</span>
			{
<span class="fc" id="L886">				return remoteGroup;</span>
			}
<span class="nc" id="L888">		}</span>
<span class="nc" id="L889">		return null;</span>
	}

	/**
	 * Vrati remote web stranky
	 * @return
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public List&lt;DocDetails&gt; getRemoteDocs()
	{
<span class="pc bpc" id="L899" title="1 of 4 branches missed.">		if (remoteDocs==null &amp;&amp; remoteGroupId&gt;0)</span>
		{
<span class="fc" id="L901">			remoteDocs = (List&lt;DocDetails&gt;) getLocalFile(&quot;docs.xml&quot;);</span>
		}
		/**
		 * musime to zosortovat tak aby prve boli hlavne stranky priecinkov
		 * inak mozu nastat problemy pri generovani virtualPath pri cloud prekladoch
		 * ticket 15053
		 */
<span class="fc" id="L908">		sortByMainPages();</span>
<span class="fc" id="L909">		return remoteDocs;</span>

	}

	/**
	 * Zosortuje zoznam doc-s podla toho ci su hlavne stranky priecinkov
	 * ak je stranka hlavna nejakemu priecinku tak bude niekde na zaciatku zoznamu
	 *
	 * @author mhalas
	 */
	private void sortByMainPages()
	{
<span class="pc bpc" id="L921" title="2 of 4 branches missed.">		if (remoteDocs == null || remoteGroups == null) return;</span>

<span class="fc" id="L923">		Set&lt;Integer&gt; mainPages = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L924" title="All 2 branches covered.">		for(GroupDetails gd : remoteGroups)</span>
		{
<span class="fc" id="L926">			mainPages.add(gd.getDefaultDocId());</span>
<span class="fc" id="L927">		}</span>
<span class="fc" id="L928">		Logger.debug(getClass(), &quot;main pages docids : &quot; + Arrays.toString(mainPages.toArray()));</span>
<span class="fc" id="L929">		final Set&lt;Integer&gt; finalMainPages = mainPages;</span>

		//Logger.debug(getClass(), &quot;docids before sort: &quot; + Arrays.toString(Lambda.convert(remoteDocs, new PropertyExtractor(&quot;docId&quot;)).toArray()));

<span class="fc" id="L933">		Collections.sort(remoteDocs, new Comparator&lt;DocDetails&gt;(){</span>
			@Override
			public int compare(DocDetails o1, DocDetails o2)
			{
<span class="pc bpc" id="L937" title="1 of 4 branches missed.">				if(finalMainPages.contains(o1.getDocId()) &amp;&amp; finalMainPages.contains(o2.getDocId())) return 0;</span>
<span class="pc bpc" id="L938" title="1 of 4 branches missed.">				if(finalMainPages.contains(o1.getDocId()) &amp;&amp; !finalMainPages.contains(o2.getDocId())) return -1;</span>
<span class="pc bpc" id="L939" title="2 of 4 branches missed.">				if(!finalMainPages.contains(o1.getDocId()) &amp;&amp; finalMainPages.contains(o2.getDocId())) return 1;</span>
<span class="nc" id="L940">				return o1.getSortPriority() - o2.getSortPriority();</span>
			}
		});

		//Logger.debug(getClass(), &quot;docids after sort: &quot; + Arrays.toString(Lambda.convert(remoteDocs, new PropertyExtractor(&quot;docId&quot;)).toArray()));
<span class="fc" id="L945">	}</span>

	@SuppressWarnings(&quot;unchecked&quot;)
	public List&lt;Media&gt; getRemoteMedia()
	{
<span class="pc bpc" id="L950" title="1 of 2 branches missed.">		if (remoteMedia==null)</span>
		{
<span class="fc" id="L952">			remoteMedia = (List&lt;Media&gt;) getLocalFile(&quot;media.xml&quot;);</span>
		}
<span class="fc" id="L954">		return remoteMedia;</span>
	}

	/**
	 * Ziska root path z remote adresara (spolocna pre vsetky remote podadresare)
	 * @return
	 */
	public String getRemoteRootPath()
	{
<span class="fc bfc" id="L963" title="All 2 branches covered.">		if (remoteRootPath == null)</span>
		{
<span class="pc bpc" id="L965" title="1 of 2 branches missed.">			if (getRemoteGroups().size()&gt;0)</span>
			{
<span class="fc" id="L967">				remoteRootPath = getRemoteGroups().get(0).getFullPath();</span>
				//int i = remoteRootPath.lastIndexOf('/');
				//if (i&gt;0) remoteRootPath = remoteRootPath.substring(0, i);
			}
		}
<span class="fc" id="L972">		return remoteRootPath;</span>
	}

	/**
	 * Ziska local cestu k adresaru
	 * @param remoteGroup
	 * @return
	 */
	public String getLocalPath(GroupDetails remoteGroup)
	{
<span class="fc" id="L982">		Logger.debug(SyncDirAction.class, &quot;getLocalPath, rgfp=&quot;+remoteGroup.getFullPath()+&quot; root=&quot;+getRemoteRootPath());</span>

<span class="fc" id="L984">		String basePath = remoteGroup.getFullPath().substring(getRemoteRootPath().length());</span>
<span class="pc bpc" id="L985" title="1 of 2 branches missed.">		if(&quot;cloud&quot;.equals(Constants.getInstallName()))</span>
		{
<span class="nc" id="L987">			String lng = getLocalLng();</span>
<span class="nc bnc" id="L988" title="All 6 branches missed.">			if (Tools.isNotEmpty(lng) &amp;&amp; basePath.length()&gt;1 &amp;&amp; basePath.startsWith(&quot;/System&quot;)==false)</span>
			{
<span class="nc" id="L990">				String[] exploded = Tools.getTokens(basePath, &quot;/&quot;);</span>
<span class="nc" id="L991">				StringBuilder translated = new StringBuilder();</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">				for (String str : exploded)</span>
				{
					//basePath = CloudToolsForCore.translate(lng, basePath);
<span class="nc" id="L995">					translated.append('/');</span>
<span class="nc" id="L996">					translated.append(CloudToolsForCore.translate(lng, str));</span>
				}
<span class="nc" id="L998">				basePath = translated.toString();</span>
<span class="nc" id="L999">				Logger.debug(getClass(), &quot;translating basePath to: &quot; + basePath);</span>
			}
		}
<span class="fc" id="L1002">		String localPath = getLocalRootGroup().getFullPath()+basePath; //TODO: preklad?</span>
<span class="fc" id="L1003">		return localPath;</span>
	}

	/**
	 * Ziska local adresar
	 * @param remoteGroupId
	 * @return
	 */
	public GroupDetails getLocalGroup(int remoteGroupId)
	{
<span class="fc" id="L1013">		GroupDetails remoteGroup = getRemoteGroup(remoteGroupId);</span>
<span class="pc bpc" id="L1014" title="1 of 2 branches missed.">		if (remoteGroup!=null) return getLocalGroup(remoteGroup);</span>
<span class="nc" id="L1015">		return null;</span>
	}

	/**
	 * Ziska local adresar
	 * @param remoteGroup
	 * @return
	 */
	public GroupDetails getLocalGroup(GroupDetails remoteGroup)
	{
<span class="fc" id="L1025">		String localPath = getLocalPath(remoteGroup);</span>
		try
		{
<span class="fc" id="L1028">			return GroupsDB.getInstance().getGroupByPath(localPath);</span>
		}
<span class="nc" id="L1030">		catch (ConcurrentModificationException ex)</span>
		{
<span class="nc" id="L1032">			GroupsDB groupsDB = GroupsDB.getInstance(true);</span>
<span class="nc" id="L1033">			return groupsDB.getGroupByPath(localPath);</span>
		}
	}

	/**
	 * Ziska local adresar
	 * @param localPath
	 * @return
	 */
	public GroupDetails getLocalGroup(String localPath)
	{
<span class="fc" id="L1044">		return GroupsDB.getInstance().getGroupByPath(localPath);</span>
	}

	/**
	 * Ziska local root adresar (na zaklade zadaneho localGroupId)
	 * @return
	 */
	public GroupDetails getLocalRootGroup()
	{
<span class="fc bfc" id="L1053" title="All 2 branches covered.">		if (localRootGroup == null)</span>
		{
<span class="fc" id="L1055">			localRootGroup = GroupsDB.getInstance().getGroup(getLocalGroupId());</span>
		}
<span class="fc" id="L1057">		return localRootGroup;</span>
	}

	/**
	 * Vrati local web stranku pre zadanu remote stranku
	 * @param remoteDoc
	 * @return
	 */
	public DocDetails getLocalDoc(DocDetails remoteDoc)
	{
<span class="fc" id="L1067">		GroupDetails localGroup = getLocalGroup(remoteDoc.getGroupId());</span>
<span class="pc bpc" id="L1068" title="1 of 2 branches missed.">		if (localGroup!=null)</span>
		{
			//najdi local doc
<span class="fc" id="L1071">			DocDB docDB = DocDB.getInstance();</span>
<span class="fc" id="L1072">			List&lt;DocDetails&gt; localDocs = docDB.getBasicDocDetailsByGroup(localGroup.getGroupId(), DocDB.ORDER_PRIORITY);</span>
<span class="fc bfc" id="L1073" title="All 2 branches covered.">			for (DocDetails doc : localDocs)</span>
			{
<span class="pc bpc" id="L1075" title="3 of 8 branches missed.">				if (doc.getTitle().equals(remoteDoc.getTitle()) || (Tools.isNotEmpty(remoteDoc.getVirtualPath()) &amp;&amp; Tools.isNotEmpty(doc.getVirtualPath()) &amp;&amp; doc.getVirtualPath().equals(remoteDoc.getVirtualPath()) ))</span>
				{
<span class="fc" id="L1077">					return(doc);</span>
				}
<span class="fc" id="L1079">			}</span>
		}
<span class="fc" id="L1081">		return null;</span>
	}

	/**
	 * Vrati nazov vzdialenej sablony podla id
	 * @param remoteTempId
	 * @return
	 */
	public String getRemoteTempName(int remoteTempId)
	{
<span class="nc" id="L1091">		TemplateDetails temp = getRemoteTemp(remoteTempId);</span>
<span class="nc bnc" id="L1092" title="All 2 branches missed.">		return (null == temp) ? null : temp.getTempName();</span>
	}

	/**
	 * Vrati vzdialenu sablonu podla id
	 * @param remoteTempId
	 * @return
	 */
	public TemplateDetails getRemoteTemp(int remoteTempId)
	{
<span class="pc bpc" id="L1102" title="1 of 2 branches missed.">		for (TemplateDetails temp : getRemoteTemps())</span>
		{
<span class="pc bpc" id="L1104" title="1 of 2 branches missed.">			if (temp.getTempId()==remoteTempId) return temp;</span>
<span class="nc" id="L1105">		}</span>
<span class="nc" id="L1106">		return null;</span>
	}

	/**
	 * Vrati nazov lokalnej sablony podla id
	 * @param localTempId
	 * @return
	 */
	public String getLocalTempName(int localTempId)
	{
<span class="nc" id="L1116">		TemplateDetails temp = TemplatesDB.getInstance().getTemplate(localTempId);</span>
<span class="nc bnc" id="L1117" title="All 2 branches missed.">		if (temp!=null) return temp.getTempName();</span>
<span class="nc" id="L1118">		return null;</span>
	}

	/**
	 * Vrati id lokalnej sablony podla nazvu
	 * @param tempName
	 * @return
	 */
	public int getLocalTempId(String tempName)
	{
<span class="pc bpc" id="L1128" title="1 of 2 branches missed.">		if (&quot;cloud&quot;.equals(Constants.getInstallName()))</span>
		{
<span class="nc" id="L1130">			String lng = getLocalLng();</span>
<span class="nc bnc" id="L1131" title="All 2 branches missed.">			if (Tools.isNotEmpty(lng))</span>
			{
<span class="nc" id="L1133">				tempName = tempName + &quot;-&quot;+lng;</span>
			}
		}

<span class="fc" id="L1137">		TemplateDetails temp = TemplatesDB.getInstance().getTemplate(tempName);</span>
<span class="pc bpc" id="L1138" title="1 of 2 branches missed.">		if (temp!=null) return temp.getTempId();</span>
<span class="nc" id="L1139">		return -1;</span>
	}

	/**
	 * Vrati zoznam remote sablon
	 * @return
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public List&lt;TemplateDetails&gt; getRemoteTemps()
	{
<span class="pc bpc" id="L1149" title="1 of 2 branches missed.">		if (remoteTemps == null)</span>
		{
<span class="fc" id="L1151">			remoteTemps = (List&lt;TemplateDetails&gt;) getLocalFile(&quot;temps.xml&quot;);</span>
		}
<span class="fc" id="L1153">		return remoteTemps;</span>
	}

	private int getCreateUserGroup(int remoteUserGroupId)
	{
<span class="nc" id="L1158">		UserGroupDetails remoteUserGroup = getRemoteUserGroup(remoteUserGroupId);</span>
<span class="nc bnc" id="L1159" title="All 2 branches missed.">		if (remoteUserGroup==null)</span>
		{
<span class="nc" id="L1161">			context.getRequest().setAttribute(&quot;errorText&quot;, &quot;Neexistuje remote pouzivatelska skupina pre userGroupId=&quot;+remoteUserGroupId);</span>
<span class="nc" id="L1162">			Logger.debug(SyncDirAction.class, &quot;Neexistuje remote pouzivatelska skupina pre userGroupId=&quot;+remoteUserGroupId);</span>
<span class="nc" id="L1163">			return -1;</span>
		}
<span class="nc" id="L1165">		int localUserGroupId = getLocalUserGroupId(remoteUserGroup.getUserGroupName());</span>
<span class="nc bnc" id="L1166" title="All 4 branches missed.">		if (localUserGroupId &lt; 1 &amp;&amp; createMissingUserGroups)</span>
		{
<span class="nc" id="L1168">			int oUserGroupId = remoteUserGroup.getUserGroupId();</span>

<span class="nc" id="L1170">			remoteUserGroup.setUserGroupId(-1);</span>
<span class="nc" id="L1171">			UserGroupsDB.saveUserGroup(remoteUserGroup);</span>
<span class="nc" id="L1172">			localUserGroupId = remoteUserGroup.getUserGroupId();</span>

<span class="nc" id="L1174">			remoteUserGroup.setUserGroupId(oUserGroupId);</span>
		}
<span class="nc bnc" id="L1176" title="All 2 branches missed.">		if (localUserGroupId &lt; 1)</span>
		{
<span class="nc" id="L1178">			context.getRequest().setAttribute(&quot;errorText&quot;, &quot;Neexistuje lokálna používateľská skupina &quot;+remoteUserGroup.getUserGroupName());</span>
<span class="nc" id="L1179">			Logger.debug(SyncDirAction.class, &quot;Neexistuje lokálna používateľská skupina &quot;+remoteUserGroup.getUserGroupName());</span>
<span class="nc" id="L1180">			return -1;</span>
		}
<span class="nc" id="L1182">		return localUserGroupId;</span>
	}

	/**
	 * Vrati remote nazov user group podla zadaneho id
	 * @param remoteUserGroupId
	 * @return
	 */
	public String getRemoteUserGroupName(int remoteUserGroupId)
	{
<span class="nc" id="L1192">		UserGroupDetails ugd = getRemoteUserGroup(remoteUserGroupId);</span>
<span class="nc bnc" id="L1193" title="All 2 branches missed.">		return (null == ugd) ? null : ugd.getUserGroupName();</span>
	}

	/**
	 * Vrati vzdialenu pouzivatelsku skupinu na zaklade jej ID
	 * @param remoteUserGroupId
	 * @return
	 */
	public UserGroupDetails getRemoteUserGroup(int remoteUserGroupId)
	{
<span class="nc bnc" id="L1203" title="All 2 branches missed.">		for (UserGroupDetails ugd : getRemoteUserGroups())</span>
		{
<span class="nc bnc" id="L1205" title="All 2 branches missed.">			if (ugd.getUserGroupId()==remoteUserGroupId) return ugd;</span>
<span class="nc" id="L1206">		}</span>
<span class="nc" id="L1207">		return null;</span>
	}

	/**
	 * Vrati lokalne id pouzivatelskej skupiny podla nazvu
	 * @param userGroupName
	 * @return
	 */
	public int getLocalUserGroupId(String userGroupName)
	{
<span class="nc" id="L1217">		UserGroupDetails ugd = getLocalUserGroup(userGroupName);</span>
<span class="nc bnc" id="L1218" title="All 2 branches missed.">		return (null == ugd) ? -1 : ugd.getUserGroupId();</span>
	}

	/**
	 * Vrati lokalnu pouzivatelsku skupinu na zaklade jej nazvu
	 * @param userGroupName
	 * @return
	 */
	public UserGroupDetails getLocalUserGroup(String userGroupName)
	{
<span class="nc" id="L1228">		return UserGroupsDB.getInstance().getUserGroup(userGroupName);</span>
	}

	/**
	 * Vrati lokalnu pouzivatelsku skupinu na zaklade jej ID
	 * @param localUserGroupId
	 * @return
	 */
	public UserGroupDetails getLocalUserGroup(int localUserGroupId)
	{
<span class="nc" id="L1238">		return UserGroupsDB.getInstance().getUserGroup(localUserGroupId);</span>
	}

	/**
	 * Vrati zoznam remote user groups
	 * @return
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public List&lt;UserGroupDetails&gt; getRemoteUserGroups()
	{
<span class="nc bnc" id="L1248" title="All 2 branches missed.">		if (remoteUserGroups == null)</span>
		{
<span class="nc" id="L1250">			remoteUserGroups = (List&lt;UserGroupDetails&gt;) getLocalFile(&quot;usergroups.xml&quot;);</span>
		}
<span class="nc" id="L1252">		return remoteUserGroups;</span>
	}


	private int getCreatePerexGroup(int remotePerexGroupId)
	{
<span class="nc" id="L1258">		PerexGroupBean remotePerexGroup = getRemotePerexGroup(remotePerexGroupId);</span>
<span class="nc bnc" id="L1259" title="All 2 branches missed.">		if (remotePerexGroup==null)</span>
		{
<span class="nc" id="L1261">			context.getRequest().setAttribute(&quot;errorText&quot;, &quot;Neexistuje remote perex skupina pre perexGroupId=&quot;+remotePerexGroupId);</span>
<span class="nc" id="L1262">			Logger.debug(SyncDirAction.class, &quot;Neexistuje remote perex skupina pre perexGroupId=&quot;+remotePerexGroupId);</span>
<span class="nc" id="L1263">			return -1;</span>
		}
<span class="nc" id="L1265">		int localPerexGroupId = getLocalPerexGroupId(remotePerexGroup.getPerexGroupName());</span>
<span class="nc bnc" id="L1266" title="All 4 branches missed.">		if (localPerexGroupId &lt; 1 &amp;&amp; createMissingUserGroups)</span>
		{
			//premigrovat ID adresarov, POZOR: v groups.xml mame len exportovane skupiny, takze to nevie setnut prava na ine skupiny ako exportovane
<span class="nc" id="L1269">			StringBuilder availableGroups = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L1270" title="All 2 branches missed.">			if (Tools.isNotEmpty(remotePerexGroup.getAvailableGroups())) {</span>
<span class="nc" id="L1271">				int[] remoteGroupIds = Tools.getTokensInt(remotePerexGroup.getAvailableGroups(), &quot;,&quot;);</span>
<span class="nc bnc" id="L1272" title="All 2 branches missed.">				for (int groupId : remoteGroupIds) {</span>
<span class="nc" id="L1273">					GroupDetails group = getLocalGroup(groupId);</span>
<span class="nc bnc" id="L1274" title="All 2 branches missed.">					if (group != null) {</span>
<span class="nc bnc" id="L1275" title="All 2 branches missed.">						if (Tools.isNotEmpty(availableGroups)) availableGroups.append(&quot;,&quot;);</span>
<span class="nc" id="L1276">						availableGroups.append(String.valueOf(group.getGroupId()));</span>
					}
				}
			}
<span class="nc" id="L1280">			DocDB.getInstance().savePerexGroup(remotePerexGroup.getPerexGroupName(), -1, availableGroups.toString(), null);</span>
<span class="nc" id="L1281">			localPerexGroupId = getLocalPerexGroupId(remotePerexGroup.getPerexGroupName());</span>
		}
<span class="nc bnc" id="L1283" title="All 2 branches missed.">		if (localPerexGroupId &lt; 1)</span>
		{
<span class="nc" id="L1285">			context.getRequest().setAttribute(&quot;errorText&quot;, &quot;Neexistuje lokálna perex skupina &quot;+remotePerexGroup.getPerexGroupName());</span>
<span class="nc" id="L1286">			Logger.debug(SyncDirAction.class, &quot;Neexistuje lokálna perex skupina &quot;+remotePerexGroup.getPerexGroupName());</span>
<span class="nc" id="L1287">			return -1;</span>
		}
<span class="nc" id="L1289">		return localPerexGroupId;</span>
	}

	/**
	 * Vrati remote nazov perex group podla zadaneho id
	 * @param remotePerexGroupId
	 * @return
	 */
	public String getRemotePerexGroupName(int remotePerexGroupId)
	{
<span class="nc" id="L1299">		PerexGroupBean pgb = getRemotePerexGroup(remotePerexGroupId);</span>
<span class="nc bnc" id="L1300" title="All 2 branches missed.">		return (null == pgb) ? null : pgb.getPerexGroupName();</span>
	}

	/**
	 * Vrati vzdialenu perex skupinu na zaklade jej ID
	 * @param remotePerexGroupId
	 * @return
	 */
	public PerexGroupBean getRemotePerexGroup(int remotePerexGroupId)
	{
<span class="nc bnc" id="L1310" title="All 2 branches missed.">		for (PerexGroupBean pgd : getRemotePerexGroups())</span>
		{
<span class="nc bnc" id="L1312" title="All 2 branches missed.">			if (pgd.getPerexGroupId()==remotePerexGroupId) return pgd;</span>
<span class="nc" id="L1313">		}</span>
<span class="nc" id="L1314">		return null;</span>
	}

	/**
	 * Vrati lokalne id perex skupiny podla nazvu
	 * @param perexGroupName
	 * @return
	 */
	public int getLocalPerexGroupId(String perexGroupName)
	{
<span class="nc" id="L1324">		PerexGroupBean pgd = getLocalPerexGroup(perexGroupName);</span>
<span class="nc bnc" id="L1325" title="All 2 branches missed.">		return (null == pgd) ? -1 : pgd.getPerexGroupId();</span>
	}

	/**
	 * Vrati lokalnu perex skupinu na zaklade jej nazvu
	 * @param perexGroupName
	 * @return
	 */
	public PerexGroupBean getLocalPerexGroup(String perexGroupName)
	{
<span class="nc" id="L1335">		return DocDB.getInstance().getPerexGroupByName(perexGroupName);</span>
	}

	/**
	 * Vrati lokalnu perex skupinu na zaklade jej ID
	 * @param localPerexGroupId
	 * @return
	 */
	public PerexGroupBean getLocalPerexGroup(int localPerexGroupId)
	{
<span class="nc" id="L1345">		return DocDB.getInstance().getPerexGroup(localPerexGroupId, null);</span>
	}


	/**
	 * Vrati zoznam remote perex groups
	 * @return
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public List&lt;PerexGroupBean&gt; getRemotePerexGroups()
	{
<span class="pc bpc" id="L1356" title="1 of 2 branches missed.">		if (remotePerexGroups == null)</span>
		{
<span class="fc" id="L1358">			remotePerexGroups = (List&lt;PerexGroupBean&gt;) getLocalFile(&quot;perexgroups.xml&quot;);</span>
		}
<span class="fc" id="L1360">		return remotePerexGroups;</span>
	}

	@Override
	public ActionBeanContext getContext()
	{
<span class="fc" id="L1366">		return context;</span>
	}
	@Override
	public void setContext(ActionBeanContext context)
	{
<span class="fc" id="L1371">		super.setContext(context);</span>

<span class="fc" id="L1373">		Identity user = getUser();</span>
<span class="pc bpc" id="L1374" title="1 of 2 branches missed.">		if (user != null)</span>
		{
			// ak je true synchrozujeme s xml subormi v syncdir a nastavime fake loginy, ktore sa ale nikde nepouzije, su tam len kvoli valid a pod.
<span class="pc bpc" id="L1377" title="1 of 2 branches missed.">			if (Tools.isNotEmpty( context.getRequest().getParameter(&quot;syncDir&quot;)))</span>
			{
<span class="fc" id="L1379">				setSyncDir(context.getRequest().getParameter(&quot;syncDir&quot;));</span>
			}
		}
<span class="fc" id="L1382">	}</span>

	public void setSyncDir(String syncDir)
	{
<span class="fc" id="L1386">		this.syncDir = syncDir;</span>
<span class="fc" id="L1387">	}</span>

	public int getLocalGroupId()
	{
<span class="fc" id="L1391">		return localGroupId;</span>
	}

	public void setLocalGroupId(int localGroupId)
	{
<span class="fc" id="L1396">		this.localGroupId = localGroupId;</span>
<span class="fc" id="L1397">	}</span>

	public int getRemoteGroupId()
	{
<span class="fc" id="L1401">		return remoteGroupId;</span>
	}

	public void setRemoteGroupId(int remoteGroupId)
	{
<span class="fc" id="L1406">		this.remoteGroupId = remoteGroupId;</span>
<span class="fc" id="L1407">	}</span>

	public boolean isCreateMissingTemplates()
	{
<span class="fc" id="L1411">		return createMissingTemplates;</span>
	}

	public void setCreateMissingTemplates(boolean createMissingTemplates)
	{
<span class="fc" id="L1416">		this.createMissingTemplates = createMissingTemplates;</span>
<span class="fc" id="L1417">	}</span>

	public boolean isCreateMissingUserGroups()
	{
<span class="fc" id="L1421">		return createMissingUserGroups;</span>
	}

	public void setCreateMissingUserGroups(boolean createMissingUserGroups)
	{
<span class="fc" id="L1426">		this.createMissingUserGroups = createMissingUserGroups;</span>
<span class="fc" id="L1427">	}</span>

	/**
	 * Vrati dekodovany objekt z XML suboru.
	 *
	 * @param filename  retazec obsahujuci nazov XML suboru
	 * @return          objekt z tohto suboru, alebo null ak nieco nevyjde
	 */
	private Object getLocalFile(String filename)
	{
<span class="fc" id="L1437">		InputStream inputStream = null;</span>
<span class="fc" id="L1438">		InputStream inputStream2 = null;</span>
		try
		{
<span class="fc" id="L1441">			String realPath = Tools.getRealPath(syncDir) + java.io.File.separatorChar + filename;</span>
<span class="fc" id="L1442">			Logger.debug(SyncDirAction.class, &quot;Reading local file: &quot;+realPath);</span>
<span class="fc" id="L1443">			inputStream = new IwcmInputStream(realPath);</span>
<span class="fc" id="L1444">			inputStream2 = checkXmlForAttack(inputStream);</span>
<span class="fc" id="L1445">			XMLDecoder decoder = new XMLDecoder(inputStream2, null, new WarningListener());</span>
<span class="fc" id="L1446">			Object o = decoder.readObject();</span>
<span class="fc" id="L1447">			decoder.close();</span>
			//Logger.debug(SyncDirAction.class, &quot;readed, o=&quot;+o);
<span class="fc" id="L1449">			return o;</span>
		}
<span class="nc" id="L1451">		catch (IOException|IndexOutOfBoundsException ex)</span>
		{
<span class="nc" id="L1453">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L1454">			errorMessages.add(ex.getMessage());</span>
		}
		finally {
<span class="pc bpc" id="L1457" title="1 of 2 branches missed.">			if (inputStream != null) {</span>
<span class="pc" id="L1458">				try { inputStream.close(); } catch (Exception ex) {}</span>
			}
<span class="pc bpc" id="L1460" title="1 of 2 branches missed.">			if (inputStream2 != null) {</span>
<span class="pc" id="L1461">				try { inputStream2.close(); } catch (Exception ex) {}</span>
			}
		}
<span class="nc" id="L1464">		return null;</span>
	}

	public void cleanFiles()
	{
<span class="nc bnc" id="L1469" title="All 2 branches missed.">		if (!Tools.isEmpty(syncDir))</span>
		{
<span class="nc" id="L1471">			Content content = getRemoteContent();</span>
<span class="nc bnc" id="L1472" title="All 4 branches missed.">			if (content!=null &amp;&amp; content.getFiles()!=null) {</span>
<span class="nc" id="L1473">				String tmpDir = Tools.getRealPath(syncDir);</span>
<span class="nc bnc" id="L1474" title="All 2 branches missed.">				for (Content.File file : content.getFiles())</span>
				{
<span class="nc" id="L1476">					new IwcmFile(tmpDir + java.io.File.separatorChar + &quot;/content/&quot; + file.getZipPath().replace(&quot;/&quot;, File.separator)).delete();</span>
<span class="nc" id="L1477">				}</span>
<span class="nc" id="L1478">				new IwcmFile(tmpDir + java.io.File.separatorChar + &quot;/content&quot;).delete();</span>
<span class="nc bnc" id="L1479" title="All 2 branches missed.">				for (String filename : new String[]{ &quot;docs.xml&quot;, &quot;groups.xml&quot;, &quot;temps.xml&quot;, &quot;perexgroups.xml&quot;, &quot;usergroups.xml&quot;, &quot;content.xml&quot; })</span>
				{
<span class="nc" id="L1481">					new IwcmFile(tmpDir + java.io.File.separatorChar + filename).delete();</span>
				}
<span class="nc" id="L1483">				new IwcmFile(tmpDir).delete();</span>
			}
		}
<span class="nc" id="L1486">	}</span>

	private Identity getUser()
	{
<span class="fc" id="L1490">		return (Identity) context.getRequest().getSession().getAttribute(Constants.USER_KEY);</span>
	}

	public String getLocalDomain()
	{
<span class="nc" id="L1495">		return localDomain;</span>
	}

	public void setLocalDomain(String localDomain)
	{
<span class="fc" id="L1500">		this.localDomain = localDomain;</span>
<span class="fc" id="L1501">	}</span>

	/**
	 * Jednoduche premapovanie ID adresarov na nove hodnoty v lokalnom systeme
	 * @return
	 */
	private String fixGroupIdsInContent(String htmlCode)
	{
<span class="fc" id="L1509">		int start = htmlCode.indexOf(&quot;groupIds=&quot;);</span>
<span class="pc bpc" id="L1510" title="1 of 2 branches missed.">		if (start==-1) return htmlCode;</span>

		//prehladame hodnoty groupIds= a nahradime ich za novy vyraz
<span class="nc" id="L1513">		Matcher matcher = Pattern.compile(&quot;!INCLUDE\\(/components/[^)]*groupIds=(['\&quot;&amp;quot;+1234567890]*)[^)]*\\)!&quot;).matcher(htmlCode);</span>
<span class="nc bnc" id="L1514" title="All 2 branches missed.">		while (matcher.find())</span>
		{
<span class="nc" id="L1516">		 	Logger.debug(SyncDirAction.class, &quot;Mam:&quot;);</span>
<span class="nc" id="L1517">		 	Logger.debug(SyncDirAction.class, matcher.group());</span>
<span class="nc" id="L1518">		 	Logger.debug(SyncDirAction.class, matcher.group(1));</span>
<span class="nc" id="L1519">			String groupIds = matcher.group(1);</span>
<span class="nc" id="L1520">			Logger.debug(SyncDirAction.class, &quot;groupIds=&quot;+groupIds);</span>
<span class="nc" id="L1521">			String groupIdsOrig = groupIds;</span>
<span class="nc" id="L1522">			groupIds = Tools.replace(groupIds, &quot;&amp;quot;&quot;, &quot;\&quot;&quot;);</span>
<span class="nc" id="L1523">			groupIds = groupIds.replace('&quot;', ' ');</span>
<span class="nc" id="L1524">			groupIds = groupIds.replace('\'', ' ');</span>
<span class="nc" id="L1525">			groupIds = groupIds.trim();</span>
<span class="nc" id="L1526">			int[] groupIdsArr = Tools.getTokensInt(groupIds, &quot;+&quot;);</span>
<span class="nc" id="L1527">			StringBuilder newGroupIds = new StringBuilder();</span>
<span class="nc bnc" id="L1528" title="All 2 branches missed.">			for (int groupId : groupIdsArr)</span>
			{
<span class="nc" id="L1530">				int localId = groupId;</span>
<span class="nc" id="L1531">				GroupDetails localGroup = getLocalGroup(groupId);</span>
<span class="nc bnc" id="L1532" title="All 2 branches missed.">				if (localGroup != null) localId = localGroup.getGroupId();</span>
<span class="nc bnc" id="L1533" title="All 2 branches missed.">				if (newGroupIds.length()&gt;0) newGroupIds.append('+');</span>
<span class="nc" id="L1534">				newGroupIds.append(localId);</span>
			}

<span class="nc bnc" id="L1537" title="All 4 branches missed.">			if (Tools.isEmpty(groupIdsOrig) || Tools.isEmpty(newGroupIds.toString())) continue;</span>

<span class="nc" id="L1539">			Logger.debug(SyncDirAction.class, &quot;replacing to:&quot;+newGroupIds.toString());</span>
<span class="nc" id="L1540">			Logger.debug(SyncDirAction.class, &quot;test:&quot;+&quot;groupIds=&quot;+groupIdsOrig+&quot;,&quot;);</span>

<span class="nc bnc" id="L1542" title="All 4 branches missed.">			if (groupIdsOrig.charAt(0)=='&quot;' || groupIdsOrig.charAt(0)=='\'')</span>
			{
<span class="nc" id="L1544">				newGroupIds.insert(0, groupIdsOrig.charAt(0));</span>
<span class="nc" id="L1545">				newGroupIds.append(groupIdsOrig.charAt(0));</span>
			}

<span class="nc" id="L1548">			htmlCode = Tools.replace(htmlCode, &quot;groupIds=&quot;+groupIdsOrig+&quot;,&quot;, &quot;groupIds=&quot;+newGroupIds.toString()+&quot;,&quot;);</span>
<span class="nc" id="L1549">			htmlCode = Tools.replace(htmlCode, &quot;groupIds=&quot;+groupIdsOrig+&quot;)&quot;, &quot;groupIds=&quot;+newGroupIds.toString()+&quot;)&quot;);</span>
<span class="nc" id="L1550">			htmlCode = Tools.replace(htmlCode, &quot;groupIds=&quot;+groupIdsOrig+&quot; &quot;, &quot;groupIds=&quot;+newGroupIds.toString()+&quot; &quot;);</span>
<span class="nc" id="L1551">		}</span>

<span class="nc" id="L1553">		return htmlCode;</span>
	}

	/**
	 * Vrati jazyk do ktoreho sa ma vykonat preklad pri klonovani
	 * @return
	 */
	private String getLocalLng()
	{
<span class="nc" id="L1562">		String lng = getRequest().getParameter(&quot;language&quot;);</span>

<span class="nc bnc" id="L1564" title="All 2 branches missed.">		if (&quot;cloud&quot;.equals(Constants.getInstallName()))</span>
		{
<span class="nc bnc" id="L1566" title="All 6 branches missed.">			if (&quot;sk&quot;.equals(lng) || &quot;cz&quot;.equals(lng) || &quot;de&quot;.equals(lng))</span>
			{
<span class="nc" id="L1568">				return lng;</span>
			}
<span class="nc" id="L1570">			return null;</span>
		}

<span class="nc" id="L1573">		return lng;</span>
	}

	private void saveRollbackJson(List&lt;Integer&gt; historyIds, List&lt;Integer&gt; historyGroupsIds)
	{
<span class="fc" id="L1578">		String archivePath = &quot;/files/protected/backup/&quot;; //NOSONAR</span>
<span class="fc" id="L1579">		String archiveName = localGroupId + &quot;_&quot; + new SimpleDateFormat(&quot;dd-MM-yyyy_HH-mm-ss&quot;).format(new Date())+&quot;.json&quot;;</span>
<span class="fc" id="L1580">		BufferedOutputStream output = null;</span>
		try
		{
<span class="fc" id="L1583">			JSONArray docs = new JSONArray();</span>
<span class="fc bfc" id="L1584" title="All 2 branches covered.">			for(Integer id : historyIds)</span>
			{
<span class="fc" id="L1586">				JSONObject item = new JSONObject();</span>
<span class="fc" id="L1587">				item.put(&quot;historyId&quot;,  id);</span>
<span class="fc" id="L1588">			   docs.put(item);</span>
<span class="fc" id="L1589">			}</span>

<span class="fc" id="L1591">			JSONArray groups = new JSONArray();</span>
<span class="pc bpc" id="L1592" title="1 of 2 branches missed.">			for(Integer id : historyGroupsIds)</span>
			{
<span class="nc" id="L1594">				JSONObject item = new JSONObject();</span>
<span class="nc" id="L1595">				item.put(&quot;historyGroupId&quot;,  id);</span>
<span class="nc" id="L1596">				groups.put(item);</span>
<span class="nc" id="L1597">			}</span>

<span class="fc" id="L1599">			JSONObject result = new JSONObject();</span>
<span class="fc" id="L1600">			result.put(&quot;docs&quot;, docs);</span>
<span class="fc" id="L1601">			result.put(&quot;groups&quot;, groups);</span>

<span class="fc" id="L1603">			IwcmFile dir = IwcmFile.fromVirtualPath(archivePath);</span>
<span class="fc" id="L1604">			Logger.debug(SyncDirAction.class, &quot;Archive directory: &quot;+dir.getAbsolutePath()+&quot; exists: &quot;+dir.exists());</span>
<span class="pc bpc" id="L1605" title="1 of 2 branches missed.">			if(!dir.exists())</span>
			{
<span class="nc" id="L1607">				Logger.debug(SyncDirAction.class, &quot;Creating directory: &quot;+dir.getAbsolutePath());</span>
<span class="nc" id="L1608">				dir.mkdirs();</span>
			}

<span class="fc" id="L1611">			output = new BufferedOutputStream(new IwcmOutputStream(new IwcmFile(PathFilter.getRealPath(archivePath), archiveName)));</span>
<span class="fc" id="L1612">			output.write(result.toString(3).getBytes(StandardCharsets.UTF_8));</span>
<span class="fc" id="L1613">			output.close();</span>
<span class="fc" id="L1614">			output = null;</span>
		}
<span class="nc" id="L1616">		catch(Exception e)	{sk.iway.iwcm.Logger.error(e);}</span>
		finally
		{
<span class="pc bpc" id="L1619" title="1 of 2 branches missed.">			if(output!=null)</span>
			{
<span class="nc" id="L1621">				try						{output.close();}</span>
<span class="nc" id="L1622">				catch (Exception ex)	{sk.iway.iwcm.Logger.error(ex);}</span>
			}
		}
<span class="fc" id="L1625">	}</span>

	private List&lt;Integer&gt; getNewGroups(Date start)
	{
<span class="fc" id="L1629">		List&lt;Integer&gt; result = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L1631">		Connection db_conn = null;</span>
<span class="fc" id="L1632">		PreparedStatement ps = null;</span>
<span class="fc" id="L1633">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L1636">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L1637">			ps = db_conn.prepareStatement(&quot;SELECT schedule_id FROM groups_scheduler WHERE save_date &gt;= ?&quot;);</span>
<span class="fc" id="L1638">			ps.setTimestamp(1, new Timestamp(start.getTime()));</span>
<span class="fc" id="L1639">			rs = ps.executeQuery();</span>
<span class="pc bpc" id="L1640" title="1 of 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L1642">				result.add(rs.getInt(&quot;schedule_id&quot;));</span>
			}
<span class="fc" id="L1644">			rs.close();</span>
<span class="fc" id="L1645">			ps.close();</span>
<span class="fc" id="L1646">			db_conn.close();</span>
<span class="fc" id="L1647">			rs = null;</span>
<span class="fc" id="L1648">			ps = null;</span>
<span class="fc" id="L1649">			db_conn = null;</span>
		}
<span class="nc" id="L1651">		catch (Exception ex)</span>
		{
<span class="nc" id="L1653">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L1659" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L1660">					rs.close();</span>
<span class="pc bpc" id="L1661" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1662">					ps.close();</span>
<span class="pc bpc" id="L1663" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L1664">					db_conn.close();</span>
			}
<span class="nc" id="L1666">			catch (Exception ex2)</span>
			{
<span class="fc" id="L1668">			}</span>
		}

<span class="fc" id="L1671">		return result;</span>
	}

	@SuppressWarnings(&quot;unchecked&quot;)
	public Map&lt;Integer, DocNoteBean&gt; getRemoteDocsNotes()
	{
<span class="pc bpc" id="L1677" title="1 of 2 branches missed.">		if (remoteNotesMap==null)</span>
		{
<span class="fc" id="L1679">			remoteNotesMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L1680">			List&lt;DocNoteBean&gt; remoteNotes = (List&lt;DocNoteBean&gt;) getLocalFile(&quot;notes.xml&quot;);</span>

<span class="pc bpc" id="L1682" title="1 of 2 branches missed.">			if (remoteNotes != null)</span>
			{
<span class="fc bfc" id="L1684" title="All 2 branches covered.">				for (DocNoteBean note : remoteNotes)</span>
				{
<span class="fc" id="L1686">					remoteNotesMap.put(note.getDocId(), note);</span>
<span class="fc" id="L1687">				}</span>
			}
		}

<span class="fc" id="L1691">		return remoteNotesMap;</span>
	}

	// [#37105 - Druhy nalez z penetracnycch testov] - uloha #0
	public static InputStream checkXmlForAttack(InputStream inputStream) throws IOException {
<span class="fc" id="L1696">		String xmlDecoderAllowedClasses = Constants.getString(&quot;XMLDecoderAllowedClasses&quot;, &quot;&quot;);</span>
<span class="fc" id="L1697">		List&lt;String&gt; allowedClasses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L1698" title="All 2 branches covered.">		for (String className : Tools.getTokens(xmlDecoderAllowedClasses, &quot;,&quot;)) {</span>
<span class="fc" id="L1699">			className = className.trim();</span>
			//toto nemozeme povolit, nie je na to dovod
<span class="pc bpc" id="L1701" title="1 of 2 branches missed.">			if (className.contains(&quot;java.lang.Runtime&quot;)) continue;</span>

<span class="fc" id="L1703">			allowedClasses.add(className);</span>
		}

<span class="fc" id="L1706">		ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="fc" id="L1707">		org.apache.commons.io.IOUtils.copy(inputStream, baos);</span>

<span class="pc" id="L1709">		try { inputStream.close(); } catch (IOException ex) { sk.iway.iwcm.Logger.error(ex); }</span>

<span class="fc" id="L1711">		byte[] bytes = baos.toByteArray();</span>

<span class="fc" id="L1713">		final String xml = new String(bytes, StandardCharsets.UTF_8);</span>
<span class="fc" id="L1714">		final String regex = &quot;class=\&quot;[\\w\\.]*\&quot;&quot;;</span>
<span class="fc" id="L1715">		final Pattern pattern = Pattern.compile(regex, Pattern.MULTILINE);</span>
<span class="fc" id="L1716">		final Matcher matcher = pattern.matcher(xml);</span>

<span class="fc" id="L1718">		final Set&lt;String&gt; classes = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L1719" title="All 2 branches covered.">		while (matcher.find()) {</span>
<span class="fc" id="L1720">			String match = matcher.group(0);</span>
<span class="fc" id="L1721">			match = Tools.replace(match, &quot;\&quot;&quot;, &quot;&quot;);</span>
<span class="fc" id="L1722">			match = Tools.replace(match, &quot;class=&quot;, &quot;&quot;);</span>
			//musi to obsahovat nejaky package, v autoupdate v TB sme mali HTML kod sablon a tam bolo class=&quot;meno&quot; vramci HTML kodu
<span class="pc bpc" id="L1724" title="1 of 2 branches missed.">			if (match.contains(&quot;.&quot;)) classes.add(match);</span>
<span class="fc" id="L1725">		}</span>

<span class="pc bpc" id="L1727" title="1 of 2 branches missed.">		if (!allowedClasses.containsAll(classes)) {</span>
<span class="nc bnc" id="L1728" title="All 2 branches missed.">			List&lt;String&gt; notAllowedClasses = classes.stream().filter(c -&gt; !allowedClasses.contains(c)).collect(Collectors.toList());</span>
<span class="nc" id="L1729">			String message = String.format(&quot;XMLDecoder - not allowed classes found: %s&quot;, Tools.join(notAllowedClasses, &quot;, &quot;));</span>
<span class="nc" id="L1730">			log.debug(message);</span>
<span class="nc" id="L1731">			throw new IOException(message);</span>
		}

<span class="fc" id="L1734">		return new ByteArrayInputStream(bytes);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>