<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConfDB.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.system</a> &gt; <span class="el_source">ConfDB.java</span></div><h1>ConfDB.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.system;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Timestamp;
import java.sql.Types;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import sk.iway.Password;
import sk.iway.iwcm.Adminlog;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DB;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.PathFilter;
import sk.iway.iwcm.RequestBean;
import sk.iway.iwcm.SetCharacterEncodingFilter;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.doc.ninja.Ninja;
import sk.iway.iwcm.stat.StatDB;
import sk.iway.iwcm.system.multidomain.MultiDomainFilter;
import sk.iway.iwcm.system.spring.events.WebjetEvent;
import sk.iway.iwcm.system.spring.events.WebjetEventType;
import sk.iway.iwcm.users.UserDetails;

public class ConfDB
{
<span class="fc" id="L33">	public static String CONF_TABLE_NAME = &quot;_conf_&quot;; //NOSONAR</span>
<span class="fc" id="L34">	public static String CONF_PREPARED_TABLE_NAME = &quot;_conf_prepared_&quot;; //NOSONAR</span>
<span class="fc" id="L35">	public static String MODULES_TABLE_NAME = &quot;_modules_&quot;; //NOSONAR</span>
<span class="fc" id="L36">	public static String ADMINLOG_TABLE_NAME = &quot;_adminlog_&quot;; //NOSONAR</span>
<span class="fc" id="L37">	public static String DB_TABLE_NAME = &quot;_db_&quot;; //NOSONAR</span>
<span class="fc" id="L38">	public static String PROPERTIES_TABLE_NAME = &quot;_properties_&quot;; //NOSONAR</span>

<span class="nc" id="L40">	protected ConfDB() {</span>
		//utility class
<span class="nc" id="L42">	}</span>

	public static List&lt;ConfDetails&gt; getConfig()
	{
<span class="fc" id="L46">		return(getConfig(null));</span>
	}

	/**
	 * Vrati konfiguracne hodnotu, ak prefix nie je null tak zacinajuce sa na hodnotu prefixu
	 * @param prefix
	 * @return
	 */
	public static List&lt;ConfDetails&gt; getConfig(String prefix)
	{
<span class="fc" id="L56">		List&lt;ConfDetails&gt; conf = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L57">		Connection db_conn = null;</span>
<span class="fc" id="L58">		PreparedStatement ps = null;</span>
<span class="fc" id="L59">		ResultSet rs = null;</span>
		try
		{
			//nacitaj data z DB
<span class="fc" id="L63">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L64">			ps = db_conn.prepareStatement(&quot;SELECT * FROM &quot; + ConfDB.CONF_TABLE_NAME + &quot; ORDER BY name&quot;);</span>
<span class="fc" id="L65">			rs = ps.executeQuery();</span>
			String value;
			String name;
<span class="fc bfc" id="L68" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="fc" id="L70">				name = DB.getDbString(rs, &quot;name&quot;);</span>
<span class="fc" id="L71">				value = DB.getDbString(rs, &quot;value&quot;);</span>

<span class="fc bfc" id="L73" title="All 4 branches covered.">				if (Tools.isEmpty(prefix) || name.startsWith(prefix))</span>
				{
<span class="fc" id="L75">					conf.add(new ConfDetails(name, value, DB.getDate(rs, &quot;date_changed&quot;)));</span>
				}
			}
<span class="fc" id="L78">			rs.close();</span>
<span class="fc" id="L79">			ps.close();</span>
<span class="fc" id="L80">			db_conn.close();</span>
<span class="fc" id="L81">			rs = null;</span>
<span class="fc" id="L82">			ps = null;</span>
<span class="fc" id="L83">			db_conn = null;</span>
		}
<span class="nc" id="L85">		catch (Exception ex)</span>
		{
<span class="nc" id="L87">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L94">					rs.close();</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L96">					ps.close();</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L98">					db_conn.close();</span>
			}
<span class="nc" id="L100">			catch (Exception ex2)</span>
			{
<span class="fc" id="L102">			}</span>
		}
<span class="fc" id="L104">		return conf;</span>
	}

	public static List&lt;ConfDetails&gt; filterConfDetailsByPerms(Identity user, List&lt;ConfDetails&gt; confList)
	{
		//odfiltruj zoznam podla prav
<span class="fc" id="L110">		String configEnabledKeys = Constants.getStringExecuteMacro(&quot;configEnabledKeys&quot;);</span>

<span class="pc bpc" id="L112" title="1 of 4 branches missed.">		if (Tools.isEmpty(configEnabledKeys) || user.isEnabledItem(&quot;conf.show_all_variables&quot;)) return confList;</span>

<span class="fc" id="L114">		List&lt;ConfDetails&gt; filtered = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L115">		String[] enabledKeys = Tools.getTokens(configEnabledKeys, &quot;,&quot;);</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">		for (ConfDetails c : confList)</span>
		{
<span class="fc bfc" id="L118" title="All 2 branches covered.">			if (isKeyVisibleToUser(user, enabledKeys, c.getName()))</span>
			{
<span class="fc" id="L120">				filtered.add(c);</span>
			}
<span class="fc" id="L122">		}</span>

<span class="fc" id="L124">		return filtered;</span>
	}

	public static List&lt;String&gt; filterByPerms(Identity user, List&lt;String&gt; confList)
	{
		//odfiltruj zoznam podla prav
<span class="nc" id="L130">		String configEnabledKeys = Constants.getStringExecuteMacro(&quot;configEnabledKeys&quot;);</span>

<span class="nc bnc" id="L132" title="All 4 branches missed.">		if (Tools.isEmpty(configEnabledKeys) || user.isEnabledItem(&quot;conf.show_all_variables&quot;)) return confList;</span>

<span class="nc" id="L134">		List&lt;String&gt; filtered = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L135">		String[] enabledKeys = Tools.getTokens(configEnabledKeys, &quot;,&quot;);</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">		for (String c : confList)</span>
		{
<span class="nc bnc" id="L138" title="All 2 branches missed.">			if (isKeyVisibleToUser(user, enabledKeys, c))</span>
			{
<span class="nc" id="L140">				filtered.add(c);</span>
			}
<span class="nc" id="L142">		}</span>

<span class="nc" id="L144">		return filtered;</span>
	}

	public static boolean isKeyVisibleToUser(Identity user, String key) {
		//odfiltruj zoznam podla prav
<span class="nc" id="L149">		String configEnabledKeys = Constants.getStringExecuteMacro(&quot;configEnabledKeys&quot;);</span>

<span class="nc bnc" id="L151" title="All 4 branches missed.">		if (Tools.isEmpty(configEnabledKeys) || user.isEnabledItem(&quot;conf.show_all_variables&quot;)) return true;</span>

<span class="nc" id="L153">		String[] enabledKeys = Tools.getTokens(configEnabledKeys, &quot;,&quot;);</span>
<span class="nc" id="L154">		return isKeyVisibleToUser(user, enabledKeys, key);</span>
	}

	public static boolean isKeyVisibleToUser(Identity user, String[] enabledKeys, String key)
	{
<span class="pc bpc" id="L159" title="2 of 4 branches missed.">		if (Tools.isEmpty(key) || user.isEnabledItem(&quot;conf.show_all_variables&quot;)) return true;</span>

<span class="fc bfc" id="L161" title="All 2 branches covered.">		for (String testKey : enabledKeys)</span>
		{
<span class="fc bfc" id="L163" title="All 2 branches covered.">			if (key.startsWith(testKey))</span>
			{
<span class="fc" id="L165">				return true;</span>
			}
		}
<span class="fc" id="L168">		return false;</span>
	}

	public static boolean deleteName(String name)
	{
<span class="fc" id="L173">		Connection db_conn = null;</span>
<span class="fc" id="L174">		PreparedStatement psDelete = null;</span>
		try
		{
			//nacitaj data z DB
<span class="fc" id="L178">			String sqlDel = &quot;&quot;;</span>
			//editacia DB _conf_
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">			if (name != null)</span>
			{
<span class="fc" id="L182">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L183">				sqlDel = &quot;DELETE FROM &quot; + ConfDB.CONF_TABLE_NAME + &quot; WHERE name=?&quot;;</span>
<span class="fc" id="L184">				psDelete = db_conn.prepareStatement(sqlDel);</span>
<span class="fc" id="L185">				psDelete.setString(1, name);</span>
<span class="fc" id="L186">				psDelete.execute();</span>
				//Logger.println(this,&quot;Number of DELETED rows= &quot; + update);
<span class="fc" id="L188">				psDelete.close();</span>
<span class="fc" id="L189">				db_conn.close();</span>
<span class="fc" id="L190">				psDelete = null;</span>
<span class="fc" id="L191">				db_conn = null;</span>
<span class="fc" id="L192">				Adminlog.add(Adminlog.TYPE_CONF_DELETE, &quot;Zmazana konfiguracna premenna: &quot;+name, -1, -1);</span>

<span class="pc bpc" id="L194" title="1 of 2 branches missed.">				if (&quot;statLanguageDomain&quot;.equals(name)) StatDB.setLanguageDomainTable(null);</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">				if (name.startsWith(&quot;multiDomainAlias:&quot;)) MultiDomainFilter.clearDomainAlias();</span>
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">				if (&quot;responseHeaders&quot;.equals(name)) PathFilter.resetResponseHeaders();</span>

				//if (update != 0)
<span class="fc" id="L199">				return true;</span>
			}

		}
<span class="nc" id="L203">		catch (Exception ex)</span>
		{
<span class="nc" id="L205">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">				if (psDelete != null)</span>
<span class="nc" id="L212">					psDelete.close();</span>
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L214">					db_conn.close();</span>
			}
<span class="nc" id="L216">			catch (Exception ex2)</span>
			{
<span class="fc" id="L218">			}</span>
		}
<span class="nc" id="L220">		return false;</span>
	}

	/**
	 * Pokusi sa desifrovat hodnotu ktora je zasifrovana v konfiguracii
	 * @param value
	 * @return
	 */
	public static String tryDecrypt(String value)
	{
<span class="fc bfc" id="L230" title="All 6 branches covered.">		if (value!=null &amp;&amp; value.length()&gt;32 &amp;&amp; value.startsWith(&quot;encrypted:&quot;))</span>
		{
			try {
<span class="fc" id="L233">				Password pass = new Password();</span>
<span class="fc" id="L234">				String decoded = pass.decrypt(value.substring(&quot;encrypted:&quot;.length()));</span>
<span class="fc" id="L235">				value = decoded;</span>
			}
<span class="nc" id="L237">			catch (Exception ex)</span>
			{
<span class="nc" id="L239">				sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L240">			}</span>
		}
<span class="fc" id="L242">		return value;</span>
	}

	public static boolean setName(String nameParam, String value)
	{
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">		if (Tools.isEmpty(nameParam)) return false;</span>

		//do not save these values
<span class="fc" id="L250">		boolean saveToDb = true;</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">		if (isOnlyLocalConfig(nameParam)) saveToDb = false;</span>

<span class="fc" id="L253">		boolean ret = false;</span>
<span class="fc" id="L254">		Connection db_conn = null;</span>
<span class="fc" id="L255">		PreparedStatement psInsert = null;</span>
		try
		{
<span class="fc" id="L258">			String name = cleanTextRemoveNonPrintableCharacters(nameParam);</span>

			//vyvolaj event
<span class="fc" id="L261">			ConfDetails conf = null;</span>
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">			if (value != null) {</span>
<span class="fc" id="L263">				 conf = new ConfDetails(name, value);</span>
			}
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">			if (conf != null) (new WebjetEvent&lt;ConfDetails&gt;(conf, WebjetEventType.ON_START)).publishEvent();</span>

<span class="pc bpc" id="L267" title="1 of 4 branches missed.">			if (value != null &amp;&amp; saveToDb)</span>
			{
				//nacitaj data z DB
<span class="fc" id="L270">				db_conn = DBPool.getConnection();</span>

<span class="fc" id="L272">				String sqlUpdate = &quot;UPDATE &quot; + ConfDB.CONF_TABLE_NAME + &quot; SET value=?, date_changed=? WHERE name=?&quot;;</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">				if (SetCharacterEncodingFilter.getCurrentRequestBean() != null &amp;&amp;</span>
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">					SetCharacterEncodingFilter.getCurrentRequestBean().getUserId() &gt; 0)</span>
				{
<span class="fc" id="L276">					StringBuilder message = new StringBuilder(&quot;Nastavena konfiguracna premenna: &quot;).append(name).append('\n');</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">					if (Tools.isNotEmpty(Constants.getString(name)))</span>
<span class="fc" id="L278">						message.append(Constants.getString(name)).append(&quot; =&gt; &quot;);</span>
<span class="fc" id="L279">					message.append(value);</span>
<span class="fc" id="L280">					Adminlog.add(Adminlog.TYPE_CONF_UPDATE, message.toString(), -1, -1);</span>
				}
<span class="fc" id="L282">				psInsert = db_conn.prepareStatement(sqlUpdate);</span>
<span class="fc" id="L283">				psInsert.setString(1, value);</span>
<span class="fc" id="L284">				psInsert.setTimestamp(2, new java.sql.Timestamp(Tools.getNow()));</span>
<span class="fc" id="L285">				psInsert.setString(3, name);</span>
<span class="fc" id="L286">				int update = psInsert.executeUpdate();</span>
<span class="fc" id="L287">				psInsert.close();</span>
<span class="fc" id="L288">				psInsert = null;</span>
<span class="fc bfc" id="L289" title="All 2 branches covered.">				if (update &lt; 1)</span>
				{
<span class="fc" id="L291">					String sqlIns = &quot;INSERT INTO &quot; + ConfDB.CONF_TABLE_NAME + &quot; (name, value, date_changed) VALUES (?,?,?)&quot;;</span>
<span class="fc" id="L292">					psInsert = db_conn.prepareStatement(sqlIns);</span>
<span class="fc" id="L293">					psInsert.setString(1, name);</span>
<span class="fc" id="L294">					psInsert.setString(2, value);</span>
<span class="fc" id="L295">					psInsert.setTimestamp(3, new java.sql.Timestamp(Tools.getNow()));</span>
<span class="fc" id="L296">					psInsert.execute();</span>
<span class="fc" id="L297">					psInsert.close();</span>
<span class="fc" id="L298">					psInsert = null;</span>
				}
<span class="fc" id="L300">				ret = true;</span>
				//refreshni hodnotu v Constants, odporucany je ale aj tak restart

<span class="fc" id="L303">				db_conn.close();</span>
<span class="fc" id="L304">				db_conn = null;</span>
			}
<span class="fc" id="L306">			setConstantValueImpl(name, value);</span>

<span class="pc bpc" id="L308" title="1 of 2 branches missed.">			if (conf != null) (new WebjetEvent&lt;ConfDetails&gt;(conf, WebjetEventType.AFTER_SAVE)).publishEvent();</span>
		}
<span class="nc" id="L310">		catch (Exception ex)</span>
		{
<span class="nc" id="L312">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">				if (psInsert != null)</span>
<span class="nc" id="L319">					psInsert.close();</span>
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L321">					db_conn.close();</span>
			}
<span class="nc" id="L323">			catch (Exception ex2)</span>
			{
<span class="fc" id="L325">			}</span>
		}
<span class="fc" id="L327">		return ret;</span>
	}

	private static void setConstantValueImpl(String name, String valueParam)
	{
<span class="fc bfc" id="L332" title="All 2 branches covered.">		if (valueParam == null) return;</span>
<span class="fc" id="L333">		String value = tryDecrypt(valueParam);</span>

<span class="pc bpc" id="L335" title="1 of 2 branches missed.">		if (&quot;linkType&quot;.equals(name))</span>
		{
<span class="nc bnc" id="L337" title="All 2 branches missed.">			if (&quot;html&quot;.equalsIgnoreCase(value))</span>
			{
<span class="nc" id="L339">				Constants.setInt(name, Constants.LINK_TYPE_HTML);</span>
			}
			else
			{
<span class="nc" id="L343">				Constants.setInt(name, Constants.LINK_TYPE_DOCID);</span>
			}
		}
		else
		{
<span class="pc bpc" id="L348" title="1 of 2 branches missed.">			if (&quot;statLanguageDomain&quot;.equals(name)) StatDB.setLanguageDomainTable(null);</span>
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">			else if (name.startsWith(&quot;multiDomainAlias:&quot;)) MultiDomainFilter.clearDomainAlias();</span>
<span class="fc bfc" id="L350" title="All 2 branches covered.">			else if (&quot;logLevel&quot;.equals(name)) Logger.setWJLogLevel(value);</span>
<span class="fc bfc" id="L351" title="All 2 branches covered.">			else if (&quot;logLevels&quot;.equals(name)) Logger.setWJLogLevels(Logger.getLogLevelsMap(value));</span>
<span class="pc bpc" id="L352" title="2 of 4 branches missed.">			else if (&quot;cacheStaticContentSeconds&quot;.equals(name) || &quot;cacheStaticContentSuffixes&quot;.equals(name)) PathFilter.resetCacheStaticContentSeconds();</span>
<span class="pc bpc" id="L353" title="1 of 2 branches missed.">			else if (&quot;responseHeaders&quot;.equals(name)) PathFilter.resetResponseHeaders();</span>
<span class="pc bpc" id="L354" title="1 of 2 branches missed.">			else if (&quot;constantsAliasSearch&quot;.equals(name)) Constants.setConstantsAliasSearch(&quot;true&quot;.equals(value));</span>
<span class="pc bpc" id="L355" title="1 of 2 branches missed.">			else if (&quot;multiDomainFolders&quot;.equals(name)) MultiDomainFilter.clearDomainFolders();</span>
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">			else if (&quot;xssHtmlAllowedFields&quot;.equals(name)) DB.resetHtmlAllowedFields();</span>
<span class="pc bpc" id="L357" title="1 of 2 branches missed.">			else if (&quot;ninjaNbspReplaceRegex&quot;.equals(name)) Ninja.resetNbspReplaceRegex();</span>
<span class="fc" id="L358">			Constants.setString(name, value);</span>
		}
<span class="fc" id="L360">	}</span>

	/**
	 * Zadisabluje polozku menu vsetkym administratorom
	 *
	 * @param menuItemName
	 * @return
	 */
	public static List&lt;UserDetails&gt; disableMenuItemAll(String menuItemName)
	{
<span class="nc" id="L370">		List&lt;UserDetails&gt; users = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L371">		List&lt;UserDetails&gt; changedUsers = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">		if(Tools.isEmpty(menuItemName)) return changedUsers;</span>
<span class="nc" id="L373">		Connection db_conn = null;</span>
<span class="nc" id="L374">		PreparedStatement ps = null;</span>
<span class="nc" id="L375">		ResultSet rs = null;</span>
		try
		{
			//nacitaj data z DB
<span class="nc" id="L379">			db_conn = DBPool.getConnection();</span>

<span class="nc" id="L381">			ps = db_conn.prepareStatement(&quot;SELECT * FROM  users WHERE is_admin=?&quot;); //NOSONAR</span>
<span class="nc" id="L382">			ps.setBoolean(1, true);</span>
<span class="nc" id="L383">			rs = ps.executeQuery();</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L386">				UserDetails user = new UserDetails();</span>
<span class="nc" id="L387">				user.setUserId(rs.getInt(&quot;user_id&quot;));</span>
<span class="nc" id="L388">				user.setFirstName(DB.getDbString(rs, &quot;first_name&quot;));</span>
<span class="nc" id="L389">				user.setLastName(DB.getDbString(rs, &quot;last_name&quot;));</span>
<span class="nc" id="L390">				users.add(user);</span>
<span class="nc" id="L391">			}</span>
<span class="nc" id="L392">			rs.close();</span>
<span class="nc" id="L393">			ps.close();</span>
<span class="nc" id="L394">			rs = null;</span>
<span class="nc" id="L395">			ps = null;</span>
			//preiteruj cez userov a zrus im danu polozku
			boolean found;
<span class="nc bnc" id="L398" title="All 2 branches missed.">			for (UserDetails user : users)</span>
			{
<span class="nc" id="L400">				ps = db_conn.prepareStatement(&quot;SELECT * FROM user_disabled_items WHERE user_id=? AND item_name=?&quot;); //NOSONAR</span>
<span class="nc" id="L401">				ps.setInt(1, user.getUserId());</span>
<span class="nc" id="L402">				ps.setString(2, menuItemName); //NOSONAR</span>
<span class="nc" id="L403">				rs = ps.executeQuery();</span>
<span class="nc" id="L404">				found = false;</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">				if (rs.next())</span>
				{
<span class="nc" id="L407">					found = true;</span>
				}
<span class="nc" id="L409">				rs.close();</span>
<span class="nc" id="L410">				ps.close();</span>
<span class="nc" id="L411">				rs = null;</span>
<span class="nc" id="L412">				ps = null;</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">				if (!found)</span>
				{
<span class="nc" id="L415">					ps = db_conn.prepareStatement(&quot;INSERT INTO user_disabled_items (user_id, item_name) VALUES (?, ?)&quot;); //NOSONAR</span>
<span class="nc" id="L416">					ps.setInt(1, user.getUserId());</span>
<span class="nc" id="L417">					ps.setString(2, menuItemName); //NOSONAR</span>
<span class="nc" id="L418">					ps.execute();</span>
<span class="nc" id="L419">					ps.close();</span>
<span class="nc" id="L420">					ps = null;</span>
<span class="nc" id="L421">					changedUsers.add(user);</span>
				}
<span class="nc" id="L423">			}</span>
<span class="nc" id="L424">			db_conn.close();</span>
<span class="nc" id="L425">			db_conn = null;</span>
		}
<span class="nc" id="L427">		catch (Exception ex)</span>
		{
<span class="nc" id="L429">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L435" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L436">					rs.close();</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L438">					ps.close();</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L440">					db_conn.close();</span>
			}
<span class="nc" id="L442">			catch (Exception ex2)</span>
			{
<span class="nc" id="L444">			}</span>
		}
<span class="nc" id="L446">		return (changedUsers);</span>
	}

	/**
	 * Ziskam si premennu z DB
	 *
	 * @param name -
	 *           nazov premennej
	 * @return
	 */
	public static ConfDetails getVariable(String name)
	{
<span class="fc" id="L458">		Connection db_conn = null;</span>
<span class="fc" id="L459">		PreparedStatement ps = null;</span>
<span class="fc" id="L460">		ResultSet rs = null;</span>
		try
		{
<span class="pc bpc" id="L463" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(name))</span>
			{
				//nacitaj data z DB (uncomited je tu kvoli clustru a MonitoringManager citaniu session hodnot)
<span class="fc" id="L466">				db_conn = DBPool.getConnectionReadUncommited();</span>
<span class="fc" id="L467">				ps = db_conn.prepareStatement(&quot;SELECT * FROM &quot; + ConfDB.CONF_TABLE_NAME + &quot; WHERE name=?&quot;);</span>
<span class="fc" id="L468">				ps.setString(1, name);</span>
<span class="fc" id="L469">				rs = ps.executeQuery();</span>
				String value;
<span class="fc" id="L471">				ConfDetails cDet = null;</span>
<span class="fc bfc" id="L472" title="All 2 branches covered.">				if (rs.next())</span>
				{
<span class="fc" id="L474">					value = DB.getDbString(rs, &quot;value&quot;);</span>
<span class="fc" id="L475">					cDet = new ConfDetails(name, value, DB.getDate(rs, &quot;date_changed&quot;));</span>
				}
<span class="fc" id="L477">				rs.close();</span>
<span class="fc" id="L478">				ps.close();</span>
<span class="fc" id="L479">				db_conn.close();</span>
<span class="fc" id="L480">				rs = null;</span>
<span class="fc" id="L481">				ps = null;</span>
<span class="fc" id="L482">				db_conn = null;</span>
<span class="fc" id="L483">				return (cDet);</span>
				//  Logger.println(this,&quot;Name= &quot; +varName+ &quot;\t\t Value= &quot; +varValue+
				// &quot;\t\t Action= &quot; +varAction);
			}
		}
<span class="nc" id="L488">		catch (Exception ex)</span>
		{
<span class="nc" id="L490">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L496" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L497">					rs.close();</span>
<span class="pc bpc" id="L498" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L499">					ps.close();</span>
<span class="pc bpc" id="L500" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L501">					db_conn.close();</span>
			}
<span class="nc" id="L503">			catch (Exception ex2)</span>
			{
<span class="fc" id="L505">			}</span>
		}
<span class="nc" id="L507">		return (null);</span>
	}

	/**
	 * Vrati zoznam moznych konfiguracnych premennych pre zadanu JSP stranku (pouziva pomocnik)
	 * @param url
	 * @return
	 */
	public static List&lt;ConfDetails&gt; getConfForJsp(String url)
	{
<span class="nc" id="L517">		List&lt;ConfDetails&gt; list = new ArrayList&lt;&gt;();</span>
		try
		{
			//najskor uprav URL na nazov modulu
<span class="nc" id="L521">			int i = url.lastIndexOf('/');</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">			if (i != -1) url = url.substring(i+1);</span>

<span class="nc" id="L524">			i = url.lastIndexOf('.');</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">			if (i != -1) url = url.substring(0, i);</span>

<span class="nc bnc" id="L527" title="All 2 branches missed.">			if (&quot;banner_system&quot;.equals(url)) url = &quot;banner&quot;;</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">			else if (&quot;forms&quot;.equals(url)) url = &quot;form&quot;;</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">			else if (&quot;related_pages&quot;.equals(url)) url = &quot;related-pages&quot;;</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">			else if (&quot;dynamic_tags&quot;.equals(url)) url = &quot;webpages&quot;;</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">			else if (&quot;reservations&quot;.equals(url)) url = &quot;reservation&quot;;</span>

<span class="nc" id="L533">			Logger.debug(ConfDB.class, &quot;getConfForJsp url = &quot;+url);</span>

<span class="nc bnc" id="L535" title="All 2 branches missed.">			for (ConfDetails conf : Constants.getAllValues())</span>
			{
<span class="nc bnc" id="L537" title="All 6 branches missed.">				if (conf.getModules()!=null &amp;&amp; (conf.getModules().indexOf(url)==0 || conf.getModules().indexOf(&quot;;&quot;+url)!=-1)) list.add(conf);</span>
<span class="nc" id="L538">			}</span>
		}
<span class="nc" id="L540">		catch (Exception e)</span>
		{
<span class="nc" id="L542">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L543">		}</span>
<span class="nc" id="L544">		return list;</span>
	}

	/**
	 * Vyhladavanie v konfiguracii (meno a popis)
	 * @param text
	 * @return
	 */
	public static List&lt;ConfDetails&gt; searchConfig(String text)
	{
<span class="nc" id="L554">		text = DB.internationalToEnglish(text).toLowerCase();</span>
<span class="nc" id="L555">		List&lt;ConfDetails&gt; list = new ArrayList&lt;&gt;();</span>
		try
		{
<span class="nc bnc" id="L558" title="All 2 branches missed.">			for (ConfDetails conf : Constants.getAllValues())</span>
			{
<span class="nc bnc" id="L560" title="All 4 branches missed.">				if (conf.getName().toLowerCase().indexOf(text)!=-1 || DB.internationalToEnglish(conf.getDescription()).toLowerCase().indexOf(text)!=-1)</span>
				{
<span class="nc" id="L562">					list.add(conf);</span>
				}
<span class="nc" id="L564">			}</span>
		}
<span class="nc" id="L566">		catch (Exception e)</span>
		{
<span class="nc" id="L568">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L569">		}</span>
<span class="nc" id="L570">		return list;</span>
	}

    /**
     * Obnovi v Constants konfiguracnu premmenu podla hodnoty v databaze
     * @param name
     */
    public static void refreshVariable(String name)
	 {
<span class="fc" id="L579">	 	 String value = new SimpleQuery().forString(&quot;SELECT value FROM &quot; + ConfDB.CONF_TABLE_NAME + &quot; WHERE name=?&quot;,name);</span>
<span class="fc bfc" id="L580" title="All 2 branches covered.">		 if (value == null) {</span>
<span class="fc" id="L581">			int count = new SimpleQuery().forInt(&quot;SELECT COUNT(*) FROM &quot; + ConfDB.CONF_TABLE_NAME + &quot; WHERE name=?&quot;,name);</span>
<span class="pc bpc" id="L582" title="1 of 2 branches missed.">			if (count &gt; 0) {</span>
				//ak je v DB ale hodnota je null tak ju nastavime na prazdny retazec
<span class="nc" id="L584">				value = &quot;&quot;;</span>
			}
		 }
<span class="fc" id="L587">		 setConstantValueImpl(name, value);</span>
<span class="fc" id="L588">    }</span>

	private static String cleanTextRemoveNonPrintableCharacters(String text)
	{
		// strips off all non-ASCII characters
<span class="fc" id="L593">		text = text.replaceAll(&quot;[^\\x00-\\x7F]&quot;, &quot;&quot;);</span>

		// erases all the ASCII control characters
<span class="fc" id="L596">		text = text.replaceAll(&quot;[\\p{Cntrl}&amp;&amp;[^\r\n\t]]&quot;, &quot;&quot;);</span>

		// removes non-printable characters from Unicode
<span class="fc" id="L599">		text = text.replaceAll(&quot;\\p{C}&quot;, &quot; &quot;);</span>

<span class="fc" id="L601">		text = Tools.replace(text, &quot;'&quot;, &quot;&quot;);</span>
<span class="fc" id="L602">		text = Tools.replace(text, &quot; &quot;, &quot;&quot;);</span>

<span class="fc" id="L604">		return text.trim();</span>
	}

    public static boolean setNamePrepared(String name, String value, Date datePrepared)
 	{
<span class="fc bfc" id="L609" title="All 2 branches covered.">		if (isOnlyLocalConfig(name)) return true;</span>

<span class="fc" id="L611">		boolean ret = false;</span>
<span class="fc" id="L612"> 		Connection db_conn = null;</span>
<span class="fc" id="L613"> 		PreparedStatement psInsert = null;</span>
 		try
 		{
 			//nacitaj data z DB
<span class="fc" id="L617"> 			db_conn = DBPool.getConnection();</span>
 			//editacia DB _conf_
<span class="pc bpc" id="L619" title="2 of 4 branches missed."> 			if (name != null &amp;&amp; value != null)</span>
 			{
 				/*String sqlUpdate = &quot;UPDATE &quot; + ConfDB.CONF_PREPARED_TABLE_NAME + &quot; SET value=?, date_changed=?, date_prepared=? WHERE name=?&quot;;
 				if (SetCharacterEncodingFilter.getCurrentRequestBean() != null &amp;&amp;
 					SetCharacterEncodingFilter.getCurrentRequestBean().getUserId() &gt; 0)
 				{
 					StringBuilder message = new StringBuilder(&quot;Nastavena konfiguracna premenna: &quot;).append(name).append('\n');
 					if (Tools.isNotEmpty(Constants.getString(name)))
 						message.append(Constants.getString(name)).append(&quot; =&gt; &quot;);
 					message.append(value);
 					//Adminlog.add(Adminlog.TYPE_CONF_UPDATE, message.toString(), -1, -1);
 				}
 				psInsert = db_conn.prepareStatement(sqlUpdate);
 				psInsert.setString(1, value);
 				psInsert.setTimestamp(2, new java.sql.Timestamp(Tools.getNow()));

 				if (datePrepared!=null) psInsert.setTimestamp(4, new java.sql.Timestamp(datePrepared.getTime()));
				else psInsert.setNull(4, Types.TIMESTAMP);

				psInsert.setString(3, name);

 				int update = psInsert.executeUpdate();
 				psInsert.close();
 				psInsert = null;

 				*/
<span class="fc" id="L645">				Integer userId = null;</span>

<span class="fc" id="L647">				RequestBean rb = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="pc bpc" id="L648" title="1 of 2 branches missed.">				if (rb != null) userId = Integer.valueOf(rb.getUserId());</span>

<span class="fc" id="L650">				String sqlIns = &quot;INSERT INTO &quot; + ConfDB.CONF_PREPARED_TABLE_NAME + &quot; (name, value, date_changed, date_prepared, user_id) VALUES (?,?,?,?,?)&quot;;</span>
<span class="fc" id="L651">				psInsert = db_conn.prepareStatement(sqlIns);</span>
<span class="fc" id="L652">				psInsert.setString(1, name);</span>
<span class="fc" id="L653">				psInsert.setString(2, value);</span>
<span class="fc" id="L654">				psInsert.setTimestamp(3, new java.sql.Timestamp(Tools.getNow()));</span>

<span class="pc bpc" id="L656" title="1 of 2 branches missed.">				if (datePrepared!=null) psInsert.setTimestamp(4, new java.sql.Timestamp(datePrepared.getTime()));</span>
<span class="fc" id="L657">				else psInsert.setNull(4, Types.TIMESTAMP);</span>

<span class="pc bpc" id="L659" title="1 of 2 branches missed.">				if (userId != null) psInsert.setInt(5, userId.intValue());</span>
<span class="nc" id="L660">				else psInsert.setNull(5, Types.INTEGER);</span>

<span class="fc" id="L662">				psInsert.execute();</span>
<span class="fc" id="L663">				psInsert.close();</span>
<span class="fc" id="L664">				psInsert = null;</span>
<span class="fc" id="L665"> 				ret = true;</span>
 			}
<span class="fc" id="L667"> 			db_conn.close();</span>
<span class="fc" id="L668"> 			db_conn = null;</span>
 		}
<span class="nc" id="L670"> 		catch (Exception ex)</span>
 		{
<span class="nc" id="L672"> 			sk.iway.iwcm.Logger.error(ex);</span>
 		}
 		finally
 		{
 			try
 			{
<span class="pc bpc" id="L678" title="1 of 2 branches missed."> 				if (psInsert != null)</span>
<span class="nc" id="L679"> 					psInsert.close();</span>
<span class="pc bpc" id="L680" title="1 of 2 branches missed."> 				if (db_conn != null)</span>
<span class="nc" id="L681"> 					db_conn.close();</span>
 			}
<span class="nc" id="L683"> 			catch (Exception ex2)</span>
 			{
<span class="fc" id="L685"> 			}</span>
 		}
<span class="fc" id="L687"> 		return ret;</span>
 	}

 	public static boolean deleteNamePrepared(String name, long now)
 	{
<span class="nc" id="L692"> 		Connection db_conn = null;</span>
<span class="nc" id="L693"> 		PreparedStatement psDelete = null;</span>
 		try
 		{
<span class="nc" id="L696"> 			String sqlDel = &quot;&quot;;</span>
<span class="nc bnc" id="L697" title="All 2 branches missed."> 			if (name != null)</span>
 			{
<span class="nc" id="L699"> 				db_conn = DBPool.getConnection();</span>
<span class="nc" id="L700"> 				sqlDel = &quot;UPDATE &quot; + ConfDB.CONF_PREPARED_TABLE_NAME + &quot; SET date_published=? WHERE name=? AND date_published IS NULL AND date_prepared IS NOT NULL AND date_prepared &lt; ?&quot;;</span>
<span class="nc" id="L701"> 				psDelete = db_conn.prepareStatement(sqlDel);</span>
<span class="nc" id="L702">				psDelete.setTimestamp(1, new Timestamp(Tools.getNow()));</span>
<span class="nc" id="L703"> 				psDelete.setString(2, name);</span>
<span class="nc" id="L704">				psDelete.setTimestamp(3, new Timestamp(now));</span>
<span class="nc" id="L705"> 				psDelete.execute();</span>
<span class="nc" id="L706"> 				psDelete.close();</span>
<span class="nc" id="L707"> 				db_conn.close();</span>
<span class="nc" id="L708"> 				psDelete = null;</span>
<span class="nc" id="L709"> 				db_conn = null;</span>
 				//Adminlog.add(Adminlog.TYPE_CONF_DELETE, &quot;Zmazana prepared konfiguracna premenna: &quot;+name, -1, -1);
<span class="nc" id="L711"> 				return true;</span>
 			}
 		}
<span class="nc" id="L714"> 		catch (Exception ex)</span>
 		{
<span class="nc" id="L716"> 			sk.iway.iwcm.Logger.error(ex);</span>
 		}
 		finally
 		{
 			try
 			{
<span class="nc bnc" id="L722" title="All 2 branches missed."> 				if (psDelete != null)</span>
<span class="nc" id="L723"> 					psDelete.close();</span>
<span class="nc bnc" id="L724" title="All 2 branches missed."> 				if (db_conn != null)</span>
<span class="nc" id="L725"> 					db_conn.close();</span>
 			}
<span class="nc" id="L727"> 			catch (Exception ex2)</span>
 			{
<span class="nc" id="L729"> 			}</span>
 		}
<span class="nc" id="L731"> 		return false;</span>
 	}

	/**
	 * Vrati predpripravenu konfiguracne hodnotu, ak prefix nie je null tak zacinajuce sa na hodnotu prefixu
	 * @param prefix
	 * @return
	 */
	public static List&lt;ConfPreparedDetails&gt; getConfigPrepared(String prefix)
	{
<span class="nc" id="L741">		List&lt;ConfPreparedDetails&gt; conf = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L742">		Connection db_conn = null;</span>
<span class="nc" id="L743">		PreparedStatement ps = null;</span>
<span class="nc" id="L744">		ResultSet rs = null;</span>
		try
		{
			//nacitaj data z DB
<span class="nc" id="L748">			db_conn = DBPool.getConnection();</span>
<span class="nc" id="L749">			ps = db_conn.prepareStatement(&quot;SELECT * FROM &quot; + ConfDB.CONF_PREPARED_TABLE_NAME + &quot; ORDER BY name&quot;);</span>
<span class="nc" id="L750">			rs = ps.executeQuery();</span>
			String value;
			String name;
<span class="nc bnc" id="L753" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L755">				name = DB.getDbString(rs, &quot;name&quot;);</span>
<span class="nc" id="L756">				value = DB.getDbString(rs, &quot;value&quot;);</span>

<span class="nc bnc" id="L758" title="All 4 branches missed.">				if (Tools.isEmpty(prefix) || name.startsWith(prefix))</span>
				{
<span class="nc" id="L760">					conf.add(new ConfPreparedDetails(name, value, DB.getDate(rs, &quot;date_changed&quot;), DB.getDate(rs, &quot;date_prepared&quot;)));</span>
				}
			}
<span class="nc" id="L763">			rs.close();</span>
<span class="nc" id="L764">			ps.close();</span>
<span class="nc" id="L765">			db_conn.close();</span>
<span class="nc" id="L766">			rs = null;</span>
<span class="nc" id="L767">			ps = null;</span>
<span class="nc" id="L768">			db_conn = null;</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">			if (conf.size() &gt; 0)</span>
<span class="nc" id="L770">				return (conf);</span>
			//  Logger.println(this,&quot;Name= &quot; +varName+ &quot;\t\t Value= &quot; +varValue+
			// &quot;\t\t Action= &quot; +varAction);
		}
<span class="nc" id="L774">		catch (Exception ex)</span>
		{
<span class="nc" id="L776">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L782" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L783">					rs.close();</span>
<span class="nc bnc" id="L784" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L785">					ps.close();</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L787">					db_conn.close();</span>
			}
<span class="nc" id="L789">			catch (Exception ex2)</span>
			{
<span class="nc" id="L791">			}</span>
		}
<span class="nc" id="L793">		return (null);</span>
	}

	/**
	 * Check if name is localOnly - not saved to DB and synchronized across cluster
	 * @param name - conf. name
	 * @return
	 */
	public static boolean isOnlyLocalConfig(String name)
	{
<span class="fc bfc" id="L803" title="All 2 branches covered.">		if (&quot;licenseExpiryDate&quot;.equals(name)) return true;</span>
<span class="fc" id="L804">		return false;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>