<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ForumGroupService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.components.forum.rest</a> &gt; <span class="el_source">ForumGroupService.java</span></div><h1>ForumGroupService.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.components.forum.rest;

import java.util.Arrays;
import java.util.Calendar;
import java.util.Date;
import java.util.Optional;

import sk.iway.iwcm.Tools;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.components.forum.jpa.DocForumEntity;
import sk.iway.iwcm.components.forum.jpa.ForumGroupEntity;
import sk.iway.iwcm.components.forum.jpa.ForumGroupRepository;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.doc.DocDB;
import sk.iway.iwcm.doc.DocDetails;
import sk.iway.iwcm.doc.TemplateDetails;
import sk.iway.iwcm.doc.TemplatesDB;
import sk.iway.iwcm.i18n.Prop;

<span class="nc" id="L20">public class ForumGroupService {</span>

    private static final String userGroupsDelimiter = &quot;+&quot;;

    private static boolean dataHasForumText(String data)  {
<span class="pc bpc" id="L25" title="2 of 4 branches missed.">        if (data.indexOf(&quot;/forum/forum_mb&quot;)!=-1 || data.indexOf(&quot;forum_mb.jsp&quot;)!=-1)</span>
<span class="nc bnc" id="L26" title="All 6 branches missed.">			if (data.indexOf(&quot;type=topics&quot;) != -1 || data.indexOf(&quot;rootGroup=&quot;) != -1 || data.indexOf(&quot;bbRootGroupId=&quot;) != -1)</span>
<span class="nc" id="L27">				return(true);</span>

<span class="nc bnc" id="L29" title="All 2 branches missed.">		else if (data.indexOf(&quot;/forum/forum&quot;)!=-1)</span>
<span class="nc bnc" id="L30" title="All 4 branches missed.">			if (data.indexOf(&quot;type=topics&quot;) != -1 || data.indexOf(&quot;bbRootGroupId=&quot;) != -1)</span>
<span class="nc" id="L31">				return(true);</span>

<span class="fc" id="L33">		return(false);</span>
    }

    public static boolean isMessageBoard(DocDetails doc, TemplateDetails temp) {
<span class="pc bpc" id="L37" title="1 of 2 branches missed.">        if( dataHasForumText(doc.getData()) ) return true;</span>
<span class="pc bpc" id="L38" title="1 of 2 branches missed.">        if( dataHasForumText(temp.getHeaderDocData()) ) return true;</span>
<span class="pc bpc" id="L39" title="1 of 2 branches missed.">        if( dataHasForumText(temp.getFooterDocData()) ) return true;</span>
<span class="pc bpc" id="L40" title="1 of 2 branches missed.">        if( dataHasForumText(temp.getMenuDocData()) ) return true;</span>
<span class="pc bpc" id="L41" title="1 of 2 branches missed.">        if( dataHasForumText(temp.getRightMenuDocData()) ) return true;</span>
<span class="pc bpc" id="L42" title="1 of 2 branches missed.">        if( dataHasForumText(temp.getObjectADocData()) ) return true;</span>
<span class="pc bpc" id="L43" title="1 of 2 branches missed.">		if( dataHasForumText(temp.getObjectBDocData()) ) return true;</span>
<span class="pc bpc" id="L44" title="1 of 2 branches missed.">        if( dataHasForumText(temp.getObjectCDocData()) ) return true;</span>
<span class="pc bpc" id="L45" title="1 of 2 branches missed.">        if( dataHasForumText(temp.getObjectDDocData()) ) return true;</span>

<span class="fc" id="L47">        return false;</span>
    }

    public static void prepareForumGroup(DocForumEntity docForumEntity) {
        //Value check
<span class="fc" id="L52">        Integer docId = docForumEntity.getDocId();</span>
<span class="pc bpc" id="L53" title="2 of 4 branches missed.">        if(docForumEntity == null || docId &lt; 1) return;</span>

<span class="fc" id="L55">        Prop prop = Prop.getInstance();</span>
<span class="fc" id="L56">		ForumGroupRepository forumGroupRepository = Tools.getSpringBean(&quot;forumGroupRepository&quot;, ForumGroupRepository.class);</span>
<span class="fc" id="L57">		Optional&lt;ForumGroupEntity&gt; forumGroupEntityOpt = forumGroupRepository.findFirstByDocIdOrderById(docId);</span>

        ForumGroupEntity forumGroupEntity;
<span class="fc bfc" id="L60" title="All 2 branches covered.">		if(forumGroupEntityOpt.isPresent())</span>
<span class="fc" id="L61">			forumGroupEntity = forumGroupEntityOpt.get();</span>
		else {
<span class="fc" id="L63">			forumGroupEntity = new ForumGroupEntity();</span>
<span class="fc" id="L64">            forumGroupEntity.setDocId(docId);</span>
<span class="fc" id="L65">            forumGroupEntity.setActive(true);</span>
<span class="fc" id="L66">            forumGroupEntity.setHoursAfterLastMessage(0);</span>

            //Find out, if this is message board
<span class="fc" id="L69">            DocDetails doc = DocDB.getInstance().getDoc(docId);</span>
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">            if(doc != null) {</span>
<span class="fc" id="L71">                TemplatesDB tempDB = TemplatesDB.getInstance();</span>
<span class="fc" id="L72">				TemplateDetails temp = tempDB.getTemplate(doc.getTempId());</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">				if (temp == null)</span>
<span class="nc" id="L74">					temp = new TemplateDetails();</span>

<span class="fc" id="L76">				forumGroupEntity.setMessageBoard( isMessageBoard(doc, temp) );</span>
            }
		}

        //
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">		if(forumGroupEntity.getActive()) forumGroupEntity.setForumStatus( prop.getText(&quot;components.forum.status_true&quot;) );</span>
<span class="nc" id="L82">		else forumGroupEntity.setForumStatus( prop.getText(&quot;components.forum.status_false&quot;));</span>

		//
<span class="fc bfc" id="L85" title="All 2 branches covered.">		if(Boolean.TRUE.equals(forumGroupEntity.getMessageBoard())) {</span>
<span class="fc" id="L86">            forumGroupEntity.setForumType( prop.getText(&quot;components.forum.admin.forumType.mb&quot;) );</span>

            //Take string of id's adminGroups
            // -&gt; convert it to int[] (using Tools.getTokensInt)
            // -&gt; this array convert to Integer[] and save into adminPerms (using Arrays.stream)
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">            if(!Tools.isEmpty( forumGroupEntity.getAdminGroups() ))</span>
<span class="nc" id="L92">                forumGroupEntity.setAdminPerms(</span>
<span class="nc" id="L93">                    Arrays.stream(</span>
<span class="nc" id="L94">                        Tools.getTokensInt( forumGroupEntity.getAdminGroups(), userGroupsDelimiter)</span>
<span class="nc" id="L95">                    ).boxed().toArray( Integer[]::new )</span>
                );
<span class="fc" id="L97">        } else forumGroupEntity.setForumType( prop.getText(&quot;components.forum.admin.forumType.simple&quot;) );</span>

        //Take string of id's addmessageGroups
		// -&gt; convert it to int[] (using Tools.getTokensInt)
		// -&gt; this array convert to Integer[] and save into addMessagePerms (using Arrays.stream)
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">		if(!Tools.isEmpty( forumGroupEntity.getAddmessageGroups() ))</span>
<span class="nc" id="L103">			forumGroupEntity.setAddMessagePerms(</span>
<span class="nc" id="L104">				Arrays.stream(</span>
<span class="nc" id="L105">					Tools.getTokensInt( forumGroupEntity.getAddmessageGroups(), userGroupsDelimiter)</span>
<span class="nc" id="L106">				).boxed().toArray( Integer[]::new )</span>
			);

<span class="fc" id="L109">        docForumEntity.setForumGroupEntity(forumGroupEntity);</span>
<span class="fc" id="L110">    }</span>

    public static void saveForum(ForumGroupEntity entityToSave) {
<span class="fc" id="L113">        ForumGroupRepository forumGroupRepository = Tools.getSpringBean(&quot;forumGroupRepository&quot;, ForumGroupRepository.class);</span>

        /* Convert selected user groups to string */

        //!! only message board can select admin users
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">        if(entityToSave.getMessageBoard()) {</span>
<span class="nc" id="L119">            String adminPermsString = &quot;&quot;;</span>
<span class="nc" id="L120">            Boolean first = true;</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">            for(Integer userGroupId : entityToSave.getAdminPerms()) {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">                if(first) {</span>
<span class="nc" id="L123">                    first = false;</span>
<span class="nc" id="L124">                    adminPermsString += userGroupId;</span>
<span class="nc" id="L125">                } else adminPermsString += &quot;+&quot; + userGroupId;</span>
            }

            //Set this string into entity
<span class="nc" id="L129">            entityToSave.setAdminGroups(adminPermsString);</span>
<span class="nc" id="L130">        } else {</span>
            //This params can be set if forum type != message board
<span class="fc" id="L132">            entityToSave.setAdminGroups(null);</span>
<span class="fc" id="L133">            entityToSave.setAdvertisementType(false);</span>
        }

        //Both types can set add message perms
<span class="fc" id="L137">        Boolean first = true;</span>
<span class="fc" id="L138">        String addMessagePermsString = &quot;&quot;;</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">        for(Integer userGroupId : entityToSave.getAddMessagePerms()) {</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">            if(first) {</span>
<span class="fc" id="L141">                first = false;</span>
<span class="fc" id="L142">                addMessagePermsString += userGroupId;</span>
<span class="nc" id="L143">            } else addMessagePermsString += &quot;+&quot; + userGroupId;</span>
        }

        //Set this string into entity
<span class="fc" id="L147">        entityToSave.setAddmessageGroups(addMessagePermsString);</span>

        // &quot;null&quot; string fix !!
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">        if(&quot;null&quot;.equals(entityToSave.getAdminGroups())) entityToSave.setAdminGroups(&quot;&quot;);</span>
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">        if(&quot;null&quot;.equals(entityToSave.getAddmessageGroups())) entityToSave.setAddmessageGroups(&quot;&quot;);</span>

        //Set domainId !
<span class="fc" id="L154">        entityToSave.setDomainId( CloudToolsForCore.getDomainId() );</span>

        //Save this entity
<span class="fc" id="L157">        forumGroupRepository.save(entityToSave);</span>

        //If it's new entity, set generated ID from DB
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">        if(entityToSave.getId() &lt; 1)</span>
<span class="nc" id="L161">            entityToSave.setId(</span>
<span class="nc" id="L162">                Long.valueOf(</span>
<span class="nc" id="L163">                    new SimpleQuery().forInt(&quot;SELECT max(id) FROM forum WHERE doc_id = ?&quot; + CloudToolsForCore.getDomainIdSqlWhere(true), entityToSave.getDocId())</span>
                )
            );
<span class="fc" id="L166">    }</span>

	public static ForumGroupEntity getForum(int docId, boolean returnNull) {
<span class="fc" id="L169">        ForumGroupRepository forumGroupRepository = Tools.getSpringBean(&quot;forumGroupRepository&quot;, ForumGroupRepository.class);</span>

		//Forum group aka FORUM
<span class="fc" id="L172">		Optional&lt;ForumGroupEntity&gt; forum = forumGroupRepository.findFirstByDocIdOrderById(docId);</span>

		//Check if value is present
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">		if(forum.isPresent()) return forum.get();</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">		else if(!returnNull) {</span>
			//Value is null but we dont want null value -&gt; create default one
<span class="nc" id="L178">			ForumGroupEntity defaultForum = new ForumGroupEntity();</span>
<span class="nc" id="L179">			defaultForum.setMessageConfirmation(false);</span>
<span class="nc" id="L180">			defaultForum.setActive(true);</span>
<span class="nc" id="L181">            defaultForum.setAdminGroups(&quot;&quot;);</span>
<span class="nc" id="L182">            defaultForum.setAddmessageGroups(&quot;&quot;);</span>
<span class="nc" id="L183">			return defaultForum;</span>
		}

		//Return null
<span class="nc" id="L187">		return null;</span>
	}

    public static boolean isActive(int docId) {
<span class="fc" id="L191">        boolean ret = true;</span>

<span class="pc bpc" id="L193" title="1 of 2 branches missed.">        if (docId &gt; 0) {</span>
<span class="fc" id="L194">            ForumGroupEntity fge = getForum(docId, true);</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">            if (fge != null) {</span>
                //Check active param
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">                if (!fge.getActive()) ret = false;</span>

                //Check is we are NOW between FROM - TO range
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">                if(fge.getDateFrom() != null)</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">                    if(Tools.getNow() &lt;= fge.getDateFrom().getTime())</span>
<span class="nc" id="L202">                        ret = false;</span>

<span class="pc bpc" id="L204" title="1 of 2 branches missed.">                if(fge.getDateTo() != null)</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">                    if(Tools.getNow() &gt;= fge.getDateTo().getTime())</span>
<span class="nc" id="L206">                        ret = false;</span>

                //Now check, if forum have set HoursAfterLastMessage param
                //If yes, check that this amount of hour haven't passed since QuestionDate
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">                if(fge.getHoursAfterLastMessage() &gt; 0) {</span>
<span class="nc" id="L211">                    Date questionDate = (new SimpleQuery()).forDate(&quot;SELECT question_date FROM document_forum WHERE doc_id=? &quot; + CloudToolsForCore.getDomainIdSqlWhere(true) + &quot;ORDER BY question_date DESC&quot;, docId);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                    if(questionDate != null) {</span>
<span class="nc" id="L213">                        Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L214">                        cal.setTime(questionDate);</span>
<span class="nc" id="L215">                        cal.add(Calendar.HOUR_OF_DAY, fge.getHoursAfterLastMessage());</span>
                        //
<span class="nc bnc" id="L217" title="All 2 branches missed.">                        if (Tools.getNow() &lt; cal.getTimeInMillis()) ret = false;</span>
                    }
                }
            }
        }
<span class="fc" id="L222">        return ret;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>