<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MonitoringManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.system.monitoring</a> &gt; <span class="el_source">MonitoringManager.java</span></div><h1>MonitoringManager.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.system.monitoring;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import org.apache.commons.dbcp.ConfigurableDataSource;

import sk.iway.iwcm.Cache;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.stat.SessionHolder;
import sk.iway.iwcm.system.ConfDB;
import sk.iway.iwcm.system.ConfDetails;
import sk.iway.iwcm.system.cluster.ClusterDB;

/**
 * MonitoringManager.java - trieda sluziaca na pracu v module Monitoring servera, metody na pracu s databazou
 *	@Title        webjet4
 *	@Company      Interway s.r.o. (www.interway.sk)
 *	@Copyright    Interway s.r.o. (c) 2001-2008
 *	@author       $Author: jeeff $
 *	@version      $Revision: 1.4 $
 *	@created      Date: 11.06.2009 10:52:51
 *	@modified     $Date: 2009/11/20 12:40:57 $
 */

<span class="nc" id="L35">public class MonitoringManager</span>
{
	/**
	 * Metoda volana z crontabu kazdych 30s, zapisuje do tabulky monitoring jednotlive hodnoty stavu servera.
	 * Musi byt vsak povolena v konstante serverMonitoringEnable, ktora je prednastavena na false.
	 *
	 * @param args
	 */
	public static void main(String[] args)
	{
		try
		{
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">			if (Constants.getBoolean(&quot;serverMonitoringEnable&quot;))</span>
			{
<span class="pc bpc" id="L49" title="1 of 2 branches missed.">				if (MonitoringManager.saveSaveCurrentServerParameter())</span>
				{
					//Logger.debug(MonitoringManager.class,&quot;MonitoringManager.saveSaveCurrentServerParameter() - saving successful&quot;);
				}
				else
<span class="nc" id="L54">					Logger.debug(MonitoringManager.class,&quot;MonitoringManager.saveSaveCurrentServerParameter() - db error&quot;);</span>
			}

<span class="pc bpc" id="L57" title="2 of 4 branches missed.">			if(ClusterDB.isServerRunningInClusterMode() &amp;&amp; &quot;none&quot;.equals(Constants.getString(&quot;statMode&quot;))==false)</span>
			{
<span class="fc" id="L59">				countUsersOnAllNodes();</span>
			}
		}
<span class="nc" id="L62">		catch (Exception ex)</span>
		{
<span class="nc" id="L64">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L65">		}</span>
<span class="fc" id="L66">	}</span>

	private static void countUsersOnAllNodes()
	{
<span class="fc" id="L70">		String myClusterName = Constants.getString(&quot;clusterMyNodeName&quot;);</span>
<span class="fc" id="L71">		ConfDB.setName(&quot;statSessions-&quot;+myClusterName, Integer.toString(SessionHolder.getTotalSessionsPerNode()));</span>
<span class="fc" id="L72">		ConfDB.setName(&quot;statDistinctUsers-&quot;+myClusterName, Integer.toString(SessionHolder.getDistinctUsersCountPerNode()));</span>
<span class="fc" id="L73">		int totalDistinctUsers=0;</span>
<span class="fc" id="L74">		int totalSessions=0;</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">		for(String clusterName : ClusterDB.getClusterNodeNamesExpandedAuto())</span>
		{
<span class="fc" id="L77">			ConfDetails cd = ConfDB.getVariable(&quot;statDistinctUsers-&quot;+clusterName);</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">			if(cd!=null)</span>
<span class="fc" id="L79">				totalDistinctUsers = totalDistinctUsers + Tools.getIntValue(cd.getValue(), 0);</span>
<span class="fc" id="L80">			cd = ConfDB.getVariable(&quot;statSessions-&quot;+clusterName);</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">			if(cd!=null)</span>
<span class="fc" id="L82">				totalSessions = totalSessions + Tools.getIntValue(cd.getValue(), 0);</span>
<span class="fc" id="L83">		}</span>
<span class="fc" id="L84">		Constants.setInt(&quot;statSessionsAllNodes&quot;, totalSessions);</span>
<span class="fc" id="L85">		Constants.setInt(&quot;statDistinctUsersAllNodes&quot;, totalDistinctUsers);</span>
<span class="fc" id="L86">	}</span>

	/**
	 * Funkcia, ktora zapise do databazy jednotlive aktualne hodnoty servera zo stranky admin/mem.jsp
	 * @return					vrati true, ak zapis prebehol uspesne, inak false
	 */
	public static boolean saveSaveCurrentServerParameter()
	{
<span class="fc" id="L94">		int numActive = 0;</span>
<span class="fc" id="L95">		int numIdle = 0;</span>

		try
		{
<span class="fc" id="L99">			ConfigurableDataSource ds = (ConfigurableDataSource)DBPool.getInstance().getDataSource(&quot;iwcm&quot;);</span>
<span class="fc" id="L100">			numActive = ds.getNumActive();</span>
<span class="fc" id="L101">			numIdle = ds.getNumIdle();</span>
		}
<span class="nc" id="L103">		catch (Exception ex)</span>
		{
<span class="nc" id="L105">		    sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L106">		}</span>

		try{

<span class="fc" id="L110">			Runtime rt = Runtime.getRuntime();</span>

<span class="fc" id="L112">			String sql = &quot;INSERT INTO monitoring (date_insert, node_name, db_active, db_idle, mem_free, mem_total, cache, sessions, cpu_usage, process_usage) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;;</span>
<span class="fc" id="L113">			long free = rt.freeMemory();</span>
<span class="fc" id="L114">			long total = rt.totalMemory();</span>
<span class="fc" id="L115">			CpuInfo cpu = new CpuInfo();	//ak nie je monitoring cpu aktivny, nevytvorim ani instanciu triedy a do databazy zapisujem 0.0</span>
<span class="fc" id="L116">			int cpuUsage = cpu.getCpuUsage();</span>
<span class="fc" id="L117">			int cpuUsageProcess = cpu.getCpuUsageProcess();</span>
<span class="fc" id="L118">			Logger.debug(null, &quot;Vysledna cpuUsage: &quot;+ cpuUsage);</span>
<span class="fc" id="L119">			new SimpleQuery().execute(sql, new Timestamp(Tools.getNow()), Constants.getString(&quot;clusterMyNodeName&quot;),</span>
<span class="fc" id="L120">				numActive, numIdle, free, total, Cache.getInstance().getSize(), SessionHolder.getTotalSessionsPerNode(), cpuUsage, cpuUsageProcess);</span>
<span class="fc" id="L121">			return true;</span>
<span class="nc" id="L122">		} catch (Exception e) {</span>
<span class="nc" id="L123">			return false;</span>
		}
	}

	/**
 	 * Vyfiltruje a vrati maximalne max_rows zaznamov monitorovanych hodnot z tabulky monitoring vyfiltrovane podla zadanych datumov a nazvu clustra.
 	 *
 	 * @param filterDateFrom 	od ktoreho datumu sa maju vyselektovat rezervacie
 	 * @param filterDateTo 		do ktoreho datumu sa maju vyselektovat rezervacie
 	 * @param filterNodeName	nazov clustra, pre ktory boli zaznamenane hodnoty
 	 *
 	 * @return ArrayList 		naplneny Beanmi so zaznamenanymi monitorovacimi informaciami, ktore splnaju podmienky udane vstupnymi parametrami
 	 */
	public static List&lt;MonitoringBean&gt; getMonitoringStats(Date filterDateFrom, Date filterDateTo, String filterNodeName)
	{
<span class="nc" id="L138">		List&lt;MonitoringBean&gt; monitoringStats = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L140">		Connection db_conn = null;</span>
<span class="nc" id="L141">		PreparedStatement ps = null;</span>
<span class="nc" id="L142">		ResultSet rs = null;</span>

<span class="nc" id="L144">		StringBuilder sql = new StringBuilder(&quot;SELECT * FROM monitoring WHERE monitoring_id &gt; 0 &quot;);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">		if (filterDateFrom != null)</span>
<span class="nc" id="L146">			sql.append(&quot;AND date_insert &gt;= ? &quot;);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">		if (filterDateTo != null)</span>
<span class="nc" id="L148">			sql.append(&quot;AND date_insert &lt;= ? &quot;);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">		if (Tools.isNotEmpty(filterNodeName))</span>
<span class="nc" id="L150">			sql.append(&quot;AND node_name = ?&quot;);</span>

<span class="nc" id="L152">		sql.append(&quot;ORDER BY date_insert DESC&quot;);</span>

		try
		{
<span class="nc" id="L156">			db_conn = DBPool.getConnection();</span>
<span class="nc" id="L157">			ps = db_conn.prepareStatement(sql.toString());</span>

<span class="nc" id="L159">			int psIndex = 1;</span>

<span class="nc bnc" id="L161" title="All 2 branches missed.">			if (filterDateFrom != null)</span>
<span class="nc" id="L162">				ps.setTimestamp(psIndex++, new Timestamp(filterDateFrom.getTime()));</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">			if (filterDateTo != null)</span>
<span class="nc" id="L164">				ps.setTimestamp(psIndex++, new Timestamp(filterDateTo.getTime()));</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">			if (Tools.isNotEmpty(filterNodeName))</span>
<span class="nc" id="L166">				ps.setString(psIndex++, filterNodeName);</span>

<span class="nc" id="L168">			rs = ps.executeQuery();</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L172">				MonitoringBean monitoringStat = new MonitoringBean();</span>

<span class="nc" id="L174">				monitoringStat.setMonitoringId(rs.getInt(&quot;monitoring_id&quot;));</span>
<span class="nc" id="L175">				monitoringStat.setDateInsert(rs.getTimestamp(&quot;date_insert&quot;));</span>
<span class="nc" id="L176">				monitoringStat.setNodeName(rs.getString(&quot;node_name&quot;));</span>

<span class="nc" id="L178">				monitoringStat.setDbActive(rs.getInt(&quot;db_active&quot;));</span>
<span class="nc" id="L179">				monitoringStat.setDbIdle(rs.getInt(&quot;db_idle&quot;));</span>
<span class="nc" id="L180">				monitoringStat.setMemFree(rs.getBigDecimal(&quot;mem_free&quot;).longValue());</span>
<span class="nc" id="L181">				monitoringStat.setMemTotal(rs.getBigDecimal(&quot;mem_total&quot;).longValue());</span>

<span class="nc" id="L183">				monitoringStat.setCache(rs.getInt(&quot;cache&quot;));</span>
<span class="nc" id="L184">				monitoringStat.setSessions(rs.getInt(&quot;sessions&quot;));</span>

<span class="nc" id="L186">				monitoringStat.setCpuUsage(rs.getDouble(&quot;cpu_usage&quot;));</span>
<span class="nc" id="L187">				monitoringStat.setProcessUsage(rs.getDouble(&quot;process_usage&quot;));</span>
<span class="nc" id="L188">				monitoringStats.add(monitoringStat);</span>

<span class="nc" id="L190">			}</span>
<span class="nc" id="L191">			rs.close();</span>
<span class="nc" id="L192">			ps.close();</span>
<span class="nc" id="L193">			db_conn.close();</span>

<span class="nc" id="L195">			rs = null;</span>
<span class="nc" id="L196">			ps = null;</span>
<span class="nc" id="L197">			db_conn = null;</span>
		}
<span class="nc" id="L199">		catch (Exception ex)</span>
		{
<span class="nc" id="L201">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L207" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L208">					rs.close();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L210">					ps.close();</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L212">					db_conn.close();</span>
			}
<span class="nc" id="L214">			catch (Exception ex2)</span>
			{
<span class="nc" id="L216">			}</span>
		}

<span class="nc" id="L219">		return monitoringStats;</span>
	}

	/**
 	 * Vymaze zaznam monitorovanych hodnot z tabulky monitoring
 	 *
 	 * @param monitoringId - identifikacne cislo ulozeneho zaznamu, ktory chceme vymazat
 	 *
 	 * @return true ak vymazanie z databazy prebehlo v poriadku, inak false
 	 */
	public static boolean deleteMonitoringStat(int monitoringId)
	{
		try{
<span class="nc" id="L232">			new SimpleQuery().execute(&quot;DELETE FROM monitoring WHERE monitoring_id = ?&quot;, monitoringId);</span>
<span class="nc" id="L233">			return true;</span>
<span class="nc" id="L234">		}catch (Exception e) {</span>
<span class="nc" id="L235">			return false;</span>
		}
	}

	/**
 	 * Vyfiltruje a vrati rozne nazvy uzlov clustera z tabulky monitoring
 	 *
 	 * @return List naplneny roznymi nazvami uzlov clustera, ktore su zapisane v tabulke monitoring
 	 */
	public static List&lt;String&gt; getDistinctNodeNames()
	{
<span class="nc" id="L246">		return new SimpleQuery().forListString(&quot;SELECT DISTINCT node_name FROM monitoring&quot;);</span>
	}


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>