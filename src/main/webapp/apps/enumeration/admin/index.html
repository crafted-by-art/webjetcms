<script data-th-inline="javascript">
    let columns = /*[(${layout.getDataTableColumns("sk.iway.iwcm.components.enumerations.model.EnumerationDataBean")})]*/ '';
</script>
<script type="text/javascript">
    var enumerationDataDataTable = null;
    var lastIgnoredChildId = null;
    var lastIgnoredParentId = null;

    WJ.breadcrumb({
        id: "enumeration-data",
        tabs: [
            {
                url: '/apps/enumeration/admin/',
                title: '[[#{components.enumerations.list}]]',
                active: true
            },
            {
                url: '#enumerationType',
                title: '{filter}',
                active: false
            }
        ]
    });

    window.domReady.add(function () {
        let url = "/admin/rest/enumeration/enumeration-data";
        let enumTypes = {};

        //presun filter do hlavicky
        $("#pills-enumerationType-tab").html("");
        $("div#enumerationType_extfilter").appendTo("#pills-enumerationType-tab");

        //SET enumeration type select filter
        $.ajax({url: url + "/enum-types", success: function(json) {
            enumTypes=json;
            setEnumerationTypeFilterSelect(enumTypes);
            $("#enumerationTypeFilterSelect").trigger("change");
        }});

        //Onchange events - update data based on selected enumeration type
        $("#enumerationTypeFilterSelect").on("change", function() {
            var enumTypeSelectValue = $('#enumerationTypeFilterSelect').val();
            window.location.hash = enumTypeSelectValue;

            var newUrl = WJ.urlAddParam(url, "enumerationTypeId", enumTypeSelectValue);
            if (enumerationDataDataTable == null) {
                if (Object.entries(enumTypes).length==0) {
                    window.location.href="/apps/enumeration/admin/enumeration-type/";
                } else {
                    enumerationDataDataTable = WJ.DataTable({
                        url: newUrl,
                        serverSide: true,
                        columns: columns,
                        id: "enumerationDataDataTable",
                        customFieldsUpdateColumns: true,
                        fetchOnCreate: true,
                        fetchOnEdit: true
                    });

                    enumerationDataDataTable.EDITOR.on('open', function (e, mode, action) {
                        var enumTypeSelectValue = $('#enumerationTypeFilterSelect').val();

                        $.ajax({url: url + "/enum-type?enumerationTypeId=" + enumTypeSelectValue, success: function(enumType) {
                            //Handle child enum type id visibility (and select options)
                            if(enumType['allowChildEnumerationType']) {
                                enumerationDataDataTable.EDITOR.field("editorFields.childEnumTypeId").show();
                                setChildEnumTypeSelect();
                            } else enumerationDataDataTable.EDITOR.field("editorFields.childEnumTypeId").hide();

                            //Handle parent enum data id visibility (and select options)
                            if(enumType['allowParentEnumerationData']) {
                                enumerationDataDataTable.EDITOR.field("editorFields.parentEnumDataId").show();
                                if(action === 'create') setParentEnumDataSelect(null);
                                else if(action === 'edit') setParentEnumDataSelect( e.currentTarget.currentJson["enumerationDataId"] );
                            } else
                                enumerationDataDataTable.EDITOR.field("editorFields.parentEnumDataId").hide();
                        }});
                    });
                }
            } else {
                //add table filter params
                enumerationDataDataTable.ajax.url(newUrl);
                enumerationDataDataTable.EDITOR.ajax().url = WJ.urlAddPath(newUrl, '/editor');
                //reload tables values
                enumerationDataDataTable.ajax.reload();
            }
        });

        function setEnumerationTypeFilterSelect(mapOfTypes) {
            //Get object, select
            let enumerationTypeFilterSelect = document.getElementById('enumerationTypeFilterSelect');
            //Remove all options except the default one
            while(enumerationTypeFilterSelect.options.length > 1)
            enumerationTypeFilterSelect.remove(1);
            //Add new options
            for (const [key, value] of Object.entries(mapOfTypes)) {
                enumerationTypeFilterSelect.add(new Option(value, key));
            }

            //set selected value
            var hash = window.location.hash;
            if (hash != "") $(enumerationTypeFilterSelect).val(hash.substr(1));

            //Refresh object
            $("#enumerationTypeFilterSelect").selectpicker('refresh');
        }

        function setChildEnumTypeSelect() {
            //Find deleted options and disabled it
            //EnumTypes are just soft deleted in DB because of reference logic
            $("#DTE_Field_editorFields-childEnumTypeId option").each(function() {
                var deletedPrefix = WJ.translate("enum_type.deleted_type_mark.js");
                if(deletedPrefix !== undefined && deletedPrefix !== null && deletedPrefix !== "")
                    if($(this).text().startsWith('(!deleted)_'))
                        $('#DTE_Field_editorFields-childEnumTypeId option[value="' + $(this).val() + '"]').prop('disabled', true);
            });

            var idToIgnore = $('#enumerationTypeFilterSelect').val(); //a.k.a right now selected enum type as filter
            if(lastIgnoredChildId !== null)
                $('#DTE_Field_editorFields-childEnumTypeId option[value="' + lastIgnoredChildId + '"]').prop('disabled', false);

            //Disable select option
            $('#DTE_Field_editorFields-childEnumTypeId option[value="' + idToIgnore + '"]').prop('disabled', true);
            //Refresh select
            $("#DTE_Field_editorFields-childEnumTypeId").selectpicker('refresh');
            //Save last disabled option, so next time this option can be enabled
            lastIgnoredChildId = idToIgnore;
        }

        function setParentEnumDataSelect(idToIgnore) {
            //Find deleted options and disabled it
            //EnumDatas are just soft deleted in DB because of reference logic
            $("#DTE_Field_editorFields-parentEnumDataId option").each(function() {
                var deletedPrefix = WJ.translate("enum_type.deleted_type_mark.js");
                if(deletedPrefix !== undefined && deletedPrefix !== null && deletedPrefix !== "")
                    if($(this).text().startsWith('(!deleted)_'))
                        $('#DTE_Field_editorFields-parentEnumDataId option[value="' + $(this).val() + '"]').prop('disabled', true);
            });

            if(lastIgnoredParentId !== null)
                $('#DTE_Field_editorFields-parentEnumDataId option[value="' + lastIgnoredParentId + '"]').prop('disabled', false);

            //Disable select option
            $('#DTE_Field_editorFields-parentEnumDataId option[value="' + idToIgnore + '"]').prop('disabled', true);
            //Refresh select
            $("#DTE_Field_editorFields-parentEnumDataId").selectpicker('refresh');
            //Save last disabled option, so next time this option can be enabled
            lastIgnoredParentId = idToIgnore;
        }
    });
    </script>

    <div id="enumerationType_extfilter">
        <div class="row datatableInit">
            <div class="col-auto">
                <select id="enumerationTypeFilterSelect">
                </select>
            </div>
        </div>
    </div>

    <table id="enumerationDataDataTable" class="datatableInit table"></table>