<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FormMailAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.form</a> &gt; <span class="el_source">FormMailAction.java</span></div><h1>FormMailAction.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.form;

import cvu.html.HTMLTokenizer;
import cvu.html.TagToken;
import net.sourceforge.stripes.action.ActionBeanContext;
import net.sourceforge.stripes.validation.SimpleError;
import org.apache.struts.util.ResponseUtils;
import sk.iway.Password;
import sk.iway.iwcm.*;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.common.DocTools;
import sk.iway.iwcm.common.PdfTools;
import sk.iway.iwcm.common.SearchTools;
import sk.iway.iwcm.common.WriteTagToolsForCore;
import sk.iway.iwcm.components.upload.XhrFileUploadServlet;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.doc.*;
import sk.iway.iwcm.editor.EditorDB;
import sk.iway.iwcm.form.validators.PhoneValidator;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.io.IwcmFile;
import sk.iway.iwcm.io.IwcmFsDB;
import sk.iway.iwcm.system.captcha.Captcha;
import sk.iway.iwcm.system.multidomain.MultiDomainFilter;
import sk.iway.iwcm.system.stripes.CSRF;
import sk.iway.iwcm.tags.WriteTag;
import sk.iway.iwcm.users.UserDetails;
import sk.iway.iwcm.users.UsersDB;
import sk.iway.upload.DiskMultiPartRequestHandler;
import sk.iway.upload.UploadedFile;

import javax.activation.DataHandler;
import javax.activation.FileDataSource;
import javax.activation.MimetypesFileTypeMap;
import javax.mail.*;
import javax.mail.internet.*;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.*;
import java.lang.reflect.Method;
import java.net.InetAddress;
import java.sql.*;
import java.util.*;

/**
 *  univerzalne poslanie mailu
 *
 *@Title        iwcm
 *@Company      Interway s.r.o. (www.interway.sk)
 *@Copyright    Interway s.r.o. (c) 2001-2002
 *@author       $Author: jeeff $
 *@version      $Revision: 1.30 $
 *@created      ďż˝tvrtok, 2002, marec 28
 *@modified     $Date: 2004/03/23 19:23:02 $
 */
<span class="nc" id="L58">public class FormMailAction extends HttpServlet</span>
{
	private static final long serialVersionUID = 1L;

	/**
	 *  Description of the Field
	 */
	public static final String FORM_FILE_DIR = &quot;/WEB-INF/formfiles/&quot;;
	/**
	 *  Description of the Field
	 */
	public static final String FORM_HTML_DIR = &quot;/WEB-INF/formhtml/&quot;;

	/**
	 *  Zaslanie formularu z www stranky, nastavuje sa to cez:&lt;br&gt;
	 *  &lt;br&gt;
	 *  Kam sa to presmeruje po submite&lt;br&gt;
	 *  &lt;INPUT type=&quot;hidden&quot; name=&quot;forward&quot; value=&quot;/showdoc.do?docid=1250&quot;&gt;&lt;br&gt;
	 *  Dokumentu s predlohou formularu (fieldy su nahradene !meno_fieldu!)&lt;br&gt;
	 *  &lt;INPUT type=hidden value=&quot;formular.html&quot; name=&quot;source&quot;&gt;&lt;br&gt;
	 *  Prijemcovia mailu oddeleny ciarkou&lt;br&gt;
	 *  &lt;INPUT type=&quot;hidden&quot; name=&quot;recipients&quot; value=&quot;lubos.balat@interway.sk&quot;&gt;
	 *  ak je nastavene toto, ulozi sa formular do databazy&lt;br&gt;
	 *  &lt;INPUT type=&quot;hidden&quot; name=&quot;savedb&quot; value=&quot;nazov_formularu&quot;&gt;&lt;br&gt;
	 *  &lt;br&gt;
	 *  Subject mailu&lt;br&gt;
	 *  &lt;INPUT type=&quot;hidden&quot; name=&quot;subject&quot; value=&quot;Slovnaft WEB formular:
	 *  palivove karty (english)&quot;&gt;&lt;br&gt;
	 *  Zoznam fieldov ktore sa poslu a ulozia do DB&lt;br&gt;
	 *  &lt;INPUT type=&quot;hidden&quot; name=&quot;fields&quot;
	 *  value=&quot;Spolocnost,ICO,Meno,Adresa,Tel,Fax,Email,Info&quot;&gt;&lt;br&gt;
	 *  Field ktory urcuje ktory field je email&lt;br&gt;
	 *  &lt;INPUT type=&quot;hidden&quot; name=&quot;femail&quot; value=&quot;Email&quot;&gt;&lt;br&gt;
	 *  Field ktory urcuje ktory field je meno&lt;br&gt;
	 *  &lt;INPUT type=&quot;hidden&quot; name=&quot;fname&quot; value=&quot;Meno&quot;&gt;&lt;br&gt;
	 *  Zaciatok tela mailu&lt;br&gt;
	 *  &lt;INPUT type=&quot;hidden&quot; name=&quot;body&quot; value=&quot;Formular palivove karty z
	 *  www.slovnaft.sk&quot;&gt;&lt;br&gt;
	 *
	 *  formmail_sendUserInfoDocId - docId stranky, ktorej text sa posle emailom odosielatelovi formularu (jeho email je v poli email)
	 *  formmail_overwriteOldForms - ak je nastavene na true a je prihlaseny pouzivatel tak sa predtym vyplneny formular prepise novym
	 *  formmail_allowOnlyOneSubmit - ak je nastavene na true a je prihlaseny pouzivatel a uz vyplnil formular, nezapise sa znova do DB a formfail sa nastavi na formIsAllreadySubmitted
	 *
	 *
	 *
	 *@param  request               Description of the Parameter
	 *@param  response              Description of the Parameter
	 *@return                       Description of the Return Value
	 *@exception  IOException       Description of the Exception
	 *@exception  ServletException  Description of the Exception */


	protected static void execute(
			HttpServletRequest request,
			HttpServletResponse response)
			throws IOException, ServletException
	{
		//sprav upload

<span class="nc" id="L117">		DiskMultiPartRequestHandler multipartHandler = null;</span>
<span class="nc" id="L118">		List&lt;UploadedFile&gt; formFiles = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L119">		Map&lt;String, List&lt;UploadedFile&gt;&gt; formFilesTable = new Hashtable&lt;&gt;();</span>
<span class="nc" id="L120">		String formName = &quot;unknownForm&quot;;</span>
		try
		{
<span class="nc" id="L123">			multipartHandler = new DiskMultiPartRequestHandler();</span>
<span class="nc" id="L124">			request = multipartHandler.handleRequest(request);</span>

<span class="nc" id="L126">			formName = DB.internationalToEnglish(request.getParameter(&quot;savedb&quot;));</span>
<span class="nc" id="L127">			FormFileRestriction restriction = null;</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">			if (FormDB.isThereFileRestrictionFor(formName))</span>
<span class="nc" id="L129">				restriction = FormDB.getFileRestrictionFor(formName);</span>

<span class="nc" id="L131">			Map&lt;String, List&lt;UploadedFile&gt;&gt; files = multipartHandler.getFileElementsMultiple();</span>

<span class="nc" id="L133">			Set&lt;Map.Entry&lt;String, List&lt;UploadedFile&gt;&gt;&gt; set = files.entrySet();</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">			for(Map.Entry&lt;String, List&lt;UploadedFile&gt;&gt; me : set)</span>
			{
<span class="nc" id="L136">				formFilesTable.put(me.getKey(), me.getValue());</span>

<span class="nc bnc" id="L138" title="All 2 branches missed.">				for (UploadedFile formFile : me.getValue())</span>
				{
<span class="nc bnc" id="L140" title="All 4 branches missed.">					if (formFile != null &amp;&amp; formFile.getFileSize() &gt; 0)</span>
					{
<span class="nc" id="L142">						((IwcmRequest)request).setParameter(me.getKey(), &quot;NOT_EMPTY&quot;);</span>

<span class="nc" id="L144">						formFiles.add(formFile);</span>
<span class="nc bnc" id="L145" title="All 4 branches missed.">						if (restriction != null &amp;&amp; restriction.isSentFileValid(formFile)==false)</span>
						{
<span class="nc" id="L147">							request.setAttribute(&quot;invalidFiles&quot;, true);</span>
						}
					}
<span class="nc" id="L150">				}</span>
<span class="nc" id="L151">			}</span>
		}
<span class="nc" id="L153">		catch (Exception ex)</span>
		{
<span class="nc" id="L155">			multipartHandler = null;</span>
<span class="nc" id="L156">		}</span>

		//je to tu duplicitne ked padne multipart
<span class="nc" id="L159">		formName = DB.internationalToEnglish(request.getParameter(&quot;savedb&quot;));</span>

<span class="nc" id="L161">		request = fillRequestWithDatabaseOptions(formName, request, formFilesTable.get(&quot;fillRequestInterceptorFile&quot;));</span>

<span class="nc" id="L163">		String forward = saveForm(request, formFilesTable, formFiles, null);</span>

		//zmaz temp subory z uploadu
<span class="nc bnc" id="L166" title="All 2 branches missed.">		if (multipartHandler != null) multipartHandler.rollback();</span>

<span class="nc" id="L168">		String forwardType=request.getParameter(&quot;forwardType&quot;);</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">		if (forward.indexOf(&quot;formfail=&quot;)!=-1)</span>
		{
			//musime nastavit na redirect, inak sa nespracuje failstatus
<span class="nc" id="L173">			forwardType = null;</span>
		}

<span class="nc bnc" id="L176" title="All 2 branches missed.">		if (&quot;forward&quot;.equals(forwardType))</span>
		{
			//ziskaj si URL
<span class="nc" id="L179">			String url = forward;</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">			if (forward.indexOf(&quot;showdoc.do&quot;)==-1)</span>
			{
<span class="nc bnc" id="L182" title="All 2 branches missed.">				if (forward.indexOf('?')!=-1) url = forward.substring(0, forward.indexOf('?'));</span>

<span class="nc" id="L184">				DocDB docDB = DocDB.getInstance();</span>
<span class="nc" id="L185">				int docId = docDB.getVirtualPathDocId(url, DocDB.getDomain(request));</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">				if (docId &gt; 0) url = Tools.addParametersToUrlNoAmp(&quot;/showdoc.do?docid=&quot;+docId, forward.substring(forward.indexOf('?')+1));</span>
			}
<span class="nc" id="L188">			request.getRequestDispatcher(url).forward(request, response);</span>
<span class="nc" id="L189">			return;</span>
		}
<span class="nc bnc" id="L191" title="All 2 branches missed.">		if (&quot;addParams&quot;.equals(forwardType))</span>
		{
<span class="nc" id="L193">			Enumeration&lt;String&gt; parameters = request.getParameterNames();</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">			while (parameters.hasMoreElements())</span>
			{
<span class="nc" id="L196">				String name = parameters.nextElement();</span>
<span class="nc bnc" id="L197" title="All 4 branches missed.">				if (&quot;docid&quot;.equals(name) || &quot;doShowdocAction&quot;.equals(name)) continue;</span>

<span class="nc" id="L199">				String[] values = request.getParameterValues(name);</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">				for (int i=0; i&lt;values.length; i++)</span>
				{
<span class="nc" id="L202">					forward = Tools.addParameterToUrlNoAmp(forward, name, values[i]);</span>
				}
<span class="nc" id="L204">			}</span>
		}

<span class="nc" id="L207">		response.sendRedirect(forward);</span>
<span class="nc" id="L208">	}</span>

	public static HttpServletRequest fillRequestWithDatabaseOptions(String formName, HttpServletRequest request, List&lt;UploadedFile&gt; excelFile)
	{
<span class="fc" id="L212">		Map&lt;String, String&gt; options = new FormAttributeDB().load(formName);</span>
<span class="fc" id="L213">		IwcmRequest wrapped = new IwcmRequest(request);</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">		for(Map.Entry&lt;String, String&gt; entry : options.entrySet())</span>
		{
<span class="fc" id="L216">			String paramName = entry.getKey();</span>
			//nastaveny parameter useFormDocId ma prioritu z databazy (lebo WriteTag ho vzdy nastavi podla aktualnej stranky)
<span class="pc bpc" id="L218" title="3 of 4 branches missed.">			if (wrapped.hasParameter(paramName)==false || &quot;useFormDocId&quot;.equals(paramName))</span>
			{
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">				if (&quot;useFormDocId&quot;.equals(paramName))</span>
				{
<span class="nc" id="L222">					wrapped.setParameter(&quot;useFormDocIdOriginal&quot;, request.getParameter(&quot;useFormDocId&quot;));</span>
<span class="nc" id="L223">					Logger.debug(FormMailAction.class, &quot;fillRequestWithDatabaseOptions, setting: useFormDocIdOriginal with value from useFormDocId=&quot;+request.getParameter(&quot;useFormDocId&quot;));</span>
				}
<span class="fc" id="L225">				Logger.debug(FormMailAction.class, &quot;fillRequestWithDatabaseOptions, setting:&quot;+paramName+&quot;=&quot;+entry.getValue());</span>
<span class="fc" id="L226">				wrapped.setParameter(paramName, entry.getValue());</span>
<span class="fc" id="L227">				wrapped.setAttribute(&quot;DB&quot;+paramName, &quot;true&quot;);</span>
			}
<span class="fc" id="L229">		}</span>
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(request.getParameter(&quot;fillRequestInterceptorClass&quot;))){</span>
			// moznost naplnit data zo vstupneho subora do nasho requestu (wrapped), pouzite napr. v jasr pri importe studentov
			// treba dat do formulara hidden parameter fillRequestInterceptorClass nastavenym na triedu ktora to ma vykonat
<span class="nc" id="L233">			InputStream is = null;</span>
			try
			{
<span class="nc" id="L236">				Class&lt;?&gt; c = Class.forName(request.getParameter(&quot;fillRequestInterceptorClass&quot;));</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">				if (FillRequestInterceptor.class.isAssignableFrom(c))</span>
				{
<span class="nc bnc" id="L239" title="All 4 branches missed.">					if (excelFile!=null &amp;&amp; excelFile.size()&gt;0) is = excelFile.get(0).getInputStream();</span>
<span class="nc" id="L240">					FillRequestInterceptor interceptor = (FillRequestInterceptor) c.getDeclaredConstructor().newInstance();</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">					if (interceptor!=null)</span>
					{
<span class="nc" id="L243">						boolean successfullyIntercepted = interceptor.intercept(is, wrapped);</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">						if (!successfullyIntercepted) {</span>
<span class="nc" id="L245">							Logger.error(FormMailAction.class, &quot;Nedoslo k naplneniu dat do wrappera v triede: &quot; + interceptor.getClass().getName());</span>
						}
					}
				}
<span class="nc" id="L249">			} catch (Exception e)</span>
			{
<span class="nc" id="L251">				Logger.error(FormMailAction.class, &quot;Problem s incerceptorom: &quot;, e);</span>
			}
			finally
			{
<span class="nc bnc" id="L255" title="All 2 branches missed.">			if (is!=null) try { is.close(); } catch (Exception ex) { /* */ }</span>
			}
		}
<span class="fc" id="L258">		return wrapped;</span>
	}

	public static String saveForm(HttpServletRequest request, Map&lt;String, List&lt;UploadedFile&gt;&gt; formFilesTable, List&lt;UploadedFile&gt; formFiles, ActionBeanContext context)
	{
<span class="fc" id="L263">		Prop prop = Prop.getInstance(PageLng.getUserLng(request));</span>
<span class="fc" id="L264">		List&lt;IwcmFile&gt; attachs = null;</span>
<span class="fc" id="L265">		boolean attachFiles = true;</span>
<span class="fc" id="L266">		String failStatus=null;</span>

<span class="fc" id="L268">		String formName = request.getParameter(&quot;savedb&quot;);</span>

		//skontroluj multiupload subory
<span class="fc" id="L271">		String[] uploadedFilesParamNameList = request.getParameterValues(&quot;Multiupload.formElementName&quot;);</span>
<span class="pc bpc" id="L272" title="3 of 4 branches missed.">		if (uploadedFilesParamNameList != null &amp;&amp; uploadedFilesParamNameList.length&gt;0)</span>
		{
			//mame to tu znova keby padlo mulipart parsovanie
<span class="nc" id="L275">			FormFileRestriction restriction = null;</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">			if (FormDB.isThereFileRestrictionFor(formName)) restriction = FormDB.getFileRestrictionFor(formName);</span>

			//over subory uploadnute cez HTML5 upload
<span class="nc bnc" id="L279" title="All 2 branches missed.">			for (String uploadedFilesParamName : uploadedFilesParamNameList)</span>
			{
<span class="nc bnc" id="L281" title="All 2 branches missed.">				if (Tools.isNotEmpty(request.getParameter(uploadedFilesParamName)))</span>
				{
<span class="nc" id="L283">					StringBuilder fileNames = new StringBuilder();</span>

<span class="nc bnc" id="L285" title="All 2 branches missed.">					for (String keys : request.getParameterValues(uploadedFilesParamName))</span>
					{

<span class="nc bnc" id="L288" title="All 2 branches missed.">						for (String fileKey : Tools.getTokens(keys, &quot;;&quot;))</span>
						{
<span class="nc bnc" id="L290" title="All 2 branches missed.">							if (restriction!=null)</span>
							{
<span class="nc" id="L292">								String filePath = XhrFileUploadServlet.getTempFilePath(fileKey);</span>
<span class="nc" id="L293">								Logger.debug(FormMailAction.class, &quot;Multiupload, fileKey=&quot; + fileKey + &quot; path=&quot; + filePath);</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">								if (filePath != null)</span>
								{
<span class="nc" id="L296">									IwcmFile file = new IwcmFile(filePath);</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">									if (file.exists())</span>
									{
<span class="nc bnc" id="L299" title="All 2 branches missed.">										if (restriction.isSentFileValid(file) == false)</span>
										{
<span class="nc" id="L301">											request.setAttribute(&quot;invalidFiles&quot;, &quot;true&quot;);</span>
										}
									}
								}
							}
<span class="nc" id="L306">							String fileName = XhrFileUploadServlet.getTempFileName(fileKey);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">							if (Tools.isNotEmpty(fileName)) {</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">								if (fileNames.length()&gt;0) fileNames.append(&quot;, &quot;);</span>
<span class="nc" id="L309">								fileNames.append(fileName);</span>
							}
						}
					}

					//nastav hodnotu input pola so zoznamom suborov, aby sa nam to pekne vyrenderovalo v maile a HTML verzii
<span class="nc" id="L315">					((IwcmRequest)request).setParameter(uploadedFilesParamName+&quot;-fileNames&quot;, fileNames.toString());</span>
				}
			}
		}

<span class="pc bpc" id="L320" title="1 of 2 branches missed.">		if (formFiles==null) formFiles = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">		if (formFilesTable==null) formFilesTable = new Hashtable&lt;&gt;();</span>

		//toto je thread safe
<span class="fc" id="L324">		String emailEncoding = SetCharacterEncodingFilter.getEncoding();</span>
<span class="fc" id="L325">		String formMailEncoding = Constants.getString(&quot;formMailEncoding&quot;);</span>
<span class="pc bpc" id="L326" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(formMailEncoding))</span>
		{
<span class="nc" id="L328">			emailEncoding = formMailEncoding;</span>
		}
<span class="fc" id="L330">		String formMailEncodingParam = request.getParameter(&quot;formMailEncoding&quot;);</span>
<span class="pc bpc" id="L331" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(formMailEncodingParam))</span>
		{
<span class="nc" id="L333">			emailEncoding = formMailEncodingParam;</span>
		}

<span class="fc" id="L336">		String host = Constants.getString(&quot;smtpServer&quot;);</span>
<span class="fc" id="L337">		String recipients = null;</span>
<span class="pc bpc" id="L338" title="1 of 2 branches missed.">		if (request.getParameter(&quot;recipients&quot;) != null)</span>
		{
<span class="fc" id="L340">			recipients = WriteTag.decodeEmailAddress(request.getParameter(&quot;recipients&quot;));</span>
		}
<span class="pc bpc" id="L342" title="2 of 4 branches missed.">		if (recipients != null &amp;&amp; recipients.indexOf('@') == -1)</span>
		{
<span class="nc" id="L344">			recipients = null;</span>
		}

<span class="fc" id="L347">		String subject = &quot;Formular z www stranky&quot;;</span>
<span class="pc bpc" id="L348" title="1 of 2 branches missed.">		if (request.getParameter(&quot;subject&quot;) != null)</span>
		{
<span class="fc" id="L350">			subject = request.getParameter(&quot;subject&quot;);</span>
		}

<span class="fc" id="L353">		String email = &quot;&quot;;</span>
<span class="fc" id="L354">		String meno = &quot;&quot;;</span>

<span class="fc" id="L356">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="fc" id="L357">		TemplatesDB tempDB = TemplatesDB.getInstance();</span>
<span class="fc" id="L358">		TemplateDetails temp = null;</span>
		GroupDetails group;

		//fmeno sa pouzivalo volakedy, uz je depreaced
<span class="pc bpc" id="L362" title="2 of 4 branches missed.">		if (request.getParameter(&quot;fmeno&quot;) != null || request.getParameter(&quot;fname&quot;) != null)</span>
		{
<span class="nc" id="L364">			String fmeno = request.getParameter(&quot;fmeno&quot;);</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">			if (fmeno == null)</span>
			{
<span class="nc" id="L367">				fmeno = request.getParameter(&quot;fname&quot;);</span>
			}
<span class="nc bnc" id="L369" title="All 2 branches missed.">			if (fmeno.indexOf(',') == -1)</span>
			{
<span class="nc" id="L371">				meno = DB.internationalToEnglish(request.getParameter(fmeno));</span>
			}
			else
			{
<span class="nc" id="L375">				StringTokenizer st = new StringTokenizer(fmeno, &quot;,&quot;);</span>
				String token;
<span class="nc" id="L377">				meno = &quot;&quot;;</span>
<span class="nc" id="L378">				StringBuilder buf = new StringBuilder();</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">				while (st.hasMoreTokens())</span>
				{
<span class="nc" id="L381">					token = st.nextToken();</span>
<span class="nc" id="L382">					buf.append(' ').append(DB.internationalToEnglish(request.getParameter(token)));</span>
				}
<span class="nc" id="L384">				meno = buf.toString();</span>
			}
		}
<span class="pc bpc" id="L387" title="1 of 2 branches missed.">		if (request.getParameter(&quot;femail&quot;) != null)</span>
		{
<span class="nc" id="L389">			email = request.getParameter(request.getParameter(&quot;femail&quot;));</span>
		}
<span class="pc bpc" id="L391" title="1 of 2 branches missed.">		else if (request.getParameter(&quot;e-mail&quot;) != null)</span>
		{
<span class="nc" id="L393">			email = request.getParameter(&quot;e-mail&quot;);</span>
		}
<span class="pc bpc" id="L395" title="1 of 2 branches missed.">		else if (request.getParameter(&quot;email&quot;) != null)</span>
		{
<span class="nc" id="L397">			email = request.getParameter(&quot;email&quot;);</span>
		}

<span class="fc" id="L400">		String source = null;</span>
<span class="pc bpc" id="L401" title="1 of 2 branches missed.">		if (request.getParameter(&quot;source&quot;) != null)</span>
		{
<span class="nc" id="L403">			source = request.getParameter(&quot;source&quot;);</span>
		}

<span class="fc" id="L406">		String forwardDefault = &quot;/&quot;;</span>
<span class="fc" id="L407">		String forwardOk = null;</span>
<span class="fc" id="L408">		String forwardFail = null;</span>
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">		if (request.getParameter(&quot;forward&quot;) != null) forwardOk = request.getParameter(&quot;forward&quot;);</span>
<span class="pc bpc" id="L410" title="1 of 2 branches missed.">		if (request.getParameter(&quot;forwardFail&quot;) != null) forwardFail = request.getParameter(&quot;forwardFail&quot;);</span>

<span class="fc" id="L412">		DocDB docDB = DocDB.getInstance();</span>

<span class="fc" id="L414">		Integer iLastDocId = null;</span>
<span class="fc" id="L415">		Integer iLastDocIdMail = null;</span>
		try
		{

			try
			{
<span class="fc" id="L421">				String referer = request.getHeader(&quot;referer&quot;);</span>
<span class="pc bpc" id="L422" title="2 of 4 branches missed.">				if (referer!=null &amp;&amp; referer.indexOf(&quot;docid=&quot;) != -1)</span>
				{
					try
					{
<span class="nc" id="L426">						referer = referer.substring(referer.indexOf(&quot;docid=&quot;) + 6);</span>
<span class="nc" id="L427">						StringTokenizer st = new StringTokenizer(referer, &quot;&amp;&quot;);</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">						if (st.hasMoreTokens())</span>
						{
<span class="nc" id="L430">							referer = st.nextToken();</span>
						}
<span class="nc" id="L432">						iLastDocId = Integer.valueOf(Integer.parseInt(referer));</span>
					}
<span class="nc" id="L434">					catch (Exception ex)</span>
					{
						//nerobime nic
<span class="nc" id="L437">					}</span>
				}
<span class="pc bpc" id="L439" title="1 of 2 branches missed.">				else if (referer!=null)</span>
				{
<span class="fc" id="L441">					String url = referer;</span>
<span class="fc" id="L442">					Logger.debug(FormMailAction.class, &quot;referer=&quot;+referer);</span>
					try
					{
<span class="fc" id="L445">						int i = url.indexOf('?');</span>
<span class="pc bpc" id="L446" title="1 of 2 branches missed.">						if (i!=-1) url = url.substring(0, i);</span>
						//odstran http://xxx/
<span class="fc" id="L448">						i = url.indexOf('/', 10);</span>
<span class="pc bpc" id="L449" title="1 of 2 branches missed.">						if (i != -1)</span>
						{
<span class="fc" id="L451">							url = url.substring(i);</span>
						}

<span class="fc" id="L454">						Logger.debug(FormMailAction.class, &quot;url=&quot;+url);</span>
<span class="fc" id="L455">						i = DocDB.getDocIdFromURL(url, DocDB.getDomain(request));</span>
<span class="pc bpc" id="L456" title="1 of 2 branches missed.">						if (i &gt; 0) iLastDocId = i;</span>

<span class="fc" id="L458">						Logger.debug(FormMailAction.class, &quot;iLastDocId=&quot;+iLastDocId);</span>
					}
<span class="nc" id="L460">					catch (Exception e)</span>
					{
						//nerobime nic
<span class="fc" id="L463">					}</span>
				}
			}
<span class="nc" id="L466">			catch (NumberFormatException ex2)</span>
			{
				//nerobime nic
<span class="fc" id="L469">			}</span>
<span class="pc bpc" id="L470" title="1 of 2 branches missed.">			if (iLastDocId==null)</span>
			{
<span class="nc" id="L472">				iLastDocId = (Integer) request.getSession().getAttribute(&quot;last_doc_id&quot;);</span>
			}

			//niekedy je formular napr v pravom menu, potom sa neparsuje docid podla requestu, ale
			//sa mu musi presne povedat, kde sa ten formular nachadza
<span class="pc bpc" id="L477" title="1 of 2 branches missed.">			if (request.getParameter(&quot;useFormDocId&quot;)!=null)</span>
			{
<span class="pc bpc" id="L479" title="1 of 2 branches missed.">				if (&quot;none&quot;.equals(request.getParameter(&quot;useFormDocId&quot;)))</span>
				{
<span class="nc" id="L481">					iLastDocId = null;</span>
				}
				else
				{
<span class="fc" id="L485">					iLastDocId = Integer.valueOf(Tools.getIntValue(request.getParameter(&quot;useFormDocId&quot;), -1));</span>
				}
			}
<span class="fc" id="L488">			iLastDocIdMail = iLastDocId;</span>
			//aby sme pre mail mohli specifikovat inu stranku ako to co sa zobrazuje
<span class="pc bpc" id="L490" title="1 of 2 branches missed.">			if (request.getParameter(&quot;useFormMailDocId&quot;)!=null)</span>
			{
<span class="nc bnc" id="L492" title="All 2 branches missed.">				if (&quot;none&quot;.equals(request.getParameter(&quot;useFormMailDocId&quot;)))</span>
				{
<span class="nc" id="L494">					iLastDocIdMail = null;</span>
				}
				else
				{
<span class="nc" id="L498">					iLastDocIdMail = Integer.valueOf(Tools.getIntValue(request.getParameter(&quot;useFormMailDocId&quot;), -1));</span>
				}
			}
<span class="fc" id="L501">			Logger.debug(FormMailAction.class, &quot;iLastDocId=&quot;+iLastDocId);</span>
		}
<span class="pc" id="L503">		catch (Exception ex) { /* nerobime nic */ }</span>


		//id stranky z ktorej je automaticky vyparsovany HTML kod formularu
<span class="fc" id="L507">		int docId = -1;</span>

		//HTML kod stranky pre test emailu (aby sa nedal recipients nastavit iny ako je v stranke)
<span class="fc" id="L510">		String originalPageHtml = null;</span>

<span class="fc" id="L512">		StringBuilder htmlData = new StringBuilder();</span>
<span class="fc" id="L513">		boolean hasHtmlData = false;</span>

<span class="fc" id="L515">		String cssData = null;</span>
<span class="fc" id="L516">		String cssLink = null;</span>

		//tu budu ulozene hodnoty atributu class pre jednotlive polia
		//da sa tak spravit server side kontrola required poli
<span class="fc" id="L520">		List&lt;LabelValueDetails&gt; classNames = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L521">		Map&lt;String, String&gt; labelsTable = new Hashtable&lt;&gt;();</span>

<span class="fc" id="L523">		boolean forceTextPlain = &quot;true&quot;.equals(request.getParameter(&quot;forceTextPlain&quot;));</span>

		//iteruj cez polozky formularu
<span class="fc" id="L526">		StringBuilder fields = null;</span>
<span class="pc bpc" id="L527" title="1 of 2 branches missed.">		if (request.getParameter(&quot;fields&quot;) != null) fields = new StringBuilder(request.getParameter(&quot;fields&quot;));</span>
		//ak je true, fields sa generuju automaticky
<span class="fc" id="L529">		boolean autoFields = false;</span>
<span class="pc bpc" id="L530" title="3 of 4 branches missed.">		if (fields == null || fields.toString().equals(&quot;*&quot;))</span>
		{
			try
			{
<span class="pc bpc" id="L534" title="2 of 4 branches missed.">				if (iLastDocIdMail!=null &amp;&amp; iLastDocId!=null)</span>
				{
<span class="fc" id="L536">					Logger.debug(FormMailAction.class, &quot;iLastDocId(int)=&quot;+iLastDocIdMail);</span>
<span class="fc" id="L537">					DocDetails doc = docDB.getDoc(iLastDocIdMail, -1, false);</span>
<span class="fc" id="L538">					docId = iLastDocId.intValue();</span>

<span class="pc bpc" id="L540" title="1 of 2 branches missed.">					if (doc!=null)</span>
					{
						//toto potrebujeme pre technicke info
<span class="fc" id="L543">						request.setAttribute(&quot;doc_title&quot;, doc.getTitle());</span>
<span class="pc bpc" id="L544" title="1 of 2 branches missed.">						request.setAttribute(&quot;doc_title_seo&quot;, Tools.isEmpty(doc.getFieldQ()) ? doc.getTitle() : doc.getFieldQ());</span>
<span class="fc" id="L545">						request.setAttribute(&quot;doc_full_url&quot;, DocDB.getInstance().getDocLink(doc.getDocId(), doc.getExternalLink(), true, request));</span>

<span class="fc" id="L547">						originalPageHtml = originalPageHtml + doc.getData();</span>

<span class="fc" id="L549">						temp = tempDB.getTemplate(doc.getTempId());</span>
<span class="fc" id="L550">						group = groupsDB.getGroup(doc.getGroupId());</span>

<span class="pc bpc" id="L552" title="1 of 2 branches missed.">						if (doc.getData().contains(&quot;/components/formsimple/&quot;))</span>
						{
<span class="fc" id="L554">							doc.setData(EditorDB.renderIncludes(doc, false, request));</span>
						}

						//UPDATNI FIELDS
<span class="fc" id="L558">						doc.setData(getCroppedHTML(ShowDoc.updateCodes(null, doc.getData(), iLastDocIdMail.intValue(), request, Constants.getServletContext())));</span>

<span class="pc bpc" id="L560" title="1 of 2 branches missed.">						if (request.getParameter(&quot;subject&quot;) == null)</span>
						{
<span class="nc" id="L562">							subject = doc.getTitle();</span>
						}

<span class="pc bpc" id="L565" title="1 of 2 branches missed.">						if (request.getParameter(&quot;forward&quot;) == null)</span>
						{
							//forward robime podla normalneho lastDocId
<span class="fc" id="L568">							forwardDefault = docDB.getDocLink(iLastDocId.intValue());</span>
						}
<span class="pc bpc" id="L570" title="1 of 2 branches missed.">						if (forwardFail==null) forwardFail = docDB.getDocLink(iLastDocId.intValue());</span>

<span class="pc bpc" id="L572" title="1 of 2 branches missed.">						if (request.getParameter(&quot;savedb&quot;) == null)</span>
						{
<span class="nc" id="L574">							formName = DocTools.removeCharsDir(DB.internationalToEnglish(doc.getTitle())).toLowerCase();</span>
						}

<span class="fc" id="L577">						fields = null;</span>
						String field;

						//vytvor strom
<span class="fc" id="L581">						HTMLTokenizer htmlTokenizer = new HTMLTokenizer(Tools.replace(doc.getData(), &quot;/&gt;&quot;, &quot;&gt;&quot;).toCharArray());</span>
						//HTMLTree htmlTree = new HTMLTree(htmlTokenizer);
						@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L584">						Enumeration&lt;Object&gt; e = htmlTokenizer.getTokens();</span>
						TagToken tagToken;
						Object o;
<span class="fc" id="L587">						String skipToTag = null;</span>
<span class="fc" id="L588">						StringBuilder labelContent = null;</span>
<span class="fc" id="L589">						String labelFor = null;</span>
<span class="fc bfc" id="L590" title="All 2 branches covered.">						while (e.hasMoreElements())</span>
						{
<span class="fc" id="L592">							o = e.nextElement();</span>
<span class="fc bfc" id="L593" title="All 2 branches covered.">							if (o instanceof TagToken)</span>
							{
<span class="fc" id="L595">								tagToken = (TagToken) o;</span>
<span class="pc bpc" id="L596" title="1 of 2 branches missed.">								if (hasHtmlData == false)</span>
								{
<span class="fc" id="L598">									htmlData.append(tagToken.getLineForm(request));</span>
								}
<span class="fc" id="L600">								field = tagToken.getFormField();</span>
<span class="fc bfc" id="L601" title="All 2 branches covered.">								if (field!=null)</span>
								{
<span class="fc bfc" id="L603" title="All 2 branches covered.">									if (fields==null) fields = new StringBuilder(field);</span>
									else
									{
										//aby sa neopakovali, napr. radiobuttony
<span class="pc bpc" id="L607" title="1 of 2 branches missed.">										if ((&quot;,&quot;+fields.toString()+&quot;,&quot;).indexOf(&quot;,&quot;+field+&quot;,&quot;)==-1)</span>
										{
<span class="fc" id="L609">											fields.append(&quot;,&quot;).append(field);</span>
										}
									}
								}
<span class="fc" id="L613">								skipToTag = tagToken.getSkipToTag(skipToTag);</span>

<span class="fc" id="L615">								Logger.debug(FormMailAction.class, &quot;TagToken name=&quot;+tagToken.getName()+&quot; for=&quot;+tagToken.getAttribute(&quot;for&quot;));</span>
<span class="fc bfc" id="L616" title="All 2 branches covered.">								if (&quot;label&quot;.equalsIgnoreCase(tagToken.getName()))</span>
								{
<span class="fc bfc" id="L618" title="All 4 branches covered.">									if (tagToken.isEndTag() &amp;&amp; labelFor != null)</span>
									{
<span class="pc bpc" id="L620" title="1 of 2 branches missed.">										if (labelContent != null) labelsTable.put(labelFor, labelContent.toString());</span>
									}
									else
									{
<span class="fc" id="L624">										labelContent = null;</span>
<span class="fc bfc" id="L625" title="All 2 branches covered.">										if (Tools.isNotEmpty(tagToken.getAttribute(&quot;for&quot;))) labelFor = tagToken.getAttribute(&quot;for&quot;);</span>
<span class="fc" id="L626">										else labelFor = null;</span>
									}
								}


<span class="fc" id="L631">								field = tagToken.getAttribute(&quot;name&quot;);</span>
<span class="fc bfc" id="L632" title="All 2 branches covered.">								if (Tools.isEmpty(field)) field = tagToken.getAttribute(&quot;id&quot;);</span>

<span class="fc bfc" id="L634" title="All 2 branches covered.">								if (field!=null)</span>
								{
<span class="fc" id="L636">									String className = tagToken.getAttribute(&quot;class&quot;);</span>
<span class="pc bpc" id="L637" title="1 of 2 branches missed.">									if (className != null)</span>
									{
<span class="fc" id="L639">										LabelValueDetails lvb = new LabelValueDetails(field, className);</span>
<span class="fc" id="L640">										lvb.setValue2(tagToken.getAttribute(&quot;id&quot;));</span>
<span class="fc" id="L641">										classNames.add(lvb);</span>
<span class="fc" id="L642">										Logger.debug(FormMailAction.class, &quot;className: &quot;+field+&quot;=&quot;+className);</span>
									}

									//skus najst pole nazvane email, to bude odosielatel emailu
<span class="pc bpc" id="L646" title="1 of 2 branches missed.">									if (request.getParameter(&quot;femail&quot;) == null)</span>
									{
<span class="pc bpc" id="L648" title="2 of 4 branches missed.">										if (&quot;email&quot;.equalsIgnoreCase(field) || &quot;e-mail&quot;.equalsIgnoreCase(field))</span>
										{
											//email = request.getParameter(field);
											//field = tagToken.getAttribute(&quot;value&quot;);
<span class="nc" id="L652">											field = request.getParameter(field);</span>
<span class="nc bnc" id="L653" title="All 4 branches missed.">											if (field!=null &amp;&amp; field.length()&gt;3)</span>
											{
<span class="nc" id="L655">												email = field;</span>
											}
										}
									}
<span class="pc bpc" id="L659" title="1 of 2 branches missed.">									if (request.getParameter(&quot;fname&quot;) == null)</span>
									{
<span class="pc bpc" id="L661" title="1 of 2 branches missed.">										if (&quot;name&quot;.equalsIgnoreCase(field) ||</span>
<span class="pc bpc" id="L662" title="1 of 2 branches missed.">												&quot;firstname&quot;.equalsIgnoreCase(field) ||</span>
<span class="pc bpc" id="L663" title="1 of 2 branches missed.">												&quot;lastname&quot;.equalsIgnoreCase(field) ||</span>
<span class="pc bpc" id="L664" title="1 of 2 branches missed.">												&quot;meno&quot;.equalsIgnoreCase(field) ||</span>
<span class="pc bpc" id="L665" title="1 of 2 branches missed.">												&quot;priezvisko&quot;.equalsIgnoreCase(field) ||</span>
<span class="pc bpc" id="L666" title="1 of 2 branches missed.">												&quot;jmeno&quot;.equalsIgnoreCase(field) ||</span>
<span class="pc bpc" id="L667" title="1 of 2 branches missed.">												&quot;prijmeni&quot;.equalsIgnoreCase(field)</span>
										)
										{
											//field = tagToken.getAttribute(&quot;value&quot;);
<span class="nc" id="L671">											field = request.getParameter(field);</span>
<span class="nc bnc" id="L672" title="All 4 branches missed.">											if (field!=null &amp;&amp; field.length()&gt;3)</span>
											{
<span class="nc bnc" id="L674" title="All 4 branches missed.">												if (meno==null || meno.length()==0)</span>
												{
<span class="nc" id="L676">													meno = DB.internationalToEnglish(field);</span>
												}
												else
												{
<span class="nc" id="L680">													meno += &quot; &quot; + DB.internationalToEnglish(field); //NOSONAR</span>
												}
											}
										}
									}
<span class="fc" id="L685">								}</span>
							}
							else
							{
<span class="pc bpc" id="L689" title="1 of 2 branches missed.">								if (skipToTag == null) htmlData.append(o.toString());</span>
<span class="fc bfc" id="L690" title="All 2 branches covered.">								if (labelFor != null)</span>
								{
<span class="fc bfc" id="L692" title="All 2 branches covered.">									if (labelContent == null) labelContent = new StringBuilder(o.toString());</span>
<span class="fc" id="L693">									else labelContent.append(o.toString());</span>
								}
							}
						}

<span class="pc bpc" id="L698" title="1 of 2 branches missed.">						if (htmlData.length() &gt; 10)</span>
						{
<span class="fc" id="L700">							hasHtmlData = true;</span>

<span class="pc bpc" id="L702" title="1 of 4 branches missed.">							if (Constants.getBoolean(&quot;formMailSendPlainText&quot;)==false &amp;&amp; forceTextPlain==false)</span>
							{
								try
								{
<span class="fc" id="L706">									cssData = &quot;&lt;style type='text/css'&gt;&quot;;</span>
<span class="fc" id="L707">									cssLink = &quot;&quot;;</span>

<span class="pc bpc" id="L709" title="1 of 2 branches missed.">									if (temp != null)</span>
									{
<span class="fc" id="L711">										String domainAlias = MultiDomainFilter.getDomainAlias(group.getDomainName());</span>

<span class="fc" id="L713">										String tempCssLink = null;</span>
<span class="pc bpc" id="L714" title="2 of 4 branches missed.">										if (temp.getCss() != null &amp;&amp; temp.getCss().length() &gt; 1)</span>
										{
<span class="nc" id="L716">											tempCssLink = temp.getCss();</span>
<span class="nc bnc" id="L717" title="All 6 branches missed.">											if (group!=null &amp;&amp; Constants.getBoolean(&quot;multiDomainEnabled&quot;)==true &amp;&amp; Tools.isNotEmpty(group.getDomainName()))</span>
											{
												//ak je cssko v /templates adresari uz domain alias nepridavame
<span class="nc bnc" id="L720" title="All 6 branches missed.">												if (tempCssLink.contains(domainAlias)==false &amp;&amp; tempCssLink.contains(&quot;/templates/&quot;)==false &amp;&amp; tempCssLink.contains(&quot;/files/&quot;)==false)</span>
												{
<span class="nc" id="L722">													tempCssLink = Tools.replace(tempCssLink, &quot;/css/&quot;, &quot;/css/&quot; + domainAlias + &quot;/&quot;);</span>
												}
											}
										}
<span class="fc" id="L726">										String baseCssPath = temp.getBaseCssPath();</span>
<span class="pc bpc" id="L727" title="3 of 6 branches missed.">										if (group!=null &amp;&amp; Constants.getBoolean(&quot;multiDomainEnabled&quot;)==true &amp;&amp; Tools.isNotEmpty(group.getDomainName()))</span>
										{
											//ak je cssko v /templates adresari uz domain alias nepridavame
<span class="pc bpc" id="L730" title="5 of 6 branches missed.">											if (baseCssPath.contains(domainAlias)==false &amp;&amp; baseCssPath.contains(&quot;/templates/&quot;)==false &amp;&amp; baseCssPath.contains(&quot;/files/&quot;)==false)</span>
											{

<span class="nc" id="L733">												baseCssPath = Tools.replace(baseCssPath, &quot;/css/&quot;, &quot;/css/&quot; + MultiDomainFilter.getDomainAlias(group.getDomainName()) + &quot;/&quot;); //NOSONAR</span>
											}
										}

<span class="fc" id="L737">										String editorEditorCss = Constants.getString(&quot;editorEditorCss&quot;);</span>

<span class="fc" id="L739">										tempCssLink = checkEmailCssVersion(tempCssLink);</span>
<span class="fc" id="L740">										baseCssPath = checkEmailCssVersion(baseCssPath);</span>
<span class="fc" id="L741">										editorEditorCss = checkEmailCssVersion(editorEditorCss);</span>

<span class="fc" id="L743">										Logger.debug(FormMailAction.class, &quot;Reading baseCSS: &quot;+baseCssPath+&quot; tempCss: &quot;+tempCssLink);</span>

										//nacitaj css styl ako v editore stranok
<span class="fc" id="L746">										StringBuilder cssStyle = new StringBuilder(FileTools.readFileContent(baseCssPath)).append('\n');</span>
<span class="pc bpc" id="L747" title="1 of 2 branches missed.">										if (tempCssLink!=null) cssStyle.append(FileTools.readFileContent(tempCssLink)).append('\n');</span>
<span class="fc" id="L748">										cssStyle.append(FileTools.readFileContent(editorEditorCss)).append('\n');</span>

<span class="fc" id="L750">										cssData += cssStyle.toString();</span>
<span class="fc" id="L751">										cssLink += &quot;&lt;link rel='stylesheet' href='&quot;+baseCssPath+&quot;' type='text/css'/&gt;\n&quot;;</span>
<span class="pc bpc" id="L752" title="1 of 2 branches missed.">										if (tempCssLink!=null) cssLink += &quot;&lt;link rel='stylesheet' href='&quot;+tempCssLink+&quot;' type='text/css'/&gt;\n&quot;;</span>
<span class="fc" id="L753">										cssLink += &quot;&lt;link rel='stylesheet' href='&quot;+editorEditorCss+&quot;' type='text/css'/&gt;\n&quot;;</span>
<span class="fc" id="L754">									}</span>
									else
									{
										//nacitaj css styl
<span class="nc" id="L758">										InputStream is = Constants.getServletContext().getResourceAsStream(&quot;/css/email.css&quot;);</span>
<span class="nc bnc" id="L759" title="All 2 branches missed.">										if (is==null)</span>
										{
<span class="nc" id="L761">											is = Constants.getServletContext().getResourceAsStream(Constants.getString(&quot;editorPageCss&quot;));</span>
<span class="nc" id="L762">											cssLink += &quot;&lt;link rel='stylesheet' href='&quot;+Constants.getString(&quot;editorPageCss&quot;)+&quot;' type='text/css'/&gt;\n&quot;;</span>
										}
										else
										{
<span class="nc" id="L766">											cssLink += &quot;&lt;link rel='stylesheet' href='/css/email.css' type='text/css'/&gt;\n&quot;;</span>
										}
<span class="nc bnc" id="L768" title="All 2 branches missed.">										if (is!=null)</span>
										{
<span class="nc" id="L770">											BufferedReader br = new BufferedReader(new InputStreamReader(is, Constants.FILE_ENCODING));</span>
											String line;
<span class="nc" id="L772">											StringBuilder startBuf = new StringBuilder(cssData);</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">											while ((line=br.readLine())!=null)</span>
											{
<span class="nc" id="L775">												startBuf.append(line).append('\n');</span>
											}
<span class="nc" id="L777">											cssData = startBuf.toString();</span>
										}
									}
								}
<span class="nc" id="L781">								catch (Exception ex)</span>
								{
<span class="nc" id="L783">									Logger.error(FormMailAction.class, ex);</span>
<span class="fc" id="L784">								}</span>

<span class="fc" id="L786">								cssData += &quot;&lt;/style&gt;&quot;;</span>
							}
						}
					}
				}
			}
<span class="nc" id="L792">			catch (Exception ex)</span>
			{
<span class="nc" id="L794">				Logger.error(FormMailAction.class, ex);</span>
<span class="fc" id="L795">			}</span>
		}
<span class="pc bpc" id="L797" title="2 of 4 branches missed.">		if (fields == null || fields.toString().equals(&quot;*&quot;))</span>
		{
			//vytvor fields...
<span class="nc" id="L800">			fields = null;</span>
<span class="nc" id="L801">			autoFields = true;</span>
<span class="nc" id="L802">			Enumeration&lt;String&gt; params = request.getParameterNames();</span>
			String param;
<span class="nc bnc" id="L804" title="All 2 branches missed.">			while (params.hasMoreElements())</span>
			{
<span class="nc" id="L806">				param = params.nextElement();</span>
<span class="nc" id="L807">				param = Tools.replace(param, &quot;amp;&quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L808" title="All 6 branches missed.">				if (&quot;recipients&quot;.equals(param) || &quot;savedb&quot;.equals(param) || &quot;__lng&quot;.equals(param)) continue;</span>

<span class="nc bnc" id="L810" title="All 2 branches missed.">				if (fields == null)</span>
				{
<span class="nc" id="L812">					fields = new StringBuilder(param);</span>
				}
				else
				{
<span class="nc" id="L816">					fields.append(&quot;,&quot;).append(param);</span>
				}
			}
		}

<span class="fc" id="L821">		Logger.debug(FormMailAction.class, &quot;fields=&quot;+fields);</span>

<span class="pc bpc" id="L823" title="1 of 2 branches missed.">		boolean hasCaptchaInclude = htmlData.indexOf(&quot;captcha.jsp&quot;)!=-1;</span>
<span class="fc bfc" id="L824" title="All 2 branches covered.">		if (forceTextPlain)</span>
		{
<span class="fc" id="L826">			hasHtmlData = false;</span>
<span class="fc" id="L827">			htmlData.setLength(0);</span>
		}

<span class="fc" id="L830">		CryptoFactory cryptoFactory = new CryptoFactory();</span>
<span class="fc" id="L831">		String publicKey = request.getParameter(&quot;encryptKey&quot;);</span>

<span class="fc" id="L833">		StringBuilder db_data = null;</span>
<span class="fc" id="L834">		StringBuilder db_data_names = null;</span>
<span class="fc" id="L835">		boolean addFieldToDatabase = true;</span>
<span class="pc bpc" id="L836" title="1 of 2 branches missed.">		if (fields != null)</span>
		{
<span class="fc" id="L838">			request.setAttribute(&quot;fields&quot;, fields.toString());</span>
<span class="fc" id="L839">			StringTokenizer st = new StringTokenizer(fields.toString(), &quot;,&quot;);</span>
			String field;
			String value;

<span class="fc bfc" id="L843" title="All 2 branches covered.">			while (st.hasMoreTokens())</span>
			{
<span class="fc" id="L845">				field = st.nextToken();</span>
<span class="pc bpc" id="L846" title="1 of 2 branches missed.">				if (field == null) continue;</span>

				//tieto pre istotu preskakujeme
<span class="pc bpc" id="L849" title="4 of 8 branches missed.">				if (&quot;useFormDocId&quot;.equals(field) || &quot;g-recaptcha-response&quot;.equals(field) || &quot;bSubmit&quot;.equals(field) || &quot;__token&quot;.equals(field) ||</span>
<span class="pc bpc" id="L850" title="3 of 6 branches missed.">						&quot;addTechInfo&quot;.equals(field) || &quot;forceTextPlain&quot;.equals(field) || &quot;subject&quot;.equals(field) ||</span>
<span class="pc bpc" id="L851" title="5 of 10 branches missed.">						&quot;pictureHeight&quot;.equals(field) || &quot;maxSizeInKilobytes&quot;.equals(field) || &quot;messageAsAttachFileName&quot;.equals(field) || &quot;useFormMailDocId&quot;.equals(field) || &quot;pictureWidth&quot;.equals(field) ||</span>
<span class="pc bpc" id="L852" title="2 of 4 branches missed.">						field.startsWith(&quot;formmail&quot;) || &quot;useFormDocIdOriginal&quot;.equals(field)) continue;</span>

<span class="fc" id="L854">				value = getValue(field, request, formFilesTable);</span>
<span class="fc" id="L855">				String fieldText = field;</span>
<span class="fc bfc" id="L856" title="All 2 branches covered.">				if (forceTextPlain) fieldText = fieldToText(fieldText, labelsTable);</span>

<span class="fc" id="L858">				value = value.replace('|', ' ');</span>
<span class="fc" id="L859">				field = field.replace('|', ' ');</span>

<span class="fc" id="L861">				RequestBean.addAllowedParameter(field);</span>

<span class="pc bpc" id="L863" title="5 of 6 branches missed.">				if (autoFields &amp;&amp; htmlData != null &amp;&amp; hasHtmlData)</span>
				{
					//do databazy pridavame iba fieldy ktore sa najdu v HTML
<span class="nc bnc" id="L866" title="All 2 branches missed.">					if (htmlData.indexOf(&quot;!&quot; + field + &quot;!&quot;) != -1)</span>
					{
<span class="nc" id="L868">						addFieldToDatabase = true;</span>
					}
					else
					{
<span class="nc" id="L872">						addFieldToDatabase = false;</span>
					}
				}
				else
				{
<span class="fc" id="L877">					addFieldToDatabase = true;</span>
				}

<span class="pc bpc" id="L880" title="1 of 2 branches missed.">				if (addFieldToDatabase)</span>
				{
<span class="fc bfc" id="L882" title="All 2 branches covered.">					if (db_data == null)</span>
					{
<span class="fc" id="L884">						db_data = new StringBuilder(field + &quot;~&quot; + cryptoFactory.encrypt(value, publicKey));</span>
<span class="fc" id="L885">						db_data_names = new StringBuilder(field);</span>
					}
					else
					{
<span class="pc bpc" id="L889" title="1 of 2 branches missed.">						if (db_data_names == null) db_data_names = new StringBuilder();</span>
<span class="fc" id="L890">						db_data.append(&quot;|&quot;).append(field).append(&quot;~&quot;).append(cryptoFactory.encrypt(value, publicKey));</span>
<span class="fc" id="L891">						db_data_names.append(&quot;|~&quot;).append(field);</span>
					}
				}
				try
				{
<span class="pc bpc" id="L896" title="1 of 4 branches missed.">					if (htmlData != null &amp;&amp; hasHtmlData)</span>
					{
						//ak je to nieco ako Hodnota_checkboxu zmen to na Hodnota checkboxu
<span class="fc bfc" id="L899" title="All 4 branches covered.">						if (value.indexOf(' ') == -1 &amp;&amp; value.indexOf('@')==-1)</span>
						{
<span class="fc" id="L901">							value = value.replace('_', ' ');</span>
						}
						//nahradu spravim len v pripade, ked nie je pouzity specialny tvar HTML kodu
<span class="pc bpc" id="L904" title="3 of 4 branches missed.">						if (value.length() &lt; 1 &amp;&amp; Tools.isEmpty(source))</span>
						{
<span class="nc" id="L906">							value = &quot;&amp;nbsp;&quot;;</span>
						}
<span class="fc" id="L908">						value = Tools.replace(value, &quot;\n&quot;, &quot;&lt;br&gt;&quot;);</span>
<span class="fc" id="L909">						htmlData = Tools.replace(htmlData, &quot;!&quot; + field + &quot;!&quot;, value);</span>
					}
					else
					{
						//asi checkbox
<span class="pc bpc" id="L914" title="1 of 4 branches missed.">						if (&quot;true&quot;.equals(value) || &quot;on&quot;.equals(value)) value = &quot;[X]&quot;;</span>
<span class="fc" id="L915">						fieldText = field;</span>
<span class="pc bpc" id="L916" title="1 of 2 branches missed.">						if (forceTextPlain) fieldText = fieldToText(fieldText, labelsTable);</span>
<span class="fc" id="L917">						htmlData.append(fieldText).append(&quot;: &quot;).append(value).append(&quot;\n&quot;);</span>
					}
				}
<span class="nc" id="L920">				catch (Exception ex)</span>
				{
<span class="nc" id="L922">					Logger.error(FormMailAction.class, ex);</span>
<span class="fc" id="L923">				}</span>
<span class="fc" id="L924">			}</span>
		}

<span class="fc bfc" id="L927" title="All 2 branches covered.">		if (&quot;true&quot;.equals(request.getParameter(&quot;addTechInfo&quot;)))</span>
		{
<span class="fc" id="L929">			String techInfoHtml = prop.getText(&quot;components.formsimple.techinfo&quot;);</span>
<span class="fc" id="L930">			techInfoHtml = ShowDoc.updateCodes(null, techInfoHtml, docId, request, Constants.getServletContext());</span>
<span class="pc bpc" id="L931" title="1 of 2 branches missed.">			if (forceTextPlain)</span>
			{
<span class="nc" id="L933">				techInfoHtml = SearchTools.htmlToPlain(techInfoHtml);</span>
			}
<span class="fc" id="L935">			htmlData.append(&quot;\n\n&quot;).append(techInfoHtml);</span>
		}

		//ak je nastavene beforePostMethod tak to sem dokaze nastavit return parametre
<span class="fc" id="L939">		String beforePostReturnParams = null;</span>

		//ak aktualizujeme zaznam, toto potom nastavime na false, aby sa nic neposlalo
<span class="fc" id="L942">		boolean emailAllowed = true;</span>

		//kontrola recipients voci povodnemu HTML kodu
<span class="pc bpc" id="L945" title="2 of 4 branches missed.">		if (originalPageHtml!=null &amp;&amp; Tools.isNotEmpty(originalPageHtml))</span>
		{
<span class="pc bpc" id="L947" title="4 of 8 branches missed.">			if (recipients!=null &amp;&amp; Tools.isNotEmpty(recipients) &amp;&amp; Constants.getBoolean(&quot;spamProtection&quot;) &amp;&amp; !&quot;true&quot;.equals(request.getAttribute(&quot;DBrecipients&quot;))) //DBrecipients sa nastavi v fillRequestWithDatabaseOptions</span>
			{
				int j;
<span class="nc" id="L950">				String[] recipientsArray = recipients.toLowerCase().split(&quot;,&quot;);</span>

<span class="nc" id="L952">				String pageHtmlLC = originalPageHtml.toLowerCase();</span>
<span class="nc bnc" id="L953" title="All 2 branches missed.">				for (j=0; j&lt;recipientsArray.length; j++)</span>
				{
<span class="nc bnc" id="L955" title="All 4 branches missed.">					if (pageHtmlLC.indexOf(recipientsArray[j].trim())==-1 &amp;&amp; pageHtmlLC.indexOf(WriteTagToolsForCore.encodeEmailAddress(recipientsArray[j].trim()))==-1)</span>
					{
<span class="nc" id="L957">						emailAllowed = false;</span>
<span class="nc" id="L958">						break;</span>
					}
				}
<span class="nc" id="L961">			}</span>
		}
		else
		{
<span class="nc" id="L965">			emailAllowed = false;</span>
		}

<span class="fc" id="L968">		String allowedRecipients = Constants.getString(&quot;formmailAllowedRecipients&quot;);</span>
<span class="pc bpc" id="L969" title="1 of 2 branches missed.">		if (Tools.isEmpty(allowedRecipients)) allowedRecipients = &quot;@&quot;+Tools.getServerName(request); //aby sa nahodou nestalo, ze je niekde zabudnute nastavenie email adresy</span>
<span class="pc bpc" id="L970" title="9 of 10 branches missed.">		if (emailAllowed == false &amp;&amp; allowedRecipients!=null &amp;&amp; Tools.isNotEmpty(allowedRecipients) &amp;&amp; recipients!=null &amp;&amp; Tools.isNotEmpty(recipients))</span>
		{
			try
			{
<span class="nc" id="L974">				String[] arArray = allowedRecipients.split(&quot;,&quot;);</span>
				int i;
				int j;
<span class="nc" id="L977">				String[] recipientsArray = recipients.split(&quot;,&quot;);</span>

<span class="nc bnc" id="L979" title="All 2 branches missed.">				for (j=0; j&lt;recipientsArray.length; j++)</span>
				{
<span class="nc" id="L981">					boolean emailFound = false;</span>
<span class="nc bnc" id="L982" title="All 2 branches missed.">					for (i=0; i&lt;arArray.length; i++)</span>
					{
<span class="nc bnc" id="L984" title="All 2 branches missed.">						if (recipientsArray[j].toLowerCase().endsWith(arArray[i]))</span>
						{
<span class="nc" id="L986">							emailFound = true;</span>
						}
					}
<span class="nc bnc" id="L989" title="All 2 branches missed.">					if (emailFound)</span>
					{
<span class="nc" id="L991">						emailAllowed = true;</span>
<span class="nc" id="L992">						break;</span>
					}
				}
			}
<span class="nc" id="L996">			catch (Exception ex)</span>
			{
<span class="nc" id="L998">				Logger.error(FormMailAction.class, ex);</span>
<span class="nc" id="L999">			}</span>
		}

<span class="pc bpc" id="L1002" title="1 of 2 branches missed.">		if (&quot;cloud&quot;.equals(Constants.getInstallName()))</span>
		{
<span class="nc bnc" id="L1004" title="All 2 branches missed.">			if (Tools.isEmpty(recipients))</span>
			{
<span class="nc" id="L1006">				UserDetails admin = CloudToolsForCore.getAdmin();</span>
<span class="nc bnc" id="L1007" title="All 4 branches missed.">				if (admin != null &amp;&amp; Tools.isEmail(admin.getEmail())) recipients = admin.getEmail();</span>
			}
		}

<span class="fc" id="L1011">		boolean spamProtectionEnabled = true;</span>
<span class="pc bpc" id="L1012" title="2 of 4 branches missed.">		if (temp != null) spamProtectionEnabled = temp.isDisableSpamProtection()==false;</span>

		//DETEKCIA SPAMU
<span class="fc" id="L1015">		boolean isCaptchOk = true;</span>
<span class="pc bpc" id="L1016" title="1 of 2 branches missed.">		if (spamProtectionEnabled) {</span>
<span class="fc" id="L1017">			isCaptchOk = checkCaptcha(request, hasCaptchaInclude);</span>
		}

<span class="fc" id="L1020">		boolean isSpam = true;</span>
		//spam kontrolujeme len ak je captcha OK, inak nam zarata odoslanie a musime cakat 30 sekund
<span class="pc bpc" id="L1022" title="1 of 2 branches missed.">		if (isCaptchOk) {</span>
<span class="pc bpc" id="L1023" title="1 of 2 branches missed.">			if (spamProtectionEnabled)	isSpam = detectSpam(request, htmlData.toString(), toString(db_data_names));</span>
<span class="nc" id="L1024">			else isSpam = false;</span>
		}

<span class="fc" id="L1027">		boolean requiredFieldsOk = checkRequiredFields(request, classNames, labelsTable, context);</span>
<span class="pc bpc" id="L1028" title="1 of 2 branches missed.">		boolean areFilesOk = request.getAttribute(&quot;invalidFiles&quot;) == null;</span>
<span class="fc" id="L1029">		boolean isFormNameOk = true;</span>
<span class="fc" id="L1030">		boolean isCsrfCorrect = true;</span>
<span class="pc bpc" id="L1031" title="1 of 2 branches missed.">		if (spamProtectionEnabled) {</span>
<span class="fc" id="L1032">			isCsrfCorrect = checkCsrf(request);</span>
		}

<span class="pc bpc" id="L1035" title="3 of 4 branches missed.">		if (&quot;public&quot;.equals(Constants.getString(&quot;clusterMyNodeType&quot;)) &amp;&amp; Constants.getBoolean(&quot;formAllowOnlyExistingFormsOnPublicNode&quot;)==true)</span>
		{
			//na public node umoznime odoslat len definovane formulare
<span class="nc" id="L1038">			int recordsCount = new SimpleQuery().forInt(&quot;select count(form_name) from form_attributes where form_name=?&quot;, formName);</span>
<span class="nc bnc" id="L1039" title="All 2 branches missed.">			if (recordsCount &lt; 1)</span>
			{
<span class="nc" id="L1041">				isFormNameOk = false;</span>

				//RequestBean.setErrorText(&quot;send_mail_error.attributes&quot;);
<span class="nc" id="L1044">				RequestBean.addError(&quot;Chyba overenia atributov formularu (na public node, formular nema definovane ziadne atributy - asi neexistuje)&quot;);</span>
<span class="nc" id="L1045">				RequestBean.addParameter(&quot;formName&quot;, formName);</span>
<span class="nc" id="L1046">				RequestBean.addParameter(&quot;DBDataNames&quot;, toString(db_data_names));</span>

<span class="nc" id="L1048">				Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;&quot;, docId, -1);</span>

			}
		}

<span class="fc" id="L1053">		int formId = -1;</span>
<span class="pc bpc" id="L1054" title="6 of 14 branches missed.">		boolean validationFailed = isSpam || requiredFieldsOk==false || emailAllowed==false || areFilesOk==false || isCaptchOk==false || isFormNameOk==false || isCsrfCorrect==false;</span>
<span class="fc bfc" id="L1055" title="All 2 branches covered.">		if (validationFailed)</span>
		{
<span class="pc bpc" id="L1057" title="1 of 2 branches missed.">			if (emailAllowed==false) failStatus = &quot;probablySpamBotEmail&quot;;</span>
<span class="pc bpc" id="L1058" title="1 of 2 branches missed.">			else if (requiredFieldsOk==false) failStatus = &quot;requiredFields&quot;;</span>
<span class="pc bpc" id="L1059" title="1 of 2 branches missed.">			else if (areFilesOk==false) failStatus = &quot;bad_file&quot;;</span>
<span class="pc bpc" id="L1060" title="1 of 2 branches missed.">			else if (isCaptchOk==false) failStatus = &quot;captcha&quot;;</span>
<span class="pc bpc" id="L1061" title="1 of 2 branches missed.">			else if (isCsrfCorrect==false) failStatus = &quot;probablySpamBotCsrf&quot;;</span>
<span class="fc" id="L1062">			else failStatus = &quot;probablySpamBot&quot;;</span>

<span class="fc" id="L1064">			emailAllowed = false;</span>

			//RequestBean.setErrorText(&quot;send_mail_error.&quot; + failStatus);
<span class="fc" id="L1067">			RequestBean.addError(prop.getText(&quot;send_mail_error.&quot; + failStatus), false);</span>
<span class="fc" id="L1068">			RequestBean.addParameter(&quot;formName&quot;, request.getParameter(&quot;savedb&quot;));</span>

<span class="fc" id="L1070">			Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;&quot;, docId, formId);</span>

		}
		else
		{

			//DETEKCIA SPAMU KONIEC

<span class="fc" id="L1078">			htmlData = new StringBuilder(replaceCaptchaInclude(request, htmlData.toString()));</span>

<span class="fc" id="L1080">			StringBuilder fileNames = null;</span>
<span class="fc" id="L1081">			StringBuilder fileNamesSendLater = null;	//ak nemame SMTP server sem ukladame odkazy pre SendMail.sendLater (ma ich inak formatovane)</span>
			//oki doki, strc to do databazy

<span class="fc" id="L1084">			Logger.debug(FormMailAction.class, &quot;db_data_names=&quot;+toString(db_data_names)+&quot; db_data=&quot;+toString(db_data)+&quot; formName=&quot;+formName);</span>



<span class="fc" id="L1088">			Connection db_conn = null;</span>
<span class="fc" id="L1089">			PreparedStatement ps = null;</span>
<span class="fc" id="L1090">			ResultSet rs = null;</span>
			try
			{
<span class="pc bpc" id="L1093" title="4 of 8 branches missed.">				if (formName != null &amp;&amp; formName.length() &gt; 0 &amp;&amp; db_data_names!=null &amp;&amp; db_data_names.length()&gt;3)</span>
				{
<span class="fc" id="L1095">					db_conn = DBPool.getConnection(request);</span>
<span class="fc" id="L1096">					ps = db_conn.prepareStatement(&quot;SELECT min(id) AS id FROM forms WHERE form_name=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L1097">					ps.setString(1, formName);</span>
<span class="fc" id="L1098">					rs = ps.executeQuery();</span>
<span class="pc bpc" id="L1099" title="1 of 2 branches missed.">					if (rs.next())</span>
					{
<span class="fc" id="L1101">						formId = rs.getInt(&quot;id&quot;);</span>
					}
<span class="fc bfc" id="L1103" title="All 2 branches covered.">					if (formId &lt; 1)</span>
					{
<span class="fc" id="L1105">						formId = -1;</span>
					}

<span class="fc" id="L1108">					rs.close();</span>
<span class="fc" id="L1109">					ps.close();</span>
<span class="fc bfc" id="L1110" title="All 2 branches covered.">					if (formId == -1)</span>
					{
						//vytvor hlavicku s udajmi o datach formulara
<span class="fc" id="L1113">						ps = db_conn.prepareStatement(&quot;INSERT INTO forms (form_name, data, user_id, doc_id, domain_id) VALUES (?, ?, -1, -1, ?)&quot;);</span>
<span class="fc" id="L1114">						ps.setString(1, formName);</span>
<span class="fc" id="L1115">						DB.setClob(ps, 2, toString(db_data_names));</span>
<span class="fc" id="L1116">						ps.setInt(3, CloudToolsForCore.getDomainId());</span>
<span class="fc" id="L1117">						ps.execute();</span>
<span class="fc" id="L1118">						ps.close();</span>
					}
					else
					{
<span class="pc bpc" id="L1122" title="1 of 2 branches missed.">						if (db_data_names!=null)</span>
						{
							//hlavicka uz existuje, iba ju updatneme
<span class="fc" id="L1125">							ps = db_conn.prepareStatement(&quot;UPDATE forms SET data=? WHERE id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L1126">							DB.setClob(ps, 1, toString(db_data_names));</span>
<span class="fc" id="L1127">							ps.setInt(2, formId);</span>
<span class="fc" id="L1128">							ps.execute();</span>
<span class="fc" id="L1129">							ps.close();</span>
						}
					}

<span class="fc" id="L1133">					int userId = -1;</span>
					try
					{
<span class="fc" id="L1136">						Identity user = UsersDB.getCurrentUser(request);</span>
<span class="pc bpc" id="L1137" title="1 of 2 branches missed.">						if (user!=null)</span>
						{
<span class="fc" id="L1139">							userId = user.getUserId();</span>
						}
					}
<span class="nc" id="L1142">					catch (Exception ex)</span>
					{
<span class="nc" id="L1144">						Logger.error(FormMailAction.class, ex);</span>
<span class="fc" id="L1145">					}</span>

<span class="pc bpc" id="L1147" title="2 of 4 branches missed.">					if (userId &gt; 0 &amp;&amp; &quot;true&quot;.equals(request.getParameter(&quot;formmail_overwriteOldForms&quot;)))</span>
					{
<span class="nc" id="L1149">						ps = db_conn.prepareStatement(&quot;DELETE FROM forms WHERE form_name=? AND user_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L1150">						ps.setString(1, formName);</span>
<span class="nc" id="L1151">						ps.setInt(2, userId);</span>
<span class="nc" id="L1152">						ps.execute();</span>
<span class="nc" id="L1153">						ps.close();</span>
					}

<span class="fc" id="L1156">					boolean allowInsert = true;</span>

<span class="pc bpc" id="L1158" title="2 of 4 branches missed.">					if (userId &gt; 0 &amp;&amp; &quot;true&quot;.equals(request.getParameter(&quot;formmail_allowOnlyOneSubmit&quot;)))</span>
					{
<span class="nc" id="L1160">						ps = db_conn.prepareStatement(&quot;SELECT * FROM forms WHERE form_name=? AND user_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L1161">						ps.setString(1, formName);</span>
<span class="nc" id="L1162">						ps.setInt(2, userId);</span>
<span class="nc" id="L1163">						rs = ps.executeQuery();</span>
<span class="nc bnc" id="L1164" title="All 2 branches missed.">						if (rs.next())</span>
						{
<span class="nc" id="L1166">							emailAllowed = false;</span>
<span class="nc" id="L1167">							allowInsert = false;</span>
<span class="nc" id="L1168">							failStatus = &quot;formIsAllreadySubmitted&quot;;</span>

							//RequestBean.setServerClas(&quot;send_mail_error.formIsAllreadySubmitted&quot;);
<span class="nc" id="L1171">							RequestBean.addError(&quot;Formular sa uz odosiela&quot;);</span>
<span class="nc" id="L1172">							RequestBean.addParameter(&quot;formName&quot;, request.getParameter(&quot;savedb&quot;));</span>
<span class="nc" id="L1173">							RequestBean.addParameter(&quot;DBDataNames&quot;, toString(db_data_names));</span>

<span class="nc" id="L1175">							Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;&quot;, docId, formId);</span>

						}
<span class="nc" id="L1178">						rs.close();</span>
<span class="nc" id="L1179">						ps.close();</span>
					}

<span class="pc bpc" id="L1182" title="1 of 2 branches missed.">					if (allowInsert)</span>
					{
<span class="fc" id="L1184">						Identity user = UsersDB.getCurrentUser(request);</span>
<span class="fc" id="L1185">						int editFormId = Tools.getIntValue(request.getParameter(&quot;_editFormId&quot;), -1);</span>
<span class="fc" id="L1186">						Logger.debug(FormMailAction.class, &quot;editFormId=&quot;+editFormId);</span>
<span class="pc bpc" id="L1187" title="3 of 6 branches missed.">						if (user!=null &amp;&amp; user.isAdmin()==true &amp;&amp; editFormId&gt;0)</span>
						{
<span class="nc" id="L1189">							Logger.debug(FormMailAction.class, &quot;Updating form: &quot;+editFormId);</span>

<span class="nc" id="L1191">							ps = db_conn.prepareStatement(&quot;UPDATE forms SET data=?, html=? WHERE id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L1192">							DB.setClob(ps, 1, toString(db_data));</span>
<span class="nc" id="L1193">							DB.setClob(ps, 2, cryptoFactory.encrypt(appendStyle(htmlData.toString(), cssLink, null, forceTextPlain), publicKey));</span>
<span class="nc" id="L1194">							ps.setInt(3, editFormId);</span>
<span class="nc" id="L1195">							ps.execute();</span>
<span class="nc" id="L1196">							ps.close();</span>

<span class="nc" id="L1198">							formId = editFormId;</span>

<span class="nc" id="L1200">							emailAllowed = false;</span>
						}
						else
						{
<span class="fc" id="L1204">							long l_now = (new java.util.Date()).getTime();</span>
<span class="fc" id="L1205">							ps = db_conn.prepareStatement(&quot;INSERT INTO forms (form_name, data, create_date, html, user_id, doc_id, domain_id) VALUES (?, ?, ?, ?, ?, ?, ?)&quot;);</span>
<span class="fc" id="L1206">							ps.setString(1, formName);</span>
<span class="fc" id="L1207">							DB.setClob(ps, 2, toString(db_data));</span>
<span class="fc" id="L1208">							ps.setTimestamp(3, new Timestamp(l_now));</span>
<span class="fc" id="L1209">							DB.setClob(ps, 4, cryptoFactory.encrypt(appendStyle(htmlData.toString(), cssLink, null, forceTextPlain), publicKey));</span>
<span class="fc" id="L1210">							ps.setInt(5, userId);</span>
<span class="fc" id="L1211">							ps.setInt(6, docId);</span>
<span class="fc" id="L1212">							ps.setInt(7, CloudToolsForCore.getDomainId());</span>
<span class="fc" id="L1213">							ps.execute();</span>
<span class="fc" id="L1214">							ps.close();</span>

							//	ziskaj id zaznamu
<span class="fc" id="L1217">							ps = db_conn.prepareStatement(&quot;SELECT max(id) AS id FROM forms WHERE form_name=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L1218">							ps.setString(1, formName);</span>
<span class="fc" id="L1219">							rs = ps.executeQuery();</span>
<span class="pc bpc" id="L1220" title="1 of 2 branches missed.">							if (rs.next())</span>
							{
<span class="fc" id="L1222">								formId = rs.getInt(&quot;id&quot;);</span>
							}
<span class="fc" id="L1224">							rs.close();</span>
<span class="fc" id="L1225">							ps.close();</span>

							try
							{
								//v try je to preto, ze som si nie isty ci Oracle zvladne zapis !=
								//updatni doc_id, pretoze historicky moze byt zapisane zle
<span class="fc" id="L1231">								ps = db_conn.prepareStatement(&quot;UPDATE forms SET doc_id=? WHERE form_name=? AND doc_id&gt;0 AND doc_id!=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L1232">								ps.setInt(1, docId);</span>
<span class="fc" id="L1233">								ps.setString(2, formName);</span>
<span class="fc" id="L1234">								ps.setInt(3, docId);</span>
<span class="fc" id="L1235">								ps.execute();</span>
<span class="fc" id="L1236">								ps.close();</span>
							}
<span class="nc" id="L1238">							catch (Exception ex2)</span>
							{
								//nerobime nic
<span class="fc" id="L1241">							}</span>
						}

<span class="fc" id="L1244">						request.setAttribute(&quot;formMailFormFormId&quot;, Integer.toString(formId));</span>

<span class="fc" id="L1246">						String pdfUrl = &quot;&quot;;</span>
<span class="fc" id="L1247">						attachs = new ArrayList&lt;&gt;();</span>

<span class="pc bpc" id="L1249" title="1 of 2 branches missed.">						if(&quot;true&quot;.equals(request.getParameter(&quot;isPdfVersion&quot;)))</span>
						{
<span class="nc" id="L1251">							pdfUrl = saveFormAsPdf(appendStyle(htmlData.toString(), cssData, null, forceTextPlain), formId, request);</span>
<span class="nc" id="L1252">							IwcmFile pdfFile =  new IwcmFile(pdfUrl);</span>
							//fileNames = new StringBuilder(pdfFile.getVirtualPath() + &quot;;&quot; + pdfFile.getName());
<span class="nc bnc" id="L1254" title="All 2 branches missed.">							if (fileNames == null) fileNames = new StringBuilder();</span>
<span class="nc bnc" id="L1255" title="All 2 branches missed.">							if (fileNames.length()&gt;0) fileNames.append(&quot;;&quot;);</span>
<span class="nc" id="L1256">							fileNames.append(pdfFile.getName());</span>

							//fileNamesSendLater = new StringBuilder();
<span class="nc bnc" id="L1259" title="All 2 branches missed.">							if (fileNamesSendLater == null) fileNamesSendLater = new StringBuilder();</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">							if (fileNamesSendLater.length()&gt;0) fileNamesSendLater.append(&quot;;&quot;);</span>
<span class="nc" id="L1261">							fileNamesSendLater.append(FORM_FILE_DIR).append(pdfFile.getName()).append(&quot;;&quot;).append(pdfFile.getName());</span>
<span class="nc" id="L1262">							attachs.add(new IwcmFile(pdfUrl));</span>
						}

						//ak su aj subory
<span class="pc bpc" id="L1266" title="1 of 2 branches missed.">						if (formFiles.size() &gt; 0)</span>
						{
							//skopiruj subory
							String newFileName;
<span class="nc" id="L1270">							String path = Tools.getRealPath(FORM_FILE_DIR);</span>
<span class="nc bnc" id="L1271" title="All 2 branches missed.">							if (path != null)</span>
							{
								String fileName;
<span class="nc bnc" id="L1274" title="All 2 branches missed.">								for (UploadedFile formFile : formFiles)</span>
								{
<span class="nc" id="L1276">									fileName = fixFileNameDirPath(formFile.getFileName().trim());</span>

									//Logger.println(this,&quot;we have a file name=&quot;+fileName+&quot; content type=&quot;+file.getContentType());

<span class="nc bnc" id="L1280" title="All 4 branches missed.">									if (fileName != null &amp;&amp; fileName.length() &gt; 1)</span>
									{
<span class="nc" id="L1282">										InputStream stream = formFile.getInputStream();</span>

<span class="nc" id="L1284">										newFileName = formId + &quot;_&quot; +</span>
<span class="nc" id="L1285">												DocTools.removeChars(</span>
<span class="nc" id="L1286">														DB.internationalToEnglish(fileName));</span>

<span class="nc bnc" id="L1288" title="All 2 branches missed.">										if (&quot;false&quot;.equals(Constants.getString(&quot;useSMTPServer&quot;)))</span>
										{
<span class="nc bnc" id="L1290" title="All 2 branches missed.">											if (fileNamesSendLater == null)</span>
											{
<span class="nc" id="L1292">												fileNamesSendLater = new StringBuilder(FORM_FILE_DIR + newFileName+&quot;;&quot;+fileName);</span>
											}
											else
											{
<span class="nc" id="L1296">												fileNamesSendLater.append(&quot;;&quot;).append(FORM_FILE_DIR).append(newFileName).append(&quot;;&quot;).append(fileName);</span>
											}
										}

<span class="nc bnc" id="L1300" title="All 2 branches missed.">										if (fileNames == null)</span>
										{
<span class="nc" id="L1302">											fileNames = new StringBuilder(newFileName);</span>
										}
										else
										{
<span class="nc" id="L1306">											fileNames.append(&quot;,&quot;).append(newFileName);</span>
										}

<span class="nc bnc" id="L1309" title="All 2 branches missed.">										if (!path.endsWith(Character.toString(File.separatorChar)))</span>
										{
<span class="nc" id="L1311">											path = path + File.separatorChar; //NOSONAR</span>
										}
<span class="nc" id="L1313">										IwcmFile fullPath = new IwcmFile(path + newFileName);</span>
<span class="nc" id="L1314">										fullPath.mkdirs();</span>
<span class="nc" id="L1315">										fullPath.delete();</span>
<span class="nc" id="L1316">										fullPath.createNewFile();</span>
<span class="nc" id="L1317">										attachs.add(fullPath);</span>

<span class="nc" id="L1319">										IwcmFsDB.writeFiletoDest(stream,new File(fullPath.getPath()),formFile.getFileSize());</span>
									}
<span class="nc" id="L1321">								}</span>
							}
						}

						//MBO: kukni ci tam neni nejaky multiupload
						//je mozne ze boli uploadovane subory
<span class="pc bpc" id="L1327" title="3 of 4 branches missed.">						if (uploadedFilesParamNameList != null &amp;&amp; uploadedFilesParamNameList.length&gt;0)</span>
						{
<span class="nc bnc" id="L1329" title="All 2 branches missed.">							for (String uploadedFilesParamName : uploadedFilesParamNameList)</span>
							{
<span class="nc" id="L1331">								String baseDirName = PathFilter.getRealPath(FORM_FILE_DIR + &quot;/&quot;);</span>
<span class="nc" id="L1332">								IwcmFile dir = new IwcmFile(baseDirName);</span>
<span class="nc bnc" id="L1333" title="All 2 branches missed.">								if (!dir.exists()) dir.mkdirs();</span>
<span class="nc bnc" id="L1334" title="All 2 branches missed.">								if (Tools.isNotEmpty(request.getParameter(uploadedFilesParamName)))</span>
								{
<span class="nc bnc" id="L1336" title="All 2 branches missed.">									for (String keys : request.getParameterValues(uploadedFilesParamName))</span>
									{
<span class="nc bnc" id="L1338" title="All 2 branches missed.">										for (String param : Tools.getTokens(keys, &quot;;&quot;))</span>
										{
<span class="nc" id="L1340">											String fileName = XhrFileUploadServlet.moveFile(param, baseDirName + File.separator);</span>
<span class="nc" id="L1341">											IwcmFile file = new IwcmFile(dir, fileName);</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">											if (file.exists())</span>
											{
<span class="nc" id="L1344">												IwcmFile dest = new IwcmFile(dir, formId + &quot;_&quot; + fileName);</span>
<span class="nc" id="L1345">												file.renameTo(dest);</span>
<span class="nc bnc" id="L1346" title="All 2 branches missed.">												if (dest.exists())</span>
												{
<span class="nc bnc" id="L1348" title="All 2 branches missed.">													if (fileNames == null)</span>
													{
<span class="nc" id="L1350">														fileNames = new StringBuilder(dest.getName());</span>
													} else
													{
<span class="nc" id="L1353">														fileNames.append(&quot;,&quot;).append(dest.getName());</span>
													}
<span class="nc bnc" id="L1355" title="All 2 branches missed.">													if (&quot;false&quot;.equals(Constants.getString(&quot;useSMTPServer&quot;))) {</span>
<span class="nc bnc" id="L1356" title="All 2 branches missed.">														if (fileNamesSendLater==null) fileNamesSendLater = new StringBuilder();</span>
<span class="nc" id="L1357">														fileNamesSendLater.append(&quot;;&quot;).append(dest.getVirtualPath()).append(&quot;;&quot;).append(dest.getName());</span>
													}


<span class="nc" id="L1361">													attachs.add(dest);</span>
												}
											}
										}
									}
								}
							}
						}

<span class="pc bpc" id="L1370" title="1 of 2 branches missed.">						if(attachs != null)</span>
						{
<span class="fc" id="L1372">							long size = 0;</span>
<span class="pc bpc" id="L1373" title="1 of 2 branches missed.">							if (attachs != null)</span>
							{
								//ak je velkost prilohy vacsia ako stanovena hranica, prilohy k mailu nepripojim
<span class="pc bpc" id="L1376" title="1 of 2 branches missed.">								for(IwcmFile file : attachs)</span>
								{
<span class="nc" id="L1378">									size += file.length();</span>
<span class="nc bnc" id="L1379" title="All 2 branches missed.">									if(size &gt; Constants.getLong(&quot;maxSizeOfAttachments&quot;)) attachFiles = false;</span>
<span class="nc" id="L1380">								}</span>
							}

							//updatni DB
<span class="fc" id="L1384">							ps = db_conn.prepareStatement(&quot;UPDATE forms SET files=? WHERE id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L1385">							DB.setClob(ps, 1, toString(fileNames));</span>
<span class="fc" id="L1386">							ps.setInt(2, formId);</span>
<span class="fc" id="L1387">							ps.execute();</span>
<span class="fc" id="L1388">							ps.close();</span>

<span class="pc bpc" id="L1390" title="1 of 2 branches missed.">							if(!attachFiles)</span>
							{
<span class="nc" id="L1392">								fileNamesSendLater = null;</span>
<span class="nc" id="L1393">								Logger.println(FormMailAction.class, &quot;Nepripajam prilohy do e-mailu: prekorocena max. velkost priloh=&quot;+size);</span>
							}
						}
					}
<span class="fc" id="L1397">					db_conn.close();</span>
<span class="fc" id="L1398">					db_conn = null;</span>
				}
			}
<span class="nc" id="L1401">			catch (Exception ex)</span>
			{
<span class="nc" id="L1403">				Logger.error(FormMailAction.class, ex);</span>


				//RequestBean.setServerClas(&quot;send_mail_error.savedb&quot;);
<span class="nc" id="L1407">				RequestBean.addError(&quot;Nastala chyba pri ukladani formularu - &quot; + ex.getMessage());</span>
<span class="nc" id="L1408">				RequestBean.addParameter(&quot;formName&quot;, request.getParameter(&quot;savedb&quot;));</span>
<span class="nc" id="L1409">				RequestBean.addParameter(&quot;DBDataNames&quot;, toString(db_data_names));</span>


<span class="nc" id="L1412">				Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;&quot;, docId, formId);</span>

<span class="nc" id="L1414">				failStatus = &quot;savedb&quot;;</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L1420" title="1 of 2 branches missed.">					if (rs != null) rs.close();</span>
<span class="pc bpc" id="L1421" title="1 of 2 branches missed.">					if (ps != null) ps.close();</span>
<span class="pc bpc" id="L1422" title="1 of 2 branches missed.">					if (db_conn != null) db_conn.close();</span>
				}
<span class="nc" id="L1424">				catch (Exception e)</span>
				{
					//nerobime nic
<span class="fc" id="L1427">				}</span>
			}

<span class="fc" id="L1430">			int sendUserInfoDocId = Tools.getIntValue(request.getParameter(&quot;formmail_sendUserInfoDocId&quot;), -1);</span>
<span class="fc" id="L1431">			Logger.debug(FormMailAction.class,&quot;sendUserInfoDocId=&quot;+sendUserInfoDocId+&quot; email=&quot;+email);</span>
<span class="pc bpc" id="L1432" title="1 of 2 branches missed.">			if (sendUserInfoDocId&gt;0)</span>
			{
<span class="nc" id="L1434">				sendUserInfo(sendUserInfoDocId, formId, email, attachs, formFilesTable, request);</span>
			}

<span class="fc" id="L1437">			Logger.println(FormMailAction.class,&quot;FormMailAction emailAllowed=&quot;+emailAllowed+&quot; recipients=&quot;+recipients);</span>

			//RequestBean.addAllowedParameter(&quot;recipients&quot;);
<span class="fc" id="L1440">			RequestBean.addParameter(&quot;recipients&quot;, new String[]{recipients});</span>
<span class="fc" id="L1441">			RequestBean.addParameter(&quot;formName&quot;, request.getParameter(&quot;savedb&quot;));</span>
<span class="fc" id="L1442">			RequestBean.addParameter(&quot;DBDataNames&quot;, toString(db_data_names));</span>

<span class="fc" id="L1444">			String beforePostMethod = request.getParameter(&quot;beforePostMethod&quot;);</span>
<span class="pc bpc" id="L1445" title="3 of 4 branches missed.">			if (Tools.isNotEmpty(request.getParameter(&quot;afterSendInterceptor&quot;))&amp;&amp;&quot;true&quot;.equals(request.getAttribute(&quot;DBafterSendInterceptor&quot;))) beforePostMethod = request.getParameter(&quot;afterSendInterceptor&quot;);</span>
<span class="pc bpc" id="L1446" title="1 of 2 branches missed.">			if (Tools.isEmpty(beforePostMethod)) beforePostMethod = Constants.getString(&quot;formMailBeforePostMethod&quot;);</span>

<span class="pc bpc" id="L1448" title="3 of 4 branches missed.">			if (Tools.isNotEmpty(beforePostMethod) &amp;&amp; Tools.isEmpty(recipients))</span>
			{
				//ked mame nastaveny interceptor je potrebne vojst nizsie aj ked nie je vyplneny email formularu (lebo sa to niekomu nezdalo vhodne)
				//je to tak preto, aby sa interceptor vobec zavolal (TB-specific)
<span class="nc" id="L1452">				recipients = Constants.getString(&quot;emailProtectionSenderEmail&quot;);</span>
			}

<span class="pc bpc" id="L1455" title="4 of 8 branches missed.">			if (emailAllowed &amp;&amp; &quot;nobody@nowhere.com&quot;.equals(recipients)==false &amp;&amp; recipients!=null &amp;&amp; recipients.contains(&quot;@&quot;))</span>
			{
<span class="pc bpc" id="L1457" title="2 of 4 branches missed.">				if (email == null || email.indexOf('@')==-1)</span>
				{
<span class="fc" id="L1459">					String emailProtectionSenderEmail = Constants.getString(SendMail.EMAIL_PROTECTION_SENDER_KEY);</span>
<span class="pc bpc" id="L1460" title="1 of 2 branches missed.">					if (Tools.isEmail(emailProtectionSenderEmail))</span>
					{
<span class="nc" id="L1462">						email = emailProtectionSenderEmail;</span>
					}
					else
					{
						//skus nastavit odosielatela ako prijemcu
<span class="fc" id="L1467">						String[] emails = recipients.split(&quot;,&quot;);</span>
<span class="pc bpc" id="L1468" title="2 of 4 branches missed.">						if (emails != null &amp;&amp; emails.length &gt; 0)</span>
						{
<span class="fc" id="L1470">							email = emails[0];</span>
						} else
						{
<span class="nc" id="L1473">							email = &quot;webform@&quot; + Tools.getServerName(request);</span>
						}
					}
				}
<span class="pc bpc" id="L1477" title="2 of 4 branches missed.">				if (meno == null || meno.trim().length() &lt; 1)</span>
				{
<span class="fc" id="L1479">					meno = email;</span>
				}

<span class="pc bpc" id="L1482" title="1 of 4 branches missed.">				if (Constants.getBoolean(&quot;formMailSendPlainText&quot;) || forceTextPlain)</span>
				{
<span class="fc" id="L1484">					htmlData = new StringBuilder(SearchTools.htmlToPlain(htmlData.toString()));</span>
<span class="fc" id="L1485">					cssData = null;</span>
				}
				else
				{
<span class="fc" id="L1489">					htmlData = new StringBuilder(SearchTools.removeCommands(htmlData.toString()));	//odstranim z HTML riadiace bloky napr.: !INCLUDE(...)!, !PARAMETER(...)!</span>
				}

<span class="pc bpc" id="L1492" title="1 of 2 branches missed.">				if (emailEncoding.indexOf(&quot;ASCII&quot;)!=-1) htmlData = new StringBuilder(DB.internationalToEnglish(htmlData.toString()));</span>
<span class="fc" id="L1493">				htmlData = new StringBuilder(createAbsolutePath(htmlData.toString(), request));</span>
<span class="fc" id="L1494">				cssData = createAbsolutePath(cssData, request);</span>

<span class="fc" id="L1496">				boolean sendMessageAsAttach = &quot;true&quot;.equals(request.getParameter(&quot;messageAsAttach&quot;));</span>
<span class="fc" id="L1497">				IwcmFile messageAsAttachFile = null;</span>
<span class="pc bpc" id="L1498" title="1 of 2 branches missed.">				if(sendMessageAsAttach)</span>
				{
<span class="nc" id="L1500">					String messageAsAttachFileName = request.getParameter(&quot;messageAsAttachFileName&quot;);</span>
<span class="nc bnc" id="L1501" title="All 2 branches missed.">					if(Tools.isEmpty(messageAsAttachFileName)) messageAsAttachFileName = &quot;priloha.html&quot;;</span>
<span class="nc" id="L1502">					else messageAsAttachFileName = DocTools.removeChars(messageAsAttachFileName);</span>
<span class="nc" id="L1503">					messageAsAttachFile = new IwcmFile(Tools.getRealPath(FORM_FILE_DIR + File.separator + formId+&quot;_&quot;+messageAsAttachFileName));</span>
<span class="nc bnc" id="L1504" title="All 2 branches missed.">					FileTools.saveFileContent(messageAsAttachFile.getVirtualPath(), &quot;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=&quot;+emailEncoding+&quot;\&quot;&gt;&quot;+(cssData == null ? &quot;&quot; : cssData)+&quot;&lt;/head&gt;&lt;body id=\&quot;WebJETEditorBody\&quot; class=\&quot;WebJETMailBody\&quot;&gt;&lt;div class=\&quot;WebJETMailWrapper\&quot;&gt;\n\n&quot;+htmlData+&quot;\n\n&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;, emailEncoding);</span>
				}

<span class="pc bpc" id="L1507" title="1 of 2 branches missed.">				if (&quot;false&quot;.equals(Constants.getString(&quot;useSMTPServer&quot;)))</span>
				{
<span class="nc bnc" id="L1509" title="All 4 branches missed.">					if(sendMessageAsAttach &amp;&amp; messageAsAttachFile!=null)</span>
					{
<span class="nc" id="L1511">						htmlData = new StringBuilder(prop.getText(&quot;form.formmailaction.pozrite_si_prilozeny_subor&quot;));</span>
<span class="nc bnc" id="L1512" title="All 2 branches missed.">						if (fileNamesSendLater == null) fileNamesSendLater = new StringBuilder();</span>
<span class="nc" id="L1513">						fileNamesSendLater.append(&quot;;&quot;).append(FORM_FILE_DIR).append(messageAsAttachFile.getName()).append(&quot;;&quot;).append(messageAsAttachFile.getName());</span>
					}
<span class="nc bnc" id="L1515" title="All 4 branches missed.">					if(attachs != null &amp;&amp; !attachFiles) htmlData.append(prop.getText(&quot;email.too_large_attachments&quot;));</span>

<span class="nc" id="L1517">					String messageBody = htmlData.toString();</span>
<span class="nc bnc" id="L1518" title="All 4 branches missed.">					if (sendMessageAsAttach==false &amp;&amp; forceTextPlain==false)</span>
					{
<span class="nc" id="L1520">						messageBody = appendStyle(htmlData.toString(), cssData, emailEncoding, forceTextPlain);</span>
					}

					// interceptor pre send later
<span class="nc bnc" id="L1524" title="All 2 branches missed.">					if(canCallInterceptor(beforePostMethod)) {</span>
<span class="nc" id="L1525">						MimeMessage message = new MimeMessage(Session.getInstance(new Properties()));</span>
<span class="nc" id="L1526">						Multipart multipart = new MimeMultipart();</span>
<span class="nc" id="L1527">						BodyPart mbp = new MimeBodyPart();</span>

						try {
<span class="nc" id="L1530">							mbp.setContent(messageBody, &quot;text/html; &quot; + emailEncoding);</span>
<span class="nc" id="L1531">							multipart.addBodyPart(mbp);</span>
<span class="nc" id="L1532">							message.setContent(multipart);</span>
<span class="nc" id="L1533">						} catch (MessagingException e) {</span>
<span class="nc" id="L1534">							sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L1535">						}</span>

<span class="nc" id="L1537">						beforePostReturnParams = callInterceptor(beforePostMethod, message, multipart, request);</span>
<span class="nc bnc" id="L1538" title="All 2 branches missed.">						if(hasInterceptorFailed(beforePostReturnParams)) {</span>
<span class="nc" id="L1539">							failStatus = &quot;beforePostMethod&quot;;</span>
						}

						try {
<span class="nc" id="L1543">							messageBody = (String) multipart.getBodyPart(0).getContent();</span>
<span class="nc" id="L1544">						} catch (Exception e) {</span>
<span class="nc" id="L1545">							sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L1546">						}</span>
					}

<span class="nc" id="L1549">					Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;Formular &quot;+formName+&quot; uspesne ulozeny do databazy, odoslany bude neskor&quot;, docId, formId);</span>

					//musime kvoli clustru a potencionalnemu zapisu suborov pozdrzat email
<span class="nc" id="L1552">					long sendLaterTime = Tools.getNow();</span>
<span class="nc" id="L1553">					sendLaterTime += (5 * Constants.getInt(&quot;clusterRefreshTimeout&quot;));</span>

<span class="nc" id="L1555">					SendMail.sendLater(meno, getFirstEmail(email), recipients, request.getParameter(&quot;replyTo&quot;), request.getParameter(&quot;ccEmails&quot;), request.getParameter(&quot;bccEmails&quot;), subject, messageBody, Tools.getBaseHref(request), Tools.formatDate(sendLaterTime), Tools.formatTime(sendLaterTime), toString(fileNamesSendLater));</span>
<span class="nc" id="L1556">				}</span>
				else
				{
					//vygeneruj mail a posli ho
<span class="fc" id="L1560">					Properties props = System.getProperties();</span>

					try
					{
<span class="pc bpc" id="L1564" title="2 of 4 branches missed.">						if (host != null &amp;&amp; host.length() &gt; 2)</span>
						{
<span class="fc" id="L1566">							props.put(&quot;mail.smtp.host&quot;, host);</span>
						}
<span class="nc bnc" id="L1568" title="All 2 branches missed.">						else if (props.getProperty(&quot;mail.smtp.host&quot;) == null)</span>
						{
<span class="nc" id="L1570">							props.put(&quot;mail.smtp.host&quot;, InetAddress.getLocalHost().getHostName());</span>
						}
					}
<span class="nc" id="L1573">					catch (Exception ex)</span>
					{
<span class="nc" id="L1575">						Logger.error(FormMailAction.class, ex);</span>
<span class="fc" id="L1576">					}</span>

<span class="fc" id="L1578">					Session session = SendMail.getSession(props);</span>

<span class="fc" id="L1580">					MimeMessage msg = new MimeMessage(session);</span>
<span class="fc" id="L1581">					InternetAddress[] toAddrs = null;</span>

					try
					{
						//este potrebujeme updatnut linky na subory

<span class="fc" id="L1587">						FormDetails formDetails = new FormDetails();</span>
<span class="fc" id="L1588">						formDetails.setFiles(toString(fileNames));</span>

						//updatni linky na attachementy
<span class="fc" id="L1591">						String baseHref = Tools.getBaseHref(request);</span>
<span class="fc" id="L1592">						htmlData = Tools.replace(htmlData, &quot;!ATTACHMENTS!&quot;, formDetails.getAttachements(baseHref));</span>

						try
						{
<span class="fc" id="L1596">							String proxyHost = request.getHeader(&quot;x-forwarded-for&quot;);</span>
<span class="pc bpc" id="L1597" title="3 of 4 branches missed.">							if (proxyHost != null &amp;&amp; proxyHost.length()&gt;4)</span>
							{
<span class="nc" id="L1599">								msg.setHeader(&quot;X-sender-proxy&quot;, proxyHost);</span>
							}

<span class="fc" id="L1602">							msg.setHeader(&quot;X-sender-ip&quot;, Tools.getRemoteIP(request));</span>
<span class="fc" id="L1603">							msg.setHeader(&quot;X-sender-host&quot;, Tools.getRemoteHost(request));</span>
<span class="fc" id="L1604">							msg.setHeader(&quot;X-server-name&quot;, Tools.getServerName(request));</span>
<span class="fc" id="L1605">							Identity user = UsersDB.getCurrentUser(request);</span>
<span class="pc bpc" id="L1606" title="1 of 2 branches missed.">							if (user!=null)</span>
							{
<span class="fc" id="L1608">								msg.setHeader(&quot;X-sender-userid&quot;, Integer.toString(user.getUserId()));</span>
<span class="fc" id="L1609">								msg.setHeader(&quot;X-sender-fullname&quot;, DB.internationalToEnglish(user.getFullName()));</span>
							}
						}
<span class="nc" id="L1612">						catch (Exception ex)</span>
						{
<span class="nc" id="L1614">							Logger.error(FormMailAction.class, ex);</span>
<span class="fc" id="L1615">						}</span>

<span class="fc" id="L1617">						toAddrs = InternetAddress.parse(recipients, false);</span>
<span class="fc" id="L1618">						msg.setRecipients(Message.RecipientType.TO, toAddrs);</span>

<span class="fc" id="L1620">						String ccEmails = request.getParameter(&quot;ccEmails&quot;);</span>
<span class="pc bpc" id="L1621" title="3 of 4 branches missed.">						if (ccEmails != null &amp;&amp; ccEmails.indexOf('@')!=-1)</span>
						{
<span class="nc" id="L1623">							InternetAddress[] ccAddrs = InternetAddress.parse(ccEmails, false);</span>
<span class="nc" id="L1624">							msg.setRecipients(Message.RecipientType.CC, ccAddrs);</span>
						}
<span class="fc" id="L1626">						String bccEmails = request.getParameter(&quot;bccEmails&quot;);</span>
<span class="pc bpc" id="L1627" title="3 of 4 branches missed.">						if (bccEmails != null &amp;&amp; bccEmails.indexOf('@')!=-1)</span>
						{
<span class="nc" id="L1629">							InternetAddress[] bccAddrs = InternetAddress.parse(bccEmails, false);</span>
<span class="nc" id="L1630">							msg.setRecipients(Message.RecipientType.BCC, bccAddrs);</span>
						}

<span class="fc" id="L1633">						String from = email;</span>
<span class="fc" id="L1634">						msg.setFrom(new InternetAddress(getFirstEmail(email), meno));</span>

						//iteruj cez polozky formularu
<span class="fc" id="L1637">						String fieldsEmailHeader = request.getParameter(&quot;fieldsEmailHeader&quot;);</span>
<span class="pc bpc" id="L1638" title="1 of 2 branches missed.">						if (fieldsEmailHeader != null)</span>
						{
<span class="nc" id="L1640">							StringTokenizer st = new StringTokenizer(fieldsEmailHeader, &quot;,&quot;);</span>
							String field;
							String value;
<span class="nc bnc" id="L1643" title="All 2 branches missed.">							while (st.hasMoreTokens())</span>
							{
<span class="nc" id="L1645">								field = st.nextToken();</span>
<span class="nc" id="L1646">								value = DB.internationalToEnglish(recode(request.getParameter(field)));</span>
<span class="nc" id="L1647">								msg.setHeader(field, value);</span>
							}
						}

						//subject = new String(subject.getBytes(), emailEncoding);
						//msg.setSubject(subject);
<span class="fc" id="L1653">						msg.setSubject(MimeUtility.encodeText(subject, emailEncoding, null));</span>

<span class="fc" id="L1655">						msg.setSentDate(new java.util.Date());</span>

						//msg.setText(body);

						//MimeBodyPart text = new MimeBodyPart();

<span class="fc" id="L1661">						MimeBodyPart html = new MimeBodyPart();</span>

						//htmlData = new String(htmlData.getBytes(EMAIL_ENCODING));

<span class="pc bpc" id="L1665" title="1 of 2 branches missed.">						if(sendMessageAsAttach) htmlData = new StringBuilder(prop.getText(&quot;form.formmailaction.pozrite_si_prilozeny_subor&quot;));</span>
<span class="pc bpc" id="L1666" title="2 of 4 branches missed.">						if(attachs != null &amp;&amp; !attachFiles) htmlData.append(prop.getText(&quot;email.too_large_attachments&quot;));</span>

						//odstran diakritiku
<span class="pc bpc" id="L1669" title="1 of 2 branches missed.">						if (emailEncoding.indexOf(&quot;ASCII&quot;)!=-1)</span>
						{
<span class="nc" id="L1671">							htmlData = new StringBuilder(DB.internationalToEnglish(htmlData.toString()));</span>
						}

						//test ci je to HTML content, alebo nie. &lt;br&gt; za HTML content nepovazujem
<span class="fc" id="L1675">						String htmlDataNoBR = Tools.replace(htmlData.toString(), &quot;&lt;br&gt;&quot;, &quot;\n&quot;);</span>
<span class="fc" id="L1676">						htmlDataNoBR = Tools.replace(htmlDataNoBR, &quot;&lt;br/&gt;&quot;, &quot;\n&quot;);</span>
<span class="pc bpc" id="L1677" title="1 of 4 branches missed.">						if (htmlDataNoBR.indexOf('&lt;') != -1 &amp;&amp; htmlDataNoBR.indexOf('&gt;') != -1)</span>
						{
<span class="fc" id="L1679">							html.setContent(appendStyle(htmlData.toString(), cssData, emailEncoding, forceTextPlain), &quot;text/html; charset=&quot;+emailEncoding);</span>
						}
						else
						{
<span class="fc" id="L1683">							html.setContent(htmlData.toString(), &quot;text/plain; charset=&quot;+emailEncoding);</span>
						}

<span class="fc" id="L1686">						Multipart mp = new MimeMultipart(&quot;mixed&quot;);</span>
<span class="pc bpc" id="L1687" title="6 of 16 branches missed.">						if ((forceTextPlain==false || (attachs != null &amp;&amp; attachFiles)) &amp;&amp; (Tools.isNotEmpty(beforePostMethod) || formFiles.size()&gt;0 || sendMessageAsAttach || (htmlDataNoBR.indexOf('&lt;') != -1 &amp;&amp; htmlDataNoBR.indexOf('&gt;') != -1)))</span>
						{
							//html.setContent(htmlData, contentType);

							//mp.addBodyPart(text);

							//#15245 - ak je nastaveny forceTextPlain a mal som aj prilohy, text formularu necham ako text/plain a prilohy pridam standartnym sposobom
<span class="pc bpc" id="L1694" title="1 of 2 branches missed.">							if(forceTextPlain)</span>
<span class="nc" id="L1695">								html.setContent(SearchTools.htmlToPlain(htmlDataNoBR), &quot;text/plain; charset=&quot;+emailEncoding);</span>

<span class="fc" id="L1697">							mp.addBodyPart(html);</span>

							//Multipart mp = new MimeMultipart(&quot;mixed&quot;);

<span class="pc bpc" id="L1701" title="2 of 4 branches missed.">							if(attachs != null &amp;&amp; attachFiles)</span>
							{
<span class="pc bpc" id="L1703" title="1 of 2 branches missed.">								for(IwcmFile file : attachs)</span>
<span class="nc" id="L1704">									attFile(file, mp, emailEncoding);</span>
							}

<span class="pc bpc" id="L1707" title="1 of 2 branches missed.">							if(sendMessageAsAttach) attFile(messageAsAttachFile, mp, emailEncoding);</span>

<span class="fc" id="L1709">							msg.setContent(mp);</span>

<span class="pc bpc" id="L1711" title="1 of 2 branches missed.">							if (canCallInterceptor(beforePostMethod))</span>
							{
<span class="nc" id="L1713">								beforePostReturnParams = callInterceptor(beforePostMethod, msg, mp, request);</span>
<span class="nc bnc" id="L1714" title="All 2 branches missed.">								if(hasInterceptorFailed(beforePostReturnParams)) {</span>
<span class="nc" id="L1715">									failStatus = &quot;beforePostMethod&quot;;</span>
								}
							}
						}
						else
						{
							//mame iba textovy obsah, posli zjednodusene
<span class="fc" id="L1722">							htmlDataNoBR = SearchTools.htmlToPlain(htmlDataNoBR);</span>
<span class="fc" id="L1723">							msg.setContent(htmlDataNoBR, &quot;text/plain; charset=&quot;+emailEncoding);</span>
						}

<span class="fc" id="L1726">						String formMailFixedSenderEmail = Constants.getString(&quot;formMailFixedSenderEmail&quot;);</span>
<span class="pc bpc" id="L1727" title="1 of 2 branches missed.">						if (Tools.isEmail(formMailFixedSenderEmail))</span>
						{
<span class="nc" id="L1729">							msg.setFrom(new InternetAddress(formMailFixedSenderEmail, formMailFixedSenderEmail));</span>
						}
						else
						{
<span class="pc bpc" id="L1733" title="1 of 2 branches missed.">							if (Tools.isEmail(Constants.getString(SendMail.EMAIL_PROTECTION_SENDER_KEY)))</span>
							{
<span class="nc" id="L1735">								from = Constants.getString(SendMail.EMAIL_PROTECTION_SENDER_KEY);</span>
<span class="nc" id="L1736">								Address[] oldSenders = msg.getFrom();</span>
<span class="nc bnc" id="L1737" title="All 6 branches missed.">								if (oldSenders != null &amp;&amp; oldSenders.length&gt;0 &amp;&amp; from.equals(oldSenders[0].toString()) == false) msg.setReplyTo(oldSenders);</span>
<span class="nc" id="L1738">								msg.setFrom(new InternetAddress(from, from));</span>
							}
						}

						//ak mame parameter &quot;replyTo&quot;, nastavme ho
<span class="fc" id="L1743">						String replyTo = request.getParameter(&quot;replyTo&quot;);</span>
<span class="pc bpc" id="L1744" title="3 of 4 branches missed.">						if(Tools.isNotEmpty(replyTo) &amp;&amp; replyTo.indexOf(&quot;@&quot;) != -1)</span>
						{
<span class="nc" id="L1746">							InternetAddress[] replyToAddrs = InternetAddress.parse(replyTo, false);</span>
<span class="nc" id="L1747">							msg.setReplyTo(replyToAddrs);</span>
						}

<span class="pc bpc" id="L1750" title="3 of 4 branches missed.">						if(beforePostReturnParams==null || beforePostReturnParams.indexOf(&quot;doNotSend&quot;) == -1)</span>
						{
<span class="fc" id="L1752">							Transport.send(msg);</span>

<span class="fc" id="L1754">							RequestBean.addParameter(&quot;formName&quot;, formName);</span>
<span class="fc" id="L1755">							RequestBean.addParameter(&quot;beforePostMethod&quot;, beforePostMethod);</span>
<span class="fc" id="L1756">							RequestBean.addParameter(&quot;from&quot;, from);</span>
<span class="fc" id="L1757">							RequestBean.addParameter(&quot;to&quot;, recipients);</span>
<span class="fc" id="L1758">							RequestBean.addParameter(&quot;subject&quot;, subject);</span>

<span class="fc" id="L1760">							Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;Formular &quot;+formName+&quot; uspesne odoslany na email &quot;+recipients, docId, formId);</span>
						}
						else
						{
<span class="nc" id="L1764">							RequestBean.addParameter(&quot;formName&quot;, formName);</span>
<span class="nc" id="L1765">							RequestBean.addParameter(&quot;beforePostMethod&quot;, beforePostMethod);</span>
<span class="nc" id="L1766">							RequestBean.addParameter(&quot;from&quot;, from);</span>
<span class="nc" id="L1767">							RequestBean.addParameter(&quot;subject&quot;, subject);</span>

<span class="nc" id="L1769">							Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;Formular &quot;+formName+&quot; uspesne ulozeny&quot;, docId, formId);</span>
						}
					}
<span class="nc" id="L1772">					catch (Exception ex)</span>
					{
<span class="nc" id="L1774">						Logger.error(FormMailAction.class, ex);</span>
<span class="nc" id="L1775">						failStatus = &quot;emailsend&quot;;</span>

						//RequestBean.setErrorText(&quot;send_mail_error&quot;);
<span class="nc" id="L1778">						RequestBean.addError(&quot;Chyba pri odosielani emailu&quot;);</span>
<span class="nc" id="L1779">						RequestBean.addError(&quot;Stack Trace: \n&quot;+Logger.getStackTrace(ex));</span>
<span class="nc" id="L1780">						RequestBean.addParameter(&quot;formName&quot;, formName);</span>

<span class="nc" id="L1782">						Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;&quot;, docId, formId);</span>
<span class="fc" id="L1783">					}</span>
				}
<span class="fc" id="L1785">			}</span>
			else
			{
<span class="nc" id="L1788">				Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;Formular &quot;+formName+&quot; uspesne ulozeny do databazy&quot;, docId, formId);</span>
			}
		} //else isSpam



<span class="fc" id="L1794">		String param = &quot;formsend=true&quot;;</span>

<span class="fc" id="L1796">		StringBuilder forward = new StringBuilder(forwardDefault);</span>
<span class="fc bfc" id="L1797" title="All 2 branches covered.">		if (failStatus!=null)</span>
		{
<span class="fc" id="L1799">			param = &quot;formfail=&quot;+failStatus;</span>
<span class="pc bpc" id="L1800" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(forwardFail)) forward = new StringBuilder(forwardFail);</span>
		}
		else
		{
<span class="pc bpc" id="L1804" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(forwardOk)) forward = new StringBuilder(forwardOk);</span>
		}

<span class="pc bpc" id="L1807" title="1 of 2 branches missed.">		if (forward.indexOf(&quot;?&quot;)==-1)</span>
		{
<span class="fc" id="L1809">			forward = forward.append('?').append(param);</span>
		}
		else
		{
<span class="nc" id="L1813">			forward =  forward.append('&amp;').append(param);</span>
		}
<span class="pc bpc" id="L1815" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(beforePostReturnParams))</span>
		{
<span class="nc" id="L1817">			forward =  forward.append('&amp;').append(beforePostReturnParams);</span>
		}

<span class="fc" id="L1820">		return (forward.toString());</span>
		//return(mapping.findForward(&quot;success&quot;));
	}

	/**
	 * Zisti ci ma zavolat afterSendInterceptor
	 * @param beforePostMethod
	 * @return true ak je pre formular nastaveny afterSendInterceptor
	 */
	private static boolean canCallInterceptor(String beforePostMethod) {
<span class="pc bpc" id="L1830" title="5 of 6 branches missed.">		return Tools.isNotEmpty(beforePostMethod) &amp;&amp; beforePostMethod.length()&gt;10 &amp;&amp; beforePostMethod.contains(&quot;.&quot;);</span>
	}

	/**
	 * Overi ci interceptor padol
	 * @param beforePostReturnParams
	 * @return true ak interceptor obsahuje string fail
	 */
	public static boolean hasInterceptorFailed(String beforePostReturnParams) {
<span class="nc bnc" id="L1839" title="All 2 branches missed.">		if(beforePostReturnParams == null) beforePostReturnParams = &quot;&quot;;</span>
<span class="nc bnc" id="L1840" title="All 2 branches missed.">		return beforePostReturnParams.indexOf(&quot;fail&quot;) != -1;</span>
	}

	/**
	 * Zavola afterSendInterceptor
	 * @param beforePostMethod
	 * @param message
	 * @param multipart
	 * @param request
	 * @return Map&lt;String, String&gt; obsahujuci failStatus a beforePostReturnParams
	 */
	private static String callInterceptor(String beforePostMethod, MimeMessage message, Multipart multipart, HttpServletRequest request) {
<span class="nc" id="L1852">		String beforePostReturnParams = null;</span>
<span class="nc" id="L1853">		int i = beforePostMethod.lastIndexOf('.');</span>
<span class="nc" id="L1854">		String beforePostClass = beforePostMethod.substring(0, i);</span>
<span class="nc" id="L1855">		beforePostMethod = beforePostMethod.substring(i+1);</span>
<span class="nc bnc" id="L1856" title="All 2 branches missed.">		if (Character.isUpperCase(beforePostMethod.charAt(0)))</span>
		{
			//je to pravdepodobne meno triedy
<span class="nc" id="L1859">			beforePostClass = beforePostClass+&quot;.&quot;+beforePostMethod;</span>
			try
			{
<span class="nc" id="L1862">				Class&lt;?&gt; c = Class.forName(beforePostClass);</span>
<span class="nc bnc" id="L1863" title="All 2 branches missed.">				if (AfterSendInterceptor.class.isAssignableFrom(c))</span>
				{
<span class="nc" id="L1865">					AfterSendInterceptor interceptor = (AfterSendInterceptor)c.getDeclaredConstructor().newInstance();</span>
<span class="nc bnc" id="L1866" title="All 2 branches missed.">					if (interceptor!=null)</span>
					{
<span class="nc" id="L1868">						beforePostReturnParams = interceptor.intercept(message, multipart, request);</span>
					}
				}
			}
<span class="nc" id="L1872">			catch (Exception ex)</span>
			{
<span class="nc" id="L1874">				Logger.error(FormMailAction.class, ex);</span>
<span class="nc" id="L1875">			}</span>
		}
		else
		{
			try
			{
<span class="nc" id="L1881">				Class&lt;?&gt; c = Class.forName(beforePostClass);</span>
<span class="nc" id="L1882">				Object o = c.getDeclaredConstructor().newInstance();</span>
				Method m;
<span class="nc" id="L1884">				Class&lt;?&gt;[] parameterTypes = new Class[] {MimeMessage.class, Multipart.class, HttpServletRequest.class};</span>
<span class="nc" id="L1885">				Object[] arguments = new Object[] {message, multipart, request};</span>
<span class="nc" id="L1886">				m = c.getMethod(beforePostMethod, parameterTypes);</span>
<span class="nc" id="L1887">				beforePostReturnParams = (String)m.invoke(o, arguments);</span>
			}
<span class="nc" id="L1889">			catch (Exception ex)</span>
			{
<span class="nc" id="L1891">				Logger.error(FormMailAction.class, ex);</span>
<span class="nc" id="L1892">			}</span>
		}

<span class="nc" id="L1895">		return beforePostReturnParams;</span>
	}

	/**
	 *  Description of the Method
	 *
	 *@param  input  Description of the Parameter
	 *@return        Description of the Return Value
	 */
	private static String recode(String input)
	{
<span class="nc bnc" id="L1906" title="All 2 branches missed.">		if (input == null)</span>
		{
<span class="nc" id="L1908">			return (&quot;&quot;);</span>
		}
		//Logger.println(this,&quot;Recoding: &quot;+input);
<span class="nc" id="L1911">		return (input.trim());</span>
	}

	/**
	 * Vrati parameter z request, ak ma request viac parametrov s rovnakym
	 * menom, spoji ich ciarkami
	 * @param name
	 * @param request
	 * @return
	 */
	private static String getValue(String name, HttpServletRequest request, Map&lt;String, List&lt;UploadedFile&gt;&gt; formFilesTable)
	{
		//recode(request.getParameter(field));

<span class="fc" id="L1925">		StringBuilder ret = null;</span>

<span class="fc" id="L1927">		String[] params = request.getParameterValues(name);</span>
<span class="fc bfc" id="L1928" title="All 2 branches covered.">		if (params != null) {</span>
<span class="fc" id="L1929">			String param = null;</span>
<span class="fc" id="L1930">			int size = 0;</span>
<span class="pc bpc" id="L1931" title="1 of 2 branches missed.">			if (params!=null) size = params.length;</span>
			int i;
<span class="fc bfc" id="L1933" title="All 2 branches covered.">			for (i=0; i&lt;size; i++)</span>
			{
<span class="fc" id="L1935">				param = params[i];</span>

				//takto mame v parametroch vrateny subor
<span class="pc bpc" id="L1938" title="1 of 2 branches missed.">				if (&quot;NOT_EMPTY&quot;.equals(param)) param = null;</span>

<span class="pc bpc" id="L1940" title="1 of 2 branches missed.">				if (param!=null)</span>
				{
<span class="pc bpc" id="L1942" title="1 of 2 branches missed.">					if (ret == null)</span>
					{
<span class="fc" id="L1944">						ret = new StringBuilder(param);</span>
					}
					else
					{
<span class="nc" id="L1948">						ret.append(&quot;;;\n&quot;).append(param);</span>
					}
				}
			}
		}

<span class="fc bfc" id="L1954" title="All 2 branches covered.">		if (ret == null)</span>
		{
			//skus najst ako subor
<span class="fc" id="L1957">			Set&lt;Map.Entry&lt;String, List&lt;UploadedFile&gt;&gt;&gt; set = formFilesTable.entrySet();</span>
<span class="pc bpc" id="L1958" title="1 of 2 branches missed.">			for(Map.Entry&lt;String, List&lt;UploadedFile&gt;&gt; me : set)</span>
			{
<span class="nc bnc" id="L1960" title="All 2 branches missed.">				if (me.getKey().equals(name))</span>
				{
<span class="nc bnc" id="L1962" title="All 2 branches missed.">					for (UploadedFile f : me.getValue())</span>
					{
<span class="nc bnc" id="L1964" title="All 2 branches missed.">						if (ret == null) ret = new StringBuilder();</span>

<span class="nc bnc" id="L1966" title="All 2 branches missed.">						if (ret.length()&gt;0) ret.append(&quot;;;\n&quot;);</span>
<span class="nc" id="L1967">						ret.append(fixFileNameDirPath(f.getFileName()));</span>
<span class="nc" id="L1968">					}</span>
				}
<span class="nc" id="L1970">			}</span>
		}

<span class="fc bfc" id="L1973" title="All 2 branches covered.">		if (ret == null) return &quot;&quot;;</span>
<span class="fc" id="L1974">		return(ret.toString().trim());</span>
	}

	/**
	 *  Description of the Method
	 *
	 *@param  formFile  Description of the Parameter
	 *@param  mp        Description of the Parameter
	 */
	private static void attFile(IwcmFile formFile, Multipart mp, String emailEncoding)
	{
		try
		{
<span class="nc bnc" id="L1987" title="All 2 branches missed.">			if (formFile != null)</span>
			{
				//retrieve the file name
<span class="nc" id="L1990">				String fileName = formFile.getName().trim();</span>
				//Logger.println(this,&quot;we have the file name=&quot; + fileName);
<span class="nc bnc" id="L1992" title="All 4 branches missed.">				if (fileName != null &amp;&amp; fileName.length() &gt; 1)</span>
				{
<span class="nc" id="L1994">					fileName = DB.internationalToEnglish(fileName);</span>
<span class="nc" id="L1995">					int ind = fileName.indexOf(&quot;_&quot;);</span>
<span class="nc bnc" id="L1996" title="All 2 branches missed.">					if(ind != -1) fileName = fileName.substring(ind+1);</span>

<span class="nc" id="L1998">					MimeBodyPart mbp2 = new MimeBodyPart();</span>

<span class="nc" id="L2000">					FileDataSource fds = null;</span>

<span class="nc bnc" id="L2002" title="All 2 branches missed.">					if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(formFile.getAbsolutePath())))</span>
					{
<span class="nc" id="L2004">						IwcmFsDB.writeFileToDisk(new File(formFile.getAbsolutePath()),new File(IwcmFsDB.getTempFilePath(formFile.getAbsolutePath())));</span>
<span class="nc" id="L2005">						fds=new FileDataSource(IwcmFsDB.getTempFilePath(formFile.getAbsolutePath()));</span>
					}
					else
					{
<span class="nc" id="L2009">						fds=new FileDataSource(formFile.getAbsolutePath());</span>
					}
					//FileDataSource fds = new FileDataSource(formFile.getAbsolutePath());

<span class="nc" id="L2013">					mbp2.setDataHandler(new DataHandler(fds));</span>
<span class="nc" id="L2014">					mbp2.setFileName(fileName);</span>
<span class="nc" id="L2015">					MimetypesFileTypeMap mimeTypesMap = new MimetypesFileTypeMap();</span>
<span class="nc" id="L2016">					String mimeType = mimeTypesMap.getContentType(fileName);</span>
<span class="nc bnc" id="L2017" title="All 4 branches missed.">					if(Tools.isNotEmpty(mimeType) &amp;&amp; mimeType.startsWith(&quot;text&quot;))</span>
<span class="nc" id="L2018">						mbp2.setHeader(&quot;Content-Type&quot;, mimeType+&quot;; charset=&quot;+emailEncoding);</span>
<span class="nc" id="L2019">					mp.addBodyPart(mbp2);</span>
				}
			}
		}
<span class="nc" id="L2023">		catch (Exception ex)</span>
		{
<span class="nc" id="L2025">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L2026">		}</span>

<span class="nc" id="L2028">	}</span>

	public static final String CROP_START = &quot;&lt;!-- formmail crop form start --&gt;&quot;;
	public static final String CROP_END = &quot;&lt;!-- formmail crop form end --&gt;&quot;;
	/**
	 * Vrati orezany HTML kod (ak obsahuje CROP_START a CROP_END)
	 * @param data - html kod
	 * @return
	 */
	public static String getCroppedHTML(String data)
	{
		try
		{
			//odstran vsetko pred &lt;body&gt; a po &lt;/body&gt;
<span class="fc" id="L2042">			String data_lcase = data.toLowerCase();</span>

			int start;
			int end;

<span class="pc bpc" id="L2047" title="1 of 2 branches missed.">			if (Constants.getBoolean(&quot;formMailCropForm&quot;))</span>
			{
<span class="nc" id="L2049">				start = data_lcase.indexOf(&quot;&lt;form&quot;);</span>
<span class="nc bnc" id="L2050" title="All 2 branches missed.">				if (start != -1) start = data_lcase.indexOf('&gt;', start);</span>
<span class="nc" id="L2051">				end = data_lcase.indexOf(&quot;&lt;/form&quot;);</span>

<span class="nc bnc" id="L2053" title="All 2 branches missed.">				if (end &gt; start)</span>
				{
<span class="nc" id="L2055">					data = data.substring(start+1, end);</span>

				}
			}
			else
			{
<span class="fc" id="L2061">				start = data_lcase.indexOf(CROP_START);</span>
<span class="fc" id="L2062">				end = data_lcase.indexOf(CROP_END);</span>

<span class="pc bpc" id="L2064" title="1 of 2 branches missed.">				if (end &gt; start)</span>
				{
<span class="fc" id="L2066">					data = data.substring(start + CROP_START.length(), end);</span>

				}
			}


		}
<span class="nc" id="L2073">		catch (RuntimeException e)</span>
		{
<span class="nc" id="L2075">			sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L2076">		}</span>

<span class="fc" id="L2078">		return(data);</span>
	}

	/**
	 * Detekcia, ci sa nejedna o spamovanie
	 * @param request
	 * @param db_data_names
	 * @return
	 */
	private static boolean detectSpam(HttpServletRequest request, String htmlData, String db_data_names)
	{
		//aby sa to dalo vypnut
<span class="pc bpc" id="L2090" title="1 of 2 branches missed.">		if (Constants.getBoolean(&quot;spamProtection&quot;)==false) return false;</span>

		//robot to posle ako amp;savedb
<span class="pc bpc" id="L2093" title="2 of 4 branches missed.">		if (Tools.isEmpty(request.getParameter(&quot;savedb&quot;)) || Tools.isEmpty(db_data_names))</span>
		{
			//RequestBean.setErrorText(&quot;send_mail_error.span_detected&quot;);
<span class="nc" id="L2096">			RequestBean.addError(&quot;Chyba meno formularu (savedb)&quot;);</span>

<span class="nc" id="L2098">			Logger.debug(FormMailAction.class, &quot;detectSpam TRUE, saved=&quot;+request.getParameter(&quot;savedb&quot;)+&quot; db_data_names=&quot;+db_data_names);</span>
			//spam roboty toto nevedia dobre poslat, kedze je to kombinacia post a get
<span class="nc" id="L2100">			return true;</span>
		}

		//preiteruj parametre a najdi nepovolene hodnoty
<span class="fc" id="L2104">		Enumeration&lt;String&gt; e = request.getParameterNames();</span>
<span class="fc bfc" id="L2105" title="All 2 branches covered.">		while (e.hasMoreElements())</span>
		{
<span class="fc" id="L2107">			String name = e.nextElement();</span>
<span class="pc bpc" id="L2108" title="3 of 6 branches missed.">			if (DocTools.testXss(name) || name.indexOf('&quot;')!=-1 || name.indexOf('\'')!=-1) return true;</span>
<span class="fc" id="L2109">			String[] values = request.getParameterValues(name);</span>
<span class="fc bfc" id="L2110" title="All 2 branches covered.">			for (int i=0; i&lt;values.length; i++)</span>
			{
<span class="pc bpc" id="L2112" title="1 of 2 branches missed.">				if (DocTools.testXss(values[i]))</span>
				{
<span class="nc" id="L2114">					RequestBean.addError(&quot;Detekovane XSS &quot;+values[i]);</span>
<span class="nc" id="L2115">					Logger.debug(FormMailAction.class, &quot;detectSpam TRUE, val=&quot;+values[i]);</span>
<span class="nc" id="L2116">					return true;</span>
				}
			}
<span class="fc" id="L2119">		}</span>

		//test na cookies (spameri zvycajne nemaju nastavene)
<span class="pc bpc" id="L2122" title="2 of 4 branches missed.">		if (request.getCookies()==null || request.getCookies().length==0)</span>
		{
<span class="nc" id="L2124">			RequestBean.addError(&quot;Cookies su prazdne&quot;);</span>

<span class="nc" id="L2126">			Logger.debug(FormMailAction.class, &quot;detectSpam TRUE, cookies are empty&quot;);</span>
<span class="nc" id="L2127">			return true;</span>
		}

<span class="fc bfc" id="L2130" title="All 2 branches covered.">		if (!SpamProtection.canPost(&quot;form&quot;, htmlData, request))</span>
		{
<span class="fc" id="L2132">			Logger.debug(FormMailAction.class, &quot;detectSpam TRUE, can't post&quot;);</span>
<span class="fc" id="L2133">			return true;</span>
		}

<span class="fc" id="L2136">		return false;</span>
	}

	/**
	 * Vrati true, ak su zadane vsetky pozadovane povinne polia
	 * @param request
	 * @param classNames
	 * @return
	 */
	private static boolean checkRequiredFields(HttpServletRequest request, List&lt;LabelValueDetails&gt; classNames, Map&lt;String, String&gt; labelsTable, ActionBeanContext context)
	{
<span class="fc" id="L2147">		request.getSession().removeAttribute(&quot;formMailValidationErrors&quot;);</span>
<span class="fc" id="L2148">		request.getSession().removeAttribute(&quot;formMailValidationErrorsElementNameTable&quot;);</span>

<span class="fc" id="L2150">		boolean allOK = true;</span>

<span class="fc" id="L2152">		Prop prop = Prop.getInstance(PageLng.getUserLng(request));</span>

<span class="fc" id="L2154">		StringBuilder formMailValidationErrors = new StringBuilder();</span>
<span class="fc" id="L2155">		Map&lt;String, String&gt; formMailValidationErrorsElementNameTable = new Hashtable&lt;&gt;();</span>

<span class="fc bfc" id="L2157" title="All 2 branches covered.">		for (LabelValueDetails lvb : classNames )</span>
		{
<span class="fc" id="L2159">			String fieldName = lvb.getLabel();</span>
<span class="fc" id="L2160">			String className = lvb.getValue();</span>

<span class="pc bpc" id="L2162" title="1 of 2 branches missed.">			if (Tools.isEmpty(className)) continue;</span>

<span class="pc bpc" id="L2164" title="1 of 2 branches missed.">			if (fieldName != null) fieldName = fieldName.trim();</span>
<span class="fc" id="L2165">			String paramValue = request.getParameter(fieldName);</span>

<span class="fc bfc" id="L2167" title="All 2 branches covered.">			if (className.indexOf(&quot;required&quot;)!=-1)</span>
			{
<span class="pc bpc" id="L2169" title="1 of 2 branches missed.">				if (Tools.isEmpty(paramValue))</span>
				{
<span class="nc" id="L2171">					Logger.debug(FormMailAction.class, &quot;checkRequiredFields: name=&quot;+fieldName+&quot; value=&quot;+paramValue+&quot; class=&quot;+className);</span>
<span class="nc bnc" id="L2172" title="All 2 branches missed.">					if (Tools.isNotEmpty(lvb.getValue2()))</span>
					{
<span class="nc" id="L2174">						String labelValue = labelsTable.get(lvb.getValue2());</span>
<span class="nc bnc" id="L2175" title="All 2 branches missed.">						if (Tools.isNotEmpty(labelValue)) fieldName = labelValue;</span>
					}

<span class="nc bnc" id="L2178" title="All 2 branches missed.">					if (context!=null)</span>
					{
<span class="nc" id="L2180">						context.getValidationErrors().add(fieldName, new SimpleError(Tools.replace(prop.getText(&quot;validation.required.valueNotPresent&quot;), &quot;{0}&quot;, fieldName)));</span>
					}
<span class="nc" id="L2182">					formMailValidationErrors.append(&quot;&lt;li&gt;&quot;).append(Tools.replace(prop.getText(&quot;validation.required.valueNotPresent&quot;), &quot;{0}&quot;, fieldName)).append(&quot;&lt;/li&gt;&quot;).append('\n');</span>
<span class="nc" id="L2183">					formMailValidationErrorsElementNameTable.put(fieldName, className);</span>

<span class="nc" id="L2185">					allOK = false;</span>
				}
			}
<span class="fc bfc" id="L2188" title="All 2 branches covered.">			if (Tools.isNotEmpty(paramValue))</span>
			{
<span class="fc" id="L2190">				PhoneValidator phoneValidator = PhoneValidator.getInstance();</span>
<span class="fc" id="L2191">				List&lt;String&gt; phoneClasses = phoneValidator.getPhoneClasses();</span>
<span class="pc bpc" id="L2192" title="2 of 4 branches missed.">				if (phoneClasses!=null &amp;&amp; phoneClasses.size()&gt;0)</span>
				{
<span class="nc" id="L2194">					List&lt;String&gt; classes = Arrays.asList(Tools.getTokens(className, &quot; &quot;));</span>
<span class="nc bnc" id="L2195" title="All 4 branches missed.">					if (phoneValidator.hasBlacklistedPhoneClass(classes) &amp;&amp; phoneValidator.isBlacklisted(paramValue)) {</span>
<span class="nc bnc" id="L2196" title="All 2 branches missed.">						String text = &quot;components.tatrabanka.blacklistedNumber&quot;.equalsIgnoreCase(prop.getText(&quot;components.tatrabanka.blacklistedNumber&quot;)) ? prop.getText(&quot;components.form.blacklistedNumber&quot;) : prop.getText(&quot;components.tatrabanka.blacklistedNumber&quot;);</span>
<span class="nc bnc" id="L2197" title="All 2 branches missed.">						if (context != null)</span>
						{
<span class="nc" id="L2199">							context.getValidationErrors().add(fieldName, new SimpleError(text));</span>
						}
<span class="nc" id="L2201">						formMailValidationErrors.append(&quot;&lt;li&gt;&quot;).append(text).append(&quot;&lt;/li&gt;&quot;).append('\n');</span>
<span class="nc" id="L2202">						Logger.debug(FormMailAction.class, &quot;formMailValidationErrors: &quot; + formMailValidationErrors);</span>
<span class="nc" id="L2203">						formMailValidationErrorsElementNameTable.put(fieldName, className);</span>

<span class="nc" id="L2205">						allOK = false;</span>
<span class="nc" id="L2206">					}</span>
<span class="nc bnc" id="L2207" title="All 4 branches missed.">					else if (phoneValidator.hasPhoneClass(classes) &amp;&amp; !phoneValidator.isValid(phoneClasses, paramValue))</span>
					{
<span class="nc bnc" id="L2209" title="All 2 branches missed.">						if (context != null)</span>
						{
<span class="nc" id="L2211">							context.getValidationErrors().add(fieldName, new SimpleError(Tools.replace(Tools.replace(prop.getText(&quot;validation.expression.valueFailedExpression&quot;), &quot;{1}&quot;, paramValue), &quot;{0}&quot;, fieldName)));</span>
						}
<span class="nc" id="L2213">						formMailValidationErrors.append(&quot;&lt;li&gt;&quot;).append(Tools.replace(Tools.replace(prop.getText(&quot;validation.expression.valueFailedExpression&quot;), &quot;{1}&quot;, paramValue), &quot;{0}&quot;, fieldName)).append(&quot;&lt;/li&gt;&quot;).append('\n');</span>
<span class="nc" id="L2214">						Logger.debug(FormMailAction.class, &quot;formMailValidationErrors: &quot; + formMailValidationErrors);</span>
<span class="nc" id="L2215">						formMailValidationErrorsElementNameTable.put(fieldName, className);</span>

<span class="nc" id="L2217">						allOK = false;</span>
					}
				}

<span class="fc" id="L2221">				FormDB myFormDB = FormDB.getInstance();</span>
<span class="fc" id="L2222">				List&lt;String[]&gt; regularExpr = myFormDB.getAllRegularExpression();</span>

<span class="fc" id="L2224">				List&lt;String&gt; classNameList = Arrays.asList(Tools.getTokens(className, &quot; &quot;));</span>

				//case insensitive porovnanie
<span class="fc" id="L2227">				paramValue = paramValue.toLowerCase();</span>
<span class="fc bfc" id="L2228" title="All 2 branches covered.">				for(String[] regExp: regularExpr)</span>
				{
					//paramValue je LC, musime dat aj regexp na LC
<span class="fc" id="L2231">					String regex = Tools.replace(regExp[2], &quot;\\\\&quot;, &quot;\\&quot;).toLowerCase();</span>
<span class="pc bpc" id="L2232" title="1 of 4 branches missed.">					if (classNameList.contains(regExp[1]) &amp;&amp; paramValue.matches(regex)==false)</span>
					{
<span class="nc" id="L2234">						Logger.debug(FormMailAction.class, &quot;checkRequiredFields regex: name=&quot;+fieldName+&quot; value=&quot;+paramValue+&quot; class=&quot;+className+&quot; regExp name=&quot;+regExp[1]+&quot; regExp=&quot;+regex);</span>

<span class="nc bnc" id="L2236" title="All 2 branches missed.">						if (DocTools.testXss(paramValue)) paramValue = &quot;&quot;;</span>
<span class="nc bnc" id="L2237" title="All 2 branches missed.">						if (DocTools.testXss(fieldName)) fieldName = &quot;&quot;;</span>

<span class="nc" id="L2239">						paramValue = ResponseUtils.filter(paramValue);</span>
<span class="nc" id="L2240">						fieldName = ResponseUtils.filter(fieldName);</span>

<span class="nc bnc" id="L2242" title="All 2 branches missed.">						if (context!=null)</span>
						{
<span class="nc bnc" id="L2244" title="All 2 branches missed.">							if(className.indexOf(&quot;email&quot;) != -1)</span>
<span class="nc" id="L2245">								context.getValidationErrors().add(fieldName, new SimpleError(Tools.replace(prop.getText(&quot;converter.email.invalidEmail&quot;), &quot;{1}&quot;, paramValue)));</span>
<span class="nc bnc" id="L2246" title="All 2 branches missed.">							else if(className.indexOf(&quot;minLen&quot;) != -1)</span>
<span class="nc" id="L2247">								context.getValidationErrors().add(fieldName, new SimpleError(Tools.replace(Tools.replace(prop.getText(&quot;validation.minlength.valueTooShort&quot;), &quot;{2}&quot;, paramValue.replaceFirst(&quot;minLen&quot;, &quot;&quot;)), &quot;{0}&quot;, fieldName)));</span>
<span class="nc bnc" id="L2248" title="All 2 branches missed.">							else if(className.indexOf(&quot;number&quot;) != -1)</span>
<span class="nc" id="L2249">								context.getValidationErrors().add(fieldName, new SimpleError(Tools.replace(Tools.replace(prop.getText(&quot;converter.number.invalidNumber&quot;), &quot;{1}&quot;, paramValue), &quot;{0}&quot;, fieldName)));</span>
							else
<span class="nc" id="L2251">								context.getValidationErrors().add(fieldName, new SimpleError(Tools.replace(Tools.replace(prop.getText(&quot;validation.expression.valueFailedExpression&quot;), &quot;{1}&quot;, paramValue), &quot;{0}&quot;, fieldName)));</span>
						}
<span class="nc bnc" id="L2253" title="All 2 branches missed.">						if(className.indexOf(&quot;email&quot;) != -1)</span>
<span class="nc" id="L2254">							formMailValidationErrors.append(&quot;&lt;li&gt;&quot;).append(Tools.replace(prop.getText(&quot;converter.email.invalidEmail&quot;), &quot;{1}&quot;, paramValue)).append(&quot;&lt;/li&gt;&quot;).append('\n');</span>
<span class="nc bnc" id="L2255" title="All 2 branches missed.">						else if(className.indexOf(&quot;minLen&quot;) != -1)</span>
<span class="nc" id="L2256">							formMailValidationErrors.append(&quot;&lt;li&gt;&quot;).append(Tools.replace(Tools.replace(prop.getText(&quot;validation.minlength.valueTooShort&quot;), &quot;{2}&quot;, className.replaceFirst(&quot;minLen&quot;, &quot;&quot;)), &quot;{0}&quot;, fieldName)).append(&quot;&lt;/li&gt;&quot;).append('\n');</span>
<span class="nc bnc" id="L2257" title="All 2 branches missed.">						else if(className.indexOf(&quot;number&quot;) != -1)</span>
<span class="nc" id="L2258">							formMailValidationErrors.append(&quot;&lt;li&gt;&quot;).append(Tools.replace(Tools.replace(prop.getText(&quot;converter.number.invalidNumber&quot;), &quot;{1}&quot;, paramValue), &quot;{0}&quot;, fieldName)).append(&quot;&lt;/li&gt;&quot;).append('\n');</span>
						else
<span class="nc" id="L2260">							formMailValidationErrors.append(&quot;&lt;li&gt;&quot;).append(Tools.replace(Tools.replace(prop.getText(&quot;validation.expression.valueFailedExpression&quot;), &quot;{1}&quot;, paramValue), &quot;{0}&quot;, fieldName)).append(&quot;&lt;/li&gt;&quot;).append('\n');</span>
<span class="nc" id="L2261">						Logger.debug(FormMailAction.class, &quot;formMailValidationErrors: &quot; + formMailValidationErrors);</span>
<span class="nc" id="L2262">						formMailValidationErrorsElementNameTable.put(fieldName, className);</span>

<span class="nc" id="L2264">						RequestBean.addError(&quot;Chyba regexp validacie &quot;+fieldName+&quot;: &quot;+formMailValidationErrors.toString());</span>

<span class="nc" id="L2266">						allOK = false;</span>
					}
<span class="fc" id="L2268">				}</span>
			}
<span class="fc" id="L2270">		}</span>

<span class="pc bpc" id="L2272" title="1 of 2 branches missed.">		if (formMailValidationErrors.length() &gt; 4)</span>
		{
<span class="nc" id="L2274">			request.getSession().setAttribute(&quot;formMailValidationErrors&quot;, &quot;&lt;ol class='formMailValidationErrors'&gt;&quot;+formMailValidationErrors.toString()+&quot;&lt;/ol&gt;&quot;);</span>
<span class="nc" id="L2275">			request.getSession().setAttribute(&quot;formMailValidationErrorsElementNameTable&quot;, formMailValidationErrorsElementNameTable);</span>
		}

<span class="fc" id="L2278">		return allOK;</span>
	}

	/**
	 * Ulozi formular ako pdfko
	 * @param htmlData
	 */
	private static String saveFormAsPdf(String htmlData, int formId, HttpServletRequest request)
	{
<span class="nc" id="L2287">		Logger.println(FormMailAction.class, &quot;Exportujem formular do pdf, form_id: &quot;+formId+&quot; path: &quot;+</span>
<span class="nc" id="L2288">				Tools.getRealPath(FORM_FILE_DIR)+File.separator+formId+&quot;_pdf.pdf&quot;);</span>
		try
		{
<span class="nc" id="L2291">			IwcmFile dir = new IwcmFile(Tools.getRealPath(FORM_FILE_DIR));</span>
<span class="nc bnc" id="L2292" title="All 2 branches missed.">			if (dir.exists()==false) dir.mkdirs();</span>

<span class="nc" id="L2294">			FileOutputStream fos = new FileOutputStream(Tools.getRealPath(FORM_FILE_DIR)+File.separator+formId+&quot;_pdf.pdf&quot;);</span>

<span class="nc" id="L2296">			PdfTools.renderHtmlCode(htmlData, fos, request);</span>

<span class="nc" id="L2298">			fos.close();</span>

<span class="nc" id="L2300">			return Tools.getRealPath(FORM_FILE_DIR)+File.separator+formId+&quot;_pdf.pdf&quot;;</span>
		}
<span class="nc" id="L2302">		catch (Exception e)</span>
		{
<span class="nc" id="L2304">			sk.iway.iwcm.Logger.error(e);</span>
		}

<span class="nc" id="L2307">		return &quot;&quot;;</span>
	}

	/**
	 * Skontroluje captcha kod, ak v htmlData je retazes captcha.jsp
	 * @param request
	 * @param hasCaptchaInclude
	 * @return
	 */
	private static boolean checkCaptcha(HttpServletRequest request, boolean hasCaptchaInclude)
	{
<span class="fc" id="L2318">		String captchaType = Constants.getString(&quot;captchaType&quot;);</span>
<span class="pc bpc" id="L2319" title="1 of 2 branches missed.">		if (Tools.isEmpty(captchaType)) captchaType = &quot;none&quot;;</span>

<span class="pc bpc" id="L2321" title="1 of 2 branches missed.">		if (&quot;internal&quot;.equals(captchaType)==false)</span>
		{
			//nie su nastavene premenne, takze nemozeme validovat
<span class="nc bnc" id="L2324" title="All 6 branches missed.">			if(!Constants.getBoolean(&quot;reCaptchaEnabled&quot;) || Tools.isEmpty(Constants.getString(&quot;reCaptchaSiteKey&quot;)) || Tools.isEmpty(Constants.getString(&quot;reCaptchaSecret&quot;)))</span>
			{
<span class="nc" id="L2326">				captchaType = &quot;none&quot;;</span>
			}
		}

<span class="fc" id="L2330">		String captchaResponse = getCaptchaRespons(request);</span>
<span class="pc bpc" id="L2331" title="3 of 6 branches missed.">		if (&quot;none&quot;.equals(captchaType)==false &amp;&amp; (Tools.isNotEmpty(captchaResponse) || hasCaptchaInclude))</span>
		{
<span class="nc" id="L2333">			boolean captchaOK = Captcha.validateResponse(request, captchaResponse, null);</span>
<span class="nc" id="L2334">			return captchaOK;</span>
		}

<span class="fc" id="L2337">		return true;</span>
	}

	private static String getCaptchaRespons(HttpServletRequest request)
	{
<span class="fc" id="L2342">		String captchaResponse = Tools.getStringValue(request.getParameter(&quot;g-recaptcha-response&quot;), &quot;&quot;);</span>
<span class="pc bpc" id="L2343" title="1 of 2 branches missed.">		if (Tools.isEmpty(captchaResponse)) {</span>
<span class="fc" id="L2344">			captchaResponse = Tools.getStringValue(request.getParameter(&quot;wjcaptcha&quot;), &quot;&quot;);</span>
		}
<span class="fc" id="L2346">		return captchaResponse;</span>
	}

	/**
	 * Nahradi kod captcha include zadanou hodnotou pouzivatela
	 * @param request
	 * @param htmlData
	 * @return
	 */
	private static String replaceCaptchaInclude(HttpServletRequest request, String htmlData)
	{
<span class="fc" id="L2357">		String value = getCaptchaRespons(request);</span>
<span class="pc bpc" id="L2358" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(value))</span>
		{
<span class="nc" id="L2360">			htmlData = Tools.replace(htmlData, &quot;!INCLUDE(/components/form/captcha.jsp)!&quot;, value);</span>
		}
<span class="fc" id="L2362">		return htmlData;</span>
	}

	private static String appendStyle(String htmlData, String styleHtml, String emailEncoding, boolean forceTextPlain)
	{
<span class="pc bpc" id="L2367" title="1 of 4 branches missed.">		if (forceTextPlain || Constants.getBoolean(&quot;formMailSendPlainText&quot;)) return htmlData;</span>

<span class="pc bpc" id="L2369" title="1 of 2 branches missed.">		if (styleHtml == null) styleHtml = &quot;&quot;;</span>

<span class="fc" id="L2371">		String metaEncoding = &quot;&quot;;</span>
<span class="fc bfc" id="L2372" title="All 2 branches covered.">		if (Tools.isNotEmpty(emailEncoding)) metaEncoding = &quot;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=&quot;+emailEncoding+&quot;\&quot;&gt;&quot;;</span>

<span class="fc" id="L2374">		return (&quot;&lt;html&gt;&lt;head&gt;&quot;+metaEncoding+styleHtml+&quot;&lt;/head&gt;&lt;body id='WebJETEditorBody' class=\&quot;WebJETMailBody\&quot;&gt;&lt;div class=\&quot;WebJETMailWrapper\&quot;&gt;\n\n&quot;+htmlData+&quot;\n\n&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
	}

	/**
	 * Vytvori absolutne cesty v zadanom HTML kode
	 * @param htmlCode - HTML kod
	 * @return
	 */
	private static String createAbsolutePath(String htmlCode, HttpServletRequest request)
	{
<span class="fc" id="L2384">		String basePath = Tools.getBaseHref(request);</span>
		//ak je tam uz base path, tak ju zrus, inak tam bude 2x
		//zrusene, pretoze to odstranovalo domenu z technickeho info htmlCode = Tools.replace(htmlCode, basePath, &quot;&quot;);
<span class="fc" id="L2387">		htmlCode = Tools.replace(htmlCode, &quot;../&quot;, &quot;/&quot;);</span>
<span class="fc" id="L2388">		htmlCode = Tools.replace(htmlCode, &quot;url(images/&quot;, &quot;url(&quot;+basePath+&quot;/images/&quot;);</span>
<span class="fc" id="L2389">		htmlCode = Tools.replace(htmlCode, &quot;url(/images/&quot;, &quot;url(&quot;+basePath+&quot;/images/&quot;);</span>
<span class="fc" id="L2390">		htmlCode = Tools.replace(htmlCode, &quot;\&quot;/images/&quot;, &quot;\&quot;&quot;+basePath+&quot;/images/&quot;);</span>
<span class="fc" id="L2391">		htmlCode = Tools.replace(htmlCode, &quot;\&quot;/files/&quot;, &quot;\&quot;&quot;+basePath+&quot;/files/&quot;);</span>
<span class="fc" id="L2392">		htmlCode = Tools.replace(htmlCode, &quot;\&quot;/css/&quot;, &quot;\&quot;&quot;+basePath+&quot;/css/&quot;);</span>

<span class="fc" id="L2394">		return(htmlCode);</span>
	}

	private static String checkEmailCssVersion(String cssLink)
	{
<span class="fc bfc" id="L2399" title="All 2 branches covered.">		if (cssLink == null) return cssLink;</span>

		//sprav custom verziu
<span class="fc" id="L2402">		String emailCssLink = Tools.replace(cssLink, &quot;.css&quot;, &quot;-email.css&quot;);</span>
<span class="pc bpc" id="L2403" title="1 of 2 branches missed.">		if (FileTools.isFile(emailCssLink)) return emailCssLink;</span>

<span class="fc" id="L2405">		return cssLink;</span>
	}

	/**
	 * IE8 a podobne vratia ako meno suboru kompletnu cestu na disku cize c:\adresar\meno.doc, toto z toho spravi len meno.doc
	 * @param fileName
	 * @return
	 */
	private static String fixFileNameDirPath(String fileName)
	{
		try
		{
<span class="nc" id="L2417">			int lomka = fileName.lastIndexOf(&quot;/&quot;);</span>
<span class="nc bnc" id="L2418" title="All 2 branches missed.">			if (lomka &gt; 0) fileName = fileName.substring(lomka+1);</span>
<span class="nc" id="L2419">			lomka = fileName.lastIndexOf(&quot;\\&quot;);</span>
<span class="nc bnc" id="L2420" title="All 2 branches missed.">			if (lomka &gt; 0) fileName = fileName.substring(lomka+1);</span>
		}
<span class="nc" id="L2422">		catch (Exception e)</span>
		{
<span class="nc" id="L2424">			Logger.error(FormMailAction.class, e);</span>
<span class="nc" id="L2425">		}</span>

<span class="nc" id="L2427">		return fileName;</span>
	}

	/**
	 * Skontroluje CSRF token
	 * @param request
	 * @return
	 */
	private static boolean checkCsrf(HttpServletRequest request)
	{
<span class="fc" id="L2437">		String spamProtectionJavascript = Constants.getString(&quot;spamProtectionJavascript&quot;);</span>
<span class="pc bpc" id="L2438" title="1 of 2 branches missed.">		if (spamProtectionJavascript.contains(&quot;formmailCsrf&quot;)==false)</span>
		{
			//csrf token sa nepouziva
<span class="nc" id="L2441">			return true;</span>
		}
<span class="fc" id="L2443">		boolean isCorrect = CSRF.verifyTokenAndDeleteIt(request);</span>
<span class="fc" id="L2444">		return isCorrect;</span>
	}

	private static String fieldToText(String fieldName, Map&lt;String, String&gt; labelsTable)
	{
<span class="fc" id="L2449">		String label = labelsTable.get(fieldName);</span>

		//ak je to radiobutton ma vlastny label, skus najst label bez _rb_ nazvu
		//Pozadavek-na-odber-el-energie_rb_Ne -&gt; Pozadavek-na-odber-el-energie
<span class="pc bpc" id="L2453" title="2 of 4 branches missed.">		if (fieldName!=null &amp;&amp; fieldName.toLowerCase().endsWith(&quot;_rb&quot;))</span>
		{
<span class="nc" id="L2455">			int i = fieldName.indexOf(&quot;_rb&quot;);</span>
<span class="nc bnc" id="L2456" title="All 2 branches missed.">			if (i&gt;2)</span>
			{
<span class="nc" id="L2458">				String labelRadioButtons = labelsTable.get(fieldName.substring(0, i));</span>
<span class="nc bnc" id="L2459" title="All 2 branches missed.">				if (Tools.isNotEmpty(labelRadioButtons))</span>
				{
<span class="nc" id="L2461">					label = labelRadioButtons;</span>
				}
			}
		}

<span class="fc bfc" id="L2466" title="All 2 branches covered.">		if (Tools.isEmpty(label)) label = Tools.replace(fieldName, &quot;-&quot;, &quot; &quot;);</span>

<span class="fc" id="L2468">		label = Tools.replace(label, &quot; *&quot;, &quot;&quot;);</span>
<span class="fc" id="L2469">		label = Tools.replace(label, &quot;e mail&quot;, &quot;e-mail&quot;);</span>

<span class="fc" id="L2471">		return label;</span>
	}

	/**
	 * Vrati prvy email so zoznamu (email1@domena.sk,email2@domena.sk vrati email1@domena.sk)
	 * @param emails
	 * @return
	 */
	private static String getFirstEmail(String emails)
	{
<span class="pc bpc" id="L2481" title="1 of 2 branches missed.">		if (Tools.isEmpty(emails)) return &quot;&quot;;</span>

<span class="fc" id="L2483">		String[] emailsArr = Tools.getTokens(emails, &quot;,&quot;, true);</span>
<span class="pc bpc" id="L2484" title="1 of 2 branches missed.">		if (emailsArr.length&gt;0) return emailsArr[0];</span>

<span class="nc" id="L2486">		return &quot;&quot;;</span>
	}

	private static String getDoubleOptInParameters(HttpServletRequest request, int formId) {
<span class="nc" id="L2490">		String hash = Password.generateStringHash(16);</span>
<span class="nc" id="L2491">		updateHash(request, formId, hash);</span>
<span class="nc" id="L2492">		return hash;</span>
	}

	private static void updateHash(HttpServletRequest request, int formId, String hash) {
<span class="nc" id="L2496">		Connection db_conn = null;</span>
<span class="nc" id="L2497">		PreparedStatement ps = null;</span>

		try {
<span class="nc" id="L2500">			db_conn = DBPool.getConnection(request);</span>
<span class="nc" id="L2501">			ps = db_conn.prepareStatement(&quot;UPDATE forms SET double_optin_hash=? WHERE id=? &quot; + CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L2502">			ps.setString(1, hash);</span>
<span class="nc" id="L2503">			ps.setInt(2, formId);</span>
<span class="nc" id="L2504">			ps.execute();</span>
<span class="nc" id="L2505">			ps.close();</span>
<span class="nc" id="L2506">		} catch (SQLException e) {</span>
<span class="nc" id="L2507">			sk.iway.iwcm.Logger.error(e);</span>
		} finally
		{
			try
			{
<span class="nc bnc" id="L2512" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L2513" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
			}
<span class="nc" id="L2515">			catch (Exception e)</span>
			{
<span class="nc" id="L2517">				sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L2518">			}</span>
		}
<span class="nc" id="L2520">	}</span>

	/**
	 * Odoslanie notifikacie na email navstevnika, ktory ho vyplnil, zadane v poli formmail_sendUserInfoDocId
	 * @param sendUserInfoDocId
	 * @param formId
	 * @param email
	 * @param attachs
	 * @param request
	 */
	private static void sendUserInfo(int sendUserInfoDocId, int formId, String email, List&lt;IwcmFile&gt; attachs, Map&lt;String, List&lt;UploadedFile&gt;&gt; formFilesTable, HttpServletRequest request)
	{
<span class="nc" id="L2532">		DocDB docDB = DocDB.getInstance();</span>

<span class="nc" id="L2534">		DocDetails doc = docDB.getDoc(sendUserInfoDocId);</span>
<span class="nc bnc" id="L2535" title="All 2 branches missed.">		Logger.debug(FormMailAction.class,&quot;doubleOptIn=&quot;+request.getParameter(&quot;doubleOptIn&quot;)+&quot;, sendUserInfoDocId-doc=&quot;+(doc != null ? doc.getDocId() : null));</span>
<span class="nc bnc" id="L2536" title="All 2 branches missed.">		if (doc != null)</span>
		{
<span class="nc" id="L2538">			String data = SearchTools.removeCommands(doc.getData()); //odstranim z HTML riadiace bloky napr.: !INCLUDE(...)!, !PARAMETER(...)!</span>
<span class="nc" id="L2539">			StringBuilder attachments = new StringBuilder();</span>
<span class="nc bnc" id="L2540" title="All 2 branches missed.">			for (IwcmFile attach : attachs) {</span>
<span class="nc" id="L2541">				attachments.append(attach.getVirtualPath());</span>
<span class="nc" id="L2542">				attachments.append(&quot;;&quot;);</span>
<span class="nc" id="L2543">				attachments.append(attach.getName());</span>
<span class="nc" id="L2544">				attachments.append(&quot;;&quot;);</span>
<span class="nc" id="L2545">			}</span>

<span class="nc bnc" id="L2547" title="All 2 branches missed.">			if (&quot;true&quot;.equals(request.getParameter(&quot;doubleOptIn&quot;))) {</span>
<span class="nc" id="L2548">				String hash = getDoubleOptInParameters(request, formId);</span>
<span class="nc" id="L2549">				data = Tools.replace(data, &quot;!FORM_ID!&quot;, &quot;&quot; + formId);</span>
<span class="nc" id="L2550">				data = Tools.replace(data, &quot;!OPTIN_HASH!&quot;, hash);</span>
			}

<span class="nc bnc" id="L2553" title="All 2 branches missed.">			for (String parameterName: Collections.list(request.getParameterNames()))</span>
			{
<span class="nc" id="L2555">				String value = getValue(parameterName, request, formFilesTable);</span>

<span class="nc" id="L2557">				data = Tools.replace(data, &quot;!&quot; + parameterName.toUpperCase() + &quot;!&quot;, value);</span>
<span class="nc" id="L2558">				data = Tools.replace(data, &quot;!&quot; + parameterName + &quot;!&quot;, value);</span>
<span class="nc" id="L2559">			}</span>

<span class="nc" id="L2561">			String authorName = Constants.getString(&quot;formmailSendUserInfoSenderName&quot;);</span>
<span class="nc bnc" id="L2562" title="All 2 branches missed.">			if(Tools.isEmpty(authorName)) authorName = doc.getAuthorName();</span>
<span class="nc" id="L2563">			String authorEmail = Constants.getString(&quot;formmailSendUserInfoSenderEmail&quot;);</span>
<span class="nc bnc" id="L2564" title="All 2 branches missed.">			if(Tools.isEmail(authorEmail) == false) authorEmail = doc.getAuthorEmail();</span>
<span class="nc" id="L2565">			Logger.debug(FormMailAction.class,&quot;sendUserInfoSenderName=&quot;+authorName+&quot;, sendUserInfoSenderEmail=&quot;+authorEmail);</span>
<span class="nc" id="L2566">			SendMail.send(authorName, authorEmail, email, null, null, null, doc.getTitle(), &quot;&lt;html&gt;&lt;body&gt;&quot;+data+&quot;&lt;/body&gt;&lt;/html&gt;&quot;, Tools.getBaseHref(request), attachments.toString());</span>
		}
<span class="nc" id="L2568">	}</span>

	private static String toString(StringBuilder sb) {
<span class="fc bfc" id="L2571" title="All 2 branches covered.">		if (sb == null) return null;</span>
<span class="fc" id="L2572">		return sb.toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>