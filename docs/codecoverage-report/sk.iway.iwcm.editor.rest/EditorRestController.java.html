<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EditorRestController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.editor.rest</a> &gt; <span class="el_source">EditorRestController.java</span></div><h1>EditorRestController.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.editor.rest;

import java.net.URI;
import java.sql.Connection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.RequestBean;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.doc.DebugTimer;
import sk.iway.iwcm.doc.DocDB;
import sk.iway.iwcm.doc.DocDetails;
import sk.iway.iwcm.doc.HistoryDB;
import sk.iway.iwcm.doc.MultigroupMappingDB;
import sk.iway.iwcm.doc.TemplateDetails;
import sk.iway.iwcm.doc.TemplatesDB;
import sk.iway.iwcm.doc.TemplatesGroupBean;
import sk.iway.iwcm.doc.TemplatesGroupDB;
import sk.iway.iwcm.editor.EditorDB;
import sk.iway.iwcm.editor.EditorForm;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.stat.StatDB;
import sk.iway.spirit.MediaDB;
import sk.iway.spirit.model.Media;
import springfox.documentation.annotations.ApiIgnore;

// LPA - pridal som ApiIgnore, pretoze sa SwaggerUI zacyklilo na saveDoc na EditorForme. Podozrievam triedu Media.
@ApiIgnore
@RestController
@RequestMapping(path = &quot;/admin/rest/document&quot;)
@PreAuthorize(&quot;@WebjetSecurityService.hasPermission('menuWebpages')&quot;)
@SuppressWarnings({&quot;rawtypes&quot;, &quot;unchecked&quot;})
<span class="fc" id="L54">public class EditorRestController</span>
{
	@Autowired
	private HttpServletRequest request;

	@PostMapping(path = &quot;/save&quot;, produces = MediaType.APPLICATION_JSON_VALUE)
	public ResponseEntity saveDoc(EditorForm editorForm)
	{
<span class="nc" id="L62">		List&lt;String&gt; warnings = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L63">		DebugTimer dt = new DebugTimer(&quot;EditorRestController.saveDoc&quot;);</span>

<span class="nc" id="L65">		SaveDocResponseObject responseObject = new SaveDocResponseObject();</span>
<span class="nc" id="L66">		Prop prop = Prop.getInstance(request);</span>
<span class="nc" id="L67">		HttpSession session = request.getSession();</span>

<span class="nc bnc" id="L69" title="All 2 branches missed.">		if (session == null)</span>
		{
<span class="nc" id="L71">			Logger.debug(EditorRestController.class, String.format(&quot;DocId: %d, error: %s&quot;, editorForm.getDocId(), prop.getText(&quot;error.userNotLogged&quot;)));</span>
<span class="nc" id="L72">			return new ResponseEntity(prop.getText(&quot;error.userNotLogged&quot;), HttpStatus.BAD_REQUEST);</span>
		}

<span class="nc bnc" id="L75" title="All 2 branches missed.">		if (!hasData(editorForm))</span>
		{
<span class="nc" id="L77">			Logger.debug(EditorRestController.class, String.format(&quot;DocId: %d, error: %s&quot;, editorForm.getDocId(), prop.getText(&quot;editor.ajax.save.error.empty&quot;)));</span>
<span class="nc" id="L78">			warnings.add(prop.getText(&quot;editor.ajax.save.error.empty&quot;));</span>
			//return new ResponseEntity(prop.getText(&quot;editor.ajax.save.error.empty&quot;), HttpStatus.BAD_REQUEST);
		}

<span class="nc" id="L82">		Identity user = (Identity) session.getAttribute(Constants.USER_KEY);</span>
<span class="nc bnc" id="L83" title="All 4 branches missed.">		if (user == null || !user.isAdmin())</span>
		{
<span class="nc" id="L85">			Logger.debug(EditorRestController.class, String.format(&quot;DocId: %d, error: %s&quot;, editorForm.getDocId(), prop.getText(&quot;error.userNotLogged&quot;)));</span>
<span class="nc" id="L86">			return new ResponseEntity(prop.getText(&quot;error.userNotLogged&quot;), HttpStatus.BAD_REQUEST);</span>
		}

<span class="nc" id="L89">		int authorId = user.getUserId();</span>
<span class="nc" id="L90">		editorForm.setAuthorId(authorId);</span>

<span class="nc" id="L92">		DocDetails docOrig = DocDB.getInstance().getBasicDocDetails(editorForm.getDocId(), false);</span>

<span class="nc bnc" id="L94" title="All 2 branches missed.">		if (!canAccess(user, editorForm)) {</span>
<span class="nc" id="L95">			Logger.debug(EditorRestController.class, String.format(&quot;DocId: %d, error: %s&quot;, editorForm.getDocId(), prop.getText(&quot;editor.save.accessError&quot;)));</span>

<span class="nc" id="L97">			responseObject.setAjaxSaveFormPermDenied(true);</span>
<span class="nc" id="L98">			return new ResponseEntity(responseObject, HttpStatus.CONFLICT);</span>
		}

<span class="nc" id="L101">		boolean refreshMenu = refreshMenu(editorForm, docOrig, user);</span>

		//ak chcem zachovat sort priority a ukladam slave clanok, potrebujem zachovat sort priority mastra
<span class="nc" id="L104">		multiGroupKeepSortPriority(editorForm);</span>

<span class="nc" id="L106">		dt.diff(&quot;before saveEditorForm&quot;);</span>
<span class="nc" id="L107">		int historyId = EditorDB.saveEditorForm(editorForm, request);</span>
<span class="nc" id="L108">		dt.diff(&quot;after saveEditorForm&quot;);</span>

<span class="nc" id="L110">		copyMediaFromDocId(editorForm);</span>
<span class="nc" id="L111">		setLastDocId(editorForm, historyId);</span>

<span class="nc" id="L113">		session.setAttribute(&quot;editor.lastDocId&quot;, Integer.valueOf(editorForm.getLastDocId()));</span>

		//priradim docasne ulozenym mediam, spravne media_fk_id a media_fk_table_name podla docId
<span class="nc" id="L116">		assignDocIdToMedia(editorForm, historyId, user, prop);</span>

<span class="nc" id="L118">		boolean needRefresh = handleSlaves(editorForm);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">		if (needRefresh) refreshMenu = true;</span>

<span class="nc" id="L121">		request.setAttribute(&quot;editorForm&quot;, editorForm);</span>
		//session.setAttribute(&quot;editorForm&quot;, editorForm);

<span class="nc" id="L124">		dt.diff(&quot;done&quot;);</span>

		// ci sa ma refreshovat lavy strom
<span class="nc" id="L127">		responseObject.setAjaxSaveFormRefreshLeft(refreshMenu);</span>
		//docId webstranky, ma vyznam hlavne pri novych dokumentoch, kedy sa nastavuje
<span class="nc" id="L129">		responseObject.setAjaxSaveFormDocId(editorForm.getDocId());</span>
		//virtualna cesta webstranky, ma vyznam hlavne pri novych dokumentoch, kedy sa nastavuje
<span class="nc" id="L131">		responseObject.setAjaxSaveFormVirtualPath(editorForm.getVirtualPath());</span>
		//flag zobrazovania, ma sa zobrazovat?, ma vyznam hlavne pri novych dokumentoch, ktore sa maju publikovat neskor
<span class="nc" id="L133">		responseObject.setAjaxSaveFormAvailable(editorForm.isAvailable());</span>
		//docId webstranky (slave) na ktoru bolo kliknute v strome; ak sa jedna o master clanok, lastDocId = docId. Sluzi k tomu aby
		//sa v lavom strome nezvyraznil master, ale slave
<span class="nc" id="L136">		responseObject.setAjaxSaveFormLastDocId(editorForm.getLastDocId());</span>

<span class="nc" id="L138">		responseObject.setAjaxSaveFormWarnings(warnings);</span>

<span class="nc" id="L140">		return new ResponseEntity(responseObject, HttpStatus.OK);</span>
	}

	@GetMapping(path = &quot;/{docId}/{historyId}&quot;, produces = MediaType.APPLICATION_JSON_VALUE)
	public ResponseEntity&lt;EditorForm&gt; getDocHistory(@PathVariable(&quot;historyId&quot;) Integer historyId, @PathVariable(&quot;docId&quot;) Integer docId) {
<span class="nc" id="L145">		return getDoc(null, docId, historyId);</span>
	}

	@GetMapping(path = &quot;/&quot;, produces = MediaType.APPLICATION_JSON_VALUE)
	public ResponseEntity&lt;EditorForm&gt; getDoc(String url)
	{
<span class="nc bnc" id="L151" title="All 2 branches missed.">		if (Tools.isNotEmpty(url)) {</span>
<span class="nc" id="L152">			url = url.trim();</span>
		}

<span class="nc bnc" id="L155" title="All 8 branches missed.">		if (Tools.isNotEmpty(url) &amp;&amp; (url.startsWith(&quot;/&quot;) || url.startsWith(&quot;http&quot;) || Tools.getIntValue(url, -6565987) == -6565987))</span>
		{
<span class="nc bnc" id="L157" title="All 2 branches missed.">			if (url.toLowerCase().startsWith(&quot;http&quot;) == false)</span>
			{
<span class="nc" id="L159">				url = &quot;http://&quot; + DocDB.getDomain(request) + url;</span>
			}

			try
			{
<span class="nc" id="L164">				URI urlObj = new URI(url);</span>
<span class="nc" id="L165">				String domain = urlObj.getHost();</span>
<span class="nc" id="L166">				String path = urlObj.getPath();</span>
<span class="nc" id="L167">				int docId = DocDB.getDocIdFromURL(path, domain);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">				if (docId &gt; 0)</span>
				{
<span class="nc" id="L170">					return getDoc(null, docId, null);</span>
				}
			}
<span class="nc" id="L173">			catch (Exception e)</span>
			{
<span class="nc" id="L175">			}</span>
		}

<span class="nc" id="L178">		return new ResponseEntity(String.format(&quot;Page with url: %s not found&quot;, url), HttpStatus.BAD_REQUEST);</span>
	}

	@GetMapping(path = &quot;/{docId}&quot;)
	public ResponseEntity&lt;EditorForm&gt; getDoc(Integer groupId, @PathVariable(&quot;docId&quot;) Integer docId, Integer historyId)
	{
<span class="nc" id="L184">		DebugTimer dt = new DebugTimer(&quot;EditorRestController.getDoc&quot;);</span>
<span class="nc" id="L185">		Prop prop = Prop.getInstance(request);</span>

<span class="nc" id="L187">		HttpSession session = request.getSession();</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">		if (session == null)</span>
		{
<span class="nc" id="L190">			Logger.debug(EditorRestController.class, String.format(&quot;Error: %s&quot;, prop.getText(&quot;error.userNotLogged&quot;)));</span>
<span class="nc" id="L191">			return new ResponseEntity(prop.getText(&quot;error.userNotLogged&quot;), HttpStatus.BAD_REQUEST);</span>
		}

<span class="nc" id="L194">		Identity user = (Identity) session.getAttribute(Constants.USER_KEY);</span>
<span class="nc bnc" id="L195" title="All 4 branches missed.">		if (user == null || !user.isAdmin())</span>
		{
<span class="nc" id="L197">			Logger.debug(EditorRestController.class, String.format(&quot;Error: %s&quot;, prop.getText(&quot;error.userNotLogged&quot;)));</span>
<span class="nc" id="L198">			return new ResponseEntity(prop.getText(&quot;error.userNotLogged&quot;), HttpStatus.BAD_REQUEST);</span>
		}

<span class="nc" id="L201">		docId = correctDocId(docId, historyId);</span>
<span class="nc" id="L202">		groupId = correctGroupId(groupId);</span>

		// vymazem docasne ulozene media (uzivatel neulozil novu stranku po
<span class="nc" id="L205">		deleteTempMedia(docId, user);</span>

<span class="nc" id="L207">		dt.diff(&quot;load editor form - start&quot;);</span>
		// ziskajme si editorForm
<span class="nc" id="L209">		EditorForm editorForm = EditorDB.getEditorForm(request, getIntValue(docId, -1), getIntValue(historyId, -1), getIntValue(groupId, -1));</span>
<span class="nc" id="L210">		dt.diff(&quot;load editor form - end&quot;);</span>

<span class="nc bnc" id="L212" title="All 2 branches missed.">		if (editorForm == null)</span>
		{
<span class="nc" id="L214">			return new ResponseEntity(&quot;Admin error - editor form null&quot;, HttpStatus.BAD_REQUEST);</span>
		}

		// otestuj, ci mame na tento dokument pristupove prava
<span class="nc bnc" id="L218" title="All 2 branches missed.">		if (!canAccess(user, editorForm.toDocDetails())) {</span>
<span class="nc" id="L219">			Logger.debug(EditorRestController.class, String.format(&quot;DocId: %d, error: %s&quot;, editorForm.getDocId(), prop.getText(&quot;editor.save.accessError&quot;)));</span>
<span class="nc" id="L220">			return new ResponseEntity(prop.getText(&quot;editor.permsDenied&quot;), HttpStatus.CONFLICT);</span>
		}

		// lebo mozeme prist z laveho stromu, a groupId je podla session
<span class="nc" id="L224">		setSessionGroupId(session, editorForm.getGroupId());</span>
<span class="nc" id="L225">		setSessionDomainName(session, editorForm.getDomainName());</span>
<span class="nc" id="L226">		session.setAttribute(&quot;editorForm&quot;, editorForm);</span>

		// updatuje statistiku dlzky prihlasenia admina
<span class="nc" id="L229">		StatDB.addAdmin(request);</span>

		// aktualizujem zoznam uzivatelov, ktory prave edituju stranku
<span class="nc" id="L232">		EditorDB.updateUserAccessList(docId, user);</span>

<span class="nc bnc" id="L234" title="All 2 branches missed.">		if (editorForm.getTempId() &gt; 0)</span>
		{
			//nastavenie prefixu klucov podla skupiny sablon
<span class="nc" id="L237">			TemplateDetails temp = TemplatesDB.getInstance().getTemplate(editorForm.getTempId());</span>
<span class="nc bnc" id="L238" title="All 6 branches missed.">			if (temp != null &amp;&amp; temp.getTemplatesGroupId()!=null &amp;&amp; temp.getTemplatesGroupId().longValue() &gt; 0) {</span>
<span class="nc" id="L239">				TemplatesGroupBean tgb = TemplatesGroupDB.getInstance().getById(temp.getTemplatesGroupId());</span>
<span class="nc bnc" id="L240" title="All 4 branches missed.">				if (tgb != null &amp;&amp; Tools.isNotEmpty(tgb.getKeyPrefix())) {</span>
<span class="nc" id="L241">					RequestBean.addTextKeyPrefix(tgb.getKeyPrefix(), false);</span>
				}
			}

<span class="nc" id="L245">			RequestBean.addTextKeyPrefix(&quot;temp-&quot;+editorForm.getTempId(), false);</span>
		}

<span class="nc" id="L248">		dt.diff(&quot;done&quot;);</span>

<span class="nc" id="L250">		return new ResponseEntity(editorForm, HttpStatus.OK);</span>
	}

	@DeleteMapping(path = &quot;/history/{historyId}&quot;, produces = MediaType.APPLICATION_JSON_VALUE)
	public ResponseEntity deleteDocHistory(@PathVariable int historyId) {
<span class="nc" id="L255">		boolean result = false;</span>

<span class="nc bnc" id="L257" title="All 2 branches missed.">		if (historyId &gt; 0)</span>
		{
<span class="nc" id="L259">			HistoryDB historyDB = new HistoryDB(DBPool.getDBName(request));</span>
<span class="nc" id="L260">			result = historyDB.deleteHistory(historyId);</span>
		}

<span class="nc" id="L263">		return ResponseEntity.ok(result);</span>
	}

	private Integer correctDocId(Integer docId, Integer historyId) {
<span class="nc bnc" id="L267" title="All 4 branches missed.">		if (historyId != null &amp;&amp; docId == null) {</span>
<span class="nc" id="L268">			return getIntegerValue(request.getAttribute(&quot;docid&quot;), null);</span>
		}

<span class="nc" id="L271">		return docId;</span>
	}

	private Integer correctGroupId(Integer groupId) {
<span class="nc bnc" id="L275" title="All 4 branches missed.">		if (groupId == null &amp;&amp; request.getSession().getAttribute(Constants.SESSION_GROUP_ID) != null)</span>
		{
<span class="nc" id="L277">			return getIntegerValue(request.getSession().getAttribute(Constants.SESSION_GROUP_ID), null);</span>
		}

		// groupId je potrebne pri vytvarani novej web stránky
<span class="nc bnc" id="L281" title="All 2 branches missed.">		if (groupId == null) {</span>
<span class="nc" id="L282">			return Constants.getInt(&quot;rootGroupId&quot;);</span>
		}

<span class="nc" id="L285">		return groupId;</span>
	}

	private void deleteTempMedia(Integer docId, Identity user){
		// vytvoreni medii)
<span class="nc bnc" id="L290" title="All 2 branches missed.">		if (docId == null) {</span>
			try {
<span class="nc" id="L292">				MediaDB mediaDB = new MediaDB();</span>
<span class="nc" id="L293">				List&lt;Media&gt; mediaList = MediaDB.getMedia(request.getSession(), &quot;documents_temp&quot;, user.getUserId(), null, 0, false);</span>

				// ak som nasiel take media, tak im priradim spravne media_fk_id a
				// media_fk_table_name
<span class="nc bnc" id="L297" title="All 4 branches missed.">				if (mediaList != null &amp;&amp; mediaList.size() &gt; 0) {</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">					for (Media media : mediaList) {</span>
<span class="nc" id="L299">						mediaDB.delete(media);</span>
<span class="nc" id="L300">					}</span>
				}
<span class="nc" id="L302">			} catch (Exception e) {</span>
<span class="nc" id="L303">				Logger.println(EditorRestController.class, &quot;ERROR: Nastal problem pri mazani docasne ulozenych medii&quot;);</span>
<span class="nc" id="L304">			}</span>
		}
<span class="nc" id="L306">	}</span>

	private void setSessionGroupId(HttpSession session, int groupId){
<span class="nc bnc" id="L309" title="All 2 branches missed.">		if (groupId &gt; 0) {</span>
			// uloz do session groupId, aby ked kliknem na Web Stranky sa rovno
			// otvoril tento adresar
<span class="nc" id="L312">			session.setAttribute(Constants.SESSION_GROUP_ID, Integer.toString(groupId));</span>
		}
<span class="nc" id="L314">	}</span>

	private void setSessionDomainName(HttpSession session, String domainName) {
<span class="nc bnc" id="L317" title="All 2 branches missed.">		if (Tools.isNotEmpty(domainName))</span>
		{
<span class="nc" id="L319">			session.setAttribute(&quot;preview.editorDomainName&quot;, domainName);</span>
		}
<span class="nc" id="L321">	}</span>

	private void assignDocIdToMedia(EditorForm editorForm, int historyId, Identity user, Prop prop) {
<span class="nc bnc" id="L324" title="All 2 branches missed.">		boolean isNewDoc = editorForm.getDocId() &gt; 0;</span>
<span class="nc bnc" id="L325" title="All 4 branches missed.">		if (isNewDoc &amp;&amp; historyId &gt; 0) {</span>
<span class="nc" id="L326">			List&lt;Media&gt; mediaList = MediaDB.getMedia(request.getSession(), &quot;documents_temp&quot;, user.getUserId(), null, 0, false);</span>
			//ak som nasiel take media, tak im priradim spravne media_fk_id a media_fk_table_name
<span class="nc bnc" id="L328" title="All 4 branches missed.">			if (mediaList != null &amp;&amp; mediaList.size() &gt; 0) {</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">				for (Media media : mediaList) {</span>
					try {
<span class="nc" id="L331">						media.setMediaFkId(Integer.valueOf(editorForm.getDocId()));</span>
<span class="nc" id="L332">						media.setMediaFkTableName(&quot;documents&quot;);</span>
<span class="nc" id="L333">						new MediaDB().save(media);</span>
<span class="nc" id="L334">					} catch (Exception e) {</span>
<span class="nc" id="L335">						Logger.println(EditorRestController.class, prop.getText(&quot;editor.save.mediaError&quot;));</span>
<span class="nc" id="L336">					}</span>
<span class="nc" id="L337">				}</span>
			}
		}
<span class="nc" id="L340">	}</span>

	private boolean handleSlaves(EditorForm editorForm) {

<span class="nc" id="L344">		String[] otherGroupsParam = request.getParameterValues(&quot;otherGroups&quot;);</span>
<span class="nc" id="L345">		List&lt;Integer&gt; otherGroups = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">		if (otherGroupsParam != null) {</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">			for(String groupIdString : otherGroupsParam) {</span>
<span class="nc" id="L348">				int groupId = Tools.getIntValue(groupIdString, -1);</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">				if (groupId &gt; 0) otherGroups.add(Integer.valueOf(groupId));</span>
			}
		}

<span class="nc bnc" id="L353" title="All 2 branches missed.">		boolean redirect = request.getParameter(&quot;redirect&quot;) != null;</span>

<span class="nc" id="L355">		boolean ret = EditorRestController.handleSlaves(editorForm, otherGroups, redirect, request);</span>
<span class="nc" id="L356">		return ret;</span>
	}

	/**
	 * Vyriesi zapis slave mapovani pri ukladani web stranky
	 * @param editorForm
	 * @param otherGroups
	 * @param redirect
	 * @param request
	 * @return true, ak je potrebne refreshnut lave menu (pribudla/zmenila sa niekde polozka)
	 */
	public static boolean handleSlaves(EditorForm editorForm, List&lt;Integer&gt; otherGroups, boolean redirect, HttpServletRequest request) {

<span class="nc" id="L369">		boolean refreshMenu = false;</span>

<span class="nc" id="L371">		DocDB docDB = DocDB.getInstance();</span>

<span class="nc" id="L373">		Map&lt;Integer, Integer&gt; groupMapping = new HashMap&lt;&gt;();</span>
<span class="nc" id="L374">		List&lt;Integer&gt; toDelete = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L376" title="All 2 branches missed.">		if (otherGroups != null)</span>
		{
<span class="nc bnc" id="L378" title="All 2 branches missed.">			for(Integer groupId : otherGroups)</span>
			{
<span class="nc bnc" id="L380" title="All 2 branches missed.">				if (groupId == null) continue;</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">				if(groupId.intValue() &gt; 0)</span>
<span class="nc" id="L382">					groupMapping.put(groupId, -1);</span>
<span class="nc" id="L383">			}</span>
		}
<span class="nc bnc" id="L385" title="All 2 branches missed.">		for(Integer docId : MultigroupMappingDB.getSlaveDocIds(editorForm.getDocId()))</span>
		{
<span class="nc" id="L387">			DocDetails doc1 = docDB.getBasicDocDetails(docId, true);</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">			if(groupMapping.get(doc1.getGroupId()) != null)</span>
			{
<span class="nc" id="L390">				groupMapping.put(doc1.getGroupId(), docId);</span>
			}
			else
			{
				// nejaky adresar bol odstraneny, refreshni lavy strom
<span class="nc" id="L395">				refreshMenu = true;</span>
<span class="nc" id="L396">				toDelete.add(docId);</span>
			}
<span class="nc" id="L398">		}</span>

		//multikategorie (praca so slave clankami)
<span class="nc" id="L401">		DocDetails masterDoc = docDB.getDoc(editorForm.getDocId(), -1, false);</span>

		//zmaz zapisane hodnoty mapovania (nie stranky)
<span class="nc" id="L404">		MultigroupMappingDB.deleteSlaves(editorForm.getDocId());</span>

<span class="nc bnc" id="L406" title="All 2 branches missed.">		if(redirect)</span>
		{
<span class="nc" id="L408">			masterDoc.setExternalLink(masterDoc.getVirtualPath());</span>
		}

<span class="nc" id="L411">		boolean multiGroupkeepSortPriority = Constants.getBoolean(&quot;multiGroupKeepSortPriority&quot;);</span>
<span class="nc" id="L412">		int formSortPriority = editorForm.getSortPriority();</span>

<span class="nc bnc" id="L414" title="All 2 branches missed.">		for(Map.Entry&lt;Integer, Integer&gt; me : groupMapping.entrySet())</span>
		{
<span class="nc" id="L416">			Integer groupId = me.getKey();</span>
<span class="nc" id="L417">			Integer docId = me.getValue();</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">			if(docId != null)</span>
			{
<span class="nc" id="L420">				Logger.debug(EditorRestController.class, &quot;Saving slave doc: &quot;+docId+&quot; to group &quot;+groupId);</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">				if(docId &lt; 0)</span>
				{
<span class="nc" id="L423">					masterDoc.setVirtualPath(&quot;&quot;);</span>
				}
				else
				{
<span class="nc" id="L427">					masterDoc.setVirtualPath(docDB.getBasicDocDetails(docId, true).getVirtualPath());</span>
				}

				//ak chcem zachovat sort priority
<span class="nc bnc" id="L431" title="All 2 branches missed.">				if(multiGroupkeepSortPriority)</span>
				{
<span class="nc bnc" id="L433" title="All 2 branches missed.">					if(editorForm.getLastDocId() != docId.intValue())</span>
					{
<span class="nc" id="L435">						multiGroupKeepSortPriority(masterDoc, docId);</span>
					}
					else
					{
						//ak ukladam slave, beriem sort priority z formu
<span class="nc" id="L440">						masterDoc.setSortPriority(formSortPriority);</span>
					}
				}
<span class="nc" id="L443">				masterDoc.setDocId(docId);</span>
<span class="nc" id="L444">				masterDoc.setGroupId(groupId);</span>
<span class="nc" id="L445">				DocDB.saveDoc(masterDoc);</span>
<span class="nc" id="L446">				EditorDB.setDefaultDocId(masterDoc.getGroupId(), masterDoc.getDocId());</span>
				//POZOR: teraz uz mame v masterDoc.getDocId hodnotu ulozeneho SLAVE
<span class="nc" id="L448">				MultigroupMappingDB.newMultigroupMapping(masterDoc.getDocId(), editorForm.getDocId(), redirect);</span>
<span class="nc" id="L449">				docDB.updateInternalCaches(masterDoc.getDocId());</span>

				//uloz AtrDB
<span class="nc" id="L452">				Connection connection = null;</span>
				try
				{
<span class="nc" id="L455">					connection = DBPool.getConnection();</span>

<span class="nc" id="L457">					EditorDB.saveDocAttrs(docId, connection, request);</span>

<span class="nc" id="L459">					connection.close();</span>
<span class="nc" id="L460">					connection = null;</span>
				}
<span class="nc" id="L462">				catch (Exception sqle)</span>
				{
<span class="nc" id="L464">					Logger.error(EditorDB.class,&quot;DB spadlo spojenie&quot;);</span>
<span class="nc" id="L465">					sk.iway.iwcm.Logger.error(sqle);</span>
<span class="nc" id="L466">					request.getSession().setAttribute(&quot;cssError&quot;, Prop.getTxt(&quot;editor.ajax.save.error&quot;));</span>
				}
				finally{
					try{
<span class="nc bnc" id="L470" title="All 2 branches missed.">						if (connection != null) connection.close();</span>
<span class="nc" id="L471">					}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
				}

<span class="nc bnc" id="L474" title="All 2 branches missed.">				if(docId &lt; 0)</span>
				{
					// nejaky adresar bol pridany, refreshni lavy strom
<span class="nc" id="L477">					refreshMenu = true;</span>
				}
			}
<span class="nc" id="L480">		}</span>

		// odstranime DocDetails pre zmazane slave mappingy
<span class="nc bnc" id="L483" title="All 2 branches missed.">		for(Integer docId : toDelete)</span>
		{
<span class="nc" id="L485">			DocDB.deleteDoc(docId, request);</span>
<span class="nc" id="L486">		}</span>

		//ak sme nieco zmazali refreshneme DocDB
<span class="nc bnc" id="L489" title="All 2 branches missed.">		if(toDelete.size() &gt; 0)	{</span>
<span class="nc" id="L490">			DocDB.getInstance(true);</span>
		}
		else {
<span class="nc" id="L493">			docDB.forceRefreshMasterSlaveMappings(); //refreshnem master-slave mapy</span>
		}

<span class="nc" id="L496">		return refreshMenu;</span>
	}

	private void copyMediaFromDocId(EditorForm editorForm) {
<span class="nc bnc" id="L500" title="All 2 branches missed.">		boolean isNewDoc = editorForm.getDocId() &gt; 0;</span>
<span class="nc" id="L501">		int copyMediaFromDocId = editorForm.getCopyMediaFrom();</span>

<span class="nc bnc" id="L503" title="All 4 branches missed.">		if(isNewDoc &amp;&amp; copyMediaFromDocId &gt; 0)</span>
		{
<span class="nc" id="L505">			Media media = null;</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">			for(Media mediaOld: MediaDB.getMedia(request.getSession(), &quot;documents&quot;, copyMediaFromDocId, null, 0, false))</span>
			{
<span class="nc" id="L508">				media = new Media();</span>
<span class="nc" id="L509">				media.setLastUpdate(mediaOld.getLastUpdate());</span>
<span class="nc" id="L510">				media.setMediaFkId(editorForm.getDocId());</span>
<span class="nc" id="L511">				media.setMediaFkTableName(mediaOld.getMediaFkTableName());</span>
<span class="nc" id="L512">				media.setMediaGroup(mediaOld.getMediaGroup());</span>
<span class="nc" id="L513">				media.setMediaInfoCz(mediaOld.getMediaInfoCz());</span>
<span class="nc" id="L514">				media.setMediaInfoDe(mediaOld.getMediaInfoDe());</span>
<span class="nc" id="L515">				media.setMediaInfoEn(mediaOld.getMediaInfoEn());</span>
<span class="nc" id="L516">				media.setMediaInfoSk(mediaOld.getMediaInfoSk());</span>
<span class="nc" id="L517">				media.setMediaLink(mediaOld.getMediaLink());</span>
<span class="nc" id="L518">				media.setMediaSortOrder(mediaOld.getMediaSortOrder());</span>
<span class="nc" id="L519">				media.setMediaThumbLink(mediaOld.getMediaThumbLink());</span>
<span class="nc" id="L520">				media.setMediaTitleCz(mediaOld.getMediaTitleCz());</span>
<span class="nc" id="L521">				media.setMediaTitleSk(mediaOld.getMediaTitleSk());</span>
<span class="nc" id="L522">				media.setMediaTitleEn(mediaOld.getMediaTitleEn());</span>
<span class="nc" id="L523">				media.setMediaTitleDe(mediaOld.getMediaTitleDe());</span>
<span class="nc" id="L524">				new MediaDB().save(media);</span>
<span class="nc" id="L525">			}</span>
		}
<span class="nc" id="L527">	}</span>

	private void setLastDocId(EditorForm editorForm, int history_id) {
<span class="nc bnc" id="L530" title="All 2 branches missed.">		boolean isNewDoc = editorForm.getDocId() &gt; 0;</span>
<span class="nc bnc" id="L531" title="All 4 branches missed.">		if(isNewDoc &amp;&amp; history_id &gt; 0)</span>
		{
			//nastav hodnoty, aby sa nam dobre refreshol lavy panel
<span class="nc" id="L534">			editorForm.setLastDocId(editorForm.getDocId());</span>
<span class="nc" id="L535">			request.getSession().setAttribute(Constants.SESSION_GROUP_ID, String.valueOf(editorForm.getGroupId()));</span>
		}
<span class="nc" id="L537">	}</span>

	public boolean hasData(EditorForm ef) {
<span class="nc" id="L540">		String formData = Tools.getStringValue(ef.getData(), &quot;&quot;);</span>
<span class="nc" id="L541">		Logger.println(EditorRestController.class, String.format(&quot;docId: %d, dataSize: %d&quot;, ef.getDocId() , formData.length()));</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">		return formData.length() &gt; 0;</span>
	}

	private boolean canAccess(Identity user, DocDetails orig) {
<span class="nc" id="L546">		return canAccess(user, new EditorForm(orig));</span>
	}

	private boolean canAccess(Identity user, EditorForm ef) {
<span class="nc" id="L550">		String saveDocActionDontVeriryUser = Tools.getStringValue((String) request.getAttribute(&quot;saveDocActionDontVeriryUser&quot;), &quot;&quot;);</span>

<span class="nc bnc" id="L552" title="All 2 branches missed.">		if (&quot;1&quot;.equalsIgnoreCase(saveDocActionDontVeriryUser)) {</span>
<span class="nc" id="L553">			return true;</span>
		}

<span class="nc" id="L556">		return EditorDB.isPageEditable(user, ef);</span>
	}

	private boolean refreshMenu(EditorForm ef, DocDetails docOrig, Identity user) {
<span class="nc bnc" id="L560" title="All 2 branches missed.">		if (ef.getDocId() &lt; 1)</span>
		{
<span class="nc" id="L562">			return true;</span>
		}

<span class="nc bnc" id="L565" title="All 2 branches missed.">		if (docOrig != null)</span>
		{
<span class="nc bnc" id="L567" title="All 2 branches missed.">			if (docOrig.getTitle().equals(ef.getTitle()) == false) return true;</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">			if (docOrig.getExternalLink().equals(ef.getExternalLink()) == false) return true;</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">			if (docOrig.getVirtualPath().equals(ef.getVirtualPath()) == false) return true;</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">			if (docOrig.isAvailable() != ef.isAvailable()) return true;</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">			if (docOrig.getGroupId() != ef.getGroupId()) return true;</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">			if (docOrig.getSortPriority() != ef.getSortPriority()) return true;</span>
		}

<span class="nc bnc" id="L575" title="All 2 branches missed.">		if (ef.getData().indexOf(&quot;!INCLUDE(&quot;) != -1) return true;</span>

<span class="nc" id="L577">		return false;</span>
	}

	public static void multiGroupKeepSortPriority(DocDetails doc, int slaveDocId) {
<span class="nc" id="L581">		DocDB docDB = DocDB.getInstance();</span>
<span class="nc" id="L582">		DocDetails slaveDoc = docDB.getBasicDocDetails(slaveDocId, false);</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">		if(slaveDoc != null) {</span>
<span class="nc" id="L584">			doc.setSortPriority(slaveDoc.getSortPriority());</span>
		}
<span class="nc" id="L586">	}</span>

	public void multiGroupKeepSortPriority(EditorForm ef) {
<span class="nc bnc" id="L589" title="All 2 branches missed.">		boolean isNewDoc = ef.getDocId() &gt; 0;</span>
<span class="nc" id="L590">		boolean multiGroupkeepSortPriority = Constants.getBoolean(&quot;multiGroupKeepSortPriority&quot;);</span>

<span class="nc bnc" id="L592" title="All 6 branches missed.">		if(multiGroupkeepSortPriority &amp;&amp; isNewDoc == false &amp;&amp; ef.getLastDocId() != ef.getDocId())</span>
		{
<span class="nc" id="L594">			DocDetails dd = DocDB.getInstance().getBasicDocDetails(ef.getDocId(), false);</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">			if (dd != null) {</span>
<span class="nc" id="L596">				ef.setSortPriority(dd.getSortPriority());</span>
			}
		}
<span class="nc" id="L599">	}</span>

	public static Integer getIntegerValue(Object value, Integer defaultValue)
	{
<span class="nc" id="L603">		Integer ret = defaultValue;</span>
		try
		{
<span class="nc bnc" id="L606" title="All 2 branches missed.">			if (value!=null)</span>
			{
<span class="nc" id="L608">				String val = (String) value;</span>
<span class="nc" id="L609">				ret = Integer.parseInt(val.trim());</span>
			}
		}
<span class="nc" id="L612">		catch (Exception ex)</span>
		{

<span class="nc" id="L615">		}</span>
<span class="nc" id="L616">		return(ret);</span>
	}

	public static int getIntValue(Integer value, int defaultValue)
	{
<span class="nc" id="L621">		int ret = defaultValue;</span>
		try
		{
<span class="nc bnc" id="L624" title="All 2 branches missed.">			if (value != null)</span>
			{
<span class="nc" id="L626">				ret = value.intValue();</span>
			}
		}
<span class="nc" id="L629">		catch (Exception ex)</span>
		{

<span class="nc" id="L632">		}</span>
<span class="nc" id="L633">		return(ret);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>