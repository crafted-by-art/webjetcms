<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PathFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm</a> &gt; <span class="el_source">PathFilter.java</span></div><h1>PathFilter.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm;

import org.apache.commons.codec.binary.Base64;
import org.apache.struts.util.TokenProcessor;
import org.springframework.web.util.NestedServletException;
import sk.iway.iwcm.analytics.AnalyticsHelper;
import sk.iway.iwcm.common.*;
import sk.iway.iwcm.components.abtesting.ABTesting;
import sk.iway.iwcm.components.domainRedirects.DomainRedirectDB;
import sk.iway.iwcm.components.response_header.rest.ResponseHeaderService;
import sk.iway.iwcm.dmail.Sender;
import sk.iway.iwcm.doc.DebugTimer;
import sk.iway.iwcm.doc.DocDB;
import sk.iway.iwcm.doc.DocDetails;
import sk.iway.iwcm.doc.GroupDetails;
import sk.iway.iwcm.doc.ninja.Ninja;
import sk.iway.iwcm.filebrowser.EditForm;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.io.*;
import sk.iway.iwcm.stat.BrowserDetector;
import sk.iway.iwcm.stat.SessionHolder;
import sk.iway.iwcm.stat.StatDB;
import sk.iway.iwcm.system.WJResponseWrapper;
import sk.iway.iwcm.system.context.ContextFilter;
import sk.iway.iwcm.system.ntlm.AuthenticationFilter;
import sk.iway.iwcm.system.stripes.CSRF;
import sk.iway.iwcm.users.UsersDB;

import javax.servlet.*;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import javax.servlet.jsp.PageContext;
import java.io.File;
import java.io.IOException;
import java.io.OutputStream;
import java.net.SocketException;
import java.net.URL;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.*;

/**
 * Filter premapovava volania na virtualne adresare a stranky do volani na
 * spravne docid
 *
 * @Title WebJET
 * @Company Interway s.r.o. (www.interway.sk)
 * @Copyright Interway s.r.o. (c) 2001-2002
 * @author Craig McClanahan
 * @version $Revision: 1.4 $ $Date: 2004/03/01 17:03:45 $
 * @created Nede?e, 2002, okt?ber 27
 * @modified $Date: 2004/03/01 17:03:45 $
 */
@SuppressWarnings(&quot;java:S1075&quot;)
<span class="fc" id="L58">public class PathFilter implements Filter</span>
{
	private static final String CHECK_ADMIN_SESSION_KEY = &quot;pathFilter.checkAdmin&quot;;
	private static final String CHECK_WEB_ACCESS_SESSION_KEY = &quot;pathFilter.checkWebAccess&quot;;
	private static final String CHECK_DOMAIN_SESSION_KEY = &quot;pathFilter.checkDomain&quot;;
<span class="fc" id="L63">	private static String customPath = null;</span>
	private static Map&lt;String, EditForm&gt; passwordProtected;
	public static final String REQUEST_START_TIME = &quot;pathFilet.requestStartTime&quot;;

<span class="fc" id="L67">	private static String[] bypassPath = null;</span>
	//pocet sekund cache pre staticky obsah
<span class="fc" id="L69">	private static int cacheStaticContentSeconds = -1;</span>
<span class="fc" id="L70">	private static String[] cacheStaticContentSuffixes = null;</span>

	private static List&lt;ResponseHeaderBean&gt; responseHeaders;

	private static Map&lt;String, DynamicForward&gt; dynamicForwards;

	/**
	 * Inicializacia servletu
	 */
	@Override
	public void init(FilterConfig filterConfig) throws ServletException
	{
		//tu nemozeme pouzivat logger pretoze toto sa vola skor ako zbehne InitServlet
<span class="fc" id="L83">		Logger.info(PathFilter.class, &quot;PathFilter init&quot;);</span>
		try
		{
			//inicializuj password protected
			//robime az v doFilter reloadProtectedDirs();

<span class="fc" id="L89">			PathFilter.setCustomPath(filterConfig.getInitParameter(&quot;customPath&quot;));</span>
			//aby bolo mozne nastavit aj cez -Dwebjet.customPath=...
<span class="fc" id="L91">			String systemParam = System.getProperty(&quot;webjet.customPath&quot;);</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(systemParam)) PathFilter.setCustomPath(systemParam);</span>
<span class="fc" id="L93">			prepareTemplates();</span>
		}
<span class="nc" id="L95">		catch (Exception e)</span>
		{
<span class="nc" id="L97">			sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L98">		}</span>
<span class="fc" id="L99">	}</span>

	public static void registerDynamicForward(String name, DynamicForward dynamicForward)
	{
<span class="nc bnc" id="L103" title="All 2 branches missed.">		if (dynamicForwards==null) dynamicForwards = Collections.synchronizedMap(new HashMap&lt;String, DynamicForward&gt;());</span>
<span class="nc" id="L104">		dynamicForwards.put(name, dynamicForward);</span>
<span class="nc" id="L105">	}</span>

	public static void unregisterDynamicForward(String name)
	{
<span class="nc bnc" id="L109" title="All 2 branches missed.">		if (dynamicForwards==null) return;</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">		if (dynamicForwards.containsKey(name)) dynamicForwards.remove(name);</span>
<span class="nc" id="L111">	}</span>

	public static void prepareTemplates()
	{
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(customPath))</span>
		{
			//tu nemozeme pouzivat logger pretoze toto sa vola skor ako zbehne InitServlet
<span class="nc" id="L118">			Logger.info(PathFilter.class, &quot;PathFilterInit - customPath: &quot; + customPath + File.separatorChar + Constants.getInstallName());</span>
			//skopiruj templates do custom adresara
<span class="nc" id="L120">			File templatesDir = new File(customPath + File.separatorChar + Constants.getInstallName() + File.separatorChar</span>
					+ &quot;/templates/&quot;);
<span class="nc bnc" id="L122" title="All 2 branches missed.">			if (templatesDir.exists())</span>
			{
				File f;
<span class="nc" id="L125">				f = new File(Tools.getRealPath(&quot;/templates/&quot; + Constants.getInstallName() + &quot;/&quot;));</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">				if (f.exists() == false)</span>
				{
					//vytvor adresar
<span class="nc bnc" id="L129" title="All 2 branches missed.">					if(f.mkdirs() == false) return;</span>
				}
<span class="nc" id="L131">				File[] listFiles = templatesDir.listFiles();</span>
<span class="nc" id="L132">				int size = listFiles.length;</span>
				int i;
				File outFile;
<span class="nc bnc" id="L135" title="All 2 branches missed.">				for (i = 0; i &lt; size; i++)</span>
				{
<span class="nc" id="L137">					f = listFiles[i];</span>
					//Logger.println(this,&quot;copy: &quot; + f.getName());
<span class="nc" id="L139">					outFile = new File(Tools.getRealPath(</span>
<span class="nc" id="L140">							&quot;/templates/&quot; + Constants.getInstallName() + &quot;/&quot; + f.getName()));</span>
<span class="nc bnc" id="L141" title="All 4 branches missed.">					if (outFile.exists() == false || outFile.lastModified() &lt; f.lastModified())</span>
					{
						//skopiruj subory
<span class="nc" id="L144">						FileTools.copyFile(f, outFile);</span>
					}
				}
			}
		}
<span class="fc" id="L149">	}</span>

	public static String getCustomPath()
	{
<span class="fc" id="L153">		return(customPath);</span>
	}

	/**
	 * Vrati REAL PATH pre zadane URL aj s detekciou Custom Path (pouzitelne len pre staticke subory)
	 * @param url
	 * @return
	 */
	public static String getCustomPathRealPath(String url)
	{
<span class="fc" id="L163">		String realPath = PathFilter.getRealPath(url);</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">		if (PathFilter.getCustomPath() != null)</span>
		{
			//skontroluj, ci pozadovany subor nie je custom
<span class="nc" id="L167">			IwcmFile fCusom = new IwcmFile(PathFilter.getCustomPath() + File.separatorChar + Constants.getInstallName() + url.replace('/', File.separatorChar));</span>
<span class="nc bnc" id="L168" title="All 4 branches missed.">			if (fCusom.exists() &amp;&amp; fCusom.canRead()) realPath = fCusom.getAbsolutePath();</span>
		}
<span class="fc" id="L170">		return realPath;</span>
	}

	/**
	 * Take this filter out of service.
	 */
	@Override
	public void destroy()
	{
		//
<span class="fc" id="L180">	}</span>

	/**
	 * Select and set (if specified) the character encoding to be used to
	 * interpret request parameters for this request.
	 *
	 * @param chain
	 *           The filter chain we are processing
	 * @exception IOException
	 *               if an input/output error occurs
	 * @exception ServletException
	 *               if a servlet error occurs
	 */
	@Override
	public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain chain) throws IOException, ServletException
	{
<span class="fc" id="L196">		String path = null;</span>
<span class="fc" id="L197">		DebugTimer timer = null;</span>

<span class="fc" id="L199">		HttpServletRequest req = (HttpServletRequest) servletRequest;</span>
<span class="fc" id="L200">		HttpServletResponse res = (HttpServletResponse) servletResponse;</span>

		try
		{
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">			if (passwordProtected==null) reloadProtectedDirs();</span>

			//System.out.println(&quot;PathFilter.doFilter: &quot;+servletRequest.getClass());
			//System.out.println(&quot;PathFilter.doFilter: &quot;+(servletRequest instanceof HttpServletRequest));

			//req.setCharacterEncoding(&quot;windows-1250&quot;);
			//req.setAttribute(&quot;SetCharacterEncodingFilter.encoding&quot;, &quot;windows-1250&quot;);

<span class="fc" id="L212">			path = req.getRequestURI();</span>
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(req.getContextPath()))</span>
			{
<span class="nc" id="L215">				path = path.substring(req.getContextPath().length());</span>
			}
<span class="fc bfc" id="L217" title="All 2 branches covered.">			if (path.contains(&quot;//&quot;))</span>
			{
<span class="fc" id="L219">				path = Tools.replace(path, &quot;/////&quot;, &quot;/&quot;);</span>
<span class="fc" id="L220">				path = Tools.replace(path, &quot;////&quot;, &quot;/&quot;);</span>
<span class="fc" id="L221">				path = Tools.replace(path, &quot;///&quot;, &quot;/&quot;);</span>
<span class="fc" id="L222">				path = Tools.replace(path, &quot;//&quot;, &quot;/&quot;);</span>
<span class="fc" id="L223">				res.setStatus(302);</span>

<span class="fc" id="L225">				StringBuilder redir = new StringBuilder();</span>
<span class="fc" id="L226">				redir.append(Tools.sanitizeHttpHeaderParam(path));</span>
<span class="fc" id="L227">				String qs = req.getQueryString();</span>
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">				if (Tools.isNotEmpty(qs)) redir.append('?').append(qs);</span>

<span class="fc" id="L230">				res.setHeader(&quot;Location&quot;, redir.toString());</span>
				//res.sendRedirect(path);
<span class="fc" id="L232">				return;</span>
			}

			//Logger.println(this,&quot;query string PATH FILTER=&quot; + req.getQueryString());
<span class="fc" id="L236">			String qs = req.getQueryString();</span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">			boolean isFirstPathFilterCall = (req.getAttribute(&quot;path_filter_orig_path&quot;)==null);</span>
<span class="fc" id="L238">			req.setAttribute(&quot;path_filter_query_string&quot;, qs);</span>
<span class="fc" id="L239">			req.setAttribute(&quot;path_filter_orig_path&quot;, path);</span>

<span class="fc" id="L241">			setNginxProxyMode(req, res);</span>
<span class="fc" id="L242">			setXFrameOptions(res);</span>
<span class="fc" id="L243">			setAccessControlAllowOrigin(path, res);</span>
<span class="fc" id="L244">			setXXssProtection(res);</span>
<span class="fc" id="L245">			setFeaturePolicy(res);</span>
<span class="fc" id="L246">			setXRobotsTagValue(path, res);</span>
<span class="fc" id="L247">			setResponseHeaders(path, req, res);</span>

			//blokovanie akcie /showdoc.do
<span class="pc bpc" id="L250" title="1 of 4 branches missed.">			if(path.startsWith(&quot;/showdoc.do&quot;) &amp;&amp; !&quot;*&quot;.equals(Constants.getString(&quot;showDocActionAllowedDocids&quot;)))</span>
			{
<span class="nc" id="L252">				int docId = Tools.getIntValue(req.getParameter(&quot;docid&quot;), -1);</span>
<span class="nc" id="L253">				Identity user = (Identity)req.getSession().getAttribute(Constants.USER_KEY);</span>

<span class="nc bnc" id="L255" title="All 4 branches missed.">				if (Tools.isEmpty(Constants.getString(&quot;showDocActionAllowedDocids&quot;))</span>
<span class="nc bnc" id="L256" title="All 6 branches missed.">						|| ((user == null || !user.isAdmin()) &amp;&amp; path.startsWith(&quot;/showdoc.do&quot;) &amp;&amp; !isShowDocAllowDocId(docId, &quot;showDocActionAllowedDocids&quot;)))</span>
				{
<span class="nc" id="L258">					Adminlog.add(Adminlog.TYPE_CLIENT_SPECIFIC, &quot;Nepovolene pouzitie /showdoc.do docId:&quot;+docId+&quot; showDocActionAllowedDocids : &quot;+ Constants.getString(&quot;showDocActionAllowedDocids&quot;), -1, -1);</span>
<span class="nc" id="L259">					res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L260">					forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="nc" id="L261">					return;</span>
				}
			}

<span class="pc bpc" id="L265" title="2 of 6 branches missed.">			if (Constants.getInt(&quot;linkType&quot;) == Constants.LINK_TYPE_HTML &amp;&amp; path.startsWith(&quot;/showdoc.do&quot;) &amp;&amp; isFirstPathFilterCall &amp;&amp;</span>
<span class="pc bpc" id="L266" title="1 of 4 branches missed.">					req.getParameterMap().size()==1 &amp;&amp; req.getParameter(&quot;docid&quot;)!=null		)</span>
			{
				//presmeruj sa na stranku v HTML formate
<span class="fc" id="L269">				int docId = Tools.getIntValue(req.getParameter(&quot;docid&quot;), -1);</span>
<span class="pc bpc" id="L270" title="1 of 2 branches missed.">				if (docId &gt; 0)</span>
				{
<span class="fc" id="L272">					DocDB docDB = DocDB.getInstance();</span>
<span class="pc bpc" id="L273" title="3 of 6 branches missed.">					if (InitServlet.isTypeCloud() || (Constants.getBoolean(&quot;enableStaticFilesExternalDir&quot;) &amp;&amp; Constants.getBoolean(&quot;multiDomainEnabled&quot;)))</span>
					{
<span class="fc" id="L275">						DocDetails doc = DocDB.getInstance().getBasicDocDetails(docId, true);</span>
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">						if (doc!=null)</span>
						{
<span class="fc" id="L278">							GroupDetails group = GroupDetails.getById(doc.getGroupId());</span>
							//MBO: Ak je zapnuty Cloud, otestuje, ci je dany DOC dostupny pre tuto domenu, ak nie, nevykona redirect ale hodi 404
<span class="pc bpc" id="L280" title="2 of 4 branches missed.">							if (group==null || !group.getDomainName().equals(CloudToolsForCore.getDomainName()))</span>
							{
<span class="nc" id="L282">								Logger.debug(PathFilter.class, &quot;DOC ID=&quot;+docId+&quot; is not allowed for domain &quot;+ CloudToolsForCore.getDomainName());</span>
<span class="nc" id="L283">								res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L284">								forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="nc" id="L285">								return;</span>
							}
						}
					}
<span class="fc" id="L289">					String redirPath = docDB.getDocLink(docId, req);</span>

<span class="pc bpc" id="L291" title="2 of 4 branches missed.">					if (redirPath.startsWith(&quot;/showdoc.do&quot;)==false &amp;&amp; Tools.isNotEmpty(redirPath))</span>
					{
<span class="fc" id="L293">						res.setStatus(301);</span>
						//zrusene, pridanie domeny je zbytocne a potom to zle presmerovava ak sme na inom ako 80 porte if (redirPath.toLowerCase().startsWith(&quot;http&quot;)==false) redirPath = Tools.getBaseHref(req)+redirPath;
<span class="fc" id="L295">						res.setHeader(&quot;Location&quot;, redirPath);</span>
						//res.sendRedirect(redirPath);
								/*if (timer != null)		//dead code
								{
									timer.diff(&quot;   Path filter - chain, path: &quot; + path);
									DBPool.getInstance().logConnections();
								}*/
<span class="fc" id="L302">						return;</span>
					}
				}
			}

<span class="pc bpc" id="L307" title="4 of 8 branches missed.">			if (path.indexOf('\'')!=-1 || path.indexOf('&quot;')!=-1 || path.indexOf('\r')!=-1 || path.indexOf('\n')!=-1 ||</span>
<span class="pc bpc" id="L308" title="4 of 8 branches missed.">				path.contains(&quot;%0D&quot;) || path.contains(&quot;%0A&quot;) || path.contains(&quot;%0d&quot;) || path.contains(&quot;%0a&quot;) || //crlf utok</span>
<span class="pc bpc" id="L309" title="3 of 6 branches missed.">				req.getRequestURI().indexOf(&quot;//&quot;)!=-1 || path.indexOf('\\')!=-1 || path.indexOf(&quot;/../&quot;)!=-1)</span>
			{
<span class="nc bnc" id="L311" title="All 2 branches missed.">				if (DocTools.isXssStrictUrlException(path, &quot;xssProtectionStrictGetUrlException&quot;)==false)</span>
				{
					//je to pokus o XSS: /404.html/'onmouseover=prompt(915761)
<span class="nc" id="L314">					Adminlog.add(Adminlog.TYPE_XSS, &quot;XSS path=&quot;+path, -1, -1);</span>
<span class="nc" id="L315">					res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="nc" id="L316">					forwardSafely(&quot;/403.jsp&quot;, req, res);</span>
<span class="nc" id="L317">					return;</span>
				}
			}

<span class="fc bfc" id="L321" title="All 2 branches covered.">			if (Tools.replace(path.toLowerCase(), &quot;;jsessionid&quot;, &quot;jsessionid&quot;).contains(&quot;;&quot;))</span>
			{
				//utok typu /;/admin/help/search.jsp, povolene je len ;jsessionid
<span class="fc" id="L324">				res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="fc" id="L325">				forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="fc" id="L326">				return;</span>
			}

			//povolenie swagger-ui / defaultnej stranky Apache CXF (/ws)
<span class="pc bpc" id="L330" title="2 of 8 branches missed.">         if (path.contains(&quot;/swagger&quot;) || path.contains(&quot;/v2/api-docs&quot;) || path.equals(&quot;/ws&quot;) || path.equals(&quot;/ws/&quot;))</span>
         {
<span class="fc" id="L332">            boolean swaggerEnabled = Constants.getBoolean(&quot;swaggerEnabled&quot;);</span>
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">            if (swaggerEnabled)</span>
            {
               //testni, ci je povoleny aj pre neadmina
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">               if (Constants.getBoolean(&quot;swaggerRequireAdmin&quot;))</span>
               {
<span class="fc" id="L338">                  Identity user = UsersDB.getCurrentUser(req);</span>
<span class="pc bpc" id="L339" title="1 of 4 branches missed.">                  if (user==null || user.isAdmin()==false) swaggerEnabled = false;</span>
               }
            }

<span class="fc bfc" id="L343" title="All 2 branches covered.">            if (swaggerEnabled==false)</span>
            {
<span class="fc" id="L345">               Adminlog.add(Adminlog.TYPE_XSS, &quot;Swagger path is not enabled (conf. swaggerEnabled=false), path=&quot;+path, -1, -1);</span>
<span class="fc" id="L346">               res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="fc" id="L347">               forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="fc" id="L348">					return;</span>
            }
         }

<span class="pc bpc" id="L352" title="3 of 6 branches missed.">			if (path.contains(&quot;.DS_Store&quot;) || path.contains(&quot;debug.&quot;) || path.contains(&quot;config.properties&quot;))</span>
			{
<span class="nc" id="L354">				res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L355">				forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="nc" id="L356">				return;</span>
			}

			//pred bypass NESMIE byt citany ziaden parameter!!!
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">			if (&quot;true&quot;.equals(servletRequest.getAttribute(&quot;PathFilter.bypass&quot;)))</span>
			{
				//request ziadno nemodifikujeme
				try
				{
<span class="nc" id="L365">					chain.doFilter(servletRequest, servletResponse);</span>
				}
<span class="nc" id="L367">				catch (SocketException se)</span>
				{
					//toto neriesime
<span class="nc" id="L370">				}</span>
<span class="nc" id="L371">				return;</span>
			}

			//STRICT XSS FILTER (aplikuje sa na vsetky HTTP poziadavky)
<span class="fc" id="L375">			String strictXssRedirect = DocTools.getXssStrictUrlRedirect(req, path, qs);</span>
<span class="fc bfc" id="L376" title="All 2 branches covered.">			if (strictXssRedirect != null)</span>
			{
<span class="fc" id="L378">				res.sendRedirect(strictXssRedirect);</span>
<span class="fc" id="L379">				return;</span>
			}

<span class="fc" id="L382">			req.setAttribute(&quot;path_filter_orig_docid&quot;, req.getParameter(&quot;docid&quot;));</span>

<span class="fc bfc" id="L384" title="All 2 branches covered.">			if (&quot;true&quot;.equals(req.getHeader(&quot;userInServletContext&quot;)))</span>
			{
<span class="fc" id="L386">				Identity user2 = (Identity)Constants.getServletContext().getAttribute(Constants.USER_KEY);</span>
<span class="pc bpc" id="L387" title="1 of 2 branches missed.">				if (user2 != null)</span>
				{
<span class="fc" id="L389">					LogonTools.setUserToSession(req.getSession(), user2);</span>
<span class="fc" id="L390">					req.setAttribute(&quot;NO WJTOOLBAR&quot;, &quot;true&quot;);</span>
				}
			}

			//kontrola IP adries pre web sidlo, ci sa moze zobrazit
<span class="fc bfc" id="L395" title="All 2 branches covered.">			if (!checkWebAccess(req, path))</span>
			{
<span class="fc" id="L397">				Logger.debug(PathFilter.class, &quot;checkWebAccess=false, forbidden access, path=&quot;+path+&quot; ip=&quot;+Tools.getRemoteIP(req));</span>
<span class="fc" id="L398">				res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="fc" id="L399">				forwardSafely(&quot;/403.jsp&quot;, req, res);</span>
<span class="fc" id="L400">				return;</span>
			}

			//kontrola na domenove presmerovania
<span class="fc" id="L404">			String serverName = Tools.getServerName(req, false);</span>
<span class="fc" id="L405">			String redir = DomainRedirectDB.translate(serverName, path, req.getQueryString(), Tools.isSecure(req));</span>
<span class="pc bpc" id="L406" title="1 of 2 branches missed.">			if (redir != null)</span>
			{
<span class="nc" id="L408">				res.setStatus(301);</span>
<span class="nc" id="L409">				res.setHeader(&quot;Location&quot;, redir);</span>
<span class="nc" id="L410">				return;</span>
			}

			//System.out.println(&quot;PathFilter.doFilter path=&quot;+path);

<span class="fc" id="L415">			req.setAttribute(REQUEST_START_TIME, System.currentTimeMillis());</span>

<span class="fc" id="L417">			Identity user = (Identity)req.getSession().getAttribute(Constants.USER_KEY);</span>

<span class="pc bpc" id="L419" title="5 of 10 branches missed.">			if (path.startsWith(&quot;/private/rest/&quot;) || path.startsWith(&quot;/rest/private/&quot;) || path.startsWith(&quot;/rest/admin/&quot;) || path.startsWith(&quot;/websocket/private/&quot;) || path.startsWith(&quot;/websocket/admin/&quot;))</span>
			{
<span class="nc bnc" id="L421" title="All 6 branches missed.">				if (user == null || ( user.isAdmin()==false &amp;&amp; path.contains(&quot;/admin/&quot;) ))</span>
				{
<span class="nc" id="L423">					Logger.debug(PathFilter.class, &quot;Nepovoleny pristup k REST/WS&quot;);</span>
<span class="nc" id="L424">					res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="nc" id="L425">               return;</span>
				}
			}

            ///// SPRING INTEGRACIA
            // ak sa nezacina na /spring (aby sa to necyklilo) a ak je to url ktoru pozna spring, forwardne to na spring servlet
<span class="pc bpc" id="L431" title="3 of 4 branches missed.">            if (dynamicForwards!=null &amp;&amp; !dynamicForwards.isEmpty())</span>
            {
<span class="nc" id="L433">                boolean adminAccessAllowed = checkAccessToAdmin(path, req, res);</span>
<span class="nc" id="L434">                boolean privateAccessAllowed = true;</span>
<span class="nc bnc" id="L435" title="All 4 branches missed.">                if (path.startsWith(&quot;/private&quot;) &amp;&amp; UsersDB.getCurrentUser(req.getSession())==null) privateAccessAllowed = false;</span>

<span class="nc bnc" id="L437" title="All 2 branches missed.">                for (DynamicForward df : dynamicForwards.values())</span>
                {
<span class="nc bnc" id="L439" title="All 2 branches missed.">                    if (df.isValid(path))</span>
                    {
<span class="nc bnc" id="L441" title="All 4 branches missed.">                        if (adminAccessAllowed &amp;&amp; privateAccessAllowed)</span>
                        {
<span class="nc" id="L443">									boolean returnAfterForward = df.forward(path, req, res);</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">									if (returnAfterForward) return;</span>
<span class="nc" id="L445">                        }</span>
                        else
                        {
                        	//ak nie je user prihlaseny a zacina to na /components a neobsahuje rest, tak posli na 403.jsp kde ho moze redirectnut do admin casti (na logon)
<span class="nc bnc" id="L449" title="All 4 branches missed.">									if (path.startsWith(&quot;/components&quot;) &amp;&amp; path.contains(&quot;rest&quot;)==false)</span>
									{
<span class="nc" id="L451">										res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="nc" id="L452">										forwardSafely(&quot;/403.jsp&quot;, req, res);</span>
<span class="nc" id="L453">										return;</span>
									}
<span class="nc" id="L455">                           res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="nc" id="L456">                           return;</span>
                        }
                    }
<span class="nc" id="L459">                }</span>
            }

            //toto musi byt az za Springom, aby pre Spring isli aj ostatne HTTP metody
<span class="pc bpc" id="L463" title="1 of 4 branches missed.">            if (Constants.getBoolean(&quot;enableUnsafeHttpMethods&quot;) == false &amp;&amp; path.contains(&quot;/rest&quot;)==false)</span>
            {
<span class="fc" id="L465">                String method = req.getMethod().toUpperCase();</span>
                //IE zial robi dotaz na SVG aj ako HEAD, takze to musime mat ako vynimku
<span class="pc bpc" id="L467" title="1 of 4 branches missed.">                if (path.endsWith(&quot;.svg&quot;) &amp;&amp; &quot;HEAD&quot;.equals(method)) method = &quot;allowedSVG&quot;;</span>

                //vynimka pre uptimerobot.com, pouzivaju to v statnej sprave
<span class="pc bpc" id="L470" title="3 of 6 branches missed.">                if (&quot;HEAD&quot;.equals(method) || &quot;TRACE&quot;.equals(method) || &quot;OPTIONS&quot;.equals(method))</span>
                {
<span class="nc" id="L472">                    String userAgent = req.getHeader(&quot;User-Agent&quot;);</span>
<span class="nc bnc" id="L473" title="All 4 branches missed.">                    if (Tools.isNotEmpty(userAgent) &amp;&amp; userAgent.contains(&quot;uptimerobot.com&quot;))</span>
                    {
<span class="nc" id="L475">                        method = &quot;allowedUptimerobot&quot;;</span>
                    }
                }

<span class="pc bpc" id="L479" title="3 of 6 branches missed.">                if (&quot;HEAD&quot;.equals(method) || &quot;TRACE&quot;.equals(method) || &quot;OPTIONS&quot;.equals(method))</span>
                {
                    //je to pokus o XSS: /404.html/'onmouseover=prompt(915761)
<span class="nc" id="L482">                    Adminlog.add(Adminlog.TYPE_XSS, &quot;HTTP method not allowed: &quot;+method, -1, -1);</span>
<span class="nc" id="L483">                    res.setStatus(HttpServletResponse.SC_METHOD_NOT_ALLOWED);</span>
<span class="nc" id="L484">                    forwardSafely(&quot;/403.jsp&quot;, req, res);</span>
<span class="nc" id="L485">                    return;</span>
                }
            }

<span class="fc" id="L489">			String logLevel = req.getParameter(&quot;_logLevel&quot;);</span>
<span class="pc bpc" id="L490" title="1 of 2 branches missed.">			if (logLevel != null) {</span>
<span class="nc" id="L491">				Logger.setWJLogLevel(logLevel);</span>
			}

<span class="pc bpc" id="L494" title="2 of 14 branches missed.">			if (Logger.isLevel(Logger.DEBUG) &amp;&amp; path.indexOf(&quot;refresher&quot;)==-1 &amp;&amp; (path.endsWith(&quot;.do&quot;) || path.endsWith(&quot;.jsp&quot;) || path.endsWith(&quot;.html&quot;) || path.endsWith(&quot;.js&quot;) || path.endsWith(&quot;.htc&quot;)))</span>
			{
<span class="pc bpc" id="L496" title="2 of 4 branches missed.">				if (req.getParameter(&quot;showPathFilterTime&quot;)!=null || req.getSession().getAttribute(&quot;pathFilter.showPathFilterTime&quot;)!=null)</span>
				{
<span class="nc" id="L498">					req.getSession().setAttribute(&quot;pathFilter.showPathFilterTime&quot;, &quot;true&quot;);</span>
<span class="nc" id="L499">					timer = new DebugTimer(&quot;PathFilter&quot;);</span>
				}
<span class="fc" id="L501">				Logger.debug(PathFilter.class, path);</span>
			}

			//trackovanie videni emailu
<span class="fc" id="L505">			String trackGif = Constants.getString(&quot;dmailTrackopenGif&quot;);</span>
<span class="pc bpc" id="L506" title="1 of 2 branches missed.">			if(Tools.isNotEmpty(trackGif))</span>
			{
<span class="pc bpc" id="L508" title="1 of 2 branches missed.">				if(path.contains(trackGif))</span>
				{
<span class="nc" id="L510">					int emailId = Tools.getIntValue(req.getParameter(&quot;emailId&quot;), -1);</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">					if (emailId &gt; 0)</span>
					{
<span class="nc" id="L513">						EmailToolsForCore.addStatOpen(emailId);</span>
					}
				}
			}

			// url tracking with GA or something else
<span class="fc" id="L519">			AnalyticsHelper.track(path, req);</span>

			//trackovanie kliknuti na linku v emaile
<span class="fc" id="L522">			String dmailStatParamValue = req.getParameter(Constants.getString(&quot;dmailStatParam&quot;));</span>
<span class="fc bfc" id="L523" title="All 2 branches covered.">			if (Tools.isNotEmpty(dmailStatParamValue))</span>
			{
<span class="fc" id="L525">				int emailId = Sender.getEmailIdFromClickHash(dmailStatParamValue);</span>
<span class="pc bpc" id="L526" title="1 of 2 branches missed.">				if (emailId &gt; 0)</span>
				{
<span class="nc" id="L528">					String extURL = req.getParameter(&quot;extURL&quot;);</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">					if (Tools.isNotEmpty(extURL))</span>
					{
<span class="nc bnc" id="L531" title="All 2 branches missed.">						if (extURL.toLowerCase().trim().startsWith(&quot;http&quot;)==false)</span>
						{
							try
							{
<span class="nc" id="L535">								String extURL2 = Tools.replace(extURL, &quot;|&quot;, &quot;=&quot;);</span>
<span class="nc" id="L536">								Base64 b64 = new Base64();</span>
<span class="nc" id="L537">								extURL = new String(b64.decode(extURL2.getBytes()));</span>
							}
<span class="nc" id="L539">							catch (Exception e)</span>
							{
<span class="nc" id="L541">								sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L542">							}</span>
						}
<span class="nc" id="L544">						EmailToolsForCore.addStatClick(emailId, extURL, req.getQueryString(), req, res);</span>
<span class="nc" id="L545">						res.sendRedirect(extURL.replaceAll(&quot;[\r\n]&quot;, &quot;&quot;));</span>
<span class="nc" id="L546">						return;</span>
					}
					else
					{
<span class="nc" id="L550">						EmailToolsForCore.addStatClick(emailId, path, req.getQueryString(), req, res);</span>
					}
				}
			}

			//kontrola jsessionid v URL, vynimka pre .jsessionid. je pre grpd cookie modul kde sa edituje takyto kluc
<span class="pc bpc" id="L556" title="5 of 10 branches missed.">			if (path.toLowerCase().contains(&quot;jsessionid&quot;) || (req.getQueryString()!=null &amp;&amp; req.getQueryString().toLowerCase().contains(&quot;jsessionid&quot;) &amp;&amp; req.getQueryString().toLowerCase().contains(&quot;.jsessionid.&quot;)==false) || req.isRequestedSessionIdFromURL())</span>
			{
<span class="nc" id="L558">				String description = &quot;SESSION using jsessionid INVALIDATING, sessionId=&quot;+req.getSession().getId()+&quot; req IP=&quot;+Tools.getRemoteIP(req);</span>
<span class="nc" id="L559">				Logger.error(PathFilter.class, description);</span>

				//toto stale hlasi acunetix ovs ako neriesene, toto je pokus o riesenie
<span class="nc" id="L562">				req.getSession().invalidate();</span>
<span class="nc" id="L563">				req.getSession(true);</span>

<span class="nc" id="L565">				String pathFixed = path;</span>
<span class="nc" id="L566">				int i = pathFixed.toLowerCase().indexOf(&quot;;jsessionid&quot;);</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">				if (i &gt; 0) pathFixed = pathFixed.substring(0, i);</span>

<span class="nc" id="L569">				i = pathFixed.toLowerCase().indexOf(&quot;jsessionid&quot;);</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">				if (i &gt; 0) pathFixed = pathFixed.substring(0, i);</span>

<span class="nc" id="L572">				res.sendRedirect(pathFixed);</span>
<span class="nc" id="L573">				return;</span>
			}

<span class="fc" id="L576">			SessionHolder holder = SessionHolder.getInstance();</span>
<span class="fc" id="L577">			if (</span>
<span class="fc bfc" id="L578" title="All 2 branches covered.">					&quot;get&quot;.equalsIgnoreCase(req.getMethod())==false ||</span>
<span class="pc bpc" id="L579" title="1 of 14 branches missed.">				 	((path.endsWith(&quot;.do&quot;) || path.endsWith(&quot;.jsp&quot;) || path.endsWith(&quot;.html&quot;) || path.endsWith(&quot;/&quot;) || path.endsWith(&quot;.action&quot;)) &amp;&amp; path.contains(&quot;/admin/&quot;) &amp;&amp; !path.contains(&quot;/scripts/&quot;))</span>
				)
			{
				//	setni data pre SessionListener - admin cast (ostatne stranky su az dole)
<span class="pc bpc" id="L583" title="1 of 2 branches missed.">				if (holder.set(req.getSession().getId(), path, req)==false)</span>
				{
					//nastalo session stealing, spravime redirect aby nenastavali exception v JSP

<span class="nc" id="L587">					StringBuilder redirPath = new StringBuilder(path);</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">					if (Tools.isNotEmpty(req.getQueryString())) redirPath.append('?').append(req.getQueryString());</span>

<span class="nc" id="L590">					res.sendRedirect(Tools.sanitizeHttpHeaderParam(redirPath.toString()));</span>
<span class="nc" id="L591">					return;</span>
				}
			}

<span class="fc bfc" id="L595" title="All 2 branches covered.">			if (path.startsWith(&quot;/admin&quot;))</span>
			{
<span class="fc" id="L597">				boolean ret = checkAdmin(req);</span>
<span class="pc bpc" id="L598" title="1 of 2 branches missed.">				if (!ret)</span>
				{
<span class="nc" id="L600">					Logger.debug(PathFilter.class, &quot;checkAdmin=&quot;+ret+&quot; forwarding to 404.jsp&quot;);</span>
					//not found posielame aby sa admin cast tvarila akoze vobec neexistuje
<span class="nc" id="L602">					res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L603">					forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="nc" id="L604">					return;</span>
				}
				else
				{
					// cesta /admin/statchart je tam kvoli generovaniu PDF aby ho bolo mozne unsecure embednut
<span class="pc bpc" id="L609" title="5 of 6 branches missed.">					if (Constants.getBoolean(&quot;adminRequireSSL&quot;) &amp;&amp; Tools.isSecure(req) == false &amp;&amp; path.indexOf(&quot;/admin/statchart&quot;)==-1)</span>
					{
<span class="nc" id="L611">						String httpsRedirectUrl = PathFilter.getHttpsRedirectUrl(req);</span>
<span class="nc" id="L612">						Logger.debug(PathFilter.class, &quot;Redirect (adminRequireSSL): &quot; + httpsRedirectUrl);</span>
<span class="nc" id="L613">						res.sendRedirect(httpsRedirectUrl);</span>
<span class="nc" id="L614">						return;</span>
					}
				}

				//#37426 CSRF ochrana Struts formularov
<span class="fc bfc" id="L619" title="All 2 branches covered.">				if (req.getSession().getAttribute(&quot;org.apache.struts.action.TOKEN&quot;)==null)</span>
				{
					//vygeneruj token, kedze struts u nas konci vygenerujem len jeden token do session
<span class="fc" id="L622">					TokenProcessor.getInstance().saveToken(req);</span>
				}
<span class="pc bpc" id="L624" title="2 of 8 branches missed.">				else if (path.endsWith(&quot;.do&quot;) &amp;&amp; &quot;post&quot;.equalsIgnoreCase(req.getMethod()) &amp;&amp; (req.getContentType()==null || req.getContentType().contains(&quot;multipart&quot;)==false))</span>
				{
<span class="pc bpc" id="L626" title="1 of 2 branches missed.">				   if (DocTools.isXssStrictUrlException(path, &quot;xssProtectionStrictPostUrlException&quot;)==false)</span>
					{
						//validuj token
<span class="fc" id="L629">						boolean isTokenValid = TokenProcessor.getInstance().isTokenValid(req, false);</span>
<span class="pc bpc" id="L630" title="1 of 2 branches missed.">						if (isTokenValid == false)</span>
						{
<span class="nc" id="L632">						   Logger.info(PathFilter.class, &quot;Struts token not valid, path=&quot;+path);</span>
<span class="nc" id="L633">							req.setAttribute(&quot;errorText&quot;, Prop.getInstance(req).getText(&quot;components.csrfError&quot;));</span>
<span class="nc" id="L634">							forwardSafely(&quot;/components/maybeError.jsp&quot;, req, res);</span>
<span class="nc" id="L635">							return;</span>
						}
					}
				}
			}

<span class="fc bfc" id="L641" title="All 2 branches covered.">			if (!checkCSRFTokenAjax(path, req)) {</span>
<span class="fc" id="L642">				Logger.debug(PathFilter.class, &quot;CSRF token missing - header param X-CSRF-Token&quot;);</span>
<span class="fc" id="L643">				res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="fc" id="L644">				forwardSafely(&quot;/403.jsp&quot;, req, res);</span>
<span class="fc" id="L645">				return;</span>
			}

			//skus prihlasit usera (ak treba)
<span class="pc bpc" id="L649" title="2 of 6 branches missed.">			if (&quot;true&quot;.equals(req.getParameter(&quot;doFilterLogon&quot;)) || &quot;redir&quot;.equals(req.getParameter(&quot;doFilterLogon&quot;)) || Tools.isNotEmpty(req.getHeader(&quot;wjlogontoken&quot;)))</span>
			{
<span class="fc bfc" id="L651" title="All 2 branches covered.">				if (user == null)</span>
				{
<span class="fc" id="L653">					String username = req.getParameter(&quot;username&quot;);</span>
<span class="fc" id="L654">					String password = req.getParameter(&quot;password&quot;);</span>

<span class="fc" id="L656">					String token = req.getParameter(&quot;token&quot;);</span>
<span class="pc bpc" id="L657" title="1 of 2 branches missed.">					if (token == null) token = req.getHeader(&quot;wjlogontoken&quot;);</span>
<span class="pc bpc" id="L658" title="3 of 6 branches missed.">					if (Tools.isEmpty(username) &amp;&amp; Tools.isEmpty(password) &amp;&amp; Tools.isNotEmpty(token))</span>
					{
						try
						{
							//toto je len finta, token zacina na NAHODNY ZNAK aby to nebolo na prvy pohlad base64 automaticky dekodovatelne
<span class="fc" id="L663">							token = Tools.replace(token, &quot;|&quot;, &quot;=&quot;).substring(1);</span>
<span class="fc" id="L664">							Base64 b64 = new Base64();</span>
<span class="fc" id="L665">							token = new String(b64.decode(token.getBytes()));</span>
<span class="fc" id="L666">							int i = token.indexOf(&quot;:&quot;);</span>
<span class="pc bpc" id="L667" title="1 of 2 branches missed.">							if (i&gt;0)</span>
							{
<span class="fc" id="L669">								username = token.substring(0, i);</span>
<span class="fc" id="L670">								password = token.substring(i+1);</span>
							}
						}
<span class="pc" id="L673">						catch (Exception ex) {}</span>
					}

<span class="pc bpc" id="L676" title="2 of 4 branches missed.">					if (Tools.isNotEmpty(username) &amp;&amp; Tools.isNotEmpty(password))</span>
					{
<span class="fc" id="L678">						user = new Identity();</span>
<span class="fc" id="L679">						Map&lt;String, String&gt; errors = new Hashtable&lt;&gt;();</span>
<span class="fc" id="L680">						sk.iway.iwcm.i18n.Prop prop = sk.iway.iwcm.i18n.Prop.getInstance(Constants.getServletContext(), req);</span>
<span class="fc" id="L681">						String forward = LogonTools.logon(username, password, user, errors, req, prop);</span>

<span class="pc bpc" id="L683" title="1 of 2 branches missed.">						if (req.getAttribute(&quot;logon.err.noadmin&quot;)!=null)</span>
						{
								//nie je to admin, prihlasme ho ako normalneho usera, ak to zbehne, bude user v session
<span class="nc" id="L686">								LogonTools.logonUser(req, username, password);</span>
						}
<span class="pc bpc" id="L688" title="2 of 6 branches missed.">						else if (forward.compareTo(&quot;logon_ok_admin&quot;) != 0 || user == null || user.isAdmin() == false)</span>
						{
<span class="fc" id="L690">							user = null;</span>
						}
						else
						{
<span class="fc" id="L694">							user.setLoginName(username);</span>
<span class="fc" id="L695">							user.setPassword(UserTools.PASS_UNCHANGED);</span>
<span class="fc" id="L696">							user.setValid(true);</span>
							//je korektne prihlaseny
<span class="fc" id="L698">							LogonTools.setUserToSession(req.getSession(), user);</span>
<span class="fc" id="L699">							req.setAttribute(&quot;NO WJTOOLBAR&quot;, &quot;true&quot;);</span>
						}

<span class="pc bpc" id="L702" title="1 of 2 branches missed.">						if (&quot;redir&quot;.equals(req.getParameter(&quot;doFilterLogon&quot;)))</span>
						{
<span class="nc" id="L704">							res.sendRedirect(path);</span>
<span class="nc" id="L705">							return;</span>
						}
					}
				}
			}

			/*
			  Kontrola pristupu do admin casti (#10398)
			 */
<span class="fc bfc" id="L714" title="All 2 branches covered.">			if (!checkAccessToAdmin(path, req, res))</span>
			{
<span class="pc bpc" id="L716" title="3 of 6 branches missed.">				if (path.equals(&quot;/admin/refresher.jsp&quot;) == false &amp;&amp; path.equals(&quot;/admin/rest/refresher&quot;) == false &amp;&amp; path.equals(&quot;/admin/rest/monitoring/actual&quot;) == false)</span>
				{
<span class="fc" id="L718">					Adminlog.add(Adminlog.TYPE_XSS, &quot;Pouzivatel nema pristup do admin casti, presmerovavam na prihlasenie&quot;, -1, -1);</span>
				}

				//ak je to nieco ako /admin.zip /admin~ /admin_backup tak nepresmeruj ale daj chybu
<span class="pc bpc" id="L722" title="1 of 6 branches missed.">				if (path.startsWith(&quot;/admin&quot;) &amp;&amp; path.indexOf(&quot;/&quot;, 4)==-1 &amp;&amp; path.length()&gt;6) {</span>
<span class="nc" id="L723">					Logger.debug(PathFilter.class, &quot;Is file like, forwarding to 404.jsp&quot;);</span>
					//not found posielame aby sa admin cast tvarila akoze vobec neexistuje
<span class="nc" id="L725">					res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L726">					forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="nc" id="L727">					return;</span>
				}

				//na public node rovno vyhlasme 404, tiez pre nepovolene IP adresy
<span class="pc bpc" id="L731" title="2 of 4 branches missed.">				if (&quot;public&quot;.equals(Constants.getString(&quot;clusterMyNodeType&quot;)) || checkAdmin(req)==false)</span>
				{
<span class="nc" id="L733">					Logger.debug(PathFilter.class, &quot;Public node, forwarding to 404.jsp&quot;);</span>
					//not found posielame aby sa admin cast tvarila akoze vobec neexistuje
<span class="nc" id="L735">					res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L736">					forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="nc" id="L737">					return;</span>
				}

<span class="fc" id="L740">				Logger.println(PathFilter.class, &quot;Pouzivatel nema pristup do admin casti, presmerovavam na prihlasenie, path=&quot;+path + &quot; allowedUrls=&quot;+ Constants.getString(&quot;allowAdminUrls&quot;));</span>

<span class="fc" id="L742">            	LogonTools.saveAfterLogonRedirect(req);</span>

<span class="fc" id="L744">				String domainController = AuthenticationFilter.getDomainController();</span>
<span class="pc bpc" id="L745" title="1 of 2 branches missed.">				if (Tools.isNotEmpty(domainController))</span>
				{
<span class="nc" id="L747">					res.sendRedirect(&quot;/ntlm/logon.do?admin=true&quot;);</span>
				}
<span class="pc bpc" id="L749" title="1 of 2 branches missed.">				else if (path.startsWith(&quot;/admin/m/&quot;))</span>
				{
<span class="nc" id="L751">					res.sendRedirect(&quot;/admin/m/logon.jsp&quot;);</span>
				}
				else
				{
<span class="fc" id="L755">					res.sendRedirect(ContextFilter.addContextPath(req.getContextPath(), &quot;/admin/logon/&quot;));</span>
				}
<span class="fc" id="L757">				return;</span>
			}

<span class="fc bfc" id="L760" title="All 4 branches covered.">			if (path.toLowerCase().endsWith(&quot;.jsp&quot;) || path.endsWith(&quot;/&quot;))</span>
			{
<span class="pc bpc" id="L762" title="2 of 6 branches missed.">				if (path.startsWith(&quot;/images&quot;) || path.startsWith(&quot;/files&quot;) || path.startsWith(&quot;/shared&quot;))</span>
				{
<span class="fc" id="L764">					Logger.debug(PathFilter.class, &quot;Volane JSP z nepovoleneho adresara, path=&quot;+path);</span>
					//not found posielame aby sa admin cast tvarila akoze vobec neexistuje
<span class="fc" id="L766">					res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="fc" id="L767">					forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="fc" id="L768">					return;</span>
				}
			}

<span class="pc bpc" id="L772" title="1 of 2 branches missed.">			if (path.endsWith(&quot;.appcache&quot;))</span>
			{
				//handlovanie zapnutia online modu pre appcache
<span class="nc" id="L775">				String appcacheMode = Tools.getCookieValue(req.getCookies(), &quot;appcacheMode&quot;, null);</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">				if (&quot;online&quot;.equals(appcacheMode))</span>
				{
<span class="nc" id="L778">					Cookie c = new Cookie(&quot;appcacheMode&quot;, &quot;&quot;);</span>
<span class="nc" id="L779">					c.setPath(&quot;/&quot;);</span>
<span class="nc" id="L780">					c.setMaxAge(-1);</span>
<span class="nc" id="L781">					c.setHttpOnly(false);</span>
<span class="nc" id="L782">					Tools.addCookie(c, res, req);</span>

<span class="nc" id="L784">					res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L785">					return;</span>
				}
<span class="nc bnc" id="L787" title="All 2 branches missed.">				else if (req.getSession().getAttribute(Constants.USER_KEY)==null)</span>
				{
					//toto nastane, ked user nie je prihlaseny, nemozeme vtedy poslat obsah suboru, lebo sa nacachuje zoznam ako neprihlaseny user
<span class="nc" id="L790">					Logger.debug(PathFilter.class, &quot;User not logged &quot; + path);</span>
<span class="nc" id="L791">					res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="nc" id="L792">					return;</span>
				}
			}

			//skontroluj password protected
<span class="fc" id="L797">			EditForm ef = isPasswordProtected(path, req);</span>
<span class="fc bfc" id="L798" title="All 4 branches covered.">			if (ef != null &amp;&amp; ef.isAccessibleFor(user)==false)</span>
			{
<span class="pc bpc" id="L800" title="1 of 2 branches missed.">				if (doFileForbiddenRedirect(ef, user, path, req, res)) return;</span>
			}

<span class="fc bfc" id="L803" title="All 6 branches covered.">			if (path.contains(&quot;admin/&quot;) &amp;&amp; (path.endsWith(&quot;.js&quot;) || path.endsWith(&quot;.html&quot;)))</span>
			{
				//otestuj, ci existuje JSP nahrada
<span class="fc" id="L806">				File f = new File(Tools.getRealPath(path+&quot;.jsp&quot;));</span>
<span class="pc bpc" id="L807" title="3 of 4 branches missed.">				if (f.exists() &amp;&amp; f.canRead())</span>
				{
<span class="nc" id="L809">					f = null;</span>

<span class="nc" id="L811">					res.setHeader(&quot;Pragma&quot;,&quot;No-Cache&quot;);</span>
<span class="nc" id="L812">					res.setDateHeader(&quot;Expires&quot;,0);</span>
<span class="nc" id="L813">					res.setHeader(&quot;Cache-Control&quot;,&quot;no-Cache&quot;);</span>

<span class="nc" id="L815">					Logger.debug(PathFilter.class, &quot;Forwarding: &quot;+path+&quot;.jsp&quot;);</span>

<span class="nc" id="L817">					forwardSafely(path+&quot;.jsp&quot;, req, res);</span>
<span class="nc" id="L818">					return;</span>
				}
			}
<span class="fc bfc" id="L821" title="All 2 branches covered.">			if (path.endsWith(&quot;.jsp&quot;))</span>
			{
<span class="fc" id="L823">				res.setHeader(&quot;Pragma&quot;,&quot;No-Cache&quot;);</span>
<span class="fc" id="L824">				res.setDateHeader(&quot;Expires&quot;,0);</span>
<span class="fc" id="L825">				res.setHeader(&quot;Cache-Control&quot;,&quot;no-Cache&quot;);</span>
			}

			//nastav kodovanie JS suborom
<span class="fc bfc" id="L829" title="All 4 branches covered.">			if (path.indexOf(&quot;admin/&quot;)==-1 &amp;&amp; path.endsWith(&quot;.js&quot;))</span>
			{
<span class="fc" id="L831">				IwcmFile f = new IwcmFile(Tools.getRealPath(path));</span>

				//otestuj, ci existuje nahrada
<span class="fc" id="L834">				File fNahrada = new File(Tools.getRealPath(path+&quot;.jsp&quot;));</span>
<span class="pc bpc" id="L835" title="1 of 4 branches missed.">				if (fNahrada.exists() &amp;&amp; fNahrada.canRead())</span>
				{
					//jsp subor by mal nastavit kodovanie spravne
					//f = fNahrada;
					//tu nespravime nic, musi sa to sprocesovat ako JSP
				}
				else
				{
<span class="fc" id="L843">					IwcmFile fCusom = null;</span>
<span class="pc bpc" id="L844" title="1 of 2 branches missed.">					if (customPath != null)</span>
					{
						//skontroluj, ci pozadovany subor nie je custom
<span class="nc" id="L847">						fCusom = new IwcmFile(customPath + File.separatorChar + Constants.getInstallName() + path.replace('/', File.separatorChar));</span>
<span class="nc bnc" id="L848" title="All 4 branches missed.">						if (fCusom.exists() &amp;&amp; fCusom.canRead()) f = fCusom;</span>
					}
<span class="fc" id="L850">					String customUrl = WriteTagToolsForCore.getCustomPageNull(path, req);</span>
<span class="pc bpc" id="L851" title="1 of 2 branches missed.">					if (customUrl != null)</span>
					{
<span class="nc" id="L853">						fCusom = new IwcmFile(Tools.getRealPath(customUrl));</span>
<span class="nc bnc" id="L854" title="All 4 branches missed.">						if (fCusom.exists() &amp;&amp; fCusom.canRead()) f = fCusom;</span>
					}

<span class="pc bpc" id="L857" title="1 of 4 branches missed.">					if (f.exists() &amp;&amp; f.canRead())</span>
					{
<span class="fc" id="L859">						sk.iway.iwcm.Encoding.setResponseEnc(req, res, &quot;text/javascript&quot;);</span>
<span class="fc" id="L860">						boolean staticHeadersSet = setStaticContentHeaders(path, user, req, res);</span>
<span class="fc" id="L861">						setXRobotsTagValue(path, res);</span>

<span class="pc bpc" id="L863" title="2 of 6 branches missed.">						if (staticHeadersSet &amp;&amp; IwcmFsDB.useDBStorage()==false &amp;&amp; FileCache.useFileCache())</span>
						{
<span class="nc bnc" id="L865" title="All 2 branches missed.">							if (writeAndCacheFile(path, res)) return;</span>
						}
<span class="fc" id="L867">						FilePathTools.writeFileOut(f, req, res);</span>
<span class="pc bpc" id="L868" title="1 of 2 branches missed.">						if (timer != null)</span>
						{
<span class="nc" id="L870">							timer.diff(&quot;   Path filter - chain, path: &quot; + path);</span>
<span class="nc" id="L871">							DBPool.getInstance().logConnections();</span>
						}

<span class="fc" id="L874">						return;</span>
					}
				}
			}

			//posielaj admin/v9/dist/ alebo /admin/elFinder adresar ako utf-8
<span class="fc bfc" id="L880" title="All 8 branches covered.">			if ((path.startsWith(&quot;/admin/v9/dist&quot;) || path.startsWith(&quot;/admin/elFinder&quot;)) &amp;&amp; (path.endsWith(&quot;.js&quot;) || path.endsWith(&quot;.css&quot;)))</span>
			{
<span class="fc" id="L882">				IwcmFile f = new IwcmFile(Tools.getRealPath(path));</span>
<span class="pc bpc" id="L883" title="2 of 4 branches missed.">				if (f.exists() &amp;&amp; f.canRead())</span>
				{
<span class="fc" id="L885">					String encoding = &quot;text/javascript&quot;;</span>
<span class="fc bfc" id="L886" title="All 2 branches covered.">					if (path.endsWith(&quot;.css&quot;)) encoding = &quot;text/css&quot;;</span>
<span class="fc" id="L887">					sk.iway.iwcm.Encoding.setResponseEnc(req, res, encoding);</span>
<span class="fc" id="L888">					setStaticContentHeaders(path, user, req, res);</span>
<span class="fc" id="L889">					setXRobotsTagValue(path, res);</span>

					//Logger.debug(PathFilter.class, &quot;Sending DIST file: &quot; + f.getAbsolutePath());
<span class="fc" id="L892">					FilePathTools.writeFileOut(f, req, res);</span>

<span class="fc" id="L894">					return;</span>
				}
			}

<span class="fc" id="L898">         	setDownloadHeaders(path, req, res);</span>
<span class="fc" id="L899">			boolean staticHeadersSet = setStaticContentHeaders(path, user, req, res);</span>
<span class="pc bpc" id="L900" title="2 of 6 branches missed.">			if (staticHeadersSet &amp;&amp; IwcmFsDB.useDBStorage()==false &amp;&amp; FileCache.useFileCache())</span>
			{
<span class="nc bnc" id="L902" title="All 2 branches missed.">				if (writeAndCacheFile(path, res)) return;</span>
			}

			//toto standardne Tomcat nepozna, pridame hlavicky podla specky
<span class="pc bpc" id="L906" title="1 of 4 branches missed.">			if (path.endsWith(&quot;.woff2&quot;) || path.endsWith(&quot;.woff&quot;))</span>
			{
<span class="pc bpc" id="L908" title="1 of 2 branches missed.">				if (path.endsWith(&quot;.woff2&quot;)) res.setHeader(&quot;Content-Type&quot;, &quot;font/woff2&quot;);</span>
<span class="nc" id="L909">				else res.setHeader(&quot;Content-Type&quot;, &quot;font/woff&quot;);</span>
			}

			//disable direct call to abtesting variant URL eg. /investicie/abtestvariantb.html for NON admin users
<span class="fc bfc" id="L913" title="All 2 branches covered.">			if (path.contains(Constants.getString(&quot;ABTestingName&quot;)))</span>
			{
<span class="fc bfc" id="L915" title="All 2 branches covered.">				if (Constants.getBoolean(&quot;ABTestingAllowVariantUrl&quot;)==false) {</span>
<span class="pc bpc" id="L916" title="1 of 4 branches missed.">					if (user == null || user.isAdmin()==false) {</span>
<span class="fc" id="L917">						Logger.debug(PathFilter.class, &quot;ABTesting direct call, not allowed for non admin, forwarding to 404.jsp&quot;);</span>
<span class="fc" id="L918">						res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="fc" id="L919">						forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="fc" id="L920">						return;</span>
					}
				} else {
					//prefer URL variant instead of cookie value
<span class="fc" id="L924">					req.setAttribute(&quot;ABTestingPrefferVariantUrl&quot;, &quot;true&quot;);</span>
				}
			}

			//accessDocId je docId web stranky, ktoru sa zobrazuje, ku ktorej sa pristupuje z verejnej casti sidla, nie admin cast
<span class="fc" id="L929">			DocDB docDB = DocDB.getInstance();</span>
<span class="fc" id="L930">			String domain = DocDB.getDomain(req);</span>
<span class="fc" id="L931">			int accessDocId = -1;</span>
			//files adresar musime nechat povoleny kvoli linkam z fulltext indexu (/files/subor.xls.html) a presmerovaniu na subor.xls
<span class="pc bpc" id="L933" title="1 of 6 branches missed.">			if (path.startsWith(&quot;/images&quot;)==false &amp;&amp; path.startsWith(&quot;/css&quot;)==false &amp;&amp; path.startsWith(&quot;/jscripts&quot;)==false)</span>
			{
<span class="pc bpc" id="L935" title="1 of 2 branches missed.">				if (Constants.getBoolean(&quot;ABTesting&quot;)==true)</span>
				{
<span class="fc" id="L937">					accessDocId = ABTesting.getVirtualPathDocId(path, domain, req, res);</span>
				}
				else
				{
					//upravene takto ak nie je vobec abtesting trieda dostupna (napr. v cloude)
<span class="nc" id="L942">					accessDocId = docDB.getVirtualPathDocId(path, domain);</span>
				}
			}

			//TatraBanka - ich proxy dava na koniec za .do kontext /, cize zo /showdoc.do?docid=4 vznikne /showdoc.do/
				/*
				if (accessDocId &lt; 1 &amp;&amp; &quot;/showdoc.do/&quot;.equals(path))
				{
					req.getRequestDispatcher(&quot;/showdoc.do&quot;).forward(req, res);
				}
				*/

<span class="fc bfc" id="L954" title="All 2 branches covered.">			if (accessDocId &gt; 0)</span>
			{
				//kontrola spravnosti domeny
<span class="pc bpc" id="L957" title="1 of 2 branches missed.">				if (!checkDomain(req))</span>
				{
<span class="nc" id="L959">					Logger.debug(PathFilter.class, &quot;checkDomain=false, forwarding to 404.jsp&quot;);</span>
<span class="nc" id="L960">					res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L961">					forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="nc" id="L962">					return;</span>
				}

				//porovnaj URL a pripadne sprav redirect
<span class="fc" id="L966">				String realUrl = docDB.getDocLink(accessDocId, req);</span>
<span class="pc bpc" id="L967" title="1 of 6 branches missed.">				if (realUrl!=null &amp;&amp; realUrl.equals(path)==false &amp;&amp; !realUrl.contains(Constants.getString(&quot;ABTestingName&quot;)))</span>
				{
					//URL so znakom * sa odstranuju, musime specialne skontrolovat
<span class="fc" id="L970">					String virtualPath = docDB.getBasicDocDetails(accessDocId, true).getVirtualPath();</span>
<span class="pc bpc" id="L971" title="1 of 4 branches missed.">					if (virtualPath == null || virtualPath.indexOf(&quot;*&quot;)==-1)</span>
					{
<span class="fc" id="L973">						Logger.debug(PathFilter.class, &quot;nesedi real URL, redirecting to: &quot;+realUrl);</span>
<span class="fc" id="L974">						res.setStatus(301);</span>
<span class="pc bpc" id="L975" title="1 of 2 branches missed.">						if (Tools.isNotEmpty(req.getQueryString())) realUrl += '?'+req.getQueryString();</span>
<span class="pc bpc" id="L976" title="1 of 2 branches missed.">						if (realUrl.toLowerCase().startsWith(&quot;http&quot;)==false) realUrl = Tools.getBaseHref(req)+realUrl;</span>
<span class="fc" id="L977">						res.setHeader(&quot;Location&quot;, Tools.sanitizeHttpHeaderParam(realUrl));</span>
<span class="fc" id="L978">						return;</span>
					}
				}

				//	setni data pre SessionListener - customer cast
<span class="fc" id="L983">				String lastURL = path;</span>
<span class="fc bfc" id="L984" title="All 2 branches covered.">				if (req.getQueryString()!=null)</span>
				{
<span class="fc" id="L986">					path = path + &quot;?&quot; + req.getQueryString();</span>
				}

<span class="pc bpc" id="L989" title="1 of 2 branches missed.">				if (holder.set(req.getSession().getId(), lastURL, req)==false)</span>
				{
					//nastalo session stealing, spravime redirect aby nenastavali exception v JSP

<span class="nc" id="L993">					StringBuilder redirPath = new StringBuilder(path);</span>
<span class="nc bnc" id="L994" title="All 2 branches missed.">					if (Tools.isNotEmpty(req.getQueryString())) redirPath.append('?').append(req.getQueryString());</span>

<span class="nc" id="L996">					res.sendRedirect(Tools.sanitizeHttpHeaderParam(redirPath.toString()));</span>
<span class="nc" id="L997">					return;</span>
				}

				//akoze skuska ochrany pred chybou Cannot create a session after the response has been committed
<span class="fc bfc" id="L1001" title="All 2 branches covered.">				if (req.getSession().getAttribute(&quot;preventCannotCreateSession&quot;)==null)</span>
				{
<span class="fc" id="L1003">					req.getSession().setAttribute(&quot;preventCannotCreateSession&quot;, &quot;1&quot;);</span>
				}

				//Logger.println(this,&quot;forwarding to docId: &quot; + docId);
<span class="fc" id="L1007">				StringBuilder url = new StringBuilder(&quot;/showdoc.do?docid=&quot;).append(accessDocId);</span>

<span class="fc bfc" id="L1009" title="All 2 branches covered.">				if (&quot;get&quot;.equalsIgnoreCase(req.getMethod()))</span>
				{
					String name;
					String[] values;
<span class="fc" id="L1013">					Enumeration&lt;String&gt; params = req.getParameterNames();</span>
<span class="fc bfc" id="L1014" title="All 2 branches covered.">					while (params.hasMoreElements())</span>
					{
<span class="fc" id="L1016">						name = params.nextElement();</span>
<span class="pc bpc" id="L1017" title="1 of 4 branches missed.">						if (name.equals(&quot;docid&quot;) || name.equals(&quot;password&quot;)) continue;</span>
<span class="fc" id="L1018">						values = req.getParameterValues(name);</span>
<span class="fc bfc" id="L1019" title="All 2 branches covered.">						for (int i = 0; i &lt; values.length; i++)</span>
						{
<span class="fc" id="L1021">							url.append(&quot;&amp;&quot;).append(Tools.sanitizeHttpHeaderParam(name)).append('=').append(Tools.sanitizeHttpHeaderParam(values[i]));</span>
						}
					}
				}

<span class="fc" id="L1026">				Logger.debug(PathFilter.class, &quot;PathFilter, url: &quot; + url + &quot; domain=&quot;+domain+&quot; origUrl=&quot;+path+&quot; qs=&quot;+req.getQueryString());</span>
<span class="pc bpc" id="L1027" title="9 of 10 branches missed.">				if (Constants.getInt(&quot;linkType&quot;) == Constants.LINK_TYPE_HTML || path.endsWith(&quot;.php&quot;) || path.endsWith(&quot;.asp&quot;) || path.endsWith(&quot;.aspx&quot;) || Constants.getBoolean(&quot;forwardVirtualPath&quot;))</span>
				{
<span class="fc" id="L1029">					req.setAttribute(&quot;docid&quot;, Integer.toString(accessDocId));</span>
<span class="fc" id="L1030">					Logger.debug(PathFilter.class, &quot;forwarding1: req=&quot; + req + &quot; resp=&quot;+res);</span>

<span class="fc" id="L1032">					String packagerMode = Constants.getString(&quot;packagerMode&quot;);</span>
<span class="fc" id="L1033">					String packagerModeParam = req.getParameter(&quot;_packagerMode&quot;);</span>
<span class="pc bpc" id="L1034" title="1 of 2 branches missed.">					if (Tools.isNotEmpty(packagerModeParam)) packagerMode = packagerModeParam;</span>

<span class="pc bpc" id="L1036" title="3 of 4 branches missed.">					if (Tools.isEmpty(packagerMode) || &quot;none&quot;.endsWith(packagerMode))</span>
					{
<span class="fc" id="L1038">						req.getRequestDispatcher(&quot;/showdoc.do?docid=&quot; + accessDocId).forward(req, res);</span>
					}
					else
					{
<span class="nc" id="L1042">						long start = Tools.getNow();</span>

<span class="nc" id="L1044">						WJResponseWrapper respWrapper = new WJResponseWrapper(res, req);</span>
<span class="nc" id="L1045">						req.getRequestDispatcher(&quot;/showdoc.do?docid=&quot; + accessDocId).forward(req, respWrapper);</span>
<span class="nc" id="L1046">						StringBuilder htmlCode = new StringBuilder(respWrapper.strWriter.getBuffer().toString());</span>

<span class="nc" id="L1048">						String fixedHtml = htmlCode.toString();</span>

						//moznost prepnutia packagera (pre kazdy pripad)
<span class="nc" id="L1051">						String packagerModeAttr = (String)req.getAttribute(&quot;packagerMode&quot;);</span>
<span class="nc bnc" id="L1052" title="All 2 branches missed.">						if (packagerModeAttr!=null) packagerMode = packagerModeAttr;</span>

						//ak je treba posli redirect
<span class="nc bnc" id="L1055" title="All 2 branches missed.">						if (Tools.isNotEmpty(respWrapper.getRedirectURL())) res.sendRedirect(respWrapper.getRedirectURL());</span>

<span class="nc" id="L1057">						long end = Tools.getNow();</span>
<span class="nc" id="L1058">						Logger.debug(PathFilter.class, &quot;Packager: HTML packaging tooks: &quot; + (end-start) + &quot;ms&quot;);</span>

						//zapis vystup
<span class="nc" id="L1061">						respWrapper.writeResponseToOriginalOutput(req, fixedHtml);</span>
					}
<span class="fc" id="L1063">				}</span>
				else
				{
<span class="nc" id="L1066">					Logger.debug(PathFilter.class, &quot;redirecting: req=&quot;+req+&quot; resp=&quot;+res);</span>
<span class="nc" id="L1067">					res.sendRedirect(req.getContextPath() + url.toString());</span>
				}
<span class="pc bpc" id="L1069" title="1 of 2 branches missed.">				if (timer != null)</span>
				{
<span class="nc" id="L1071">					timer.diff(&quot;   Path filter - chain, path: &quot; + path);</span>
<span class="nc" id="L1072">					DBPool.getInstance().logConnections();</span>
				}
<span class="fc" id="L1074">				return;</span>
			}
			else
			{
<span class="fc bfc" id="L1078" title="All 2 branches covered.">				if (&quot;/sitemap.xml&quot;.equals(path))</span>
				{
					//nie je definovana stranka s URL /sitemap.xml, priamo forwardnem
					//je to tu kvoli cloudu, pretoze do 404.jsp uz dorazi request a nema RequestBean (zjavne sa to vola az po skonceni filtrov)
<span class="fc" id="L1082">					res.setContentType(&quot;text/xml; charset=utf-8&quot;);</span>
<span class="fc" id="L1083">					res.setStatus(HttpServletResponse.SC_OK);</span>
<span class="fc" id="L1084">					String customPage = WriteTagToolsForCore.getCustomPage(&quot;/components/sitemap/google-sitemap.jsp&quot;, req);</span>
<span class="fc" id="L1085">					forwardSafely(customPage, req, res);</span>
<span class="fc" id="L1086">					return;</span>
				}
			}

<span class="pc bpc" id="L1090" title="1 of 8 branches missed.">			if ((path.startsWith(&quot;/components/&quot;) || path.startsWith(&quot;/templates/&quot;)) &amp;&amp; path.lastIndexOf('.') &gt; path.lastIndexOf('/') &amp;&amp; path.equals(&quot;/components/editoricon.gif&quot;)==false)</span>
			{
				try
				{
					//skus najst nahradu za pozadovanu stranku
<span class="fc" id="L1095">					String customPage = WriteTagToolsForCore.getCustomPage(path, req);</span>
<span class="pc bpc" id="L1096" title="1 of 2 branches missed.">					if (customPage.equals(path)==false)</span>
					{
<span class="nc" id="L1098">						forwardSafely(customPage, req, res);</span>
<span class="nc" id="L1099">						return;</span>
					}

<span class="fc bfc" id="L1102" title="All 2 branches covered.">					if (path.endsWith(&quot;editor_component.jsp&quot;))</span>
					{
						//over ci existuje, ak nie, pouzi defaultnu
<span class="fc bfc" id="L1105" title="All 2 branches covered.">						if (WriteTagToolsForCore.isFileExists(path)==false)</span>
						{
							try
							{
								//tu mame plne meno povodneho suboru v include
<span class="fc" id="L1110">								String jspFileName = req.getParameter(&quot;jspFileName&quot;);</span>
<span class="pc bpc" id="L1111" title="1 of 2 branches missed.">								if (jspFileName != null)</span>
								{
<span class="nc bnc" id="L1113" title="All 2 branches missed.">									if (jspFileName.startsWith(&quot;!INCLUDE(&quot;)) jspFileName = jspFileName.substring(9).trim();</span>

									//skus verziu s odstranenou druhou castou, /components/iway/news/editor_component.jsp -&gt; /components/news/editor_component.jsp
<span class="nc" id="L1116">									String pathBezDruhejCasti = &quot;/components&quot;+path.substring(path.indexOf(&quot;/&quot;, 13));</span>
<span class="nc bnc" id="L1117" title="All 2 branches missed.">									if (WriteTagToolsForCore.isFileExists(pathBezDruhejCasti))</span>
									{
										//mame custom subor, ak ale existuje nastaveny CONF kluc k danemu suboru nepouzijeme
<span class="nc" id="L1120">										String CONF_KEY = jspFileName.substring(0, jspFileName.lastIndexOf('.')).replace('/', '.').substring(1);</span>
<span class="nc" id="L1121">										Prop prop = Prop.getInstance(req);</span>
										//ak kluc neexistuje pouzijeme
<span class="nc bnc" id="L1123" title="All 4 branches missed.">										if (prop.getText(CONF_KEY+&quot;.conf.propSearchKey&quot;).equals(CONF_KEY+&quot;.conf.propSearchKey&quot;) &amp;&amp; prop.getText(CONF_KEY+&quot;.conf&quot;).equals(CONF_KEY+&quot;.conf&quot;))</span>
										{
<span class="nc" id="L1125">											Logger.debug(PathFilter.class, &quot;forwarding to:&quot;+pathBezDruhejCasti);</span>
<span class="nc" id="L1126">											req.getRequestDispatcher(WriteTagToolsForCore.getCustomPage(pathBezDruhejCasti, req)).forward(req, res);</span>
										}
									}
								}
							}
<span class="nc" id="L1131">							catch (Exception ex)</span>
							{
<span class="nc" id="L1133">								sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L1134">							}</span>

<span class="fc" id="L1136">							req.getRequestDispatcher(WriteTagToolsForCore.getCustomPage(&quot;/components/editor_component_universal.jsp&quot;, req)).forward(req, res);</span>
<span class="fc" id="L1137">							return;</span>
						}

					}
				}
<span class="nc" id="L1142">				catch (RuntimeException e)</span>
				{
<span class="nc" id="L1144">					sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L1145">				}</span>

			}
			//podpora custom pluginov v editore - NETREBA uz bereme z dist priecinka
			/*if (path.startsWith(&quot;/admin/skins/webjet8/ckeditor/dist/plugins/&quot;) || path.startsWith(&quot;/admin/skins/webjet8/ckeditor/plugins/&quot;))
			{
				path = Tools.replace(path, &quot;/admin/skins/webjet8/ckeditor/dist/plugins/&quot;, &quot;/admin/ckeditor/plugins/&quot;);
				path = Tools.replace(path, &quot;/admin/skins/webjet8/ckeditor/plugins/&quot;, &quot;/admin/ckeditor/plugins/&quot;);
				String customPage = WriteTagToolsForCore.getCustomPageAdmin(path, req);
				if (customPage != null)
				{
					req.getRequestDispatcher(customPage).forward(req, res);
					return;
				}
			}*/
<span class="pc bpc" id="L1160" title="2 of 4 branches missed.">			if (path.endsWith(&quot;.php&quot;) || path.endsWith(&quot;.asp&quot;))</span>
			{
				//skus najst JSP verziu stranky
<span class="nc" id="L1163">				String jspPath = path.substring(0, path.length() - 4) + &quot;.jsp&quot;;</span>
<span class="nc" id="L1164">				File jspFile = new File(Tools.getRealPath(jspPath));</span>
<span class="nc bnc" id="L1165" title="All 2 branches missed.">				if (jspFile.exists())</span>
				{
<span class="nc" id="L1167">					forwardSafely(jspPath, req, res);</span>
<span class="nc bnc" id="L1168" title="All 2 branches missed.">					if (timer != null)</span>
					{
<span class="nc" id="L1170">						timer.diff(&quot;   Path filter - chain, path: &quot; + path);</span>
<span class="nc" id="L1171">						DBPool.getInstance().logConnections();</span>
					}
<span class="nc" id="L1173">					return;</span>
				}
			}
<span class="pc bpc" id="L1176" title="1 of 2 branches missed.">			if (customPath != null)</span>
			{
				//skontroluj, ci pozadovany subor nie je custom
<span class="nc" id="L1179">				IwcmFile f = new IwcmFile(customPath + File.separatorChar + Constants.getInstallName() + path.replace('/', File.separatorChar));</span>

<span class="nc bnc" id="L1181" title="All 2 branches missed.">				if (f.exists()==false)</span>
				{
<span class="nc" id="L1183">					f = new IwcmFile(Tools.getRealPath(&quot;/templates/&quot; + Constants.getInstallName() + &quot;/assets&quot; + path));</span>
				}

<span class="nc bnc" id="L1186" title="All 12 branches missed.">				if (f.exists()==false &amp;&amp; path.contains(&quot;/admin/docsify/&quot;) &amp;&amp; &quot;iwcm.interway.sk&quot;.equals(req.getServerName()) &amp;&amp; user != null &amp;&amp; user.isAdmin() &amp;&amp; path.contains(&quot;..&quot;)==false)</span>
                {
                    //je to docsify subor, ten mame inde, musime upravit
<span class="nc" id="L1189">                    f = new IwcmFile(Tools.getRealPath(&quot;/&quot;));</span>
<span class="nc" id="L1190">                    f = new IwcmFile(f.getParentFile(), path.substring(6).replace('/', File.separatorChar));</span>
                }

				//Logger.println(this,&quot;Checking CUSTOM: &quot;+f.getAbsolutePath());
<span class="nc bnc" id="L1194" title="All 4 branches missed.">				if (f.exists() &amp;&amp; f.isFile())</span>
				{
					//existuje custom subor, posli ho na vystup
<span class="nc bnc" id="L1197" title="All 4 branches missed.">					if (path.toLowerCase().endsWith(&quot;.jsp&quot;) || path.toLowerCase().endsWith(&quot;.class&quot;))</span>
					{
						//toto este nevieme, nerob nic
<span class="nc" id="L1200">						Logger.error(this,&quot;TOTO AKO CUSTOM NEVIEM: &quot; + path);</span>
					}
					else
					{
						//Logger.println(this,&quot;sending custom page:
						// &quot;+f.getAbsolutePath());
						//je to nejaky obrazok, alebo subor, posli na vystup
<span class="nc" id="L1207">						FilePathTools.writeFileOut(f, req, res);</span>
						//Logger.println(this,&quot;Zapisany subor: &quot; + path);
<span class="nc bnc" id="L1209" title="All 2 branches missed.">						if (timer != null)</span>
						{
<span class="nc" id="L1211">							timer.diff(&quot;   Path filter - chain, path: &quot; + path);</span>
<span class="nc" id="L1212">							DBPool.getInstance().logConnections();</span>
						}
<span class="nc" id="L1214">						return;</span>
					}
				}
			}

<span class="fc bfc" id="L1219" title="All 4 branches covered.">			if (FilePathTools.isExternalDir(path) &amp;&amp; path.startsWith(&quot;/files/protected/&quot;)==false)</span>
			{
				//externy adresar pre cloudStaticFilesDir folder
<span class="fc" id="L1222">				boolean fileWritten = FilePathTools.writeFileOut(path, req, res);</span>
<span class="pc bpc" id="L1223" title="1 of 2 branches missed.">				if (fileWritten)</span>
				{
<span class="pc bpc" id="L1225" title="1 of 2 branches missed.">					if (timer != null)</span>
					{
<span class="nc" id="L1227">						timer.diff(&quot;   Path filter - chain, path: &quot; + path);</span>
<span class="nc" id="L1228">						DBPool.getInstance().logConnections();</span>
					}
<span class="fc" id="L1230">					return;</span>
				}
			}

			//zaslanie fresh suboru pre elfinder (volane len s parametrom v=xxx) po zmene velkosti
			//tomcat 8 totiz nejako divne cachuje obrazky a aj ked ho zmenime tak to nepomoze a vrati povodny
<span class="fc bfc" id="L1236" title="All 6 branches covered.">			if (user != null &amp;&amp; user.isAdmin() &amp;&amp; req.getParameter(&quot;v&quot;)!=null)</span>
			{
<span class="fc" id="L1238">				String mimeType = Constants.getServletContext().getMimeType(path.toLowerCase());</span>
<span class="fc bfc" id="L1239" title="All 2 branches covered.">				if (Tools.isEmpty(mimeType)) mimeType = &quot;application/octet-stream&quot;;</span>
<span class="fc bfc" id="L1240" title="All 4 branches covered.">				if (mimeType.startsWith(&quot;image/&quot;) &amp;&amp; path.startsWith(&quot;/images&quot;))</span>
				{
<span class="fc" id="L1242">					IwcmFile f = new IwcmFile(Tools.getRealPath(path));</span>
<span class="pc bpc" id="L1243" title="2 of 4 branches missed.">					if (f.exists() &amp;&amp; f.canRead()) {</span>
<span class="fc" id="L1244">						FilePathTools.writeFileOut(f, req, res);</span>
						//Logger.println(this,&quot;Zapisany subor: &quot; + path);
<span class="pc bpc" id="L1246" title="1 of 2 branches missed.">						if (timer != null)</span>
						{
<span class="nc" id="L1248">							timer.diff(&quot;   Path filter - chain, path: &quot; + path);</span>
<span class="nc" id="L1249">							DBPool.getInstance().logConnections();</span>
						}
<span class="fc" id="L1251">						return;</span>
					}
				}
			}


			//preposlanie suboru z historie, tiket 13373, parameter pochadza z file_history.jsp
<span class="pc bpc" id="L1258" title="5 of 6 branches missed.">			if (req.getParameter(&quot;fHistoryId&quot;)!=null &amp;&amp; user != null &amp;&amp; user.isAdmin())</span>
			{
<span class="nc" id="L1260">				int fHistoryId = Tools.getIntValue(req.getParameter(&quot;fHistoryId&quot;), -1);</span>
<span class="nc bnc" id="L1261" title="All 2 branches missed.">				if (fHistoryId &gt; 0)</span>
				{
<span class="nc" id="L1263">					boolean sendOK = FileHistoryDB.sendFileFromHistory(path, fHistoryId, res);</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">					if (sendOK == false)</span>
					{
<span class="nc" id="L1266">						res.setStatus(404);</span>
					}
<span class="nc" id="L1268">					return;</span>
				}
			}



<span class="fc bfc" id="L1274" title="All 2 branches covered.">			if (path.startsWith(&quot;/templates/&quot;)) {</span>
<span class="fc" id="L1275">				Ninja.includeNinja(req);</span>
			}

			//forward(request, response);
			//return;
		}
<span class="nc" id="L1281">		catch (RuntimeException rex)</span>
		{
<span class="nc" id="L1283">			sk.iway.iwcm.Logger.error(rex);</span>
		}
<span class="nc" id="L1285">		catch (Exception ex)</span>
		{
<span class="nc bnc" id="L1287" title="All 2 branches missed.">			if (ex.getClass().getCanonicalName().startsWith(&quot;org.spring&quot;)) throw ex;</span>
			else
			{
<span class="nc" id="L1290">				sk.iway.iwcm.Logger.error(ex);</span>
			}
<span class="pc" id="L1292">		}</span>

<span class="pc bpc" id="L1294" title="1 of 2 branches missed.">		if (timer != null)</span>
		{
<span class="nc" id="L1296">			timer.diff(&quot;   Path filter - chain, path: &quot; + path);</span>
<span class="nc" id="L1297">			DBPool.getInstance().logConnections();</span>
		}

		try
		{
			// Pass control on to the next filter
<span class="fc" id="L1303">			chain.doFilter(servletRequest, servletResponse);</span>
		}
<span class="fc" id="L1305">		catch (NestedServletException|org.springframework.security.access.AccessDeniedException e)</span>
		{
			//nastane napr. pri volani /admin/adminlog/logging ak user nema pravo na cmp_adminlog
			//rest sluzby si to handluju same, toto sa tyka webview
			//neda sa zachytit priamo AccessDeniedException preto chytame NestedServletException
<span class="pc bpc" id="L1310" title="1 of 2 branches missed.">			if (e.getCause().toString().contains(&quot;AccessDeniedException&quot;))</span>
			{
<span class="nc" id="L1312">				res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
				//ak to nie je rest posli ho aj na defaultnu 403 stranku
<span class="nc bnc" id="L1314" title="All 4 branches missed.">				if (path==null || path.contains(&quot;/rest&quot;)==false) forwardSafely(&quot;/403.jsp&quot;, req, res);</span>
			}
			else
			{
<span class="fc" id="L1318">				throw e;</span>
			}
<span class="fc" id="L1320">		}</span>
<span class="fc" id="L1321">	}</span>




	/**
	 * Skontroluje, ci je mozne pristupit k verejnej casti webu, nie admin casti
	 * @author kmarton
	 *
	 * @param request
	 * @return
	 */
	public static boolean checkWebAccess(HttpServletRequest request, String path)
	{
<span class="fc" id="L1335">        Identity user = UsersDB.getCurrentUser(request);</span>

        //kontrola referer hlavicky (CSRF), je povinna pre POST alebo ked je prihlaseny user
<span class="fc" id="L1338">        String pathLC = path.toLowerCase();</span>
<span class="pc bpc" id="L1339" title="1 of 8 branches missed.">        if (user != null || &quot;POST&quot;.equalsIgnoreCase(request.getMethod()) || pathLC.endsWith(&quot;.do&quot;) || pathLC.endsWith(&quot;.action&quot;))</span>
        {
<span class="fc" id="L1341">            boolean isUrlAccessible = true;</span>
<span class="fc" id="L1342">            boolean xsrfUrlException = DocTools.isXssStrictUrlException(path, &quot;xsrfUrlException&quot;);</span>
<span class="fc bfc" id="L1343" title="All 4 branches covered.">            if (xsrfUrlException==false &amp;&amp; isXsrfCheckRequired(request))</span>
            {
<span class="fc" id="L1345">                isUrlAccessible = checkXsrf(request);</span>
            }

            //nastal CSRF utok, referer nesedi
<span class="pc bpc" id="L1349" title="1 of 2 branches missed.">            if (isUrlAccessible==false) return false;</span>
        }

		//kontrola pristupu do /components/ adresara
<span class="fc bfc" id="L1353" title="All 4 branches covered.">		if ((path.startsWith(&quot;/components/&quot;) || path.startsWith(&quot;/apps/&quot;))</span>
<span class="pc bpc" id="L1354" title="1 of 6 branches missed.">			 &amp;&amp; (path.endsWith(&quot;.jsp&quot;) || path.endsWith(&quot;.ftl&quot;) || path.endsWith(&quot;.html&quot;)))</span>
		{
<span class="fc bfc" id="L1356" title="All 4 branches covered.">			if (user == null || user.isAdmin()==false)</span>
			{
<span class="fc" id="L1358">				boolean canAccess = DocTools.isXssStrictUrlException(path, &quot;componentsDirectCallExceptions&quot;);</span>
<span class="fc bfc" id="L1359" title="All 2 branches covered.">				if (canAccess==false)</span>
				{
					//ak to zacina na /apps/ over este, ci to nie je platna URL adresa stranky
<span class="fc" id="L1362">					int docId = -1;</span>
<span class="fc bfc" id="L1363" title="All 2 branches covered.">					if (path.startsWith(&quot;/apps/&quot;)) docId = DocDB.getInstance().getDocIdFromURLImpl(path, DocDB.getDomain(request));</span>
<span class="fc bfc" id="L1364" title="All 2 branches covered.">					if (docId &lt; 1)</span>
					{
<span class="fc" id="L1366">						Adminlog.add(Adminlog.TYPE_XSS, &quot;Direct component call, path=&quot;+path, -1, -1);</span>
<span class="fc" id="L1367">						return false;</span>
					}
				}
				//duplicitna kontrola, v ziadnom pripade nema zmysel pristupovat na komponenty s URL obsahujucim admin a tiez do statistiky
<span class="pc bpc" id="L1371" title="1 of 4 branches missed.">				if (canAccess &amp;&amp; path.contains(&quot;admin_answer.jsp&quot;)) return canAccess;</span>
<span class="pc bpc" id="L1372" title="1 of 2 branches missed.">				if (path.contains(&quot;admin&quot;))</span>
				{
<span class="nc bnc" id="L1374" title="All 6 branches missed.">					if (user != null &amp;&amp; (path.contains(&quot;FCKeditor&quot;) || path.contains(&quot;/components/gallery/admin_gallery_popup.jsp&quot;) ||</span>
<span class="nc bnc" id="L1375" title="All 2 branches missed.">							path.contains(&quot;/components/helpdesk/fotogaleria/admin_upload.jsp&quot;)))</span>
					{
						//specialna vynimka pre CK editor pre rozne projekty kde je user prihlaseny ale nie je admin
						//+ #17331 - pridana vynimka pre upload suboru vo fotogalerii v intre
					}
					else
					{
<span class="nc" id="L1382">						return false;</span>
					}
				}
<span class="pc bpc" id="L1385" title="3 of 4 branches missed.">				if (path.contains(&quot;/components/stat/&quot;) &amp;&amp; path.contains(&quot;stat_async_ajax.jsp&quot;) == false) return false;</span>
			}
		}

		//kontrola pristupu podla povolenych IP adries
<span class="fc" id="L1390">		HttpSession session = request.getSession();</span>
<span class="fc" id="L1391">		Boolean val = (Boolean) session.getAttribute(CHECK_WEB_ACCESS_SESSION_KEY);</span>
<span class="fc bfc" id="L1392" title="All 2 branches covered.">		if (val != null)</span>
		{
			//Logger.println(this,&quot;Checking to access web from session: &quot; + val.booleanValue());
<span class="fc" id="L1395">			return (val.booleanValue());</span>
		}

<span class="fc" id="L1398">		boolean ret = Tools.checkIpAccess(request, &quot;webEnableIPs&quot;);</span>
<span class="fc" id="L1399">		session.setAttribute(CHECK_WEB_ACCESS_SESSION_KEY, Boolean.valueOf(ret));</span>
<span class="fc" id="L1400">		return (ret);</span>
	}

	/**
	 * Skontroluje, ci je mozne pristupit k verejnej casti webu na zaklade domeny&lt;br /&gt;
	 *
	 * Castokrat web najskor bezi na domene nieco.t8.iway.sk a nasledne sa spusti na
	 *	domenie nieco.sk, filter umoznuje zadat domeny, pre ktore bude stranka
	 *	vracat obsah a pre ktore bude robit 404 / redirect na inu domenu.
	 *	@author kmarton
	 *
	 * @param request
	 * @return
	 */
	private boolean checkDomain(HttpServletRequest request)
	{
<span class="fc" id="L1416">		HttpSession session = request.getSession();</span>
<span class="fc" id="L1417">		Boolean val = (Boolean) session.getAttribute(CHECK_DOMAIN_SESSION_KEY);</span>
<span class="fc bfc" id="L1418" title="All 2 branches covered.">		if (val != null)</span>
		{
			//Logger.println(this,&quot;Checking DOMAIN to access web from session: &quot; + val.booleanValue());
<span class="fc" id="L1421">			return (val.booleanValue());</span>
		}
<span class="fc" id="L1423">		String webAllowedDomains = Constants.getString(&quot;webAllowedDomains&quot;);</span>
<span class="fc" id="L1424">		boolean ret = true;</span>
<span class="pc bpc" id="L1425" title="2 of 4 branches missed.">		if (webAllowedDomains != null &amp;&amp; webAllowedDomains.length() &gt; 1)</span>
		{
<span class="nc" id="L1427">			ret = false;</span>
<span class="nc" id="L1428">			StringTokenizer st = new StringTokenizer(webAllowedDomains, &quot;,&quot;);</span>
			String domain;
<span class="nc" id="L1430">			String myDomain = Tools.getServerName(request);</span>
<span class="nc" id="L1431">			Logger.println(this,&quot;Checking: &quot; + myDomain + &quot; vs &quot; + webAllowedDomains);</span>
<span class="nc bnc" id="L1432" title="All 2 branches missed.">			while (st.hasMoreTokens())</span>
			{
<span class="nc" id="L1434">				domain = st.nextToken();</span>
<span class="nc bnc" id="L1435" title="All 2 branches missed.">				if (myDomain.endsWith(domain))</span>
				{
<span class="nc" id="L1437">					ret = true;</span>
<span class="nc" id="L1438">					break;</span>
				}
			}
		}
<span class="fc" id="L1442">		session.setAttribute(CHECK_DOMAIN_SESSION_KEY, Boolean.valueOf(ret));</span>
<span class="fc" id="L1443">		return (ret);</span>
	}

	private boolean checkAccessToAdmin(String path, HttpServletRequest request, HttpServletResponse response)
	{
<span class="fc" id="L1448">		boolean isAdminUrlAccessible = true;</span>
<span class="fc" id="L1449">        Identity user = UsersDB.getCurrentUser(request.getSession());</span>

<span class="fc" id="L1451">        boolean xsrfUrlException = DocTools.isXssStrictUrlException(path, &quot;xsrfUrlException&quot;);</span>

<span class="fc bfc" id="L1453" title="All 2 branches covered.">		if(path.startsWith(&quot;/admin&quot;) ||</span>
<span class="fc bfc" id="L1454" title="All 4 branches covered.">			(path.startsWith(&quot;/components/&quot;) &amp;&amp; path.contains(&quot;/admin&quot;)) ||</span>
<span class="fc bfc" id="L1455" title="All 4 branches covered.">			(path.startsWith(&quot;/apps/&quot;) &amp;&amp; path.contains(&quot;/admin&quot;)))	//pristupuje do admin casti a admin komponent/app</span>
		{
<span class="pc bpc" id="L1457" title="1 of 4 branches missed.">			if(user == null || UsersDB.checkUserPerms(user, &quot;admin|editableGroupsNotEmpty&quot;)==false)	//A nie je prihlaseny, alebo nie je prihlaseny ako admin</span>
			{
<span class="fc" id="L1459">				isAdminUrlAccessible = false;</span>
<span class="fc" id="L1460">				String allowAdminUrls = Constants.getString(&quot;allowAdminUrls&quot;);</span>
				//ak v starom WJ mali customizovanu premennu a nemaju tam springove prihlasenie, pridajme
<span class="pc bpc" id="L1462" title="2 of 4 branches missed.">				if (allowAdminUrls.contains(&quot;/admin/logon.do&quot;) &amp;&amp; allowAdminUrls.contains(&quot;/admin/logon/&quot;)==false) allowAdminUrls += &quot;,^/admin/logon$,^/admin/logon/$,^/admin/logon/changePassword$&quot;;</span>

<span class="fc" id="L1464">				String[] adminUrls = Tools.getTokens(allowAdminUrls, &quot;,&quot;, true);</span>

<span class="fc bfc" id="L1466" title="All 2 branches covered.">				for(String url: adminUrls)</span>
				{
<span class="pc bpc" id="L1468" title="1 of 6 branches missed.">					if(path.startsWith(url) || (&quot;^&quot;+path+&quot;$&quot;).equals(url) || (path+&quot;$&quot;).endsWith(url))</span>
					{
<span class="fc" id="L1470">						isAdminUrlAccessible = true;</span>
<span class="fc" id="L1471">						break;</span>
					}
				}
			}
<span class="fc bfc" id="L1475" title="All 4 branches covered.">			if(isAdminUrlAccessible &amp;&amp; xsrfUrlException==false)</span>
			{
<span class="fc" id="L1477">				isAdminUrlAccessible = checkXsrf(request);</span>
			}

<span class="pc bpc" id="L1480" title="1 of 14 branches missed.">			if (path.endsWith(&quot;.html&quot;) || path.endsWith(&quot;.jsp&quot;) || path.endsWith(&quot;.action&quot;) || path.endsWith(&quot;.do&quot;) || path.endsWith(&quot;.js&quot;) || path.endsWith(&quot;/&quot;) || path.indexOf(&quot;ajax&quot;)!=-1)</span>
			{
<span class="fc" id="L1482">				setUaCompatibleAdmin(path, response);</span>
			}
		}

<span class="fc bfc" id="L1486" title="All 4 branches covered.">		if (user != null &amp;&amp; user.isAdmin())</span>
		{
<span class="fc bfc" id="L1488" title="All 2 branches covered.">            if (xsrfUrlException==false)</span>
            {
<span class="fc bfc" id="L1490" title="All 2 branches covered.">                if (isXsrfCheckRequired(request))</span>
                {
<span class="fc" id="L1492">                    isAdminUrlAccessible = checkXsrf(request);</span>
                }
            }
        }
<span class="fc" id="L1496">		return isAdminUrlAccessible;</span>
	}

    /**
     * Overi, ci je potrebna XSRF kontrola (kontrola referera)
     * ta sa robi pri POST alebo ked v URL su nejake parametre (okrem vynimiek definovanych v xsrfParamNameException ako docid, _logLevel, combineEnabled atd)
     * @param request
     * @return
     */
	private static boolean isXsrfCheckRequired(HttpServletRequest request)
    {
        //ak uz je user prihlaseny ako admin, kontrolujme CSRF vzdy (aby sa nedal spravit utok z inej stranky mazuci napr. data)
        //niektore URL musime whitelistovat, kedze mozu viest z mailu
<span class="fc" id="L1509">        boolean isXsrfCheckRequired = false;</span>
<span class="fc bfc" id="L1510" title="All 2 branches covered.">        if (&quot;GET&quot;.equalsIgnoreCase(request.getMethod()))</span>
        {
<span class="fc" id="L1512">            Enumeration&lt;String&gt; paramNames = request.getParameterNames();</span>
<span class="fc" id="L1513">            int failsafe = 0;</span>
<span class="fc" id="L1514">            int maxFailsafe = 10;</span>

<span class="fc" id="L1516">            String xsrfParamNames = Constants.getString(&quot;xsrfParamNameExceptionSystem&quot;);</span>
<span class="pc bpc" id="L1517" title="1 of 2 branches missed.">            if (Tools.isNotEmpty(Constants.getString(&quot;xsrfParamNameException&quot;))) xsrfParamNames += &quot;,&quot; + Constants.getString(&quot;xsrfParamNameException&quot;);</span>

<span class="fc" id="L1519">            String[] xsrfParamNameException = Tools.getTokens(xsrfParamNames.toLowerCase(), &quot;,&quot;, true);</span>
<span class="pc bpc" id="L1520" title="1 of 4 branches missed.">            while (paramNames.hasMoreElements() &amp;&amp; failsafe++ &lt;= maxFailsafe)</span>
            {
<span class="fc" id="L1522">                String name = paramNames.nextElement().toLowerCase();</span>
                //natvrdo kvoli performance
<span class="fc bfc" id="L1524" title="All 2 branches covered.">                if (&quot;docid&quot;.equals(name)) continue;</span>
                //displaytag povolime
<span class="pc bpc" id="L1526" title="1 of 2 branches missed.">                if (name.startsWith(&quot;d-&quot;)) continue;</span>
                //over voci zoznamu povolenych parametrov
<span class="fc bfc" id="L1528" title="All 2 branches covered.">                if (Tools.containsOneItem(xsrfParamNameException, name)) continue;</span>

<span class="fc" id="L1530">                isXsrfCheckRequired = true;</span>
<span class="fc" id="L1531">            }</span>
            //ak to ma vela parametrov tak to je rovno podozrive
<span class="fc bfc" id="L1533" title="All 2 branches covered.">            if (failsafe&gt;=maxFailsafe) isXsrfCheckRequired = true;</span>
<span class="fc" id="L1534">        }</span>
        else {
            //pre POST je check required
<span class="fc" id="L1537">            isXsrfCheckRequired = true;</span>
        }
<span class="fc" id="L1539">        return isXsrfCheckRequired;</span>
    }


	/**
	 * Method checks for XSRF attack, if referrer from request header is not current server
	 * or from list of trusted referrers (constant xsrfReferers, see {@link Constants} ) method denies
	 * access to url and logs attack. for more information see Ticket 11207
	 * @param request request
	 * @return true if xsrf is not detected, else false
	 */
	private static boolean checkXsrf(HttpServletRequest request)
	{
<span class="fc" id="L1552">		String trustedXsrfReferers = Constants.getString(&quot;xsrfReferers&quot;);</span>
		//ten length je tam aby v Oracle DB bolo mozne v konfiguracii nastavit znak -
<span class="pc bpc" id="L1554" title="2 of 4 branches missed.">		if(Tools.isEmpty(trustedXsrfReferers) || trustedXsrfReferers.length()&lt;2) return true;</span>

<span class="fc" id="L1556">		String remoteReferrer = request.getHeader(&quot;referer&quot;);</span>
<span class="fc bfc" id="L1557" title="All 2 branches covered.">		if(Tools.isEmpty(remoteReferrer))</span>
        {
            //vynimka pre elfinder download - /admin/elfinder-connector/?cmd=file&amp;target=iwcm_2_L2ZpbGVzL3pfb19wcmlzcF9uYV9wb2hyZWJfcGRmLnBkZg_E_E&amp;download=1&amp;volumes=files
            //nechcel som dat vynimku pre cely elfinder-connector, preto sa testuje parameter download
<span class="fc" id="L1561">            String path = PathFilter.getOrigPath(request);</span>
<span class="pc bpc" id="L1562" title="3 of 4 branches missed.">            if (&quot;/admin/elfinder-connector/&quot;.equals(path) &amp;&amp; &quot;1&quot;.equals(request.getParameter(&quot;download&quot;)))</span>
            {
<span class="nc" id="L1564">                return true;</span>
            }

            //do slaka, MSIE posiela empty referer ked otvara popup okno, takze zial MSIE nebude pre GET poziadavky chranene
<span class="fc" id="L1568">            String userAgent = request.getHeader(&quot;User-Agent&quot;);</span>
<span class="fc" id="L1569">            boolean isMsie = false;</span>
<span class="pc bpc" id="L1570" title="2 of 4 branches missed.">            if (userAgent!=null &amp;&amp; &quot;GET&quot;.equalsIgnoreCase(request.getMethod()))</span>
            {
                //vynimka len pre Trident/7.0 co je MSIE 11, starsi MSIE nebude podporovany (jedine ochranu uplne vypnut)
<span class="pc bpc" id="L1573" title="1 of 2 branches missed.">                if (userAgent.contains(&quot;Trident/7.0&quot;)) isMsie = true;</span>
            }

<span class="pc bpc" id="L1576" title="2 of 4 branches missed.">            if  (isMsie==false &amp;&amp; isXsrfCheckRequired(request))</span>
            {
<span class="nc" id="L1578">                Adminlog.add(Adminlog.TYPE_XSRF, &quot;Possible XSRF attack, referer is empty&quot;, -1, -1);</span>
<span class="nc" id="L1579">                return false;</span>
            }
<span class="fc" id="L1581">            return true;</span>
        }

<span class="fc" id="L1584">		String remoteReferrerServer = &quot;&quot;;</span>
		try
		{
<span class="fc" id="L1587">			URL remoteReferrerUrl = new URL(remoteReferrer);</span>
<span class="fc" id="L1588">			remoteReferrerServer = remoteReferrerUrl.getHost();</span>
		}
<span class="nc" id="L1590">		catch (Exception e)</span>
		{
<span class="nc" id="L1592">			Logger.debug(PathFilter.class,&quot;Failed to create URL from referrer: &quot; + remoteReferrer);</span>
<span class="fc" id="L1593">		}</span>
<span class="pc bpc" id="L1594" title="1 of 2 branches missed.">		for(String trustedReferrer : trustedXsrfReferers.split(&quot;,&quot;))</span>
		{
<span class="fc" id="L1596">			trustedReferrer = trustedReferrer.trim();</span>
<span class="pc bpc" id="L1597" title="1 of 2 branches missed.">			if(trustedReferrer.equalsIgnoreCase(Constants.SERVER_NAME_MACRO))</span>
			{
<span class="fc" id="L1599">				trustedReferrer = Tools.getServerName(request, false);</span>
			}
<span class="pc bpc" id="L1601" title="7 of 8 branches missed.">			if (trustedReferrer.startsWith(&quot;%&quot;) &amp;&amp; trustedReferrer.endsWith(&quot;%&quot;) &amp;&amp; trustedReferrer.length()&gt;4 &amp;&amp; remoteReferrerServer.contains(trustedReferrer.substring(1, trustedReferrer.length()-1)))</span>
			{
<span class="nc" id="L1603">					return true;</span>
			}
<span class="pc bpc" id="L1605" title="5 of 6 branches missed.">			if (trustedReferrer.startsWith(&quot;%&quot;) &amp;&amp; trustedReferrer.length()&gt;2 &amp;&amp; remoteReferrerServer.endsWith(trustedReferrer.substring(1)))</span>
			{
<span class="nc" id="L1607">				return true;</span>
			}
<span class="pc bpc" id="L1609" title="1 of 2 branches missed.">			if(remoteReferrerServer.equalsIgnoreCase(trustedReferrer))</span>
			{
<span class="fc" id="L1611">				return true;</span>
			}
		}
<span class="nc" id="L1614">		Adminlog.add(Adminlog.TYPE_XSRF, &quot;Possible XSRF attack from: &quot; + remoteReferrer, -1, -1);</span>

<span class="nc" id="L1616">		return false;</span>
	}

	/**
	 * Skontroluje, ci je mozne pristupit k admin casti
	 *
	 * @param request
	 * @return
	 */
	public static boolean checkAdmin(HttpServletRequest request)
	{
<span class="fc" id="L1627">		HttpSession session = request.getSession();</span>
<span class="fc" id="L1628">		Boolean val = (Boolean) session.getAttribute(CHECK_ADMIN_SESSION_KEY);</span>
<span class="fc bfc" id="L1629" title="All 2 branches covered.">		if (val != null)</span>
		{
<span class="fc" id="L1631">			return (val.booleanValue());</span>
		}

<span class="pc bpc" id="L1634" title="1 of 2 branches missed.">		if (&quot;public&quot;.equals(Constants.getString(&quot;clusterMyNodeType&quot;))) return false;</span>

<span class="fc" id="L1636">		String adminEnableIPs = Constants.getString(&quot;adminEnableIPs&quot;);</span>
<span class="fc" id="L1637">		boolean ret = true;</span>
<span class="pc bpc" id="L1638" title="2 of 4 branches missed.">		if (adminEnableIPs != null &amp;&amp; adminEnableIPs.length() &gt; 1)</span>
		{
<span class="fc" id="L1640">			ret = false;</span>
<span class="fc" id="L1641">			StringTokenizer st = new StringTokenizer(adminEnableIPs, &quot;,&quot;);</span>
			String ip;
<span class="fc" id="L1643">			String myIP = Tools.getRemoteIP(request);</span>
<span class="fc" id="L1644">			Logger.println(PathFilter.class,&quot;Checking: &quot; + myIP + &quot; vs &quot; + adminEnableIPs);</span>
<span class="pc bpc" id="L1645" title="1 of 2 branches missed.">			while (st.hasMoreTokens())</span>
			{
<span class="fc" id="L1647">				ip = st.nextToken().trim();</span>
<span class="pc bpc" id="L1648" title="1 of 2 branches missed.">				if (myIP.startsWith(ip))</span>
				{
<span class="fc" id="L1650">					ret = true;</span>
<span class="fc" id="L1651">					break;</span>
				}
			}
		}
<span class="fc" id="L1655">		session.setAttribute(CHECK_ADMIN_SESSION_KEY, Boolean.valueOf(ret));</span>
<span class="fc" id="L1656">		return (ret);</span>
	}

	/**
	 * Nacita z databazy zoznam adresarov, v ktorych su chranene subory
	 *
	 */
	public static synchronized void reloadProtectedDirs()
	{
<span class="fc" id="L1665">		Map&lt;String, EditForm&gt; protectedDirs = new HashMap&lt;&gt;();</span>

<span class="fc" id="L1667">		Connection db_conn = null;</span>
<span class="fc" id="L1668">		PreparedStatement ps = null;</span>
<span class="fc" id="L1669">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L1672">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L1673">			ps = db_conn.prepareStatement(&quot;SELECT * FROM dirprop&quot;); //NOSONAR</span>
<span class="fc" id="L1674">			rs = ps.executeQuery();</span>
			EditForm ef;
			String passProtected;
<span class="fc bfc" id="L1677" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="fc" id="L1679">				passProtected = DB.getDbString(rs, &quot;password_protected&quot;);</span>
<span class="fc bfc" id="L1680" title="All 2 branches covered.">				if (Tools.isEmpty(passProtected))</span>
				{
<span class="fc" id="L1682">					continue;</span>
				}

<span class="fc" id="L1685">				ef = new EditForm();</span>
<span class="fc" id="L1686">				ef.setPasswordProtectedString(passProtected);</span>
<span class="fc" id="L1687">				ef.setOrigDir(DB.getDbString(rs, &quot;dir_url&quot;));</span>
<span class="fc" id="L1688">				ef.setIndexFulltext(rs.getBoolean(&quot;index_fulltext&quot;));</span>
<span class="fc" id="L1689">				ef.setLogonDocId(rs.getInt(&quot;logon_doc_id&quot;));</span>

<span class="fc" id="L1691">				protectedDirs.put(ef.getOrigDir(), ef);</span>
			}
<span class="fc" id="L1693">			rs.close();</span>
<span class="fc" id="L1694">			ps.close();</span>
<span class="fc" id="L1695">			rs = null;</span>
<span class="fc" id="L1696">			ps = null;</span>
		}
<span class="nc" id="L1698">		catch (Exception sqlEx)</span>
		{
			//ak este nie je spraveny update toto hadze exception
<span class="nc bnc" id="L1701" title="All 2 branches missed.">			if (sqlEx.getMessage().indexOf(&quot;doesn't exist&quot;)!=-1)</span>
			{
<span class="nc" id="L1703">				sk.iway.iwcm.Logger.error(sqlEx);</span>
			}
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L1710" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="fc" id="L1711">					db_conn.close();</span>
<span class="pc bpc" id="L1712" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L1713">					rs.close();</span>
<span class="pc bpc" id="L1714" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1715">					ps.close();</span>
			}
<span class="nc" id="L1717">			catch (Exception ex2)</span>
			{
<span class="fc" id="L1719">			}</span>
		}
<span class="fc" id="L1721">		passwordProtected = protectedDirs;</span>
<span class="fc" id="L1722">	}</span>

	/**
	 * Skontroluje, ci zadane URL je v protected zone
	 * @param url
	 * @return EditForm ak je chranene, alebo null
	 */
	public static EditForm isPasswordProtected(String url, HttpServletRequest request)
	{
<span class="pc bpc" id="L1731" title="1 of 2 branches missed.">		if (request == null) return isPasswordProtected(url, null, null);</span>
<span class="fc" id="L1732">		return isPasswordProtected(url, request, request.getSession());</span>
	}

	/**
	 * Skontroluje prava k danemu URL (suboru)
	 * @param url - url adresa suboru z adresara /files
	 * @param request - ak nie je null prida sa aj statistika videni (ak statistiku nechceme zaratat nastavime len session)
	 * @param session - session z ktorej sa ziska identita pouzivatela
	 * @return
	 */
	public static EditForm isPasswordProtected(String url, HttpServletRequest request, HttpSession session)
	{
<span class="fc" id="L1744">		boolean galleryCheckUserPerms = Constants.getBoolean(&quot;galleryCheckUserPerms&quot;);</span>
<span class="pc bpc" id="L1745" title="1 of 6 branches missed.">		if (url.startsWith(&quot;/files&quot;)==false &amp;&amp; (url.startsWith(&quot;/images/gallery/&quot;)==false || galleryCheckUserPerms == false))</span>
		{
<span class="fc" id="L1747">			return(null);</span>
		}

<span class="pc bpc" id="L1750" title="3 of 4 branches missed.">		if (session == null &amp;&amp; request != null) session = request.getSession();</span>

<span class="fc" id="L1752">		EditForm efBestMatch = null;</span>

<span class="pc bpc" id="L1754" title="2 of 4 branches missed.">		if(passwordProtected != null &amp;&amp; passwordProtected.size() &gt; 0)</span>
		{
<span class="fc" id="L1756">			String testPath = url;</span>
<span class="fc" id="L1757">			int start = 1; //nastavit musim na 1, aby v pripade prvej podmienky islo do while cyklu</span>
<span class="pc bpc" id="L1758" title="1 of 2 branches missed.">			if (testPath.endsWith(&quot;/&quot;)) testPath = testPath.substring(0, testPath.length()-1);</span>
<span class="fc bfc" id="L1759" title="All 2 branches covered.">			else if(testPath.contains(&quot;.&quot;)) //ak sa jedna o subor - vytiahnem adresar</span>
			{
<span class="fc" id="L1761">				start = testPath.lastIndexOf(&quot;/&quot;);</span>
<span class="pc bpc" id="L1762" title="1 of 2 branches missed.">				if(start != -1) testPath = testPath.substring(0, testPath.lastIndexOf(&quot;/&quot;));</span>
			}
<span class="fc" id="L1764">			EditForm ef = null;</span>
<span class="fc" id="L1765">			int failsafe = 0;</span>
<span class="fc" id="L1766">			String firstTestPath = &quot;&quot;;</span>
			//hladam najblizsi nadradeny adresar kotry je password protected
<span class="pc bpc" id="L1768" title="1 of 4 branches missed.">			while (start &gt; 0 &amp;&amp; failsafe++ &lt; 30)</span>
			{
<span class="fc bfc" id="L1770" title="All 2 branches covered.">				if(failsafe == 1) firstTestPath = testPath;</span>

<span class="fc" id="L1772">				ef = passwordProtected.get(testPath);</span>
<span class="fc bfc" id="L1773" title="All 2 branches covered.">				if(ef != null)</span>
				{
<span class="fc" id="L1775">					efBestMatch = ef;</span>
					//pokial som nenasiel v prvom pokuse, pridam do zoznamu, nech pri dalsom volani neiterujem zbytocne + ochrana proti DOC utokom
<span class="pc bpc" id="L1777" title="3 of 4 branches missed.">					if(failsafe &gt; 1 &amp;&amp; passwordProtected.size() &lt; 2000) passwordProtected.put(firstTestPath, ef);</span>
					break;
				}

<span class="fc" id="L1781">				start = testPath.lastIndexOf(&quot;/&quot;);</span>
<span class="fc bfc" id="L1782" title="All 2 branches covered.">				if (start &gt; 0) testPath = testPath.substring(0, start); //substring len v pripade ak lomitko nieje na zaciatku</span>
			}
		}

<span class="fc bfc" id="L1786" title="All 2 branches covered.">		if (url.startsWith(&quot;/files&quot;))</span>
		{
			//pre files skus skontrolovat ci nie je zaheslovany v sekcii /files/
<span class="fc" id="L1789">			DocDB docDB = DocDB.getInstance();</span>
<span class="fc" id="L1790">			int docId = docDB.getDocIdFromURLImpl(url+&quot;.html&quot;, null);</span>
<span class="pc bpc" id="L1791" title="1 of 2 branches missed.">			if (docId &lt; 1) docId = docDB.getDocIdFromURLImpl(url+&quot;.html&quot;, DocDB.getDomain(request));</span>
<span class="fc bfc" id="L1792" title="All 2 branches covered.">			if (docId &lt; 1) docId = docDB.getDocIdFromURLImpl(Tools.replace(url, &quot;.&quot;, &quot;-&quot;)+&quot;.html&quot;, null);</span>
<span class="fc bfc" id="L1793" title="All 2 branches covered.">			if (docId &lt; 1) docId = docDB.getDocIdFromURLImpl(Tools.replace(url, &quot;.&quot;, &quot;-&quot;)+&quot;.html&quot;, DocDB.getDomain(request));</span>
<span class="fc bfc" id="L1794" title="All 2 branches covered.">			if (docId &gt; 0)</span>
			{
<span class="fc" id="L1796">				DocDetails fileDoc = docDB.getBasicDocDetails(docId, false);</span>
<span class="pc bpc" id="L1797" title="1 of 2 branches missed.">				if (fileDoc != null)</span>
				{
<span class="fc" id="L1799">					Identity user = null;</span>
<span class="pc bpc" id="L1800" title="1 of 2 branches missed.">					if (session != null) user = UsersDB.getCurrentUser(session);</span>
					else
					{
<span class="nc" id="L1803">						RequestBean rb = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="nc bnc" id="L1804" title="All 4 branches missed.">						if (rb!=null &amp;&amp; rb.getUserId()&gt;0) user = new Identity(UsersDB.getUser(rb.getUserId()));</span>
					}
<span class="fc" id="L1806">					boolean canAccess = DocDB.canAccess(fileDoc, user, true);</span>
<span class="fc" id="L1807">					boolean isAvailable = fileDoc.isAvailable();</span>
<span class="pc bpc" id="L1808" title="7 of 8 branches missed.">					if (isAvailable == false &amp;&amp; user != null &amp;&amp; user.isAdmin() &amp;&amp; Constants.getBoolean(&quot;adminCheckUserGroups&quot;)==false)</span>
					{
						//ak je admin ignorujeme nastavenie available atributu stranky
<span class="nc" id="L1811">						isAvailable = true;</span>
					}

<span class="pc bpc" id="L1814" title="2 of 4 branches missed.">					if (!canAccess || !isAvailable)</span>
					{
<span class="nc" id="L1816">						efBestMatch = new EditForm();</span>
						//to cislo je bulharska konstanta len aby nam potom nezbehlo ef.isAccessibleFor, pretoze to neriesi podadresare dokumentu
<span class="nc" id="L1818">						efBestMatch.setPasswordProtectedString(&quot;999888777&quot;);</span>
					}
					else
					{
						try
						{
<span class="pc bpc" id="L1824" title="1 of 2 branches missed.">							if (request != null)</span>
							{
<span class="fc" id="L1826">								StatDB.add(request.getSession(), request, null, docId);</span>
							}
						}
<span class="nc" id="L1829">						catch (Exception e)</span>
						{
<span class="nc" id="L1831">							sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L1832">						}</span>
					}
				}
			}
		}

<span class="fc" id="L1838">		return(efBestMatch);</span>
	}

	/**
	 * Vykona redirect (ak treba) na zobrazenie logon stranky / zamietnutia pristupu k suboru (/files/*), vrati true, ak bol redirect vykonany
	 * @param ef
	 * @param user
	 * @param originalPath
	 * @param req
	 * @param res
	 * @return true ak je redirect vykonany, inak false
	 * @throws IOException
	 * @throws ServletException
	 */
	public static boolean doFileForbiddenRedirect(EditForm ef, Identity user, String originalPath, HttpServletRequest req, HttpServletResponse res) throws IOException, ServletException
	{
<span class="fc" id="L1854">		boolean isAccesible = false;</span>
<span class="pc bpc" id="L1855" title="3 of 4 branches missed.">		if (user != null &amp;&amp; ef!=null)</span>
		{
			//otestuj, ci je user v skupine pre tento adresar

			int i;
<span class="nc" id="L1860">			int size = ef.getPasswordProtected().length;</span>
<span class="nc bnc" id="L1861" title="All 2 branches missed.">			for (i=0; i&lt;size; i++)</span>
			{
<span class="nc bnc" id="L1863" title="All 2 branches missed.">				if (user.isInUserGroup(ef.getPasswordProtected()[i]))</span>
				{
<span class="nc" id="L1865">					isAccesible = true;</span>
<span class="nc" id="L1866">					break;</span>
				}
			}

		}

<span class="pc bpc" id="L1872" title="1 of 2 branches missed.">		if (isAccesible) return false;</span>

<span class="fc" id="L1874">		String pathQS = originalPath;</span>
<span class="fc bfc" id="L1875" title="All 2 branches covered.">		if (Tools.isNotEmpty(req.getQueryString())) pathQS = originalPath + &quot;?&quot; + req.getQueryString();</span>

<span class="fc" id="L1877">		Logger.debug(PathFilter.class, &quot;NOT ACCESSIBLE: path=&quot;+pathQS+&quot; user=&quot;+user);</span>
<span class="pc bpc" id="L1878" title="1 of 2 branches missed.">		if (user != null)</span>
		{
			//user nema pristup, daj mu forbidden
<span class="nc" id="L1881">			int fileAccessDeniedDocId = Constants.getInt(&quot;fileAccessDeniedDocId&quot;);</span>
<span class="nc" id="L1882">			Logger.debug(PathFilter.class, &quot;fileAccessDeniedDocId=&quot;+fileAccessDeniedDocId+&quot; ntlm=&quot;+AuthenticationFilter.getForbiddenURL());</span>
<span class="nc bnc" id="L1883" title="All 2 branches missed.">			if (fileAccessDeniedDocId &gt; 0)</span>
			{
<span class="nc" id="L1885">				res.setHeader(&quot;Pragma&quot;,&quot;No-Cache&quot;);</span>
<span class="nc" id="L1886">				res.setDateHeader(&quot;Expires&quot;,0);</span>
<span class="nc" id="L1887">				res.setHeader(&quot;Cache-Control&quot;,&quot;no-Cache&quot;);</span>

<span class="nc" id="L1889">				req.setAttribute(&quot;logonFormSubmitURL&quot;, originalPath);</span>
<span class="nc" id="L1890">				req.getRequestDispatcher(&quot;/showdoc.do?docid=&quot;+fileAccessDeniedDocId+&quot;&amp;origUrl=&quot;+Tools.URLEncode(pathQS)).forward(req, res);</span>
			}
<span class="nc bnc" id="L1892" title="All 2 branches missed.">			else if (Tools.isNotEmpty(AuthenticationFilter.getForbiddenURL()))</span>
			{
<span class="nc" id="L1894">				res.sendRedirect(Tools.addParameterToUrlNoAmp(AuthenticationFilter.getForbiddenURL(), &quot;origUrl&quot;, pathQS));</span>
			}
			else
			{
<span class="nc" id="L1898">				res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
			}
<span class="nc" id="L1900">		}</span>
		else
		{
			//forwardni sa na logon stranku
<span class="fc" id="L1904">			req.getSession().setAttribute(&quot;afterLogonRedirect&quot;, pathQS);</span>

<span class="fc" id="L1906">			res.setHeader(&quot;Pragma&quot;,&quot;No-Cache&quot;);</span>
<span class="fc" id="L1907">			res.setDateHeader(&quot;Expires&quot;,0);</span>
<span class="fc" id="L1908">			res.setHeader(&quot;Cache-Control&quot;,&quot;no-Cache&quot;);</span>

<span class="fc bfc" id="L1910" title="All 4 branches covered.">			if (ef != null &amp;&amp; ef.getLogonDocId()&gt;0)</span>
			{
				//res.sendRedirect(&quot;/showdoc.do?docid=&quot;+ef.getLogonDocId());

				//request.setAttribute(&quot;docDetailsOriginal&quot;, doc);

				//pre subor sa musime submitnut priamo na usrlogon.do aby sa najskor spravilo prihlasenie az potom kontrola prav na subor
<span class="fc" id="L1917">				req.setAttribute(&quot;logonFormSubmitURL&quot;, &quot;/usrlogon.do&quot;);</span>
<span class="fc" id="L1918">				req.getRequestDispatcher(&quot;/showdoc.do?docid=&quot;+ef.getLogonDocId()+&quot;&amp;dontUpdateLastDocId=true&quot;).forward(req, res);</span>
			}
			else
			{
<span class="fc" id="L1922">				req.getRequestDispatcher(&quot;/components/user/logon.jsp?permsDenied=true&quot;).forward(req, res);</span>
			}
		}
<span class="fc" id="L1925">		return true;</span>
	}

	/**
	 * Vrati cestu k suboru na disku z daneho URL, berie do uvahy aj custom path
	 * @param url - url adresa suboru, napr. /css/page.css
	 * @return - vrati cestu na disku, napr. /var/webapps/webjet/css/page.css
	 */
	public static String getRealPath(String url)
	{
<span class="pc bpc" id="L1935" title="1 of 2 branches missed.">		if (customPath != null)</span>
		{
			//skontroluj, ci pozadovany subor nie je custom
<span class="nc bnc" id="L1938" title="All 2 branches missed.">			File f = new File(customPath + File.separatorChar + Constants.getInstallName() + (url.startsWith(&quot;/&quot;)?&quot;&quot;:File.separatorChar) + url.replace('/', File.separatorChar));</span>
			//Logger.println(this,&quot;Checking CUSTOM: &quot;+f.getAbsolutePath());
<span class="nc bnc" id="L1940" title="All 2 branches missed.">			if (f.exists())</span>
			{
<span class="nc" id="L1942">				return(f.getAbsolutePath());</span>
			}
		}
<span class="fc" id="L1945">		return(Tools.getRealPath(url));</span>
	}

	public static String getOrigPath(HttpServletRequest request)
	{
<span class="fc" id="L1950">		return((String)request.getAttribute(&quot;path_filter_orig_path&quot;));</span>
	}

	/**
	 * Vrati adresu povodnej stranky, v pripade DOCID liniek vratane parametra docid
	 * @param request
	 * @return
	 */
	public static String getOrigPathDocId(HttpServletRequest request)
	{
<span class="pc bpc" id="L1960" title="3 of 4 branches missed.">		if (Constants.getInt(&quot;linkType&quot;)==Constants.LINK_TYPE_DOCID &amp;&amp; request.getParameter(&quot;docid&quot;)!=null)</span>
		{
<span class="nc" id="L1962">			return &quot;/showdoc.do?docid=&quot;+Tools.getDocId(request);</span>
		}
<span class="fc" id="L1964">		String origPath = getOrigPath(request);</span>

<span class="pc bpc" id="L1966" title="1 of 2 branches missed.">		if (&quot;/showdoc.do&quot;.equals(origPath)) origPath = origPath + &quot;?docid=&quot; + Tools.getDocId(request);</span>

<span class="fc" id="L1968">		return origPath;</span>
	}

	/**
	 * Vrati adresu povodnej stranky, v pripade DOCID liniek vratane docid s pridanym
	 * parametrom pre uload suboru pre stripes (aby to Stripes spracoval)
	 * @param request
	 * @return
	 */
	public static String getOrigPathUpload(HttpServletRequest request)
	{
<span class="pc bpc" id="L1979" title="3 of 4 branches missed.">		if (Constants.getInt(&quot;linkType&quot;)==Constants.LINK_TYPE_DOCID &amp;&amp; request.getParameter(&quot;docid&quot;)!=null)</span>
		{
<span class="nc" id="L1981">			return &quot;/showdoc.do?docid=&quot;+Tools.getDocId(request) +&quot;&amp;__sfu=1&quot;;</span>
		}
<span class="fc" id="L1983">		return getOrigPath(request)+&quot;?__sfu=1&quot;;</span>
	}

	public static boolean bypassPath(String path, ServletRequest servletRequest)
	{
		//aby nam lokalne fungoval customPath
<span class="pc bpc" id="L1989" title="3 of 4 branches missed.">		if (Tools.isNotEmpty(PathFilter.getCustomPath()) &amp;&amp; &quot;iwcm.interway.sk&quot;.equals(servletRequest.getServerName())) return false;</span>

<span class="fc bfc" id="L1991" title="All 2 branches covered.">		if (bypassPath == null)</span>
		{
<span class="fc" id="L1993">			synchronized(PathFilter.class) //NOSONAR</span>
			{
<span class="pc bpc" id="L1995" title="1 of 2 branches missed.">				if (bypassPath == null)</span>
				{
<span class="fc" id="L1997">					String[] tokens = Tools.getTokens(Constants.getString(&quot;pathFilterBypassPath&quot;), &quot;,&quot;, true);</span>
<span class="pc bpc" id="L1998" title="1 of 2 branches missed.">					bypassPath = tokens == null ? new String[0] : tokens;</span>
				}
<span class="fc" id="L2000">			}</span>
		}

<span class="pc bpc" id="L2003" title="1 of 2 branches missed.">		if (bypassPath.length &gt; 0)</span>
		{
<span class="nc bnc" id="L2005" title="All 2 branches missed.">			for (int i=0; i&lt;bypassPath.length; i++)</span>
			{
<span class="nc bnc" id="L2007" title="All 2 branches missed.">				if (path.startsWith(bypassPath[i])) return(true);</span>
			}
		}

<span class="fc" id="L2011">		return(false);</span>
	}

    /**
     * Nastavi cache hlavicky podla konf. premennej cacheStaticContentSeconds a cacheStaticContentSuffixes
     * @param path
     * @param user
     * @param request
     * @param response
     * @return
     */
	public static boolean setStaticContentHeaders(String path, Identity user, HttpServletRequest request, HttpServletResponse response)
	{
<span class="fc bfc" id="L2024" title="All 4 branches covered.">		if (path.startsWith(&quot;/cache/&quot;)==false &amp;&amp; request.getParameter(&quot;v&quot;)!=null)</span>
		{
			//vygeneruj odkaz bez v parametra, negeneruje pre fiktivne /cache/nieco.css linky
<span class="fc" id="L2027">			String canonicalLink = Tools.getBaseHref(request) + path;</span>
<span class="fc" id="L2028">			response.setHeader(&quot;Link&quot;, &quot;&lt;&quot;+canonicalLink+&quot;&gt;; rel=\&quot;canonical\&quot;&quot;);</span>
		}

		//vypnutie cachovania pre obrazky z imageeditora
<span class="pc bpc" id="L2032" title="1 of 2 branches missed.">		if (path.contains(&quot;/_tmp_&quot;))</span>
		{
<span class="nc" id="L2034">			response.setDateHeader(&quot;Expires&quot;,0);</span>
<span class="nc" id="L2035">			response.setDateHeader(&quot;Last-Modified&quot;, Tools.getNow());</span>
<span class="nc" id="L2036">			response.setHeader(&quot;Cache-Control&quot;,&quot;no-store, no-cache, must-revalidate, max-age=0&quot;);</span>
			//response.setHeader(&quot;Cache-Control&quot;,&quot;post-check=0, pre-check=0&quot;);
<span class="nc" id="L2038">			response.setHeader(&quot;Pragma&quot;,&quot;No-Cache&quot;);</span>
<span class="nc" id="L2039">			response.setHeader(&quot;Etag&quot;, &quot;&quot;);</span>

<span class="nc" id="L2041">			return false;</span>
		}

<span class="fc bfc" id="L2044" title="All 2 branches covered.">		if (cacheStaticContentSeconds &lt; 0)</span>
		{
<span class="fc" id="L2046">			cacheStaticContentSeconds = Constants.getInt(&quot;cacheStaticContentSeconds&quot;);</span>
		}

<span class="fc bfc" id="L2049" title="All 2 branches covered.">		if (cacheStaticContentSuffixes == null)</span>
		{
<span class="fc" id="L2051">			synchronized(PathFilter.class) //NOSONAR</span>
			{
<span class="pc bpc" id="L2053" title="1 of 2 branches missed.">				if (cacheStaticContentSuffixes == null)</span>
				{
<span class="fc" id="L2055">					String[] tokens = Tools.getTokens(Constants.getString(&quot;cacheStaticContentSuffixes&quot;), &quot;,&quot;, true);</span>
<span class="pc bpc" id="L2056" title="1 of 2 branches missed.">					cacheStaticContentSuffixes = tokens == null ? new String[0] : tokens;</span>
				}
<span class="fc" id="L2058">			}</span>
		}

		//prefixom /cache mame oznacene veci, co sa musia cachovat kvoli rychlosti admin casti (/admin/scripts/common.jsp)
<span class="fc bfc" id="L2062" title="All 2 branches covered.">		if (path.startsWith(&quot;/cache/&quot;)==false)</span>
		{
<span class="pc bpc" id="L2064" title="3 of 6 branches missed.">			if (cacheStaticContentSeconds&lt;1 || cacheStaticContentSuffixes==null || cacheStaticContentSuffixes.length&lt;1) return false;</span>

			//administratorom cache nenastavujem (okrem admin casti, tam sa to casto nemeni)
<span class="pc bpc" id="L2067" title="1 of 10 branches missed.">			if (user!=null &amp;&amp; user.isAdmin() &amp;&amp; path.startsWith(&quot;/admin&quot;)==false &amp;&amp; path.startsWith(&quot;/components&quot;)==false &amp;&amp; Constants.getBoolean(&quot;cacheStaticContentForAdmin&quot;)==false) return false;</span>

			//pre IP pre ktore neevidujeme statistiku nenastavujem (pravdepodobne IWAY + admini)
<span class="pc bpc" id="L2070" title="2 of 4 branches missed.">			if (Constants.getBoolean(&quot;cacheStaticContentForAdmin&quot;)==false &amp;&amp; BrowserDetector.isStatIpAllowedFast(request)==false) return false;</span>
		}
		//String pathLC = path.toLowerCase();
		//v parametri v sa prenasa verzia suboru, v tom pripade cachujeme
		//uz cachujem aj admin cast if (pathLC.startsWith(&quot;/admin/&quot;) &amp;&amp; (request.getParameter(&quot;v&quot;)==null &amp;&amp; request.getParameter(&quot;t&quot;)==null)) return false;

<span class="fc" id="L2076">		int myCacheStaticContentSeconds = cacheStaticContentSeconds;</span>
<span class="pc bpc" id="L2077" title="3 of 4 branches missed.">		if (myCacheStaticContentSeconds &lt; 1 &amp;&amp; path.startsWith(&quot;/cache/&quot;)) myCacheStaticContentSeconds = 300;</span>
		//ak mame parameter v tak natvrdo nastavime cas na 7 dni
<span class="fc bfc" id="L2079" title="All 2 branches covered.">		if (request.getParameter(&quot;v&quot;)!=null) myCacheStaticContentSeconds = 60 * 60 * 24 * 7;</span>
<span class="fc bfc" id="L2080" title="All 2 branches covered.">		if (path.contains(&quot;ckeditor&quot;)) myCacheStaticContentSeconds = 60 * 60 * 24 * 7;</span>
<span class="fc bfc" id="L2081" title="All 2 branches covered.">		if (path.contains(&quot;assets&quot;)) myCacheStaticContentSeconds = 60 * 60 * 24 * 7;</span>
<span class="fc bfc" id="L2082" title="All 2 branches covered.">		if (path.contains(&quot;_common&quot;)) myCacheStaticContentSeconds = 60 * 60 * 24 * 7;</span>
<span class="fc bfc" id="L2083" title="All 2 branches covered.">		if (path.contains(&quot;/admin/images/&quot;)) myCacheStaticContentSeconds = 60 * 60 * 24 * 7;</span>
<span class="pc bpc" id="L2084" title="1 of 4 branches missed.">		if (path.contains(&quot;/admin/v9/dist/&quot;) &amp;&amp; myCacheStaticContentSeconds&lt;301) myCacheStaticContentSeconds = 60 * 30;</span>

<span class="pc bpc" id="L2086" title="1 of 2 branches missed.">		if (myCacheStaticContentSeconds &lt; cacheStaticContentSeconds) myCacheStaticContentSeconds = cacheStaticContentSeconds;</span>

<span class="fc bfc" id="L2088" title="All 2 branches covered.">		for (int i=0; i&lt;cacheStaticContentSuffixes.length; i++)</span>
		{
<span class="fc bfc" id="L2090" title="All 2 branches covered.">			if (path.endsWith(cacheStaticContentSuffixes[i]))</span>
			{
<span class="fc" id="L2092">				setCacheHeaders(myCacheStaticContentSeconds, response);</span>

<span class="fc" id="L2094">				return true;</span>
			}
		}

		//cachovanie json pre dashboard
<span class="pc bpc" id="L2099" title="1 of 2 branches missed.">		if (path.contains(&quot;/admin/v9/json/&quot;)) {</span>
<span class="nc" id="L2100">			setCacheHeaders(60 * 60 * 24, response);</span>
		}

<span class="fc" id="L2103">		return false;</span>
	}

    /**
     * Nastavi HTTP hlavicku Content-Disposition na hdonotu attachment;filename=abc pre subory v adresaroch /files a /images
     * ktore maju priponu definovanu v konf. premennej forceDownloadSuffixes
     *
     * Umozni to vyvolat download dialog napr. pre pdf subory namiesto ich zobrazenia v prehliadaci
     *
     * @param path
     * @param request
     * @param response
     */
	public static void setDownloadHeaders(String path, HttpServletRequest request, HttpServletResponse response)
    {
<span class="fc bfc" id="L2118" title="All 2 branches covered.">        if (path.endsWith(&quot;/&quot;)) return;</span>

<span class="fc bfc" id="L2120" title="All 4 branches covered.">        if (path.startsWith(&quot;/images&quot;) || path.startsWith(&quot;/files&quot;))</span>
        {
            try
            {
<span class="fc" id="L2124">                int lomka = path.lastIndexOf(&quot;/&quot;);</span>
<span class="fc" id="L2125">                int bodka = path.indexOf(&quot;.&quot;, lomka);</span>
<span class="pc bpc" id="L2126" title="1 of 4 branches missed.">                if (lomka &gt; 0 &amp;&amp; bodka &gt; lomka)</span>
                {
<span class="fc" id="L2128">                    String fileName = path.substring(lomka + 1);</span>

<span class="pc bpc" id="L2130" title="1 of 2 branches missed.">                    if (isForceDownload(fileName))</span>
                    {
<span class="nc" id="L2132">                        response.setHeader(&quot;Content-Disposition&quot;, &quot;attachment;filename=&quot;+fileName);</span>
                    }
                }
            }
<span class="nc" id="L2136">            catch (Exception ex)</span>
            {
<span class="nc" id="L2138">                sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L2139">            }</span>
        }
<span class="fc" id="L2141">    }</span>

    public static boolean isForceDownload(String fileName) {
<span class="fc" id="L2144">		String forceDownloadSuffixes = Constants.getString(&quot;forceDownloadSuffixes&quot;);</span>
<span class="fc" id="L2145">		String ext = FileTools.getFileExtension(fileName);</span>

<span class="pc bpc" id="L2147" title="3 of 4 branches missed.">		return (Tools.isNotEmpty(forceDownloadSuffixes) &amp;&amp; forceDownloadSuffixes.contains(ext));</span>
	}

	/**
	 * Nastavi cache hlavicky na pozadovanu hodnotu v sekundach
	 * @param myCacheStaticContentSeconds
	 * @param response
	 */
	public static void setCacheHeaders(int myCacheStaticContentSeconds, HttpServletResponse response)
	{
<span class="fc" id="L2157">		response.setHeader(&quot;Cache-Control&quot;, &quot;max-age=&quot;+myCacheStaticContentSeconds);</span>
<span class="fc bfc" id="L2158" title="All 2 branches covered.">		if (response.containsHeader(&quot;Pragma&quot;))	response.setHeader(&quot;Pragma&quot;,&quot;&quot;);</span>
<span class="fc bfc" id="L2159" title="All 2 branches covered.">		if (response.containsHeader(&quot;Expires&quot;)) response.setDateHeader(&quot;Expires&quot;, Tools.getNow()+myCacheStaticContentSeconds*1000);</span>
<span class="fc" id="L2160">	}</span>

	/**
	 * Cache pre staticke subory, cachuju sa len subory pre ktore sa nastavuje setStaticContentHeaders
	 * @param url
	 * @return
	 */
	public static boolean writeAndCacheFile(String url, HttpServletResponse response)
	{
		//ak je cache vypnuta, neriesime
<span class="nc bnc" id="L2170" title="All 2 branches missed.">		if (FileCache.useFileCache() == false) return false;</span>
		//pre DB storage tu cache neriesime, to sa riesi priamo v IwcmFsFilter
<span class="nc bnc" id="L2172" title="All 2 branches missed.">		if (IwcmFsDB.useDBStorage()) return false;</span>

<span class="nc" id="L2174">		String mimeType = Constants.getServletContext().getMimeType(url.toLowerCase());</span>
<span class="nc bnc" id="L2175" title="All 2 branches missed.">		if (Tools.isEmpty(mimeType)) mimeType = &quot;application/octet-stream&quot;;</span>
<span class="nc" id="L2176">		response.setContentType(mimeType);</span>

<span class="nc" id="L2178">		byte[] data = FileCache.getObject(url);</span>
<span class="nc bnc" id="L2179" title="All 2 branches missed.">		if (data != null)</span>
		{
<span class="nc" id="L2181">			response.setContentLength(data.length);</span>

			try
			{
<span class="nc" id="L2185">				OutputStream out=response.getOutputStream();</span>
<span class="nc" id="L2186">				out.write(data);</span>
<span class="nc" id="L2187">				out.close();</span>
<span class="nc" id="L2188">				return true;</span>
			}
<span class="nc" id="L2190">			catch (Exception ex)</span>
			{
<span class="nc" id="L2192">				sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L2193">			}</span>
		}
		else
		{
<span class="nc" id="L2197">			IwcmFile f = new IwcmFile(Tools.getRealPath(url));</span>
<span class="nc bnc" id="L2198" title="All 2 branches missed.">			if (f.length() &gt; FileCache.getMaxFileSize()) return false;</span>

<span class="nc" id="L2200">			response.setContentLength((int)f.length());</span>

			//nacitaj data do pola
<span class="nc" id="L2203">			data = new byte[(int)f.length()];</span>
<span class="nc" id="L2204">			boolean dataCopied = false;</span>

<span class="nc" id="L2206">			IwcmInputStream in = null;</span>
			try
			{
<span class="nc" id="L2209">				OutputStream out=response.getOutputStream();</span>

<span class="nc" id="L2211">				in = new IwcmInputStream(f);</span>

<span class="nc" id="L2213">				byte[] buffer = new byte[64000];</span>
<span class="nc" id="L2214">				int bytesRead = 0;</span>
<span class="nc" id="L2215">				int bytesCopied = 0;</span>
<span class="nc bnc" id="L2216" title="All 2 branches missed.">				while ((bytesRead = in.read(buffer, 0, 64000)) != -1)</span>
				{
					//Logger.debug(IwcmFsDB.class, &quot;writing &quot;+bytesRead);
<span class="nc" id="L2219">					out.write(buffer, 0, bytesRead);</span>

<span class="nc" id="L2221">					System.arraycopy(buffer, 0, data, bytesCopied, bytesRead);</span>
<span class="nc" id="L2222">					bytesCopied+=bytesRead;</span>
				}
<span class="nc" id="L2224">				out.flush();</span>
<span class="nc" id="L2225">				out.close();</span>
<span class="nc" id="L2226">				in.close();</span>

<span class="nc" id="L2228">				dataCopied = true;</span>
			}
<span class="nc" id="L2230">			catch (Exception e)</span>
			{
<span class="nc" id="L2232">				sk.iway.iwcm.Logger.error(e);</span>
			}
			finally
			{
<span class="nc bnc" id="L2236" title="All 2 branches missed.">				if (in != null) try { in.close(); } catch (Exception e) {}</span>
			}

<span class="nc bnc" id="L2239" title="All 2 branches missed.">			if (dataCopied)</span>
			{
<span class="nc" id="L2241">				FileCache.setObject(url, data);</span>
<span class="nc" id="L2242">				return true;</span>
			}
		}

<span class="nc" id="L2246">		return false;</span>
	}

	/**
	 * Nastavenie hlavicky X-Robots-Tag, viz https://developers.google.com/webmasters/control-crawl-index/docs/robots_meta_tag
	 * @param url
	 * @param response
	 */
	public static void setXRobotsTagValue(String url, HttpServletResponse response)
	{
<span class="fc" id="L2256">		String xRobotsTagUrls = Constants.getString(&quot;xRobotsTagUrls&quot;);</span>
<span class="pc bpc" id="L2257" title="1 of 2 branches missed.">		if (Tools.isEmpty(xRobotsTagUrls)) return;</span>

<span class="fc bfc" id="L2259" title="All 2 branches covered.">		if (url.charAt(0)=='/') url = url.toLowerCase(); //aby sa nam NOT_SEARCHABLE_PAGE nezmenilo na male pismena</span>

<span class="fc" id="L2261">		String[] paths = Tools.getTokens(xRobotsTagUrls, &quot;,&quot;, true);</span>
<span class="fc bfc" id="L2262" title="All 2 branches covered.">		for (String path : paths)</span>
		{
<span class="fc bfc" id="L2264" title="All 2 branches covered.">			if (ResponseHeaderService.isPathCorrect(path, url))</span>
			{
<span class="fc" id="L2266">				String xRobotsTagValue = Constants.getStringExecuteMacro(&quot;xRobotsTagValue&quot;);</span>
<span class="pc bpc" id="L2267" title="1 of 2 branches missed.">				if (Tools.isNotEmpty(xRobotsTagValue))</span>
				{
<span class="fc" id="L2269">					response.setHeader(&quot;X-Robots-Tag&quot;, xRobotsTagValue);</span>
<span class="fc" id="L2270">					return;</span>
				}
			}
		}
<span class="fc" id="L2274">	}</span>

	public static void setUaCompatibleAdmin(String path, HttpServletResponse response)
	{
<span class="fc" id="L2278">		String xUaCompatibleAdminValue = Constants.getString(&quot;xUaCompatibleAdminValue&quot;);</span>
<span class="pc bpc" id="L2279" title="1 of 2 branches missed.">		if (Tools.isEmpty(xUaCompatibleAdminValue)) return;</span>


<span class="fc" id="L2282">		response.setHeader(&quot;X-UA-Compatible&quot;, xUaCompatibleAdminValue);</span>
<span class="fc" id="L2283">	}</span>

	/**
	 * Nastavi hlavicku X-Frame-Options podla konfiguracnej premennej xFrameOptions
	 * @param response
	 */
	private static void setXFrameOptions(HttpServletResponse response)
	{
<span class="fc" id="L2291">		String xFrameOptions = Constants.getString(&quot;xFrameOptions&quot;);</span>
<span class="pc bpc" id="L2292" title="1 of 2 branches missed.">		if (Tools.isEmpty(xFrameOptions)) return;</span>


<span class="fc" id="L2295">		response.setHeader(&quot;X-Frame-Options&quot;, xFrameOptions);</span>
<span class="fc" id="L2296">	}</span>

	private static void setXXssProtection(HttpServletResponse response)
	{
<span class="fc" id="L2300">		String xXssProtection = Constants.getString(&quot;xXssProtection&quot;);</span>
<span class="pc bpc" id="L2301" title="1 of 2 branches missed.">		if (Tools.isEmpty(xXssProtection)) return;</span>

<span class="fc" id="L2303">		response.setHeader(&quot;X-XSS-Protection&quot;, xXssProtection);</span>
<span class="fc" id="L2304">	}</span>

	/**
	 * Nastavi hlavicku Feature-Policy podla konfiguracnej premennej featurePolicyHeader
	 * @param response
	 */
	public static void setFeaturePolicy(HttpServletResponse response)
	{
<span class="fc" id="L2312">		String featurePolicy = Constants.getString(&quot;featurePolicyHeader&quot;);</span>
<span class="pc bpc" id="L2313" title="1 of 2 branches missed.">		if (Tools.isEmpty(featurePolicy)) return;</span>

<span class="nc" id="L2315">		response.setHeader(&quot;Feature-Policy&quot;, featurePolicy);</span>
<span class="nc" id="L2316">		response.setHeader(&quot;Permissions-Policy&quot;, featurePolicy);</span>
<span class="nc" id="L2317">	}</span>

	/**
	 * Nastavenie hlavicky Access-Control-Allow-Origin
	 * @param url
	 * @param response
	 */
	public static void setAccessControlAllowOrigin(String url, HttpServletResponse response)
	{
<span class="fc" id="L2326">		String accessControlAllowOriginUrls = Constants.getString(&quot;accessControlAllowOriginUrls&quot;);</span>
<span class="pc bpc" id="L2327" title="1 of 2 branches missed.">		if (Tools.isEmpty(accessControlAllowOriginUrls)) return;</span>

<span class="fc" id="L2329">		String[] paths = Tools.getTokens(accessControlAllowOriginUrls, &quot;,&quot;, true);</span>
<span class="fc" id="L2330">		String accessControlAllowOriginValue = Constants.getStringExecuteMacro(&quot;accessControlAllowOriginValue&quot;);</span>
<span class="fc bfc" id="L2331" title="All 2 branches covered.">		for (String path : paths)</span>
		{
<span class="fc bfc" id="L2333" title="All 2 branches covered.">			if (ResponseHeaderService.isPathCorrect(path, url))</span>
			{
<span class="pc bpc" id="L2335" title="1 of 2 branches missed.">				if (Tools.isNotEmpty(accessControlAllowOriginValue))</span>
				{
<span class="fc" id="L2337">					String accessControlAllowedOrigins = Constants.getString(&quot;accessControlAllowedOrigins&quot;);</span>
<span class="fc" id="L2338">					boolean canAccess = false;</span>
<span class="pc bpc" id="L2339" title="1 of 2 branches missed.">					if (Tools.isEmpty(accessControlAllowedOrigins))</span>
					{
<span class="fc" id="L2341">						canAccess = true;</span>
					}
					else
					{
<span class="nc" id="L2345">						accessControlAllowedOrigins = Tools.replace(accessControlAllowedOrigins, &quot;\n&quot;, &quot;,&quot;);</span>
<span class="nc" id="L2346">						accessControlAllowedOrigins = Tools.replace(accessControlAllowedOrigins, &quot;\r&quot;, &quot;,&quot;);</span>
<span class="nc" id="L2347">						RequestBean rb = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="nc bnc" id="L2348" title="All 2 branches missed.">						if (rb != null) {</span>
<span class="nc" id="L2349">							String origin = rb.getHeaderOrigin();</span>
<span class="nc bnc" id="L2350" title="All 2 branches missed.">							if (Tools.isNotEmpty(origin))</span>
							{
<span class="nc bnc" id="L2352" title="All 2 branches missed.">								if ((&quot;,&quot;+accessControlAllowedOrigins+&quot;,&quot;).contains(&quot;,&quot;+origin+&quot;,&quot;)) canAccess = true;</span>
							}
						}
					}

<span class="pc bpc" id="L2357" title="1 of 2 branches missed.">					if (canAccess)</span>
					{
<span class="fc" id="L2359">						response.setHeader(&quot;Access-Control-Allow-Origin&quot;, accessControlAllowOriginValue);</span>
<span class="fc" id="L2360">						setHeader(response, &quot;Access-Control-Allow-Headers&quot;, &quot;accessControlAllowHeaders&quot;);</span>
<span class="fc" id="L2361">						setHeader(response, &quot;Access-Control-Allow-Methods&quot;, &quot;accessControlAllowMethods&quot;);</span>
<span class="fc" id="L2362">						setHeader(response, &quot;Access-Control-Max-Age&quot;, &quot;accessControlMaxAge&quot;);</span>
<span class="fc" id="L2363">						return;</span>
					}
				}
			}
		}
<span class="fc" id="L2368">	}</span>

	/**
	 * Nastavi HTTP hlavicku podla nazvu konfiguracnej premennej
	 * @param response
	 * @param headerName - meno HTTP hlavicky
	 * @param constantName - meno konfiguracnej premennej
	 */
	public static void setHeader(HttpServletResponse response, String headerName, String constantName)
	{
<span class="fc" id="L2378">		String value = Constants.getStringExecuteMacro(constantName);</span>
<span class="fc bfc" id="L2379" title="All 2 branches covered.">		if (Tools.isEmpty(value)) return;</span>

<span class="pc bpc" id="L2381" title="1 of 2 branches missed.">		if (&quot;&amp;nbsp;&quot;.equals(value)) value = &quot; &quot;;</span>

		//Logger.debug(SetCharacterEncodingFilter.class, &quot;Setting header &quot;+headerName+&quot;:&quot;+value);

<span class="fc" id="L2385">		response.setHeader(headerName, value);</span>
<span class="fc" id="L2386">	}</span>

	/**
	 * Nastavi hlavicky pre konkretne volania podla konfiguracnej premennej responseHeaders
	 * @param response
	 */
	private static void setResponseHeaders(String path, HttpServletRequest request, HttpServletResponse response) {

<span class="pc bpc" id="L2394" title="1 of 6 branches missed.">		if (path.startsWith(&quot;/files&quot;) || path.startsWith(&quot;/images&quot;) || path.startsWith(&quot;/shared&quot;)) {</span>
<span class="fc" id="L2395">			String lngCode = Constants.getString(&quot;defaultLanguage&quot;);</span>
			//set last known language for files and images folder
<span class="fc bfc" id="L2397" title="All 2 branches covered.">			if (path.contains(&quot;/en/&quot;)) lngCode = &quot;en&quot;;</span>
<span class="pc bpc" id="L2398" title="1 of 2 branches missed.">			else if (path.contains(&quot;/de/&quot;)) lngCode = &quot;de&quot;;</span>
<span class="fc bfc" id="L2399" title="All 2 branches covered.">			else if (path.contains(&quot;/cz/&quot;)) lngCode = &quot;cz&quot;;</span>
<span class="pc bpc" id="L2400" title="1 of 2 branches missed.">			else if (path.contains(&quot;/sk/&quot;)) lngCode = &quot;sk&quot;;</span>
<span class="fc" id="L2401">			else lngCode = PageLng.getUserLng(request);</span>

<span class="fc" id="L2403">			String isoCode = PageLng.getUserLngIso(lngCode);</span>
<span class="fc" id="L2404">			ResponseHeaderService.setContentLanguageHeader(isoCode, true, request, response);</span>
		}

		// parse and cache
<span class="fc bfc" id="L2408" title="All 2 branches covered.">		if(responseHeaders == null) {</span>
<span class="fc" id="L2409">			synchronized (PathFilter.class) {</span>

<span class="fc" id="L2411">				String[] headers = Tools.getTokens(Constants.getString(&quot;responseHeaders&quot;), &quot;\n&quot;);</span>
<span class="pc bpc" id="L2412" title="1 of 2 branches missed.">				if(headers.length &gt; 0) {</span>
<span class="fc" id="L2413">					responseHeaders = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L2414" title="All 2 branches covered.">					for(int i = 0; i &lt; headers.length; i++) {</span>
<span class="fc" id="L2415">						responseHeaders.add(new ResponseHeaderBean(headers[i]));</span>
					}
				}
<span class="fc" id="L2418">			}</span>
		}

		// set headers
<span class="pc bpc" id="L2422" title="1 of 2 branches missed.">		if(responseHeaders != null) {</span>
<span class="fc bfc" id="L2423" title="All 2 branches covered.">			for(ResponseHeaderBean header : responseHeaders) {</span>
<span class="fc bfc" id="L2424" title="All 2 branches covered.">				if(path.startsWith(header.getUrl())) {</span>
<span class="fc" id="L2425">					response.setHeader(header.getName(), Constants.executeMacro(header.getValue()));</span>
				}
<span class="fc" id="L2427">			}</span>
		}

<span class="fc" id="L2430">		ResponseHeaderService.setResponseHeaders(path, request, response);</span>
<span class="fc" id="L2431">	}</span>

	/**
	 * Ak existuje _mobile.jsp verzia zadaneho JSP vykona nan interny forward a vrati true pre ukoncenie povodneho JSP, nieco ako:
	 * if (PathFilter.forwardToMobileOrTablet(&quot;/components/magzilla/new_bug_popup.jsp&quot;, pageContext)) return;
	 * @param jspFileName
	 * @param context
	 * @return
	 */
	public static boolean forwardToMobileOrTablet(String jspFileName, PageContext context)
	{
<span class="nc bnc" id="L2442" title="All 2 branches missed.">		if (BrowserDetector.isSmartphoneOrTablet((HttpServletRequest)context.getRequest())==false) return false;</span>

<span class="nc" id="L2444">		String mobileJsp = Tools.replace(jspFileName, &quot;.jsp&quot;, &quot;_mobile.jsp&quot;);</span>
<span class="nc bnc" id="L2445" title="All 2 branches missed.">		if (FileTools.isFile(mobileJsp)==false) return false;</span>

		try
		{
<span class="nc" id="L2449">			context.forward(mobileJsp);</span>
<span class="nc" id="L2450">			return true;</span>
		}
<span class="nc" id="L2452">		catch (Exception e)</span>
		{
<span class="nc" id="L2454">			sk.iway.iwcm.Logger.error(e);</span>
		}
<span class="nc" id="L2456">		return false;</span>
	}

	/**
	 * Pouziva sa v spojeni s nginx cache proxy serverom, nastavuje cookie s nazvom nc ktora nasledne v
	 * dalsich http requestoch od klienta zamedzi posielaniu cache vysledkov (ak je nastavena na hodnotu 1)
	 * @param request
	 * @param response
	 */
	public static void setNginxProxyMode(HttpServletRequest request, HttpServletResponse response)
	{
		try
		{
<span class="pc bpc" id="L2469" title="1 of 2 branches missed.">			if (Constants.getBoolean(&quot;nginxProxyMode&quot;)==false) return;</span>

<span class="nc" id="L2471">			String actualCookieValue = Tools.getCookieValue(request.getCookies(), &quot;nc&quot;, null);</span>
<span class="nc" id="L2472">			Cookie c = new Cookie(&quot;nc&quot;, &quot;1&quot;);</span>
<span class="nc" id="L2473">			c.setPath(&quot;/&quot;);</span>

			//ak potrebujeme nastavit nocache cookie
<span class="nc bnc" id="L2476" title="All 2 branches missed.">			if (isNoCacheCookieRequired(request))</span>
			{
				//ak uz je nastavena na 1 tak ju nemusime nastavovat
<span class="nc bnc" id="L2479" title="All 2 branches missed.">				if (&quot;1&quot;.equals(actualCookieValue)==false) {</span>
					//session cookie
<span class="nc" id="L2481">					c.setMaxAge(-1);</span>
					//toto nesmie ist cez Tools.addCookie pretoze sa ani v pripade EU smernice nemoze vypnut
<span class="nc" id="L2483">					response.addCookie(c);</span>
				}
			}
			else
			{
<span class="nc bnc" id="L2488" title="All 2 branches missed.">				if (&quot;1&quot;.equals(actualCookieValue)) {</span>
					//cookie nam prisla v http requeste ale uz ju nemam setovat, takze ju dam zmazat
<span class="nc" id="L2490">					c.setMaxAge(0);</span>
					//toto nesmie ist cez Tools.addCookie pretoze sa ani v pripade EU smernice nemoze vypnut
<span class="nc" id="L2492">					response.addCookie(c);</span>
				}
			}
		}
<span class="nc" id="L2496">		catch (Exception e)</span>
		{
<span class="nc" id="L2498">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L2499">		}</span>
<span class="nc" id="L2500">	}</span>

	/**
	 * Overi, ci je mozne pouzit nginx proxy rezim (konstanta nginxProxyMode), ak je povoleny, overuje este:
	 * prihlaseneho pouzivatela (rezim nedostupny)
	 * prepnutie verzie cez forceBrowserDetector (ak je ina verzia ako pc nedostupne)
	 * @param request
	 * @return
	 */
	public static boolean isNoCacheCookieRequired(HttpServletRequest request)
	{
<span class="nc bnc" id="L2511" title="All 2 branches missed.">		if (request.getSession()!=null)</span>
		{
<span class="nc bnc" id="L2513" title="All 2 branches missed.">			if (request.getSession().getAttribute(Constants.USER_KEY)!=null) return true;</span>
<span class="nc bnc" id="L2514" title="All 4 branches missed.">			else if (request.getParameter(&quot;forceBrowserDetector&quot;)!=null &amp;&amp; &quot;pc&quot;.equals(request.getParameter(&quot;forceBrowserDetector&quot;))==false) return true; //NOSONAR</span>
<span class="nc bnc" id="L2515" title="All 2 branches missed.">			else if (request.getSession().getAttribute(&quot;BrowserDetector.forceBrowserDetector&quot;)!=null) return true; //NOSONAR</span>
		}

<span class="nc" id="L2518">		return false;</span>
	}


	/**
	 * Vrati URL adresu pre httpS presmerovanie
	 * @param request
	 * @return
	 */
	public static String getHttpsRedirectUrl(HttpServletRequest request)
	{
<span class="nc" id="L2529">		String path = PathFilter.getOrigPath(request);</span>
<span class="nc" id="L2530">		String qs = request.getQueryString();</span>
<span class="nc" id="L2531">		StringBuilder url = new StringBuilder(&quot;https://&quot;).append(Tools.getServerName(request)).append(path);</span>
<span class="nc bnc" id="L2532" title="All 2 branches missed.">		if (Tools.isNotEmpty(qs)) url.append('?').append(qs);</span>
<span class="nc" id="L2533">		return Tools.sanitizeHttpHeaderParam(url.toString());</span>
	}

	/**
	 * Otestuje, ci je povolene showdoc volanie pre dane docId
	 * @param docId - id dokumentu
	 * @param constantName - meno konstanty
	 * @return
	 */
	private static boolean isShowDocAllowDocId(int docId, String constantName)
	{
<span class="nc" id="L2544">		String showDocAllowDocIds = Constants.getString(constantName);</span>
<span class="nc bnc" id="L2545" title="All 2 branches missed.">		if (Tools.isNotEmpty(showDocAllowDocIds))</span>
		{
<span class="nc" id="L2547">			StringTokenizer st = new StringTokenizer(showDocAllowDocIds, &quot;,+;&quot;);</span>
<span class="nc bnc" id="L2548" title="All 2 branches missed.">			while (st.hasMoreTokens())</span>
			{
<span class="nc" id="L2550">				int token = Tools.getIntValue(st.nextToken().trim(), -1);</span>
<span class="nc bnc" id="L2551" title="All 2 branches missed.">				if(token == -1) continue;	//preskocim</span>
<span class="nc bnc" id="L2552" title="All 2 branches missed.">				if(docId == token)</span>
				{
<span class="nc" id="L2554">					return true;</span>
				}
<span class="nc" id="L2556">			}</span>
		}
<span class="nc" id="L2558">		return false;</span>
	}

	public static void resetResponseHeaders() {
<span class="nc" id="L2562">		responseHeaders = null;</span>
<span class="nc" id="L2563">	}</span>

	public static void resetCacheStaticContentSeconds()
	{
<span class="nc" id="L2567">		cacheStaticContentSeconds = -1;</span>
<span class="nc" id="L2568">		cacheStaticContentSuffixes = null;</span>
<span class="nc" id="L2569">	}</span>

	//pre WebJET 9 kontrolujeme pri REST volaniach CSRF token
	private boolean checkCSRFTokenAjax(String path, HttpServletRequest request) {
<span class="pc bpc" id="L2573" title="2 of 6 branches missed.">		if (path.startsWith(&quot;/admin/rest/&quot;)==false || path.startsWith(&quot;/admin/rest/document/&quot;) || path.startsWith(&quot;/admin/rest/datatables/&quot;) ) {</span>
			//taketo URL nekontrolujeme
<span class="fc" id="L2575">			return true;</span>
		}

		//ak path obsahuje vyraz html tak token nie je potrebny
<span class="pc bpc" id="L2579" title="1 of 4 branches missed.">		if (path.contains(&quot;/html&quot;) || path.contains(&quot;html/&quot;)) return true;</span>

<span class="pc bpc" id="L2581" title="1 of 2 branches missed.">		if (&quot;webjet9&quot;.equals(Constants.getString(&quot;defaultSkin&quot;))==false) return true;</span>

		//pouziva sa pri prihlaseni tokenom, vtedy CSRF nie je posielane
<span class="fc bfc" id="L2584" title="All 2 branches covered.">		if (request.getAttribute(&quot;csrfDisabled&quot;)!=null) return true;</span>

<span class="fc" id="L2586">		String header = request.getHeader(&quot;X-CSRF-Token&quot;);</span>
<span class="fc bfc" id="L2587" title="All 2 branches covered.">		if (Tools.isEmpty(header)) {</span>
<span class="fc" id="L2588">			return false;</span>
		}

<span class="fc" id="L2591">		return CSRF.verifyTokenAjax(request.getSession(), header);</span>
	}

	private static void setCustomPath(String path) {
<span class="fc" id="L2595">		PathFilter.customPath = path;</span>
<span class="fc" id="L2596">	}</span>

	/**
	 * Safely forward request dispatcher, need to use this if next statement is return
	 * eg. after checkAdmin you must return from PathFilter even when /404.jsp has compilation errors
	 * @param request
	 * @param response
	 * @param path
	 */
	private static void forwardSafely(String path, HttpServletRequest request, HttpServletResponse response){
		try {
<span class="fc" id="L2607">		request.getRequestDispatcher(path).forward(request, response);</span>
<span class="nc" id="L2608">		} catch (Exception ex) {</span>
<span class="nc" id="L2609">			Logger.error(PathFilter.class, ex);</span>
<span class="fc" id="L2610">		}</span>
<span class="fc" id="L2611">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>