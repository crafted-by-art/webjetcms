# 'JsTree Document Opener'

Expanding library

***

**Dependencies**

- [Tools](tools.md)
***
The library allows automated manipulation (opening) of tree nodes generated by the jsTree library and opening of a document based on its ID in the dataTables library.

Expands the class `AbstractJsTreeOpener`

```javascript
import AbstractJsTreeOpener from "../abstract-opener/abstract-js-tree-opener";

export class JsTreeDocumentOpener extends AbstractJsTreeOpener {}
```

***

## Creating an instance:

**WebJET** creates an instance in the file [app.js](https://github.com/webjetcms/webjetcms/blob/main/src/main/webapp/admin/v9/src/js/app.js)
```javascript
import JsTreeDocumentOpener from "./libs/js-tree-document-opener/js-tree-document-opener";

window.jsTreeDocumentOpener = new JsTreeDocumentOpener();
```

**Application:**

### Initiation:

Ideally, the initialization is performed whenever the jstree is initialized by calling the method [init()](#init)

```javascript
window.jsTreeDocumentOpener.init();
```

Wo **WebJET** initialization is in progress in the file [app-init.js](https://github.com/webjetcms/webjetcms/blob/main/src/main/webapp/admin/v9/src/js/app-init.js)

```javascript
window.jstree = somStromcek.jstree({
	core: {
		check_callback: function (operation, node, parent, position, more) {},
		data: function (obj, callback) {
			window.jsTreeDocumentOpener.init();
		},
	},
});
```

Method [init()](#init) ensure: <a id="init-algo" />

1.  Parses from the browser url using [Tools.getUrlQuery()](tools.md#geturlquery) search query after question mark

2.  Removes the key from the evaporated object `docid` if we haven't changed it before with [idKeyName](#idkeyname)

3.  The value of z `docid` sows with a setter [id](#id)

4.  Setter [id](#id) resets the class to the new state and validates the input: <a id="id-algo" />

    1.  If the input is invalid, the DEV environment prints a message about the invalid input and aborts the execution

        1.  The class switches to the state `Not Ready & Iddle`, waiting for the setter's call [id](#id)

    2.  If the input is valid, a request is made to the API, whose default address can be changed using [apiUrl](#apiurl)

        1.  The received data is stored in the class so that it can be worked with

        2.  The class switches to the state `Ready & Iddle` and waiting for the call [next()](#next) or [id](#id)

***

### Opening tree nodes:

Opening tree nodes is done by calling the method [next()](#next):

```javascript
window.jsTreeDocumentOpener.next();
```

Wo **WebJET** a call is in progress in the file [app-init.js](https://github.com/webjetcms/webjetcms/blob/main/src/main/webapp/admin/v9/src/js/app-init.js)

1.  After thinning the tree `/listener: loaded.jstree`

2.  After opening (*open node*) of the node `/listener: after_open.jstree`

3.  After selecting (*select node*) of the node `/listener: select_node.jstree`

***
**Warning:** In case we want to externally set [id](#id) it is good to use the method before [loaded()](#loaded)in which we can call [next()](#next) and test [notFound](#notfound).
```javascript
/** @type {JsTreeDocumentOpener} jstdo */
const jstdo = window.jsTreeDocumentOpener.loaded((result, docId, selfClass) => {
	if (selfClass.notFound) {
		// Napr. nejaký alert pre používateľa
	} else {
		selfClass.next();
	}
});

jstdo.id = 4;
```

The problem with the implementation was waiting for the tree structure to be loaded and the datatable to be synchronized. The original implementation used events `this.dataTable.on('draw.dt', (evt, settings) => `which was not suitable for use when switching the Folders, System and Trash tabs, because the datatable was loaded immediately after switching the tab.

The code uses the function `setInterval` with call counting in the function `waitForDatatableRowLoaded` and waiting for the non-display `div.dataTables_processing:visible`. When it is not displayed, it counts 3 more intervals of non-display and then continues searching for the web page. Similarly, tree structure loading is also handled, waiting is implemented in the function `waitForJsTreeLoaded`. Functions are implemented directly in `abstract-js-tree-opener.js`.

The search is also complicated because of pagination and the differences between client and server pagination. In both cases, it goes through each page in turn, looking for the element with the specified ID. If found it opens the editor.

If as `docid` parameter specified value `-1` a simulated click on the Add button will open a new editor.

When combining the specified parameter `groupid` the following situations are possible:
- positive is entered `docid` - parameter `groupid` is ignored, the directory is opened according to the directory of the specified web page
- is specified `docid=-1`, parameter `groupid` is used to open the directory structure and then to open a new web page
***
## List of APIs

**(Click to see the detail for the function)**
| Methods | Gettery | Gettery | Settery | | --------------------------------- | --------------------- | ----------------------- | | [init()](#init)                   | [notFound](#notfound) | [id](#id)               | | [next()](#next)                   | | [apiUrl](#apiurl)       | | [loaded()](#loaded)               | | [idKeyName](#idkeyname) | | [inputDataFrom()](#inputdatafrom) | | | | [setInputValue()](#setinputvalue) | | |

***
### Detailed description of functions

#### init()

Invokes an initialization that provides [the following procedure](#init-algo)

```javascript
/**
 * @description Inicializácia po načítaní jstree
 * @returns {void}
 * @public
 */
window.jsTreeDocumentOpener.init();
```

***
#### next()

Opens the next node in the sequence. If no other node already exists in the list, opens the dataTable document with our ID.

```javascript
/**
 * @description Otvorí nasledujúci node v poradí.
 *              Ak už neexistuje v zozname žiadny ďalší node, otvorý dataTable dokument s našim ID.
 * @returns {void}
 * @public
 */
window.jsTreeDocumentOpener.next();
```

***
#### loaded()

Sets a callback that is executed after a new [id](#id) and receipt of data.

```javascript
/**
 * @description Nastaví callback, ktorý sa vykoná po zadaní nového DocID a prijatí dát.
 * @param {Function} callback [result, docId, JsTreeDocumentOpener]
 * @returns {JsTreeDocumentOpener}
 * @public
 */
window.jsTreeDocumentOpener.loaded(callback);
```

***
#### inputDataFrom()

Connects the specified input, which must be inserted as a jQuery object `$('.input-css-trieda')`. Input ensures entering a new ID

```javascript
/**
 * @description Pripojí zadaný input, ktorý musí byť vložený ako jQuery objekt `$('.input-css-trieda')`
 *              Input zabezpečuje zadanie nového ID
 * @param {jQuery} openerInput jQuery selector for input
 * @param {function} [withNotifyCallback] Callback, ktorý sa vykoná, pri chybnom vstupe alebo nenájdenom dokumente.
 *                                        V callbacku je dostupný argument `value`
 * @returns {void}
 * @public
 */
window.jsTreeDocumentOpener.inputDataFrom(openerInput, withNotifyCallback);
```

***
#### setInputValue()

If it was connected using [inputDataFrom()](#inputdatafrom) input, we can set the value of the input from anywhere.

```javascript
/**
 * @description Ak bol pripojený pomocou inputDataFrom() input, tak danému inputu môžeme odkiaľkoľvek nastaviť value.
 * @see inputDataFrom
 * @param {string|number} value
 * @returns {void}
 * @public
 */
window.jsTreeDocumentOpener.setInputValue(value);
```

***
#### id

Set a new document ID. This ID will be sent via the API and will also be used to open the document after the corresponding tree nodes have been successfully opened.

[Click for more info what setter id does](#id-algo)

```javascript
/**
 * @description Nastavenie nového ID dokumentu.
 *              Toto ID bude odoslané cez API a zároveň bude použité na otvorenie dokumentu po úspešnom otvorení príslušných uzlov stromu.
 * @default docid
 * @param {number|string} id
 * @returns {void}
 * @public
 * @setter
 */
window.jsTreeDocumentOpener.docId = value;
```

***
#### apiUrl

Setting up a new API url

```javascript
/**
 * @description Nastavenie novej API url
 * @param {string} value
 * @example
 *          API url bez ID
 *          `/admin/rest/web-pages/parents/`
 * @returns {void}
 * @public
 * @setter
 */
window.jsTreeDocumentOpener.apiUrl = value;
```

***
#### idKeyName

The new name of the URl query key that will contain the document ID.

```javascript
/**
 * @description Nový názov URl query kľúča, v ktorom sa bude nachádzať ID dokumentu.
 * @param {string} value
 * @returns {void}
 * @public
 * @setter
 */
window.jsTreeDocumentOpener.idKeyName = value;
```

***
#### notFound

It is used to determine if, after receiving data, the node we want to open first exists in the jsTree. If such a node does not exist (not found), then the value TRUE is returned. If such a node exists (has been found), then the value FALSE is returned.

[loaded()](#loaded)

```javascript
/**
 * @description Slúži na zistenie, či po prijatí dát, existuje v jsTree uzol, ktorý chceme otvoriť ako prvý.
 *              Ak takýto uzol neexistuje (nebol nájdený / not found), tak sa nám vráti hodnota TRUE
 *              Ak takýto uzol existuje (bol nájdený / found), tak sa nám vráti hodnota FALSE
 *              Ideálne použitie tohto gettera je vo vnútri metódy loaded()
 * @returns {boolean}
 * @public
 * @getter
 */
window.jsTreeDocumentOpener.notFound;
```

***
