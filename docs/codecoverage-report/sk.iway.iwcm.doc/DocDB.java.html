<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DocDB.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.doc</a> &gt; <span class="el_source">DocDB.java</span></div><h1>DocDB.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.doc;

import gnu.trove.TIntObjectHashMap;
import gnu.trove.TObjectIntHashMap;

import org.apache.struts.util.ResponseUtils;
import org.json.JSONObject;
import sk.iway.iwcm.*;
import sk.iway.iwcm.common.AdminTools;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.common.DocTools;
import sk.iway.iwcm.components.forum.rest.ForumGroupService;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.editor.*;
import sk.iway.iwcm.editor.service.GroupsService;
import sk.iway.iwcm.editor.service.WebpagesService;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.stat.StatDB;
import sk.iway.iwcm.stat.StatNewDB;
import sk.iway.iwcm.system.cluster.ClusterDB;
import sk.iway.iwcm.system.fulltext.indexed.Documents;
import sk.iway.iwcm.system.spring.events.DocumentPublishEvent;
import sk.iway.iwcm.system.spring.events.WebjetEvent;
import sk.iway.iwcm.system.spring.events.WebjetEventType;
import sk.iway.iwcm.users.UserGroupDetails;
import sk.iway.iwcm.users.UserGroupsDB;
import sk.iway.iwcm.users.UsersDB;

import javax.servlet.http.HttpServletRequest;
import java.net.MalformedURLException;
import java.net.URI;
import java.net.URL;
import java.sql.*;
import java.text.Collator;
import java.util.*;
import java.util.Date;
import java.util.Map.Entry;
import java.util.concurrent.TimeUnit;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 *  Drzi cacheable udaje z tabulky documents a nacita pozadovany necacheable
 *
 *@Title        Interway Content Management
 *@Company      Interway s.r.o. (www.interway.sk)
 *@Copyright    Interway s.r.o. (c) 2001-2002
 *@author       $Author: jeeff $
 *@version      $Revision: 1.55 $
 *@created      $Date: 2004/03/23 20:41:10 $
 *@modified     $Date: 2004/03/23 20:41:10 $
 */
@SuppressWarnings({&quot;java:S6905&quot;, &quot;java:S1133&quot;, &quot;java:S6909&quot;, &quot;java:S6912&quot;})
public class DocDB extends DB
{
	/**
	 *  Description of the Field
	 */
	public static final int ORDER_TITLE = 1;
	/**
	 *  Description of the Field
	 */
	public static final int ORDER_ID = 2;
	/**
	 *  Description of the Field
	 */
	public static final int ORDER_PRIORITY = 3;
	/**
	 *  Description of the Field
	 */
	public static final int ORDER_DATE = 4;
	/**
	 *  Description of the Field
	 */
	public static final int ORDER_PLACE = 5;

	public static final int ORDER_EVENT_DATE = 6;

	public static final int ORDER_SAVE_DATE = 7;

	public static final int ORDER_RATING = 8;


	/**
	 * getDocPerex vrati iba dokumenty, co maju platny zaciatok a koniec
	 */
	public static final int PUBLISH_NEW = 1;
	/**
	 * getDocPerex vrati iba dokumenty, co su stare
	 */
	public static final int PUBLISH_OLD = 2;
	/**
	 * getDocPerex vrati vsetky dokumenty, bez ohladu na datum publikovania
	 */
	public static final int PUBLISH_ALL = 3;
	/**
	 * getDocPerex vrati vsetky dokumenty v buducnosti (_NEW vrati iba tie, ktore maju uz platny
	 * datum zaciatku)
	 */
	public static final int PUBLISH_NEXT = 4;


	/**
	 * getDocPerex vrati iba dokumenty, co maju platny zaciatok a koniec
	 * neberie ohlad na to, ci je zadany text perexu
	 */
	public static final int PUBLISH_NO_PEREX_CHECK_NEW = 101;
	/**
	 * getDocPerex vrati iba dokumenty, co su stare
	 * neberie ohlad na to, ci je zadany text perexu
	 */
	public static final int PUBLISH_NO_PEREX_CHECK_OLD = 102;
	/**
	 * getDocPerex vrati vsetky dokumenty, bez ohladu na datum publikovania
	 * neberie ohlad na to, ci je zadany text perexu
	 */
	public static final int PUBLISH_NO_PEREX_CHECK_ALL = 103;

	/**
	 * getDocPerex vrati vsetky dokumenty v buducnosti (_NEW vrati iba tie, ktore maju uz platny
	 * datum zaciatku)
	 */
	public static final int PUBLISH_NO_PEREX_CHECK_NEXT = 104;

	/**
	 *  pole dokumentov cachovanych v pamati
	 */
	private Map&lt;Integer, DocDetails&gt; cachedDocs;

	//tabulka pre skupiny perexov (zrychleny pristup)
<span class="fc" id="L131">	private List&lt;PerexGroupBean&gt; perexGroups = null;</span>

	private final String serverName;

	//toto drzi hashtabulku url pre danu domenu, vzdy k tomu pristupujte cez getUrlsByUrlDomains(domena)
<span class="fc" id="L136">	private Map&lt;String, TObjectIntHashMap&lt;String&gt;&gt; urlsByUrlDomains = null;</span>
	/**
	 * tato hashtabulka ma zakladne info o kazdej stranke bez nutnosti pristupu do DB (docid, title, groupid, navbar)
	 * Kvoli pamatovej narocnosti je riesena ako {@link List}, nie ako {@link Map}.
	 *
	 * Index v Liste je doc_id a pouzity ako kluc na vyhladavanie
	 *
	 * Nemente na typ {@link List}! Potrebujeme niektore vlastnosti Listu, ako napr. ensureCapacity()
	 */
<span class="fc" id="L145">	private TIntObjectHashMap&lt;DocDetails&gt; basicAllDocsTable = null;</span>
<span class="fc" id="L146">	private TIntObjectHashMap&lt;List&lt;DocDetails&gt;&gt; basicAllDocsInGroupTable = null;</span>

	/**
	 * mapa master-slave stranok
	 */
<span class="fc" id="L151">	private Map&lt;Integer, Integer&gt; slavesMasterMappings = null;</span>
	/**
	 * mapa master-all_master_slaves stranok
	 */
<span class="fc" id="L155">	private Map&lt;Integer, Integer[]&gt; masterMappings = null;</span>


<span class="fc" id="L158">	private DocPublishService docPublishService = new DocPublishService();</span>

	/**
	 * Zakladna instancia objektu
	 * @return
	 */
	public static DocDB getInstance()
	{
<span class="fc" id="L166">		return(getInstance(false));</span>
	}

	/**
	 * Zakladna instancia objektu
	 * @param forceRefresh - true = refresh instancie
	 * @return
	 */
	public static DocDB getInstance(boolean forceRefresh)
	{
<span class="fc" id="L176">		return(getInstance(Constants.getServletContext(), forceRefresh, &quot;iwcm&quot;)); //NOSONAR</span>
	}

	/**
	 *  Gets the instance attribute of the DocDB class
	 *
	 *@param  servletContext2  Description of the Parameter
	 *@param  force_refresh   Description of the Parameter
	 *@param  serverName      Description of the Parameter
	 *@return                 The instance value
	 *@deprecated
	 */
	@Deprecated
	public static DocDB getInstance(javax.servlet.ServletContext servletContext2, boolean force_refresh, String serverName)
	{
<span class="fc" id="L191">		javax.servlet.ServletContext servletContext = Constants.getServletContext();</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">		if (!force_refresh)</span>
		{
<span class="fc" id="L194">			DocDB myDocDB = (DocDB) servletContext.getAttribute(Constants.A_DOC_DB);</span>
<span class="pc bpc" id="L195" title="1 of 4 branches missed.">			if (myDocDB != null &amp;&amp; myDocDB.urlsByUrlDomains!=null)</span>
			{
				//Set publishable service and call checkPublishable
<span class="fc" id="L198">				myDocDB.docPublishService.checkWebpagesToPublish(myDocDB);</span>
<span class="fc" id="L199">				return myDocDB;</span>
			}
		}
<span class="fc" id="L202">		synchronized (DocDB.class)</span>
		{
<span class="fc bfc" id="L204" title="All 2 branches covered.">			if (force_refresh)</span>
			{
<span class="fc" id="L206">				DocDB myDocDB = new DocDB(servletContext, serverName);</span>
				//save us to server space
<span class="fc" id="L208">				servletContext.setAttribute(Constants.A_DOC_DB, myDocDB);</span>

<span class="fc" id="L210">				myDocDB.docPublishService.checkWebpagesToPublish(myDocDB);</span>
<span class="fc" id="L211">				return myDocDB;</span>
			}
			else
			{
<span class="fc" id="L215">				DocDB myDocDB = (DocDB) servletContext.getAttribute(Constants.A_DOC_DB);</span>
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">				if (myDocDB == null)</span>
				{
<span class="fc" id="L218">					myDocDB = new DocDB(servletContext, serverName);</span>
					//	remove
					//servletContext.removeAttribute(Constants.A_DOC_DB);
					//save us to server space
<span class="fc" id="L222">					servletContext.setAttribute(Constants.A_DOC_DB, myDocDB);</span>

				}
<span class="fc" id="L225">				myDocDB.docPublishService.checkWebpagesToPublish(myDocDB);</span>
<span class="fc" id="L226">				return myDocDB;</span>
			}
		}
	}

	/**
	 * Constructor for the DocDB object
	 *
	 * @param servletContext
	 *           Description of the Parameter
	 * @param serverName
	 *           Description of the Parameter
	 */
	private DocDB(javax.servlet.ServletContext servletContext, String serverName)
<span class="fc" id="L240">	{</span>
<span class="fc" id="L241">		Logger.println(this,&quot;DocDB: constructor [&quot;+Constants.getInstallName()+&quot;]&quot;);</span>
<span class="fc" id="L242">		Logger.debugMemInfo();</span>

<span class="fc" id="L244">		this.serverName = serverName;</span>

		//Logger.println(this,&quot;DocDB: constructor&quot;);

<span class="fc" id="L248">		cachedDocs = new Hashtable&lt;&gt;();</span>

<span class="fc" id="L250">		forceRefreshMasterSlaveMappings();</span>

		try
		{
			//cache documents
<span class="fc" id="L255">			getDoc(-1, -1);</span>
		}
<span class="nc" id="L257">		catch (Exception ex)</span>
		{
<span class="nc" id="L259">			Logger.error(DocDB.class, ex);</span>
<span class="fc" id="L260">		}</span>


<span class="fc" id="L263">		loadUrls();</span>

<span class="fc" id="L265">		ClusterDB.addRefresh(DocDB.class);</span>

<span class="fc" id="L267">		Logger.debug(this,&quot;DocDB: constructor [&quot;+Constants.getInstallName()+&quot;] done&quot;);</span>
<span class="fc" id="L268">		Logger.debugMemInfo();</span>
<span class="fc" id="L269">	}</span>

	/**
	 * Vrati ci moze byt dokument zobrazeny
	 * @param docId
	 * @return true/false podla toho ci moze byt dokument zobrazeny podla datumov publikovania
	 */
	public boolean canBeShown(int docId)
	{
<span class="nc bnc" id="L278" title="All 2 branches missed.">		if(docId &lt; 0)</span>
		{
<span class="nc" id="L280">			return false;</span>
		}

<span class="nc" id="L283">		DocDetails doc = getDoc(docId);</span>
<span class="nc" id="L284">		return canBeShown(doc);</span>
	}

	public boolean canBeShown(DocDetails doc)
	{
<span class="nc bnc" id="L289" title="All 4 branches missed.">		if(doc == null || doc.getDocId() &lt; 1)</span>
		{
<span class="nc" id="L291">			return false;</span>
		}

<span class="nc" id="L294">		long start = doc.getPublishStart();</span>
<span class="nc" id="L295">		long end = doc.getPublishEnd();</span>
<span class="nc" id="L296">		long rightNow = Tools.getNow();</span>

<span class="nc bnc" id="L298" title="All 8 branches missed.">		return (start &lt;= 0 || start &lt;= rightNow) &amp;&amp; (end &lt;= 0 || end &gt;= rightNow);</span>
	}

	/**
	 * nacitanie stranok na publikovanie
	 */
	public void readPagesToPublic()
	{
<span class="fc" id="L306">		docPublishService.refreshPagesToPublish();</span>
<span class="fc" id="L307">	}</span>

	/**
	 * @deprecated
	 */
	@Deprecated
	public int getVirtualPathDocId(String virtualPath)
	{
		//nevieme domenu
<span class="fc" id="L316">		return getVirtualPathDocId(virtualPath, &quot;&quot;);</span>
	}

	/**
	 * Ziska docId stranky so zadanym URL a zadanou domenou
	 * @param virtualPath
	 * @param domain
	 * @return
	 */
	public int getVirtualPathDocId(String virtualPath, String domain)
	{
		//disallow webpages URL starts with /admin
<span class="fc bfc" id="L328" title="All 2 branches covered.">		if (virtualPath.startsWith(&quot;/admin&quot;)) return -1;</span>

<span class="pc bpc" id="L330" title="1 of 2 branches missed.">		if (virtualPath.startsWith(&quot;/css&quot;)||</span>
<span class="fc bfc" id="L331" title="All 2 branches covered.">			virtualPath.startsWith(&quot;/images&quot;)||</span>
<span class="fc bfc" id="L332" title="All 2 branches covered.">			virtualPath.startsWith(&quot;/files&quot;) ||</span>
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">			virtualPath.startsWith(&quot;/jscripts&quot;))</span>
		{
<span class="pc bpc" id="L335" title="1 of 4 branches missed.">			if (virtualPath.endsWith(&quot;.html&quot;) || virtualPath.endsWith(&quot;/&quot;)) {</span>
				//allow to create webpage in this folder with .html or / extension
			} else {
<span class="fc" id="L338">				return -1;</span>
			}
		}

<span class="pc bpc" id="L342" title="1 of 4 branches missed.">		if (Tools.isEmpty(domain) || Constants.getBoolean(&quot;multiDomainEnabled&quot;)==false) domain = &quot;default&quot;;</span>
<span class="fc" id="L343">		TObjectIntHashMap&lt;String&gt; urlsByUrl = getUrlsByUrlDomains(domain, false);</span>
		//Logger.debug(DocDB.class, &quot;getVirtualPathDocId: domain=&quot;+domain+&quot; hashSize=&quot;+urlsByUrl.size());
<span class="fc" id="L345">		return getVirtualPathDocId(virtualPath, urlsByUrl);</span>
	}

	/**
	 * Vrati docId pre zadanu virtualnu cestu, alebo -1, ak zadana cesta nie je zadana
	 * @param virtualPath
	 * @return
	 */
	public int getVirtualPathDocId(String virtualPath, TObjectIntHashMap&lt;String&gt; urlsByUrl)
	{
<span class="pc bpc" id="L355" title="1 of 2 branches missed.">		if (urlsByUrl!=null)</span>
		{
<span class="fc" id="L357">			virtualPath = normalizeVirtualPath(virtualPath);</span>

<span class="fc" id="L359">			int docId = urlsByUrl.get(virtualPath);</span>
<span class="fc bfc" id="L360" title="All 2 branches covered.">			if (docId!=0)</span>
			{
<span class="fc" id="L362">				return docId;</span>
			}

<span class="fc bfc" id="L365" title="All 4 branches covered.">			if (virtualPath.endsWith(&quot;.gif&quot;) || virtualPath.endsWith(&quot;.jpg&quot;) ||</span>
<span class="fc bfc" id="L366" title="All 4 branches covered.">					virtualPath.endsWith(&quot;.css&quot;) || virtualPath.endsWith(&quot;.js&quot;))</span>
			{
<span class="fc" id="L368">				return(-1);</span>
			}

			//skus najst /adr1/adr2/* cestu k adresaru
			try
			{
				//Logger.println(this,&quot;testing: &quot;+virtualPath+&quot;*&quot;);
<span class="fc" id="L375">				int i = urlsByUrl.get(virtualPath+&quot;*&quot;);</span>
<span class="pc bpc" id="L376" title="1 of 2 branches missed.">				if (i!=0)</span>
				{
<span class="nc" id="L378">					return i;</span>
				}

<span class="fc" id="L381">				int index = 1;</span>
<span class="fc" id="L382">				int failsafe = 1;</span>
<span class="pc bpc" id="L383" title="1 of 4 branches missed.">				while (failsafe &lt; 200 &amp;&amp; index &gt; 0)</span>
				{
<span class="fc" id="L385">					index = virtualPath.lastIndexOf('/');</span>
<span class="fc bfc" id="L386" title="All 2 branches covered.">					if (index &gt; 0)</span>
					{
<span class="fc" id="L388">						virtualPath = virtualPath.substring(0, index);</span>
						//Logger.println(this,&quot;testing: &quot;+virtualPath+&quot;*&quot;);
<span class="fc" id="L390">						i = urlsByUrl.get(virtualPath+&quot;*/&quot;);</span>
<span class="pc bpc" id="L391" title="1 of 2 branches missed.">						if (i!=0)</span>
						{
<span class="nc" id="L393">							return i;</span>
						}
<span class="fc" id="L395">						i = urlsByUrl.get(virtualPath+&quot;/*/&quot;);</span>
<span class="fc bfc" id="L396" title="All 2 branches covered.">						if (i!=0)</span>
						{
<span class="fc" id="L398">							return i;</span>
						}
<span class="fc" id="L400">						i = urlsByUrl.get(virtualPath+&quot;*&quot;);</span>
<span class="pc bpc" id="L401" title="1 of 2 branches missed.">						if (i!=0)</span>
						{
<span class="nc" id="L403">							return i;</span>
						}
<span class="fc" id="L405">						i = urlsByUrl.get(virtualPath+&quot;/*&quot;);</span>
<span class="pc bpc" id="L406" title="1 of 2 branches missed.">						if (i!=0)</span>
						{
<span class="nc" id="L408">							return i;</span>
						}

					}
<span class="fc" id="L412">					failsafe++;</span>
				}

			}
<span class="nc" id="L416">			catch (Exception e)</span>
			{
<span class="nc" id="L418">				Logger.error(DocDB.class, e);</span>
<span class="fc" id="L419">			}</span>
		}
<span class="fc" id="L421">		return(-1);</span>
	}

	/**
	 * Znormalizuje cestu, napr. odstrani koncove lomitko (napr /produkty/ -&gt; /produkty),
	 * prida zaciatocne lomitko (ak nie je)
	 * @param virtualPath
	 * @return
	 */
	@SuppressWarnings(&quot;java:S1075&quot;)
	public static String normalizeVirtualPath(String virtualPath)
	{
<span class="fc bfc" id="L433" title="All 2 branches covered.">		if (Tools.isEmpty(virtualPath)) return &quot;&quot;;</span>

		/*if (virtualPath.endsWith(&quot;/&quot;))
		{
			virtualPath = virtualPath.substring(0, virtualPath.length()-1);
		}*/
<span class="fc bfc" id="L439" title="All 6 branches covered.">		if (virtualPath.endsWith(&quot;/&quot;)==false &amp;&amp; virtualPath.lastIndexOf('/')!=-1 &amp;&amp; virtualPath.lastIndexOf('/')&gt;=virtualPath.lastIndexOf('.'))</span>
		{
<span class="fc" id="L441">			virtualPath = virtualPath + &quot;/&quot;;</span>
		}
<span class="fc bfc" id="L443" title="All 2 branches covered.">		if (virtualPath.startsWith(&quot;/&quot;)==false)</span>
		{
<span class="fc" id="L445">			virtualPath = &quot;/&quot; + virtualPath;</span>
		}
<span class="pc bpc" id="L447" title="1 of 2 branches missed.">		if (virtualPath.contains(&quot;//&quot;)) virtualPath = Tools.replace(virtualPath, &quot;//&quot;, &quot;/&quot;);</span>
		//Logger.println(this,&quot;vp=&quot;+virtualPath);
<span class="fc" id="L449">		return(virtualPath);</span>
	}


	/**
	 *  Vrati web stranku
	 *
	 *@param  docId  ID stranky
	 *@return         The doc value
	 */
	public DocDetails getDoc(int docId)
	{
<span class="fc bfc" id="L461" title="All 2 branches covered.">		if (docId &lt; 1) return null;</span>

<span class="fc" id="L463">		return (getDoc(docId, -1));</span>
	}

	/**
	 *  vrati web stranku
	 *
	 *@param  doc_id      id stranky
	 *@param  history_id  id historie (doc_id musi byt -1)
	 *@return             The doc value
	 */
	public DocDetails getDoc(int doc_id, int history_id)
	{
<span class="fc" id="L475">		return getDoc(doc_id, history_id, true);</span>
	}

	/**
	 * Hodnotu useCache=false pouzivame v pripade ked vysledny docDetails modifikujeme
	 * ak je totiz nastavena premenna cacheDocDetailsNewerThanDays na true docDetails sa cachuje
	 * podobne ak ma nastaveny atribut cache
	 * @param doc_id
	 * @param history_id
	 * @param useCache
	 * @return
	 */
	public DocDetails getDoc(int doc_id, int history_id, boolean useCache)
	{
<span class="fc" id="L489">		boolean dbConnectionOK = false;</span>

<span class="fc" id="L491">		String sql = &quot;&quot;;</span>

<span class="fc" id="L493">		Connection db_conn = null;</span>
<span class="fc" id="L494">		PreparedStatement ps = null;</span>
<span class="fc" id="L495">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L498">			DocDetails doc = null;</span>

<span class="fc bfc" id="L500" title="All 2 branches covered.">			if (history_id &lt; 0)</span>
			{
<span class="fc bfc" id="L502" title="All 2 branches covered.">				if (doc_id == -1)</span>
				{
					//oracle: sql = &quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, d.* FROM documents d, users u WHERE (d.author_id(+)=u.user_id  AND cacheable=&quot;+DB.getBooleanSql(true)+&quot;)&quot;;
<span class="fc" id="L505">					sql = &quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, u.photo, &quot;+DocDB.getDocumentFields()+&quot; FROM documents d LEFT JOIN  users u ON d.author_id=u.user_id WHERE cacheable=&quot;+DB.getBooleanSql(true);</span>
<span class="pc bpc" id="L506" title="1 of 2 branches missed.">					if (Constants.DB_TYPE == Constants.DB_ORACLE)</span>
					{
<span class="nc" id="L508">						sql = &quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, u.photo, &quot;+DocDB.getDocumentFields()+&quot; FROM documents d,  users u WHERE d.author_id=u.user_id(+) AND cacheable=&quot;+DB.getBooleanSql(true);</span>
					}
<span class="fc" id="L510">					cachedDocs = new Hashtable&lt;&gt;();</span>
				}
				else
				{
					//try to find document in cache
<span class="pc bpc" id="L515" title="1 of 4 branches missed.">					if (useCache &amp;&amp; cachedDocs!=null)</span>
					{
<span class="fc" id="L517">						doc = cachedDocs.get(Integer.valueOf(doc_id));</span>
<span class="fc bfc" id="L518" title="All 2 branches covered.">						if (doc!=null)</span>
						{
<span class="fc" id="L520">							return (doc);</span>
						}
					}
<span class="fc" id="L523">					sql = &quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, u.photo, &quot;+DocDB.getDocumentFields()+&quot; FROM documents d LEFT JOIN  users u ON d.author_id=u.user_id WHERE doc_id= ?&quot;;</span>
<span class="pc bpc" id="L524" title="1 of 2 branches missed.">					if (Constants.DB_TYPE == Constants.DB_ORACLE)</span>
					{
<span class="nc" id="L526">						sql = &quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, u.photo, &quot;+DocDB.getDocumentFields()+&quot; FROM documents d,  users u WHERE d.author_id=u.user_id(+) AND doc_id= ?&quot;;</span>
					}
				}
			}
			else
			{
<span class="fc" id="L532">				sql = &quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, u.photo, h.* FROM documents_history h LEFT JOIN  users u ON h.author_id=u.user_id WHERE history_id= ?&quot;;</span>
<span class="pc bpc" id="L533" title="1 of 2 branches missed.">				if (Constants.DB_TYPE == Constants.DB_ORACLE)</span>
				{
<span class="nc" id="L535">					sql = &quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, u.photo, h.* FROM documents_history h,  users u WHERE h.author_id=u.user_id(+) AND history_id= ?&quot;;</span>
				}
<span class="fc" id="L537">				doc_id = 0;</span>
			}

<span class="pc bpc" id="L540" title="5 of 6 branches missed.">			if (Constants.getBoolean(&quot;docAuthorLazyLoad&quot;) &amp;&amp; history_id &lt; 0 &amp;&amp; doc_id != -1)</span>
<span class="nc" id="L541">				sql = &quot;SELECT &quot;+DocDB.getDocumentFields()+&quot; FROM documents d WHERE doc_id= ?&quot;;</span>
<span class="pc bpc" id="L542" title="3 of 4 branches missed.">			if (Constants.getBoolean(&quot;docAuthorLazyLoad&quot;) &amp;&amp; history_id &gt;= 0)</span>
<span class="nc" id="L543">				sql = &quot;SELECT * FROM documents_history h WHERE history_id = ?&quot;;</span>
<span class="pc bpc" id="L544" title="5 of 6 branches missed.">			if (Constants.getBoolean(&quot;docAuthorLazyLoad&quot;) &amp;&amp; history_id &lt; 0 &amp;&amp; doc_id == -1)</span>
<span class="nc" id="L545">				sql = &quot;SELECT &quot;+DocDB.getDocumentFields()+&quot; FROM documents d WHERE cacheable=&quot;+DB.getBooleanSql(true);</span>

<span class="fc" id="L547">			db_conn = DBPool.getConnectionReadUncommited();</span>
<span class="fc" id="L548">			ps = db_conn.prepareStatement(sql);</span>
<span class="fc bfc" id="L549" title="All 2 branches covered.">			if (history_id &gt;= 0)</span>
<span class="fc" id="L550">				ps.setInt(1, history_id);</span>
<span class="fc bfc" id="L551" title="All 4 branches covered.">			if (doc_id != -1 &amp;&amp; history_id &lt; 0)</span>
<span class="fc" id="L552">				ps.setInt(1, doc_id);</span>
			//ps.setInt(1, user.getUserId());
			//Logger.println(this,&quot;sql=&quot;+sql);
<span class="fc" id="L555">			rs = ps.executeQuery();</span>

<span class="fc" id="L557">			dbConnectionOK = true;</span>

<span class="fc bfc" id="L559" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="pc bpc" id="L561" title="1 of 2 branches missed.">				if (Constants.getBoolean(&quot;docAuthorLazyLoad&quot;))</span>
<span class="nc" id="L562">					doc = getDocDetails(rs, false, true);</span>
				else
<span class="fc" id="L564">					doc = getDocDetails(rs, false);</span>

<span class="fc bfc" id="L566" title="All 2 branches covered.">				if (history_id &gt; 0)</span>
				{
<span class="fc" id="L568">					doc.setHistoryApprovedBy(rs.getInt(&quot;approved_by&quot;));</span>
<span class="fc" id="L569">					doc.setHistoryDisapprovedBy(rs.getInt(&quot;disapproved_by&quot;));</span>
<span class="fc" id="L570">					doc.setHistoryActual(rs.getBoolean(&quot;actual&quot;));</span>
				}

<span class="fc bfc" id="L573" title="All 2 branches covered.">				if (history_id&gt;-1)</span>
<span class="fc" id="L574">					doc.setPublicable(rs.getBoolean(&quot;publicable&quot;));//lubbis</span>


<span class="pc bpc" id="L577" title="3 of 4 branches missed.">				if (doc_id == -1 &amp;&amp; history_id == -1)</span>
				{
<span class="nc" id="L579">					cachedDocs.put(Integer.valueOf(doc_id), doc);</span>
				}
				else
				{
<span class="fc" id="L583">					int cacheNewerDays = Constants.getInt(&quot;cacheDocDetailsNewerThanDays&quot;);</span>
<span class="pc bpc" id="L584" title="1 of 4 branches missed.">					if (useCache &amp;&amp; cacheNewerDays&gt;0)</span>
					{
<span class="nc" id="L586">						Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L587">						cal.add(Calendar.DATE, -cacheNewerDays);</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">						if (doc.getDateCreated()&gt;cal.getTimeInMillis())</span>
						{
<span class="nc" id="L590">							Logger.debug(DocDB.class, &quot;Caching web page: &quot;+doc.getDocId()+&quot; date=&quot;+doc.getDateCreatedString());</span>
<span class="nc" id="L591">							cachedDocs.put(Integer.valueOf(doc_id), doc);</span>
						}
					}
<span class="fc" id="L594">					rs.close();</span>
<span class="fc" id="L595">					ps.close();</span>
<span class="fc" id="L596">					db_conn.close();</span>

<span class="fc" id="L598">					rs = null;</span>
<span class="fc" id="L599">					ps = null;</span>
<span class="fc" id="L600">					db_conn = null;</span>

<span class="fc" id="L602">					return (doc);</span>
				}

			}
<span class="fc" id="L606">			rs.close();</span>
<span class="fc" id="L607">			ps.close();</span>
<span class="fc" id="L608">			db_conn.close();</span>

<span class="fc" id="L610">			rs = null;</span>
<span class="fc" id="L611">			ps = null;</span>
<span class="fc" id="L612">			db_conn = null;</span>
		}
<span class="nc" id="L614">		catch (Exception ex)</span>
		{
<span class="nc" id="L616">			Logger.error(DocDB.class, ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L622" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L623">					rs.close();</span>
<span class="pc bpc" id="L624" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L625">					ps.close();</span>
<span class="pc bpc" id="L626" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L627">					db_conn.close();</span>
			}
<span class="nc" id="L629">			catch (Exception ex2)</span>
			{
<span class="nc" id="L631">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L632">			}</span>
		}

		//toto reportujeme aby sme v showdocaction mohli vypisat chybu
<span class="pc bpc" id="L636" title="1 of 2 branches missed.">		if (dbConnectionOK==false) throw new NullPointerException();</span>

<span class="fc" id="L638">		return (null);</span>
	}

	/**
	 * Vrati web stranku na zaklade nazvu, ak je zadane groupId tak v danom adresari
	 * @param title
	 * @param groupId
	 * @return
	 */
	public DocDetails getDocByTitle(String title, int groupId)
	{
<span class="fc" id="L649">		DocDetails doc = null;</span>

<span class="fc" id="L651">		Connection db_conn = null;</span>
<span class="fc" id="L652">		PreparedStatement ps = null;</span>
<span class="fc" id="L653">		ResultSet rs = null;</span>
		try
		{

<span class="fc" id="L657">			StringBuilder sql = new StringBuilder(&quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, u.photo, d.* FROM documents d LEFT JOIN users u ON d.author_id=u.user_id WHERE d.title=?&quot;);</span>
<span class="pc bpc" id="L658" title="1 of 2 branches missed.">			if (Constants.DB_TYPE == Constants.DB_ORACLE)</span>
			{
<span class="nc" id="L660">				sql = new StringBuilder(&quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, u.photo, d.* FROM documents d, users u WHERE d.author_id=u.user_id(+) AND d.title=?&quot;);</span>
			}
<span class="pc bpc" id="L662" title="1 of 2 branches missed.">			if (groupId &gt; 0) sql.append(&quot; AND d.group_id=?&quot;);</span>

<span class="fc" id="L664">			db_conn = DBPool.getConnectionReadUncommited();</span>
<span class="fc" id="L665">			ps = db_conn.prepareStatement(sql.toString());</span>
<span class="fc" id="L666">			ps.setString(1, title);</span>
<span class="pc bpc" id="L667" title="1 of 2 branches missed.">			if (groupId &gt; 0) ps.setInt(2, groupId);</span>
<span class="fc" id="L668">			rs = ps.executeQuery();</span>
<span class="fc bfc" id="L669" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="fc" id="L671">				doc = new DocDetails();</span>
<span class="fc" id="L672">				getDocDetails(rs, doc, false, false);</span>
			}
<span class="fc" id="L674">			rs.close();</span>
<span class="fc" id="L675">			ps.close();</span>
<span class="fc" id="L676">			db_conn.close();</span>
<span class="fc" id="L677">			rs = null;</span>
<span class="fc" id="L678">			ps = null;</span>
<span class="fc" id="L679">			db_conn = null;</span>
		}
<span class="nc" id="L681">		catch (Exception ex)</span>
		{
<span class="nc" id="L683">			Logger.error(DocDB.class, ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L689" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L690">					rs.close();</span>
<span class="pc bpc" id="L691" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L692">					ps.close();</span>
<span class="pc bpc" id="L693" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L694">					db_conn.close();</span>
			}
<span class="nc" id="L696">			catch (Exception ex2)</span>
			{
<span class="nc" id="L698">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L699">			}</span>
		}

<span class="fc" id="L702">		return doc;</span>
	}

	/**
	 *  Vrati stranky v zadanom adresari
	 *
	 *@param  group_id  Description of the Parameter
	 *@return           The docByGroup value
	 */
	public List&lt;DocDetails&gt; getDocByGroup(int group_id)
	{
<span class="fc" id="L713">		return (getDocByGroup(group_id, ORDER_TITLE, true, -1, -1, false));</span>
	}

	/**
	 *  vrati stranky v zadanom adresari
	 *
	 *@param  groupId    id skupiny
	 *@param  orderType  sposob usporiadania
	 *@param  asc        smer usporiadania, ak true vzostupne
	 *@param  start      poradove cislo zaciatku (strankovanie)
	 *@param  end        poradove cislo konca (strankovanie)
	 *@param  no_data    ak je true nevracia sa obsah stlpca data
	 *@return            List s dokumentami v skupine groupId
	 */
	public List&lt;DocDetails&gt; getDocByGroup(int groupId, int orderType, boolean asc, int start, int end, boolean no_data)
	{
<span class="fc" id="L729">		return getDocByGroup(groupId, orderType, asc, start, end, no_data, true);</span>
	}

	/**
	 *  vrati stranky v zadanom adresari
	 *
	 *@param  groupId    id skupiny
	 *@param  orderType  sposob usporiadania
	 *@param  asc        smer usporiadania, ak true vzostupne
	 *@param  start      poradove cislo zaciatku (strankovanie)
	 *@param  end        poradove cislo konca (strankovanie)
	 *@param  no_data    ak je true nevracia sa obsah stlpca data
	 *@param  onlyAvailable ak je true vrati len stranky s availabe=1
	 *@return            List s dokumentami v skupine groupId
	 */
	public List&lt;DocDetails&gt; getDocByGroup(int groupId, int orderType, boolean asc, int start, int end, boolean no_data, boolean onlyAvailable)
	{
<span class="fc" id="L746">		List&lt;DocDetails&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L747">		java.sql.Connection db_conn = null;</span>
<span class="fc" id="L748">		java.sql.PreparedStatement ps = null;</span>
<span class="fc" id="L749">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L752">			db_conn = DBPool.getConnectionReadUncommited();</span>

			//read user permissions for every org struct

<span class="fc" id="L756">			StringBuilder order = new StringBuilder(&quot;d.title&quot;);</span>
<span class="pc bpc" id="L757" title="1 of 2 branches missed.">			if (orderType == ORDER_DATE)</span>
			{
<span class="nc" id="L759">				order = new StringBuilder(&quot;publish_start&quot;);</span>
			}
<span class="fc bfc" id="L761" title="All 2 branches covered.">			else if (orderType == ORDER_ID)</span>
			{
<span class="fc" id="L763">				order = new StringBuilder(&quot;doc_id&quot;);</span>
			}
<span class="pc bpc" id="L765" title="1 of 2 branches missed.">			else if (orderType == ORDER_PRIORITY)</span>
			{
<span class="nc" id="L767">				order = new StringBuilder(&quot;sort_priority&quot;);</span>
			}
<span class="pc bpc" id="L769" title="1 of 2 branches missed.">			else if (orderType == ORDER_PLACE)</span>
			{
<span class="nc" id="L771">				order = new StringBuilder(&quot;perex_place&quot;);</span>
			}
<span class="pc bpc" id="L773" title="1 of 2 branches missed.">			else if (orderType == ORDER_EVENT_DATE)</span>
			{
<span class="nc" id="L775">				order = new StringBuilder(&quot;event_date&quot;);</span>
			}
<span class="pc bpc" id="L777" title="1 of 2 branches missed.">			else if (orderType == ORDER_SAVE_DATE)</span>
			{
<span class="nc" id="L779">				order = new StringBuilder(&quot;date_created&quot;);</span>
			}
<span class="pc bpc" id="L781" title="1 of 2 branches missed.">			else if (orderType == ORDER_RATING)</span>
			{
<span class="nc" id="L783">				order = new StringBuilder(&quot;forum_count&quot;);</span>
			}

<span class="pc bpc" id="L786" title="1 of 2 branches missed.">			if (asc)</span>
			{
<span class="fc" id="L788">				order.append(&quot; ASC&quot;);</span>
			}
			else
			{
<span class="nc" id="L792">				order.append(&quot; DESC&quot;);</span>
			}

<span class="pc bpc" id="L795" title="2 of 4 branches missed.">			if (orderType == ORDER_PLACE || orderType == ORDER_PRIORITY)</span>
			{
				//ak sme podla mesta, ostatne sortni podla title
<span class="nc" id="L798">				order.append(&quot;, d.title ASC&quot;);</span>
			}

			String sql;
			DocDetails doc;

<span class="fc" id="L804">			String onlyAvailableAppend = &quot;&quot;;</span>
<span class="fc bfc" id="L805" title="All 2 branches covered.">			if (onlyAvailable) {</span>
<span class="fc" id="L806">				onlyAvailableAppend = &quot;available=&quot;+DB.getBooleanSql(true)+&quot; AND&quot;;</span>
<span class="pc bpc" id="L807" title="1 of 2 branches missed.">				if (Constants.DB_TYPE == Constants.DB_ORACLE) onlyAvailableAppend = &quot;AND available=&quot;+DB.getBooleanSql(true)+&quot; AND&quot;;</span>
			}

<span class="pc bpc" id="L810" title="1 of 2 branches missed.">			if (Constants.DB_TYPE == Constants.DB_MSSQL)</span>
			{
<span class="nc" id="L812">				String top = &quot;&quot;;</span>
<span class="nc bnc" id="L813" title="All 2 branches missed.">				if (end &gt; 0)</span>
				{
<span class="nc" id="L815">					top = &quot;TOP &quot; + end;</span>
				}
<span class="nc" id="L817">				sql = &quot;SELECT &quot; + top + &quot; u.title as u_title, u.first_name, u.last_name, u.email, u.photo, d.* FROM documents d LEFT JOIN  users u ON d.author_id=u.user_id WHERE &quot;+onlyAvailableAppend+&quot; group_id=&quot; + groupId + &quot; ORDER BY &quot; + order.toString();</span>
<span class="nc" id="L818">			}</span>
<span class="pc bpc" id="L819" title="1 of 2 branches missed.">			else if (Constants.DB_TYPE == Constants.DB_ORACLE)</span>
			{
				//POZOR: ORA tu chyba limit!
<span class="nc" id="L822">				sql = &quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, u.photo, d.* FROM documents d,  users u WHERE d.author_id=u.user_id(+) &quot;+onlyAvailableAppend+&quot; group_id=&quot; + groupId + &quot; ORDER BY &quot; + order.toString();</span>
			}
			else
			{
<span class="fc" id="L826">				String limit = &quot;&quot;;</span>
<span class="pc bpc" id="L827" title="3 of 4 branches missed.">				if (start &gt;= 0 &amp;&amp; end &gt; 0)</span>
				{
<span class="nc" id="L829">					int rows = end - start;</span>
<span class="nc" id="L830">					limit = &quot; LIMIT &quot; + start + &quot;, &quot; + rows;</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">					if (Constants.DB_TYPE==Constants.DB_PGSQL) limit = &quot; OFFSET &quot; + start + &quot; LIMIT &quot; + rows;</span>
<span class="nc" id="L832">					start = 0;</span>
<span class="nc" id="L833">					end = rows + 1;</span>
					//?? je treba +1 ??
				}
<span class="fc" id="L836">				sql = &quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, u.photo, d.* FROM documents d LEFT JOIN  users u ON d.author_id=u.user_id WHERE &quot;+onlyAvailableAppend+&quot; group_id=&quot; + groupId + &quot; ORDER BY &quot; + order + limit;</span>
			}
<span class="fc" id="L838">			ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L839">			rs = ps.executeQuery();</span>

<span class="fc" id="L841">			int counter = 0;</span>
<span class="pc bpc" id="L842" title="1 of 2 branches missed.">			if (start &gt; 0)</span>
			{
				int i;
<span class="nc bnc" id="L845" title="All 2 branches missed.">				for (i=0; i&lt;start; i++)</span>
				{
					//jTDS nevie rs.absolute...
					//rs.absolute(index);
<span class="nc" id="L849">					rs.next();</span>
				}
<span class="nc" id="L851">				counter = start;</span>
			}
<span class="fc bfc" id="L853" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="pc bpc" id="L855" title="3 of 4 branches missed.">				if (end &gt; 0 &amp;&amp; counter &gt; end)</span>
				{
<span class="nc" id="L857">					counter++;</span>
<span class="nc" id="L858">					break;</span>
				}

<span class="fc" id="L861">				counter++;</span>

<span class="fc" id="L863">				doc = getDocDetails(rs, no_data);</span>

<span class="fc" id="L865">				ret.add(doc);</span>
			}
<span class="fc" id="L867">			rs.close();</span>
<span class="fc" id="L868">			ps.close();</span>
<span class="fc" id="L869">			db_conn.close();</span>
<span class="fc" id="L870">			db_conn = null;</span>
<span class="fc" id="L871">			ps = null;</span>
<span class="fc" id="L872">			rs = null;</span>
		}
<span class="nc" id="L874">		catch (Exception ex){Logger.error(DocDB.class, ex);}</span>
		finally{
			try{
<span class="pc bpc" id="L877" title="1 of 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="pc bpc" id="L878" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L879" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L880">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="fc" id="L882">		return (ret);</span>
	}

    /**
     *  Vrati stranky v zadanom adresari
     *
     *@param  domainId  Description of the Parameter
     *@return           The docByDomainId value
     */
    public List&lt;DocDetails&gt; getDocByDomainId(int domainId)
    {
<span class="nc" id="L893">        return (getDocByDomainId(domainId, ORDER_TITLE, true, -1, -1, false));</span>
    }

    /**
     *  vrati stranky v zadanom adresari
     *
     *@param  domainId    id skupiny
     *@param  orderType  sposob usporiadania
     *@param  asc        smer usporiadania, ak true vzostupne
     *@param  start      poradove cislo zaciatku (strankovanie)
     *@param  end        poradove cislo konca (strankovanie)
     *@param  no_data    ak je true nevracia sa obsah stlpca data
     *@return            List s dokumentami v skupine groupId
     */
    public List&lt;DocDetails&gt; getDocByDomainId(int domainId, int orderType, boolean asc, int start, int end, boolean no_data)
    {
<span class="nc" id="L909">        List&lt;DocDetails&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L910">        java.sql.Connection db_conn = null;</span>
<span class="nc" id="L911">        java.sql.PreparedStatement ps = null;</span>
<span class="nc" id="L912">        ResultSet rs = null;</span>
        try
        {
<span class="nc" id="L915">            db_conn = DBPool.getConnectionReadUncommited();</span>

            //read user permissions for every org struct

<span class="nc" id="L919">            StringBuilder order = new StringBuilder(&quot;d.title&quot;);</span>
<span class="nc bnc" id="L920" title="All 2 branches missed.">            if (orderType == ORDER_DATE)</span>
            {
<span class="nc" id="L922">                order = new StringBuilder(&quot;publish_start&quot;);</span>
            }
<span class="nc bnc" id="L924" title="All 2 branches missed.">            else if (orderType == ORDER_ID)</span>
            {
<span class="nc" id="L926">                order = new StringBuilder(&quot;doc_id&quot;);</span>
            }
<span class="nc bnc" id="L928" title="All 2 branches missed.">            else if (orderType == ORDER_PRIORITY)</span>
            {
<span class="nc" id="L930">                order = new StringBuilder(&quot;sort_priority&quot;);</span>
            }
<span class="nc bnc" id="L932" title="All 2 branches missed.">            else if (orderType == ORDER_PLACE)</span>
            {
<span class="nc" id="L934">                order = new StringBuilder(&quot;perex_place&quot;);</span>
            }
<span class="nc bnc" id="L936" title="All 2 branches missed.">            else if (orderType == ORDER_EVENT_DATE)</span>
            {
<span class="nc" id="L938">                order = new StringBuilder(&quot;event_date&quot;);</span>
            }
<span class="nc bnc" id="L940" title="All 2 branches missed.">            else if (orderType == ORDER_SAVE_DATE)</span>
            {
<span class="nc" id="L942">                order = new StringBuilder(&quot;date_created&quot;);</span>
            }
<span class="nc bnc" id="L944" title="All 2 branches missed.">            else if (orderType == ORDER_RATING)</span>
            {
<span class="nc" id="L946">                order = new StringBuilder(&quot;forum_count&quot;);</span>
            }

<span class="nc bnc" id="L949" title="All 2 branches missed.">            if (asc)</span>
            {
<span class="nc" id="L951">                order.append(&quot; ASC&quot;);</span>
            }
            else
            {
<span class="nc" id="L955">                order.append(&quot; DESC&quot;);</span>
            }

<span class="nc bnc" id="L958" title="All 4 branches missed.">            if (orderType == ORDER_PLACE || orderType == ORDER_PRIORITY)</span>
            {
                //ak sme podla mesta, ostatne sortni podla title
<span class="nc" id="L961">                order.append(&quot;, d.title ASC&quot;);</span>
            }

            String sql;
            DocDetails doc;

<span class="nc bnc" id="L967" title="All 2 branches missed.">            if (Constants.DB_TYPE == Constants.DB_MSSQL)</span>
            {
<span class="nc" id="L969">                String top = &quot;&quot;;</span>
<span class="nc bnc" id="L970" title="All 2 branches missed.">                if (end &gt; 0)</span>
                {
<span class="nc" id="L972">                    top = &quot;TOP &quot; + end;</span>
                }
<span class="nc" id="L974">                sql = &quot;SELECT &quot; + top + &quot; u.title as u_title, u.first_name, u.last_name, u.email, u.photo, d.* FROM documents d LEFT JOIN  users u ON d.author_id=u.user_id WHERE available=&quot;+DB.getBooleanSql(true)+&quot; AND root_group_l1=&quot; + domainId + &quot; ORDER BY &quot; + order.toString();</span>
<span class="nc" id="L975">            }</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">            else if (Constants.DB_TYPE == Constants.DB_ORACLE)</span>
            {
                //POZOR: ORA tu chyba limit!
<span class="nc" id="L979">                sql = &quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, u.photo, d.* FROM documents d,  users u WHERE d.author_id=u.user_id(+) AND available=&quot;+DB.getBooleanSql(true)+&quot; AND root_group_l1=&quot; + domainId + &quot; ORDER BY &quot; + order.toString();</span>
            }
            else
            {
<span class="nc" id="L983">                String limit = &quot;&quot;;</span>
<span class="nc bnc" id="L984" title="All 4 branches missed.">                if (start &gt;= 0 &amp;&amp; end &gt; 0)</span>
                {
<span class="nc" id="L986">                    int rows = end - start;</span>
<span class="nc" id="L987">                    limit = &quot; LIMIT &quot; + start + &quot;, &quot; + rows;</span>
<span class="nc bnc" id="L988" title="All 2 branches missed.">					if (Constants.DB_TYPE==Constants.DB_PGSQL) limit = &quot; OFFSET &quot; + start + &quot; LIMIT &quot; + rows;</span>

<span class="nc" id="L990">					start = 0;</span>
<span class="nc" id="L991">                    end = rows + 1;</span>
                    //?? je treba +1 ??
                }
<span class="nc" id="L994">                sql = &quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, u.photo, d.* FROM documents d LEFT JOIN  users u ON d.author_id=u.user_id WHERE available=&quot;+DB.getBooleanSql(true)+&quot; AND root_group_l1=&quot; + domainId + &quot; ORDER BY &quot; + order + limit;</span>
            }
<span class="nc" id="L996">            ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L997">            rs = ps.executeQuery();</span>

<span class="nc" id="L999">            int counter = 0;</span>
<span class="nc bnc" id="L1000" title="All 2 branches missed.">            if (start &gt; 0)</span>
            {
                int i;
<span class="nc bnc" id="L1003" title="All 2 branches missed.">                for (i=0; i&lt;start; i++)</span>
                {
                    //jTDS nevie rs.absolute...
                    //rs.absolute(index);
<span class="nc" id="L1007">                    rs.next();</span>
                }
<span class="nc" id="L1009">                counter = start;</span>
            }
<span class="nc bnc" id="L1011" title="All 2 branches missed.">            while (rs.next())</span>
            {
<span class="nc bnc" id="L1013" title="All 4 branches missed.">                if (end &gt; 0 &amp;&amp; counter &gt; end)</span>
                {
<span class="nc" id="L1015">                    counter++;</span>
<span class="nc" id="L1016">                    break;</span>
                }

<span class="nc" id="L1019">                counter++;</span>

<span class="nc" id="L1021">                doc = getDocDetails(rs, no_data);</span>

<span class="nc" id="L1023">                ret.add(doc);</span>
            }
<span class="nc" id="L1025">            rs.close();</span>
<span class="nc" id="L1026">            ps.close();</span>
<span class="nc" id="L1027">            db_conn.close();</span>
<span class="nc" id="L1028">            db_conn = null;</span>
<span class="nc" id="L1029">            ps = null;</span>
<span class="nc" id="L1030">            rs = null;</span>
        }
<span class="nc" id="L1032">        catch (Exception ex){Logger.error(DocDB.class, ex);}</span>
        finally{
            try{
<span class="nc bnc" id="L1035" title="All 2 branches missed.">                if (rs != null) rs.close();</span>
<span class="nc bnc" id="L1036" title="All 2 branches missed.">                if (ps != null) ps.close();</span>
<span class="nc bnc" id="L1037" title="All 2 branches missed.">                if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L1038">            }catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
        }
<span class="nc" id="L1040">        return (ret);</span>
    }

	/**
	 * Vrati stranky pre zadanu userGroupId, pouziva sa pre zistenie dostupnych emailov
	 * pre danu emailovu skupinu
	 * @param userGroupId
	 * @return
	 */
	public List&lt;DocDetails&gt; getDocByUserGroup(int userGroupId)
	{
<span class="nc" id="L1051">		List&lt;DocDetails&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1052">		java.sql.Connection db_conn = null;</span>
<span class="nc" id="L1053">		java.sql.PreparedStatement ps = null;</span>
<span class="nc" id="L1054">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L1057">			db_conn = DBPool.getConnectionReadUncommited();</span>

			//read user permissions for every org struct

			String sql;
			DocDetails doc;


<span class="nc" id="L1065">			sql = &quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, u.photo, &quot;+getDocumentFieldsNodata()+&quot; FROM documents d LEFT JOIN  users u ON d.author_id=u.user_id WHERE available=&quot;+DB.getBooleanSql(true)+&quot; AND password_protected LIKE '%&quot; + userGroupId + &quot;%' ORDER BY date_created DESC&quot;;</span>
<span class="nc" id="L1066">			ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L1067">			rs = ps.executeQuery();</span>

<span class="nc bnc" id="L1069" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L1071">				doc = getDocDetails(rs, true);</span>

				//ak to tam skutocne je, pridaj
<span class="nc bnc" id="L1074" title="All 2 branches missed.">				if ((&quot;,&quot;+doc.getPasswordProtected()+&quot;,&quot;).indexOf(&quot;,&quot;+userGroupId+&quot;,&quot;)!=-1)</span>
				{
<span class="nc" id="L1076">					ret.add(doc);</span>
				}
			}
<span class="nc" id="L1079">			rs.close();</span>
<span class="nc" id="L1080">			ps.close();</span>
<span class="nc" id="L1081">			db_conn.close();</span>
<span class="nc" id="L1082">			db_conn = null;</span>
<span class="nc" id="L1083">			ps = null;</span>
<span class="nc" id="L1084">			rs = null;</span>
		}
<span class="nc" id="L1086">		catch (Exception ex){Logger.error(DocDB.class, ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L1089" title="All 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="nc bnc" id="L1090" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L1091" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L1092">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="nc" id="L1094">		return (ret);</span>
	}

	/**
	 * Pripravi zoznam stranok, co maju perex v adresaroch groupIds a potrebne id sablony, vratane
	 * strankovania a handlovania parametrov
	 *
	 * @param groupIds
	 * @param orderType
	 * @param asc
	 * @param publishType
	 * @param pageSize
	 * @param arrayListDocName
	 * @param arrayListPagerName
	 * @param request
	 * @param tempId
	 * @return
	 */
	public int getDocPerex(String groupIds, int orderType, boolean asc, int publishType, int pageSize, String arrayListDocName, String arrayListPagerName, HttpServletRequest request, final int tempId)
	{
		SelectionFilter&lt;DocDetails&gt; filter;
		//ak nemame zadane tempId alebo je zaporne, tak vracaj vsetky dokumenty
<span class="pc bpc" id="L1116" title="1 of 2 branches missed.">		if (tempId &lt;= 0)</span>
<span class="fc" id="L1117">			filter = new SelectionFilter&lt;DocDetails&gt;(){</span>
			@Override
<span class="fc" id="L1119">			public boolean fullfilsConditions(DocDetails candidate){return true;}};</span>
			//inak musi byt id sablony dokumentu zhodne s parametrom
			else
<span class="nc" id="L1122">				filter = new SelectionFilter&lt;DocDetails&gt;(){</span>
				@Override
				public boolean fullfilsConditions(DocDetails candidate){
<span class="nc bnc" id="L1125" title="All 2 branches missed.">					return candidate.getTempId() == tempId;</span>
				}};

<span class="fc" id="L1128">				return getDocPerex(groupIds, orderType, asc, publishType, pageSize, arrayListDocName, arrayListPagerName, request, filter);</span>
	}

	public int getDocumentsByIds(List&lt;Integer&gt; docIds, String arrayListDocName, String arrayListPagerName, HttpServletRequest request)
	{
<span class="nc" id="L1133">		String groupIds = &quot;&quot;;</span>
<span class="nc" id="L1134">		int orderType = DocDB.ORDER_ID;</span>
<span class="nc" id="L1135">		boolean asc = false;</span>
<span class="nc" id="L1136">		int publishType = DocDB.PUBLISH_NO_PEREX_CHECK_NEW;</span>
<span class="nc" id="L1137">		int pageSize = docIds.size();</span>

<span class="nc bnc" id="L1139" title="All 2 branches missed.">		String docIdsStr = docIds.size() &gt; 0 ? Tools.join(docIds) : &quot;null&quot;;</span>
<span class="nc" id="L1140">		String whereSql = &quot; AND doc_id IN ( &quot; + docIdsStr + &quot;) &quot;;</span>
<span class="nc" id="L1141">		String oldWhereSql = (String) request.getAttribute(&quot;whereSql&quot;);</span>
<span class="nc bnc" id="L1142" title="All 2 branches missed.">		request.setAttribute(&quot;whereSql&quot;, (Tools.isEmpty(oldWhereSql) ? &quot;&quot; : oldWhereSql) + whereSql);</span>

		SelectionFilter&lt;DocDetails&gt; filter;
<span class="nc" id="L1145">		filter = new SelectionFilter&lt;DocDetails&gt;(){</span>
		@Override
<span class="nc" id="L1147">		public boolean fullfilsConditions(DocDetails candidate){return true;}};</span>

<span class="nc" id="L1149">		return getDocPerex(groupIds, orderType, asc, publishType, pageSize, arrayListDocName, arrayListPagerName, request, filter);</span>
	}

	/**
	 * Pripravi zoznam stranok pre news komponentu
	 * @param groupIds - id adresara
	 * @param orderType
	 * @param asc
	 * @param publishType - typ publikovania (konstanty PUBLISH_)
	 * @param pageSize - velkost stranky
	 * @param arrayListDocName	- pod tymto nazvom nastavi do requestu zoznam stranok
	 * @param arrayListPagerName	- pod tymto nazvom nastavi do requestu strankovanie
	 * @param request
	 * @param filter
	 * @return
	 */
	public int getDocPerex(String groupIds, int orderType, boolean asc, int publishType, int pageSize, String arrayListDocName, String arrayListPagerName, HttpServletRequest request, SelectionFilter&lt;DocDetails&gt; filter)
	{

<span class="fc" id="L1168">		request.removeAttribute(arrayListPagerName);</span>
<span class="fc" id="L1169">		request.removeAttribute(arrayListDocName);</span>

		//strankovanie
<span class="fc" id="L1172">		int page = 1;</span>

<span class="fc" id="L1174">		PageParams pageParams = new PageParams(request);</span>

<span class="pc bpc" id="L1176" title="1 of 2 branches missed.">		if (request.getAttribute(&quot;DocDB.pageParams&quot;) != null)</span>
<span class="nc" id="L1177">			pageParams = (PageParams)request.getAttribute(&quot;DocDB.pageParams&quot;);</span>

<span class="fc" id="L1179">		String pageParamName = pageParams.getValue(&quot;pageParamName&quot;, &quot;page&quot;);</span>
		try
		{
<span class="pc bpc" id="L1182" title="1 of 2 branches missed.">			if (request.getParameter(pageParamName) != null)</span>
			{
<span class="nc" id="L1184">				page = Integer.parseInt(request.getParameter(pageParamName));</span>
			}
		}
<span class="nc" id="L1187">		catch (Exception ex)</span>
		{
			//
<span class="fc" id="L1190">		}</span>

		//ak sa nema strankovat, ignoruj parameter
<span class="fc" id="L1193">		boolean paging = pageParams.getBooleanValue(&quot;paging&quot;, false);</span>
		try
		{
<span class="pc bpc" id="L1196" title="1 of 2 branches missed.">			if (request.getParameter(&quot;paging&quot;) != null)</span>
			{
<span class="nc" id="L1198">				paging = Boolean.parseBoolean(request.getParameter(&quot;paging&quot;));</span>
			}
		}
<span class="nc" id="L1201">		catch (Exception ex)</span>
		{
			//
<span class="fc" id="L1204">		}</span>
<span class="pc bpc" id="L1205" title="1 of 2 branches missed.">		if (paging == false)</span>
		{
<span class="fc" id="L1207">			page = 1;</span>
		}

<span class="fc" id="L1210">		String p_order = request.getParameter(&quot;order&quot;);</span>
<span class="pc bpc" id="L1211" title="1 of 2 branches missed.">		if (p_order != null)</span>
		{
<span class="nc bnc" id="L1213" title="All 2 branches missed.">			if (p_order.compareTo(&quot;date&quot;) == 0)</span>
			{
<span class="nc" id="L1215">				orderType = DocDB.ORDER_DATE;</span>
			}
<span class="nc bnc" id="L1217" title="All 2 branches missed.">			else if (p_order.compareTo(&quot;id&quot;) == 0)</span>
			{
<span class="nc" id="L1219">				orderType = DocDB.ORDER_ID;</span>
			}
<span class="nc bnc" id="L1221" title="All 2 branches missed.">			else if (p_order.compareTo(&quot;priority&quot;) == 0)</span>
			{
<span class="nc" id="L1223">				orderType = DocDB.ORDER_PRIORITY;</span>
			}
<span class="nc bnc" id="L1225" title="All 2 branches missed.">			else if (p_order.compareTo(&quot;title&quot;) == 0)</span>
			{
<span class="nc" id="L1227">				orderType = DocDB.ORDER_TITLE;</span>
			}
<span class="nc bnc" id="L1229" title="All 2 branches missed.">			else if (p_order.compareTo(&quot;place&quot;) == 0)</span>
			{
<span class="nc" id="L1231">				orderType = DocDB.ORDER_PLACE;</span>
			}
<span class="nc bnc" id="L1233" title="All 2 branches missed.">			else if (p_order.compareTo(&quot;save_date&quot;) == 0)</span>
			{
<span class="nc" id="L1235">				orderType = DocDB.ORDER_SAVE_DATE;</span>
			}
		}
<span class="pc bpc" id="L1238" title="3 of 4 branches missed.">		if (request.getParameter(&quot;desc&quot;) != null &amp;&amp; request.getParameter(&quot;desc&quot;).compareToIgnoreCase(&quot;yes&quot;)==0)</span>
		{
<span class="nc" id="L1240">			asc = false;</span>
		}
<span class="pc bpc" id="L1242" title="3 of 4 branches missed.">		if (request.getParameter(&quot;asc&quot;) != null &amp;&amp; request.getParameter(&quot;asc&quot;).compareToIgnoreCase(&quot;yes&quot;)==0)</span>
		{
<span class="nc" id="L1244">			asc = true;</span>
		}
<span class="fc" id="L1246">		String p_publish = request.getParameter(&quot;publish&quot;);</span>
<span class="pc bpc" id="L1247" title="1 of 2 branches missed.">		if (p_publish!=null)</span>
		{
<span class="nc bnc" id="L1249" title="All 2 branches missed.">			if (p_publish.compareToIgnoreCase(&quot;new&quot;)==0)</span>
			{
<span class="nc" id="L1251">				publishType = PUBLISH_NEW;</span>
			}
<span class="nc bnc" id="L1253" title="All 2 branches missed.">			else if (p_publish.compareToIgnoreCase(&quot;old&quot;)==0)</span>
			{
<span class="nc" id="L1255">				publishType = PUBLISH_OLD;</span>
			}
<span class="nc bnc" id="L1257" title="All 2 branches missed.">			else if (p_publish.compareToIgnoreCase(&quot;all&quot;)==0)</span>
			{
<span class="nc" id="L1259">				publishType = PUBLISH_ALL;</span>
			}
<span class="nc bnc" id="L1261" title="All 2 branches missed.">			else if (p_publish.compareToIgnoreCase(&quot;next&quot;)==0)</span>
			{
<span class="nc" id="L1263">				publishType = PUBLISH_NEXT;</span>
			}
<span class="nc bnc" id="L1265" title="All 2 branches missed.">			else if (p_publish.compareToIgnoreCase(&quot;npcnew&quot;)==0)</span>
			{
<span class="nc" id="L1267">				publishType = PUBLISH_NO_PEREX_CHECK_NEW;</span>
			}
<span class="nc bnc" id="L1269" title="All 2 branches missed.">			else if (p_publish.compareToIgnoreCase(&quot;npcold&quot;)==0)</span>
			{
<span class="nc" id="L1271">				publishType = PUBLISH_NO_PEREX_CHECK_OLD;</span>
			}
<span class="nc bnc" id="L1273" title="All 2 branches missed.">			else if (p_publish.compareToIgnoreCase(&quot;npcall&quot;)==0)</span>
			{
<span class="nc" id="L1275">				publishType = PUBLISH_NO_PEREX_CHECK_ALL;</span>
			}
<span class="nc bnc" id="L1277" title="All 2 branches missed.">			else if (p_publish.compareToIgnoreCase(&quot;npcnext&quot;)==0)</span>
			{
<span class="nc" id="L1279">				publishType = PUBLISH_NO_PEREX_CHECK_NEXT;</span>
			}

		}
		try
		{
<span class="pc bpc" id="L1285" title="1 of 2 branches missed.">			if (request.getParameter(&quot;psize&quot;) != null)</span>
			{
<span class="nc" id="L1287">				pageSize = Integer.parseInt(request.getParameter(&quot;psize&quot;));</span>
			}
		}
<span class="nc" id="L1290">		catch (Exception ex)</span>
		{
			//
<span class="fc" id="L1293">		}</span>

		//ziskaj zoznam dokumentov
<span class="fc" id="L1296">		int start = (page - 1) * pageSize;</span>
<span class="fc" id="L1297">		int end = start + pageSize;</span>

		//Logger.println(this,&quot;start=&quot;+start+&quot; end=&quot;+end+&quot; p_size=&quot;+p_size);

<span class="fc" id="L1301">		long now = -1;</span>
<span class="fc" id="L1302">		String perexNow = request.getParameter(&quot;perexNow&quot;);</span>
<span class="pc bpc" id="L1303" title="1 of 2 branches missed.">		if (perexNow==null)</span>
		{
<span class="fc" id="L1305">			perexNow = (String)request.getAttribute(&quot;perexNow&quot;);</span>
		}

<span class="pc bpc" id="L1308" title="1 of 2 branches missed.">		if (perexNow!=null)</span>
		{
			try
			{
<span class="nc" id="L1312">				now = Long.parseLong(perexNow);</span>
			}
<span class="nc" id="L1314">			catch (Exception ex)</span>
			{
				//
<span class="nc" id="L1317">			}</span>
		}

<span class="pc bpc" id="L1320" title="1 of 2 branches missed.">		StringBuilder whereSql = request.getAttribute(&quot;whereSql&quot;) == null ? new StringBuilder() : new StringBuilder(Tools.replace(request.getAttribute(&quot;whereSql&quot;).toString(), &quot; doc_id&quot;, &quot; d.doc_id&quot;));</span>
<span class="fc" id="L1321">		String orderSql = (String)request.getAttribute(&quot;orderSql&quot;);</span>
<span class="fc" id="L1322">		request.removeAttribute(&quot;orderSql&quot;);</span>

<span class="fc" id="L1324">		String perexGroup = null;</span>
<span class="pc bpc" id="L1325" title="1 of 2 branches missed.">		if (request.getAttribute(&quot;perexGroup&quot;)!=null)</span>
		{
			//najskor to skus ziskat z requestu
<span class="fc" id="L1328">			perexGroup = (String)request.getAttribute(&quot;perexGroup&quot;);</span>
		}
		else
		{
			try
			{
				//skus ziskat perexGroup podla sablony
				//je to tam vo formate &lt;perexGroup name=&quot;meno&quot; label=&quot;nazov skupiny&quot;&gt;
<span class="nc" id="L1336">				String afterBodyData = (String)request.getAttribute(&quot;after_body&quot;);</span>
<span class="nc bnc" id="L1337" title="All 2 branches missed.">				if (afterBodyData!=null)</span>
				{
<span class="nc" id="L1339">					String perexGroupLabel = null;</span>
					//format: &lt;perexGroup name=&quot;ajurvedska&quot; label=&quot;Ajurvedska strava&quot;&gt;
<span class="nc" id="L1341">					int startIndex = afterBodyData.indexOf(&quot;&lt;perexGroup name=\&quot;&quot;);</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">					if (startIndex!=-1)</span>
					{
						//najdi prve uvodzovky
<span class="nc" id="L1345">						startIndex = afterBodyData.indexOf('\&quot;', startIndex);</span>
						//najdi konciace uvodzovky
<span class="nc" id="L1347">						int endIndex = afterBodyData.indexOf(&quot;\&quot;&quot;, startIndex+1);</span>
<span class="nc bnc" id="L1348" title="All 2 branches missed.">						if (endIndex&gt;startIndex)</span>
						{
<span class="nc" id="L1350">							perexGroup = afterBodyData.substring(startIndex+1, endIndex);</span>

<span class="nc" id="L1352">							perexGroupLabel = perexGroup;</span>
							//najdi uvodzovky pre label=&quot;
<span class="nc" id="L1354">							startIndex = afterBodyData.indexOf(&quot;\&quot;&quot;, endIndex+1);</span>
<span class="nc" id="L1355">							endIndex = afterBodyData.indexOf(&quot;\&quot;&quot;, startIndex+1);</span>
<span class="nc bnc" id="L1356" title="All 2 branches missed.">							if (endIndex&gt;startIndex)</span>
							{
<span class="nc" id="L1358">								perexGroupLabel = afterBodyData.substring(startIndex+1, endIndex);</span>
							}
<span class="nc" id="L1360">							request.setAttribute(&quot;perex_group_label&quot;, perexGroupLabel);</span>
						}
					}
				}
			}
<span class="nc" id="L1365">			catch (Exception ex)</span>
			{
<span class="nc" id="L1367">				Logger.error(DocDB.class, ex);</span>
<span class="nc" id="L1368">			}</span>
		}

<span class="pc bpc" id="L1371" title="1 of 2 branches missed.">		if (perexGroup!=null)</span>
		{
<span class="pc bpc" id="L1373" title="1 of 2 branches missed.">			if(Constants.getBoolean(&quot;perexGroupUseJoin&quot;))</span>
			{
<span class="nc" id="L1375">				StringBuilder groupNamesIn = new StringBuilder();</span>
<span class="nc" id="L1376">				String[] groupNames = Tools.getTokens(perexGroup, &quot;,&quot;, true);</span>
				String gn;
<span class="nc" id="L1378">				int pid = -1;</span>
<span class="nc" id="L1379">				PerexGroupBean pgb = null;</span>
<span class="nc bnc" id="L1380" title="All 2 branches missed.">				for (int j=0; j&lt;groupNames.length; j++)</span>
				{
<span class="nc" id="L1382">					pid = -1;</span>
<span class="nc" id="L1383">					gn = groupNames[j];</span>
<span class="nc bnc" id="L1384" title="All 2 branches missed.">					if(Tools.getIntValue(gn,0) &gt; 0) pid = Tools.getIntValue(gn,0);</span>
					else
					{
<span class="nc" id="L1387">						pgb = getPerexGroup(-1, gn);</span>
<span class="nc bnc" id="L1388" title="All 2 branches missed.">						if (pgb != null) pid = pgb.getPerexGroupId();</span>
					}

<span class="nc bnc" id="L1391" title="All 2 branches missed.">					if(pid &gt; 0) groupNamesIn.append(gn).append(&quot;,&quot;);</span>
				}

<span class="nc bnc" id="L1394" title="All 4 branches missed.">				if(Tools.isNotEmpty(groupNamesIn)) whereSql.append(&quot; AND p.perex_group_id IN (&quot;+(groupNamesIn.toString().endsWith(&quot;,&quot;) ? groupNamesIn.substring(0, groupNamesIn.length()-1) : groupNamesIn)+&quot;) &quot;);</span>
<span class="nc" id="L1395">			}</span>
			else
			{
<span class="fc" id="L1398">				whereSql.append(&quot; AND ( &quot;);</span>
<span class="fc" id="L1399">				StringTokenizer st = new StringTokenizer(perexGroup, &quot;,&quot;);</span>
<span class="fc" id="L1400">				int counter = 0;</span>

<span class="fc" id="L1402">				String perexGroupMode = &quot; OR &quot;;</span>
<span class="pc bpc" id="L1403" title="1 of 2 branches missed.">				if (&quot;and&quot;.equals(request.getAttribute(&quot;perexGroupMode&quot;))) perexGroupMode = &quot; AND &quot;;</span>
<span class="fc" id="L1404">				request.removeAttribute(&quot;perexGroupMode&quot;);</span>

<span class="pc bpc" id="L1406" title="1 of 2 branches missed.">				while (st.hasMoreTokens())</span>
				{
<span class="nc" id="L1408">					String token = st.nextToken().trim();</span>
<span class="nc" id="L1409">					int pid = Tools.getIntValue(token, -1);</span>
<span class="nc bnc" id="L1410" title="All 2 branches missed.">					if (pid &lt; 1)</span>
					{
<span class="nc" id="L1412">						PerexGroupBean pgb = getPerexGroup(-1, token);</span>
<span class="nc bnc" id="L1413" title="All 2 branches missed.">						if (pgb != null) pid = pgb.getPerexGroupId();</span>
					}

<span class="nc bnc" id="L1416" title="All 2 branches missed.">					if (pid &lt; 1) continue;</span>

<span class="nc bnc" id="L1418" title="All 2 branches missed.">					if (counter &gt; 0)</span>
					{
<span class="nc" id="L1420">						whereSql.append(perexGroupMode);</span>
					}
<span class="nc" id="L1422">					whereSql.append(&quot; perex_group LIKE '%,&quot;).append(pid).append(&quot;,%' &quot;);</span>
<span class="nc" id="L1423">					counter ++;</span>
<span class="nc" id="L1424">				}</span>
<span class="pc bpc" id="L1425" title="1 of 2 branches missed.">				if (whereSql.toString().endsWith(&quot;AND ( &quot;))</span>
				{
<span class="fc" id="L1427">					whereSql = new StringBuilder(whereSql.substring(0,whereSql.length()-6).trim()+&quot; &quot;);</span>
				}
				else
				{
<span class="nc" id="L1431">					whereSql.append(&quot; ) &quot;);</span>
				}
			}
		}

<span class="fc" id="L1436">		Identity user = UsersDB.getCurrentUser(request);</span>
<span class="fc" id="L1437">		boolean searchAlsoProtectedPages = pageParams.getBooleanValue(&quot;searchAlsoProtectedPages&quot;, false);</span>
		try{
<span class="pc bpc" id="L1439" title="1 of 2 branches missed.">			if(request.getParameter(&quot;searchAlsoProtectedPages&quot;)!=null)</span>
			{
<span class="nc" id="L1441">				searchAlsoProtectedPages = Tools.getBooleanValue(request.getParameter(&quot;searchAlsoProtectedPages&quot;), false);</span>
			}
		}
<span class="nc" id="L1444">		catch(Exception e)</span>
		{
			//
<span class="fc" id="L1447">		}</span>
<span class="pc bpc" id="L1448" title="3 of 4 branches missed.">		if (user == null &amp;&amp; searchAlsoProtectedPages==false)</span>
		{
<span class="nc" id="L1450">			whereSql.append(&quot; AND (password_protected IS null OR password_protected='') &quot;);</span>
		}
<span class="pc bpc" id="L1452" title="2 of 4 branches missed.">		else if (user != null &amp;&amp; searchAlsoProtectedPages==false)</span>
		{
			//skupiny pre web stranky
<span class="fc" id="L1455">			StringBuilder sqlProtected = new StringBuilder(&quot; AND (password_protected IS null OR password_protected=''&quot;);</span>
<span class="fc" id="L1456">			StringTokenizer stu = new StringTokenizer(user.getUserGroupsIds(), &quot;,&quot;);</span>
<span class="fc bfc" id="L1457" title="All 2 branches covered.">			while (stu.hasMoreTokens())</span>
			{
<span class="fc" id="L1459">				int groupId = Tools.getIntValue(stu.nextToken(), -1);</span>
<span class="pc bpc" id="L1460" title="1 of 2 branches missed.">				if (groupId &gt; 0)</span>
				{
<span class="fc" id="L1462">					sqlProtected.append(&quot; OR password_protected='&quot;).append(groupId).append(&quot;' OR password_protected LIKE '&quot;)</span>
<span class="fc" id="L1463">					.append(groupId).append(&quot;,%' OR password_protected LIKE '%,&quot;).append(groupId).append(&quot;,%' OR password_protected LIKE '%,&quot;).append(groupId).append('\'');</span>
				}
<span class="fc" id="L1465">			}</span>
<span class="fc" id="L1466">			sqlProtected.append(&quot;) &quot;);</span>
<span class="fc" id="L1467">			whereSql.append(sqlProtected.toString());</span>
		}

<span class="fc" id="L1470">		boolean expandGroupIds = pageParams.getBooleanValue(&quot;expandGroupIds&quot;, true);</span>
<span class="pc bpc" id="L1471" title="1 of 2 branches missed.">		if(!expandGroupIds)</span>
<span class="nc" id="L1472">			expandGroupIds = &quot;true&quot;.equals(request.getAttribute(&quot;expandGroupIds&quot;));</span>
<span class="fc" id="L1473">		String expandedGroupIds = null;</span>
<span class="pc bpc" id="L1474" title="1 of 2 branches missed.">		if (expandGroupIds)</span>
		{
<span class="fc" id="L1476">			StringBuilder searchGroups = null;</span>
<span class="fc" id="L1477">			StringTokenizer st = new StringTokenizer(groupIds, &quot;,+; &quot;);</span>
<span class="fc" id="L1478">			GroupsDB groupsDB = GroupsDB.getInstance();</span>
			List&lt;GroupDetails&gt; searchGroupsArray;
			int searchRootGroupId;
<span class="fc bfc" id="L1481" title="All 2 branches covered.">			while (st.hasMoreTokens())</span>
			{
				try
				{
<span class="fc" id="L1485">					String sid = st.nextToken();</span>
<span class="fc" id="L1486">					sid = sid.replace('(', ' ');</span>
<span class="fc" id="L1487">					sid = sid.replace(')', ')');</span>
<span class="fc" id="L1488">					sid = sid.trim();</span>
<span class="fc" id="L1489">					searchRootGroupId = Integer.parseInt(sid);</span>
				}
<span class="nc" id="L1491">				catch (Exception ex)</span>
				{
<span class="nc" id="L1493">					Logger.error(DocDB.class, &quot;groupIds=&quot;+groupIds);</span>
<span class="nc" id="L1494">					Logger.error(DocDB.class, ex);</span>
<span class="nc" id="L1495">					continue;</span>
<span class="fc" id="L1496">				}</span>
				//najdi child grupy
<span class="fc" id="L1498">				searchGroupsArray = groupsDB.getGroupsTree(searchRootGroupId, true, false);</span>
<span class="fc bfc" id="L1499" title="All 2 branches covered.">				for (GroupDetails group : searchGroupsArray)</span>
				{
<span class="pc bpc" id="L1501" title="1 of 2 branches missed.">					if (group != null)</span>
					{
<span class="pc bpc" id="L1503" title="1 of 2 branches missed.">						if (searchGroups == null)</span>
						{
<span class="fc" id="L1505">							searchGroups = new StringBuilder(String.valueOf(group.getGroupId()));</span>
						}
						else
						{
<span class="nc" id="L1509">							searchGroups.append(',').append(group.getGroupId());</span>
						}
					}
<span class="fc" id="L1512">				}</span>
			}
<span class="pc bpc" id="L1514" title="1 of 2 branches missed.">			if (searchGroups!=null) expandedGroupIds = searchGroups.toString();</span>
		}

		//ak je TRUE, tak nenacitam data stlpec
<span class="fc" id="L1518">		boolean noData = pageParams.getBooleanValue(&quot;noData&quot;, false);</span>
		//ak je TRUE, tak chcem kontrolovat duplicitu pre multikategorie
<span class="fc" id="L1520">		boolean checkDuplicity = false;</span>
<span class="pc bpc" id="L1521" title="1 of 2 branches missed.">		if(request.getAttribute(&quot;checkDuplicity&quot;) != null) checkDuplicity = &quot;true&quot;.equals(request.getAttribute(&quot;checkDuplicity&quot;));</span>
<span class="fc" id="L1522">		else checkDuplicity = pageParams.getBooleanValue(&quot;checkDuplicity&quot;, false);</span>
<span class="fc" id="L1523">		StringBuilder docIdsNotIn = new StringBuilder(&quot;&quot;);</span>
<span class="pc bpc" id="L1524" title="1 of 2 branches missed.">		if(checkDuplicity)</span>
		{
<span class="nc" id="L1526">			List&lt;Integer&gt; slavesMasterForDoc = null;</span>

<span class="nc bnc" id="L1528" title="All 2 branches missed.">			if(getSlavesMasterMappings() != null)</span>
			{
<span class="nc bnc" id="L1530" title="All 2 branches missed.">				String[] groupIdsTokens = Tools.getTokens(getOnlyNumbersIn((expandedGroupIds != null ? expandedGroupIds : groupIds).replace('+', ','),true), &quot;,&quot;);</span>
<span class="nc" id="L1531">				List&lt;DocDetails&gt; docsInGroups = new ArrayList&lt;&gt;(); //vsetky stranky v zadanych adresaroch</span>
<span class="nc bnc" id="L1532" title="All 2 branches missed.">				for(String g : groupIdsTokens)</span>
<span class="nc" id="L1533">					docsInGroups.addAll(getBasicDocDetailsByGroup(Tools.getIntValue(g,0), 0));</span>

<span class="nc bnc" id="L1535" title="All 2 branches missed.">				if(docsInGroups.size() &gt; 0)</span>
				{
<span class="nc" id="L1537">					HashMap&lt;Integer, Boolean&gt; docsInGroupsHm = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1538" title="All 2 branches missed.">					for(DocDetails dd : docsInGroups)</span>
<span class="nc" id="L1539">						docsInGroupsHm.put(Integer.valueOf(dd.getDocId()), Boolean.TRUE);</span>

<span class="nc bnc" id="L1541" title="All 2 branches missed.">					for (Entry&lt;Integer, Boolean&gt; entry : docsInGroupsHm.entrySet())</span>
					{
<span class="nc bnc" id="L1543" title="All 2 branches missed.">						if(entry.getValue() != Boolean.FALSE)</span>
						{
<span class="nc" id="L1545">							Integer docId = entry.getKey();</span>
							//ziskam zoznam docId, ktore su rovnake k danej stranke
<span class="nc" id="L1547">							slavesMasterForDoc = null;</span>

<span class="nc bnc" id="L1549" title="All 2 branches missed.">							if(slavesMasterForDoc == null)</span>
<span class="nc" id="L1550">								slavesMasterForDoc = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L1552">							Integer masterId = getSlavesMasterMappings().get(docId);</span>
<span class="nc bnc" id="L1553" title="All 2 branches missed.">							if(masterId != null)</span>
							{
								//ak sa master nachadza v zozname stranok, tak ponecham master miesto slave a vymazem vsetky slave stranky danej master stranky
								//v opacnom pripade vymazem vsetky ostatne slaves
<span class="nc bnc" id="L1557" title="All 4 branches missed.">								boolean containsMaster = docsInGroupsHm.get(masterId) != null &amp;&amp; docsInGroupsHm.get(masterId) == Boolean.TRUE;</span>
<span class="nc" id="L1558">								Integer[] slaves = getMasterMappings().get(masterId);</span>
<span class="nc bnc" id="L1559" title="All 2 branches missed.">								if(slaves != null)</span>
								{
<span class="nc bnc" id="L1561" title="All 2 branches missed.">									if(containsMaster) //aby preskocilo pri iteracii master</span>
<span class="nc" id="L1562">										docsInGroupsHm.put(masterId, Boolean.FALSE);</span>
<span class="nc bnc" id="L1563" title="All 2 branches missed.">									for(Integer slave : slaves)</span>
									{
<span class="nc bnc" id="L1565" title="All 6 branches missed.">										if(containsMaster || (!containsMaster &amp;&amp; slave.intValue() != docId.intValue()))</span>
<span class="nc" id="L1566">											slavesMasterForDoc.add(slave);</span>
									}
								}
<span class="nc" id="L1569">							}</span>
							else
							{
								//ak docId je master, tak pridam do duplicitnych vsetky jeho slaves
<span class="nc" id="L1573">								Integer[] slaves = getMasterMappings().get(docId);</span>
<span class="nc bnc" id="L1574" title="All 2 branches missed.">								if(slaves != null)</span>
								{
<span class="nc" id="L1576">									slavesMasterForDoc.addAll(Arrays.asList(slaves));</span>
								}
							}
							//odstranim ich zo zonamu stranok
<span class="nc bnc" id="L1580" title="All 4 branches missed.">							if(slavesMasterForDoc != null &amp;&amp; slavesMasterForDoc.size() &gt; 0)</span>
							{
<span class="nc bnc" id="L1582" title="All 2 branches missed.">								for(Integer sm: slavesMasterForDoc)</span>
								{
<span class="nc bnc" id="L1584" title="All 2 branches missed.">									if(docsInGroupsHm.get(sm) != null)</span>
									{
<span class="nc" id="L1586">										docsInGroupsHm.put(sm, Boolean.FALSE);</span>
<span class="nc" id="L1587">										docIdsNotIn.append(sm.intValue()).append(&quot;,&quot;);</span>
									}
<span class="nc" id="L1589">								}</span>
							}
						}
<span class="nc" id="L1592">					}</span>
				}
			}

<span class="nc bnc" id="L1596" title="All 2 branches missed.">			if(Tools.isNotEmpty(docIdsNotIn))</span>
<span class="nc" id="L1597">				docIdsNotIn = new StringBuilder(docIdsNotIn.toString().substring(0, docIdsNotIn.length()-1));</span>
		}

		//kvoli blogom aby prihlaseny blogger videl na stranke aj nepublikovane clanky
<span class="fc" id="L1601">		boolean onlyAvailable = true;</span>
<span class="pc bpc" id="L1602" title="1 of 2 branches missed.">		if (&quot;false&quot;.equals(request.getAttribute(&quot;perexOnlyAvailable&quot;)))</span>
		{
<span class="nc" id="L1604">			onlyAvailable = false;</span>
<span class="nc" id="L1605">			request.removeAttribute(&quot;perexOnlyAvailable&quot;);</span>
		}

		//pokial je zadany datum pre ktory sa maju novinky vypisat
<span class="pc bpc" id="L1609" title="1 of 2 branches missed.">		String datum = request.getParameter(&quot;datum&quot;) != null ? request.getParameter(&quot;datum&quot;) : null;</span>
<span class="pc bpc" id="L1610" title="1 of 2 branches missed.">		if (request.getAttribute(&quot;newsDatum&quot;)!=null)</span>
		{
			//aby bolo mozne mat v stranke viacero komponent ale len jedna bude filtrovana podla datumu
			//ostatnym nastavime atribut datum na znak -
<span class="nc" id="L1614">			datum = (String)request.getAttribute(&quot;newsDatum&quot;);</span>
<span class="nc bnc" id="L1615" title="All 2 branches missed.">			if (&quot;-&quot;.equals(datum)) datum = null;</span>
<span class="nc" id="L1616">			request.removeAttribute(&quot;newsDatum&quot;);</span>
		}

<span class="pc bpc" id="L1619" title="2 of 4 branches missed.">		if(expandedGroupIds != null &amp;&amp; expandGroupIds)</span>
		{
<span class="fc" id="L1621">			int rootGroupLevel = 1000;</span>
			//ak groupId je na vacsej urovni ako 3, pouzijeme expandedGroupIds
<span class="pc bpc" id="L1623" title="1 of 2 branches missed.">			int rootGroupId = Tools.isNotEmpty(groupIds) ? Tools.getIntValue(groupIds, 0) : 0;</span>
<span class="pc bpc" id="L1624" title="1 of 2 branches missed.">			if(rootGroupId &gt; 0) rootGroupLevel =  GroupsDB.getInstance().getPathList(Tools.getIntValue(groupIds,0)).size();</span>
<span class="pc bpc" id="L1625" title="2 of 4 branches missed.">			if(rootGroupLevel&lt;=0 || rootGroupLevel &gt; 3) groupIds = expandedGroupIds;</span>
		}

		//toto sa zda to iste ako predchadzajuce, nie je to ale tak kedze predchadzajuca vetva sa vykona len ked sa expandovalo
<span class="fc" id="L1629">		int rootGroupLevel = 1000;</span>
<span class="pc bpc" id="L1630" title="3 of 6 branches missed.">		if(groupIds != null &amp;&amp; expandGroupIds &amp;&amp; pageParams.getBooleanValue(&quot;useRootGroupLevel&quot;, true))</span>
		{
			//ak groupId je na vacsej urovni ako 3, pouzijeme expandedGroupIds
<span class="pc bpc" id="L1633" title="1 of 2 branches missed.">			int rootGroupId = Tools.isNotEmpty(groupIds) ? Tools.getIntValue(groupIds, 0) : 0;</span>
<span class="pc bpc" id="L1634" title="1 of 2 branches missed.">			if(rootGroupId &gt; 0) rootGroupLevel =  GroupsDB.getInstance().getPathList(Tools.getIntValue(groupIds,0)).size();</span>
		}

<span class="fc" id="L1637">		List&lt;DocDetails&gt; tempDocs = getDocPerex(groupIds, orderType, asc, start, end, publishType, now, whereSql.toString(), orderSql, noData, docIdsNotIn.toString(), onlyAvailable, datum, rootGroupLevel);</span>
<span class="fc" id="L1638">		List&lt;Object&gt; docs = new ArrayList&lt;&gt;();</span>
		//zistime, ci dokument vybrany z databazy splna podmienky dane filtrom
<span class="fc bfc" id="L1640" title="All 2 branches covered.">		for (DocDetails object : tempDocs) {</span>
<span class="pc bpc" id="L1641" title="2 of 4 branches missed.">			if ( filter == null || filter.fullfilsConditions(object) ) {</span>
<span class="fc" id="L1642">				docs.add(object);</span>
			}
<span class="fc" id="L1644">		}</span>


<span class="fc" id="L1647">		int total_docs = docs.size();</span>
		//vytvor pages
<span class="fc" id="L1649">		List&lt;LabelValueDetails&gt; pages = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1650">		request.removeAttribute(arrayListPagerName);</span>
<span class="pc bpc" id="L1651" title="1 of 2 branches missed.">		if (paging)</span>
		{
			//ziskaj celkovy pocet dokumentov
<span class="nc" id="L1654">			total_docs = getDocPerexCountInGroups(groupIds, publishType, whereSql.toString(), docIdsNotIn.toString(), onlyAvailable, datum, rootGroupLevel);</span>

			LabelValueDetails lv_page;
<span class="nc" id="L1657">			int p = 1;</span>
<span class="nc" id="L1658">			start = 0;</span>
<span class="nc" id="L1659">			int docId = Tools.getIntValue(request.getParameter(&quot;docid&quot;), -1);</span>
<span class="nc" id="L1660">			StringBuilder url = new StringBuilder(getDocLink(docId));</span>
<span class="nc" id="L1661">			Enumeration&lt;String&gt; e = request.getParameterNames();</span>
			String name;
			String value;
<span class="nc bnc" id="L1664" title="All 2 branches missed.">			while (e.hasMoreElements())</span>
			{
<span class="nc" id="L1666">				name = ResponseUtils.filter(e.nextElement());</span>
<span class="nc" id="L1667">				value = Tools.URLEncode(request.getParameter(name));</span>
				//znak _ je tam kvoli system parametrom ako _writePerfStat, aby sa nahodou nestalo, ze sa ulozi do cache
<span class="nc bnc" id="L1669" title="All 6 branches missed.">				if (&quot;docid&quot;.equals(name) || pageParamName.equals(name) || name.startsWith(&quot;_&quot;)) continue;</span>

<span class="nc bnc" id="L1671" title="All 2 branches missed.">				if (url.indexOf(&quot;?&quot;)==-1)</span>
				{
<span class="nc" id="L1673">					url.append('?').append(name).append('=').append(value);</span>
				}
				else
				{
<span class="nc" id="L1677">					url.append(&quot;&amp;amp;&quot;).append(name).append('=').append(value);</span>
				}
			}
<span class="nc" id="L1680">			boolean pagingNavigation = pageParams.getBooleanValue(&quot;pagingNavigation&quot;, false);</span>
<span class="nc bnc" id="L1681" title="All 2 branches missed.">			if (pageSize &gt; 0)</span>
			{
<span class="nc" id="L1683">				String mark = &quot;&amp;amp;&quot;;</span>
<span class="nc bnc" id="L1684" title="All 2 branches missed.">				if (url.indexOf(&quot;?&quot;)==-1)</span>
				{
<span class="nc" id="L1686">					mark = &quot;?&quot;;</span>
				}
<span class="nc bnc" id="L1688" title="All 2 branches missed.">				while (start &lt; total_docs)</span>
				{
<span class="nc bnc" id="L1690" title="All 2 branches missed.">					if (p == page)</span>
					{
<span class="nc bnc" id="L1692" title="All 2 branches missed.">						if(pagingNavigation)</span>
						{
							//prev
<span class="nc bnc" id="L1695" title="All 2 branches missed.">							if(p != 1)</span>
							{
<span class="nc" id="L1697">								request.setAttribute(&quot;prev&quot;, new LabelValueDetails(&quot;&amp;lt;&amp;lt;&amp;lt;&quot;, &quot;&lt;a href='&quot; + url + mark + pageParamName  + &quot;=&quot; + (p-1) + &quot;'&gt;&quot;));</span>
							}
							//next
<span class="nc bnc" id="L1700" title="All 2 branches missed.">							if(start+pageSize &lt; total_docs)</span>
							{
<span class="nc" id="L1702">								request.setAttribute(&quot;next&quot;,new LabelValueDetails(&quot;&amp;gt;&amp;gt;&amp;gt;&quot;, &quot;&lt;a href='&quot; + url + mark + pageParamName  + &quot;=&quot; + (p+1) + &quot;'&gt;&quot;));</span>
							}
						}
<span class="nc" id="L1705">						lv_page = new LabelValueDetails(Integer.toString(p), &quot;&quot;);</span>
					}
					else
					{

<span class="nc" id="L1710">						lv_page = new LabelValueDetails(Integer.toString(p), &quot;&lt;a href='&quot; + url + mark + pageParamName  + &quot;=&quot; + p + &quot;'&gt;&quot;);</span>
					}
<span class="nc" id="L1712">					pages.add(lv_page);</span>
<span class="nc" id="L1713">					p++;</span>
<span class="nc" id="L1714">					start = start + pageSize;</span>
				}
			}
<span class="nc bnc" id="L1717" title="All 2 branches missed.">			if (pages.size()&gt;1) request.setAttribute(arrayListPagerName, pages);</span>
		}

<span class="fc" id="L1720">		request.setAttribute(arrayListDocName, docs);</span>
<span class="fc" id="L1721">		return(total_docs);</span>
	}



	/**
	 * Pripravi zoznam stranok, co maju perex v adresaroch groupIds, vratane
	 * strankovania a handlovania parametrov
	 *
	 * odkazuje na /showdoc.do?docid=?
	 */
	public int getDocPerex(String groupIds, int orderType, boolean asc, int publishType, int pageSize, String arrayListDocName, String arrayListPagerName, HttpServletRequest request)
	{
<span class="fc" id="L1734">		return getDocPerex(groupIds, orderType, asc, publishType, pageSize, arrayListDocName, arrayListPagerName, request, -1);</span>
	}

	/**
	 * Vrati stranky, ktore maju zadany perex v adresaroch groupIds
	 */
	public List&lt;DocDetails&gt; getDocPerex(String groupIds, int orderType, boolean asc, int publishType)
	{
<span class="nc" id="L1742">		return(getDocPerex(groupIds, orderType, asc, 0, 0, publishType, Tools.getNow(), &quot;&quot;, null, false, null, true, null, -1));</span>
	}

	/**
	 * Vrati stranky, ktore maju zadany perex v adresaroch groupIds
	 * @param groupIds - zoznam id adresarov, napr. 1,2,4,8
	 * @param orderType - sposob usporiadania
	 * @param asc - ak true, vzostupne usporiadane
	 * @param startIndex - zaciatok (pre stramkovanie), alebo 0 ak vsetky
	 * @param endIndex - koniec (pre strankovanie), alebo 0 ak vsetky
	 * @param publishType - ake sa vyberu dokumenty (nove, stare, vsetky)
	 * @param now - timestamp casu pre ktory sa to generuje, ak je &lt;0, pouzije sa aktualny cas
	 * @param whereSql - SQL prikaz, ktory sa prida do WHERE
	 * @param noData - TRUE ak chceme nacitat vysledky BEZ stlpca data a data_asc
	 * @param docIdsNotIn - obsahuje duplicitne docId oddelene ciarkou, ktore sa maju z hladania vypustit
	 * @param datum - ak chcem zobrazit news pre konkretny den v tvare dd.MM.yyyy
	 * @return
	 */
	private List&lt;DocDetails&gt; getDocPerex(String groupIds, int orderType, boolean asc, int startIndex, int endIndex, int publishType, long now, String whereSql, String orderSql, boolean noData, String docIdsNotIn, boolean onlyAvailable, String datum, int rootGroupLevel)
	{
		//Logger.println(this,&quot;DocDB.getDocPerex now=&quot;+now+&quot; &quot;+(new java.util.Date(now)));
<span class="pc bpc" id="L1763" title="1 of 2 branches missed.">		if (whereSql==null) whereSql = &quot;&quot;;</span>
		//len pre istotu...
<span class="fc" id="L1765">		whereSql = whereSql.replace(';', ' ');</span>

<span class="pc bpc" id="L1767" title="1 of 2 branches missed.">		if(Tools.isNotEmpty(docIdsNotIn))</span>
<span class="nc" id="L1768">			whereSql += &quot; AND d.doc_id NOT IN (&quot;+docIdsNotIn+&quot;)&quot;;</span>

<span class="fc" id="L1770">		List&lt;DocDetails&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="pc bpc" id="L1772" title="1 of 2 branches missed.">		if (now &lt; 0)</span>
		{
<span class="fc" id="L1774">			now = (new java.util.Date()).getTime();</span>
		}

<span class="fc" id="L1777">		Connection db_conn = null;</span>
<span class="fc" id="L1778">		PreparedStatement ps = null;</span>
<span class="fc" id="L1779">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L1782">			db_conn = DBPool.getConnectionReadUncommited();</span>

<span class="fc" id="L1784">			boolean checkPerex = true;</span>
<span class="pc bpc" id="L1785" title="1 of 2 branches missed.">			if (publishType&gt;100)</span>
			{
				//nebudeme kontrolovat ci doc_html je null
<span class="fc" id="L1788">				checkPerex = false;</span>
<span class="fc" id="L1789">				publishType = publishType - 100;</span>
			}

<span class="fc" id="L1792">			StringBuilder order = new StringBuilder(&quot;d.title&quot;);</span>
<span class="pc bpc" id="L1793" title="1 of 2 branches missed.">			if (orderType == ORDER_DATE)</span>
			{
<span class="nc" id="L1795">				order = new StringBuilder(&quot;publish_start&quot;);</span>
			}
<span class="pc bpc" id="L1797" title="1 of 2 branches missed.">			else if (orderType == ORDER_ID)</span>
			{
<span class="nc" id="L1799">				order = new StringBuilder(&quot;doc_id&quot;);</span>
			}
<span class="pc bpc" id="L1801" title="1 of 2 branches missed.">			else if (orderType == ORDER_PRIORITY)</span>
			{
<span class="nc" id="L1803">				order = new StringBuilder(&quot;sort_priority&quot;);</span>
			}
<span class="pc bpc" id="L1805" title="1 of 2 branches missed.">			else if (orderType == ORDER_PLACE)</span>
			{
<span class="nc" id="L1807">				order = new StringBuilder(&quot;perex_place&quot;);</span>
			}
<span class="pc bpc" id="L1809" title="1 of 2 branches missed.">			else if (orderType == ORDER_EVENT_DATE)</span>
			{
<span class="nc" id="L1811">				order = new StringBuilder(&quot;event_date&quot;);</span>
			}
<span class="pc bpc" id="L1813" title="1 of 2 branches missed.">			else if (orderType == ORDER_SAVE_DATE)</span>
			{
<span class="fc" id="L1815">				order = new StringBuilder(&quot;date_created&quot;);</span>
			}
<span class="nc bnc" id="L1817" title="All 2 branches missed.">			else if (orderType == ORDER_RATING)</span>
			{
<span class="nc" id="L1819">				order = new StringBuilder(&quot;forum_count&quot;);</span>
			}

<span class="pc bpc" id="L1822" title="1 of 2 branches missed.">			if (asc)</span>
			{
<span class="nc" id="L1824">				order.append(&quot; ASC&quot;);</span>
<span class="nc bnc" id="L1825" title="All 4 branches missed.">				if (orderType != ORDER_PRIORITY &amp;&amp; orderType != ORDER_PLACE) order.append(&quot;, sort_priority ASC&quot;);</span>
			}
			else
			{
<span class="fc" id="L1829">				order.append(&quot; DESC&quot;);</span>
<span class="pc bpc" id="L1830" title="2 of 4 branches missed.">				if (orderType != ORDER_PRIORITY &amp;&amp; orderType != ORDER_PLACE) order.append(&quot;, sort_priority ASC&quot;);</span>
			}

<span class="pc bpc" id="L1833" title="1 of 2 branches missed.">			if (orderType == ORDER_PLACE)</span>
			{
				//ak sme podla mesta, ostatne sortni podla title
<span class="nc" id="L1836">				order.append(&quot;, d.title ASC&quot;);</span>
			}

<span class="pc bpc" id="L1839" title="1 of 2 branches missed.">			if (orderSql != null)</span>
			{
<span class="nc" id="L1841">				order = new StringBuilder(orderSql);</span>
			}

<span class="fc" id="L1844">			String dateSql = &quot; &quot;;</span>
			//v pripade ze existuje parameter datum napr. datum=25.10.2011
<span class="pc bpc" id="L1846" title="1 of 2 branches missed.">			if(datum != null)</span>
			{
				//v pripade ze existuje parameter datum napr. datum=25.10.2011
<span class="nc" id="L1849">				dateSql = &quot; AND ( (publish_start IS NOT null AND publish_start &gt;= ? AND publish_start &lt;= ?) ) &quot;;</span>
			}
<span class="fc bfc" id="L1851" title="All 2 branches covered.">			else if (publishType == PUBLISH_NEW)</span>
			{
<span class="fc" id="L1853">				dateSql = &quot; AND ( (publish_start IS null OR publish_start &lt;= ?) AND (publish_end IS null OR publish_end &gt;= ?) ) &quot;;</span>
				//dateSql = &quot; AND ( (publish_start IS NOT null AND publish_start &gt;= ? ) OR (publish_start IS null AND publish_end &gt;= ?) ) &quot;;
			}
<span class="pc bpc" id="L1856" title="1 of 2 branches missed.">			else if (publishType == PUBLISH_OLD)</span>
			{
<span class="nc" id="L1858">				dateSql = &quot; AND ( (publish_end IS NOT null AND publish_end &lt; ?) ) &quot;;</span>
			}
<span class="pc bpc" id="L1860" title="1 of 2 branches missed.">			else if (publishType == PUBLISH_NEXT)</span>
			{
				//zobrazme aj veci za poslednych 24 hodin, aby sme vedeli, co sme zmeskali
<span class="nc" id="L1863">				now = now - TimeUnit.DAYS.toMillis(1);</span>
<span class="nc" id="L1864">				dateSql = &quot; AND ( (publish_end IS NOT null AND publish_end &gt;= ?) OR (publish_end IS null AND publish_start IS NOT NULL AND publish_start &gt;= ?) ) &quot;;</span>
			}

			//Logger.println(this,&quot;dateSql=&quot;+dateSql);

			StringBuilder sql;

<span class="pc bpc" id="L1871" title="1 of 2 branches missed.">			String docFields = getDocumentFields(noData==false);</span>

			DocDetails doc;
<span class="fc" id="L1874">			int maxRows = -1;</span>
<span class="pc bpc" id="L1875" title="1 of 2 branches missed.">			if (endIndex &gt; startIndex) maxRows = endIndex - startIndex;</span>

<span class="fc" id="L1877">			String checkPerexSql = &quot;&quot;;</span>
<span class="pc bpc" id="L1878" title="1 of 2 branches missed.">			if (checkPerex)</span>
			{
<span class="nc" id="L1880">				checkPerexSql = &quot; AND html_data IS NOT NULL &quot;;</span>
			}

<span class="pc bpc" id="L1883" title="1 of 2 branches missed.">			int rootGroupId = Tools.isNotEmpty(groupIds) ? Tools.getIntValue(groupIds, 0) : 0;</span>

<span class="pc bpc" id="L1885" title="5 of 6 branches missed.">			boolean perexGroupUseJoin = Constants.getBoolean(&quot;perexGroupUseJoin&quot;) &amp;&amp; Tools.isNotEmpty(whereSql) &amp;&amp; whereSql.contains(&quot;p.perex_group_id&quot;);</span>

<span class="pc bpc" id="L1887" title="1 of 2 branches missed.">			if (groupIds != null) groupIds = getOnlyNumbersIn(groupIds,true);</span>
<span class="pc bpc" id="L1888" title="1 of 2 branches missed.">			if (Constants.DB_TYPE == Constants.DB_MSSQL)</span>
			{
<span class="nc" id="L1890">				String top = &quot;&quot;;</span>
<span class="nc bnc" id="L1891" title="All 2 branches missed.">				if (endIndex &gt; 0)</span>
				{
<span class="nc bnc" id="L1893" title="All 2 branches missed.">					if (checkPerex)</span>
					{
						//zvys start index, lebo niekde noze byt v adresari stranka, ktora nema perex a tu skipneme programovo
<span class="nc" id="L1896">						StringTokenizer st = new StringTokenizer(groupIds, &quot;,&quot;);</span>
						//toto je len taky odhad, ze kazdy adresar ma jednu (hlavnu) stranku, ktora nema perex
<span class="nc" id="L1898">						endIndex += st.countTokens() + 5;</span>
					}
<span class="nc" id="L1900">					top = &quot;TOP &quot; + endIndex;</span>
				}
<span class="nc bnc" id="L1902" title="All 2 branches missed.">				sql = new StringBuilder(&quot;SELECT &quot; ).append( top ).append( &quot; u.title as u_title, u.first_name, u.last_name, u.email, u.photo, &quot;).append(docFields).append(&quot; FROM documents d LEFT JOIN users u ON d.author_id=u.user_id&quot;+(perexGroupUseJoin ? &quot; LEFT JOIN perex_group_doc p ON d.doc_id = p.doc_id&quot; : &quot;&quot;)+&quot; WHERE&quot;);</span>

<span class="nc bnc" id="L1904" title="All 2 branches missed.">				if (Constants.getBoolean(&quot;docAuthorLazyLoad&quot;))</span>
<span class="nc bnc" id="L1905" title="All 2 branches missed.">					sql = new StringBuilder(&quot;SELECT &quot; ).append( top ).append(' ').append(docFields).append(&quot; FROM documents d&quot;+(perexGroupUseJoin ? &quot; LEFT JOIN perex_group_doc p ON d.doc_id = p.doc_id&quot; : &quot;&quot;)+&quot; WHERE&quot;);</span>

<span class="nc bnc" id="L1907" title="All 2 branches missed.">				if (onlyAvailable) sql.append(&quot; available=&quot;+DB.getBooleanSql(true)+&quot; &quot;);</span>
<span class="nc" id="L1908">				else sql.append(&quot; d.doc_id&gt;0 &quot;);</span>

<span class="nc bnc" id="L1910" title="All 4 branches missed.">				if (groupIds!=null &amp;&amp; groupIds.length()&gt;0)</span>
				{
<span class="nc bnc" id="L1912" title="All 4 branches missed.">					if(rootGroupLevel &lt;= 3 &amp;&amp; rootGroupLevel &gt; 0) sql.append(&quot; AND root_group_l&quot;+rootGroupLevel+&quot; = &quot;+rootGroupId);</span>
<span class="nc" id="L1913">					else sql.append(&quot; AND group_id IN (&quot; ).append( getOnlyNumbersIn(groupIds) ).append( &quot;) &quot;);</span>
				}
<span class="nc" id="L1915">				sql.append(&quot; &quot; ).append(dateSql).append(checkPerexSql).append(whereSql).append(&quot; ORDER BY &quot; ).append( order);</span>
<span class="nc" id="L1916">			}</span>
<span class="pc bpc" id="L1917" title="1 of 2 branches missed.">			else if (Constants.DB_TYPE == Constants.DB_ORACLE)</span>
			{
<span class="nc bnc" id="L1919" title="All 2 branches missed.">				sql = new StringBuilder(&quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, u.photo, &quot;).append(docFields).append(&quot; FROM documents d LEFT JOIN users u ON d.author_id=u.user_id&quot;+(perexGroupUseJoin ? &quot; LEFT JOIN perex_group_doc p ON d.doc_id = p.doc_id&quot; : &quot;&quot;)+&quot; WHERE&quot;);</span>
<span class="nc bnc" id="L1920" title="All 2 branches missed.">				if (Constants.getBoolean(&quot;docAuthorLazyLoad&quot;))</span>
<span class="nc bnc" id="L1921" title="All 2 branches missed.">					sql = new StringBuilder(&quot;SELECT &quot;).append(docFields).append(&quot; FROM documents d&quot;+(perexGroupUseJoin ? &quot; LEFT JOIN perex_group_doc p ON d.doc_id = p.doc_id&quot; : &quot;&quot;)+&quot; WHERE&quot;);</span>

<span class="nc bnc" id="L1923" title="All 2 branches missed.">				if (onlyAvailable) sql.append(&quot; available=&quot;+DB.getBooleanSql(true)+&quot; &quot;);</span>
<span class="nc" id="L1924">				else sql.append(&quot; d.doc_id&gt;0 &quot;);</span>

<span class="nc bnc" id="L1926" title="All 4 branches missed.">				if (groupIds!=null &amp;&amp; groupIds.length()&gt;0)</span>
				{
<span class="nc bnc" id="L1928" title="All 4 branches missed.">					if(rootGroupLevel &lt;= 3 &amp;&amp; rootGroupLevel &gt; 0) sql.append(&quot; AND root_group_l&quot;+rootGroupLevel+&quot; = &quot;+rootGroupId);</span>
<span class="nc" id="L1929">					else sql.append(&quot; AND group_id IN (&quot; ).append( getOnlyNumbersIn(groupIds) ).append( &quot;) &quot;);</span>
				}
<span class="nc" id="L1931">				sql.append(' ').append(dateSql).append(checkPerexSql).append(whereSql).append(&quot; ORDER BY &quot; ).append( order);</span>
			}
			else
			{
<span class="fc" id="L1935">				String limit = &quot;&quot;;</span>
<span class="pc bpc" id="L1936" title="2 of 4 branches missed.">				if (startIndex &gt;= 0 &amp;&amp; endIndex &gt; 0)</span>
				{
<span class="fc" id="L1938">					int rows = endIndex - startIndex;</span>
<span class="fc" id="L1939">					limit = &quot; LIMIT &quot; + startIndex + &quot;, &quot; + rows;</span>
<span class="pc bpc" id="L1940" title="1 of 2 branches missed.">					if (Constants.DB_TYPE == Constants.DB_PGSQL) limit = &quot; OFFSET &quot; + startIndex + &quot; LIMIT &quot; + rows;</span>
<span class="fc" id="L1941">					startIndex = 0;</span>
				}
<span class="pc bpc" id="L1943" title="1 of 2 branches missed.">				sql = new StringBuilder(&quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, u.photo, &quot;).append(docFields).append(&quot; FROM documents d LEFT JOIN users u ON d.author_id=u.user_id&quot;+(perexGroupUseJoin ? &quot; LEFT JOIN perex_group_doc p ON d.doc_id = p.doc_id&quot; : &quot;&quot;)+&quot; WHERE&quot;);</span>
<span class="pc bpc" id="L1944" title="1 of 2 branches missed.">				if (Constants.getBoolean(&quot;docAuthorLazyLoad&quot;))</span>
<span class="nc bnc" id="L1945" title="All 4 branches missed.">					sql = new StringBuilder(&quot;SELECT &quot;).append((perexGroupUseJoin ? &quot;DISTINCT &quot; : &quot;&quot;)+docFields).append(&quot; FROM documents d&quot;+(perexGroupUseJoin ? &quot; LEFT JOIN perex_group_doc p ON d.doc_id = p.doc_id&quot; : &quot;&quot;)+&quot; WHERE&quot;);</span>

<span class="pc bpc" id="L1947" title="1 of 2 branches missed.">				if (onlyAvailable) sql.append(&quot; available=&quot;+DB.getBooleanSql(true)+&quot; &quot;);</span>
<span class="nc" id="L1948">				else sql.append(&quot; d.doc_id&gt;0 &quot;);</span>

<span class="pc bpc" id="L1950" title="2 of 4 branches missed.">				if (groupIds!=null &amp;&amp; groupIds.length()&gt;0)</span>
				{
<span class="pc bpc" id="L1952" title="2 of 4 branches missed.">					if(rootGroupLevel &lt;= 3 &amp;&amp; rootGroupLevel &gt; 0) sql.append(&quot; AND root_group_l&quot;+rootGroupLevel+&quot; = &quot;+rootGroupId);</span>
<span class="nc" id="L1953">					else sql.append(&quot; AND group_id IN (&quot; ).append( getOnlyNumbersIn(groupIds) ).append( &quot;) &quot;);</span>
				}
<span class="fc" id="L1955">				sql.append(' ').append(dateSql).append(checkPerexSql).append(whereSql).append(&quot; ORDER BY &quot; ).append( order ).append( limit);</span>
			}
			//Logger.println(this,&quot;getDocPerex() sql=&quot;+sql);
<span class="pc bpc" id="L1958" title="1 of 2 branches missed.">			if(datum != null)</span>
			{
<span class="nc" id="L1960">				ps = db_conn.prepareStatement(sql.toString());</span>
<span class="nc" id="L1961">				ps.setTimestamp(1, new Timestamp(DB.getTimestamp(datum, &quot;00:00:00&quot;)));</span>
<span class="nc" id="L1962">				ps.setTimestamp(2, new Timestamp(DB.getTimestamp(datum, &quot;23:59:59&quot;)));</span>
			}
<span class="pc bpc" id="L1964" title="1 of 4 branches missed.">			else if (publishType == PUBLISH_NEW || publishType == PUBLISH_NEXT)</span>
			{
<span class="fc" id="L1966">				Timestamp tsNow = new Timestamp(now);</span>
<span class="fc" id="L1967">				ps = db_conn.prepareStatement(sql.toString());</span>
<span class="fc" id="L1968">				ps.setTimestamp(1, tsNow);</span>
<span class="fc" id="L1969">				ps.setTimestamp(2, tsNow);</span>
<span class="fc" id="L1970">			}</span>
<span class="pc bpc" id="L1971" title="1 of 2 branches missed.">			else if (publishType == PUBLISH_OLD)</span>
			{
<span class="nc" id="L1973">				Timestamp tsNow = new Timestamp(now);</span>
<span class="nc" id="L1974">				ps = db_conn.prepareStatement(sql.toString());</span>
<span class="nc" id="L1975">				ps.setTimestamp(1, tsNow);</span>
<span class="nc" id="L1976">			}</span>
			else
			{
<span class="fc" id="L1979">				ps = db_conn.prepareStatement(sql.toString());</span>
			}
<span class="fc" id="L1981">			Logger.debug(this,&quot;sql: &quot;+sql);</span>

<span class="fc" id="L1983">			rs = ps.executeQuery();</span>

<span class="fc" id="L1985">			int counter = 0;</span>
<span class="pc bpc" id="L1986" title="1 of 2 branches missed.">			if (startIndex &gt; 0)</span>
			{
				int i;
<span class="nc bnc" id="L1989" title="All 2 branches missed.">				for (i=0; i&lt;startIndex; i++)</span>
				{
					//jTDS nevie rs.absolute...
					//rs.absolute(startIndex);
<span class="nc" id="L1993">					rs.next();</span>
				}
			}
<span class="fc" id="L1996">			counter = 0;</span>
<span class="fc bfc" id="L1997" title="All 2 branches covered.">			while (rs.next())</span>
			{
				//Logger.println(this,&quot;counter=&quot;+counter+&quot; rows=&quot;+maxRows);
<span class="pc bpc" id="L2000" title="2 of 4 branches missed.">				if (maxRows &gt; 0 &amp;&amp; counter &gt;= maxRows)</span>
				{
<span class="nc" id="L2002">					break;</span>
				}

<span class="pc bpc" id="L2005" title="1 of 2 branches missed.">				if (Constants.getBoolean(&quot;docAuthorLazyLoad&quot;))</span>
<span class="nc" id="L2006">					doc = getDocDetails(rs, noData, true);</span>
				else
<span class="fc" id="L2008">					doc = getDocDetails(rs, noData);</span>

<span class="pc bpc" id="L2010" title="1 of 2 branches missed.">				if (checkPerex)</span>
				{
					//skontroluj, ci je tam nejaky perex
<span class="nc bnc" id="L2013" title="All 4 branches missed.">					if (doc.getHtmlData()!=null &amp;&amp; doc.getHtmlData().length()&gt;1)</span>
					{
<span class="nc" id="L2015">						ret.add(doc);</span>
<span class="nc" id="L2016">						counter++;</span>
					}
				}
				else
				{
<span class="fc" id="L2021">					ret.add(doc);</span>
<span class="fc" id="L2022">					counter++;</span>
				}
			}
<span class="fc" id="L2025">			rs.close();</span>
<span class="fc" id="L2026">			ps.close();</span>
<span class="fc" id="L2027">			db_conn.close();</span>

<span class="fc" id="L2029">			rs = null;</span>
<span class="fc" id="L2030">			ps = null;</span>
<span class="fc" id="L2031">			db_conn = null;</span>
		}
<span class="nc" id="L2033">		catch (Exception ex)</span>
		{
<span class="nc" id="L2035">			Logger.error(DocDB.class, ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L2041" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L2042">					rs.close();</span>
<span class="pc bpc" id="L2043" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L2044">					ps.close();</span>
<span class="pc bpc" id="L2045" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L2046">					db_conn.close();</span>
			}
<span class="nc" id="L2048">			catch (Exception ex2)</span>
			{
<span class="nc" id="L2050">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L2051">			}</span>
		}

<span class="fc" id="L2054">		return (ret);</span>

	}

	/**
	 * vrati pocet stranok v adresaroch groupIds
	 * @param docIdsNotIn - obsahuje duplicitne docId oddelene ciarkou, ktore sa maju z hladania vypustit
	 * @return
	 */
	private int getDocPerexCountInGroups(String groupIds, int publishType, String whereSql, String docIdsNotIn, boolean onlyAvailable, String datum, int rootGroupLevel)
	{
<span class="nc bnc" id="L2065" title="All 2 branches missed.">		if (whereSql==null) whereSql = &quot;&quot;;</span>
		//len pre istotu...
<span class="nc" id="L2067">		whereSql = whereSql.replace(';', ' ');</span>

<span class="nc bnc" id="L2069" title="All 2 branches missed.">		if(Tools.isNotEmpty(docIdsNotIn))</span>
<span class="nc" id="L2070">			whereSql += &quot; AND d.doc_id NOT IN (&quot;+docIdsNotIn+&quot;)&quot;;</span>

<span class="nc" id="L2072">		int ret = 0;</span>

<span class="nc" id="L2074">		Connection db_conn = null;</span>
<span class="nc" id="L2075">		PreparedStatement ps = null;</span>
<span class="nc" id="L2076">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L2079">			db_conn = DBPool.getConnection(serverName);</span>

<span class="nc" id="L2081">			boolean checkPerex = true;</span>
<span class="nc bnc" id="L2082" title="All 2 branches missed.">			if (publishType&gt;100)</span>
			{
				//nebudeme kontrolovat ci doc_html je null
<span class="nc" id="L2085">				checkPerex = false;</span>
<span class="nc" id="L2086">				publishType = publishType - 100;</span>
			}

<span class="nc bnc" id="L2089" title="All 6 branches missed.">			boolean perexGroupUseJoin = Constants.getBoolean(&quot;perexGroupUseJoin&quot;) &amp;&amp; Tools.isNotEmpty(whereSql) &amp;&amp; whereSql.contains(&quot;p.perex_group_id&quot;);</span>

<span class="nc bnc" id="L2091" title="All 2 branches missed.">			if (groupIds != null) groupIds = getOnlyNumbersIn(groupIds,true);</span>
<span class="nc bnc" id="L2092" title="All 6 branches missed.">			if (InitServlet.isTypeCloud() &amp;&amp; ( Tools.isEmpty(groupIds) || &quot;-1&quot;.equals(groupIds) ))</span>
			{
<span class="nc" id="L2094">				groupIds = String.valueOf(CloudToolsForCore.getDomainId());</span>
			}

<span class="nc bnc" id="L2097" title="All 2 branches missed.">			int rootGroupId = Tools.isNotEmpty(groupIds) ? Tools.getIntValue(groupIds, 0) : 0;</span>

<span class="nc bnc" id="L2099" title="All 2 branches missed.">			if (groupIds != null) groupIds = getOnlyNumbersIn(groupIds,true);</span>

<span class="nc" id="L2101">			StringBuilder sql = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L2102" title="All 6 branches missed.">			if(Constants.DB_TYPE == Constants.DB_MYSQL || Constants.DB_TYPE == Constants.DB_PGSQL) sql.append(&quot;SELECT count(&quot;+(perexGroupUseJoin ? &quot;DISTINCT &quot; : &quot;&quot;)+&quot;d.doc_id) as total FROM documents d&quot;);</span>
<span class="nc" id="L2103">			else sql.append(&quot;SELECT count(d.doc_id) as total FROM documents d&quot;);</span>

<span class="nc bnc" id="L2105" title="All 2 branches missed.">			sql.append((perexGroupUseJoin ? &quot; LEFT JOIN perex_group_doc p ON d.doc_id = p.doc_id&quot; : &quot;&quot;)+&quot; WHERE&quot;);</span>

<span class="nc bnc" id="L2107" title="All 2 branches missed.">			if (onlyAvailable) sql.append(&quot; available=&quot;+DB.getBooleanSql(true)+&quot; &quot;);</span>
<span class="nc" id="L2108">			else sql.append(&quot; d.doc_id&gt;0 &quot;);</span>

<span class="nc bnc" id="L2110" title="All 4 branches missed.">			if (groupIds!=null &amp;&amp; groupIds.length()&gt;0)</span>
			{
<span class="nc bnc" id="L2112" title="All 4 branches missed.">				if(rootGroupLevel &lt;= 3 &amp;&amp; rootGroupLevel &gt; 0) sql.append(&quot; AND root_group_l&quot;+rootGroupLevel+&quot; = &quot;+rootGroupId);</span>
<span class="nc" id="L2113">				else sql.append(&quot; AND group_id IN (&quot; ).append( groupIds ).append( &quot;) &quot;);</span>
			}

<span class="nc bnc" id="L2116" title="All 2 branches missed.">			if (checkPerex) sql.append(&quot; AND html_data IS NOT null &quot;);</span>
<span class="nc" id="L2117">			sql.append(whereSql);</span>
<span class="nc bnc" id="L2118" title="All 2 branches missed.">			if(datum != null)</span>
			{
				//v pripade ze existuje parameter datum napr. datum=25.10.2011
<span class="nc" id="L2121">				sql.append(&quot; AND ( (publish_start IS NOT null AND publish_start &gt;= ? AND publish_start &lt;= ?) ) &quot;);</span>
<span class="nc" id="L2122">				Logger.debug(this, &quot;getDocPerexCountInGroups sql=&quot;+sql);</span>

<span class="nc" id="L2124">				ps = db_conn.prepareStatement(sql.toString());</span>
<span class="nc" id="L2125">				ps.setTimestamp(1, new Timestamp(DB.getTimestamp(datum, &quot;00:00:00&quot;)));</span>
<span class="nc" id="L2126">				ps.setTimestamp(2, new Timestamp(DB.getTimestamp(datum, &quot;23:59:59&quot;)));</span>
			}
<span class="nc bnc" id="L2128" title="All 2 branches missed.">			else if (publishType == PUBLISH_NEW)</span>
			{
<span class="nc" id="L2130">				sql.append(&quot; AND ( (publish_start IS null OR publish_start &lt; ?) AND (publish_end IS null OR publish_end &gt; ?) )&quot;);</span>
<span class="nc" id="L2131">				Logger.debug(this, &quot;getDocPerexCountInGroups sql=&quot;+sql);</span>

<span class="nc" id="L2133">				Timestamp now = new Timestamp((new java.util.Date()).getTime());</span>
<span class="nc" id="L2134">				ps = db_conn.prepareStatement(sql.toString());</span>
<span class="nc" id="L2135">				ps.setTimestamp(1, now);</span>
<span class="nc" id="L2136">				ps.setTimestamp(2, now);</span>
<span class="nc" id="L2137">			}</span>
<span class="nc bnc" id="L2138" title="All 2 branches missed.">			else if (publishType == PUBLISH_OLD)</span>
			{
<span class="nc" id="L2140">				sql.append(&quot; AND ( (publish_end IS NOT null AND publish_end &lt; ?) )&quot;);</span>
<span class="nc" id="L2141">				Logger.debug(this, &quot;getDocPerexCountInGroups sql=&quot;+sql.toString());</span>

<span class="nc" id="L2143">				Timestamp now = new Timestamp((new java.util.Date()).getTime());</span>
<span class="nc" id="L2144">				ps = db_conn.prepareStatement(sql.toString());</span>
<span class="nc" id="L2145">				ps.setTimestamp(1, now);</span>
<span class="nc" id="L2146">			}</span>
<span class="nc bnc" id="L2147" title="All 2 branches missed.">			else if (publishType == PUBLISH_NEXT)</span>
			{
<span class="nc" id="L2149">				sql.append(&quot; AND ( (publish_end IS NOT null AND publish_end &gt;= ?) OR (publish_end IS null AND publish_start IS NOT NULL AND publish_start &gt;= ?) ) &quot;);</span>
<span class="nc" id="L2150">				Timestamp now = new Timestamp((new java.util.Date()).getTime() - TimeUnit.DAYS.toMillis(1));</span>
<span class="nc" id="L2151">				ps = db_conn.prepareStatement(sql.toString());</span>
<span class="nc" id="L2152">				ps.setTimestamp(1, now);</span>
<span class="nc" id="L2153">				ps.setTimestamp(2, now);</span>
<span class="nc" id="L2154">			}</span>
			else
			{
<span class="nc" id="L2157">				Logger.debug(this, &quot;getDocPerexCountInGroups sql=&quot;+sql.toString());</span>
<span class="nc" id="L2158">				ps = db_conn.prepareStatement(sql.toString());</span>
			}
<span class="nc" id="L2160">			rs = ps.executeQuery();</span>

<span class="nc bnc" id="L2162" title="All 2 branches missed.">			if (rs.next())</span>
			{
<span class="nc" id="L2164">				ret = rs.getInt(&quot;total&quot;);</span>
			}
<span class="nc" id="L2166">			rs.close();</span>
<span class="nc" id="L2167">			ps.close();</span>
<span class="nc" id="L2168">			db_conn.close();</span>
<span class="nc" id="L2169">			rs = null;</span>
<span class="nc" id="L2170">			ps = null;</span>
<span class="nc" id="L2171">			db_conn = null;</span>
		}
<span class="nc" id="L2173">		catch (Exception ex)</span>
		{
<span class="nc" id="L2175">			Logger.error(DocDB.class, ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L2181" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L2182">					rs.close();</span>
<span class="nc bnc" id="L2183" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L2184">					ps.close();</span>
<span class="nc bnc" id="L2185" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L2186">					db_conn.close();</span>
			}
<span class="nc" id="L2188">			catch (Exception ex2)</span>
			{
<span class="nc" id="L2190">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L2191">			}</span>
		}

<span class="nc" id="L2194">		return (ret);</span>
	}


	/**
	 *  Vrati pocet dostupnych (available=1) stranok v zadanom adresari
	 *
	 *@param  group_id  Description of the Parameter
	 *@return           The docCountInGroup value
	 */
	public int getDocCountInGroup(int group_id)
	{
<span class="nc" id="L2206">		int ret = 0;</span>
<span class="nc" id="L2207">		java.sql.Connection db_conn = null;</span>
<span class="nc" id="L2208">		java.sql.PreparedStatement ps = null;</span>
<span class="nc" id="L2209">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L2212">			db_conn = DBPool.getConnection(serverName);</span>

			//read user permissions for every org struct

			String sql;
<span class="nc" id="L2217">			sql = &quot;SELECT count(doc_id) as total FROM documents d WHERE available=&quot;+DB.getBooleanSql(true)+&quot; AND group_id=&quot; + group_id;</span>
<span class="nc" id="L2218">			ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L2219">			rs = ps.executeQuery();</span>

<span class="nc bnc" id="L2221" title="All 2 branches missed.">			if (rs.next())</span>
			{
<span class="nc" id="L2223">				ret = rs.getInt(&quot;total&quot;);</span>
			}
<span class="nc" id="L2225">			rs.close();</span>
<span class="nc" id="L2226">			ps.close();</span>
<span class="nc" id="L2227">			db_conn.close();</span>
<span class="nc" id="L2228">			db_conn = null;</span>
<span class="nc" id="L2229">			ps = null;</span>
<span class="nc" id="L2230">			rs = null;</span>
		}
<span class="nc" id="L2232">		catch (Exception ex){Logger.error(DocDB.class, ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L2235" title="All 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="nc bnc" id="L2236" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L2237" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L2238">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="nc" id="L2240">		return (ret);</span>
	}


	/**
	 *  Interne nacitanie zoznamu URL adries do cache
	 */
	private void loadUrls()
	{
<span class="fc" id="L2249">		Logger.debug(DocDB.class, &quot;Load URLS start&quot;);</span>
<span class="fc" id="L2250">		Logger.debugMemInfo();</span>

<span class="fc" id="L2252">		urlsByUrlDomains = new Hashtable&lt;&gt;();</span>

<span class="fc" id="L2254">		DebugTimer timer = new DebugTimer(&quot;loadUrls&quot;);</span>

		//nemozeme pouzit GroupsDB, pretoze to potrebuje inicializovane DocDB (kvoli virtualpath)
		//GroupsDB groupsDB = GroupsDB.getInstance(servletContext, false, dbName);

		//iteruj po grupach a ziskavaj dokumenty
<span class="fc" id="L2260">		Map&lt;Integer, GroupDetails&gt; allGroups = getAllGroups();</span>

<span class="fc" id="L2262">		Logger.debug(DocDB.class, &quot;after getAllGroups&quot;);</span>
<span class="fc" id="L2263">		Logger.debugMemInfo();</span>

		String fileName;
<span class="fc" id="L2266">		int counter=0;</span>
<span class="fc" id="L2267">		timer.diff(&quot;loading doc table&quot;);</span>
<span class="fc" id="L2268">		TIntObjectHashMap&lt;List&lt;DocDetails&gt;&gt; basicAllDocsInGroupTableLocal = null;</span>
<span class="fc" id="L2269">		int failsafe = 0;</span>
<span class="pc bpc" id="L2270" title="1 of 4 branches missed.">		while (basicAllDocsInGroupTableLocal==null &amp;&amp; failsafe++&lt;5)</span>
		{
<span class="fc" id="L2272">			timer.diff(&quot;loading doc table, try=&quot;+failsafe);</span>
<span class="fc" id="L2273">			basicAllDocsInGroupTableLocal = getDocForUrls(true);</span>
		}
<span class="pc bpc" id="L2275" title="1 of 2 branches missed.">		if (basicAllDocsInGroupTableLocal == null) basicAllDocsInGroupTableLocal = getDocForUrls(false);</span>

<span class="fc" id="L2277">		basicAllDocsInGroupTable = basicAllDocsInGroupTableLocal;</span>
<span class="fc" id="L2278">		timer.diff(&quot;loaded&quot;);</span>

		//System.gc();
<span class="fc" id="L2281">		timer.diff(&quot;after getDocForUrls&quot;);</span>
		//Logger.debugMemInfo();

<span class="fc" id="L2284">		TObjectIntHashMap&lt;String&gt; urlsByUrl = null;</span>
<span class="fc" id="L2285">		String lastDomain = null;</span>

<span class="fc bfc" id="L2287" title="All 2 branches covered.">		for (GroupDetails group : allGroups.values())</span>
		{
<span class="pc bpc" id="L2289" title="1 of 2 branches missed.">			if (group != null)</span>
			{
				//ziskaj zoznam dokumentov v danej grupe
<span class="fc" id="L2292">				List&lt;DocDetails&gt; docs = basicAllDocsInGroupTable.get(group.getGroupId());</span>

<span class="fc bfc" id="L2294" title="All 2 branches covered.">				if (docs==null)</span>
				{
<span class="fc" id="L2296">					continue;</span>
				}

				//docDB.getDocForUrls(group.getGroupId());

<span class="fc" id="L2301">				String[] groupDiskPathDomain = null;</span>
<span class="fc" id="L2302">				String domain = &quot;&quot;;</span>

<span class="fc bfc" id="L2304" title="All 2 branches covered.">				if (Constants.getBoolean(&quot;multiDomainEnabled&quot;))</span>
				{
<span class="fc" id="L2306">					groupDiskPathDomain = GroupsDB.getURLPathDomainGroup(allGroups, group.getGroupId());</span>
<span class="fc" id="L2307">					domain = groupDiskPathDomain[1];</span>
				}

				//Logger.debug(DocDB.class, &quot;lastDomain=&quot;+lastDomain+&quot; domain=&quot;+domain+&quot; dif=&quot;+timer.getDiff());
<span class="pc bpc" id="L2311" title="1 of 6 branches missed.">				if (urlsByUrl==null || lastDomain==null || lastDomain.equals(domain)==false)</span>
				{
<span class="fc" id="L2313">					lastDomain = domain;</span>
<span class="fc" id="L2314">					urlsByUrl = getUrlsByUrlDomains(lastDomain, true);</span>
					//System.out.println(&quot;loadUrls: domain=&quot;+lastDomain+&quot; size=&quot;+urlsByUrl.size());
				}

<span class="fc bfc" id="L2318" title="All 2 branches covered.">				for (DocDetails doc : docs)</span>
				{

<span class="fc" id="L2321">					fileName = doc.getVirtualPath();</span>
<span class="fc bfc" id="L2322" title="All 2 branches covered.">					if (Tools.isEmpty(fileName))</span>
					{
<span class="fc bfc" id="L2324" title="All 2 branches covered.">						if (groupDiskPathDomain == null) groupDiskPathDomain = GroupsDB.getURLPathDomainGroup(allGroups, group.getGroupId());</span>
<span class="fc" id="L2325">						String groupDiskPath = DocTools.removeCharsDir(DB.internationalToEnglish(groupDiskPathDomain[0])).toLowerCase() + &quot;/&quot;; //NOSONAR</span>
						//aby to nevytvorilo root stranky pre taketo typy URL
<span class="fc" id="L2327">						int lastDefaulDocId = group.getDefaultDocId();</span>
<span class="pc bpc" id="L2328" title="1 of 2 branches missed.">						if (group.getDefaultDocId()!=doc.getDocId())</span>
						{
							//fakt uz netusim preco je tu toto, hlavne ta 4...
<span class="fc" id="L2331">							group.setDefaultDocIdNoNavbar(4);</span>
						}
<span class="fc" id="L2333">						fileName = getURL(doc, group, groupDiskPath);</span>
<span class="fc" id="L2334">						group.setDefaultDocIdNoNavbar(lastDefaulDocId);</span>
						//Logger.debug(DocDB.class, &quot;Empty VP: docId=&quot;+doc.getDocId()+&quot; vp=&quot;+doc.getVirtualPath()+&quot; grp=&quot;+group.getGroupId()+&quot; gdp=&quot;+groupDiskPath+&quot; new url=&quot;+fileName);

<span class="fc" id="L2337">						doc.setVirtualPath(fileName);</span>
					}
					//Logger.println(this,doc.getDocId() + &quot;: &quot; + fileName);
<span class="fc" id="L2340">					urlsByUrl.put(fileName, doc.getDocId());</span>

					//POZOR: TUTO MAME ULOZENU DOMENU
<span class="fc" id="L2343">					doc.setFieldT(domain);</span>

<span class="fc" id="L2345">					counter++;</span>
<span class="fc" id="L2346">				}</span>

				//timer.diff(&quot;mam: &quot; + group.getGroupId());
			}
<span class="fc" id="L2350">		}</span>

<span class="fc" id="L2352">		timer.diff(&quot;done, size=&quot;+counter);</span>

		//System.gc();
<span class="fc" id="L2355">		Logger.debug(DocDB.class, &quot;Load URLS done&quot;);</span>
		//Logger.debugMemInfo();
<span class="fc" id="L2357">	}</span>

	/**
	 * This method is essential during startup phase and therefore
	 * can't be replaced by {@link GroupsDB}.getGroups(), since correct initialization
	 * of {@link GroupsDB} requires already initialized {@link DocDB}. Such a mutual
	 * dependency would render this code undeterministic.
	 */
	private static Map&lt;Integer, GroupDetails&gt; getAllGroups()
	{
<span class="fc" id="L2367">		Map&lt;Integer, GroupDetails&gt; groups = new Hashtable&lt;&gt;();</span>
		GroupDetails group;
<span class="fc" id="L2369">		java.sql.Connection db_conn = null;</span>
<span class="fc" id="L2370">		java.sql.PreparedStatement ps = null;</span>
<span class="fc" id="L2371">		java.sql.ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L2374">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L2375">			String sql = &quot;SELECT * FROM groups ORDER BY sort_priority, group_id, group_name&quot;;</span>
<span class="fc" id="L2376">			ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L2377">			rs = ps.executeQuery();</span>

<span class="fc bfc" id="L2379" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="fc" id="L2381">				group = new GroupDetails();</span>
<span class="fc" id="L2382">				group.setGroupId(rs.getInt(&quot;group_id&quot;));</span>
<span class="fc" id="L2383">				group.setGroupName(getDbString(rs, &quot;group_name&quot;));</span>
<span class="fc" id="L2384">				group.setInternal(rs.getBoolean(&quot;internal&quot;));</span>
<span class="fc" id="L2385">				group.setParentGroupId(rs.getInt(&quot;parent_group_id&quot;));</span>
<span class="fc" id="L2386">				group.setNavbar(getDbString(rs, &quot;navbar&quot;));</span>
<span class="fc" id="L2387">				group.setDefaultDocIdNoNavbar(rs.getInt(&quot;default_doc_id&quot;));</span>
<span class="fc" id="L2388">				group.setTempId(rs.getInt(&quot;temp_id&quot;));</span>
<span class="fc" id="L2389">				group.setSortPriority(rs.getInt(&quot;sort_priority&quot;));</span>
<span class="fc" id="L2390">				group.setPasswordProtected(getDbString(rs, &quot;password_protected&quot;));</span>
<span class="fc" id="L2391">				group.setMenuType(rs.getInt(&quot;menu_type&quot;));</span>
<span class="fc" id="L2392">				group.setUrlDirName(getDbString(rs, &quot;url_dir_name&quot;));</span>
<span class="fc" id="L2393">				group.setSyncId(rs.getInt(&quot;sync_id&quot;));</span>
<span class="fc" id="L2394">				group.setSyncStatus(rs.getInt(&quot;sync_status&quot;));</span>
<span class="fc" id="L2395">				group.setHtmlHead(DB.getDbString(rs, &quot;html_head&quot;));</span>
<span class="fc" id="L2396">				group.setLogonPageDocId(rs.getInt(&quot;logon_page_doc_id&quot;));</span>

<span class="fc" id="L2398">				group.setDomainName(DB.getDbString(rs, &quot;domain_name&quot;));</span>

				//tu nepotrebujeme ostatne atributy

<span class="fc" id="L2402">				groups.put(group.getGroupId(), group);</span>
			}

<span class="fc" id="L2405">			rs.close();</span>

<span class="fc" id="L2407">			ps.close();</span>
<span class="fc" id="L2408">			db_conn.close();</span>
<span class="fc" id="L2409">			db_conn = null;</span>
<span class="fc" id="L2410">			ps = null;</span>
<span class="fc" id="L2411">			rs = null;</span>
		}
<span class="nc" id="L2413">		catch (Exception ex){Logger.error(DocDB.class, ex);}</span>
		finally{
			try{
<span class="pc bpc" id="L2416" title="1 of 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="pc bpc" id="L2417" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L2418" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L2419">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}

<span class="fc" id="L2422">		return(groups);</span>
	}

	private TIntObjectHashMap&lt;List&lt;DocDetails&gt;&gt; getDocForUrls(boolean returnNull)
	{
<span class="fc" id="L2427">		TIntObjectHashMap&lt;List&lt;DocDetails&gt;&gt; table = new TIntObjectHashMap&lt;&gt;(10, 0.9f);</span>
<span class="pc bpc" id="L2428" title="1 of 2 branches missed.">		if (basicAllDocsTable==null) basicAllDocsTable = allocateEmptyBasicDocDetails();</span>

<span class="fc" id="L2430">		java.sql.Connection db_conn = null;</span>
<span class="fc" id="L2431">		java.sql.PreparedStatement ps = null;</span>
<span class="fc" id="L2432">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L2435">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L2436">			String sql = &quot;SELECT doc_id, title, navbar, external_link, group_id, virtual_path, available, searchable, show_in_menu, show_in_navbar, show_in_sitemap, logged_show_in_menu, logged_show_in_sitemap, logged_show_in_navbar, sort_priority, password_protected, temp_id, date_created, field_a, field_b, field_c FROM documents&quot;;</span>

<span class="fc" id="L2438">			ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L2439">			rs = ps.executeQuery();</span>
			DocDetails doc;
			List&lt;DocDetails&gt; list;
<span class="fc bfc" id="L2442" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="fc" id="L2444">				doc = new DocDetails();</span>
<span class="fc" id="L2445">				doc.setDocId(rs.getInt(&quot;doc_id&quot;));</span>
<span class="fc" id="L2446">				doc.setTitle(DB.getDbString(rs, &quot;title&quot;));</span>
<span class="fc" id="L2447">				String navbar = DB.getDbString(rs, &quot;navbar&quot;);</span>
<span class="fc bfc" id="L2448" title="All 2 branches covered.">				if (doc.getTitle().equals(navbar)==false) doc.setNavbar(navbar);</span>
<span class="fc" id="L2449">				doc.setExternalLink(DB.getDbString(rs, &quot;external_link&quot;));</span>
<span class="fc" id="L2450">				doc.setGroupId(rs.getInt(&quot;group_id&quot;));</span>
<span class="fc" id="L2451">				doc.setVirtualPath(normalizeVirtualPath(DB.getDbString(rs, &quot;virtual_path&quot;)));</span>
<span class="fc" id="L2452">				doc.setAvailable(rs.getBoolean(&quot;available&quot;));</span>
<span class="fc" id="L2453">				doc.setSearchable(rs.getBoolean(&quot;searchable&quot;));</span>
<span class="fc" id="L2454">				doc.setShowInMenu(rs.getBoolean(&quot;show_in_menu&quot;));</span>
<span class="fc" id="L2455">				doc.setShowInSitemap(DB.getBoolean(rs, &quot;show_in_sitemap&quot;));</span>
<span class="fc" id="L2456">				doc.setShowInNavbar(DB.getBoolean(rs, &quot;show_in_navbar&quot;));</span>

<span class="fc" id="L2458">				doc.setLoggedShowInMenu(DB.getBoolean(rs, &quot;logged_show_in_menu&quot;));</span>
<span class="fc" id="L2459">				doc.setLoggedShowInSitemap(DB.getBoolean(rs, &quot;logged_show_in_sitemap&quot;));</span>
<span class="fc" id="L2460">				doc.setLoggedShowInNavbar(DB.getBoolean(rs, &quot;logged_show_in_navbar&quot;));</span>

<span class="fc" id="L2462">				doc.setSortPriority(rs.getInt(&quot;sort_priority&quot;));</span>
<span class="fc" id="L2463">				doc.setPasswordProtected(DB.getDbString(rs, &quot;password_protected&quot;));</span>
<span class="fc" id="L2464">				doc.setTempId(rs.getInt(&quot;temp_id&quot;));</span>
<span class="fc" id="L2465">				doc.setDateCreated(rs.getTimestamp(&quot;date_created&quot;).getTime());</span>
<span class="fc" id="L2466">				doc.setFieldA(DB.getDbString(rs, &quot;field_a&quot;));</span>
<span class="fc" id="L2467">				doc.setFieldB(DB.getDbString(rs, &quot;field_b&quot;));</span>
<span class="fc" id="L2468">				doc.setFieldC(DB.getDbString(rs, &quot;field_c&quot;));</span>

				//POZOR: do fieldT si neskor ulozime DOMENU

<span class="fc" id="L2472">				putToBasicDocDetails(doc);</span>

<span class="pc bpc" id="L2474" title="5 of 6 branches missed.">				if (Constants.getInt(&quot;linkType&quot;)!=Constants.LINK_TYPE_HTML &amp;&amp; Constants.getBoolean(&quot;forwardVirtualPath&quot;)==true &amp;&amp; rs.getString(&quot;virtual_path&quot;)==null)</span>
				{
<span class="nc" id="L2476">					continue;</span>
				}
<span class="fc" id="L2478">				list = table.get(doc.getGroupId());</span>
<span class="fc bfc" id="L2479" title="All 2 branches covered.">				if (list==null)</span>
				{
<span class="fc" id="L2481">					list = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L2482">					table.put(doc.getGroupId(), list);</span>
				}
<span class="fc" id="L2484">				list.add(doc);</span>
<span class="fc" id="L2485">			}</span>
<span class="fc" id="L2486">			rs.close();</span>
<span class="fc" id="L2487">			ps.close();</span>
<span class="fc" id="L2488">			db_conn.close();</span>
<span class="fc" id="L2489">			rs = null;</span>
<span class="fc" id="L2490">			ps = null;</span>
<span class="fc" id="L2491">			db_conn = null;</span>
		}
<span class="nc" id="L2493">		catch (Exception ex)</span>
		{
<span class="nc" id="L2495">			Logger.error(DocDB.class, ex);</span>
<span class="nc bnc" id="L2496" title="All 2 branches missed.">			if (returnNull) return null;</span>
		}
		finally
		{
			try{
<span class="pc bpc" id="L2501" title="1 of 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="pc bpc" id="L2502" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L2503" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L2504">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}

<span class="fc" id="L2507">		basicAllDocsTable.compact();</span>

<span class="fc" id="L2509">		return (table);</span>
	}

	private TIntObjectHashMap&lt;DocDetails&gt; allocateEmptyBasicDocDetails()
	{
<span class="fc" id="L2514">		int maxDocId = new SimpleQuery().forInt(&quot;SELECT MAX(doc_id) FROM documents&quot;);</span>
<span class="fc" id="L2515">		sk.iway.iwcm.Logger.printf(DocDB.class, &quot;Max doc id: %d&quot;, maxDocId);</span>
		//allow +10% more for resize
<span class="fc" id="L2517">		int allocationSize = (int) (maxDocId * 1.1);</span>
<span class="fc" id="L2518">		TIntObjectHashMap&lt;DocDetails&gt; newBasicDocDetails = new TIntObjectHashMap&lt;&gt;(allocationSize, 0.9f);</span>
<span class="fc" id="L2519">		return newBasicDocDetails;</span>
	}

	void putToBasicDocDetails(DocDetails doc)
	{
<span class="fc" id="L2524">		basicAllDocsTable.put(doc.getDocId(), doc);</span>
<span class="fc" id="L2525">	}</span>

	private void putToBasicDocDetailsAndResize(DocDetails doc)
	{
<span class="fc" id="L2529">		putToBasicDocDetails(doc);</span>
<span class="fc" id="L2530">		basicAllDocsTable.compact();</span>
<span class="fc" id="L2531">	}</span>

	@SuppressWarnings({&quot;rawtypes&quot;, &quot;unchecked&quot;})
	public List&lt;DocDetails&gt; getBasicDocDetailsAll()
	{
		//je to tu takto aby sa nehadzala ClassCastException v Spotlighte
<span class="fc" id="L2537">		List basicDocDetails = new ArrayList();</span>
<span class="fc" id="L2538">		basicDocDetails.addAll(Arrays.asList(basicAllDocsTable.getValues()));</span>

<span class="fc" id="L2540">		return basicDocDetails;</span>
	}

	/**
	 * Vrati docDetails s cache, su tam len zakladne info - docId, title, navbar, externalLink, groupId, virtualPath, available, showInMenu, showInSitemap, showInNavbar, loggedShowIn...
	 * @param docId - id stranky
	 * @param doNotReturnNull - ak je nastavene na true, tak to vzdy vrati aspon prazdny objekt
	 * @return
	 */
	public DocDetails getBasicDocDetails(int docId, boolean doNotReturnNull)
	{
<span class="fc" id="L2551">		DocDetails doc = null;</span>

<span class="pc bpc" id="L2553" title="2 of 6 branches missed.">		if (basicAllDocsTable!=null &amp;&amp; basicAllDocsTable.size()&gt;0 &amp;&amp; docId &gt; 0)</span>
		{
<span class="fc" id="L2555">			doc = basicAllDocsTable.get(docId);</span>
		}

<span class="fc bfc" id="L2558" title="All 4 branches covered.">		if (doNotReturnNull &amp;&amp; doc == null)</span>
		{
<span class="fc" id="L2560">			doc = new DocDetails();</span>
<span class="fc" id="L2561">			doc.setDocId(docId);</span>
<span class="fc" id="L2562">			doc.setTitle(&quot;??? docId=&quot;+docId);</span>
		}

<span class="fc" id="L2565">		return(doc);</span>
	}

	/**
	 * Vrati zoznam docDetails z cache (su tam len zakladne info) v zadanom adresari a so zadanym usporiadanim
	 * @param groupId
	 * @param orderType
	 * @return
	 */
	public List&lt;DocDetails&gt; getBasicDocDetailsByGroup(int groupId, int orderType)
	{
<span class="fc" id="L2576">		List&lt;DocDetails&gt; docs = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L2578">		List&lt;DocDetails&gt; docsInGroup = basicAllDocsInGroupTable.get(groupId);</span>
<span class="fc bfc" id="L2579" title="All 2 branches covered.">		if (docsInGroup == null) return(docs);</span>
<span class="fc" id="L2580">		docs.addAll(docsInGroup);</span>

		//usortuj to
<span class="fc bfc" id="L2583" title="All 2 branches covered.">		if (orderType == DocDB.ORDER_PRIORITY)</span>
		{
<span class="fc" id="L2585">			Collections.sort(docs, new Comparator&lt;DocDetails&gt;() {</span>
				@Override
				public int compare(DocDetails d1, DocDetails d2)
				{
<span class="fc bfc" id="L2589" title="All 2 branches covered.">					if (d1.getSortPriority() &lt; d2.getSortPriority())</span>
<span class="fc" id="L2590">						return -1;</span>
<span class="fc bfc" id="L2591" title="All 2 branches covered.">					else if (d1.getSortPriority() &gt; d2.getSortPriority())</span>
<span class="fc" id="L2592">						return 1;</span>
					else
<span class="fc" id="L2594">						return 0;</span>
				}

			});
		}
<span class="pc bpc" id="L2599" title="1 of 2 branches missed.">		else if (orderType == DocDB.ORDER_TITLE)</span>
		{
<span class="nc" id="L2601">			Collections.sort(docs, new Comparator&lt;DocDetails&gt;() {</span>
				@Override
				public int compare(DocDetails d1, DocDetails d2)
				{
<span class="nc" id="L2605">					return(d1.getTitle().compareTo(d2.getTitle()));</span>
				}

			});
		}
<span class="pc bpc" id="L2610" title="1 of 2 branches missed.">		else if (orderType == DocDB.ORDER_DATE)</span>
		{
<span class="nc" id="L2612">			Collections.sort(docs, new Comparator&lt;DocDetails&gt;() {</span>
				@Override
				public int compare(DocDetails d1, DocDetails d2)
				{
<span class="nc" id="L2616">					long date1 = d1.getPublishStart();</span>
<span class="nc bnc" id="L2617" title="All 2 branches missed.">					if (date1 &lt; 10000) date1 = d1.getDateCreated();</span>

<span class="nc" id="L2619">					long date2 = d2.getPublishStart();</span>
<span class="nc bnc" id="L2620" title="All 2 branches missed.">					if (date2 &lt; 10000) date2 = d2.getDateCreated();</span>

<span class="nc bnc" id="L2622" title="All 2 branches missed.">					if (date1 &gt; date2) return 1;</span>
<span class="nc bnc" id="L2623" title="All 2 branches missed.">					else if (date1 &lt; date2) return -1;</span>
<span class="nc" id="L2624">					return 0;</span>
				}
			});
		}

<span class="fc" id="L2629">		return(docs);</span>
	}

	/**
	 * Ziska docId z URL a domeny
	 * @param url
	 * @param domain
	 * @return
	 */
	public static int getDocIdFromURL(String url, String domain)
	{
<span class="fc" id="L2640">		DocDB docDB = DocDB.getInstance();</span>
<span class="fc" id="L2641">		return(docDB.getDocIdFromURLImpl(url, domain));</span>
	}

	/**
	 * Vrati domenu podla request
	 * @param request
	 * @return
	 */
	public static String getDomain(HttpServletRequest request)
	{
<span class="fc" id="L2651">		String serverName = Tools.getServerName(request);</span>

<span class="fc" id="L2653">		return getDomain(serverName, request);</span>
	}

	/**
	 * Vrati domenu podla zadaneho nazvu
	 * @param serverName
	 * @param request
	 * @return
	 */
	public static String getDomain(String serverName, HttpServletRequest request)
	{
<span class="pc bpc" id="L2664" title="1 of 2 branches missed.">		if (request == null) return serverName;</span>

<span class="fc" id="L2666">		String sessionDomain = (String)request.getSession().getAttribute(&quot;preview.editorDomainName&quot;);</span>

<span class="fc bfc" id="L2668" title="All 2 branches covered.">		if (Tools.isNotEmpty(sessionDomain))</span>
		{
<span class="fc" id="L2670">			serverName = sessionDomain;</span>
		}

<span class="fc" id="L2673">		String adminHost = Constants.getString(&quot;multiDomainAdminHost&quot;); //admin host moze obsahovat viac hostov</span>
<span class="pc bpc" id="L2674" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(adminHost) &amp;&amp;</span>
<span class="nc bnc" id="L2675" title="All 6 branches missed.">				( (&quot;,&quot;+adminHost+&quot;,&quot;).indexOf(&quot;,&quot;+serverName+&quot;,&quot;)!=-1 || &quot;iwcm.interway.sk&quot;.equals(serverName) || &quot;localhost&quot;.equals(serverName) ) &amp;&amp;</span>
<span class="nc bnc" id="L2676" title="All 2 branches missed.">				Tools.isEmpty(sessionDomain) &amp;&amp;</span>
<span class="nc bnc" id="L2677" title="All 4 branches missed.">				( request.getParameter(&quot;docid&quot;)!=null || request.getParameter(&quot;historyid&quot;)!=null))</span>
		{
<span class="nc" id="L2679">			DocDetails myDoc = null;</span>
<span class="nc" id="L2680">			int docId = Tools.getIntValue(request.getParameter(&quot;docid&quot;), -1);</span>
<span class="nc bnc" id="L2681" title="All 2 branches missed.">			if (docId &gt; 0)</span>
			{
<span class="nc" id="L2683">				myDoc = DocDB.getInstance().getBasicDocDetails(docId, false);</span>

			}
			else
			{
<span class="nc" id="L2688">				int historyId = Tools.getIntValue(request.getParameter(&quot;historyid&quot;), -1);</span>
<span class="nc bnc" id="L2689" title="All 2 branches missed.">				if (historyId &gt; 0)</span>
				{
<span class="nc" id="L2691">					myDoc = DocDB.getInstance().getDoc(-1, historyId);</span>
				}
			}
<span class="nc bnc" id="L2694" title="All 2 branches missed.">			if (myDoc != null)</span>
			{
<span class="nc" id="L2696">				GroupDetails group = GroupsDB.getInstance().getGroup(myDoc.getGroupId());</span>
<span class="nc bnc" id="L2697" title="All 2 branches missed.">				if (group != null)</span>
				{
<span class="nc" id="L2699">					String domain = group.getDomainName();</span>
<span class="nc bnc" id="L2700" title="All 2 branches missed.">					if (Tools.isNotEmpty(domain))</span>
					{
<span class="nc" id="L2702">						Logger.debug(DocDB.class, &quot;Setting preview domain: &quot;+domain);</span>
<span class="nc" id="L2703">						request.getSession().setAttribute(&quot;preview.editorDomainName&quot;, domain);</span>
<span class="nc" id="L2704">						serverName = domain;</span>
					}
				}
			}
		}

<span class="fc" id="L2710">		return serverName;</span>
	}

	/**
	 * ziska docId z URL
	 * @param url
	 * @return
	 */
	public int getDocIdFromURLImpl(String url, String domain)
	{
<span class="fc" id="L2720">		Logger.debug(DocDB.class, &quot;getDocIdFromURLImpl, url=&quot;+url+&quot; domain=&quot;+domain);</span>
		try
		{
<span class="fc" id="L2723">			TObjectIntHashMap&lt;String&gt; mUrls = getUrlsByUrlDomains(domain, false);</span>

<span class="pc bpc" id="L2725" title="1 of 2 branches missed.">			if (mUrls != null)</span>
			{
<span class="fc" id="L2727">				Integer iDocId = mUrls.get(url);</span>
<span class="pc bpc" id="L2728" title="1 of 4 branches missed.">				if (iDocId == null || iDocId.intValue()==0) iDocId = mUrls.get(normalizeVirtualPath(url));</span>

<span class="pc bpc" id="L2730" title="1 of 2 branches missed.">				if (iDocId != null)</span>
				{
<span class="fc" id="L2732">					return(iDocId.intValue());</span>
				}
			}
		}
<span class="nc" id="L2736">		catch (Exception e)</span>
		{
<span class="nc" id="L2738">			Logger.error(DocDB.class, e);</span>
<span class="nc" id="L2739">		}</span>
<span class="nc" id="L2740">		return(-1);</span>
	}

	/**
	 * ziska URL z docId
	 * POZOR: pred url je nutne dat contextPath!!
	 * @param docId
	 * @return
	 */
	private static String getURLFromDocId(int docId)
	{
<span class="fc" id="L2751">		DocDB docDB = DocDB.getInstance();</span>
<span class="fc" id="L2752">		return(docDB.getURLFromDocIdImpl(docId));</span>
	}

	/**
	 * ziska URL z docId
	 * POZOR: pred url je nutne dat contextPath!!
	 * @param docId
	 * @return
	 */
	private String getURLFromDocIdImpl(int docId)
	{
<span class="fc" id="L2763">		DocDetails doc = basicAllDocsTable.get(docId);</span>

<span class="fc bfc" id="L2765" title="All 2 branches covered.">		if (doc==null) return &quot;/showdoc.do?docid=&quot;+docId;</span>

<span class="fc" id="L2767">		String url = doc.getVirtualPath();</span>
<span class="fc" id="L2768">		url = Tools.replace(url, &quot;*&quot;, &quot;&quot;);</span>
<span class="fc" id="L2769">		return(url);</span>
	}

	/**
	 * ziska URL z docId
	 * @param docId
	 * @param request
	 * @return
	 */
	public static String getURLFromDocId(int docId, HttpServletRequest request)
	{
<span class="fc" id="L2780">		return(getURLFromDocId(docId));</span>
	}


	/**
	 * Vrati cestu k adresaru s odstranenymi nepovolenymi znakmi
	 * @param allGroups
	 * @param groupId
	 * @return
	 */
	public static String getGroupDiskPath(List&lt;GroupDetails&gt; allGroups, int groupId)
	{
<span class="fc" id="L2792">		String groupDiskPath = DB.internationalToEnglish(GroupsDB.getURLPathGroup(allGroups, groupId)).toLowerCase() + &quot;/&quot;; //NOSONAR</span>
<span class="fc" id="L2793">		groupDiskPath = DocTools.removeCharsDir(groupDiskPath).toLowerCase();</span>
<span class="fc" id="L2794">		groupDiskPath = Tools.replace(groupDiskPath, &quot;//&quot;, &quot;/&quot;);</span>
<span class="fc" id="L2795">		return(groupDiskPath);</span>
	}

	/**
	 * Ziskanie URL adresy stranky
	 * @param doc
	 * @param groupsDB
	 * @return
	 */
	public static String getURL(DocDetails doc, GroupsDB groupsDB)
	{
<span class="fc" id="L2806">		return(getURL(doc, getGroupDiskPath(groupsDB.getGroupsAll(), doc.getGroupId())));</span>
	}

	/**
	 * Ziskanie URL adresy web stranky
	 * @param doc
	 * @param groupDiskPath
	 * @return
	 */
	public static String getURL(DocDetails doc, String groupDiskPath)
	{
<span class="fc" id="L2817">		return(getURL(doc, null, groupDiskPath));</span>
	}

	/**
	 * Ziska URL adresu web stranky
	 * @param doc
	 * @param group
	 * @param groupDiskPath
	 * @return
	 */
	public static String getURL(DocDetails doc, GroupDetails group, String groupDiskPath)
	{
<span class="fc bfc" id="L2829" title="All 4 branches covered.">		if (Tools.isEmpty(doc.getVirtualPath()) || doc.getVirtualPath().indexOf('/')==-1)</span>
		{
<span class="fc" id="L2831">			String htmlFileName = doc.getVirtualPath();</span>
<span class="fc bfc" id="L2832" title="All 2 branches covered.">			if (Tools.isEmpty(htmlFileName))</span>
			{
<span class="fc" id="L2834">				htmlFileName = doc.getNavbar();</span>
			}
<span class="fc" id="L2836">			StringBuilder fileName = new StringBuilder(groupDiskPath);</span>
<span class="fc bfc" id="L2837" title="All 2 branches covered.">			if (group == null)</span>
			{
<span class="fc" id="L2839">				GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="fc" id="L2840">				group = groupsDB.getGroup(doc.getGroupId());</span>
			}
<span class="pc bpc" id="L2842" title="1 of 2 branches missed.">			if (group == null)</span>
			{
<span class="nc" id="L2844">				return &quot;/page-&quot;+doc.getDocId()+&quot;.html&quot;;</span>
			}
<span class="pc bpc" id="L2846" title="1 of 8 branches missed.">			if (Tools.isEmpty(doc.getVirtualPath()) &amp;&amp; ((group.getDefaultDocId()&lt;=0 &amp;&amp; !&quot;-&quot;.equals(group.getUrlDirName())) || group.getDefaultDocId()==doc.getDocId()))</span>
			{
				//ak adresar nema default stranku, alebo je to prave nasa, nemusi to koncit na .html
<span class="pc bpc" id="L2849" title="1 of 2 branches missed.">				if (fileName.toString().endsWith(&quot;/&quot;)==false) fileName.append('/');</span>
			}
			else
			{
<span class="fc" id="L2853">				fileName.append(DocTools.removeChars(DB.internationalToEnglish(htmlFileName).toLowerCase())).append(Constants.getString(&quot;editorPageExtension&quot;));</span>
			}
<span class="fc" id="L2855">			return (normalizeVirtualPath(fixURL(fileName.toString())));</span>
		}
		else
		{
<span class="fc" id="L2859">			return(doc.getVirtualPath());</span>
		}
	}

	private static String fixURL(String url)
	{
<span class="pc bpc" id="L2865" title="1 of 2 branches missed.">		if (url==null) return(&quot;&quot;);</span>

<span class="fc" id="L2867">		url = DocTools.removeCharsDir(url).toLowerCase();</span>

<span class="fc" id="L2869">		url = Tools.replace(url, &quot;//&quot;, &quot;/&quot;);</span>
<span class="fc" id="L2870">		url = Tools.replace(url, &quot;_-_&quot;, &quot;_&quot;);</span>
<span class="fc" id="L2871">		url = Tools.replace(url, &quot;__&quot;, &quot;_&quot;);</span>
<span class="fc" id="L2872">		url = Tools.replace(url, &quot;___&quot;, &quot;_&quot;);</span>
<span class="fc" id="L2873">		url = Tools.replace(url, &quot;._&quot;, &quot;_&quot;);</span>
<span class="fc" id="L2874">		url = Tools.replace(url, &quot;_.html&quot;, &quot;.html&quot;);</span>
<span class="fc" id="L2875">		url = Tools.replace(url, &quot;.html.html&quot;, &quot;.html&quot;);</span>
		//ak mame nahradu spojok a bodiek v URL toto treba
<span class="fc" id="L2877">		url = Tools.replace(url, &quot;-html.html&quot;, &quot;.html&quot;);</span>
		//htm je tu kvoli importu web stranok zo zip archivu
<span class="fc" id="L2879">		url = Tools.replace(url, &quot;.htm.html&quot;, &quot;.htm&quot;);</span>
<span class="fc" id="L2880">		url = Tools.replace(url, &quot;-htm.html&quot;, &quot;.htm&quot;);</span>
<span class="fc" id="L2881">		return(url);</span>
	}

	/**
	 * Vrati linku na dokument
	 * @param docId
	 * @return
	 */
	public String getDocLink(int docId)
	{
<span class="fc" id="L2891">		return(getDocLink(docId, null, null));</span>
	}

	public String getDocLink(int docId, HttpServletRequest request)
	{
<span class="fc" id="L2896">		return(getDocLink(docId, null, request));</span>
	}

	/**
	 * Vrati linku na zadane docId
	 * @param docId - id stranky
	 * @param externalLink - externa linka (ak ma dokument nastavene a vieme urcit)
	 * @param request
	 * @return
	 */
	public String getDocLink(int docId, String externalLink, HttpServletRequest request)
	{
<span class="fc" id="L2908">		return getDocLink(docId, externalLink, false, request);</span>
	}

	/**
	 * Vrati linku na zadane docId
	 * @param docId - id stranky
	 * @param externalLink - externa linka (ak ma dokument nastavene a vieme urcit)
	 * @param alwaysIncludeHttpPrefix - ak je nastavene na true vracia sa vzdy aj s HTTP prefixom (napr. pre email...), inak sa http prefix nastavi len pre multidomain ine ako aktualna domena
	 * @param request
	 * @return
	 */
	public String getDocLink(int docId, String externalLink, boolean alwaysIncludeHttpPrefix, HttpServletRequest request)
	{
<span class="fc bfc" id="L2921" title="All 2 branches covered.">		if (docId&lt;1)</span>
		{
<span class="fc" id="L2923">			return(&quot;javascript:void(0)&quot;);</span>
		}
<span class="fc bfc" id="L2925" title="All 2 branches covered.">		if (Tools.isNotEmpty(externalLink))</span>
		{
<span class="pc bpc" id="L2927" title="3 of 4 branches missed.">			if (alwaysIncludeHttpPrefix &amp;&amp; externalLink.startsWith(&quot;http&quot;)==false) externalLink = Tools.getBaseHref(request)+externalLink;</span>
<span class="fc" id="L2928">			return(externalLink);</span>
		}
<span class="pc bpc" id="L2930" title="3 of 4 branches missed.">		if (Constants.getInt(&quot;linkType&quot;)==Constants.LINK_TYPE_HTML || Constants.getBoolean(&quot;forwardVirtualPath&quot;)==true)</span>
		{
			//ziskaj linku
			//Logger.println(this,&quot;ziskavam linku: &quot;+getURLFromDocId(docId));
<span class="fc" id="L2934">			DocDetails doc = basicAllDocsTable.get(docId);</span>

			String url;
<span class="fc bfc" id="L2937" title="All 2 branches covered.">			if (doc==null)</span>
			{
				//url = &quot;/showdoc.do?docid=&quot;+docId;
				//jeeff: uprava pre cloud, ale asi nema smysel robit linku na doc ktory neexistuje
<span class="fc" id="L2941">				url = &quot;#nopage&quot;;</span>
			}
<span class="fc" id="L2943">			else url = doc.getVirtualPath();</span>
<span class="fc" id="L2944">			url = Tools.replace(url, &quot;*&quot;, &quot;&quot;);</span>
<span class="fc" id="L2945">			url = Tools.replace(url, &quot;//&quot;, &quot;/&quot;);</span>

<span class="fc bfc" id="L2947" title="All 4 branches covered.">			if (request!=null &amp;&amp; doc!=null)</span>
			{
				//vo fieldT mame domenu stranky (kvoli optimalizacii kodu)
<span class="fc" id="L2950">				String fieldT = doc.getFieldT();</span>

				//porovnaj domeny
<span class="fc" id="L2953">				String domain = getDomain(request);</span>
<span class="pc bpc" id="L2954" title="1 of 8 branches missed.">				if (alwaysIncludeHttpPrefix || (domain.equals(fieldT)==false &amp;&amp; Tools.isNotEmpty(fieldT) &amp;&amp; &quot;default&quot;.equals(fieldT)==false))</span>
				{
<span class="pc bpc" id="L2956" title="1 of 2 branches missed.">					if (Tools.isNotEmpty(fieldT))</span>
					{
<span class="pc bpc" id="L2958" title="1 of 2 branches missed.">						if (Tools.isSecure(request)) url = &quot;https://&quot;+fieldT+url;</span>
<span class="fc" id="L2959">						else url = &quot;http://&quot;+fieldT+url;</span>
					}
				}
			}
<span class="fc bfc" id="L2963" title="All 4 branches covered.">			if (alwaysIncludeHttpPrefix &amp;&amp; url.startsWith(&quot;http&quot;)==false) {</span>
<span class="pc bpc" id="L2964" title="1 of 4 branches missed.">				if (doc != null &amp;&amp; Tools.isNotEmpty(doc.getFieldT())) {</span>
<span class="fc" id="L2965">					url = &quot;http://&quot;+doc.getFieldT()+url;</span>
				} else {
<span class="fc" id="L2967">					url = Tools.getBaseHref(request)+url;</span>
				}
			}

<span class="pc bpc" id="L2971" title="1 of 2 branches missed.">			if (url.startsWith(&quot;/javascript:&quot;)) url = url.substring(1);</span>

<span class="fc" id="L2973">			return url;</span>
		}

		//nastava v pripade, ze adresar ma nastavene defaultDocId ale stranka bola vymazana, nechcem v cloude taku linku
<span class="nc bnc" id="L2977" title="All 2 branches missed.">		if (&quot;cloud&quot;.equals(Constants.getInstallName())) return &quot;&quot;;</span>

<span class="nc" id="L2979">		return(&quot;/showdoc.do?docid=&quot;+docId);</span>
	}


	/**
	 * Vrati prazdny string ak aktualna domena v requeste je zhodna s domenou stranky docId,
	 * inak vrati odkaz http[s]://domenaDanehoDocId.sk
	 * @param docId - ID stranky
	 * @param alwaysIncludeHttpPrefix - ak je nastavene na true http[s] prefix vrati vzdy
	 * @param request
	 * @return
	 */
	public String getDocDomainIfDifferent(int docId, boolean alwaysIncludeHttpPrefix, HttpServletRequest request)
	{
<span class="nc bnc" id="L2993" title="All 2 branches missed.">		if (docId&lt;1)</span>
		{
<span class="nc" id="L2995">			return(&quot;&quot;);</span>
		}
<span class="nc bnc" id="L2997" title="All 4 branches missed.">		if (Constants.getInt(&quot;linkType&quot;)==Constants.LINK_TYPE_HTML || Constants.getBoolean(&quot;forwardVirtualPath&quot;)==true)</span>
		{
			//ziskaj linku
			//Logger.println(this,&quot;ziskavam linku: &quot;+getURLFromDocId(docId));
<span class="nc" id="L3001">			DocDetails doc = basicAllDocsTable.get(docId);</span>

<span class="nc" id="L3003">			String retDomain = &quot;&quot;;</span>

<span class="nc bnc" id="L3005" title="All 4 branches missed.">			if (request!=null &amp;&amp; doc!=null)</span>
			{
				//vo fieldT mame domenu stranky (kvoli optimalizacii kodu)
<span class="nc" id="L3008">				String fieldT = doc.getFieldT();</span>

				//porovnaj domeny
<span class="nc" id="L3011">				String actualDomain = getDomain(request);</span>
<span class="nc bnc" id="L3012" title="All 8 branches missed.">				if (alwaysIncludeHttpPrefix || (actualDomain.equals(fieldT)==false &amp;&amp; Tools.isNotEmpty(fieldT) &amp;&amp; &quot;default&quot;.equals(fieldT)==false))</span>
				{
<span class="nc bnc" id="L3014" title="All 2 branches missed.">					if (Tools.isNotEmpty(fieldT))</span>
					{
<span class="nc bnc" id="L3016" title="All 2 branches missed.">						if (Tools.isSecure(request)) retDomain = &quot;https://&quot;+fieldT;</span>
<span class="nc" id="L3017">						else retDomain = &quot;http://&quot;+fieldT;</span>
					}
				}
			}

<span class="nc" id="L3022">			return retDomain;</span>
		}

<span class="nc" id="L3025">		return(&quot;&quot;);</span>
	}



	/**
	 * Replace oldText na newText vo vsetkych strankach
	 * @param oldText
	 * @param newText
	 * @return
	 */
	public List&lt;DocDetails&gt; replaceTextAll(String oldText, String newText)
	{
<span class="nc" id="L3038">		List&lt;DocDetails&gt; docs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L3039">		Connection db_conn = null;</span>
<span class="nc" id="L3040">		PreparedStatement ps = null;</span>
<span class="nc" id="L3041">		ResultSet rs = null;</span>
		try
		{
			//ziskaj udaje z db
<span class="nc" id="L3045">			db_conn = DBPool.getConnection(serverName);</span>
<span class="nc" id="L3046">			ps = db_conn.prepareStatement(&quot;SELECT * FROM documents WHERE data LIKE ?&quot;);</span>
<span class="nc" id="L3047">			ps.setString(1, &quot;%&quot;+oldText+&quot;%&quot;);</span>
<span class="nc" id="L3048">			rs = ps.executeQuery();</span>
<span class="nc bnc" id="L3049" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L3051">				DocDetails doc = new DocDetails();</span>
<span class="nc" id="L3052">				doc.setDocId(rs.getInt(&quot;doc_id&quot;));</span>
<span class="nc" id="L3053">				doc.setTitle(getDbString(rs, &quot;title&quot;));</span>
<span class="nc" id="L3054">				doc.setData(DB.getDbString(rs, &quot;data&quot;));</span>

				//Logger.println(this,&quot;mam: &quot; + doc.getTitle());

<span class="nc" id="L3058">				docs.add(doc);</span>
<span class="nc" id="L3059">			}</span>
<span class="nc" id="L3060">			rs.close();</span>
<span class="nc" id="L3061">			ps.close();</span>

			//ok, mame zoznam, updatni to
<span class="nc bnc" id="L3064" title="All 2 branches missed.">			for (DocDetails doc : docs)</span>
			{
<span class="nc" id="L3066">				Logger.println(this,&quot;updating link in: &quot;+doc.getTitle());</span>

<span class="nc" id="L3068">				doc.setData(Tools.replace(doc.getData(), oldText, newText));</span>

<span class="nc" id="L3070">				ps = db_conn.prepareStatement(&quot;UPDATE documents SET data=?, data_asc=?, sync_status=1 WHERE doc_id=?&quot;);</span>
				//ps.setString(1, doc.getData());
				//ps.setString(2, DB.internationalToEnglish(doc.getData()).toLowerCase());
<span class="nc" id="L3073">				DB.setClob(ps, 1, doc.getData());</span>
<span class="nc" id="L3074">				DB.setClob(ps, 2, DB.internationalToEnglish(doc.getData()).toLowerCase());</span>

<span class="nc" id="L3076">				ps.setInt(3, doc.getDocId());</span>
<span class="nc" id="L3077">				ps.executeUpdate();</span>
<span class="nc" id="L3078">				ps.close();</span>

				//DocDB.updateDataClob(db_conn, doc.getDocId(), -1, doc.getData(), DB.internationalToEnglish(doc.getData()).toLowerCase());
<span class="nc" id="L3081">			}</span>

<span class="nc" id="L3083">			db_conn.close();</span>
<span class="nc" id="L3084">			db_conn = null;</span>
<span class="nc" id="L3085">			ps = null;</span>
<span class="nc" id="L3086">			rs = null;</span>
		}
<span class="nc" id="L3088">		catch (Exception ex){Logger.error(DocDB.class, ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L3091" title="All 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="nc bnc" id="L3092" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L3093" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L3094">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}

<span class="nc" id="L3097">		return(docs);</span>
	}

	/**
	 * Vyhladavanie vo vsetkych strankach (/admin/searchall.jsp)
	 * @param text
	 * @return
	 */
	public List&lt;DocDetails&gt; searchTextAll(String text)
	{
<span class="nc" id="L3107">		return searchTextAll(text, -1);</span>
	}

	/**
	 * Vyhladavanie vo vsetkych strankach (/admin/searchall.jsp) v danom adresari
	 *
	 * @param 	text		text, ktory sa vyhladava v nazvoch a telach stranok
	 * @param	groupId	identifikacne cislo adresara, v ktorom sa vyhladava
	 *
	 * @return	zoznam stranok, ktore obsahuju vo svojom nazve alebo tele dany text a su umiestnene v danom adresari
	 *
	 */
	public List&lt;DocDetails&gt; searchTextAll(String text, int groupId)
	{
<span class="nc" id="L3121">		return searchTextAll(text, groupId, null);</span>
	}

	/**
	 * Search for text in documents
	 * @param text - text to search
	 * @param groupId - root groupId
	 * @param whereSql - additional SQL query
	 * @return
	 */
	public List&lt;DocDetails&gt; searchTextAll(String text, int groupId, String whereSql) {
<span class="fc" id="L3132">		return searchTextAll(text, groupId, whereSql, true);</span>
	}

	/**
	 * Search for text in documents
	 * @param text - text to search
	 * @param groupId - root groupId
	 * @param whereSql - additional SQL query
	 * @param allowFulltext - allow to use fulltext for faster results
	 * @return
	 */
	public List&lt;DocDetails&gt; searchTextAll(String text, int groupId, String whereSql, boolean allowFulltext)
	{
<span class="pc bpc" id="L3145" title="1 of 2 branches missed.">		if (&quot;tatrabanka&quot;.equals(Constants.getInstallName()))</span>
		{
			//fix na TB, ale inak rozumne som to nevedel spravit
			//vo fulltexte to mame ako TatraPay TB cize s medzerou kvoli sup
<span class="nc" id="L3149">			text = Tools.replace(text, &quot;TB&quot;, &quot; TB&quot;);</span>
		}
		//odstran dvojite medzery
<span class="fc" id="L3152">		text = Tools.replace(text, &quot;  &quot;, &quot; &quot;);</span>

<span class="fc" id="L3154">		List&lt;DocDetails&gt; docs = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L3155">		String groupIdsQuery = null;</span>
<span class="fc bfc" id="L3156" title="All 2 branches covered.">		if (groupId &gt; 0) groupIdsQuery = StatDB.getRootGroupWhere(&quot;group_id&quot;, groupId);</span>

		//obmedzujeme na max 2000 zaznamov, viac realne nema zmysel (zbytocne iba zere pamat)
<span class="fc" id="L3159">		int limit = Constants.getInt(&quot;searchTextAllLimit&quot;);</span>
<span class="fc" id="L3160">		String limit1 = &quot;&quot;;</span>
<span class="fc" id="L3161">		String limit2 = &quot;&quot;;</span>
<span class="pc bpc" id="L3162" title="3 of 4 branches missed.">		if (Constants.DB_TYPE==Constants.DB_MYSQL || Constants.DB_TYPE==Constants.DB_PGSQL) limit2 = &quot; LIMIT &quot;+limit;</span>
<span class="pc bpc" id="L3163" title="1 of 2 branches missed.">		if (Constants.DB_TYPE==Constants.DB_MSSQL) limit1 = &quot; TOP &quot;+limit;</span>

<span class="fc" id="L3165">		StringBuilder sql = new StringBuilder(&quot;SELECT&quot;).append(limit1).append(' ').append(getDocumentFields()).append(&quot;, d.data_asc FROM documents d WHERE &quot;);</span>

<span class="fc" id="L3167">		boolean useFullText = false;</span>

<span class="fc" id="L3169">		int searchTextDocsLimit = Constants.getInt(&quot;searchTextDocsLimit&quot;);</span>
<span class="pc bpc" id="L3170" title="1 of 2 branches missed.">		if(searchTextDocsLimit &lt; 0) searchTextDocsLimit = 10000;</span>

<span class="pc bpc" id="L3172" title="3 of 4 branches missed.">		if (basicAllDocsTable.size()&gt; searchTextDocsLimit &amp;&amp; allowFulltext)</span>
		{
<span class="nc bnc" id="L3174" title="All 2 branches missed.">			if (Constants.DB_TYPE == Constants.DB_MSSQL)</span>
			{
<span class="nc" id="L3176">				sql.append(&quot;CONTAINS(data_asc, ?)&quot;);</span>
			}
<span class="nc bnc" id="L3178" title="All 4 branches missed.">			else if (Constants.DB_TYPE == Constants.DB_ORACLE &amp;&amp; Constants.getBoolean(&quot;searchUseOracleText&quot;))</span>
			{
<span class="nc" id="L3180">				sql.append(&quot;CONTAINS(data_asc, ?)&gt;1&quot;);</span>
			}
<span class="nc bnc" id="L3182" title="All 2 branches missed.">			else if (Constants.DB_TYPE == Constants.DB_PGSQL)</span>
			{
<span class="nc" id="L3184">				sql.append(&quot;to_tsvector(data_asc) @@ to_tsquery(?)&quot;);</span>
			}
			else
			{
<span class="nc" id="L3188">				sql.append(&quot;MATCH(title, data_asc) AGAINST (? IN BOOLEAN MODE) &quot;);</span>
			}
<span class="nc" id="L3190">			useFullText =true;</span>
		}
		else
		{
<span class="fc" id="L3194">			sql.append(&quot;(data LIKE ? OR data_asc LIKE ? OR d.title LIKE ?) &quot;);</span>
<span class="fc" id="L3195">			useFullText =false;</span>
		}

<span class="fc bfc" id="L3198" title="All 2 branches covered.">		if (Tools.isNotEmpty(groupIdsQuery)) sql.append(' ').append(groupIdsQuery);</span>

<span class="fc bfc" id="L3200" title="All 2 branches covered.">		if (Tools.isNotEmpty(whereSql)) sql.append(' ').append(whereSql).append(' ');</span>

<span class="fc" id="L3202">		sql.append(limit2);</span>

<span class="fc" id="L3204">		Logger.debug(DocDB.class, &quot;SearcTextAll, text=&quot;+text+&quot;, groupid=&quot;+groupId+&quot;, sql=&quot;+sql);</span>

<span class="fc" id="L3206">		Connection db_conn = null;</span>
<span class="fc" id="L3207">		PreparedStatement ps = null;</span>
<span class="fc" id="L3208">		ResultSet rs = null;</span>

		try
		{
			//ziskaj udaje z db
<span class="fc" id="L3213">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L3214">			ps = StatNewDB.prepareStatement(db_conn, sql.toString());</span>

<span class="pc bpc" id="L3216" title="1 of 2 branches missed.">			if (useFullText)</span>
			{
<span class="nc bnc" id="L3218" title="All 4 branches missed.">				if ((Constants.DB_TYPE == Constants.DB_MSSQL || (Constants.DB_TYPE == Constants.DB_ORACLE &amp;&amp; Constants</span>
<span class="nc bnc" id="L3219" title="All 4 branches missed.">						.getBoolean(&quot;searchUseOracleText&quot;))) &amp;&amp; text.split(&quot; &quot;).length &gt; 1)</span>
				{
<span class="nc" id="L3221">					String[] words = text.split(&quot; &quot;);</span>
					//String containsPhraze = Lambda.join(words, &quot; AND &quot;);
<span class="nc" id="L3223">					String containsPhraze = String.join(&quot; AND &quot;, words);</span>

<span class="nc" id="L3225">					Logger.debug(getClass(), &quot;contains phraze: &quot; + containsPhraze);</span>
<span class="nc" id="L3226">					ps.setString(1, DB.internationalToEnglish(containsPhraze.toLowerCase()));</span>
<span class="nc" id="L3227">				}</span>
<span class="nc bnc" id="L3228" title="All 2 branches missed.">				else if (Constants.DB_TYPE == Constants.DB_PGSQL) {</span>
<span class="nc" id="L3229">					String containsPhraze = text;</span>
<span class="nc" id="L3230">					String[] words = text.split(&quot; &quot;);</span>
<span class="nc bnc" id="L3231" title="All 2 branches missed.">					if (words.length&gt;1) containsPhraze = String.join(&quot; &amp; &quot;, words);</span>

<span class="nc" id="L3233">					Logger.debug(getClass(), &quot;contains phraze pgsql: &quot; + containsPhraze);</span>
<span class="nc" id="L3234">					ps.setString(1, DB.internationalToEnglish(containsPhraze.toLowerCase()));</span>
<span class="nc" id="L3235">				}</span>
				else
				{
<span class="nc" id="L3238">					ps.setString(1, &quot;%&quot; + DB.internationalToEnglish(text.toLowerCase()) + &quot;%&quot;);</span>
				}
			}
			else
			{
<span class="fc" id="L3243">				String searchText = Tools.replace(text, &quot; &quot;, &quot;%&quot;);</span>
				//data
<span class="fc" id="L3245">				ps.setString(1, &quot;%&quot;+searchText+&quot;%&quot;);</span>
				//data_asc
<span class="fc" id="L3247">				ps.setString(2, &quot;%&quot;+DB.internationalToEnglish(searchText.toLowerCase())+&quot;%&quot;);</span>
				//title
<span class="fc" id="L3249">				ps.setString(3, &quot;%&quot;+searchText+&quot;%&quot;);</span>
			}

<span class="fc" id="L3252">			rs = ps.executeQuery();</span>
			DocDetails doc;
<span class="fc" id="L3254">			int counter = 0;</span>
<span class="pc bpc" id="L3255" title="1 of 4 branches missed.">			while (rs.next() &amp;&amp; counter++ &lt; limit)</span>
			{
<span class="fc" id="L3257">				doc = getDocDetails(rs, false, true);</span>
<span class="fc" id="L3258">				String dataAsc = DB.getDbString(rs, &quot;data_asc&quot;);</span>
<span class="pc bpc" id="L3259" title="2 of 4 branches missed.">				if (dataAsc != null &amp;&amp; &quot;null&quot;.equals(dataAsc)==false)</span>
				{
<span class="fc" id="L3261">					doc.setData(dataAsc);</span>
				}
<span class="fc" id="L3263">				docs.add(doc);</span>
<span class="fc" id="L3264">			}</span>
<span class="fc" id="L3265">			rs.close();</span>
<span class="fc" id="L3266">			ps.close();</span>

<span class="fc" id="L3268">			db_conn.close();</span>
<span class="fc" id="L3269">			db_conn = null;</span>
<span class="fc" id="L3270">			ps = null;</span>
<span class="fc" id="L3271">			rs = null;</span>
		}
<span class="nc" id="L3273">		catch (Exception ex){Logger.error(DocDB.class, ex);}</span>
		finally{
			try{
<span class="pc bpc" id="L3276" title="1 of 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="pc bpc" id="L3277" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L3278" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L3279">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}

<span class="fc" id="L3282">		return(docs);</span>
	}

	/**
	 * Vyhlada stranky obsahujuce zadane URL
	 * @param url
	 * @return
	 */
	public List&lt;DocDetails&gt; searchTextUrl(String url)
	{
<span class="nc" id="L3292">		return searchTextUrl(url, -1);</span>
	}

	/**
	 * Vyhlada stranky obsahujuce zadane URL v zadanom adresari
	 * @param url
	 * @param groupId
	 * @return
	 */
	public List&lt;DocDetails&gt; searchTextUrl(String url, int groupId)
	{
<span class="nc" id="L3303">		List&lt;DocDetails&gt; docs = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L3305">		String groupIdsQuery = null;</span>
<span class="nc bnc" id="L3306" title="All 2 branches missed.">		if (groupId &gt; 0) groupIdsQuery = StatDB.getRootGroupWhere(&quot;group_id&quot;, groupId);</span>

		//obmedzujeme na max 2000 zaznamov, viac realne nema zmysel (zbytocne iba zere pamat)
<span class="nc" id="L3309">		int limit = Constants.getInt(&quot;searchTextAllLimit&quot;);</span>
<span class="nc" id="L3310">		String limit1 = &quot;&quot;;</span>
<span class="nc" id="L3311">		String limit2 = &quot;&quot;;</span>
<span class="nc bnc" id="L3312" title="All 4 branches missed.">		if (Constants.DB_TYPE==Constants.DB_MYSQL || Constants.DB_TYPE==Constants.DB_PGSQL) limit2 = &quot; LIMIT &quot;+limit;</span>
<span class="nc bnc" id="L3313" title="All 2 branches missed.">		if (Constants.DB_TYPE==Constants.DB_MSSQL) limit1 = &quot; TOP &quot;+limit;</span>

<span class="nc" id="L3315">		StringBuilder sql = new StringBuilder(&quot;SELECT&quot;).append(limit1).append(' ').append(getDocumentFieldsNodata()).append(&quot; FROM documents d WHERE virtual_path LIKE ?&quot;);</span>

<span class="nc bnc" id="L3317" title="All 2 branches missed.">		if (Tools.isNotEmpty(groupIdsQuery)) sql.append(' ').append(groupIdsQuery);</span>

<span class="nc" id="L3319">		sql.append(limit2);</span>

<span class="nc" id="L3321">		Connection db_conn = null;</span>
<span class="nc" id="L3322">		PreparedStatement ps = null;</span>
<span class="nc" id="L3323">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L3326">			URI uri = new URI(url);</span>
<span class="nc" id="L3327">			String path = uri.getPath();</span>
			//ziskaj udaje z db
<span class="nc" id="L3329">			db_conn = DBPool.getConnection();</span>
<span class="nc" id="L3330">			ps = StatNewDB.prepareStatement(db_conn, sql.toString());</span>
<span class="nc" id="L3331">			ps.setString(1, &quot;%&quot;+path.toLowerCase()+&quot;%&quot;);</span>
<span class="nc" id="L3332">			rs = ps.executeQuery();</span>
			DocDetails doc;
<span class="nc" id="L3334">			int counter = 0;</span>
<span class="nc bnc" id="L3335" title="All 4 branches missed.">			while (rs.next() &amp;&amp; counter++&lt;limit)</span>
			{
<span class="nc" id="L3337">				doc = getDocDetails(rs, true, true);</span>
<span class="nc" id="L3338">				docs.add(doc);</span>
			}
<span class="nc" id="L3340">			rs.close();</span>
<span class="nc" id="L3341">			ps.close();</span>

<span class="nc" id="L3343">			db_conn.close();</span>
<span class="nc" id="L3344">			db_conn = null;</span>
<span class="nc" id="L3345">			ps = null;</span>
<span class="nc" id="L3346">			rs = null;</span>
		}
<span class="nc" id="L3348">		catch (Exception ex){Logger.error(DocDB.class, ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L3351" title="All 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="nc bnc" id="L3352" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L3353" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L3354">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}

<span class="nc" id="L3357">		return(docs);</span>
	}

	/**
	 * vrati zoznam dokumentov na schvalenie pre daneho pouzivatela
	 * @param userId
	 * @return
	 */
	public List&lt;DocDetails&gt; getDocsForApprove(int userId)
	{
<span class="fc" id="L3367">		List&lt;DocDetails&gt; docs = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L3368">		Connection db_conn = null;</span>
<span class="fc" id="L3369">		PreparedStatement ps = null;</span>
<span class="fc" id="L3370">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L3373">			db_conn = DBPool.getConnection(serverName);</span>

<span class="fc" id="L3375">			ps = db_conn.prepareStatement(&quot;SELECT dh.history_id, dh.doc_id, dh.save_date, dh.title, dh.author_id, dh.group_id, dh.available, u.title as u_title, u.first_name, u.last_name, u.email, u.photo FROM documents_history dh,  users u WHERE dh.awaiting_approve IS NOT NULL AND dh.awaiting_approve LIKE '%,&quot;+userId+&quot;,%' AND dh.author_id = u.user_id ORDER BY save_date DESC&quot;);</span>
<span class="fc" id="L3376">			rs = ps.executeQuery();</span>
			DocDetails doc;
<span class="fc" id="L3378">			GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="fc bfc" id="L3379" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="fc" id="L3381">				doc = new DocDetails();</span>
<span class="fc" id="L3382">				doc.setHistoryId(rs.getInt(&quot;history_id&quot;));</span>
<span class="fc" id="L3383">				doc.setDocId(rs.getInt(&quot;doc_id&quot;));</span>
<span class="fc" id="L3384">				doc.setAuthorId(rs.getInt(&quot;author_id&quot;));</span>
<span class="fc" id="L3385">				doc.setTitle(DB.getDbString(rs, &quot;title&quot;));</span>
<span class="fc" id="L3386">				doc.setGroupId(rs.getInt(&quot;group_id&quot;));</span>
<span class="fc" id="L3387">				doc.setNavbar(groupsDB.getNavbarNoHref(doc.getGroupId()));</span>
<span class="fc" id="L3388">				doc.setDateCreated(DB.getDbTimestamp(rs, &quot;save_date&quot;));</span>
<span class="fc" id="L3389">				doc.setAvailable(rs.getBoolean(&quot;available&quot;));</span>

<span class="fc" id="L3391">				doc.setAuthorName(getFullName(rs));</span>
<span class="fc" id="L3392">				doc.setAuthorEmail(getDbString(rs, &quot;email&quot;));</span>

<span class="fc" id="L3394">				docs.add(doc);</span>
			}
<span class="fc" id="L3396">			rs.close();</span>
<span class="fc" id="L3397">			ps.close();</span>
<span class="fc" id="L3398">			db_conn.close();</span>
<span class="fc" id="L3399">			db_conn = null;</span>
<span class="fc" id="L3400">			ps = null;</span>
<span class="fc" id="L3401">			rs = null;</span>
		}
<span class="nc" id="L3403">		catch (Exception ex){Logger.error(DocDB.class, ex);}</span>
		finally{
			try{
<span class="pc bpc" id="L3406" title="1 of 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="pc bpc" id="L3407" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L3408" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L3409">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="fc" id="L3411">		return(docs);</span>
	}

	/**
	 * Vymazanie stranky z databazy, nemaze to historiu (aby sa dalo dostat aspon k niecomu, ked sa to zmaze omylom)
	 * PRE KOREKTNE PRESUNUTIE DO KOSA POUZITE DeleteServlet.deleteDoc
	 * @param docId
	 * @param request - moze byt aj null
	 * @return
	 */
	public static boolean deleteDoc(int docId, HttpServletRequest request) {
<span class="fc" id="L3422">		return deleteDoc(docId, request, true);</span>
	}

	/**
	 * Vymazanie stranky z databazy, nemaze to historiu (aby sa dalo dostat aspon k niecomu, ked sa to zmaze omylom)
	 * PRE KOREKTNE PRESUNUTIE DO KOSA POUZITE DeleteServlet.deleteDoc
	 * @param docId
	 * @param request
	 * @param publishEvents - ak je true publikuju sa aj udalosti o zmene
	 * @return
	 */
	public static boolean deleteDoc(int docId, HttpServletRequest request, boolean publishEvents)
	{
		// ziskanie namapovanych stranok
<span class="fc" id="L3436">		List&lt;Integer&gt; slaves = MultigroupMappingDB.getSlaveDocIds(docId);</span>

<span class="fc" id="L3438">		Connection db_conn = null;</span>
<span class="fc" id="L3439">		PreparedStatement ps = null;</span>
		try
		{
<span class="fc" id="L3442">			DocDetails doc = DocDB.getInstance().getBasicDocDetails(docId, false);</span>
<span class="pc bpc" id="L3443" title="2 of 4 branches missed.">			if (doc!=null &amp;&amp; publishEvents) (new WebjetEvent&lt;DocDetails&gt;(doc, WebjetEventType.ON_DELETE)).publishEvent();</span>

<span class="fc" id="L3445">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L3446">			ps = db_conn.prepareStatement(&quot;DELETE FROM documents WHERE doc_id=?&quot;);</span>
<span class="fc" id="L3447">			ps.setInt(1, docId);</span>
<span class="fc" id="L3448">			ps.execute();</span>
<span class="fc" id="L3449">			ps.close();</span>

			// zmazanie namapovanych stranok
<span class="pc bpc" id="L3452" title="1 of 2 branches missed.">			for (Integer slave : slaves) {</span>
<span class="nc" id="L3453">				 ps.setInt(1, slave);</span>
<span class="nc" id="L3454">				 ps.execute();</span>
<span class="nc" id="L3455">				 DocDB.getInstance().updateInternalCaches(slave);</span>
<span class="nc" id="L3456">			}</span>

			//zmazem aj pripadne zaznamy z perex_group_doc
<span class="fc" id="L3459">			ps = db_conn.prepareStatement(&quot;DELETE FROM perex_group_doc WHERE doc_id=?&quot;);</span>
<span class="fc" id="L3460">			ps.setInt(1, docId);</span>
<span class="fc" id="L3461">			ps.execute();</span>
<span class="fc" id="L3462">			ps.close();</span>

<span class="pc bpc" id="L3464" title="3 of 4 branches missed.">			if (Constants.DB_TYPE == Constants.DB_MSSQL &amp;&amp; Constants.getBoolean(&quot;jtdsCommit&quot;))</span>
			{
<span class="nc" id="L3466">				db_conn.commit();</span>
			}
<span class="fc" id="L3468">			db_conn.close();</span>

			//zmaz zapisane hodnoty mapovania z tabulky 'multigroup_mapping'
<span class="fc" id="L3471">			MultigroupMappingDB.deleteSlaves(docId);</span>

<span class="fc" id="L3473">			DocDB.getInstance().updateInternalCaches(docId);</span>

<span class="pc bpc" id="L3475" title="2 of 4 branches missed.">			if (doc!=null &amp;&amp; publishEvents) (new WebjetEvent&lt;DocDetails&gt;(doc, WebjetEventType.AFTER_DELETE)).publishEvent();</span>

<span class="fc" id="L3477">			db_conn = null;</span>
<span class="fc" id="L3478">			ps = null;</span>
<span class="fc" id="L3479">			return(true);</span>
		}
<span class="nc" id="L3481">		catch (Exception ex){Logger.error(DocDB.class, ex);}</span>
		finally{
			try{
<span class="pc bpc" id="L3484" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L3485" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L3486">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="nc" id="L3488">		return(false);</span>
	}

	/**
	 * Naplni DocDetails z ResultSetu, je treba spravit join medzi documents a users
	 * @param rs
	 * @param noData
	 * @return
	 */
	public static DocDetails getDocDetails(ResultSet rs, boolean noData)
	{
<span class="fc" id="L3499">		DocDetails doc = new DocDetails();</span>
<span class="fc" id="L3500">		getDocDetails(rs, doc, noData, false);</span>
<span class="fc" id="L3501">		return(doc);</span>

	}

	/**
	 * Naplni DocDetails z ResultSetu
	 * @param rs
	 * @param noData - ak je true nevracia sa data hodnota
	 * @param noAuthor - ak je true nevracia sa autor (SQL nemusi robit JOIN na tabulku users)
	 * @return
	 */
	public static DocDetails getDocDetails(ResultSet rs, boolean noData, boolean noAuthor)
	{
<span class="fc" id="L3514">		DocDetails doc = new DocDetails();</span>
<span class="fc" id="L3515">		getDocDetails(rs, doc, noData, noAuthor);</span>
<span class="fc" id="L3516">		return(doc);</span>
	}

	/**
	 * Naplni DocDetails z ResultSetu
	 * @param rs
	 * @param doc
	 * @param noData - ak je true nevracia sa data hodnota
	 * @param noAuthor - ak je true nevracia sa autor (SQL nemusi robit JOIN na tabulku users)
	 */
	public static void getDocDetails(ResultSet rs, DocDetails doc, boolean noData, boolean noAuthor)
	{
		try
		{
<span class="fc" id="L3530">			doc.setDocId(rs.getInt(&quot;doc_id&quot;));</span>
<span class="fc bfc" id="L3531" title="All 2 branches covered.">			if (noData)</span>
			{
<span class="fc" id="L3533">				doc.setData(WebpagesService.DATA_NOT_LOADED);</span>
			}
			else
			{
<span class="fc" id="L3537">				doc.setData(DB.getDbString(rs, &quot;data&quot;));</span>
			}

<span class="fc" id="L3540">			doc.setDateCreated(DB.getDbTimestamp(rs, &quot;date_created&quot;));</span>
<span class="fc" id="L3541">			doc.setPublishStart(DB.getDbTimestamp(rs, &quot;publish_start&quot;));</span>
<span class="fc" id="L3542">			doc.setPublishEnd(DB.getDbTimestamp(rs, &quot;publish_end&quot;));</span>
<span class="fc" id="L3543">			doc.setAuthorId(rs.getInt(&quot;author_id&quot;));</span>
			try
			{
<span class="fc bfc" id="L3546" title="All 2 branches covered.">				if (noAuthor == false)</span>
				{
<span class="fc" id="L3548">					doc.setAuthorName(getFullName(rs));</span>
<span class="fc" id="L3549">					doc.setAuthorEmail(getDbString(rs, &quot;email&quot;));</span>
<span class="fc" id="L3550">                    doc.setAuthorPhoto(getDbString(rs, &quot;photo&quot;));</span>
				}
			}
<span class="nc" id="L3553">			catch (Exception ex)</span>
			{
				// asi to nebolo JOINute na users...
<span class="fc" id="L3556">			}</span>

<span class="fc" id="L3558">			doc.setSearchable(rs.getBoolean(&quot;searchable&quot;));</span>
<span class="fc" id="L3559">			doc.setGroupId(rs.getInt(&quot;group_id&quot;));</span>
<span class="fc" id="L3560">			doc.setAvailable(rs.getBoolean(&quot;available&quot;));</span>
<span class="fc" id="L3561">			doc.setShowInMenu(rs.getBoolean(&quot;show_in_menu&quot;));</span>
<span class="fc" id="L3562">			doc.setPasswordProtected(getDbString(rs, &quot;password_protected&quot;));</span>

<span class="fc" id="L3564">			doc.setCacheable(rs.getBoolean(&quot;cacheable&quot;));</span>
<span class="fc" id="L3565">			doc.setExternalLink(getDbString(rs, &quot;external_link&quot;));</span>
<span class="fc" id="L3566">			doc.setVirtualPath(getDbString(rs, &quot;virtual_path&quot;));</span>
<span class="fc" id="L3567">			doc.setTempId(rs.getInt(&quot;temp_id&quot;));</span>
<span class="fc" id="L3568">			doc.setTitle(getDbString(rs, &quot;title&quot;));</span>
<span class="fc" id="L3569">			doc.setNavbar(getDbString(rs, &quot;navbar&quot;));</span>
<span class="fc" id="L3570">			doc.setFileName(getDbString(rs, &quot;file_name&quot;));</span>
<span class="fc" id="L3571">			doc.setSortPriority(rs.getInt(&quot;sort_priority&quot;));</span>
<span class="fc" id="L3572">			doc.setHeaderDocId(rs.getInt(&quot;header_doc_id&quot;));</span>
<span class="fc" id="L3573">			doc.setFooterDocId(rs.getInt(&quot;footer_doc_id&quot;));</span>
<span class="fc" id="L3574">			doc.setMenuDocId(rs.getInt(&quot;menu_doc_id&quot;));</span>
<span class="fc" id="L3575">			doc.setRightMenuDocId(rs.getInt(&quot;right_menu_doc_id&quot;));</span>

<span class="fc" id="L3577">			doc.setHtmlHead(getDbString(rs, &quot;html_head&quot;));</span>
<span class="fc" id="L3578">			doc.setHtmlData(getDbString(rs, &quot;html_data&quot;));</span>
<span class="fc" id="L3579">			doc.setPerexPlace(getDbString(rs, &quot;perex_place&quot;));</span>
<span class="fc" id="L3580">			doc.setPerexImage(getDbString(rs, &quot;perex_image&quot;));</span>
<span class="fc" id="L3581">			doc.setPerexGroupString(getDbString(rs, &quot;perex_group&quot;));</span>

<span class="fc" id="L3583">			doc.setEventDate(DB.getDbTimestamp(rs, &quot;event_date&quot;));</span>

<span class="fc" id="L3585">			doc.setSyncId(rs.getInt(&quot;sync_id&quot;));</span>
<span class="fc" id="L3586">			doc.setSyncStatus(rs.getInt(&quot;sync_status&quot;));</span>

<span class="fc" id="L3588">			doc.setFieldA(DB.getDbString(rs, &quot;field_a&quot;));</span>
<span class="fc" id="L3589">			doc.setFieldB(DB.getDbString(rs, &quot;field_b&quot;));</span>
<span class="fc" id="L3590">			doc.setFieldC(DB.getDbString(rs, &quot;field_c&quot;));</span>
<span class="fc" id="L3591">			doc.setFieldD(DB.getDbString(rs, &quot;field_d&quot;));</span>
<span class="fc" id="L3592">			doc.setFieldE(DB.getDbString(rs, &quot;field_e&quot;));</span>
<span class="fc" id="L3593">			doc.setFieldF(DB.getDbString(rs, &quot;field_f&quot;));</span>

<span class="fc" id="L3595">			doc.setFieldG(DB.getDbString(rs, &quot;field_g&quot;));</span>
<span class="fc" id="L3596">			doc.setFieldH(DB.getDbString(rs, &quot;field_h&quot;));</span>
<span class="fc" id="L3597">			doc.setFieldI(DB.getDbString(rs, &quot;field_i&quot;));</span>
<span class="fc" id="L3598">			doc.setFieldJ(DB.getDbString(rs, &quot;field_j&quot;));</span>
<span class="fc" id="L3599">			doc.setFieldK(DB.getDbString(rs, &quot;field_k&quot;));</span>
<span class="fc" id="L3600">			doc.setFieldL(DB.getDbString(rs, &quot;field_l&quot;));</span>

<span class="fc" id="L3602">			doc.setDisableAfterEnd(rs.getBoolean(&quot;disable_after_end&quot;));</span>

<span class="fc" id="L3604">			doc.setForumCount(rs.getInt(&quot;forum_count&quot;));</span>

<span class="fc" id="L3606">			doc.setViewsTotal(rs.getInt(&quot;views_total&quot;));</span>

<span class="fc" id="L3608">			doc.setFieldM(DB.getDbString(rs, &quot;field_m&quot;));</span>
<span class="fc" id="L3609">			doc.setFieldN(DB.getDbString(rs, &quot;field_n&quot;));</span>
<span class="fc" id="L3610">			doc.setFieldO(DB.getDbString(rs, &quot;field_o&quot;));</span>
<span class="fc" id="L3611">			doc.setFieldP(DB.getDbString(rs, &quot;field_p&quot;));</span>
<span class="fc" id="L3612">			doc.setFieldQ(DB.getDbString(rs, &quot;field_q&quot;));</span>
<span class="fc" id="L3613">			doc.setFieldR(DB.getDbString(rs, &quot;field_r&quot;));</span>
<span class="fc" id="L3614">			doc.setFieldS(DB.getDbString(rs, &quot;field_s&quot;));</span>
<span class="fc" id="L3615">			doc.setFieldT(DB.getDbString(rs, &quot;field_t&quot;));</span>

<span class="fc" id="L3617">			doc.setRequireSsl(rs.getBoolean(&quot;require_ssl&quot;));</span>

<span class="fc" id="L3619">			DataAccessHelper.docLoadData(rs, doc);</span>
		}
<span class="nc" id="L3621">		catch (Exception re)</span>
		{
			//
<span class="fc" id="L3624">		}</span>
<span class="fc" id="L3625">	}</span>

	/**
	 * Vrati DocDetails podla adresara a nazvu, alebo ak nenajde/nie je zadane podla syncId
	 * @param syncId - hodnota docId na remote serveri
	 * @return
	 */
	public DocDetails getDocBySync(int syncId, int groupId, String title, String remoteFullPath, String syncDefaultForGroupId)
	{
<span class="nc bnc" id="L3634" title="All 4 branches missed.">		if (Tools.isNotEmpty(title) &amp;&amp; groupId &gt; 0)</span>
		{
			//skusme najst podla mena
<span class="nc" id="L3637">			GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="nc" id="L3638">			GroupDetails parentGroup = groupsDB.getGroupBySync(remoteFullPath, groupId);</span>
<span class="nc bnc" id="L3639" title="All 2 branches missed.">			if (parentGroup != null)</span>
			{
<span class="nc" id="L3641">				List&lt;DocDetails&gt; docsByGroup = getDocByGroup(parentGroup.getGroupId());</span>
<span class="nc" id="L3642">				DocDetails localDefaultDoc = null;</span>
<span class="nc bnc" id="L3643" title="All 2 branches missed.">				for (DocDetails docByName : docsByGroup)</span>
				{
<span class="nc bnc" id="L3645" title="All 2 branches missed.">					if (parentGroup.getDefaultDocId()==docByName.getDocId())</span>
					{
<span class="nc" id="L3647">						localDefaultDoc = docByName;</span>
					}
<span class="nc bnc" id="L3649" title="All 2 branches missed.">					if (docByName.getTitle().equals(title))</span>
					{
<span class="nc" id="L3651">						return(docByName);</span>
					}
<span class="nc" id="L3653">				}</span>
<span class="nc bnc" id="L3654" title="All 4 branches missed.">				if (localDefaultDoc != null &amp;&amp; Tools.isNotEmpty(syncDefaultForGroupId))</span>
				{
					//nenasli sme, ale ak stranka co ju hladame je tiez default doc adresara, tak to skusme pouzit
<span class="nc" id="L3657">					StringTokenizer st = new StringTokenizer(syncDefaultForGroupId, &quot;,&quot;);</span>
					String sTmp;
					int remoteGroupId;
					GroupDetails syncGroup;
<span class="nc bnc" id="L3661" title="All 2 branches missed.">					while (st.hasMoreTokens())</span>
					{
<span class="nc" id="L3663">						sTmp = st.nextToken();</span>
						try
						{
<span class="nc" id="L3666">							remoteGroupId = Tools.getIntValue(sTmp, -1);</span>
<span class="nc bnc" id="L3667" title="All 2 branches missed.">							if (remoteGroupId &gt; 0)</span>
							{
<span class="nc" id="L3669">								syncGroup = groupsDB.getGroupBySync(null, remoteGroupId);</span>
<span class="nc bnc" id="L3670" title="All 4 branches missed.">								if (syncGroup != null &amp;&amp; parentGroup.getGroupId() == syncGroup.getGroupId())</span>
								{
<span class="nc" id="L3672">									return(localDefaultDoc);</span>
								}
							}
						}
<span class="nc" id="L3676">						catch (Exception e)</span>
						{
<span class="nc" id="L3678">							Logger.error(DocDB.class, e);</span>
<span class="nc" id="L3679">						}</span>
					}
				}
			}
		}

<span class="nc bnc" id="L3685" title="All 2 branches missed.">		if (syncId &lt; 1) return(null);</span>

<span class="nc" id="L3687">		DocDetails doc = null;</span>
<span class="nc" id="L3688">		java.sql.Connection db_conn = null;</span>
<span class="nc" id="L3689">		java.sql.PreparedStatement ps = null;</span>
<span class="nc" id="L3690">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L3693">			db_conn = DBPool.getConnectionReadUncommited();</span>

			String sql;


<span class="nc" id="L3698">			sql = &quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, u.photo, d.* FROM documents d LEFT JOIN  users u ON d.author_id=u.user_id WHERE sync_id=? ORDER BY doc_id ASC&quot;;</span>

<span class="nc" id="L3700">			ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L3701">			ps.setInt(1, syncId);</span>
<span class="nc" id="L3702">			rs = ps.executeQuery();</span>

<span class="nc bnc" id="L3704" title="All 2 branches missed.">			if (rs.next())</span>
			{
<span class="nc" id="L3706">				doc = getDocDetails(rs, false);</span>
			}

<span class="nc" id="L3709">			rs.close();</span>
<span class="nc" id="L3710">			ps.close();</span>
<span class="nc" id="L3711">			db_conn.close();</span>
<span class="nc" id="L3712">			db_conn = null;</span>
<span class="nc" id="L3713">			ps = null;</span>
<span class="nc" id="L3714">			rs = null;</span>
		}
<span class="nc" id="L3716">		catch (Exception ex){Logger.error(DocDB.class, ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L3719" title="All 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="nc bnc" id="L3720" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L3721" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L3722">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="nc" id="L3724">		return (doc);</span>
	}


	/**
	 * Ulozi perex skupinu do DB, ak je vsetko OK, vrati TRUE
	 * @param groupName - nazov perex skupiny
	 * @return
	 */
	public boolean savePerexGroup(String groupName)
	{
<span class="nc" id="L3735">		return (savePerexGroup(groupName, -1, &quot;&quot;, null));</span>
	}


	/**
	 * Ulozi perex skupinu do DB alebo vykona update, ak je vsetko OK, vrati TRUE
	 * @param groupName - nazov perex skupiny
	 * @param groupId - id perex skupiny
	 * @return
	 */
	public boolean savePerexGroup(String groupName, int groupId)
	{
<span class="nc" id="L3747">		return (savePerexGroup(groupName, groupId, &quot;&quot;, null));</span>
	}

	/**
	 * Ulozi perex skupinu do DB alebo vykona update, ak je vsetko OK, vrati TRUE
	 * @param groupName - nazov perex skupiny
	 * @param groupId - id perex skupiny
	 * @param availableGroups - skupina adresarov, pre ktore je perex skupina platna
	 * @return - &quot;1&quot; - ulozilo sa v poriadku, &quot;-1&quot; - nastal problem pri ulozeni do DB, &quot;-2&quot; - zadana group name uz existuje
	 */
	public boolean savePerexGroup(String groupName, int groupId, String availableGroups, HttpServletRequest request)
	{
<span class="nc bnc" id="L3759" title="All 4 branches missed.">		if (InitServlet.isTypeCloud() &amp;&amp; Tools.isEmpty(availableGroups))</span>
		{
<span class="nc" id="L3761">			availableGroups = String.valueOf(CloudToolsForCore.getDomainId());</span>
		}

<span class="nc" id="L3764">		String lng = &quot;&quot;;</span>
<span class="nc bnc" id="L3765" title="All 2 branches missed.">		if(request != null)</span>
<span class="nc" id="L3766">			PageLng.getUserLng(request);</span>
<span class="nc" id="L3767">		Prop prop = Prop.getInstance(lng);</span>
<span class="nc" id="L3768">		boolean result = false;</span>
<span class="nc" id="L3769">		boolean found = false;</span>
<span class="nc" id="L3770">		int resultsDb = 0;</span>
<span class="nc" id="L3771">		StringBuilder ulozeneAdresare = new StringBuilder();</span>
		try
		{
<span class="nc bnc" id="L3774" title="All 2 branches missed.">			if (Tools.isNotEmpty(groupName))</span>
			{
<span class="nc bnc" id="L3776" title="All 2 branches missed.">				if( InitServlet.isTypeCloud() ) {</span>
<span class="nc bnc" id="L3777" title="All 2 branches missed.">					if(Tools.isEmpty(availableGroups))</span>
					{
<span class="nc" id="L3779">						availableGroups = CloudToolsForCore.getDomainId() + &quot;&quot;;</span>
					}
					else
					{
<span class="nc" id="L3783">						Logger.debug(this,&quot; Removing availableGroups [ &quot;+availableGroups+&quot; ] from other domains&quot;);</span>
<span class="nc" id="L3784">						GroupDetails gd = null;</span>
<span class="nc" id="L3785">						int[] newAvailableGroupsCd = Tools.getTokensInt(availableGroups, &quot;,&quot;);</span>
<span class="nc" id="L3786">						availableGroups = &quot;,&quot;+availableGroups+&quot;,&quot;;</span>
<span class="nc" id="L3787">						boolean removeGroup = false;</span>
<span class="nc bnc" id="L3788" title="All 2 branches missed.">						for(int avgGrup : newAvailableGroupsCd)</span>
						{
<span class="nc" id="L3790">							removeGroup = false;</span>
<span class="nc bnc" id="L3791" title="All 2 branches missed.">							if((gd = GroupDetails.getById(avgGrup)) != null )</span>
							{
<span class="nc bnc" id="L3793" title="All 2 branches missed.">								if (!gd.getDomainName().equalsIgnoreCase(CloudToolsForCore.getDomainName()))</span>
<span class="nc" id="L3794">									removeGroup = true;  //vymazeme cislo zo zoznamu, pretoze je z inej domeny</span>
							}
							else
<span class="nc" id="L3797">								removeGroup = true;	//je null (nepatri do ziadnej domeny) nema tu co hladat</span>

<span class="nc bnc" id="L3799" title="All 2 branches missed.">							if(removeGroup)</span>
<span class="nc" id="L3800">								availableGroups = Tools.replace(availableGroups, &quot;,&quot;+avgGrup+&quot;,&quot;, &quot;,&quot;);</span>
						}
						//odstranim pridane ciarky
<span class="nc" id="L3803">						availableGroups = availableGroups.substring(1,availableGroups.length());</span>
						//ak bolo v availableGroups iba jedno cislo a bolo zmazane, neostala tam uz ziadna ciarka
<span class="nc bnc" id="L3805" title="All 2 branches missed.">						if(availableGroups.length() &gt; 0) availableGroups = availableGroups.substring(0,availableGroups.length()-1);</span>
					}
				}
<span class="nc" id="L3808">				PerexGroupBean pg = getPerexGroup(groupId, null);</span>

<span class="nc bnc" id="L3810" title="All 2 branches missed.">				for(PerexGroupBean pgBean : getPerexGroups())</span>
				{
					//duplicitu kontrolujem pri novej perex skupine, alebo editacii perex skupiny s ostatnymi skupinami
<span class="nc bnc" id="L3813" title="All 6 branches missed.">					if((pg == null || pg.getPerexGroupId() != pgBean.getPerexGroupId()) &amp;&amp; pgBean.getPerexGroupName().equalsIgnoreCase(groupName.trim()))</span>
					{
						//ak naslo rovnaky nazov perex skupiny, skontrolujem este aj zhodnost skupin
<span class="nc" id="L3816">						int[] pgBeanAvailableGroupsInt = pgBean.getAvailableGroupsInt();</span>
<span class="nc" id="L3817">						int[] newAvailableGroups = Tools.getTokensInt(availableGroups, &quot;,&quot;);</span>
<span class="nc" id="L3818">						GroupsDB groupsDB = GroupsDB.getInstance();</span>

						//ak je zadane pre vsetky adresare, tak je zhoda
<span class="nc bnc" id="L3821" title="All 4 branches missed.">						if(pgBeanAvailableGroupsInt.length == 0 || newAvailableGroups.length == 0)</span>
						{
<span class="nc" id="L3823">							found = true;</span>
<span class="nc bnc" id="L3824" title="All 2 branches missed.">							if(pgBeanAvailableGroupsInt.length == 0)</span>
							{
<span class="nc" id="L3826">								ulozeneAdresare.delete(0, ulozeneAdresare.length());</span>
<span class="nc" id="L3827">								ulozeneAdresare.append(prop.getText(&quot;editor.perex_group.vsetky&quot;));</span>
							}
							else
							{
<span class="nc bnc" id="L3831" title="All 2 branches missed.">								for(int groupIdTmp : pgBeanAvailableGroupsInt)</span>
<span class="nc" id="L3832">									ulozeneAdresare.append(groupsDB.getPath(groupIdTmp)).append(&quot;, &quot;);</span>
<span class="nc bnc" id="L3833" title="All 2 branches missed.">								if(Tools.isNotEmpty(ulozeneAdresare)){</span>
<span class="nc" id="L3834">									ulozeneAdresare = new StringBuilder(ulozeneAdresare.substring(0, ulozeneAdresare.length()-2));</span>
								}
							}
							break;
						}
						else
						{
<span class="nc bnc" id="L3841" title="All 2 branches missed.">							for(int groupIdTmp : pgBeanAvailableGroupsInt)</span>
							{
<span class="nc bnc" id="L3843" title="All 2 branches missed.">								if(isGroupAvailable(newAvailableGroups, groupsDB.getParentGroups(groupIdTmp)))</span>
								{
<span class="nc" id="L3845">									found = true;</span>
<span class="nc" id="L3846">									break;</span>
								}
							}
<span class="nc bnc" id="L3849" title="All 2 branches missed.">							if(found)</span>
							{
<span class="nc bnc" id="L3851" title="All 2 branches missed.">								for(int groupIdTmp : pgBeanAvailableGroupsInt)</span>
<span class="nc" id="L3852">									ulozeneAdresare.append(groupsDB.getPath(groupIdTmp)).append(&quot;, &quot;);</span>
<span class="nc bnc" id="L3853" title="All 2 branches missed.">								if(Tools.isNotEmpty(ulozeneAdresare))</span>
<span class="nc" id="L3854">									ulozeneAdresare = new StringBuilder(ulozeneAdresare.substring(0, ulozeneAdresare.length()-2));</span>
								break;
							}
						}

					}
<span class="nc" id="L3860">				}</span>

				//Logger.println(this,&quot;UPDATE: &quot; +groupName+ &quot;  &quot; +groupId);

<span class="nc bnc" id="L3864" title="All 2 branches missed.">				if (!found)</span>
				{
<span class="nc" id="L3866">					java.sql.Connection db_conn = null;</span>
<span class="nc" id="L3867">					java.sql.PreparedStatement ps = null;</span>
					try{
<span class="nc" id="L3869">						db_conn = DBPool.getConnection();</span>
						String sql;

<span class="nc bnc" id="L3872" title="All 2 branches missed.">						if (groupId &gt; 0)</span>
						{
<span class="nc" id="L3874">							sql = &quot;UPDATE perex_groups SET perex_group_name=?, available_groups=? WHERE perex_group_id=?&quot;;</span>
<span class="nc bnc" id="L3875" title="All 2 branches missed.">							if (pg!=null) Adminlog.add(Adminlog.TYPE_PEREX_GROUP_UPDATE, String.format(&quot;Zmena nazvu perex skupiny: %s =&gt; %s &quot;, pg.getPerexGroupName(), groupName), groupId, -1);</span>
<span class="nc" id="L3876">							else Adminlog.add(Adminlog.TYPE_PEREX_GROUP_UPDATE, String.format(&quot;Zmena nazvu perex skupiny: %s =&gt; %s &quot;, groupId, groupName), groupId, -1);</span>
						}
						else
						{
<span class="nc" id="L3880">							sql = &quot;INSERT INTO perex_groups (perex_group_name, available_groups) VALUES (?,?)&quot;;</span>
<span class="nc" id="L3881">							Adminlog.add(Adminlog.TYPE_PEREX_GROUP_CREATE, &quot;Vytvorena perex skupina: &quot;+groupName, groupId, -1);</span>
						}

<span class="nc" id="L3884">						ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L3885">						int ind = 1;</span>
<span class="nc" id="L3886">						ps.setString(ind++, groupName);</span>
<span class="nc" id="L3887">						ps.setString(ind++, availableGroups);</span>
<span class="nc bnc" id="L3888" title="All 2 branches missed.">						if (groupId &gt; 0)</span>
<span class="nc" id="L3889">							ps.setInt(ind++, groupId);</span>

<span class="nc" id="L3891">						resultsDb = ps.executeUpdate();</span>
<span class="nc" id="L3892">						ps.close();</span>
<span class="nc" id="L3893">						db_conn.close();</span>

<span class="nc bnc" id="L3895" title="All 2 branches missed.">						if(resultsDb &gt; 0)</span>
<span class="nc" id="L3896">							result = true;</span>
						else
<span class="nc" id="L3898">							result = false;</span>

<span class="nc" id="L3900">						db_conn = null;</span>
<span class="nc" id="L3901">						ps = null;</span>
					}
<span class="nc" id="L3903">					catch (Exception ex){Logger.error(DocDB.class, ex);}</span>
					finally{
						try{
<span class="nc bnc" id="L3906" title="All 2 branches missed.">							if (ps != null) ps.close();</span>
<span class="nc bnc" id="L3907" title="All 2 branches missed.">							if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L3908">						}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
					}
<span class="nc" id="L3910">				}</span>
				else
				{
<span class="nc bnc" id="L3913" title="All 2 branches missed.">					if(request != null)</span>
<span class="nc" id="L3914">						request.setAttribute(&quot;groupExist&quot;, prop.getText(&quot;editor.perex_group.skupina_je_uz_definovana&quot;, ulozeneAdresare.toString()));</span>
<span class="nc" id="L3915">					result = false;</span>
				}
			}
		}
<span class="nc" id="L3919">		catch (Exception ex)</span>
		{
<span class="nc" id="L3921">			result = false;</span>
<span class="nc" id="L3922">			Logger.error(DocDB.class, ex);</span>
<span class="nc" id="L3923">		}</span>

<span class="nc bnc" id="L3925" title="All 2 branches missed.">		if(resultsDb &gt; 0)</span>
<span class="nc" id="L3926">			getPerexGroups(true);</span>

<span class="nc bnc" id="L3928" title="All 2 branches missed.">		if (result) {</span>
<span class="nc" id="L3929">			ClusterDB.addRefresh(DocDB.class);</span>
		}

<span class="nc" id="L3932">		return(result);</span>
	}

	/**
	 * Vrati List s nazvami perex skupin
	 * @return
	 */
	public List&lt;PerexGroupBean&gt; getPerexGroups()
	{
<span class="fc" id="L3941">		return(getPerexGroups(false));</span>
	}


	/**
	 *  Vrati List s nazvami perex skupin
	 * @param forceRefresh
	 * @return
	 */
	public List&lt;PerexGroupBean&gt; getPerexGroups(boolean forceRefresh)
	{
<span class="pc bpc" id="L3952" title="1 of 4 branches missed.">		if (perexGroups!=null &amp;&amp; forceRefresh==false)</span>
		{
<span class="fc" id="L3954">			return(perexGroups);</span>
		}

<span class="fc" id="L3957">		List&lt;PerexGroupBean&gt; perexGroupsHolder = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L3958">		java.sql.Connection db_conn = null;</span>
<span class="fc" id="L3959">		java.sql.PreparedStatement ps = null;</span>
<span class="fc" id="L3960">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L3963">			db_conn = DBPool.getConnection();</span>
			PerexGroupBean pgBean;
			String sql;

<span class="fc" id="L3967">			sql = &quot;SELECT * FROM perex_groups ORDER BY perex_group_name ASC&quot;;</span>
<span class="fc" id="L3968">			ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L3969">			rs = ps.executeQuery();</span>
<span class="fc bfc" id="L3970" title="All 2 branches covered.">			while(rs.next())</span>
			{
<span class="fc" id="L3972">				pgBean = new PerexGroupBean();</span>
<span class="fc" id="L3973">				pgBean.setPerexGroupId(rs.getInt(&quot;perex_group_id&quot;));</span>
<span class="fc" id="L3974">				pgBean.setPerexGroupName(DB.getDbString(rs, &quot;perex_group_name&quot;));</span>
<span class="fc" id="L3975">				pgBean.setRelatedPages(DB.getDbString(rs, &quot;related_pages&quot;));</span>
<span class="fc" id="L3976">				pgBean.setAvailableGroups(DB.getDbString(rs, &quot;available_groups&quot;));</span>
<span class="fc" id="L3977">				perexGroupsHolder.add(pgBean);</span>
			}

<span class="fc" id="L3980">			rs.close();</span>
<span class="fc" id="L3981">			ps.close();</span>
<span class="fc" id="L3982">			db_conn.close();</span>
<span class="fc" id="L3983">			db_conn = null;</span>
<span class="fc" id="L3984">			ps = null;</span>
<span class="fc" id="L3985">			rs = null;</span>
		}
<span class="nc" id="L3987">		catch (Exception ex){Logger.error(DocDB.class, ex);}</span>
		finally{
			try{
<span class="pc bpc" id="L3990" title="1 of 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="pc bpc" id="L3991" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L3992" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L3993">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}

<span class="fc" id="L3996">		perexGroups = perexGroupsHolder;</span>

<span class="fc" id="L3998">		return (perexGroups);</span>
	}

	public PerexGroupBean getPerexGroupByName(String name) {
<span class="nc" id="L4002">	    List&lt;PerexGroupBean&gt; groups = getPerexGroups();</span>
        try {
<span class="nc" id="L4004">            return groups.stream().filter(i -&gt; name.equalsIgnoreCase(i.getPerexGroupName())).findFirst().get(); //NOSONAR</span>
<span class="nc" id="L4005">        } catch(Exception e) {</span>
				//
        }

<span class="nc" id="L4009">	    return null;</span>
    }

	/**
	 * Zmaze zadanu perex skupinu
	 * @param groups
	 * @return
	 */
	public boolean deletePerexGroup(String groups)
	{
		String[] groupsArray;
<span class="nc" id="L4020">		Connection db_conn = null;</span>
<span class="nc" id="L4021">		PreparedStatement ps = null;</span>
		try
		{
<span class="nc bnc" id="L4024" title="All 2 branches missed.">			if (Tools.isNotEmpty(groups))</span>
			{
<span class="nc" id="L4026">				db_conn = DBPool.getConnection();</span>

<span class="nc" id="L4028">				groupsArray = Tools.getTokens(groups, &quot;,&quot;);</span>
<span class="nc bnc" id="L4029" title="All 2 branches missed.">				for (int i=0; i&lt;groupsArray.length; i++)</span>
				{
<span class="nc" id="L4031">					int groupId = Tools.getIntValue(groupsArray[i], -1);</span>
<span class="nc" id="L4032">					PerexGroupBean perexGroup = getPerexGroup(groupId, groupsArray[i]);</span>

<span class="nc bnc" id="L4034" title="All 2 branches missed.">					if (perexGroup.getPerexGroupId() &lt; 0) continue;</span>
<span class="nc" id="L4035">					ps = db_conn.prepareStatement(&quot;DELETE FROM perex_groups WHERE perex_group_id=?&quot;);</span>
<span class="nc" id="L4036">					ps.setInt(1, perexGroup.getPerexGroupId()) ;</span>
<span class="nc" id="L4037">					ps.execute();</span>
<span class="nc" id="L4038">					ps.close();</span>

					//zmazem aj pripadne zaznamy z perex_group_doc
<span class="nc" id="L4041">					ps = db_conn.prepareStatement(&quot;DELETE FROM perex_group_doc WHERE perex_group_id=?&quot;);</span>
<span class="nc" id="L4042">					ps.setInt(1, perexGroup.getPerexGroupId());</span>
<span class="nc" id="L4043">					ps.execute();</span>
<span class="nc" id="L4044">					ps.close();</span>

<span class="nc" id="L4046">					Adminlog.add(Adminlog.TYPE_PEREX_GROUP_DELETE, &quot;Zmazana perex skupina: &quot;+perexGroup.getPerexGroupName()+&quot; id=&quot;+perexGroup.getPerexGroupId(), perexGroup.getPerexGroupId(), -1);</span>
					//Logger.println(this,&quot;Deleting &quot;+groupsArray[i]+&quot;, result: &quot;+result);
				}

<span class="nc" id="L4050">				db_conn.close();</span>

<span class="nc" id="L4052">				getPerexGroups(true);</span>

<span class="nc" id="L4054">				return(true);</span>
			}
<span class="nc" id="L4056">			db_conn = null;</span>
<span class="nc" id="L4057">			ps = null;</span>
		}
<span class="nc" id="L4059">		catch (Exception ex){Logger.error(DocDB.class, ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L4062" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L4063" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L4064">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="nc" id="L4066">		getPerexGroups(true);</span>
<span class="nc" id="L4067">		return (false);</span>
	}


	/**
	 * Vrati perex skupinu, bud sa zada id alebo name, ak su obe, tak sa zoberie id
	 * @param groupId - ak je -1 zoberiem name
	 * @param groupName
	 * @return
	 */
	public PerexGroupBean getPerexGroup(int groupId, String groupName)
	{
<span class="pc bpc" id="L4079" title="1 of 2 branches missed.">		for(PerexGroupBean pgBean : getPerexGroups())</span>
		{
<span class="pc bpc" id="L4081" title="1 of 2 branches missed.">			if (groupId&gt;0)</span>
			{
<span class="fc bfc" id="L4083" title="All 2 branches covered.">				if (pgBean.getPerexGroupId()==groupId)</span>
				{
<span class="fc" id="L4085">					return(pgBean);</span>
				}
			}
<span class="nc bnc" id="L4088" title="All 4 branches missed.">			else if (Tools.isNotEmpty(groupName) &amp;&amp; pgBean.getPerexGroupName().equalsIgnoreCase(groupName))</span>
			{
<span class="nc" id="L4090">				return(pgBean);</span>
			}
<span class="fc" id="L4092">		}</span>
<span class="nc" id="L4093">		return(new PerexGroupBean());</span>
	}

	/**
	 * Skonvertuje ID skupiny na meno
	 * @param perexGroupId
	 * @return
	 */
	public String convertPerexGroupIdToName(int perexGroupId)
	{
<span class="fc" id="L4103">		PerexGroupBean pgBean = getPerexGroup(perexGroupId, null);</span>
<span class="pc bpc" id="L4104" title="1 of 2 branches missed.">		if (pgBean == null) return null;</span>
<span class="fc" id="L4105">		return(pgBean.getPerexGroupName());</span>
	}

	/**
	 * Skonvertuje z pola IDecok perex skupin na retazec nazvov
	 * @param perexGroupIds
	 * @return
	 */
	public String convertPerexGroupIdsToNames(String[] perexGroupIds)
	{
<span class="nc bnc" id="L4115" title="All 4 branches missed.">		if (perexGroupIds == null || perexGroupIds.length&lt;1) return &quot;&quot;;</span>
<span class="nc" id="L4116">		int size = perexGroupIds.length;</span>
<span class="nc" id="L4117">		StringBuilder perexGroupNames = new StringBuilder();</span>
		int i;
<span class="nc bnc" id="L4119" title="All 2 branches missed.">		for (i=0; i&lt;size; i++)</span>
		{
<span class="nc" id="L4121">			String name = convertPerexGroupIdToName(perexGroupIds[i]);</span>
<span class="nc bnc" id="L4122" title="All 2 branches missed.">			if (perexGroupNames.length()&gt;0) perexGroupNames.append(&quot;, &quot;);</span>
<span class="nc bnc" id="L4123" title="All 2 branches missed.">			if (Tools.isNotEmpty(name)) perexGroupNames.append(name);</span>
		}
<span class="nc" id="L4125">		return perexGroupNames.toString();</span>
	}

	/**
	 * Skonvertuje z pola IDecok perex skupin na retazec nazvov
	 * @param perexGroupIds
	 * @return
	 */
	public String convertPerexGroupIdsToNames(int[] perexGroupIds)
	{
<span class="nc bnc" id="L4135" title="All 4 branches missed.">		if (perexGroupIds == null || perexGroupIds.length&lt;1) return &quot;&quot;;</span>
<span class="nc" id="L4136">		int size = perexGroupIds.length;</span>
<span class="nc" id="L4137">		StringBuilder perexGroupNames = new StringBuilder();</span>
		int i;
<span class="nc bnc" id="L4139" title="All 2 branches missed.">		for (i=0; i&lt;size; i++)</span>
		{
<span class="nc" id="L4141">			String name = convertPerexGroupIdToName(perexGroupIds[i]);</span>
<span class="nc bnc" id="L4142" title="All 2 branches missed.">			if (perexGroupNames.length()&gt;0) perexGroupNames.append(&quot;, &quot;);</span>
<span class="nc bnc" id="L4143" title="All 2 branches missed.">			if (Tools.isNotEmpty(name)) perexGroupNames.append(name);</span>
		}
<span class="nc" id="L4145">		return perexGroupNames.toString();</span>
	}

	/**
	 * Skonvertuje ID skupiny na meno (id je ako String)
	 * @param perexGroupId
	 * @return
	 */
	public String convertPerexGroupIdToName(String perexGroupId)
	{
<span class="fc" id="L4155">		int i = Tools.getIntValue(perexGroupId, -1);</span>
<span class="pc bpc" id="L4156" title="1 of 2 branches missed.">		if (i&gt;0)</span>
		{
<span class="fc" id="L4158">			return(convertPerexGroupIdToName(i));</span>
		}
		//ak by nahodou to ID bolo nejake zmyslu plne, vratme to
<span class="nc" id="L4161">		return(perexGroupId);</span>
	}

	/**
	 * Skonvertuje nazov skupiny na id
	 *
	 * @author kmarton
	 * @param perexGroupName meno skupiny, ktorej chceme ziskat identifikator
	 *
	 * @return -1 ak sa take meno nenaslo, inak vrati identifikator skupiny
	 */
	public int convertPerexGroupNameToId(String perexGroupName)
	{
<span class="nc" id="L4174">		PerexGroupBean pgBean = getPerexGroup(-1, perexGroupName);</span>
<span class="nc" id="L4175">		int perexGroupId = pgBean.getPerexGroupId();</span>

<span class="nc bnc" id="L4177" title="All 2 branches missed.">		if (perexGroupId &gt; 0)</span>
<span class="nc" id="L4178">			return(perexGroupId);</span>
		else
<span class="nc" id="L4180">			return -1;</span>
	}

	/**
	 *
	 * @param rootGroupId
	 * @param time
	 * @return
	 */
	public static String getDateTimeCreatedString(int rootGroupId, boolean time)
	{
<span class="nc" id="L4191">		StringBuilder ret = new StringBuilder();</span>
		List&lt;GroupDetails&gt; searchGroupsArray;
<span class="nc" id="L4193">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="nc" id="L4194">		StringBuilder searchGroups = null;</span>
<span class="nc" id="L4195">		long dateTime = 0;</span>
		java.text.SimpleDateFormat formatter;
		java.text.SimpleDateFormat timeFormatter;

<span class="nc" id="L4199">		formatter = new java.text.SimpleDateFormat(sk.iway.iwcm.Constants.getString(&quot;dateFormat&quot;));</span>
<span class="nc" id="L4200">		timeFormatter = new java.text.SimpleDateFormat(&quot;H:mm&quot;);</span>

<span class="nc" id="L4202">		java.sql.Connection db_conn = null;</span>
<span class="nc" id="L4203">		java.sql.PreparedStatement ps = null;</span>
<span class="nc" id="L4204">		ResultSet rs = null;</span>
		try
		{
<span class="nc bnc" id="L4207" title="All 2 branches missed.">			if (rootGroupId &lt; 1)</span>
<span class="nc" id="L4208">				rootGroupId = 1;</span>

<span class="nc" id="L4210">			db_conn = DBPool.getConnection();</span>
			StringBuilder sql;

<span class="nc" id="L4213">			searchGroupsArray = groupsDB.getGroupsTree(rootGroupId, true, false);</span>
<span class="nc bnc" id="L4214" title="All 2 branches missed.">			for (GroupDetails group : searchGroupsArray)</span>
			{
<span class="nc bnc" id="L4216" title="All 2 branches missed.">				if (group != null)</span>
				{
<span class="nc bnc" id="L4218" title="All 2 branches missed.">					if (searchGroups == null)</span>
					{
<span class="nc" id="L4220">						searchGroups = new StringBuilder(String.valueOf(group.getGroupId()));</span>
					}
					else
					{
<span class="nc" id="L4224">						searchGroups.append(',').append(group.getGroupId());</span>
					}
				}
<span class="nc" id="L4227">			}</span>

<span class="nc" id="L4229">			sql = new StringBuilder(&quot;SELECT max(date_created) as last_update FROM documents&quot;);</span>

<span class="nc bnc" id="L4231" title="All 2 branches missed.">			if (searchGroups != null)</span>
			{
<span class="nc" id="L4233">				sql.append(&quot; WHERE group_id IN (&quot;).append(getOnlyNumbersIn(searchGroups.toString(),true)).append(')');</span>
			}


<span class="nc" id="L4237">			ps = db_conn.prepareStatement(sql.toString());</span>
<span class="nc" id="L4238">			rs = ps.executeQuery();</span>
<span class="nc bnc" id="L4239" title="All 2 branches missed.">			if(rs.next())</span>
			{

<span class="nc" id="L4242">				dateTime = DB.getDbTimestamp(rs, &quot;last_update&quot;);</span>

			}

<span class="nc" id="L4246">			ret = new StringBuilder(formatter.format(new java.util.Date(dateTime)));</span>
<span class="nc bnc" id="L4247" title="All 2 branches missed.">			if(time)</span>
			{
<span class="nc" id="L4249">				ret.append(&quot;  &quot;).append(timeFormatter.format(new java.util.Date(dateTime)));</span>
			}

<span class="nc" id="L4252">			rs.close();</span>
<span class="nc" id="L4253">			ps.close();</span>
<span class="nc" id="L4254">			db_conn.close();</span>
<span class="nc" id="L4255">			db_conn = null;</span>
<span class="nc" id="L4256">			ps = null;</span>
<span class="nc" id="L4257">			rs = null;</span>
		}
<span class="nc" id="L4259">		catch (Exception ex){Logger.error(DocDB.class, ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L4262" title="All 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="nc bnc" id="L4263" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L4264" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L4265">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="nc" id="L4267">		return (ret.toString());</span>
	}

	/**
	 * Vrati zoznam roznych hodnot v danom fielde, pouziva sa na rendering selectu pre hodnoty vo field_X
	 * @param field
	 * @return
	 */
	public static List&lt;String&gt; getFieldDistinctValues(String field)
	{
<span class="nc" id="L4277">		List&lt;String&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L4278">		Connection db_conn = null;</span>
<span class="nc" id="L4279">		PreparedStatement ps = null;</span>
<span class="nc" id="L4280">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L4283">			db_conn = DBPool.getConnection();</span>
<span class="nc" id="L4284">			ps = db_conn.prepareStatement(&quot;SELECT DISTINCT &quot;+field+&quot; as field_value FROM documents ORDER BY &quot; + field);</span>
<span class="nc" id="L4285">			rs = ps.executeQuery();</span>
			String value;
<span class="nc bnc" id="L4287" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L4289">				value = DB.getDbString(rs, &quot;field_value&quot;);</span>
<span class="nc bnc" id="L4290" title="All 2 branches missed.">				if (Tools.isNotEmpty(value))</span>
				{
<span class="nc" id="L4292">					ret.add(value);</span>
				}
			}
<span class="nc" id="L4295">			rs.close();</span>
<span class="nc" id="L4296">			ps.close();</span>
<span class="nc" id="L4297">			rs = null;</span>
<span class="nc" id="L4298">			ps = null;</span>
		}
<span class="nc" id="L4300">		catch (Exception ex)</span>
		{
<span class="nc" id="L4302">			Logger.error(DocDB.class, ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L4308" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L4309">					db_conn.close();</span>
<span class="nc bnc" id="L4310" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L4311">					rs.close();</span>
<span class="nc bnc" id="L4312" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L4313">					ps.close();</span>
			}
<span class="nc" id="L4315">			catch (Exception ex2)</span>
			{
<span class="nc" id="L4317">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L4318">			}</span>
		}
<span class="nc" id="L4320">		return(ret);</span>
	}

	/**
	 * Zistenie ci stranku mozeme povazovat za novu, zmenenu alebo nemodifikovanu
	 *
	 * nova je taka, ktora nema historiu starsiu ako zadany pocet dni
	 * zmenena je taka, kde doslo za zadany pocet dni k zmene
	 *
	 * @param docId - id stranky
	 * @param minDaysNotChanged - pocet dni, pocas ktorych nesmelo dojst k zmene
	 * @param maxDaysTestChanged - maximalny pocet dni, ktore sa testuju na zmenu (ak v tomto rozsahu nie je ziadna zmena, je dokument bezo zmeny)
	 * @return 0=bez zmeny, 1=nova, 2=zmenena
	 */
	public static int getPageNewChangedStatus(int docId, int minDaysNotChanged, int maxDaysTestChanged)
	{
<span class="fc" id="L4336">		int status = 0;</span>
<span class="fc" id="L4337">		Connection db_conn = null;</span>
<span class="fc" id="L4338">		PreparedStatement ps = null;</span>
<span class="fc" id="L4339">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L4342">			Calendar cal = Calendar.getInstance();</span>
<span class="fc" id="L4343">			cal.add(Calendar.DAY_OF_YEAR, -minDaysNotChanged);</span>
<span class="fc" id="L4344">			long dateNewStart = cal.getTime().getTime();</span>

			//Logger.println(this,&quot;dateNewStart&quot;+Tools.formatDateTime(dateNewStart));

			//cal = Calendar.getInstance();
<span class="fc" id="L4349">			cal.add(Calendar.DAY_OF_YEAR, -maxDaysTestChanged);</span>
<span class="fc" id="L4350">			long dateChangedStart = cal.getTime().getTime();</span>


			//Logger.println(this,&quot;dateChangedStart&quot;+Tools.formatDateTime(dateChangedStart));

<span class="fc" id="L4355">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L4356">			ps = db_conn.prepareStatement(&quot;SELECT save_date, actual FROM documents_history WHERE doc_id=? AND awaiting_approve IS NULL ORDER BY save_date DESC&quot;);</span>
<span class="fc" id="L4357">			ps.setInt(1, docId);</span>
			//ps.setTimestamp(2, new Timestamp(dateChangedStart));
<span class="fc" id="L4359">			rs = ps.executeQuery();</span>
<span class="fc" id="L4360">			boolean actual = false;</span>
			long saveDate;
<span class="fc bfc" id="L4362" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="pc bpc" id="L4364" title="1 of 2 branches missed.">				if (!actual)</span>
				{
<span class="fc" id="L4366">					actual = rs.getBoolean(&quot;actual&quot;);</span>
				}
				//tu nemoze byt else, inak by to nezbehlo ak je len jedna zmena v DB
<span class="pc bpc" id="L4369" title="1 of 2 branches missed.">				if (actual)</span>
				{
<span class="fc" id="L4371">					saveDate = rs.getTimestamp(&quot;save_date&quot;).getTime();</span>
					//Logger.println(this,&quot;saveDate&quot;+Tools.formatDateTime(saveDate));
<span class="pc bpc" id="L4373" title="1 of 2 branches missed.">					if (saveDate &gt; dateNewStart)</span>
					{
						//predpokladame, ze je nova
<span class="fc" id="L4376">						status = 1;</span>
					}
<span class="nc bnc" id="L4378" title="All 2 branches missed.">					else if (saveDate &lt; dateChangedStart)</span>
					{
						//ak sme ju mali ako novu a narazili sme na datum po rozsahu maxDaysTestChanged, nie je nova, ale zmenena
<span class="nc bnc" id="L4381" title="All 2 branches missed.">						if (status == 1) status = 2;</span>
						break;
					}
					else
					{
<span class="nc" id="L4386">						status = 2;</span>
<span class="nc" id="L4387">						break;</span>
					}
					//Logger.println(this,&quot;nastavujem[&quot;+docId+&quot;]: &quot; + status);
				}

			}
<span class="fc" id="L4393">			rs.close();</span>
<span class="fc" id="L4394">			ps.close();</span>
<span class="fc" id="L4395">			rs = null;</span>
<span class="fc" id="L4396">			ps = null;</span>
		}
<span class="nc" id="L4398">		catch (Exception ex)</span>
		{
<span class="nc" id="L4400">			Logger.error(DocDB.class, ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L4406" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="fc" id="L4407">					db_conn.close();</span>
<span class="pc bpc" id="L4408" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L4409">					rs.close();</span>
<span class="pc bpc" id="L4410" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L4411">					ps.close();</span>
			}
<span class="nc" id="L4413">			catch (Exception ex2)</span>
			{
<span class="nc" id="L4415">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L4416">			}</span>
		}

<span class="fc" id="L4419">		return(status);</span>
	}

	/** vrati najvacsiu prioritu so vsetkych dokumentov v skupine
	 * @param groupId
	 * @return
	 */
	public static int getMaxSortPriorityInGroup(int groupId) {
<span class="fc" id="L4427">		int maxP = 0;</span>
<span class="fc" id="L4428">		Connection db_conn = null;</span>
<span class="fc" id="L4429">		PreparedStatement ps = null;</span>
<span class="fc" id="L4430">		ResultSet rs = null;</span>
		try
		{


<span class="fc" id="L4435">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L4436">			ps = db_conn.prepareStatement(&quot;select max(sort_priority) as max,group_id from documents where group_id = ? group by group_id&quot;);</span>
<span class="fc" id="L4437">			ps.setInt(1, groupId);</span>

<span class="fc" id="L4439">			rs = ps.executeQuery();</span>

<span class="fc bfc" id="L4441" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="fc" id="L4443">				maxP = rs.getInt(&quot;max&quot;);</span>
			}
<span class="fc" id="L4445">			rs.close();</span>
<span class="fc" id="L4446">			ps.close();</span>
<span class="fc" id="L4447">			rs = null;</span>
<span class="fc" id="L4448">			ps = null;</span>
		}
<span class="nc" id="L4450">		catch (Exception ex)</span>
		{
<span class="nc" id="L4452">			Logger.error(DocDB.class, ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L4458" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="fc" id="L4459">					db_conn.close();</span>
<span class="pc bpc" id="L4460" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L4461">					rs.close();</span>
<span class="pc bpc" id="L4462" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L4463">					ps.close();</span>
			}
<span class="nc" id="L4465">			catch (Exception ex2)</span>
			{
<span class="nc" id="L4467">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L4468">			}</span>
		}

<span class="fc" id="L4471">		return(maxP);</span>
	}

	/**
	 * Otestuje, ci stranka je pristupna aktualne prihlasenemu clovekovi
	 * @param doc
	 * @param user
	 * @return
	 */
	public static boolean canAccess(DocDetails doc, Identity user)
	{
<span class="fc" id="L4482">		return canAccess(doc, user, false);</span>
	}

	/**
	 * Otestuje, ci stranka je pristupna aktualne prihlasenemu clovekovi
	 * @param doc
	 * @param user
	 * @param checkGroup - ak je nastavene na true, skontroluju sa aj prava nastavene pre adresar
	 * @return
	 */
	public static boolean canAccess(DocDetails doc, Identity user, boolean checkGroup)
	{
		//aby sme nemenili hodnoty pre BasicDocDetails
<span class="fc" id="L4495">		String passwordProtected = doc.getPasswordProtected();</span>

<span class="pc bpc" id="L4497" title="1 of 4 branches missed.">		if (checkGroup &amp;&amp; Tools.isEmpty(passwordProtected))</span>
		{
<span class="fc" id="L4499">			GroupDetails group = GroupsDB.getInstance().getGroup(doc.getGroupId());</span>
<span class="pc bpc" id="L4500" title="1 of 2 branches missed.">			if (group != null)</span>
			{
<span class="fc" id="L4502">				passwordProtected = group.getPasswordProtected();</span>
			}
		}

<span class="fc bfc" id="L4506" title="All 2 branches covered.">		if (Tools.isEmpty(passwordProtected)) return(true);</span>

<span class="fc bfc" id="L4508" title="All 2 branches covered.">		if (user == null)</span>
		{
			//tu nemozeme vratit false, pretoze doc moze mat nastavene len email skupiny
<span class="fc" id="L4511">			user = new Identity();</span>
		}

<span class="fc" id="L4514">		Logger.debug(DocDB.class, &quot;doc(&quot;+doc.getDocId()+&quot;).getPasswordProtected()=&quot;+passwordProtected);</span>
		//zisti ci dany user ma pravo na skupinu pre web stranku
<span class="fc" id="L4516">		boolean canAccess = false;</span>
<span class="fc bfc" id="L4517" title="All 2 branches covered.">		if (Tools.isNotEmpty(user.getUserGroupsIds()))</span>
		{
<span class="fc" id="L4519">			Logger.debug(DocDB.class,&quot;doc perms=&quot;+passwordProtected+&quot; user=&quot;+user.getUserGroupsIds()+&quot; userid=&quot;+user.getUserId());</span>
<span class="fc" id="L4520">			StringTokenizer st = new StringTokenizer(user.getUserGroupsIds(), &quot;,&quot;);</span>
<span class="fc" id="L4521">			String passwordProtected2 = &quot;,&quot; + passwordProtected + &quot;,&quot;;</span>
<span class="fc bfc" id="L4522" title="All 2 branches covered.">			while (st.hasMoreTokens())</span>
			{
<span class="fc bfc" id="L4524" title="All 2 branches covered.">				if (passwordProtected2.indexOf(&quot;,&quot; + st.nextToken() + &quot;,&quot;) != -1)</span>
				{
<span class="fc" id="L4526">					Logger.debug(DocDB.class, &quot;canAccess=true&quot;);</span>
<span class="fc" id="L4527">					canAccess = true;</span>
<span class="fc" id="L4528">					break;</span>
				}
			}
		}

<span class="fc bfc" id="L4533" title="All 2 branches covered.">		if (!canAccess)</span>
		{
			//otestuj, ci stranka nema nastavene len email skupiny
<span class="fc" id="L4536">			StringTokenizer st = new StringTokenizer(passwordProtected, &quot;,&quot;);</span>
<span class="fc" id="L4537">			boolean onlyEmailGroups = true;</span>
<span class="fc" id="L4538">			UserGroupsDB userGroupsDB = UserGroupsDB.getInstance();</span>
			UserGroupDetails ugd;
			int groupId;
<span class="fc bfc" id="L4541" title="All 2 branches covered.">			while (st.hasMoreTokens())</span>
			{
<span class="fc" id="L4543">				groupId = Tools.getIntValue(st.nextToken().trim(), -1);</span>
<span class="pc bpc" id="L4544" title="1 of 2 branches missed.">				if (groupId != -1)</span>
				{
<span class="fc" id="L4546">					ugd = userGroupsDB.getUserGroup(groupId);</span>
<span class="pc bpc" id="L4547" title="1 of 4 branches missed.">					if (ugd != null &amp;&amp; ugd.getUserGroupType() == UserGroupDetails.TYPE_PERMS)</span>
					{
<span class="fc" id="L4549">						onlyEmailGroups = false;</span>
					}
				}
				else
				{
					//nezbehlo parsovanie, co s tym? Zakazem to?
<span class="nc" id="L4555">					onlyEmailGroups = false;</span>
				}
			}

<span class="fc bfc" id="L4559" title="All 2 branches covered.">			if (onlyEmailGroups == true)</span>
			{
<span class="fc" id="L4561">				canAccess = true;</span>
			}
		}

<span class="fc bfc" id="L4565" title="All 2 branches covered.">		if (user.isAdmin())</span>
		{
<span class="pc bpc" id="L4567" title="1 of 2 branches missed.">			if (Constants.getBoolean(&quot;adminCheckUserGroups&quot;)==false)</span>
			{
<span class="fc" id="L4569">				Logger.debug(DocDB.class, &quot;je to admin, pristup povolujem&quot;);</span>
				//ak je to admin a pre admina sa nekontroluju prava (default), zobraz
<span class="fc" id="L4571">				canAccess = true;</span>
			}
		}
<span class="fc" id="L4574">		return(canAccess);</span>
	}

	/**
	 * Skontroluje, ci je dostupny adresar aktualne prihlasenemu pouzivatelovi
	 * @param group
	 * @param user
	 * @return
	 */
	public static boolean canAccess(GroupDetails group, Identity user)
	{
<span class="nc" id="L4585">		DocDetails doc = new DocDetails();</span>
<span class="nc" id="L4586">		doc.setDocId(-group.getGroupId());</span>
<span class="nc" id="L4587">		doc.setPasswordProtected(group.getPasswordProtected());</span>

<span class="nc" id="L4589">		return canAccess(doc, user);</span>
	}

	/**
	 * Ziska urlsByUrl hashtabulku pre zadanu domenu
	 * @param domain
	 * @return
	 */
	protected TObjectIntHashMap&lt;String&gt; getUrlsByUrlDomains(String domain, boolean createIfNull)
	{
<span class="pc bpc" id="L4599" title="1 of 4 branches missed.">		if (createIfNull==false &amp;&amp; urlsByUrlDomains.size()==1)</span>
		{
<span class="nc" id="L4601">			return urlsByUrlDomains.entrySet().iterator().next().getValue();</span>
		}

<span class="fc bfc" id="L4604" title="All 2 branches covered.">		if (Tools.isEmpty(domain)) domain = &quot;default&quot;;</span>
		try
		{
			//normalize domain - odstran http
<span class="fc" id="L4608">			int i = domain.indexOf(&quot;://&quot;);</span>
<span class="pc bpc" id="L4609" title="1 of 2 branches missed.">			if (i&gt;0) domain = domain.substring(i+3);</span>

<span class="fc" id="L4611">			i = domain.indexOf('/');</span>
<span class="pc bpc" id="L4612" title="1 of 2 branches missed.">			if (i&gt;0) domain = domain.substring(0, i);</span>
		}
<span class="nc" id="L4614">		catch (Exception e)</span>
		{
<span class="nc" id="L4616">			Logger.error(DocDB.class, e);</span>
<span class="fc" id="L4617">		}</span>

<span class="fc" id="L4619">		TObjectIntHashMap&lt;String&gt; urlsByUrl = urlsByUrlDomains.get(domain);</span>
<span class="fc bfc" id="L4620" title="All 2 branches covered.">		if (urlsByUrl==null)</span>
		{
<span class="fc bfc" id="L4622" title="All 2 branches covered.">			if (createIfNull)</span>
			{
<span class="fc" id="L4624">				urlsByUrl = new TObjectIntHashMap&lt;&gt;(10, 0.9f);</span>
<span class="fc" id="L4625">				urlsByUrlDomains.put(domain, urlsByUrl);</span>
			}
			else
			{
				//v cloude nechceme dohladavat &quot;default&quot; redirecty
<span class="pc bpc" id="L4630" title="1 of 2 branches missed.">				if (InitServlet.isTypeCloud()==false)</span>
				{
<span class="fc" id="L4632">					urlsByUrl = urlsByUrlDomains.get(&quot;default&quot;);</span>
<span class="pc bpc" id="L4633" title="1 of 2 branches missed.">					if (urlsByUrl==null)</span>
					{
<span class="nc bnc" id="L4635" title="All 2 branches missed.">						if (Constants.getBoolean(&quot;multiDomainEnabled&quot;)==true)</span>
						{
<span class="nc" id="L4637">							urlsByUrl = new TObjectIntHashMap&lt;&gt;(10, 0.9f);</span>
<span class="nc" id="L4638">							urlsByUrlDomains.put(domain, urlsByUrl);</span>
						}
<span class="nc bnc" id="L4640" title="All 2 branches missed.">						else if (urlsByUrlDomains.size() &gt; 0)</span>
						{
							//ak nie je z nejakeho dovodu ani default, vrat prvu najdenu
<span class="nc" id="L4643">							urlsByUrl = urlsByUrlDomains.entrySet().iterator().next().getValue();</span>
						}
					}
				}
			}
		}

		//System.out.println(&quot;getUrlsByUrlDomains(&quot;+domain+&quot;).size=&quot;+urlsByUrl.size());

<span class="fc" id="L4652">		return urlsByUrl;</span>
	}

	/**
	 * Vrati zoznam stranok so zadanou sablonou
	 * @param tid
	 * @return
	 */
	public static List&lt;DocDetails&gt; getDocsByTempId(int tid)
	{
<span class="nc" id="L4662">		List&lt;DocDetails&gt; docs = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L4664">		Connection db_conn = null;</span>
<span class="nc" id="L4665">		PreparedStatement ps = null;</span>
<span class="nc" id="L4666">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L4669">			db_conn = DBPool.getConnection();</span>
<span class="nc" id="L4670">			ps = db_conn.prepareStatement(&quot;SELECT * FROM documents WHERE temp_id=?&quot;);</span>
<span class="nc" id="L4671">			ps.setInt(1, tid);</span>
<span class="nc" id="L4672">			rs = ps.executeQuery();</span>

			DocDetails doc;
<span class="nc" id="L4675">			GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="nc" id="L4676">			boolean linkTypeHtml = false;</span>
<span class="nc bnc" id="L4677" title="All 2 branches missed.">			if (Constants.getInt(&quot;linkType&quot;) == Constants.LINK_TYPE_HTML)</span>
			{
<span class="nc" id="L4679">				linkTypeHtml = true;</span>
			}
<span class="nc bnc" id="L4681" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L4683">				doc = new DocDetails();</span>
<span class="nc" id="L4684">				getDocDetails(rs, doc, true, true);</span>

<span class="nc bnc" id="L4686" title="All 2 branches missed.">				if (linkTypeHtml)</span>
				{
<span class="nc" id="L4688">					doc.setDocLink(DocDB.getURL(doc, groupsDB));</span>
				}
<span class="nc" id="L4690">				doc.setNavbar(groupsDB.getNavbarNoHref(doc.getGroupId()));</span>

<span class="nc" id="L4692">				docs.add(doc);</span>
			}
<span class="nc" id="L4694">			rs.close();</span>
<span class="nc" id="L4695">			ps.close();</span>
<span class="nc" id="L4696">			db_conn.close();</span>
<span class="nc" id="L4697">			rs = null;</span>
<span class="nc" id="L4698">			ps = null;</span>
<span class="nc" id="L4699">			db_conn = null;</span>
		}
<span class="nc" id="L4701">		catch (Exception ex)</span>
		{
<span class="nc" id="L4703">			Logger.error(DocDB.class, ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L4709" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L4710">					rs.close();</span>
<span class="nc bnc" id="L4711" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L4712">					ps.close();</span>
<span class="nc bnc" id="L4713" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L4714">					db_conn.close();</span>
			}
<span class="nc" id="L4716">			catch (Exception ex2)</span>
			{
<span class="nc" id="L4718">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L4719">			}</span>
		}
<span class="nc" id="L4721">		return (docs);</span>
	}

	/**
	 * vrati vsetky stranky medzi zadanymi datumami a so zadanym authorId
	 * @param dateFrom
	 * @param dateTo
	 * @return
	 */
	public static List&lt;DocDetails&gt; getAllDocsFromTo(String dateFrom, String dateTo, Integer authorId)
	{
<span class="nc" id="L4732">		Connection db_conn = null;</span>
<span class="nc" id="L4733">		PreparedStatement ps = null;</span>
<span class="nc" id="L4734">		ResultSet rs = null;</span>
<span class="nc" id="L4735">		List&lt;DocDetails&gt; docs = new ArrayList&lt;&gt;();</span>

		try
		{
<span class="nc" id="L4739">			db_conn = DBPool.getConnection();</span>

<span class="nc bnc" id="L4741" title="All 4 branches missed.">			if(authorId == null || authorId.intValue() == -1)</span>
			{
<span class="nc" id="L4743">				ps = db_conn.prepareStatement(&quot;SELECT * FROM documents WHERE date_created &gt;= ? AND date_created &lt;= ? ORDER BY date_created DESC&quot;);</span>
<span class="nc" id="L4744">				ps.setTimestamp(1,new Timestamp(DB.getTimestamp(dateFrom,&quot;0:00:00&quot;)));</span>
<span class="nc" id="L4745">				ps.setTimestamp(2,new Timestamp(DB.getTimestamp(dateTo,&quot;23:59:59&quot;)));</span>
			}else{
<span class="nc" id="L4747">				ps = db_conn.prepareStatement(&quot;SELECT * FROM documents WHERE date_created &gt;= ? AND date_created &lt;= ? AND author_id = ? ORDER BY date_created DESC&quot;);</span>
<span class="nc" id="L4748">				ps.setTimestamp(1,new Timestamp(DB.getTimestamp(dateFrom,&quot;0:00:00&quot;)));</span>
<span class="nc" id="L4749">				ps.setTimestamp(2,new Timestamp(DB.getTimestamp(dateTo,&quot;23:59:59&quot;)));</span>
<span class="nc" id="L4750">				ps.setInt(3, authorId);</span>
			}

<span class="nc" id="L4753">			rs = ps.executeQuery();</span>

			DocDetails doc;
<span class="nc" id="L4756">			GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="nc" id="L4757">			boolean linkTypeHtml = false;</span>
<span class="nc bnc" id="L4758" title="All 2 branches missed.">			if (Constants.getInt(&quot;linkType&quot;) == Constants.LINK_TYPE_HTML)</span>
			{
<span class="nc" id="L4760">				linkTypeHtml = true;</span>
			}

<span class="nc bnc" id="L4763" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L4765">				doc = new DocDetails();</span>
<span class="nc" id="L4766">				DocDB.getDocDetails(rs, doc, true, true);</span>

<span class="nc bnc" id="L4768" title="All 2 branches missed.">				if (linkTypeHtml)</span>
				{
<span class="nc" id="L4770">					doc.setDocLink(DocDB.getURL(doc, groupsDB));</span>
				}
<span class="nc" id="L4772">				doc.setNavbar(groupsDB.getNavbarNoHref(doc.getGroupId()));</span>

<span class="nc" id="L4774">				docs.add(doc);</span>
			}
<span class="nc" id="L4776">			rs.close();</span>
<span class="nc" id="L4777">			ps.close();</span>
<span class="nc" id="L4778">			db_conn.close();</span>
<span class="nc" id="L4779">			rs = null;</span>
<span class="nc" id="L4780">			ps = null;</span>
<span class="nc" id="L4781">			db_conn = null;</span>
		}
<span class="nc" id="L4783">		catch (Exception ex)</span>
		{
<span class="nc" id="L4785">			Logger.error(DocDB.class, ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L4791" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L4792">					rs.close();</span>
<span class="nc bnc" id="L4793" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L4794">					ps.close();</span>
<span class="nc bnc" id="L4795" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L4796">					db_conn.close();</span>
			}
<span class="nc" id="L4798">			catch (Exception ex2)</span>
			{
<span class="nc" id="L4800">				Logger.error(DocDB.class, ex2);</span>
<span class="nc" id="L4801">			}</span>
		}

<span class="nc" id="L4804">		return docs;</span>
	}

	/**
	 * Vrati domenu pre zadane docId
	 * @param docId
	 * @return
	 */
	public String getDomain(int docId)
	{
<span class="fc" id="L4814">		DocDetails doc = getBasicDocDetails(docId, false);</span>
<span class="pc bpc" id="L4815" title="1 of 2 branches missed.">		if (doc != null)</span>
		{
<span class="fc" id="L4817">			GroupDetails group = GroupsDB.getInstance().getGroup(doc.getGroupId());</span>
<span class="pc bpc" id="L4818" title="1 of 2 branches missed.">			if (group != null)</span>
			{
<span class="fc" id="L4820">				return group.getDomainName();</span>
			}
		}

<span class="nc" id="L4824">		return &quot;&quot;;</span>
	}

	/**
	 * Vrati dokumenty pouzivatela, ktore este neboli schvalene
	 * @return
	 */
	public List&lt;DocDetails&gt; getNotApprovedDocs(int userId)
	{
<span class="nc" id="L4833">		List&lt;DocDetails&gt; docs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L4834">		Connection db_conn = null;</span>
<span class="nc" id="L4835">		PreparedStatement ps = null;</span>
<span class="nc" id="L4836">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L4839">			db_conn = DBPool.getConnection(serverName);</span>
<span class="nc" id="L4840">			ps = db_conn.prepareStatement(&quot;SELECT history_id, dh.doc_id, dh.save_date, dh.title, dh.author_id, dh.group_id, dh.available FROM documents_history dh&quot; +</span>
					&quot; JOIN documents ON (documents.doc_id = dh.doc_id)&quot;+
					&quot; WHERE dh.awaiting_approve IS NOT NULL AND NOT dh.awaiting_approve='' AND dh.author_id = ? ORDER BY save_date DESC&quot;);
<span class="nc" id="L4843">			ps.setInt(1, userId);</span>
<span class="nc" id="L4844">			rs = ps.executeQuery();</span>
			DocDetails doc;
<span class="nc" id="L4846">			GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="nc bnc" id="L4847" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L4849">				doc = new DocDetails();</span>
<span class="nc" id="L4850">				doc.setHistoryId(rs.getInt(&quot;history_id&quot;));</span>
<span class="nc" id="L4851">				doc.setDocId(rs.getInt(&quot;doc_id&quot;));</span>
<span class="nc" id="L4852">				doc.setAuthorId(rs.getInt(&quot;author_id&quot;));</span>
<span class="nc" id="L4853">				doc.setTitle(DB.getDbString(rs, &quot;title&quot;));</span>
<span class="nc" id="L4854">				doc.setGroupId(rs.getInt(&quot;group_id&quot;));</span>
<span class="nc" id="L4855">				doc.setNavbar(groupsDB.getNavbarNoHref(doc.getGroupId()));</span>
<span class="nc" id="L4856">				doc.setDateCreated(DB.getDbTimestamp(rs, &quot;save_date&quot;));</span>
<span class="nc" id="L4857">				doc.setAvailable(rs.getBoolean(&quot;available&quot;));</span>
<span class="nc" id="L4858">				docs.add(doc);</span>
			}
<span class="nc" id="L4860">			rs.close();</span>
<span class="nc" id="L4861">			ps.close();</span>
<span class="nc" id="L4862">			db_conn.close();</span>
<span class="nc" id="L4863">			db_conn = null;</span>
<span class="nc" id="L4864">			ps = null;</span>
<span class="nc" id="L4865">			rs = null;</span>
		}
<span class="nc" id="L4867">		catch (Exception ex){Logger.error(DocDB.class, ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L4870" title="All 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="nc bnc" id="L4871" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L4872" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L4873">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="nc" id="L4875">		return(docs);</span>
	}

	/**
	 * Nastavi title tak, ze obsahuje aj spatnu cestu k adresarom
	 * @param doc
	 * @return
	 */
	public static String getTitleWithPath(DocDetails doc)
	{
<span class="nc bnc" id="L4885" title="All 2 branches missed.">		if (doc == null) return &quot;&quot;;</span>
<span class="nc" id="L4886">		StringBuilder title = new StringBuilder(doc.getTitle());</span>

<span class="nc" id="L4888">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="nc" id="L4889">		GroupDetails group = groupsDB.getGroup(doc.getGroupId());</span>
<span class="nc bnc" id="L4890" title="All 2 branches missed.">		if (group == null) return title.toString();</span>
<span class="nc bnc" id="L4891" title="All 8 branches missed.">		if (group.getNavbarNameNoAparam().equals(doc.getTitle())==false &amp;&amp; group.getDefaultDocId()!=doc.getDocId() &amp;&amp; &quot;&amp;nbsp;&quot;.equals(group.getNavbarNameNoAparam())==false &amp;&amp; Tools.isNotEmpty(group.getNavbarNameNoAparam()))</span>
<span class="nc" id="L4892">			title.append(&quot; - &quot;).append(group.getNavbarNameNoAparam());</span>
<span class="nc" id="L4893">		int failsafe = 0;</span>

<span class="nc bnc" id="L4895" title="All 6 branches missed.">		while (group!=null &amp;&amp; group.getParentGroupId()&gt;0 &amp;&amp; failsafe++ &lt; 50)</span>
		{
<span class="nc" id="L4897">			group = groupsDB.getGroup(group.getParentGroupId());</span>
<span class="nc bnc" id="L4898" title="All 6 branches missed.">			if (group != null &amp;&amp; &quot;&amp;nbsp;&quot;.equals(group.getNavbarNameNoAparam())==false &amp;&amp; Tools.isNotEmpty(group.getNavbarNameNoAparam()))</span>
			{
<span class="nc" id="L4900">				title.append(&quot; - &quot;).append(group.getNavbarNameNoAparam());</span>
			}
		}

<span class="nc" id="L4904">		return title.toString();</span>
	}

	/**
	 * Ulozi DocDetails do databazy, POZOR: NEVYKONA DocDB.getInstance(true)
	 * @param docDetails
	 */
	public static boolean saveDoc(DocDetails docDetails) {
<span class="fc" id="L4912">		return saveDoc(docDetails, true);</span>
	}

	/**
	 * Ulozi DocDetails do databazy, POZOR: NEVYKONA DocDB.getInstance(true)
	 * @param docDetails
	 * @param publishEvents - ak je true publikuju sa aj udalosti o zmene
	 * @return
	 */
	public static boolean saveDoc(DocDetails docDetails, boolean publishEvents)
	{
<span class="pc bpc" id="L4923" title="1 of 2 branches missed.">		if (docDetails==null) return false;</span>

<span class="fc" id="L4925">		boolean saveOK = false;</span>

<span class="fc" id="L4927">		Connection db_conn = null;</span>
<span class="fc" id="L4928">		PreparedStatement ps = null;</span>
<span class="fc" id="L4929">		ResultSet rs = null;</span>

		try
		{
<span class="pc bpc" id="L4933" title="1 of 4 branches missed.">			if (docDetails!=null &amp;&amp; publishEvents) (new WebjetEvent&lt;DocDetails&gt;(docDetails, WebjetEventType.ON_START)).publishEvent();</span>

<span class="fc" id="L4935">			Prop properties = Prop.getInstance();</span>

<span class="fc" id="L4937">			String sql = &quot;INSERT INTO documents (title, data, data_asc, external_link, navbar, date_created, &quot; +</span>
					&quot;publish_start, publish_end, author_id, group_id, temp_id, searchable, available, &quot; +
					&quot;cacheable, sort_priority, header_doc_id, footer_doc_id, menu_doc_id, password_protected, html_head, &quot;+
					&quot;html_data, perex_place, perex_image, perex_group, show_in_menu, event_date, right_menu_doc_id,&quot; +
					&quot;field_a, field_b, field_c, field_d, field_e, field_f, field_g, field_h, field_i, field_j, field_k, field_l, disable_after_end, virtual_path, require_ssl, file_name, field_m, field_n, field_o, field_p, field_q, field_r, field_s, field_t, root_group_l1, root_group_l2, root_group_l3) &quot; +
					&quot;VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;;

<span class="fc bfc" id="L4944" title="All 2 branches covered.">			if (docDetails.getDocId() &gt; 0)</span>
			{
<span class="fc" id="L4946">				sql = &quot;UPDATE documents SET title=?, data=?, data_asc=?, external_link=?, navbar=?, date_created=?, &quot; +</span>
						&quot;publish_start=?, publish_end=?, author_id=?, group_id=?, temp_id=?, searchable=?, available=?, &quot; +
						&quot;cacheable=?, sort_priority=?, header_doc_id=?, footer_doc_id=?, menu_doc_id=?, password_protected=?, html_head=?, &quot;+
						&quot;html_data=?, perex_place=?, perex_image=?, perex_group=?, show_in_menu=?, event_date=?, right_menu_doc_id=?,&quot; +
						&quot;field_a=?, field_b=?, field_c=?, field_d=?, field_e=?, field_f=?, field_g=?, field_h=?, field_i=?, field_j=?, field_k=?, field_l=?, disable_after_end=?, virtual_path=?, require_ssl=?, file_name=?, field_m=?, field_n=?, field_o=?, field_p=?, field_q=?, field_r=?, field_s=?, field_t=?, root_group_l1=?, root_group_l2=?, root_group_l3=?, sync_status=1 &quot; +
						&quot;WHERE doc_id=?&quot;;
			}

<span class="fc" id="L4954">			String publishDocData = null;</span>
<span class="fc" id="L4955">			java.util.Date now = new java.util.Date();</span>
<span class="fc" id="L4956">			long time = docDetails.getPublishStart();</span>
<span class="fc bfc" id="L4957" title="All 2 branches covered.">			if (time &gt; 0)</span>
			{
				//ak sa to ma vypublikovat az po aktualnom case, zrus available
<span class="pc bpc" id="L4960" title="1 of 2 branches missed.">				if (time &gt; now.getTime())</span>
				{
<span class="nc bnc" id="L4962" title="All 2 branches missed.">					if (docDetails.isPublicable())</span>
					{
<span class="nc" id="L4964">						docDetails.setAvailable(false);</span>
<span class="nc" id="L4965">						publishDocData = properties.getText(&quot;editor.publish.note&quot;) + &quot; &quot; + docDetails.getPublishStartString() + &quot; &quot; + docDetails.getPublishStartTimeString();</span>
					}
				}
			}

<span class="fc" id="L4970">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L4971">			ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L4972">			ps.setString(1, docDetails.getTitle());</span>
<span class="pc bpc" id="L4973" title="1 of 2 branches missed.">			if (publishDocData != null)</span>
			{
<span class="nc" id="L4975">				DB.setClob(ps, 2, publishDocData);</span>
<span class="nc" id="L4976">				DB.setClob(ps, 3, DB.internationalToEnglish(publishDocData).toLowerCase());</span>
			}
			else
			{
<span class="fc" id="L4980">				DB.setClob(ps, 2, docDetails.getData());</span>
<span class="fc" id="L4981">				EditorForm ef = new EditorForm(docDetails);</span>
<span class="fc" id="L4982">				DB.setClob(ps, 3, EditorDB.getDataAsc(docDetails.getData(), ef));</span>
			}

<span class="fc" id="L4985">			ps.setString(4, docDetails.getExternalLink());</span>
<span class="fc" id="L4986">			ps.setString(5, docDetails.getNavbar());</span>

<span class="fc" id="L4988">			ps.setTimestamp(6, new Timestamp(now.getTime()));</span>

<span class="pc bpc" id="L4990" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(docDetails.getPublishStartString()))</span>
			{
<span class="fc bfc" id="L4992" title="All 2 branches covered.">				if (time &gt; 0)</span>
				{
<span class="fc" id="L4994">					ps.setTimestamp(7, new Timestamp(time));</span>
				}
				else
				{
<span class="fc" id="L4998">					ps.setNull(7, java.sql.Types.TIMESTAMP);</span>
				}
			}
			else
			{
<span class="nc" id="L5003">				ps.setNull(7, java.sql.Types.DATE);</span>
			}

<span class="fc bfc" id="L5006" title="All 2 branches covered.">			if (Tools.isNotEmpty(docDetails.getPublishEndString()))</span>
			{
<span class="fc" id="L5008">				long time2 = docDetails.getPublishEnd();</span>
<span class="pc bpc" id="L5009" title="1 of 2 branches missed.">				if (time2 &gt; 0)</span>
				{
<span class="fc" id="L5011">					ps.setTimestamp(8, new Timestamp(time2));</span>
				}
				else
				{
<span class="nc" id="L5015">					ps.setNull(8, java.sql.Types.TIMESTAMP);</span>
				}
<span class="fc" id="L5017">			}</span>
			else
			{
<span class="fc" id="L5020">				ps.setNull(8, java.sql.Types.DATE);</span>
			}

<span class="fc" id="L5023">			ps.setInt(9, docDetails.getAuthorId());</span>
<span class="fc" id="L5024">			ps.setInt(10, docDetails.getGroupId());</span>
<span class="fc" id="L5025">			ps.setInt(11, docDetails.getTempId());</span>
<span class="fc" id="L5026">			ps.setBoolean(12, docDetails.isSearchable());</span>
<span class="fc" id="L5027">			ps.setBoolean(13, docDetails.isAvailable());</span>
<span class="fc" id="L5028">			ps.setBoolean(14, docDetails.isCacheable());</span>
<span class="fc" id="L5029">			ps.setInt(15, docDetails.getSortPriority());</span>
<span class="fc" id="L5030">			ps.setInt(16, docDetails.getHeaderDocId());</span>
<span class="fc" id="L5031">			ps.setInt(17, docDetails.getFooterDocId());</span>
<span class="fc" id="L5032">			ps.setInt(18, docDetails.getMenuDocId());</span>
<span class="pc bpc" id="L5033" title="1 of 2 branches missed.">			if (docDetails.getPasswordProtected() == null)</span>
			{
<span class="nc" id="L5035">				ps.setNull(19, java.sql.Types.VARCHAR);</span>
			}
			else
			{
<span class="fc" id="L5039">				ps.setString(19, docDetails.getPasswordProtected());</span>
			}
<span class="fc" id="L5041">			DB.setClob(ps, 20, docDetails.getHtmlHead());</span>
<span class="pc bpc" id="L5042" title="1 of 4 branches missed.">			if (docDetails.getHtmlData() == null || docDetails.getHtmlData().length() &lt; 1)</span>
			{
<span class="fc" id="L5044">				ps.setNull(21, Types.VARCHAR);</span>
			}
			else
			{
<span class="fc" id="L5048">				DB.setClob(ps, 21, docDetails.getHtmlData());</span>
			}
<span class="fc" id="L5050">			ps.setString(22, docDetails.getPerexPlace());</span>
<span class="fc" id="L5051">			ps.setString(23, docDetails.getPerexImage());</span>

<span class="fc" id="L5053">			ps.setString(24, &quot;,&quot;+docDetails.getPerexGroupIdsString()+&quot;,&quot;);</span>
<span class="fc" id="L5054">			ps.setBoolean(25, docDetails.isShowInMenu());</span>

<span class="pc bpc" id="L5056" title="1 of 2 branches missed.">			if (docDetails.getEventDateString()!=null )</span>
			{
<span class="fc bfc" id="L5058" title="All 2 branches covered.">				if (docDetails.getEventTimeString().trim().length() &lt; 3)</span>
				{
<span class="fc" id="L5060">					docDetails.setEventTimeString(&quot;6:00&quot;);</span>
				}
<span class="fc" id="L5062">				long time2 = docDetails.getEventDate();</span>
<span class="fc bfc" id="L5063" title="All 2 branches covered.">				if (time2 &gt; 0)</span>
				{
<span class="fc" id="L5065">					ps.setTimestamp(26, new Timestamp(time2));</span>
				}
				else
				{
<span class="fc" id="L5069">					ps.setNull(26, java.sql.Types.TIMESTAMP);</span>
				}
<span class="fc" id="L5071">			}</span>
			else
			{
<span class="nc" id="L5074">				ps.setNull(26, java.sql.Types.DATE);</span>
			}
<span class="fc" id="L5076">			ps.setInt(27, docDetails.getRightMenuDocId());</span>

<span class="fc" id="L5078">			ps.setString(28, docDetails.getFieldA());</span>
<span class="fc" id="L5079">			ps.setString(29, docDetails.getFieldB());</span>
<span class="fc" id="L5080">			ps.setString(30, docDetails.getFieldC());</span>
<span class="fc" id="L5081">			ps.setString(31, docDetails.getFieldD());</span>
<span class="fc" id="L5082">			ps.setString(32, docDetails.getFieldE());</span>
<span class="fc" id="L5083">			ps.setString(33, docDetails.getFieldF());</span>
<span class="fc" id="L5084">			ps.setString(34, docDetails.getFieldG());</span>
<span class="fc" id="L5085">			ps.setString(35, docDetails.getFieldH());</span>
<span class="fc" id="L5086">			ps.setString(36, docDetails.getFieldI());</span>
<span class="fc" id="L5087">			ps.setString(37, docDetails.getFieldJ());</span>
<span class="fc" id="L5088">			ps.setString(38, docDetails.getFieldK());</span>
<span class="fc" id="L5089">			ps.setString(39, docDetails.getFieldL());</span>

<span class="fc" id="L5091">			ps.setBoolean(40, docDetails.isDisableAfterEnd());</span>
<span class="fc bfc" id="L5092" title="All 2 branches covered.">			if (Tools.isEmpty(docDetails.getVirtualPath()))</span>
			{
<span class="fc" id="L5094">				EditorForm ef = new EditorForm(docDetails);</span>
<span class="fc" id="L5095">				EditorDB.setVirtualPath(ef);</span>
<span class="fc" id="L5096">				docDetails.setVirtualPath(ef.getVirtualPath());</span>
			}
<span class="fc" id="L5098">			ps.setString(41, docDetails.getVirtualPath());</span>

<span class="fc" id="L5100">			ps.setBoolean(42, docDetails.isRequireSsl());</span>

<span class="fc" id="L5102">			GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="fc" id="L5103">			GroupDetails group = groupsDB.getGroup(docDetails.getGroupId());</span>
<span class="fc" id="L5104">			String fileName = null;</span>
<span class="pc bpc" id="L5105" title="2 of 4 branches missed.">			if (group != null &amp;&amp; group.isInternal()==false)</span>
			{
<span class="fc" id="L5107">				fileName = groupsDB.getGroupNamePath(docDetails.getGroupId());</span>
				//musim obmedzit na max 255 znakov
<span class="pc bpc" id="L5109" title="1 of 2 branches missed.">				if(fileName.length() &gt; 255)</span>
				{
<span class="nc" id="L5111">					fileName = DB.prepareString(fileName, 255);</span>
<span class="nc" id="L5112">					int lastSlash = fileName.lastIndexOf(&quot;/&quot;);</span>
<span class="nc bnc" id="L5113" title="All 2 branches missed.">					if(lastSlash != -1) fileName = fileName.substring(0, lastSlash);</span>
				}
			}
<span class="fc" id="L5116">			ps.setString(43, fileName);</span>

<span class="fc" id="L5118">			ps.setString(44, docDetails.getFieldM());</span>
<span class="fc" id="L5119">			ps.setString(45, docDetails.getFieldN());</span>
<span class="fc" id="L5120">			ps.setString(46, docDetails.getFieldO());</span>
<span class="fc" id="L5121">			ps.setString(47, docDetails.getFieldP());</span>
<span class="fc" id="L5122">			ps.setString(48, docDetails.getFieldQ());</span>
<span class="fc" id="L5123">			ps.setString(49, docDetails.getFieldR());</span>
<span class="fc" id="L5124">			ps.setString(50, docDetails.getFieldS());</span>
<span class="fc" id="L5125">			ps.setString(51, docDetails.getFieldT());</span>

<span class="fc" id="L5127">			DocDB.getRootGroupL(docDetails.getGroupId(), ps, 52);</span>

<span class="fc bfc" id="L5129" title="All 2 branches covered.">			if (docDetails.getDocId() &gt; 0)</span>
			{
<span class="fc" id="L5131">				ps.setInt(55, docDetails.getDocId());</span>
			}

<span class="fc" id="L5134">			ps.execute();</span>
<span class="fc" id="L5135">			ps.close();</span>

<span class="pc bpc" id="L5137" title="3 of 4 branches missed.">			if (Constants.DB_TYPE == Constants.DB_MSSQL &amp;&amp; Constants.getBoolean(&quot;jtdsCommit&quot;))</span>
			{
<span class="nc" id="L5139">				db_conn.commit();</span>
			}

			//get new doc_id
			//get document id
			// JRASKA: Toto predsa treba robit len pri novom clanku, inak zmenime docID pre predtym existujuci clanok
<span class="fc" id="L5145">			int docId = -1;</span>
<span class="fc bfc" id="L5146" title="All 2 branches covered.">			if (docDetails.getDocId() &lt; 1)</span>
			{
<span class="fc" id="L5148">				ps = db_conn.prepareStatement(&quot;SELECT max(doc_id) FROM documents WHERE title=?&quot;);</span>
<span class="fc" id="L5149">				ps.setString(1, docDetails.getTitle());</span>
<span class="fc" id="L5150">				rs = ps.executeQuery();</span>
<span class="pc bpc" id="L5151" title="1 of 2 branches missed.">				if (rs.next())</span>
				{
<span class="fc" id="L5153">					docId = rs.getInt(1);</span>
				}
<span class="fc" id="L5155">				rs.close();</span>
<span class="fc" id="L5156">				ps.close();</span>
<span class="fc" id="L5157">				docDetails.setDocId(docId);</span>
			}

			//aktualizuj pripadne aj tab. perex_group_doc
<span class="fc" id="L5161">			DocDB.udpdatePerexGroupDoc(docDetails.getDocId(), docDetails.getPerexGroupIdsString());</span>

<span class="fc" id="L5163">			db_conn.close();</span>
<span class="fc" id="L5164">			rs = null;</span>
<span class="fc" id="L5165">			ps = null;</span>
<span class="fc" id="L5166">			db_conn = null;</span>

			//ak su nastavene syncId tak zapis aj to, potrebne pre synchronizaciu struktury
<span class="fc bfc" id="L5169" title="All 2 branches covered.">			if (docDetails.getSyncId()&gt;0) {</span>
<span class="fc" id="L5170">				new SimpleQuery().execute(&quot;UPDATE documents SET sync_id=? WHERE doc_id=?&quot;, docDetails.getSyncId(), docDetails.getDocId());</span>
			}

			//premenovanie Groupy ak je stranka defaultna pre Grupu.
<span class="fc bfc" id="L5174" title="All 2 branches covered.">			if(GroupsService.canSyncTitle(docDetails.getDocId(), docDetails.getGroupId()))</span>
			{
<span class="fc" id="L5176">				changeGroupTitle(docDetails.getGroupId(), docDetails.getDocId(), docDetails.getTitle());</span>
			}

<span class="fc" id="L5179">			DocDB.getInstance().updateInternalCaches(docDetails.getDocId());</span>
<span class="fc" id="L5180">			saveOK = true;</span>

<span class="pc bpc" id="L5182" title="1 of 4 branches missed.">			if (docDetails!=null &amp;&amp; publishEvents) (new WebjetEvent&lt;DocDetails&gt;(docDetails, WebjetEventType.AFTER_SAVE)).publishEvent();</span>
		}
<span class="nc" id="L5184">		catch (Exception ex)</span>
		{
<span class="nc" id="L5186">			Logger.error(DocDB.class, ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L5192" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L5193">					rs.close();</span>
<span class="pc bpc" id="L5194" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L5195">					ps.close();</span>
<span class="pc bpc" id="L5196" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L5197">					db_conn.close();</span>
			}
<span class="nc" id="L5199">			catch (Exception ex2)</span>
			{
				//
<span class="fc" id="L5202">			}</span>
		}

<span class="fc" id="L5205">		return saveOK;</span>
	}

	public static boolean isGroupAvailable(int[] availableGroups, List&lt;GroupDetails&gt; groups)
	{
<span class="nc" id="L5210">		return isGroupAvailable(availableGroups, groups, false, null);</span>
	}

	/**
	 * availableGroups - array of int Ids represent in which groups is perex available
	 * groups - list of parent groups of actual selected group in jsTree
	 * recursive - True (check if perexGroup is available not only for parent groups but also for child group of selected group in jsTree)
	 * actualGropId - if &quot;recursive&quot; if true this MUST by set (its id of selected group in jsTree)
	 */
	public static boolean isGroupAvailable(int[] availableGroups, List&lt;GroupDetails&gt; groups, boolean recursive, Integer actualGropId)
	{
		//check availability for parent groups
<span class="fc bfc" id="L5222" title="All 2 branches covered.">		for (int groupId : availableGroups)</span>
		{
<span class="fc bfc" id="L5224" title="All 2 branches covered.">			for (GroupDetails group : groups)</span>
			{
<span class="fc bfc" id="L5226" title="All 2 branches covered.">				if (group.getGroupId() == groupId) return true;</span>
<span class="fc" id="L5227">			}</span>
		}

		//check availability for child groups
<span class="pc bpc" id="L5231" title="1 of 4 branches missed.">		if(recursive &amp;&amp; actualGropId != null) {</span>

<span class="fc" id="L5233">			GroupsDB groupsDB = GroupsDB.getInstance();</span>

<span class="fc bfc" id="L5235" title="All 2 branches covered.">			for (int availableGroupId : availableGroups) {</span>

<span class="fc" id="L5237">				int[] tmpParentGroupIds = Tools.getTokensInt(groupsDB.getParents(availableGroupId), &quot;,&quot;);</span>

<span class="fc bfc" id="L5239" title="All 2 branches covered.">				for(int tmpParentGroupId : tmpParentGroupIds) {</span>
<span class="pc bpc" id="L5240" title="1 of 2 branches missed.">					if(tmpParentGroupId == actualGropId) return true;</span>
				}
			}
		}

<span class="fc" id="L5245">		return false;</span>
	}

	/**
	 * Vrati perex groupy dostupne pre zadane groupId, pokial nieje zadane groupId, vrati zoznam skupin, ktore niesu priradene ziadnemu adresaru
	 * @param groupId
	 * @return
	 */
	public List&lt;PerexGroupBean&gt; getPerexGroups(int groupId)
	{
<span class="fc" id="L5255">		return getPerexGroups(groupId, false);</span>
	}

	/**
	 * Vrati perex groupy dostupne pre zadane groupId, pokial nieje zadane groupId, vrati zoznam skupin, ktore niesu priradene ziadnemu adresaru
	 * @param groupId
	 * @return
	 */
	public List&lt;PerexGroupBean&gt; getPerexGroups(int groupId, boolean recursive)
	{
<span class="fc" id="L5265">		int[] groupIds = new int[1];</span>
<span class="fc" id="L5266">		groupIds[0] = groupId;</span>
<span class="fc" id="L5267">		return getPerexGroups(groupIds, recursive);</span>
	}

	/**
	 * Returns PerexGroups available in groupIds folder (if not empty)
	 * @param groupIds
	 * @param recursive - true to recursivelly check subfolders
	 * @return
	 */
	public List&lt;PerexGroupBean&gt; getPerexGroups(int[] groupIds, boolean recursive)
	{
<span class="fc" id="L5278">		List&lt;PerexGroupBean&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L5279" title="2 of 4 branches missed.">		if(groupIds.length &gt; 0 &amp;&amp; groupIds[0]&gt;0)</span>
		{
			//najskor potrebujeme zoznam parent skupin
<span class="fc" id="L5282">			GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="fc" id="L5283">			Set&lt;Integer&gt; duplicityCheck = new HashSet&lt;&gt;();</span>

<span class="fc bfc" id="L5285" title="All 2 branches covered.">			for (int groupId : groupIds) {</span>
<span class="fc" id="L5286">				List&lt;GroupDetails&gt; parentGroups = groupsDB.getParentGroups(groupId);</span>

				//get all perex groups
<span class="fc" id="L5289">				List&lt;PerexGroupBean&gt; allPerexGroups = getPerexGroups();</span>

<span class="pc bpc" id="L5291" title="2 of 4 branches missed.">				if(allPerexGroups != null &amp;&amp; allPerexGroups.size() &gt; 0)</span>
				{
					//Loop all perex groups and for each one call isGroupAvailable method (method will return true if this perexGroup is availaible)
<span class="fc bfc" id="L5294" title="All 2 branches covered.">					for(PerexGroupBean perexGroup : allPerexGroups)</span>
					{
<span class="pc bpc" id="L5296" title="1 of 2 branches missed.">						if (perexGroup.getPerexGroupId() &lt; 1) continue;</span>

<span class="fc" id="L5298">						int[] perexAvailableGroups = perexGroup.getAvailableGroupsInt();</span>

						//isGroupAvailable param &quot;recursive&quot; and &quot;groupId&quot; are set for getting perexGroups for child (all subfolders - if recursive is true)
<span class="fc bfc" id="L5301" title="All 4 branches covered.">						if (perexAvailableGroups.length == 0 || isGroupAvailable(perexAvailableGroups, parentGroups, recursive, groupId))</span>
						{
<span class="fc bfc" id="L5303" title="All 2 branches covered.">							if (duplicityCheck.contains(perexGroup.getPerexGroupId())==false) ret.add(perexGroup);</span>
<span class="fc" id="L5304">							duplicityCheck.add(perexGroup.getPerexGroupId());</span>
						}
<span class="fc" id="L5306">					}</span>
				}
			}
<span class="fc" id="L5309">		}</span>
		else
		{
			//pokial nemame zadane groupId, tak vratime zoznam skupin, ktore su dostupne pre vsetky adresare
<span class="nc" id="L5313">			List&lt;PerexGroupBean&gt; allPerexGroups = getPerexGroups();</span>
<span class="nc bnc" id="L5314" title="All 4 branches missed.">			if(allPerexGroups != null &amp;&amp; allPerexGroups.size() &gt; 0)</span>
			{
<span class="nc bnc" id="L5316" title="All 2 branches missed.">				for(PerexGroupBean perexGroup : allPerexGroups)</span>
				{
<span class="nc bnc" id="L5318" title="All 2 branches missed.">					if(Tools.isEmpty(perexGroup.getAvailableGroups()))</span>
<span class="nc" id="L5319">						ret.add(perexGroup);</span>
<span class="nc" id="L5320">				}</span>
			}
		}

<span class="fc" id="L5324">		Collator collator = Collator.getInstance();</span>
<span class="fc" id="L5325">		ret.sort((o1, o2) -&gt; collator.compare(o1.getPerexGroupName().toLowerCase(), o2.getPerexGroupName().toLowerCase()));</span>

<span class="fc" id="L5327">		return (ret);</span>
	}

	/**
	 * Vrati vsetky clanky t.z. webstranky, ktore vytvoril dany pouzivatel a vyfiltruje ich podla zadanych kriterii
	 *
	 * @param authorId			autor webstranok, identifikator pouzivatela
	 * @param filterTopicId		identifikator rubriky - groupId
	 * @param filterBlogName	nazov clanku, pouziva sa LIKE, cize staci len cast nazvu
	 * @param filterDateFrom	datum ulozenia od
	 * @param filterDateTo		datum ulozenia do
	 *
	 * @return
	 */
	public static List&lt;DocDetails&gt; getBlogs(int authorId, int filterTopicId, String filterBlogName, Date filterDateFrom, Date filterDateTo)
	{
<span class="nc" id="L5343">		List&lt;DocDetails&gt; docs = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L5345">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="nc" id="L5346">		GroupDetails group = null;</span>

<span class="nc" id="L5348">		Connection db_conn = null;</span>
<span class="nc" id="L5349">		PreparedStatement ps = null;</span>
<span class="nc" id="L5350">		ResultSet rs = null;</span>

		try
		{
<span class="nc" id="L5354">			db_conn = DBPool.getConnection();</span>

			//--------------VYBER AUTOROVYCH CLANKOV--------------------------
<span class="nc" id="L5357">			StringBuilder sql = new StringBuilder();</span>
<span class="nc" id="L5358">			sql.append(&quot;SELECT &quot; + DocDB.getDocumentFieldsNodata() + &quot; FROM documents d WHERE d.author_id = ? &quot;);</span>

<span class="nc bnc" id="L5360" title="All 2 branches missed.">			if(Tools.isNotEmpty(filterBlogName))</span>
<span class="nc" id="L5361">				sql.append(&quot; AND d.title LIKE ? &quot;);</span>
<span class="nc bnc" id="L5362" title="All 2 branches missed.">			if (filterDateFrom != null)</span>
<span class="nc" id="L5363">				sql.append(&quot; AND d.date_created &gt; ? &quot;);</span>
<span class="nc bnc" id="L5364" title="All 2 branches missed.">			if (filterDateTo != null)</span>
<span class="nc" id="L5365">				sql.append(&quot; AND d.date_created &lt; ? &quot;);</span>

<span class="nc" id="L5367">			sql.append(&quot; ORDER BY d.date_created DESC, doc_id DESC&quot;);</span>

<span class="nc" id="L5369">			ps = db_conn.prepareStatement(sql.toString());</span>
<span class="nc" id="L5370">			int psCounter = 1;</span>
<span class="nc" id="L5371">			ps.setInt(psCounter++, authorId);</span>
<span class="nc bnc" id="L5372" title="All 2 branches missed.">			if(Tools.isNotEmpty(filterBlogName))</span>
<span class="nc" id="L5373">				ps.setString(psCounter++, &quot;%&quot; + filterBlogName + &quot;%&quot;);</span>
<span class="nc bnc" id="L5374" title="All 2 branches missed.">			if (filterDateFrom != null)</span>
<span class="nc" id="L5375">				ps.setTimestamp(psCounter++, new Timestamp(filterDateFrom.getTime()));</span>
<span class="nc bnc" id="L5376" title="All 2 branches missed.">			if (filterDateTo != null)</span>
<span class="nc" id="L5377">				ps.setTimestamp(psCounter++, new Timestamp(filterDateTo.getTime()));</span>

<span class="nc" id="L5379">			rs = ps.executeQuery();</span>

<span class="nc" id="L5381">			int failsafe = Constants.getInt(&quot;searchTextAllLimit&quot;);</span>
<span class="nc" id="L5382">			int counter = 0;</span>
<span class="nc bnc" id="L5383" title="All 4 branches missed.">			while (rs.next() &amp;&amp; counter++ &lt; failsafe)</span>
			{
<span class="nc" id="L5385">				DocDetails doc = DocDB.getDocDetails(rs, true, true);</span>

				//mozny filter, ak bol zadany iba vybrany topic
<span class="nc bnc" id="L5388" title="All 4 branches missed.">				if (filterTopicId &gt; -1 &amp;&amp; doc.getGroupId() != filterTopicId)</span>
<span class="nc" id="L5389">					continue;</span>

				//ak sme nasli defaultnu stranku adresara, tak tu nezobrazuj, pretoze pravdepodobne ide o news komponentu
<span class="nc bnc" id="L5392" title="All 4 branches missed.">				if (group == null || group.getGroupId()!= doc.getGroupId())</span>
<span class="nc" id="L5393">					group = groupsDB.getGroup( doc.getGroupId() );</span>
<span class="nc bnc" id="L5394" title="All 4 branches missed.">				if (group != null &amp;&amp; group.getDefaultDocId() == doc.getDocId())</span>
<span class="nc" id="L5395">					continue;</span>

<span class="nc" id="L5397">				docs.add( doc );</span>
<span class="nc" id="L5398">			}</span>

<span class="nc" id="L5400">			rs.close();</span>
<span class="nc" id="L5401">			ps.close();</span>
<span class="nc" id="L5402">			db_conn.close();</span>

<span class="nc" id="L5404">			rs = null;</span>
<span class="nc" id="L5405">			ps = null;</span>
<span class="nc" id="L5406">			db_conn = null;</span>
		}
<span class="nc" id="L5408">		catch (Exception ex)</span>
		{
<span class="nc" id="L5410">			Logger.error(DocDB.class, ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L5416" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L5417">					rs.close();</span>
<span class="nc bnc" id="L5418" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L5419">					ps.close();</span>
<span class="nc bnc" id="L5420" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L5421">					db_conn.close();</span>
			}
<span class="nc" id="L5423">			catch (Exception ex2)</span>
			{
<span class="nc" id="L5425">				Logger.error(DocDB.class, ex2);</span>
<span class="nc" id="L5426">			}</span>
		}

<span class="nc" id="L5429">		return docs;</span>
	}

	/**
	 * Vrati identifikator skupiny Blog
	 *
	 * @return
	 */
	public static int getBlogGroupId()
	{
<span class="fc" id="L5439">		return new SimpleQuery().forInt(&quot;SELECT user_group_id FROM user_groups WHERE user_group_name LIKE 'Blog'&quot;);</span>
	}

	public synchronized void updateInternalCaches(int docId)
	{
		//najskor vyber z DB rovnako ako pre loadUrls
<span class="fc" id="L5445">		java.sql.Connection db_conn = null;</span>
<span class="fc" id="L5446">		java.sql.PreparedStatement ps = null;</span>
<span class="fc" id="L5447">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L5450">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L5451">			String sql = &quot;SELECT doc_id, title, navbar, external_link, group_id, virtual_path, available, searchable, show_in_menu, sort_priority, password_protected, temp_id, date_created, field_a, field_b, field_c FROM documents WHERE doc_id=?&quot;;</span>

<span class="fc" id="L5453">			ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L5454">			ps.setInt(1, docId);</span>
<span class="fc" id="L5455">			rs = ps.executeQuery();</span>

<span class="fc" id="L5457">			DocDetails doc = null;</span>
<span class="fc" id="L5458">			boolean docIsNew = false;</span>
<span class="fc" id="L5459">			int oldGroupId = -1;</span>
<span class="fc" id="L5460">			String oldVirtualPath = null;</span>

<span class="fc bfc" id="L5462" title="All 2 branches covered.">			if (rs.next())</span>
			{
<span class="fc" id="L5464">				doc = getBasicDocDetails(docId, false);</span>
<span class="fc bfc" id="L5465" title="All 2 branches covered.">				if (doc == null)</span>
				{
<span class="fc" id="L5467">					doc = new DocDetails();</span>
<span class="fc" id="L5468">					docIsNew = true;</span>
				}
				else
				{
<span class="fc" id="L5472">					oldGroupId = doc.getGroupId();</span>
<span class="fc" id="L5473">					oldVirtualPath = doc.getVirtualPath();</span>
				}

<span class="fc" id="L5476">				doc.setDocId(rs.getInt(&quot;doc_id&quot;));</span>
<span class="fc" id="L5477">				doc.setTitle(DB.getDbString(rs, &quot;title&quot;));</span>
<span class="fc" id="L5478">				String navbar = DB.getDbString(rs, &quot;navbar&quot;);</span>
<span class="fc bfc" id="L5479" title="All 2 branches covered.">				if (doc.getTitle().equals(navbar)==false) doc.setNavbar(navbar);</span>
<span class="fc" id="L5480">				doc.setExternalLink(DB.getDbString(rs, &quot;external_link&quot;));</span>
<span class="fc" id="L5481">				doc.setGroupId(rs.getInt(&quot;group_id&quot;));</span>
<span class="fc" id="L5482">				doc.setVirtualPath(normalizeVirtualPath(DB.getDbString(rs, &quot;virtual_path&quot;)));</span>
<span class="fc" id="L5483">				doc.setAvailable(rs.getBoolean(&quot;available&quot;));</span>
<span class="fc" id="L5484">				doc.setSearchable(rs.getBoolean(&quot;searchable&quot;));</span>
<span class="fc" id="L5485">				doc.setShowInMenu(rs.getBoolean(&quot;show_in_menu&quot;));</span>
<span class="fc" id="L5486">				doc.setSortPriority(rs.getInt(&quot;sort_priority&quot;));</span>
<span class="fc" id="L5487">				doc.setPasswordProtected(DB.getDbString(rs, &quot;password_protected&quot;));</span>
<span class="fc" id="L5488">				doc.setTempId(rs.getInt(&quot;temp_id&quot;));</span>
<span class="fc" id="L5489">				doc.setDateCreated(rs.getTimestamp(&quot;date_created&quot;).getTime());</span>

<span class="fc" id="L5491">				doc.setFieldA(DB.getDbString(rs, &quot;field_a&quot;));</span>
<span class="fc" id="L5492">				doc.setFieldB(DB.getDbString(rs, &quot;field_b&quot;));</span>
<span class="fc" id="L5493">				doc.setFieldC(DB.getDbString(rs, &quot;field_c&quot;));</span>

				//POZOR: do fieldT si neskor ulozime DOMENU
<span class="fc" id="L5496">				GroupDetails group = GroupsDB.getInstance().getGroup(doc.getGroupId());</span>
<span class="pc bpc" id="L5497" title="2 of 4 branches missed.">				if (group != null &amp;&amp; Tools.isNotEmpty(group.getDomainName()))</span>
				{
<span class="fc" id="L5499">					doc.setFieldT(group.getDomainName());</span>
				}
			}
<span class="fc" id="L5502">			rs.close();</span>
<span class="fc" id="L5503">			ps.close();</span>
<span class="fc" id="L5504">			db_conn.close();</span>
<span class="fc" id="L5505">			rs = null;</span>
<span class="fc" id="L5506">			ps = null;</span>
<span class="fc" id="L5507">			db_conn = null;</span>

<span class="fc bfc" id="L5509" title="All 2 branches covered.">			if (doc != null)</span>
			{
<span class="fc bfc" id="L5511" title="All 2 branches covered.">				if (docIsNew)</span>
<span class="fc" id="L5512">					putToBasicDocDetailsAndResize(doc);</span>

<span class="fc bfc" id="L5514" title="All 4 branches covered.">				if (docIsNew == false &amp;&amp; oldGroupId != doc.getGroupId())</span>
				{
					//najskor vymazeme povodny zaznam
<span class="fc" id="L5517">					List&lt;DocDetails&gt; list = basicAllDocsInGroupTable.get(oldGroupId);</span>
<span class="pc bpc" id="L5518" title="1 of 2 branches missed.">					if (list != null)</span>
					{
<span class="fc" id="L5520">						Iterator&lt;DocDetails&gt; iter = list.iterator();</span>
<span class="pc bpc" id="L5521" title="1 of 2 branches missed.">						while (iter.hasNext())</span>
						{
<span class="fc bfc" id="L5523" title="All 2 branches covered.">							if (iter.next().getDocId()==doc.getDocId())</span>
							{
<span class="fc" id="L5525">								Logger.debug(DocDB.class, &quot;updateInternalCaches: mazem stary zaznam v basilAllDocsInGroupTable &quot;+oldGroupId);</span>
<span class="fc" id="L5526">								iter.remove();</span>
<span class="fc" id="L5527">								break;</span>
							}
						}
					}
				}
<span class="fc bfc" id="L5532" title="All 4 branches covered.">				if (docIsNew || oldGroupId != doc.getGroupId())</span>
				{
					//vlozime na spravne miesto
<span class="fc" id="L5535">					List&lt;DocDetails&gt; list = basicAllDocsInGroupTable.get(doc.getGroupId());</span>
<span class="fc bfc" id="L5536" title="All 2 branches covered.">					if (list==null)</span>
					{
<span class="fc" id="L5538">						list = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L5539">						Logger.debug(DocDB.class, &quot;updateInternalCaches: vytvaram novy list&quot;);</span>
<span class="fc" id="L5540">						basicAllDocsInGroupTable.put(doc.getGroupId(), list);</span>
					}
<span class="fc" id="L5542">					Logger.debug(DocDB.class, &quot;updateInternalCaches: vkladam do listu basicAllDocsInGroupTable&quot;);</span>
<span class="fc" id="L5543">					list.add(doc);</span>
				}

<span class="fc" id="L5546">            	DocumentPublishEvent documentPublishEvent = new DocumentPublishEvent(doc);</span>

				//aktualizovat URL schemu
				//toto drzi hashtabulku url pre danu domenu, vzdy k tomu pristupujte cez getUrlsByUrlDomains(domena)
				//private Map&lt;String, Map&lt;String, Integer&gt;&gt; urlsByUrlDomains = null;
<span class="fc bfc" id="L5551" title="All 4 branches covered.">				if (doc.getVirtualPath().equals(oldVirtualPath)==false || oldGroupId != doc.getGroupId())</span>
				{
<span class="fc" id="L5553">					GroupsDB groupsDB = GroupsDB.getInstance();</span>

<span class="fc" id="L5555">					String oldDomain = null;</span>
<span class="fc" id="L5556">					GroupDetails oldGroup = groupsDB.getGroup(oldGroupId);</span>
<span class="fc bfc" id="L5557" title="All 2 branches covered.">					if (oldGroup != null) oldDomain = oldGroup.getDomainName();</span>

<span class="fc" id="L5559">					String newDomain = null;</span>
<span class="pc bpc" id="L5560" title="1 of 2 branches missed.">					if (Constants.getBoolean(&quot;multiDomainEnabled&quot;))</span>
					{
<span class="fc" id="L5562">						GroupDetails group = groupsDB.getGroup(doc.getGroupId());</span>
<span class="pc bpc" id="L5563" title="1 of 2 branches missed.">						if (group != null) newDomain = group.getDomainName();</span>
<span class="fc" id="L5564">					}</span>
					else
					{
<span class="nc" id="L5567">						newDomain = oldDomain;</span>
					}

					//vymazeme staru hodnotu z hash tabulky
<span class="fc" id="L5571">					TObjectIntHashMap&lt;String&gt; oldTable = getUrlsByUrlDomains(oldDomain, false);</span>
<span class="pc bpc" id="L5572" title="1 of 4 branches missed.">					if (oldTable != null &amp;&amp; oldVirtualPath != null)</span>
					{
<span class="fc" id="L5574">						Logger.debug(DocDB.class, &quot;updateInternalCaches: mazem stare URL (&quot;+oldVirtualPath+&quot;) pre domenu &quot;+oldDomain);</span>
<span class="fc" id="L5575">						oldTable.remove(oldVirtualPath);</span>
					}

					//zapiseme novu
<span class="fc" id="L5579">					TObjectIntHashMap&lt;String&gt; newTable = getUrlsByUrlDomains(newDomain, false);</span>
<span class="pc bpc" id="L5580" title="1 of 2 branches missed.">					if (newTable != null)</span>
					{
<span class="fc" id="L5582">						Logger.debug(DocDB.class, &quot;updateInternalCaches: vkladam URL (&quot;+doc.getVirtualPath()+&quot;) pre domenu &quot;+newDomain);</span>
<span class="fc" id="L5583">						newTable.put(doc.getVirtualPath(), doc.getDocId());</span>
					}

<span class="pc bpc" id="L5586" title="1 of 2 branches missed.">					if (documentPublishEvent != null) {</span>
<span class="fc" id="L5587">						documentPublishEvent.setOldVirtualPath(oldVirtualPath);</span>
					}
				}

<span class="pc bpc" id="L5591" title="1 of 2 branches missed.">				if (documentPublishEvent != null) {</span>
<span class="fc" id="L5592">					(new WebjetEvent&lt;DocumentPublishEvent&gt;(documentPublishEvent, WebjetEventType.ON_PUBLISH)).publishEvent();</span>
				}

				//aktualizovat v clustri
<span class="fc" id="L5596">				ClusterDB.addRefresh(&quot;sk.iway.iwcm.doc.DocDB-&quot;+doc.getDocId());</span>

				//aktualizuj si publicable cache
<span class="fc" id="L5599">				readPagesToPublic();</span>

				//aktualizuj cache dokumentov
<span class="pc bpc" id="L5602" title="1 of 2 branches missed.">				if (cachedDocs.containsKey(Integer.valueOf(doc.getDocId())))</span>
				{
<span class="nc" id="L5604">					DocDetails docRefreshCache = getDoc(doc.getDocId(), -1, false);</span>
<span class="nc bnc" id="L5605" title="All 2 branches missed.">					if (docRefreshCache != null)</span>
					{
<span class="nc" id="L5607">						Logger.debug(DocDB.class, &quot;refreshing cached doc: &quot;+docRefreshCache.getDocId()+&quot; &quot;+docRefreshCache.getTitle());</span>
<span class="nc" id="L5608">						cachedDocs.put(Integer.valueOf(doc.getDocId()), docRefreshCache);</span>
					}
				}

				//aktualizuj Cache
<span class="fc" id="L5613">				Cache.getInstance().onDocChange(doc);</span>
				/*spravime update dokumentu v indexe */
<span class="fc" id="L5615">				Documents.updateSingleDocument(docId);</span>
<span class="fc" id="L5616">			}</span>
			/**
			 * ak sme nic nevytiahli z DB tak to znamena ze dokument bol zmazany a treba ho
			 * zmazat aj z internych tabuliek a cache a indexu
			 */
			else
			{
<span class="fc" id="L5623">				cleanupDocReferences(docId);</span>
			}
		}
<span class="nc" id="L5626">		catch (Exception ex)</span>
		{
<span class="nc" id="L5628">			Logger.error(DocDB.class, ex);</span>
		}
		finally
		{
			try{
<span class="pc bpc" id="L5633" title="1 of 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="pc bpc" id="L5634" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L5635" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L5636">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="fc" id="L5638">	}</span>

	/**
	 * Tato metoda zmaze informacie o doc s docId z internych tabuliek
	 * v pamati, basicAllDocsTable, basicAllDocsInGroupTable, urlsByUrlDomains
	 * basicAllDocsTable, z cache ak sa tam nachadza, zmaze takisto data z lucene indexu
	 * informacie o dokumente vyberie z basicAllDocsTable. ak sa tam doc uz nenachadza tak
	 * metode nic nespravi
	 * @param docId id dokumentu
	 * @author mhalas
	 */
	private void cleanupDocReferences(int docId)
	{
		DocDetails doc;
<span class="fc" id="L5652">		doc = basicAllDocsTable.get(docId);</span>
		/* uz je to pravdepodobne vymazane aj z pamati */
<span class="fc bfc" id="L5654" title="All 2 branches covered.">		if(doc == null) return;</span>
<span class="fc" id="L5655">		removeDocFromBasilAllDocsInGroup(doc);</span>
<span class="fc" id="L5656">		TObjectIntHashMap&lt;String&gt; oldTable = DocDB.getInstance().getUrlsByUrlDomains(doc.getGroup().getDomainName(), false);</span>
<span class="pc bpc" id="L5657" title="2 of 4 branches missed.">		if (oldTable != null &amp;&amp; doc.getVirtualPath() != null)</span>
		{
<span class="fc" id="L5659">			Logger.debug(DocDB.class, &quot;updateInternalCaches: mazem stare URL (&quot;+doc.getVirtualPath()+&quot;) pre domenu &quot;+doc.getGroup().getDomainName());</span>
<span class="fc" id="L5660">			oldTable.remove(doc.getVirtualPath());</span>
		}
<span class="fc" id="L5662">		basicAllDocsTable.remove(docId);</span>
<span class="fc" id="L5663">		readPagesToPublic();</span>
<span class="pc bpc" id="L5664" title="1 of 2 branches missed.">		if (cachedDocs.containsKey(Integer.valueOf(docId))) cachedDocs.remove(Integer.valueOf(docId));</span>
<span class="fc" id="L5665">		Cache.getInstance().clearAll();</span>
<span class="fc" id="L5666">		Cache.getInstance(true);</span>
<span class="fc" id="L5667">		ClusterDB.addRefresh(DocDB.class.getName()+&quot;-&quot;+docId);</span>
<span class="fc" id="L5668">		Documents.deleteSingleDocument(docId);</span>
<span class="fc" id="L5669">	}</span>

	/**
	 * Skontroluje ci dany DocDetails nie je v cache, ak je vrati, ak nie je ziska z DB a prida do cache (pouziva sa primarne z TemplatesDB)
	 * @param docId
	 * @return
	 */
	public DocDetails getDocAndAddToCacheIfNot(int docId)
	{
<span class="fc" id="L5678">		DocDetails doc = null;</span>
<span class="pc bpc" id="L5679" title="1 of 2 branches missed.">		if (cachedDocs!=null)</span>
		{
<span class="fc" id="L5681">			doc = cachedDocs.get(Integer.valueOf(docId));</span>
<span class="fc bfc" id="L5682" title="All 2 branches covered.">			if (doc!=null)</span>
			{
<span class="fc" id="L5684">				Logger.debug(DocDB.class, &quot;getDocAndAddToCacheIfNot - returning from cache &quot;+docId);</span>
<span class="fc" id="L5685">				return (doc);</span>
			}
		}
<span class="fc" id="L5688">		doc = getDoc(docId);</span>
<span class="pc bpc" id="L5689" title="2 of 4 branches missed.">		if (cachedDocs!=null &amp;&amp; doc != null)</span>
		{
<span class="fc" id="L5691">			Logger.debug(DocDB.class, &quot;getDocAndAddToCacheIfNot - caching &quot;+docId);</span>
<span class="fc" id="L5692">			cachedDocs.put(Integer.valueOf(docId), doc);</span>
		}
<span class="fc" id="L5694">		return doc;</span>
	}

	/**
	 * novy sposob vyhladavania pouziva povodne prazdny stlpec file_name pre urcenie adresara
	 * v ktorom sa ma hladat (namiesto group_id IN (sialene dlhy zoznam ideciek))
	 * tato metoda stlpec naplni hodnotami
	 * treba volat po zmene adresara (ak sa presunie, alebo nieco podobne)
	 * @param rootGroupId - id adresara, alebo -1 pre aktualizaciu vsetkeho
	 */
	public static void updateFileNameField(int rootGroupId)
	{
		//nacitaj si hodnoty doc_id, group_id do listu

<span class="fc" id="L5708">		Connection db_conn = null;</span>
<span class="fc" id="L5709">		PreparedStatement ps = null;</span>
<span class="fc" id="L5710">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L5713">			List&lt;LabelValueDetails&gt; list = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L5714">			int counter = 0;</span>

<span class="fc" id="L5716">			db_conn = DBPool.getConnection();</span>

<span class="fc" id="L5718">			StringBuilder sql = new StringBuilder(&quot;SELECT doc_id, group_id FROM documents WHERE doc_id&gt;0&quot;);</span>
<span class="pc bpc" id="L5719" title="1 of 2 branches missed.">			if (rootGroupId &gt; 0) sql.append(StatDB.getRootGroupWhere(&quot;group_id&quot;, rootGroupId));</span>

<span class="fc" id="L5721">			Logger.debug(DocDB.class, &quot;updateFileNameField: sql=&quot;+sql);</span>

<span class="fc" id="L5723">			ps = db_conn.prepareStatement(sql.toString());</span>
<span class="fc" id="L5724">			rs = ps.executeQuery();</span>
<span class="fc bfc" id="L5725" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="fc" id="L5727">				LabelValueDetails lvd = new LabelValueDetails();</span>
<span class="fc" id="L5728">				lvd.setInt1(rs.getInt(&quot;doc_id&quot;));</span>
<span class="fc" id="L5729">				lvd.setInt2(rs.getInt(&quot;group_id&quot;));</span>
<span class="fc" id="L5730">				list.add(lvd);</span>

<span class="fc" id="L5732">				counter++;</span>
<span class="pc bpc" id="L5733" title="1 of 2 branches missed.">				if (counter % 1000 == 0)</span>
				{
<span class="nc" id="L5735">					Logger.debug(DocDB.class, &quot;updateFileNameField: Reading data &quot;+counter);</span>
				}
<span class="fc" id="L5737">			}</span>
<span class="fc" id="L5738">			rs.close();</span>
<span class="fc" id="L5739">			ps.close();</span>


			//poukladaj hodnoty
<span class="fc" id="L5743">			GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="fc" id="L5744">			ps = db_conn.prepareStatement(&quot;UPDATE documents SET file_name=? WHERE doc_id=?&quot;);</span>

<span class="fc" id="L5746">			int total = counter;</span>
<span class="fc" id="L5747">			counter = 0;</span>
<span class="fc bfc" id="L5748" title="All 2 branches covered.">			for (LabelValueDetails lvd : list)</span>
			{
<span class="fc" id="L5750">				GroupDetails group = groupsDB.getGroup(lvd.getInt2());</span>
<span class="fc" id="L5751">				String fileName = null;</span>

<span class="pc bpc" id="L5753" title="1 of 4 branches missed.">				if (group != null &amp;&amp; group.isInternal()==false)</span>
				{
<span class="fc" id="L5755">					fileName = groupsDB.getGroupNamePath(lvd.getInt2());</span>
				}

<span class="fc" id="L5758">				ps.setString(1, DB.prepareString(fileName, 255));</span>
<span class="fc" id="L5759">				ps.setInt(2, lvd.getInt1());</span>
<span class="fc" id="L5760">				ps.execute();</span>

<span class="fc" id="L5762">				counter++;</span>
<span class="pc bpc" id="L5763" title="1 of 2 branches missed.">				if (counter % 1000 == 0)</span>
				{
<span class="nc" id="L5765">					Logger.debug(DocDB.class, &quot;Updating data &quot;+counter+&quot;/&quot;+total);</span>
				}
<span class="fc" id="L5767">			}</span>
<span class="fc" id="L5768">			ps.close();</span>

<span class="fc" id="L5770">			db_conn.close();</span>
<span class="fc" id="L5771">			rs = null;</span>
<span class="fc" id="L5772">			ps = null;</span>
<span class="fc" id="L5773">			db_conn = null;</span>
		}
<span class="nc" id="L5775">		catch (Exception ex)</span>
		{
<span class="nc" id="L5777">			Logger.error(DocDB.class, ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L5783" title="1 of 2 branches missed.">				if (rs!=null) rs.close();</span>
<span class="pc bpc" id="L5784" title="1 of 2 branches missed.">				if (ps!=null) ps.close();</span>
<span class="pc bpc" id="L5785" title="1 of 2 branches missed.">				if (db_conn!=null) db_conn.close();</span>
			}
<span class="nc" id="L5787">			catch (Exception ex2)</span>
			{
				//
<span class="fc" id="L5790">			}</span>
		}

		//update-nem este root_group_l1 - l3
<span class="fc" id="L5794">		updateRootGroupLevelValues(rootGroupId);</span>
<span class="fc" id="L5795">	}</span>

	public List&lt;DocBasic&gt; getPublicableDocs(){
<span class="fc" id="L5798">		return docPublishService.getPublicableDocs();</span>
	}

	public void forceRefreshMasterSlaveMappings()
	{
<span class="fc" id="L5803">		slavesMasterMappings = null;</span>
<span class="fc" id="L5804">		masterMappings = null;</span>
<span class="fc" id="L5805">	}</span>

	/**
	 * inicializuje mapu master-slave stranok
	 * @return
	 */
	public Map&lt;Integer, Integer&gt; getSlavesMasterMappings()
	{
<span class="fc bfc" id="L5813" title="All 2 branches covered.">		if(slavesMasterMappings == null)</span>
<span class="fc" id="L5814">			slavesMasterMappings = MultigroupMappingDB.getAllMappings();</span>

<span class="fc" id="L5816">		return slavesMasterMappings;</span>
	}

	/**
	 * inicializuje mapu master-all_master_slaves stranok
	 * @return
	 */
	public Map&lt;Integer, Integer[]&gt; getMasterMappings()
	{
<span class="pc bpc" id="L5825" title="1 of 4 branches missed.">		if(getSlavesMasterMappings() != null &amp;&amp; masterMappings == null)</span>
		{
<span class="fc" id="L5827">			masterMappings = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L5828" title="All 2 branches covered.">			for(Entry&lt;Integer, Integer&gt; ms : getSlavesMasterMappings().entrySet())</span>
			{
<span class="fc" id="L5830">				Integer[] slavesOfMaster = masterMappings.get(ms.getValue());</span>
<span class="fc bfc" id="L5831" title="All 2 branches covered.">				if(slavesOfMaster == null) {</span>
<span class="fc" id="L5832">					masterMappings.put(ms.getValue(), new Integer[]{ms.getKey()});</span>
				} else {
<span class="fc" id="L5834">					Integer[] slavesOfMasterTmp = Arrays.copyOf(slavesOfMaster, slavesOfMaster.length+1);</span>
<span class="fc" id="L5835">					slavesOfMasterTmp[slavesOfMaster.length] = ms.getKey();</span>
<span class="fc" id="L5836">					masterMappings.put(ms.getValue(), slavesOfMasterTmp);</span>
				}
<span class="fc" id="L5838">			}</span>
			/*
			for(Iterator iterator = masterMappings.entrySet().iterator(); iterator.hasNext();)
			{
				Entry&lt;Integer, Integer[]&gt; mm = (Entry&lt;Integer, Integer[]&gt;)iterator.next();
				System.out.println(&quot;&gt;&gt;&gt;&gt; &quot;+mm.getKey()+&quot;: &quot;+Arrays.toString(mm.getValue()));
			}
			 */
		}

<span class="fc" id="L5848">		return masterMappings;</span>
	}

	/**
	 * Parses docid from url string, if any error or string does not contain docid
	 * if url does not contain docid, uses getVirtualPathDocId to get docId
	 * returns -1
	 * @param url
	 * @return docid or -1
	 */
	public static int parseDocIdFromDmailUrl(String url,HttpServletRequest request){

<span class="nc" id="L5860">		int ret = -1;</span>
<span class="nc" id="L5861">		String path = url;</span>

<span class="nc bnc" id="L5863" title="All 2 branches missed.">		if (!Tools.isEmpty(url))</span>
		{
<span class="nc" id="L5865">			url = url.toLowerCase();</span>
<span class="nc bnc" id="L5866" title="All 2 branches missed.">			if (url.contains(&quot;docid&quot;))</span>
			{
<span class="nc" id="L5868">				url = url.split(&quot;docid=&quot;)[1];</span>
<span class="nc" id="L5869">				url = url.split(&quot;&amp;&quot;)[0];</span>
<span class="nc" id="L5870">				Pattern p = Pattern.compile(&quot;\\d+&quot;);</span>
<span class="nc" id="L5871">				Matcher m = p.matcher(url);</span>
<span class="nc bnc" id="L5872" title="All 2 branches missed.">				if (m.find())</span>
				{
<span class="nc" id="L5874">					ret = Integer.parseInt(Tools.getStringValue(m.group(), &quot;-1&quot;));</span>
				}
<span class="nc" id="L5876">			}</span>
<span class="nc bnc" id="L5877" title="All 2 branches missed.">			else if (ret == -1)</span>
			{
<span class="nc" id="L5879">				String domain = DocDB.getDomain(request);</span>
				URL durl;
				try
				{
<span class="nc" id="L5883">					durl = new URL(path);</span>
<span class="nc" id="L5884">					path = durl.getPath();</span>
				}
<span class="nc" id="L5886">				catch (MalformedURLException e)</span>
				{
					//ak to nie je url tak to je path a rovno to dame metode
					//getVirtualPathDocId
<span class="nc" id="L5890">				}</span>
<span class="nc" id="L5891">				ret = DocDB.getInstance().getVirtualPathDocId(path, domain);</span>
			}
		}

<span class="nc" id="L5895">		return ret;</span>
	}

	/**
	 * novy sposob vyhladavania pouziva povodne prazdne stlpce root_group_l1, root_group_l2, root_group_l3
	 * co obsahuju pre kazdy adresar (hodnota group_id) ID adresarov na prvej, druhej a tretej urovni,
	 * co urychli vyhladavanie news v &quot;getDocPerex&quot; pre adresare na prvych troch urovnich (namiesto group_id IN (sialene dlhy zoznam ideciek))
	 *
	 * tato metoda stlpce root_group_l1, root_group_l2, root_group_l3 naplni hodnotami
	 * treba volat po zmene adresara (ak sa presunie, alebo nieco podobne)
	 * @param rootGroupId - id adresara, alebo -1 pre aktualizaciu vsetkeho
	 */
	public static void updateRootGroupLevelValues(int rootGroupId)
	{
<span class="pc bpc" id="L5909" title="3 of 4 branches missed.">		if (rootGroupId &lt; 1 &amp;&amp; InitServlet.isTypeCloud())</span>
		{
<span class="nc" id="L5911">            rootGroupId = CloudToolsForCore.getDomainId();</span>
		}
<span class="pc bpc" id="L5913" title="1 of 2 branches missed.">		if (InitServlet.isTypeCloud())</span>
		{
<span class="nc" id="L5915">			GroupDetails grp = GroupsDB.getInstance().getGroup(rootGroupId);</span>
<span class="nc bnc" id="L5916" title="All 4 branches missed.">			if (grp == null || grp.getDomainName().equals(CloudToolsForCore.getDomainName())==false) return;</span>
		}

		//nacitaj si hodnoty doc_id, group_id do listu
<span class="fc" id="L5920">		Connection db_conn = null;</span>
<span class="fc" id="L5921">		PreparedStatement ps = null;</span>
<span class="fc" id="L5922">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L5925">			List&lt;LabelValueDetails&gt; list = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L5926">			int counter = 0;</span>

<span class="fc" id="L5928">			db_conn = DBPool.getConnection();</span>

<span class="fc" id="L5930">			StringBuilder sql = new StringBuilder(&quot;SELECT doc_id, group_id FROM documents WHERE doc_id&gt;0&quot;);</span>
<span class="pc bpc" id="L5931" title="1 of 2 branches missed.">			if (rootGroupId &gt; 0) sql.append(StatDB.getRootGroupWhere(&quot;group_id&quot;, rootGroupId));</span>

<span class="fc" id="L5933">			Logger.debug(DocDB.class, &quot;updateRootGroupLevelValues: sql=&quot;+sql);</span>

<span class="fc" id="L5935">			ps = db_conn.prepareStatement(sql.toString());</span>
<span class="fc" id="L5936">			rs = ps.executeQuery();</span>
<span class="fc bfc" id="L5937" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="fc" id="L5939">				LabelValueDetails lvd = new LabelValueDetails();</span>
<span class="fc" id="L5940">				lvd.setInt1(rs.getInt(&quot;doc_id&quot;));</span>
<span class="fc" id="L5941">				lvd.setInt2(rs.getInt(&quot;group_id&quot;));</span>
<span class="fc" id="L5942">				list.add(lvd);</span>

<span class="fc" id="L5944">				counter++;</span>
<span class="pc bpc" id="L5945" title="1 of 2 branches missed.">				if (counter % 1000 == 0)</span>
				{
<span class="nc" id="L5947">					Logger.debug(DocDB.class, &quot;updateRootGroupLevelValues: Reading data &quot;+counter);</span>
				}
<span class="fc" id="L5949">			}</span>
<span class="fc" id="L5950">			rs.close();</span>
<span class="fc" id="L5951">			ps.close();</span>


			//poukladaj hodnoty
<span class="fc" id="L5955">			ps = db_conn.prepareStatement(&quot;UPDATE documents SET root_group_l1=?, root_group_l2=?, root_group_l3=? WHERE doc_id=?&quot;);</span>

<span class="fc" id="L5957">			int total = counter;</span>
<span class="fc" id="L5958">			counter = 0;</span>
<span class="fc bfc" id="L5959" title="All 2 branches covered.">			for (LabelValueDetails lvd : list)</span>
			{
<span class="fc" id="L5961">				DocDB.getRootGroupL(lvd.getInt2(), ps, 1);</span>

<span class="fc" id="L5963">				ps.setInt(4, lvd.getInt1());</span>
<span class="fc" id="L5964">				ps.execute();</span>

<span class="fc" id="L5966">				counter++;</span>
<span class="pc bpc" id="L5967" title="1 of 2 branches missed.">				if (counter % 1000 == 0)</span>
				{
<span class="nc" id="L5969">					Logger.debug(DocDB.class, &quot;Updating data &quot;+counter+&quot;/&quot;+total);</span>
				}
<span class="fc" id="L5971">			}</span>
<span class="fc" id="L5972">			ps.close();</span>

<span class="fc" id="L5974">			db_conn.close();</span>
<span class="fc" id="L5975">			rs = null;</span>
<span class="fc" id="L5976">			ps = null;</span>
<span class="fc" id="L5977">			db_conn = null;</span>
		}
<span class="nc" id="L5979">		catch (Exception ex)</span>
		{
<span class="nc" id="L5981">			Logger.error(DocDB.class, ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L5987" title="1 of 2 branches missed.">				if (rs!=null) rs.close();</span>
<span class="pc bpc" id="L5988" title="1 of 2 branches missed.">				if (ps!=null) ps.close();</span>
<span class="pc bpc" id="L5989" title="1 of 2 branches missed.">				if (db_conn!=null) db_conn.close();</span>
			}
<span class="nc" id="L5991">			catch (Exception ex2)</span>
			{
				//
<span class="fc" id="L5994">			}</span>
		}
<span class="fc" id="L5996">	}</span>

	/**
	 * vrati hodnoty pre root_group_l1 - root_group_l3 a pripadne aj nastavi do PreparedStatement
	 * @param groupId
	 * @param ps
	 * @param psInd
	 * @return
	 */
	public static int[] getRootGroupL(int groupId, PreparedStatement ps, int psInd)
	{
<span class="fc" id="L6007">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="fc" id="L6008">		List&lt;GroupDetails&gt; parentGroups = groupsDB.getParentGroups(groupId);</span>
<span class="fc" id="L6009">		int[] root_group_l = new int[3];</span>
<span class="fc" id="L6010">		Arrays.fill(root_group_l, 0);</span>
<span class="fc" id="L6011">		int ind = 0;</span>
<span class="fc bfc" id="L6012" title="All 2 branches covered.">		for(int i=parentGroups.size()-1; i &gt;= 0; i--)</span>
		{
<span class="fc" id="L6014">			root_group_l[ind++] = parentGroups.get(i).getGroupId();</span>
<span class="fc bfc" id="L6015" title="All 2 branches covered.">			if(ind == 3) break;</span>
		}

<span class="fc bfc" id="L6018" title="All 2 branches covered.">		if(ps != null)</span>
		{
			try
			{
<span class="pc bpc" id="L6022" title="1 of 2 branches missed.">				if(root_group_l[0] &gt; 0) ps.setInt(psInd++, root_group_l[0]);</span>
<span class="nc" id="L6023">				else ps.setObject(psInd++, null);</span>
<span class="fc bfc" id="L6024" title="All 2 branches covered.">				if(root_group_l[1] &gt; 0) ps.setInt(psInd++, root_group_l[1]);</span>
<span class="fc" id="L6025">				else ps.setObject(psInd++, null);</span>
<span class="fc bfc" id="L6026" title="All 2 branches covered.">				if(root_group_l[2] &gt; 0) ps.setInt(psInd++, root_group_l[2]);</span>
<span class="fc" id="L6027">				else ps.setObject(psInd++, null);</span>
			}
<span class="nc" id="L6029">			catch (SQLException e)</span>
			{
<span class="nc" id="L6031">				sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L6032">			}</span>
		}

<span class="fc" id="L6035">		return root_group_l;</span>
	}

	/**
	 * aktualizuj hodnoty v perex_group_doc
	 * @param docId
	 * @param perexGroups
	 */
	public static void udpdatePerexGroupDoc(int docId, String perexGroups)
	{
<span class="fc" id="L6045">		boolean perexGroupUseJoin = Constants.getBoolean(&quot;perexGroupUseJoin&quot;);</span>
<span class="pc bpc" id="L6046" title="1 of 2 branches missed.">		if(perexGroupUseJoin)</span>
		{
			//skontrolujem aj MultigroupMapping
<span class="nc" id="L6049">			int masterId = MultigroupMappingDB.getMasterDocId(docId);</span>
<span class="nc bnc" id="L6050" title="All 2 branches missed.">			List&lt;MultigroupMapping&gt; slavesId = MultigroupMappingDB.getSlaveMappings(masterId &gt; 0 ? masterId : docId);</span>
<span class="nc" id="L6051">			List&lt;Integer&gt; docIdList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L6052" title="All 2 branches missed.">			if(masterId &gt; 0)</span>
<span class="nc" id="L6053">				docIdList.add(Integer.valueOf(masterId));</span>
<span class="nc bnc" id="L6054" title="All 4 branches missed.">			if(slavesId != null &amp;&amp; slavesId.size() &gt; 0)</span>
<span class="nc bnc" id="L6055" title="All 2 branches missed.">				for(MultigroupMapping mm : slavesId)</span>
<span class="nc" id="L6056">					docIdList.add(Integer.valueOf(mm.getDocId()));</span>
<span class="nc bnc" id="L6057" title="All 4 branches missed.">			if(masterId &lt; 1 || docIdList.size() &lt; 1)</span>
<span class="nc" id="L6058">				docIdList.add(Integer.valueOf(docId));</span>

<span class="nc" id="L6060">			Connection db_conn = null;</span>
<span class="nc" id="L6061">			PreparedStatement ps = null;</span>
			try
			{
<span class="nc" id="L6064">				db_conn = DBPool.getConnection();</span>
<span class="nc" id="L6065">				String[] pgArray = Tools.getTokens(perexGroups, &quot;,&quot;);</span>

<span class="nc bnc" id="L6067" title="All 2 branches missed.">				for(Integer id : docIdList)</span>
				{
<span class="nc" id="L6069">					Logger.println(DocDB.class, &quot;udpdatePerexGroupDoc - doc_id = &quot;+id+&quot;; perexGroups = &quot;+perexGroups);</span>

<span class="nc" id="L6071">					ps = db_conn.prepareStatement(&quot;DELETE FROM perex_group_doc WHERE doc_id = ?&quot;);</span>
<span class="nc" id="L6072">					ps.setInt(1, id);</span>
<span class="nc" id="L6073">					ps.execute();</span>
<span class="nc" id="L6074">					ps.close();</span>
<span class="nc" id="L6075">					ps = null;</span>

<span class="nc bnc" id="L6077" title="All 2 branches missed.">					for(String pg : pgArray)</span>
					{
<span class="nc bnc" id="L6079" title="All 2 branches missed.">						if(Tools.getIntValue(pg, -1) &gt; 0)</span>
						{
<span class="nc" id="L6081">							ps = db_conn.prepareStatement(&quot;INSERT INTO perex_group_doc (doc_id, perex_group_id) VALUES (?,?)&quot;);</span>
<span class="nc" id="L6082">							ps.setInt(1, id);</span>
<span class="nc" id="L6083">							ps.setInt(2, Tools.getIntValue(pg, 0));</span>
<span class="nc" id="L6084">							ps.execute();</span>
<span class="nc" id="L6085">							ps.close();</span>
<span class="nc" id="L6086">							ps = null;</span>
						}
					}
<span class="nc" id="L6089">				}</span>

<span class="nc" id="L6091">				db_conn.close();</span>
<span class="nc" id="L6092">				db_conn = null;</span>
			}
<span class="nc" id="L6094">			catch (Exception ex)</span>
			{
<span class="nc" id="L6096">				Logger.error(DocDB.class, ex);</span>
			}
			finally
			{
				try
				{
<span class="nc bnc" id="L6102" title="All 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L6103">						ps.close();</span>
<span class="nc bnc" id="L6104" title="All 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L6105">						db_conn.close();</span>
				}
<span class="nc" id="L6107">				catch (Exception ex2)</span>
				{
					//
<span class="nc" id="L6110">				}</span>
			}
		}
<span class="fc" id="L6113">	}</span>

	/**
	 * Prenesene z GroupsListAction koli kontrole na cloud WJ
	 * @param user
	 * @return
	 */
	public static List&lt;DocDetails&gt; getMyPages(Identity user)
	{
		//ziskaj Moje Dokumenty
<span class="nc" id="L6123">		List&lt;DocDetails&gt; myPages = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L6124">		StringTokenizer st = new StringTokenizer(user.getEditablePages(), &quot;,&quot;);</span>
		int id;
		DocDetails page;
<span class="nc" id="L6127">		DocDB docDB = DocDB.getInstance();</span>
<span class="nc" id="L6128">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="nc bnc" id="L6129" title="All 2 branches missed.">		while (st.hasMoreTokens())</span>
		{
<span class="nc" id="L6131">			id = Integer.parseInt(st.nextToken());</span>
<span class="nc" id="L6132">			page = docDB.getDoc(id);</span>
<span class="nc bnc" id="L6133" title="All 2 branches missed.">			if (page != null)</span>
			{
				//skontroluj, ci uz nemam pristup k adresaru (aby nebola duplicita)
<span class="nc bnc" id="L6136" title="All 2 branches missed.">				if ((&quot;,&quot;+user.getEditableGroups()+&quot;,&quot;).indexOf(&quot;,&quot;+page.getGroupId()+&quot;,&quot;)==-1)</span>
				{
<span class="nc" id="L6138">					page.setNavbar(groupsDB.getNavbarNoHref(page.getGroupId()));</span>
<span class="nc" id="L6139">					myPages.add(page);</span>
				}
			}
		}
<span class="nc" id="L6143">		return myPages;</span>
	}

	/**
	 * Vrati zoznam naposledy editovanych stranok podla tabulky documents_history. Vynecha stranky ktorych virtual_path zacina na /files/ co su zaindexovane subory
	 * Prenesene z GroupsListAction koli kontrole na cloud WJ
	 * @deprecated - pouzite AdminTools.get...
	 * @param userId
	 * @param maxSize
	 * @return
	 */
	@Deprecated
	public static List&lt;DocDetails&gt; getMyRecentPages(int userId, int maxSize)
	{
<span class="nc" id="L6157">		return(AdminTools.getMyRecentPages(userId,maxSize));</span>
	}

	/**
	 * Zmeni nazov grupy. Grupa musi mat defaultne DocID &gt; 0 a nesmie to byt v System adresari / internom / s vypnutym zobrazenim
	 * @param groupId - id grupy ktorej nazov ideme zmenit
	 * @param newTitle - novy nazov grupy
	 * @return - true ak vsetko prebehlo v poriadku
	 */
	public static boolean changeGroupTitle(int groupId, int docId, String newTitle)
	{
<span class="fc" id="L6168">		return changeGroupTitle(groupId, docId, newTitle, false);</span>
	}

	/**
	 * Zmeni nazov grupy. Grupa musi mat defaultne DocID &gt; 0 a nesmie to byt v System adresari
	 * @param groupId - id grupy ktorej nazov ideme zmenit
	 * @param docId - id web stranky ktorej zmena nastala
	 * @param newTitle - novy nazov grupy
	 * @param forceUpdate - ak je true, zmeni sa aj nazov interneho/nezobrazovaneho priecinka
	 * @return
	 */
	public static boolean changeGroupTitle(int groupId, int docId, String newTitle, boolean forceUpdate)
	{
<span class="fc" id="L6181">		GroupDetails grDetails =  GroupsDB.getInstance().getGroup(groupId);</span>
<span class="pc bpc" id="L6182" title="3 of 10 branches missed.">		if(grDetails != null &amp;&amp; grDetails.getDefaultDocId() == docId &amp;&amp; newTitle != null &amp;&amp; !newTitle.equals(grDetails.getGroupName()) &amp;&amp;</span>
<span class="pc bpc" id="L6183" title="3 of 6 branches missed.">				(forceUpdate || (grDetails.isInternal()==false &amp;&amp; grDetails.getMenuType()!=GroupDetails.MENU_TYPE_HIDDEN &amp;&amp;  grDetails.getFullPath()!=null))</span>
<span class="pc bpc" id="L6184" title="1 of 4 branches missed.">				&amp;&amp; grDetails.getFullPath().indexOf(&quot;/System&quot;)==-1 &amp;&amp; grDetails.getParentGroupId()&gt;0)</span>
		{
<span class="fc" id="L6186">			Logger.debug(DocDB.class, &quot;Renaming group: &quot;+groupId+&quot; to name :&quot;+newTitle);</span>
<span class="fc" id="L6187">			grDetails.setGroupName(newTitle);</span>
<span class="fc" id="L6188">			grDetails.setNavbar(newTitle);</span>
<span class="pc bpc" id="L6189" title="1 of 2 branches missed.">			if (grDetails.getUrlDirName().startsWith(&quot;/&quot;)==false)</span>
			{
<span class="fc" id="L6191">				String urlDirName = sk.iway.iwcm.DB.internationalToEnglish(newTitle).toLowerCase();</span>
<span class="fc" id="L6192">				urlDirName = DocTools.removeCharsDir(urlDirName, true).toLowerCase();</span>
<span class="fc" id="L6193">				grDetails.setUrlDirName(urlDirName);</span>
			}
<span class="fc" id="L6195">			GroupsDB.getInstance().setGroup(grDetails);</span>
<span class="fc" id="L6196">			return true;</span>
		}
<span class="fc" id="L6198">		return false;</span>
	}


	protected void changeUrlInUrlmap(String oldUrl, String newUrl)
	{
<span class="nc bnc" id="L6204" title="All 2 branches missed.">		if (urlsByUrlDomains.containsKey(oldUrl))</span>
		{
<span class="nc" id="L6206">			TObjectIntHashMap&lt;String&gt; urlsForDomain = urlsByUrlDomains.get(oldUrl);</span>
<span class="nc" id="L6207">			urlsByUrlDomains.remove(oldUrl);</span>
<span class="nc" id="L6208">			urlsByUrlDomains.put(newUrl, urlsForDomain);</span>
		}

<span class="nc" id="L6211">	}</span>

	/**
	 * Zmaze zaznam o dokumente z prislusnej grupy
	 * v basicAllDocsInGroupTable
	 * @param doc
	 * @author mhalas
	 */
	private void removeDocFromBasilAllDocsInGroup(DocDetails doc)
	{
<span class="fc" id="L6221">		List&lt;DocDetails&gt; list = DocDB.getInstance().basicAllDocsInGroupTable.get(doc.getGroupId());</span>
<span class="pc bpc" id="L6222" title="1 of 2 branches missed.">		if (list != null)</span>
		{
<span class="fc" id="L6224">			Iterator&lt;DocDetails&gt; iter = list.iterator();</span>
<span class="pc bpc" id="L6225" title="1 of 2 branches missed.">			while (iter.hasNext())</span>
			{
<span class="fc bfc" id="L6227" title="All 2 branches covered.">				if (iter.next().getDocId()==doc.getDocId())</span>
				{
<span class="fc" id="L6229">					Logger.debug(DocDB.class, &quot;updateInternalCaches: mazem stary zaznam v basilAllDocsInGroupTable &quot;+doc.getGroupId());</span>
<span class="fc" id="L6230">					iter.remove();</span>
<span class="fc" id="L6231">					break;</span>
				}
			}
		}
<span class="fc" id="L6235">	}</span>

	/**
	 * @deprecated - pouzite AdminTools.get...
	 */
	@Deprecated
	public static List&lt;DocDetails&gt; getRecentPages(int size){
<span class="nc" id="L6242">		return AdminTools.getRecentPages(size);</span>
	}

	/**
	 * @deprecated - pouzite AdminTools.get...
	 */
	@Deprecated
	public static List&lt;DocDetails&gt; getRecentPages(int size, Identity user)
	{
<span class="nc" id="L6251">		return AdminTools.getRecentPages(size,user);</span>
	}

	public DocDetails getDocByField(String fieldName, String fieldValue)
	{
<span class="nc" id="L6256">		return getDocByField(fieldName, fieldValue, false);</span>
	}

	public DocDetails getDocByField(String fieldName, String fieldValue, boolean noData)
	{
<span class="nc" id="L6261">		String sql = &quot;&quot;;</span>

<span class="nc" id="L6263">		Connection connection = null;</span>
<span class="nc" id="L6264">		PreparedStatement ps = null;</span>
<span class="nc" id="L6265">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L6268">			DocDetails doc = null;</span>

<span class="nc bnc" id="L6270" title="All 2 branches missed.">			String select = DocDB.getDocumentFields(noData==false);</span>
<span class="nc bnc" id="L6271" title="All 2 branches missed.">			if (Constants.getBoolean(&quot;docAuthorLazyLoad&quot;)) {</span>
<span class="nc" id="L6272">				sql = &quot;SELECT &quot; + select + &quot; FROM documents d WHERE field_&quot; + fieldName + &quot;= ?&quot;;</span>
			} else {
<span class="nc" id="L6274">				sql = &quot;SELECT u.title as u_title, u.first_name, u.last_name, u.email, u.photo, &quot; + select + &quot; FROM documents d LEFT JOIN users u ON d.author_id=u.user_id WHERE d.field_&quot; + fieldName + &quot;= ?&quot;;</span>
			}

			try {
<span class="nc" id="L6278">				connection = DBPool.getConnectionReadUncommited();</span>

				try {
<span class="nc" id="L6281">					ps = connection.prepareStatement(sql);</span>
<span class="nc" id="L6282">					ps.setString(1, fieldValue);</span>

					try {
<span class="nc" id="L6285">						rs = ps.executeQuery();</span>

<span class="nc bnc" id="L6287" title="All 2 branches missed.">						while (rs.next())</span>
						{
<span class="nc bnc" id="L6289" title="All 2 branches missed.">							if (Constants.getBoolean(&quot;docAuthorLazyLoad&quot;)) {</span>
<span class="nc" id="L6290">								doc = getDocDetails(rs, noData, true);</span>
							}
							else {
<span class="nc" id="L6293">								doc = getDocDetails(rs, noData);</span>
							}
						}
					}
					finally {
<span class="nc" id="L6298">						ps.close();</span>
					}
				}
				finally {
<span class="nc bnc" id="L6302" title="All 2 branches missed.">					if (rs!=null) rs.close();</span>
				}
			}
			finally {
<span class="nc bnc" id="L6306" title="All 2 branches missed.">				if (connection!=null) connection.close();</span>
			}

<span class="nc" id="L6309">			return doc;</span>
		}
<span class="nc" id="L6311">		catch (Exception e)</span>
		{
<span class="nc" id="L6313">			Logger.error(DocDB.class, e);</span>
		}

<span class="nc" id="L6316">		return (null);</span>
	}

	/**
	 * Vrati zoznam podadresarov oddelenych ciarkou
	 * @param groupId - id korenoveho adresara
	 * @return String - zoznam podadresarov oddelenych ciarkou
	 */

	public static String getSubgroups(int groupId){
<span class="nc" id="L6326">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
		List&lt;GroupDetails&gt; searchGroupsArray;
<span class="nc" id="L6328">		StringBuilder searchGroups = null;</span>

<span class="nc" id="L6330">			searchGroupsArray = groupsDB.getGroupsTree(groupId, true, true);</span>
<span class="nc bnc" id="L6331" title="All 2 branches missed.">			for (GroupDetails group : searchGroupsArray)</span>
			{
<span class="nc bnc" id="L6333" title="All 2 branches missed.">				if (group != null)</span>
				{
<span class="nc bnc" id="L6335" title="All 2 branches missed.">					if (searchGroups == null)</span>
					{
<span class="nc" id="L6337">						searchGroups = new StringBuilder(String.valueOf(group.getGroupId()));</span>
					}
					else
					{
<span class="nc" id="L6341">						searchGroups.append(',').append(group.getGroupId());</span>
					}
				}
<span class="nc" id="L6344">			}</span>

<span class="nc bnc" id="L6346" title="All 2 branches missed.">		if(searchGroups!=null){</span>
<span class="nc" id="L6347">			return  searchGroups.toString();</span>
		}
		else{
<span class="nc" id="L6350">			return &quot;&quot;;</span>
		}

	}

	/**
	 * Vrati zoznam produktov ktore maju zadanu cenu, pouziva sa v eshope v admin_pricelist.jsp
	 * @param showOnlyAvailable
	 * @return
	 */
	public List&lt;DocDetails&gt; getItemsWithPrice(boolean showOnlyAvailable)
	{
<span class="nc" id="L6362">		List&lt;DocDetails&gt; products = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L6364">		Connection db_conn=null;</span>

<span class="nc" id="L6366">		PreparedStatement ps = null;</span>
<span class="nc" id="L6367">		ResultSet rs = null;</span>

		try
		{
<span class="nc" id="L6371">			db_conn = DBPool.getConnection();</span>
<span class="nc" id="L6372">			String priceColumnName = Constants.getString(&quot;basketPriceField&quot;);</span>
<span class="nc bnc" id="L6373" title="All 2 branches missed.">			if (priceColumnName == null)</span>
<span class="nc" id="L6374">				ps = db_conn.prepareStatement(&quot;SELECT doc_id FROM documents&quot;);</span>
			else
			{
				//premena z fieldJ na field_j, ak je nutna
<span class="nc bnc" id="L6378" title="All 2 branches missed.">				priceColumnName = priceColumnName.toLowerCase().startsWith(&quot;field&quot;) ?</span>
<span class="nc" id="L6379">							&quot;field_&quot;+priceColumnName.toLowerCase().substring(priceColumnName.length() - 1) : priceColumnName;</span>

<span class="nc" id="L6381">				StringBuilder sql = new StringBuilder(&quot;SELECT doc_id FROM documents WHERE&quot;);</span>
<span class="nc bnc" id="L6382" title="All 2 branches missed.">				if (Constants.DB_TYPE == Constants.DB_MSSQL) sql.append(&quot; LEN(&quot;);</span>
<span class="nc" id="L6383">				else sql.append(&quot; LENGTH(&quot;);</span>
<span class="nc" id="L6384">				sql.append(priceColumnName).append(&quot;) &gt; 0&quot;);</span>
<span class="nc" id="L6385">				ps = db_conn.prepareStatement(sql.toString());</span>
			}
<span class="nc" id="L6387">			rs = ps.executeQuery();</span>
<span class="nc bnc" id="L6388" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L6390">				DocDetails document = getDoc(rs.getInt(1));</span>
<span class="nc bnc" id="L6391" title="All 2 branches missed.">				if (document == null)</span>
<span class="nc" id="L6392">					continue;</span>
<span class="nc" id="L6393">				double price = document.getPrice();</span>
				//ak nema cenu, tak nas nezaujima, nejde o produkt
<span class="nc bnc" id="L6395" title="All 6 branches missed.">				if (Math.abs(price) &lt; 1e-7 || (showOnlyAvailable &amp;&amp; !document.isAvailable() ) )</span>
<span class="nc" id="L6396">					continue;</span>
<span class="nc" id="L6397">				products.add(document);</span>
<span class="nc" id="L6398">			}</span>
<span class="nc" id="L6399">			rs.close();</span>
<span class="nc" id="L6400">			ps.close();</span>
<span class="nc" id="L6401">			db_conn.close();</span>

<span class="nc" id="L6403">			rs = null;</span>
<span class="nc" id="L6404">			ps = null;</span>
<span class="nc" id="L6405">			db_conn = null;</span>
		}
<span class="nc" id="L6407">		catch (Exception ex)</span>
		{
<span class="nc" id="L6409">			Logger.error(DocDB.class, ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L6415" title="All 2 branches missed.">				if (rs!=null)</span>
<span class="nc" id="L6416">					rs.close();</span>
<span class="nc bnc" id="L6417" title="All 2 branches missed.">				if (ps!=null)</span>
<span class="nc" id="L6418">					ps.close();</span>
<span class="nc bnc" id="L6419" title="All 2 branches missed.">				if (db_conn!=null)</span>
<span class="nc" id="L6420">					db_conn.close();</span>
			}
<span class="nc" id="L6422">			catch (Exception ex2){</span>
				//
<span class="nc" id="L6424">			}</span>
		}

<span class="nc" id="L6427">		return products;</span>
	}


	private static String notNull(String text)
	{
<span class="nc bnc" id="L6433" title="All 2 branches missed.">		if (text == null) return &quot;&quot;;</span>
<span class="nc" id="L6434">		return text;</span>
	}

	/**
	 * Otestuje stav fora pre stranku
	 * return: 0=nema forum, 1=forum aktivne, -1=forum neaktivne
	 */
	private static int getForumStatus(DocDetails docDet, TemplateDetails temp)
	{
<span class="nc bnc" id="L6443" title="All 4 branches missed.">		if (docDet == null || docDet.getData() == null)</span>
<span class="nc" id="L6444">			return(0);</span>

<span class="nc bnc" id="L6446" title="All 2 branches missed.">		if (temp == null)</span>
<span class="nc" id="L6447">			return(0);</span>

<span class="nc bnc" id="L6449" title="All 2 branches missed.">		if(ForumGroupService.isMessageBoard(docDet, temp)) {</span>
<span class="nc bnc" id="L6450" title="All 2 branches missed.">			if(ForumGroupService.isActive(docDet.getDocId()))</span>
<span class="nc" id="L6451">				return(1);</span>
			else
<span class="nc" id="L6453">				return(-1);</span>
		}

<span class="nc" id="L6456">		return(0);</span>
	}

	/**
	 * Vrati DocDetails ako json object, pouziva sa v ajax_docstable.jsp pre webstranky a novinky
	 * @param d
	 * @param group
	 * @param request
	 * @return
	 */
	public static JSONObject getJsonObject(DocDetails d, GroupDetails group, HttpServletRequest request) {
<span class="nc" id="L6467">		JSONObject j = new JSONObject();</span>
		try {
<span class="nc" id="L6469">			String tempName = &quot;&quot;;</span>

<span class="nc" id="L6471">			TemplateDetails temp = TemplatesDB.getInstance().getTemplate(d.getTempId());</span>
<span class="nc bnc" id="L6472" title="All 2 branches missed.">			if (temp != null) tempName = temp.getTempName();</span>

<span class="nc" id="L6474">			boolean showOnHOmepage = false;</span>
<span class="nc" id="L6475">			String perexGroups = d.getPerexGroupString();</span>
<span class="nc" id="L6476">			String showOnHomepagePerex = Constants.getString(&quot;showOnHomepagePerexGroup&quot;);</span>

<span class="nc" id="L6478">			String category = &quot;&quot;;</span>
<span class="nc" id="L6479">			String subCategory = &quot;&quot;;</span>

<span class="nc" id="L6481">			String newsListConstantName = Tools.getStringValue(request.getParameter(&quot;newsListConstantName&quot;),&quot;&quot;);</span>
<span class="nc bnc" id="L6482" title="All 2 branches missed.">			if(Tools.isNotEmpty(newsListConstantName)){</span>

<span class="nc" id="L6484">				String constGroups = Tools.replace(Constants.getString(newsListConstantName), &quot;\\*&quot;, &quot;&quot;);</span>
<span class="nc" id="L6485">				List&lt;String&gt; groupIdsList = Arrays.asList(constGroups.split(&quot;,&quot;));</span>

<span class="nc bnc" id="L6487" title="All 2 branches missed.">				if(groupIdsList.contains(d.getGroupId()+&quot;&quot;)){</span>
					// ake je parent v liste kategorii =&gt; nieje v podkategorii
<span class="nc" id="L6489">					category = group.getGroupName() ;</span>
				}else{
<span class="nc" id="L6491">					subCategory = group.getGroupName();</span>
<span class="nc" id="L6492">					category = GroupDetails.getById(group.getParentGroupId()).getGroupName();</span>

				}
			}

<span class="nc bnc" id="L6497" title="All 6 branches missed.">			if( Tools.isNotEmpty(&quot;showOnHomepagePerex&quot;) &amp;&amp; perexGroups!=null &amp;&amp; perexGroups.indexOf(showOnHomepagePerex)&gt;-1){</span>
<span class="nc" id="L6498">				showOnHOmepage = true;</span>
			}

<span class="nc" id="L6501">			j.put(&quot;docId&quot;, String.valueOf(d.getDocId()));</span>
<span class="nc" id="L6502">            j.put(&quot;historyId&quot;, String.valueOf(d.getHistoryId()));</span>

			//stranky na schvalenie
<span class="nc bnc" id="L6505" title="All 2 branches missed.">			if (group.getGroupId()==Constants.getInt(&quot;systemPagesDocsToApprove&quot;)) j.put(&quot;groupId&quot;, Constants.getInt(&quot;systemPagesDocsToApprove&quot;));</span>
<span class="nc" id="L6506">			else j.put(&quot;groupId&quot;, String.valueOf(d.getGroupId()));</span>

<span class="nc" id="L6508">			j.put(&quot;sortPriority&quot;, d.getSortPriority());</span>
<span class="nc" id="L6509">			j.put(&quot;title&quot;, ResponseUtils.filter(d.getTitle()));</span>
<span class="nc" id="L6510">			j.put(&quot;authorName&quot;, ResponseUtils.filter(notNull(d.getAuthorName())));</span>
<span class="nc" id="L6511">			j.put(&quot;templateName&quot;, ResponseUtils.filter(tempName));</span>
<span class="nc" id="L6512">			j.put(&quot;templateId&quot;, d.getTempId());</span>
<span class="nc" id="L6513">			j.put(&quot;fieldA&quot;, ResponseUtils.filter(d.getFieldA()));</span>
<span class="nc" id="L6514">			j.put(&quot;fieldB&quot;, ResponseUtils.filter(d.getFieldB()));</span>
<span class="nc" id="L6515">			j.put(&quot;fieldC&quot;, ResponseUtils.filter(d.getFieldC()));</span>
<span class="nc" id="L6516">			j.put(&quot;fieldD&quot;, ResponseUtils.filter(d.getFieldD()));</span>
<span class="nc" id="L6517">			j.put(&quot;fieldE&quot;, ResponseUtils.filter(d.getFieldE()));</span>
<span class="nc" id="L6518">			j.put(&quot;fieldF&quot;, ResponseUtils.filter(d.getFieldF()));</span>
<span class="nc" id="L6519">			j.put(&quot;fieldG&quot;, ResponseUtils.filter(d.getFieldG()));</span>
<span class="nc" id="L6520">			j.put(&quot;fieldH&quot;, ResponseUtils.filter(d.getFieldH()));</span>
<span class="nc" id="L6521">			j.put(&quot;fieldI&quot;, ResponseUtils.filter(d.getFieldI()));</span>
<span class="nc" id="L6522">			j.put(&quot;fieldJ&quot;, ResponseUtils.filter(d.getFieldJ()));</span>
<span class="nc" id="L6523">			j.put(&quot;fieldK&quot;, ResponseUtils.filter(d.getFieldK()));</span>
<span class="nc" id="L6524">			j.put(&quot;fieldL&quot;, ResponseUtils.filter(d.getFieldL()));</span>
<span class="nc" id="L6525">			j.put(&quot;fieldM&quot;, ResponseUtils.filter(d.getFieldM()));</span>
<span class="nc" id="L6526">			j.put(&quot;fieldN&quot;, ResponseUtils.filter(d.getFieldN()));</span>
<span class="nc" id="L6527">			j.put(&quot;fieldO&quot;, ResponseUtils.filter(d.getFieldO()));</span>
<span class="nc" id="L6528">			j.put(&quot;fieldP&quot;, ResponseUtils.filter(d.getFieldP()));</span>
<span class="nc" id="L6529">			j.put(&quot;fieldQ&quot;, ResponseUtils.filter(d.getFieldQ()));</span>
<span class="nc" id="L6530">			j.put(&quot;fieldR&quot;, ResponseUtils.filter(d.getFieldR()));</span>
<span class="nc" id="L6531">			j.put(&quot;fieldS&quot;, ResponseUtils.filter(d.getFieldS()));</span>
<span class="nc" id="L6532">			j.put(&quot;fieldT&quot;, ResponseUtils.filter(d.getFieldT()));</span>

<span class="nc bnc" id="L6534" title="All 2 branches missed.">			if(group.getLng()!=null){</span>
<span class="nc" id="L6535">				j.put(&quot;lang&quot;, group.getLng());</span>
<span class="nc bnc" id="L6536" title="All 2 branches missed.">			}else if (temp!=null) {</span>
<span class="nc" id="L6537">				j.put(&quot;lang&quot;, temp.getLng());</span>
			}
			else
			{
<span class="nc" id="L6541">				j.put(&quot;lang&quot;, Constants.getString(&quot;defaultLanguage&quot;));</span>
			}

<span class="nc" id="L6544">			j.put(&quot;publicStart&quot;, d.getPublishStartString());</span>
<span class="nc" id="L6545">			j.put(&quot;publicStartTime&quot;, d.getPublishStartTimeString());</span>
<span class="nc" id="L6546">			j.put(&quot;publicStartWithTime&quot;, d.getPublishStartString()+&quot; &quot;+d.getPublishStartTimeString() );</span>
<span class="nc" id="L6547">			j.put(&quot;publicStartTimestamp&quot;, String.valueOf(d.getPublishStart()));</span>

<span class="nc" id="L6549">			j.put(&quot;publicEnd&quot;, d.getPublishEndString());</span>
<span class="nc" id="L6550">			j.put(&quot;publicEndTime&quot;, d.getPublishEndTimeString());</span>
<span class="nc" id="L6551">			j.put(&quot;publicEndWithTime&quot;, d.getPublishEndString() +&quot; &quot;+d.getPublishEndTimeString() );</span>
<span class="nc" id="L6552">			j.put(&quot;publicEndTimestamp&quot;, String.valueOf(d.getPublishEnd()));</span>

<span class="nc" id="L6554">			j.put(&quot;publicEvent&quot;, d.getEventDateString());</span>
<span class="nc" id="L6555">			j.put(&quot;publicEventTime&quot;, d.getEventTimeString());</span>
<span class="nc" id="L6556">			j.put(&quot;publicEventWithTime&quot;, d.getEventDateString() +&quot; &quot;+d.getEventTimeString() );</span>
<span class="nc" id="L6557">			j.put(&quot;publicEventTimestamp&quot;, String.valueOf(d.getEventDate()));</span>

<span class="nc" id="L6559">			j.put(&quot;dateCreated&quot;, Tools.formatDateTime(d.getDateCreated()));</span>
<span class="nc" id="L6560">			j.put(&quot;dateCreatedTimestamp&quot;, String.valueOf(d.getDateCreated()));</span>
<span class="nc" id="L6561">			j.put(&quot;empty&quot;, &quot;&quot;);</span>
<span class="nc" id="L6562">			j.put(&quot;domain&quot;, group.getDomainName());</span>

<span class="nc" id="L6564">			JSONObject properties = new JSONObject();</span>
<span class="nc" id="L6565">			properties.put(&quot;isAvailable&quot;, d.isAvailable());</span>
<span class="nc" id="L6566">			properties.put(&quot;isCacheable&quot;, d.isCacheable());</span>
<span class="nc" id="L6567">			properties.put(&quot;isSearchable&quot;, d.isSearchable());</span>
<span class="nc" id="L6568">			properties.put(&quot;isShowInMenu&quot;, d.isShowInMenu());</span>
<span class="nc" id="L6569">			properties.put(&quot;isRequireSsl&quot;, d.isRequireSsl());</span>
<span class="nc" id="L6570">			properties.put(&quot;isForum&quot;, String.valueOf(getForumStatus(d, temp)));</span>
<span class="nc" id="L6571">			properties.put(&quot;isShowOnHomepage&quot;, showOnHOmepage);</span>

<span class="nc" id="L6573">			j.put(&quot;properties&quot;, properties);</span>

<span class="nc" id="L6575">			j.put(&quot;link&quot;, d.getDocLink());</span>
<span class="nc" id="L6576">			j.put(&quot;groupName&quot;, ResponseUtils.filter(group.getGroupName()));</span>
<span class="nc" id="L6577">			j.put(&quot;category&quot;, ResponseUtils.filter(category));</span>
<span class="nc" id="L6578">			j.put(&quot;subcategory&quot;, ResponseUtils.filter(subCategory));</span>

			try {
<span class="nc" id="L6581">				j.put(&quot;externalLink&quot;, notNull(d.getExternalLink()));</span>
			}
<span class="nc" id="L6583">			catch (Exception e) {</span>
<span class="nc" id="L6584">				j.put(&quot;externalLink&quot;, &quot;&quot;);</span>
<span class="nc" id="L6585">			}</span>

<span class="nc" id="L6587">			j.put(&quot;perex&quot;, ResponseUtils.filter(d.getPerex()));</span>
<span class="nc" id="L6588">			j.put(&quot;perexPlace&quot;, ResponseUtils.filter(d.getPerexPlace()));</span>
<span class="nc" id="L6589">			j.put(&quot;perexImage&quot;, ResponseUtils.filter(d.getPerexImage()));</span>

			try
			{
<span class="nc" id="L6593">				String[] perexGroupNames = d.getPerexGroupNames();</span>
<span class="nc bnc" id="L6594" title="All 4 branches missed.">				if (perexGroupNames != null &amp;&amp; perexGroupNames.length&gt;1)</span>
				{
<span class="nc" id="L6596">					j.put(&quot;perexGroup&quot;, perexGroupNames);</span>
				}
				else
				{
<span class="nc" id="L6600">					j.put(&quot;perexGroup&quot;, &quot;&quot;);</span>
				}
			}
<span class="nc" id="L6603">			catch (Exception e)</span>
			{
<span class="nc" id="L6605">				Logger.error(DocDB.class, e);</span>
<span class="nc" id="L6606">				j.put(&quot;perexGroup&quot;, &quot;&quot;);</span>
<span class="nc" id="L6607">			}</span>

<span class="nc" id="L6609">			List&lt;String&gt; passwordProtected = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L6610" title="All 2 branches missed.">			if (d.getPasswordProtected() != null) {</span>
<span class="nc bnc" id="L6611" title="All 2 branches missed.">				for (String idString : Tools.getTokens(d.getPasswordProtected(), &quot;,&quot;)) {</span>
<span class="nc" id="L6612">					int id = Integer.parseInt(idString);</span>
<span class="nc" id="L6613">					UserGroupDetails userGroup = UserGroupsDB.getInstance().getUserGroup(id);</span>

<span class="nc bnc" id="L6615" title="All 2 branches missed.">					if (userGroup != null) {</span>
<span class="nc" id="L6616">						passwordProtected.add(userGroup.getUserGroupName());</span>
					}
				}
			}

<span class="nc" id="L6621">			j.put(&quot;perexPasswordProtected&quot;, passwordProtected);</span>

<span class="nc" id="L6623">			boolean isDefaultDoc = false;</span>
<span class="nc bnc" id="L6624" title="All 4 branches missed.">			if (group != null &amp;&amp; group.getDefaultDocId()==d.getDocId()) isDefaultDoc = true;</span>

<span class="nc" id="L6626">			j.put(&quot;defaultDoc&quot;, isDefaultDoc);</span>
		}
<span class="nc" id="L6628">		catch (Exception e) {</span>
<span class="nc" id="L6629">			Logger.error(DocDB.class, e);</span>
<span class="nc" id="L6630">		}</span>

<span class="nc" id="L6632">		return j;</span>
	}

	 /**
	  * vsetkym strankam z adresara na vstupe opatovne vygeneruje Url (virtualPath)
	  * zaroven rekurzivne prechadza aj jeho podadresare
	  *
	  * @param rootGroupId
	  * @param user
	  * @param request
	  */
	 public void regenerateUrl(int rootGroupId, Identity user, HttpServletRequest request)
	 {
		  //ziskaj zoznam stranok v adresari
<span class="nc" id="L6646">		  List&lt;DocDetails&gt; docs = DocDB.getInstance().getBasicDocDetailsByGroup(rootGroupId, -1);</span>
<span class="nc" id="L6647">		  Iterator&lt;DocDetails&gt; iter = docs.iterator();</span>
		  DocDetails doc;
		  EditorForm ef;
<span class="nc bnc" id="L6650" title="All 2 branches missed.">		  while (iter.hasNext())</span>
		  {
<span class="nc" id="L6652">				doc = iter.next();</span>
<span class="nc" id="L6653">				ef = EditorDB.getEditorForm(request, doc.getDocId(), -1, rootGroupId);</span>

<span class="nc" id="L6655">				Logger.println(this, ef.getTitle() + &quot; [docid: &quot; + ef.getDocId() + &quot;] - virtualPath: &quot; + ef.getVirtualPath());</span>

<span class="nc bnc" id="L6657" title="All 2 branches missed.">				if (ef.getVirtualPath().contains(&quot;*&quot;))</span>
				{
<span class="nc" id="L6659">					 Logger.println(this,&quot; skipping (contains *)&quot;);</span>
<span class="nc" id="L6660">					 continue;</span>
				}

<span class="nc" id="L6663">				ef.setVirtualPath(&quot;&quot;);</span>
				//nastav aktualneho usera
<span class="nc" id="L6665">				ef.setAuthorId(user.getUserId());</span>
<span class="nc" id="L6666">				ef.setPublish(&quot;1&quot;);</span>

<span class="nc" id="L6668">				EditorDB.saveEditorForm(ef, request);</span>

<span class="nc" id="L6670">				Logger.println(this,&quot; -&gt; &quot; + ef.getVirtualPath());</span>
		  }

		  // rekurzivne sa zavolaj na podadresare
<span class="nc" id="L6674">		  List&lt;GroupDetails&gt; subGroups = GroupsDB.getInstance().getGroups(rootGroupId);</span>
<span class="nc" id="L6675">		  Iterator&lt;GroupDetails&gt; iterGroup = subGroups.iterator();</span>
		  GroupDetails group;
<span class="nc bnc" id="L6677" title="All 2 branches missed.">		  while (iterGroup.hasNext())</span>
		  {
<span class="nc" id="L6679">				group = iterGroup.next();</span>
<span class="nc" id="L6680">				regenerateUrl(group.getGroupId(), user, request);</span>
		  }
<span class="nc" id="L6682">	}</span>


	/**
	 * Upravi poradie stranok v adresari po zmene stranky cez drag&amp;drop, vsetky za touto strankou precisluje
	 * @param editorForm
	 * @param position
	 */
	public void fixWebpageSortOrder(EditorForm editorForm, int position) {
		// ziskaj pocet adresarov v tomto adresari, tie musime odpocitat
<span class="nc" id="L6692">		List&lt;GroupDetails&gt; folders = GroupsDB.getInstance().getGroups(editorForm.getGroupId());</span>
<span class="nc" id="L6693">		position = position - folders.size();</span>
<span class="nc bnc" id="L6694" title="All 2 branches missed.">		if (position &lt; 0)</span>
<span class="nc" id="L6695">			position = 0;</span>

		// iterujme stranky a upravime poradie
<span class="nc" id="L6698">		DocDB docDB = DocDB.getInstance();</span>
<span class="nc" id="L6699">		List&lt;DocDetails&gt; docs = docDB.getBasicDocDetailsByGroup(editorForm.getGroupId(), DocDB.ORDER_PRIORITY);</span>

		// v adresari nic nie je, nemusime menit sort priority
<span class="nc bnc" id="L6702" title="All 2 branches missed.">		if (docs.size() == 0)</span>
<span class="nc" id="L6703">			return;</span>

<span class="nc" id="L6705">		StringBuilder updateSortOrderList = null;</span>
<span class="nc" id="L6706">		int maxSortPriority = 0;</span>
<span class="nc bnc" id="L6707" title="All 2 branches missed.">		for (DocDetails doc : docs) {</span>
<span class="nc" id="L6708">			maxSortPriority = doc.getSortPriority();</span>

<span class="nc bnc" id="L6710" title="All 2 branches missed.">			if (doc.getDocId() == editorForm.getDocId()) {</span>
				// netreba nic menit
<span class="nc" id="L6712">				Logger.debug(DocDB.class, &quot;fixWebpageSortOrder, ZHODA DOCID, position=&quot; + position);</span>
<span class="nc bnc" id="L6713" title="All 2 branches missed.">				if (position == 0)</span>
<span class="nc" id="L6714">					return;</span>
				continue;
			}

<span class="nc" id="L6718">			position--;</span>

<span class="nc" id="L6720">			Logger.debug(DocDB.class, &quot;fixWebpageSortOrder, docid=&quot; + doc.getTitle() + &quot; &quot; + doc.getDocId() + &quot; position=&quot; + position);</span>

<span class="nc bnc" id="L6722" title="All 2 branches missed.">			if (position == -1) {</span>
<span class="nc" id="L6723">				Logger.debug(DocDB.class, &quot;fixWebpageSortOrder, position==-1, setting priority: &quot; + doc.getSortPriority());</span>
<span class="nc" id="L6724">				editorForm.setSortPriority(doc.getSortPriority());</span>
			}
<span class="nc bnc" id="L6726" title="All 2 branches missed.">			if (position &lt; 0) {</span>
<span class="nc bnc" id="L6727" title="All 2 branches missed.">				if (updateSortOrderList == null)</span>
<span class="nc" id="L6728">					updateSortOrderList = new StringBuilder(String.valueOf(doc.getDocId()));</span>
				else
<span class="nc" id="L6730">					updateSortOrderList.append(&quot;,&quot;).append(String.valueOf(doc.getDocId()));</span>
			}

<span class="nc" id="L6733">			Logger.debug(DocDB.class, &quot;fixWebpageSortOrder, toUpdate=&quot; + updateSortOrderList);</span>
<span class="nc" id="L6734">		}</span>

<span class="nc bnc" id="L6736" title="All 2 branches missed.">		if (updateSortOrderList == null) {</span>
<span class="nc" id="L6737">			Logger.debug(DocDB.class, &quot;updateSortOrderList, updatujem self, maxSortPriority=&quot; + maxSortPriority);</span>
<span class="nc" id="L6738">			editorForm.setSortPriority(maxSortPriority + 10);</span>
		} else {

			// update cache hodnoty
<span class="nc" id="L6742">			int[] docids = Tools.getTokensInt(updateSortOrderList.toString(), &quot;,&quot;);</span>
<span class="nc bnc" id="L6743" title="All 2 branches missed.">			for (int docid : docids) {</span>
<span class="nc" id="L6744">				DocDetails doc = docDB.getDoc(docid);</span>
<span class="nc" id="L6745">				doc.setSortPriority(doc.getSortPriority()+10);</span>
<span class="nc" id="L6746">				DocDB.saveDoc(doc, true);</span>
			}
		}
<span class="nc" id="L6749">	}</span>

	/**
	 * Vrati/vytvori stranku podla zadanej cesty, pouziva sa napr. pri importe
	 * @param path - cesta vo formate /adresar1/adresar2/meno-stranky
	 * @return
	 */
	public DocDetails getCreateDoc(String path) {

		//check if path is number, then return doc with this id
		try {
<span class="nc" id="L6760">			int id = Integer.parseInt(path);</span>
<span class="nc" id="L6761">			return DocDB.getInstance().getDoc(id);</span>
<span class="fc" id="L6762">		} catch (Exception e) {</span>
			//not a number, continue
		}

<span class="fc" id="L6766">		int domainSeparatorIndex = path.indexOf(&quot;:&quot;);</span>
<span class="pc bpc" id="L6767" title="1 of 2 branches missed.">		if (domainSeparatorIndex&gt;0) {</span>
<span class="nc" id="L6768">			String domain = path.substring(0, domainSeparatorIndex);</span>
<span class="nc" id="L6769">			RequestBean rb = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="nc bnc" id="L6770" title="All 2 branches missed.">			if (rb != null) {</span>
<span class="nc" id="L6771">				rb.setDomain(domain);</span>
			}
<span class="nc" id="L6773">			path = path.substring(domainSeparatorIndex+1);</span>
		}

<span class="fc" id="L6776">		int lomka = path.lastIndexOf(&quot;/&quot;);</span>
<span class="pc bpc" id="L6777" title="2 of 4 branches missed.">		if (lomka == -1 || path.endsWith(&quot;/&quot;)) return null;</span>

<span class="fc" id="L6779">		String groupPath = path.substring(0, lomka);</span>
<span class="fc" id="L6780">		String pageName = path.substring(lomka+1);</span>

<span class="fc" id="L6782">		GroupDetails group = GroupsDB.getInstance().getCreateGroup(groupPath);</span>
<span class="pc bpc" id="L6783" title="1 of 2 branches missed.">		if (group == null) return null;</span>

<span class="fc" id="L6785">		DocDetails doc = getDocByTitle(pageName, group.getGroupId());</span>
<span class="pc bpc" id="L6786" title="1 of 2 branches missed.">		if (doc != null) return doc;</span>

<span class="nc" id="L6788">		RequestBean rb = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="nc bnc" id="L6789" title="All 2 branches missed.">		if (rb == null) return null;</span>

<span class="nc" id="L6791">		doc = new DocDetails();</span>
<span class="nc" id="L6792">		doc.setGroupId(group.getGroupId());</span>
<span class="nc" id="L6793">		doc.setTempId(group.getTempId());</span>
<span class="nc" id="L6794">		doc.setAuthorId(rb.getUserId());</span>
<span class="nc" id="L6795">		doc.setSortPriority(getMaxSortPriorityInGroup(group.getGroupId())+10);</span>

<span class="nc" id="L6797">		doc.setTitle(pageName);</span>
<span class="nc" id="L6798">		doc.setNavbar(pageName);</span>
<span class="nc" id="L6799">		doc.setData(&quot;&quot;);</span>

<span class="nc" id="L6801">		saveDoc(doc);</span>
<span class="nc" id="L6802">		updateInternalCaches(doc.getDocId());</span>

<span class="nc" id="L6804">		return doc;</span>
	}

	/**
	 * Vrati zoznam SQL stlpcov pre vyber z databazy
	 * @return
	 */
	public static String getDocumentFields() {
<span class="fc" id="L6812">		return getDocumentFields(true);</span>
	}

	/**
	 * Vrati zoznam SQL stlpcov pre vyber z databazy bez data stlpca (mensi objem dat)
	 * @return
	 */
	public static String getDocumentFieldsNodata() {
<span class="fc" id="L6820">		return getDocumentFields(false);</span>
	}

	/**
	 * Vrati zoznam SQL stlpcov pre vyber z databazy
	 * @param includeDataField - ak je true, bude sa vracat aj stlpec data (je narocnejsie na pamat pri citani dat)
	 * @return
	 */
	public static String getDocumentFields(boolean includeDataField) {
<span class="fc" id="L6829">		StringBuilder sqlFields = new StringBuilder();</span>

<span class="fc" id="L6831">		sqlFields.append(&quot;d.doc_id, &quot;);</span>
<span class="fc bfc" id="L6832" title="All 2 branches covered.">		if (includeDataField) sqlFields.append(&quot;d.data, &quot;);</span>
<span class="fc" id="L6833">		sqlFields.append(&quot;d.date_created, d.publish_start, d.publish_end, d.author_id, d.searchable, d.group_id, d.available, d.show_in_menu, d.password_protected, d.cacheable, d.external_link, d.virtual_path, d. temp_id, d.title, d.navbar, d.file_name, d.sort_priority, d.header_doc_id, d.footer_doc_id, d.menu_doc_id, d.right_menu_doc_id, d.html_head, d.html_data, d.perex_place, d.perex_image, d.perex_group, d.event_date, d.sync_id, d.sync_status, d.field_a, d.field_b, d.field_c, d.field_d, d.field_e, d.field_f, d.field_g, d.field_h, d.field_i, d.field_j, d.field_k, d.field_l, d.disable_after_end, d.forum_count, d.views_total, d.field_m, d.field_n, d.field_o, d.field_p, d.field_q, d.field_r, d.field_s, d.field_t, d.require_ssl&quot;);</span>

<span class="fc" id="L6835">		String[] additionalFields = DataAccessHelper.getDocFields();</span>
<span class="pc bpc" id="L6836" title="2 of 4 branches missed.">		if (additionalFields!=null &amp;&amp; additionalFields.length&gt;0) {</span>
<span class="fc bfc" id="L6837" title="All 2 branches covered.">			for (String field : additionalFields) {</span>
<span class="fc" id="L6838">				sqlFields.append(&quot;, d.&quot;).append(field);</span>
			}
		}

<span class="fc" id="L6842">		return sqlFields.toString();</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>