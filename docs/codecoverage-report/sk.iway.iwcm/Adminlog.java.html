<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Adminlog.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm</a> &gt; <span class="el_source">Adminlog.java</span></div><h1>Adminlog.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm;

import java.lang.reflect.Field;
import java.net.InetAddress;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Map;

import sk.iway.iwcm.helpers.BeanDiff;
import sk.iway.iwcm.helpers.BeanDiffPrinter;
import sk.iway.iwcm.system.ConfDB;
import sk.iway.iwcm.system.adminlog.AdminlogNotifyManager;

/**
 *  Adminlog.java
 *
 *@Title        webjet4
 *@Company      Interway s.r.o. (www.interway.sk)
 *@Copyright    Interway s.r.o. (c) 2001-2005
 *@author       $Author: thaber $
 *@version      $Revision: 1.25 $
 *@created      Date: 7.2.2005 16:35:22
 *@modified     $Date: 2010/02/24 15:06:13 $
 */
public class Adminlog
{
	public static final int TYPE_HELP_LAST_SEEN = 10;
	public static final int TYPE_FILE_UPLOAD = 20;
	public static final int TYPE_SAVEDOC = 30;
	public static final int TYPE_MEDIA = 31;
	public static final int TYPE_MEDIA_GROUP = 32;

	public static final int TYPE_INIT = 40;
	//public static final int TYPE_AUDIT_NOTIFY = 41;

	public static final int TYPE_GROUP = 50;
	public static final int TYPE_IMPORTXLS = 60;
	public static final int TYPE_DMAIL_AUTOSENDER = 70;
	public static final int TYPE_DMAIL_DOMAINLIMITS = 71;
	public static final int TYPE_DMAIL = 72;
	public static final int TYPE_DMAIL_BLACKLIST = 73;
	public static final int TYPE_USER_LOGOFF = 79;
	public static final int TYPE_USER_LOGON = 80;
	public static final int TYPE_USER_EDIT = 81;
	public static final int TYPE_USER_INSERT = 82;
	public static final int TYPE_USER_DELETE = 83;
	public static final int TYPE_USER_AUTHORIZE = 84;
	public static final int TYPE_USER_UPDATE = 85;
	public static final int TYPE_USER_SAVE = 86;
	public static final int TYPE_USER_GROUP_UPDATE = 87;
	public static final int TYPE_USER_GROUP_DELETE = 88;
	public static final int TYPE_USER_GROUP_INSERT = 89;
	public static final int TYPE_TEMPLATE_INSERT = 90;
	public static final int TYPE_TEMPLATE_UPDATE = 91;
	public static final int TYPE_TEMPLATE_DELETE = 92;
	public static final int TYPE_INQUIRY = 95;
	public static final int TYPE_GALLERY = 93;
	public static final int TYPE_SE_SITEMAP = 100;
	public static final int TYPE_FORM_EXPORT = 110;
	public static final int TYPE_FORM_DELETE = 111;
	public static final int TYPE_FORM_ARCHIVE = 112;
   public static final int TYPE_FORM_VIEW = 113;
	public static final int TYPE_FORM_REGEXP = 114;
   public static final int TYPE_FORMMAIL = 120;
	public static final int TYPE_SENDMAIL = 130;
	public static final int TYPE_JSPERROR = 140;
	public static final int TYPE_SQLERROR = 150;
	public static final int TYPE_XSS = 160;
	public static final int TYPE_XSRF = 165;
	public static final int TYPE_RUNTIME_ERROR = 170;
	public static final int TYPE_HELPDESK = 200;
	public static final int TYPE_DATA_DELETING = 220;
	public static final int TYPE_CRON = 230;
	public static final int TYPE_USER_CHANGE_PASSWORD = 94;
	/*
	public static final int TYPE_COMPONENT_CREATE = 500;
	public static final int TYPE_COMPONENT_DELETE = 510;
	public static final int TYPE_COMPONENT_UPDATE = 520;
	*/
	public static final int TYPE_PEREX_GROUP_CREATE = 530;
	public static final int TYPE_PEREX_GROUP_DELETE = 540;
	public static final int TYPE_PEREX_GROUP_UPDATE = 550;
	public static final int TYPE_CONF_UPDATE = 560;
	public static final int TYPE_CONF_DELETE = 570;
	public static final int TYPE_PROP_UPDATE = 580;
	public static final int TYPE_PROP_DELETE = 590;
	public static final int TYPE_BANNER_CREATE = 600;
	public static final int TYPE_BANNER_DELETE = 610;
	public static final int TYPE_BANNER_UPDATE = 620;
	public static final int TYPE_CALENDAR_CREATE = 630;
	public static final int TYPE_CALENDAR_DELETE = 640;
	public static final int TYPE_CALENDAR_UPDATE = 650;
	public static final int TYPE_QA_CREATE = 660;
	public static final int TYPE_QA_DELETE = 670;
	public static final int TYPE_QA_UPDATE = 680;
	public static final int TYPE_TIP_CREATE = 690;
	public static final int TYPE_TIP_DELETE = 700;
	public static final int TYPE_TIP_UPDATE = 710;
	public static final int TYPE_INQUIRY_CREATE = 720;
	public static final int TYPE_INQUIRY_DELETE = 730;
	public static final int TYPE_INQUIRY_UPDATE = 740;
	public static final int TYPE_PROXY_CREATE = 750;
	public static final int TYPE_PROXY_DELETE = 760;
	public static final int TYPE_PROXY_UPDATE = 770;
	public static final int TYPE_REDIRECT_CREATE = 780;
	public static final int TYPE_REDIRECT_DELETE = 790;
	public static final int TYPE_REDIRECT_UPDATE = 800;
	public static final int TYPE_PAGE_DELETE = 810;
	public static final int TYPE_PAGE_UPDATE = 820;
	public static final int TYPE_FORUM_SAVE = 2000;
	public static final int TYPE_USER_PERM_GROUP_CREATE = 830;
	public static final int TYPE_USER_PERM_GROUP_UPDATE = 840;
	public static final int TYPE_USER_PERM_GROUP_DELETE = 850;
	public static final int TYPE_FORUM_DELETE = 860;
	public static final int TYPE_FORUM_UNDELETE = 861;
	public static final int TYPE_FORUM_CLOSE = 860;
	public static final int TYPE_FORUM_CREATE = 870;
	public static final int TYPE_FORUM_UPDATE = 880;
	public static final int TYPE_BASKET_CREATE = 890;
	public static final int TYPE_BASKET_DELETE = 900;
	public static final int TYPE_BASKET_UPDATE = 910;
	public static final int TYPE_FILE_SAVE = 920;
	public static final int TYPE_FILE_DELETE = 930;
	public static final int TYPE_FILE_EDIT = 935;
	public static final int TYPE_FILE_CREATE = 936;

	public static final int TYPE_PERSISTENT_CACHE = 300;
	public static final int TYPE_INSERT_SCRIPT = 301;
	public static final int TYPE_ADMINLOG_NOTIFY = 302;
	public static final int TYPE_TEMPLATE_GROUP = 303;
	public static final int TYPE_TOOLTIP = 304;

	public static final int TYPE_RESERVATION = 305;
	public static final int TYPE_RESERVATION_OBJECT = 306;
	public static final int TYPE_RESERVATION_PRICE = 307;
	public static final int TYPE_RESERVATION_TIMES = 308;
	public static final int TYPE_DOC_ATTRIBUTES = 309;
	public static final int TYPE_SEO = 310;
	public static final int TYPE_RESTAURANT_MENU = 311;
	public static final int TYPE_QUIZ = 312;
	public static final int TYPE_FILE_ARCHIVE = 313;

	/*
	public static final int TYPE_HEAT_MAP_CLEAN = 940;
	public static final int TYPE_REG_ALARM = 970;
	*/
	public static final int TYPE_CLIENT_SPECIFIC = 99999;
	public static final int TYPE_UPDATEDB = 980;
	/*
	public static final int TYPE_CONTACT_CREATE = 990;
	public static final int TYPE_CONTACT_UPDATE = 991;
	public static final int TYPE_CONTACT_DELETE = 992;
	*/
	public static final int TYPE_INVENTORY = 1000;
	public static final int TYPE_IMPORT_WEBJET = 1010;
	public static final int TYPE_EXPORT_WEBJET = 1020;
	public static final int TYPE_EXPORT=1030;
	public static final int TYPE_PAYMENT_GATEWAY=1040;
	public static final int TYPE_WEB_SERVICES=1050;
    public static final int TYPE_GDPR_FORMS_DELETE = 1070;
    public static final int TYPE_GDPR_USERS_DELETE = 1071;
    public static final int TYPE_GDPR_BASKET_INVOICES_DELETE = 1072;
    public static final int TYPE_GDPR_EMAILS_DELETE = 1073;
	 public static final int TYPE_GDPR_REGEXP = 1074;
	 public static final int TYPE_GDPR_DELETE = 1075;
	 public static final int TYPE_GDPR_COOKIES = 1076;

	//POZOR NAD hodnotu 10 000 je mozne pridavat len client specific polia, ktore sa zobrazia len ak sa v nazve nachadza install name
	public static final int TYPE_CLONE_CLOUD_STRUCTURE = 10030;
	public static final int TYPE_SUCCESSFULLY_DELETED_CLOUD_STRUCTURE = 10040;
	public static final int TYPE_DELETE_ERROR_CLOUD_STRUCTURE = 10050;
	public static final int TYPE_REQUEST_TO_ORDER_DOMAIN_CLOUD = 10060;
	public static final int TYPE_ORDERED_DOMAIN_CLOUD = 10070;
	public static final int TYPE_REQUEST_TO_CONNECT_DOMAIN_CLOUD = 10080;
	public static final int TYPE_CONNECTED_DOMAIN_CLOUD = 10090;
	public static final int TYPE_USER_RENAME_DOMAIN_CLOUD = 10100;

	public static final int TYPE_COOKIE_ACCEPTED = 1060;
	public static final int TYPE_COOKIE_REJECTED = 1061;

	public static final int TYPE_RESPONSE_HEADER = 1062;

	//toto musi byt public aby to vedel ziskat adminlog.jsp
	private static final Integer[] TYPY_ARRAY;

	static
	{
		//zozbiera zoznam hore do pola TYPY_ARRAY
		// MBO: to uz to sakra nemohol byt ENUM???
<span class="fc" id="L195">		List&lt;Integer&gt; values = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L196">		Field[] fields =	Adminlog.class.getFields();</span>
<span class="fc bfc" id="L197" title="All 2 branches covered.">		for (Field field : fields)</span>
		{
			try
			{
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">				if (field.getType() != int.class)</span>
<span class="nc" id="L202">					continue;</span>

<span class="fc" id="L204">				int value = field.getInt(null);</span>

<span class="fc bfc" id="L206" title="All 4 branches covered.">				if (value &gt; 10000 &amp;&amp; value != TYPE_CLIENT_SPECIFIC)</span>
				{
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">					if (field.getName().toLowerCase().indexOf(Constants.getInstallName())==-1) continue;</span>
				}

<span class="fc" id="L211">				values.add(value);</span>
				// this code gather all the types and creates corresponding text.properties keys
				//System.out.println(String.format(&quot;components.adminlog.%d=%s&quot;, value, field.getName().replace(&quot;TYPE_&quot;, &quot;&quot;)));
			}
<span class="pc" id="L215">			catch (IllegalArgumentException|IllegalAccessException e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="fc" id="L217">		Collections.sort(values);</span>
<span class="fc" id="L218">		TYPY_ARRAY = values.toArray(new Integer[0]);</span>
<span class="fc" id="L219">	}</span>

	private Adminlog() {
		//private constructor
	}

	/**
	 * Zaloguje hlasku do admin logu
	 * @param logType - typ zaznamu (podla TYPE_xxx alebo custom &gt; 99999)
	 * @param description - popis zaznamu
	 * @param subId1 - custom int typ1 (napr. primarny kluc objektu, ktoreho sa tyka zmena - docid, forumid,...)
	 * @param subId2 - custom int typ2
	 */
	public static void add(int logType, String description, int subId1, int subId2)
	{
<span class="fc" id="L234">		add(logType, SetCharacterEncodingFilter.getCurrentRequestBean(), description, subId1, subId2, new Timestamp(Tools.getNow()));</span>
<span class="fc" id="L235">	}</span>

	public static void add(int logType, String description, Long subId1, Long subId2)
	{
<span class="nc" id="L239">		int isub1 = 0;</span>
<span class="nc" id="L240">		int isub2 = 0;</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">		if (subId1 != null) isub1 = subId1.intValue();</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">		if (subId2 != null) isub2 = subId2.intValue();</span>
<span class="nc" id="L243">		add(logType, SetCharacterEncodingFilter.getCurrentRequestBean(), description, isub1, isub2, new Timestamp(Tools.getNow()));</span>
<span class="nc" id="L244">	}</span>

	/**
	 * Zaloguje hlasku do admin logu
	 * @param logType - typ zaznamu (podla TYPE_xxx alebo custom &gt; 99999)
	 * @param description - popis zaznamu
	 * @param subId1 - custom int typ1 (napr. primarny kluc objektu, ktoreho sa tyka zmena - docid, forumid,...)
	 * @param subId2 - custom int typ2
	 * @param timestamp - timestamp zaznamu v DB
	 */
	public static void add(int logType, String description, int subId1, int subId2, Timestamp timestamp)
	{
<span class="nc" id="L256">		add(logType, SetCharacterEncodingFilter.getCurrentRequestBean(), description, subId1, subId2, timestamp);</span>
<span class="nc" id="L257">	}</span>



	/**
	 * Pridanie zaznamu do adminlogu AK SA POUZIVATEL ZMENIL OD ZACIATKU REQUESTU
	 * @param logType - typ zaznamu (podla TYPE_xxx alebo custom &gt; 99999)
	 * @param userId - id pouzivatela (pouzije sa ak je request null)
	 * @param description - popis zmeny
	 * @param subId1 - custom int typ1 (napr. primarny kluc objektu, ktoreho sa tyka zmena - docid, forumid,...)
	 * @param subId2 - custom int typ2
	 * @param timestamp - timestamp zaznamu v DB
	 */
	public static void add(int logType, int userId, String description, int subId1, int subId2, Timestamp timestamp)
	{
<span class="fc" id="L272">		RequestBean requestBean = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">		if (requestBean == null) requestBean = new RequestBean();</span>
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">		if (userId &gt; 0) requestBean.setUserId(userId);</span>
<span class="fc" id="L275">		add(logType, requestBean, description, subId1, subId2, timestamp);</span>
<span class="fc" id="L276">	}</span>

	/**
	 * Pridanie zaznamu do adminlogu AK SA POUZIVATEL ZMENIL OD ZACIATKU REQUESTU
	 * @param logType - typ zaznamu (podla TYPE_xxx alebo custom &gt; 99999)
	 * @param userId - id pouzivatela (pouzije sa ak je request null)
	 * @param description - popis zmeny
	 * @param subId1 - custom int typ1 (napr. primarny kluc objektu, ktoreho sa tyka zmena - docid, forumid,...)
	 * @param subId2 - custom int typ2
	 */
	public static void add(int logType, int userId, String description, int subId1, int subId2)
	{
<span class="fc" id="L288">		RequestBean requestBean = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">		if (requestBean == null) requestBean = new RequestBean();</span>
<span class="fc bfc" id="L290" title="All 2 branches covered.">		if (userId &gt; 0) requestBean.setUserId(userId);</span>
<span class="fc" id="L291">		add(logType, requestBean, description, subId1, subId2, new Timestamp(Tools.getNow()));</span>
<span class="fc" id="L292">	}</span>

	/**
	 * Pridanie zaznamu do adminlogu, zaznam sa zapise anonymne (bez IP adresy, user-agent a referer)
	 * @param logType - typ zaznamu (podla TYPE_xxx alebo custom &gt; 99999)
	 * @param description - popis zmeny
	 * @param subId1 - custom int typ1 (napr. primarny kluc objektu, ktoreho sa tyka zmena - docid, forumid,...)
	 * @param subId2 - custom int typ2
	 * @param anonymous -
	 */
	public static void addAnonymously(int logType, String description, int subId1, int subId2) {
<span class="nc" id="L303">		RequestBean requestBeanAnonym = new RequestBean();</span>
<span class="nc" id="L304">		requestBeanAnonym.setUserId(-1);</span>
<span class="nc" id="L305">		RequestBean requestBean = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">		if (requestBean != null) {</span>
<span class="nc" id="L307">			requestBeanAnonym.setDomain(requestBean.getDomain());</span>
<span class="nc" id="L308">			requestBeanAnonym.setUrl(requestBean.getUrl());</span>
<span class="nc" id="L309">			requestBeanAnonym.setRemoteIP(&quot;0.0.0.0&quot;);</span>
<span class="nc" id="L310">			requestBeanAnonym.setRemoteHost(&quot;0.0.0.0&quot;);</span>

		}
<span class="nc" id="L313">		add(logType, requestBeanAnonym, description, subId1, subId2, new Timestamp(Tools.getNow()));</span>
<span class="nc" id="L314">	}</span>

//	public static void addWithDifferentUser(int logType, int userId, String description, int subId1, int subId2)
//	{
//		RequestBean requestBean = SetCharacterEncodingFilter.getCurrentRequestBean();
//		requestBean.setUserId(userId);
//		add(logType, requestBean, description, subId1, subId2);
//	}

//	private static void add(int logType, RequestBean requestBean, String description, int subId1, int subId2)
//	{
//		add(logType, requestBean, description, subId1, subId2, new Timestamp(Tools.getNow()));
//	}

	private static void add(int logType, RequestBean requestBean, String descriptionParam, int subId1, int subId2, Timestamp timestamp)
	{
<span class="fc" id="L330">		StringBuilder localhostAppend = null;</span>
<span class="fc bfc" id="L331" title="All 4 branches covered.">		if (requestBean == null || Tools.isEmpty(requestBean.getRemoteIP())) {</span>
<span class="fc bfc" id="L332" title="All 2 branches covered.">			if (requestBean == null) requestBean = new RequestBean();</span>

			try {
<span class="fc" id="L335">				localhostAppend = new StringBuilder();</span>
				//it's probably not HTTP request call, set IP address of server
<span class="fc" id="L337">				String serverName = InetAddress.getLocalHost().getHostName();</span>
<span class="fc" id="L338">				InetAddress[] ipecky = InetAddress.getAllByName(serverName);</span>

				int i;
<span class="fc bfc" id="L341" title="All 2 branches covered.">				for (i = 0; i &lt; ipecky.length; i++)</span>
				{
<span class="pc bpc" id="L343" title="1 of 2 branches missed.">					if (i==0) {</span>
<span class="fc" id="L344">						requestBean.setRemoteIP(ipecky[i].getHostAddress());</span>
<span class="fc" id="L345">						requestBean.setRemoteHost(ipecky[i].getHostName());</span>
					}
<span class="fc" id="L347">					localhostAppend.append(&quot;ServerIP[&quot;).append(i + 1).append(&quot;]: &quot;).append(ipecky[i].getHostAddress()).append(' ').append(ipecky[i].getHostName()).append('\n');</span>
				}

<span class="pc bpc" id="L350" title="1 of 2 branches missed.">				if (Constants.getServletContext()!=null) localhostAppend.append(&quot;Web root: &quot;).append(Constants.getServletContext().getRealPath(&quot;/&quot;)).append('\n');</span>
<span class="fc" id="L351">				localhostAppend.append(&quot;user: &quot;).append(System.getProperty(&quot;user.name&quot;)).append('\n');</span>

<span class="nc" id="L353">			} catch (Exception ex) {</span>
				//
<span class="fc" id="L355">			}</span>
		}

		//Timestamp timestamp = new Timestamp(Tools.getNow());

<span class="fc" id="L360">		String description = descriptionParam;</span>

<span class="fc bfc" id="L362" title="All 4 branches covered.">		if (Tools.isEmpty(description) || logType==Adminlog.TYPE_FORMMAIL)</span>
		{
<span class="fc bfc" id="L364" title="All 2 branches covered.">			if (Tools.isNotEmpty(requestBean.getErrorsString())) description = requestBean.getErrorsString();</span>

<span class="fc" id="L366">			StringBuilder parameters = new StringBuilder();</span>

<span class="fc bfc" id="L368" title="All 2 branches covered.">			for (Map.Entry&lt;String, String[]&gt; entry : requestBean.getAllParameters().entrySet())</span>
			{
<span class="fc bfc" id="L370" title="All 2 branches covered.">				for (String value : entry.getValue())</span>
				{
<span class="fc bfc" id="L372" title="All 2 branches covered.">					if (parameters.length()&gt;0) parameters.append(&quot;\n&quot;);</span>
<span class="fc" id="L373">					parameters.append(entry.getKey());</span>
<span class="fc" id="L374">					parameters.append(&quot;: &quot;);</span>
<span class="fc" id="L375">					parameters.append(value);</span>
				}
<span class="fc" id="L377">			}</span>

<span class="fc bfc" id="L379" title="All 2 branches covered.">			if (parameters.length()&gt;0)</span>
			{
<span class="fc" id="L381">				description = description + &quot;\nparameters:\n&quot;+parameters.toString();</span>
			}
		}

		//add auditValues from RequestBean
<span class="pc bpc" id="L386" title="1 of 2 branches missed.">        if (requestBean != null) {</span>
<span class="fc" id="L387">            description = description + getRequestBeanAuditLog(requestBean);</span>
        }


<span class="fc" id="L391">		boolean writeToAuditLog = true;</span>

		try
		{
<span class="pc bpc" id="L395" title="3 of 4 branches missed.">			if (logType==TYPE_JSPERROR &amp;&amp; description.indexOf(&quot;Cannot create a session after the response has been committed&quot;)!=-1) writeToAuditLog = false;</span>
		}
<span class="nc" id="L397">		catch (Exception e)</span>
		{
<span class="nc" id="L399">			sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L400">		}</span>

<span class="pc bpc" id="L402" title="1 of 2 branches missed.">		if (writeToAuditLog)</span>
		{
			try
			{
				//debug
<span class="fc" id="L407">				Logger.debug(Adminlog.class, description + &quot; subId1=&quot;+subId1+&quot; subId2=&quot;+subId2);</span>

<span class="fc" id="L409">				Connection db_conn = DBPool.getConnection();</span>
				try
				{
<span class="fc" id="L412">					PreparedStatement ps = db_conn.prepareStatement(&quot;INSERT INTO &quot; + ConfDB.ADMINLOG_TABLE_NAME+&quot; (log_type, user_id, ip, hostname, create_date, description, sub_id1, sub_id2) VALUES (?, ?, ?, ?, ?, ?, ?, ?)&quot;);</span>
					try
					{
<span class="fc" id="L415">						int index = 1;</span>
<span class="fc" id="L416">						ps.setInt(index++, logType);</span>
<span class="fc" id="L417">						ps.setInt(index++, requestBean.getUserId());</span>
<span class="fc" id="L418">						ps.setString(index++, requestBean.getRemoteIP());</span>
<span class="fc" id="L419">						ps.setString(index++, requestBean.getRemoteHost());</span>

<span class="fc" id="L421">						ps.setTimestamp(index++, timestamp);</span>

<span class="fc" id="L423">						String descriptionLocal = DB.prepareString(description, 60000);</span>

<span class="fc" id="L425">						String nodeName = Constants.getString(&quot;clusterMyNodeName&quot;);</span>
<span class="fc" id="L426">                        descriptionLocal += &quot;\n&quot;;</span>
<span class="fc bfc" id="L427" title="All 2 branches covered.">						if (Tools.isNotEmpty(nodeName))</span>
						{
<span class="fc" id="L429">                            descriptionLocal += &quot;\nnode:&quot;+nodeName;</span>
						}
<span class="fc bfc" id="L431" title="All 2 branches covered.">						if (Tools.isNotEmpty(requestBean.getUrl()))</span>
						{
<span class="fc" id="L433">                            descriptionLocal += &quot;\nURI: &quot;+requestBean.getUrl();</span>
<span class="pc bpc" id="L434" title="1 of 4 branches missed.">							if (Tools.isNotEmpty(requestBean.getQueryString()) &amp;&amp; requestBean.getUrl().equals(&quot;/admin/logon.do&quot;)==false) descriptionLocal += &quot;?&quot;+requestBean.getQueryString();</span>
						}
<span class="fc bfc" id="L436" title="All 2 branches covered.">						if (Tools.isNotEmpty(requestBean.getDomain()))</span>
						{
<span class="fc" id="L438">                            descriptionLocal += &quot;\nDomain: &quot;+requestBean.getDomain();</span>
						}
<span class="fc bfc" id="L440" title="All 2 branches covered.">						if (Tools.isNotEmpty(requestBean.getUserAgent()))</span>
						{
<span class="fc" id="L442">                            descriptionLocal += &quot;\nUser-Agent: &quot;+requestBean.getUserAgent();</span>
						}
<span class="pc bpc" id="L444" title="1 of 4 branches missed.">						if (localhostAppend!=null &amp;&amp; localhostAppend.length()&gt;0)</span>
						{
<span class="fc" id="L446">							descriptionLocal += &quot;\n&quot;+localhostAppend.toString();</span>
						}

<span class="fc" id="L449">						DB.setClob(ps, index++, DB.prepareString(descriptionLocal, 65000));</span>

<span class="fc" id="L451">						ps.setInt(index++, subId1);</span>
<span class="fc" id="L452">						ps.setInt(index++, subId2);</span>

<span class="fc" id="L454">						ps.execute();</span>
					}
<span class="fc" id="L456">					finally { ps.close(); }</span>
				}
<span class="fc" id="L458">				finally { db_conn.close(); }</span>
			}
<span class="nc" id="L460">			catch (Exception ex)</span>
			{
<span class="nc" id="L462">				sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L463">			}</span>
		}

<span class="pc bpc" id="L466" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(Constants.getString(&quot;adminlogCustomLogger&quot;)))</span>
		{
			try
			{
				@SuppressWarnings(&quot;rawtypes&quot;)
<span class="nc" id="L471">				Class loggerClass = Class.forName(Constants.getString(&quot;adminlogCustomLogger&quot;));</span>
<span class="nc bnc" id="L472" title="All 4 branches missed.">				if (loggerClass!=null &amp;&amp; AdminlogCustomLogger.class.isAssignableFrom(loggerClass))</span>
				{
					@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L475">					AdminlogCustomLogger logger = (AdminlogCustomLogger)loggerClass.getDeclaredConstructor().newInstance();</span>
					//sem musi ist descriptionParam, pretoze description uz obsahuje aj parametre (ak je prazdny description pridaju sa, to v TB handlujeme zvlast)
<span class="nc" id="L477">					logger.addLog(logType, requestBean, descriptionParam, timestamp);</span>
				}
			}
<span class="nc" id="L480">			catch (Exception e)</span>
			{
<span class="nc" id="L482">				sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L483">			}</span>
		}

		try
		{
			//Logovanie do suboru
<span class="fc" id="L489">			AdminlogFile.write(timestamp, requestBean, logType, description);</span>
			//AdminlogTB.write(timestamp, requestBean, logType, description);
		}
<span class="nc" id="L492">		catch (Exception e)</span>
		{
<span class="nc" id="L494">			sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L495">		}</span>

		try
		{
			//Poslanie notifikacie
<span class="fc" id="L500">			AdminlogNotifyManager.sendNotification(logType, requestBean, timestamp, description, writeToAuditLog); // posle notifikacny email, ak je nastaveny</span>
		}
<span class="nc" id="L502">		catch (Exception e)</span>
		{
<span class="nc" id="L504">			sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L505">		}</span>
<span class="fc" id="L506">	}</span>

	/**
	 * Vrati datum posledneho zaznamu daneho typu pre daneho pouzivatela
	 * @param logType - typ zaznamu
	 * @param userId - id pouzivatela
	 * @return
	 */
	public static long getLastDate(int logType, int userId)
	{
<span class="nc" id="L516">		long lastDate = 0;</span>
		try
		{
<span class="nc" id="L519">			Connection db_conn = DBPool.getConnection();</span>
			try
			{
<span class="nc" id="L522">				PreparedStatement ps = db_conn.prepareStatement(&quot;SELECT max(create_date) as create_date FROM &quot;+ConfDB.ADMINLOG_TABLE_NAME+&quot; WHERE user_id=? AND log_type=?&quot;);</span>
				try
				{
<span class="nc" id="L525">					ps.setInt(1, userId);</span>
<span class="nc" id="L526">					ps.setInt(2, logType);</span>
<span class="nc" id="L527">					ResultSet rs = ps.executeQuery();</span>
					try
					{
<span class="nc bnc" id="L530" title="All 2 branches missed.">						if (rs.next())</span>
						{
<span class="nc" id="L532">							Timestamp ts = rs.getTimestamp(&quot;create_date&quot;);</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">							if (ts != null) lastDate = ts.getTime();</span>
						}
					}
<span class="nc" id="L536">					finally { rs.close(); }</span>
				}
<span class="nc" id="L538">				finally { ps.close(); }</span>
			}
<span class="nc" id="L540">			finally { db_conn.close(); }</span>
		}
<span class="nc" id="L542">		catch (Exception ex)</span>
		{
<span class="nc" id="L544">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L545">		}</span>
<span class="nc" id="L546">		return(lastDate);</span>
	}

	/**
	 * Returns changelog text for given object
	 * @param id - ID of object OR NULL/-1 if new object
	 * @param newObj - changed object
	 * @param originalObj - original object allready saved in DB or NULL if new object
	 * @return
	 */
	public static String getChangelog(Long id, Object newObj, Object originalObj) {
<span class="fc" id="L557">		String changes = Adminlog.getPojoZmeny(newObj, originalObj);</span>
<span class="fc" id="L558">		String title = &quot;CREATE:&quot;;</span>
<span class="fc bfc" id="L559" title="All 2 branches covered.">		if (originalObj != null)</span>
		{
<span class="fc" id="L561">			title = &quot;UPDATE:&quot;;</span>
		}
<span class="fc" id="L563">		return title + &quot;\nid: &quot; + id + &quot;\n&quot; + changes;</span>
	}

	/**
	 * Returns changelog text for DELETE of given object (prints all properties)
	 * @param id
	 * @param obj
	 * @return
	 */
	public static String getChangelogDelete(Long id, Object obj) {
<span class="fc" id="L573">		String changes = Adminlog.getPojoZmeny(obj, null);</span>
<span class="fc" id="L574">		String title = &quot;DELETE:&quot;;</span>
<span class="fc" id="L575">		return title + &quot;\nid: &quot; + id + &quot;\n&quot; + changes;</span>
	}

	/**
	 * Vrati zoznam zmenenych atributov POJO objektu
	 * @param o1
	 * @param o1Original
	 * @return
	 */
	public static String getPojoZmeny(Object newObj, Object originalObj)
	{
<span class="pc bpc" id="L586" title="1 of 2 branches missed.">        if(newObj == null)</span>
<span class="nc" id="L587">            return &quot;Bez zmeny&quot;;</span>
<span class="fc" id="L588">        BeanDiff diff = new BeanDiff().setNew(newObj).setOriginal(originalObj);</span>
<span class="fc" id="L589">        return new BeanDiffPrinter(diff).toString();</span>
	}

	public static List&lt;AdminlogBean&gt; searchAdminlog(int[] logTypes, int logTypeFrom, int logTypeTo, int userId, long createdFrom, long createdTo, String description, int subId1, int subId2, String ip, String hostname)
	{
<span class="fc" id="L594">		return searchAdminlog(logTypes, logTypeFrom, logTypeTo, userId, createdFrom, createdTo, description, subId1, subId2, ip, hostname, -1);</span>
	}

	/**
	 * Vyhladavanie v adminlogu
	 * @param logTypes - pole log_type ideciek, alebo prazdne pole
	 * @param logTypeFrom - log type od, alebo -1
	 * @param logTypeTo - log type do, alebo -1
	 * @param userId - id pouzivatela, alebo 0
	 * @param createdFrom - datum zaciatku logu, alebo -1
	 * @param createdTo - datum konca logu, alebo -1
	 * @param description, podretazec z pola description, alebo null
	 * @param subId1 - sub_id1, alebo -1
	 * @param subId2 - sub_id2, alebo -1
	 * @param ip - podretazec ip adresy pocitaca, alebo null
	 * @param hostname - podretazec hostname pocitaca, alebo null
	 * @param logIdGreaterThan - id zaznamu v databaze od ktoreho sa budu vysledky vyhladavat. Je to kladne cislo alebo -1
	 * @return
	 */
	public static List&lt;AdminlogBean&gt; searchAdminlog(int[] logTypes, int logTypeFrom, int logTypeTo, int userId, long createdFrom, long createdTo, String description, int subId1, int subId2, String ip, String hostname, int logIdGreaterThan)
	{
<span class="fc" id="L615">		List&lt;AdminlogBean&gt; logy = new ArrayList&lt;&gt;();</span>

		try
		{
<span class="fc" id="L619">			StringBuilder sql = new StringBuilder(&quot;SELECT * FROM &quot;).append(ConfDB.ADMINLOG_TABLE_NAME);</span>
<span class="fc" id="L620">			StringBuilder where = new StringBuilder();</span>
<span class="pc bpc" id="L621" title="1 of 2 branches missed.">			if (logTypes.length&gt;0)</span>
			{
<span class="fc" id="L623">				where.append(&quot; AND log_type IN (&quot;);</span>
<span class="fc bfc" id="L624" title="All 2 branches covered.">				for (int i=0; i&lt;logTypes.length; i++)</span>
				{
<span class="pc bpc" id="L626" title="1 of 2 branches missed.">					if (i&gt;0) where.append(',');</span>
<span class="fc" id="L627">					where.append(logTypes[i]);</span>
				}
<span class="fc" id="L629">				where.append(')');</span>
			}
<span class="pc bpc" id="L631" title="1 of 2 branches missed.">			if (logTypeFrom != -1)</span>
			{
<span class="nc" id="L633">				where.append(&quot; AND log_type&gt;=&quot;).append(logTypeFrom);</span>
			}
<span class="pc bpc" id="L635" title="1 of 2 branches missed.">			if (logTypeTo != -1)</span>
			{
<span class="nc" id="L637">				where.append(&quot; AND log_type&lt;=&quot;).append(logTypeTo);</span>
			}
<span class="pc bpc" id="L639" title="1 of 2 branches missed.">			if (userId != 0)</span>
			{
<span class="pc bpc" id="L641" title="1 of 2 branches missed.">				if (userId&lt;0)</span>
				{
<span class="nc" id="L643">					userId = -userId;</span>
<span class="nc" id="L644">					where.append(&quot; AND user_id&lt;&gt;&quot;).append(userId);</span>
				}
				else
				{
<span class="fc" id="L648">					where.append(&quot; AND user_id=&quot;).append(userId);</span>
				}
			}
<span class="pc bpc" id="L651" title="1 of 2 branches missed.">			if (createdFrom &gt; 0)</span>
			{
<span class="nc" id="L653">				where.append(&quot; AND create_date&gt;=?&quot;);</span>
			}
<span class="pc bpc" id="L655" title="1 of 2 branches missed.">			if (createdTo &gt; 0)</span>
			{
<span class="nc" id="L657">				where.append(&quot; AND create_date&lt;=?&quot;);</span>
			}
<span class="pc bpc" id="L659" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(description))</span>
			{
<span class="pc bpc" id="L661" title="3 of 4 branches missed.">				if (description.charAt(0)=='!' &amp;&amp; description.length()&gt;2)</span>
				{
<span class="nc" id="L663">					description = description.substring(1);</span>
<span class="nc" id="L664">					where.append(&quot; AND description NOT LIKE ?&quot;);</span>
				}
<span class="pc bpc" id="L666" title="3 of 4 branches missed.">				else if (description.startsWith(&quot;NOT&quot;) &amp;&amp; description.length()&gt;3)</span>
                {
<span class="nc" id="L668">                    description = description.substring(3).trim();</span>
<span class="nc" id="L669">                    where.append(&quot; AND description NOT LIKE ?&quot;);</span>
                }
				else
				{
<span class="fc" id="L673">					where.append(&quot; AND description LIKE ?&quot;);</span>
				}
			}
<span class="pc bpc" id="L676" title="1 of 2 branches missed.">			if (subId1 != -1)</span>
			{
<span class="nc" id="L678">				where.append(&quot; AND sub_id1=&quot;).append(subId1);</span>
			}
<span class="pc bpc" id="L680" title="1 of 2 branches missed.">			if (subId2 != -1)</span>
			{
<span class="nc" id="L682">				where.append(&quot; AND sub_id2=&quot;).append(subId2);</span>
			}
<span class="pc bpc" id="L684" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(ip))</span>
			{
<span class="nc bnc" id="L686" title="All 4 branches missed.">				if (ip.charAt(0)=='!' &amp;&amp; ip.length()&gt;2)</span>
				{
<span class="nc" id="L688">					ip = ip.substring(1);</span>
<span class="nc" id="L689">					where.append(&quot; AND ip NOT LIKE ?&quot;);</span>
				}
				else
				{
<span class="nc" id="L693">					where.append(&quot; AND ip LIKE ?&quot;);</span>
				}
			}
<span class="pc bpc" id="L696" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(hostname))</span>
			{
<span class="nc bnc" id="L698" title="All 4 branches missed.">				if (hostname.charAt(0)=='!' &amp;&amp; hostname.length()&gt;2)</span>
				{
<span class="nc" id="L700">					hostname = hostname.substring(1);</span>
<span class="nc" id="L701">					where.append(&quot; AND hostname NOT LIKE ?&quot;);</span>
				}
				else
				{
<span class="nc" id="L705">					where.append(&quot; AND hostname LIKE ?&quot;);</span>
				}
			}
<span class="pc bpc" id="L708" title="1 of 2 branches missed.">			if (logIdGreaterThan != -1)</span>
			{
<span class="nc" id="L710">				where.append(&quot; AND log_id&gt;=&quot;).append(logIdGreaterThan);</span>
			}


<span class="pc bpc" id="L714" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(where))</span>
			{
				//odstranime prve AND
<span class="fc" id="L717">				sql.append(&quot; WHERE &quot;).append(where.substring(4).trim());</span>
			}

<span class="fc" id="L720">			sql.append(&quot; ORDER BY log_id DESC&quot;);</span>

<span class="fc" id="L722">			Logger.debug(Adminlog.class, &quot;adminlog sql: &quot; + sql);</span>

<span class="fc" id="L724">			Connection db_conn = DBPool.getConnection();</span>
			try
			{
<span class="fc" id="L727">				PreparedStatement ps = db_conn.prepareStatement(sql.toString());</span>
				try
				{
<span class="fc" id="L730">					int psCounter = 1;</span>
<span class="pc bpc" id="L731" title="1 of 2 branches missed.">					if (createdFrom &gt; 0)</span>
					{
<span class="nc" id="L733">						ps.setTimestamp(psCounter++, new Timestamp(createdFrom));</span>
					}
<span class="pc bpc" id="L735" title="1 of 2 branches missed.">					if (createdTo &gt; 0)</span>
					{
<span class="nc" id="L737">						ps.setTimestamp(psCounter++, new Timestamp(createdTo));</span>
					}
<span class="pc bpc" id="L739" title="1 of 2 branches missed.">					if (Tools.isNotEmpty(description))</span>
					{
<span class="fc" id="L741">						ps.setString(psCounter++, &quot;%&quot;+description+&quot;%&quot;);</span>
					}
<span class="pc bpc" id="L743" title="1 of 2 branches missed.">					if (Tools.isNotEmpty(ip))</span>
					{
<span class="nc" id="L745">						ps.setString(psCounter++, &quot;%&quot;+ip+&quot;%&quot;);</span>
					}
<span class="pc bpc" id="L747" title="1 of 2 branches missed.">					if (Tools.isNotEmpty(hostname))</span>
					{
<span class="nc" id="L749">						ps.setString(psCounter++, &quot;%&quot;+hostname+&quot;%&quot;);</span>
					}

<span class="fc" id="L752">					ResultSet rs = ps.executeQuery();</span>
					try
					{
						AdminlogBean ab;
<span class="fc bfc" id="L756" title="All 2 branches covered.">						while (rs.next())</span>
						{
<span class="fc" id="L758">							ab = new AdminlogBean(rs);</span>
<span class="fc" id="L759">							logy.add(ab);</span>
						}
					}
<span class="fc" id="L762">					finally { rs.close(); }</span>
				}
<span class="fc" id="L764">				finally { ps.close(); }</span>
			}
<span class="fc" id="L766">			finally { db_conn.close(); }</span>
		}
<span class="nc" id="L768">		catch (Exception ex)</span>
		{
<span class="nc" id="L770">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L771">		}</span>

<span class="fc" id="L773">		return(logy);</span>
	}

	public static List&lt;AdminlogBean&gt; getLastEvents(int size)
	{
<span class="fc" id="L778">		Connection db_conn = null;</span>
<span class="fc" id="L779">		PreparedStatement ps = null;</span>
<span class="fc" id="L780">		ResultSet rs = null;</span>
<span class="fc" id="L781">		List&lt;AdminlogBean&gt; logy = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L782">		String ADMINLOG_FIELDS_NODATA = &quot;SELECT * FROM &quot;;</span>
<span class="fc" id="L783">		String ADMINLOG_ORDER_BY_DOCS_ID = &quot; ORDER BY log_id DESC&quot;;</span>
		try
		{
<span class="fc" id="L786">			StringBuilder sql = null;</span>
<span class="pc bpc" id="L787" title="1 of 2 branches missed.">			if (Constants.DB_TYPE == Constants.DB_MSSQL)</span>
			{
<span class="nc" id="L789">				sql = new StringBuilder(&quot;SELECT TOP &quot;).append(size).append(&quot; * FROM &quot;).append(ConfDB.ADMINLOG_TABLE_NAME);</span>
<span class="nc" id="L790">				sql.append(ADMINLOG_ORDER_BY_DOCS_ID);</span>
			}
<span class="pc bpc" id="L792" title="3 of 4 branches missed.">			else if (Constants.DB_TYPE == Constants.DB_MYSQL || Constants.DB_TYPE == Constants.DB_PGSQL)</span>
			{
<span class="fc" id="L794">				sql = new StringBuilder(ADMINLOG_FIELDS_NODATA).append(ConfDB.ADMINLOG_TABLE_NAME);</span>
<span class="fc" id="L795">				sql.append(ADMINLOG_ORDER_BY_DOCS_ID);</span>
<span class="fc" id="L796">				sql.append(&quot; LIMIT &quot;).append(size);</span>
			}
			else
			{
				//oracle
<span class="nc" id="L801">				sql = new StringBuilder(ADMINLOG_FIELDS_NODATA).append(ConfDB.ADMINLOG_TABLE_NAME);</span>
<span class="nc" id="L802">				sql.append(&quot; WHERE rownum &lt; &quot;).append(size);</span>
<span class="nc" id="L803">				sql.append(ADMINLOG_ORDER_BY_DOCS_ID);</span>
			}
<span class="fc" id="L805">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L806">			ps = db_conn.prepareStatement(sql.toString(), ResultSet.TYPE_FORWARD_ONLY, ResultSet.CONCUR_READ_ONLY);</span>
<span class="fc" id="L807">			rs = ps.executeQuery();</span>
			try
			{
				AdminlogBean ab;
<span class="fc bfc" id="L811" title="All 2 branches covered.">				while (rs.next())</span>
				{
<span class="fc" id="L813">					ab = new AdminlogBean(rs);</span>
<span class="fc" id="L814">					logy.add(ab);</span>
				}
			}
			finally
			{
<span class="fc" id="L819">				rs.close();</span>
<span class="fc" id="L820">				ps.close();</span>
<span class="fc" id="L821">				db_conn.close();</span>
			}
		}
<span class="nc" id="L824">		catch (Exception ex)</span>
		{
<span class="nc" id="L826">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L827">		}</span>
<span class="fc" id="L828">		return logy;</span>
	}

	/**
	 * Returns all types of audit
	 * @return
	 */
	public static Integer[] getTypes() {
<span class="fc" id="L836">		return TYPY_ARRAY;</span>
	}

	/**
	 * Format RequestBean.auditValues to String
	 * @param requestBean
	 * @return
	 */
	public static String getRequestBeanAuditLog(RequestBean requestBean) {
		//add auditValues from RequestBean
<span class="fc" id="L846">		StringBuilder log = new StringBuilder();</span>
<span class="pc bpc" id="L847" title="1 of 2 branches missed.">        if (requestBean != null) {</span>
<span class="fc" id="L848">            Map&lt;String, String[]&gt; auditValues = requestBean.getAuditValues(false);</span>
<span class="pc bpc" id="L849" title="1 of 4 branches missed.">            if (auditValues != null &amp;&amp; auditValues.size() &gt; 0) {</span>
<span class="fc bfc" id="L850" title="All 2 branches covered.">                for (Map.Entry&lt;String, String[]&gt; entry : auditValues.entrySet()) {</span>
<span class="fc" id="L851">                    String key = entry.getKey();</span>
<span class="fc" id="L852">                    String[] values = entry.getValue();</span>
<span class="pc bpc" id="L853" title="2 of 4 branches missed.">                    if (values != null &amp;&amp; values.length &gt; 0) {</span>
<span class="pc bpc" id="L854" title="1 of 2 branches missed.">                        if (log.length() &gt; 0) log.append(&quot;\n&quot;);</span>
<span class="fc" id="L855">                        log.append(key).append(&quot;: &quot;);</span>
<span class="fc bfc" id="L856" title="All 2 branches covered.">                        for (int i = 0; i &lt; values.length; i++) {</span>
<span class="pc bpc" id="L857" title="1 of 2 branches missed.">                            if (i &gt; 0) log.append(&quot;, &quot;);</span>
<span class="fc" id="L858">                            log.append(values[i]);</span>
                        }
                    }
<span class="fc" id="L861">                }</span>
<span class="pc bpc" id="L862" title="1 of 2 branches missed.">				if (log.length() &gt; 0) {</span>
<span class="fc" id="L863">					log.insert(0, '\n');</span>
<span class="fc" id="L864">					log.append(&quot;\n&quot;);</span>
				}

<span class="fc" id="L867">                auditValues.clear();</span>
            }
        }
<span class="fc" id="L870">		return log.toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>