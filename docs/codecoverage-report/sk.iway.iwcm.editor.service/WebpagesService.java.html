<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebpagesService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.editor.service</a> &gt; <span class="el_source">WebpagesService.java</span></div><h1>WebpagesService.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.editor.service;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.stream.Collectors;

import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.springframework.data.domain.Page;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;

import sk.iway.iwcm.Adminlog;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DB;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.InitServlet;
import sk.iway.iwcm.LabelValueDetails;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.RequestBean;
import sk.iway.iwcm.SetCharacterEncodingFilter;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.admin.jstree.JsTreeItem;
import sk.iway.iwcm.admin.layout.LayoutService;
import sk.iway.iwcm.admin.settings.AdminSettingsService;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.common.UserTools;
import sk.iway.iwcm.components.abtesting.ABTesting;
import sk.iway.iwcm.components.blog.rest.BlogService;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.doc.DocBasic;
import sk.iway.iwcm.doc.DocDB;
import sk.iway.iwcm.doc.DocDetails;
import sk.iway.iwcm.doc.DocEditorFields;
import sk.iway.iwcm.doc.GroupDetails;
import sk.iway.iwcm.doc.GroupEditorField;
import sk.iway.iwcm.doc.GroupsDB;
import sk.iway.iwcm.doc.GroupsTreeService;
import sk.iway.iwcm.doc.PerexGroupBean;
import sk.iway.iwcm.doc.TemplateDetails;
import sk.iway.iwcm.doc.TemplatesDB;
import sk.iway.iwcm.editor.EditorDB;
import sk.iway.iwcm.editor.EditorForm;
import sk.iway.iwcm.editor.rest.GetAllItemsDocOptions;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.system.datatable.DatatablePageImpl;
import sk.iway.iwcm.system.datatable.DatatableRestControllerV2;
import sk.iway.iwcm.system.datatable.ProcessItemAction;
import sk.iway.iwcm.system.datatable.SpecSearch;
import sk.iway.iwcm.system.datatable.json.LabelValue;
import sk.iway.iwcm.system.jpa.JpaTools;
import sk.iway.iwcm.users.UserDetails;
import sk.iway.iwcm.users.UserGroupDetails;
import sk.iway.iwcm.users.UserGroupsDB;
import sk.iway.iwcm.users.UsersDB;

/**
 * Priprava zoznamu web stranok a pridruzenych ciselnikov pre DT.
 * Servis je potrebne konstruovat so zadanym group_id, podla neho sa nasledne vracaju data.
 */
public class WebpagesService {

    private int groupId;
    private Prop prop;
	private GroupDetails localSystemGroup;

	public static final String DATA_NOT_LOADED = &quot;data not loaded&quot;;

<span class="nc" id="L81">	public WebpagesService() {</span>
<span class="nc" id="L82">	}</span>

<span class="fc" id="L84">    public WebpagesService(int groupId, Identity user, Prop prop, HttpServletRequest request) {</span>
<span class="fc" id="L85">        this.groupId = groupId;</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">		if (groupId&lt;1) {</span>
			//musime vydedukovat korenovy adresar
			//zoznam web stranok v korenovom/prvom adresari v zozname
<span class="fc" id="L89">			int rootGroupId = Constants.getInt(&quot;rootGroupId&quot;);</span>
			//ziskaj zoznam root adresarov
<span class="fc" id="L91">			GroupsTreeService groupsTreeService = new GroupsTreeService();</span>
<span class="fc" id="L92">			List&lt;JsTreeItem&gt; rootGroups = groupsTreeService.getItems(user, 0, false, &quot;dt-tree-group-filter-system-trash&quot;, null, request);</span>
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">			if (rootGroups.isEmpty()==false) {</span>
<span class="fc" id="L94">				rootGroupId = Tools.getIntValue(rootGroups.get(0).getId(), rootGroupId);</span>
			}
<span class="fc" id="L96">			this.groupId = rootGroupId;</span>
		}
<span class="fc" id="L98">		this.prop = prop;</span>
<span class="fc" id="L99">    }</span>

	/**
	 * Ponecha v zozname len adresare z aktualne nastavenej domeny
	 * @param groups
	 * @return
	 */
	public static List&lt;GroupDetails&gt; filterGroupsByCurrentDomain(List&lt;GroupDetails&gt; groups) {
<span class="fc" id="L107">		List&lt;GroupDetails&gt; filtered = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L108">		RequestBean rb = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="fc" id="L109">		String currentDomain = null;</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">		if (rb != null) currentDomain = rb.getDomain();</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">		if (currentDomain == null) currentDomain = &quot;&quot;;</span>

<span class="fc" id="L113">		boolean hasLocalSystem = false;</span>
<span class="fc" id="L114">		GroupDetails globalSystem = null;</span>

<span class="fc bfc" id="L116" title="All 2 branches covered.">		for (GroupDetails group : groups) {</span>
<span class="fc bfc" id="L117" title="All 4 branches covered.">			if (Tools.isEmpty(group.getDomainName()) || currentDomain.equals(group.getDomainName())) {</span>

<span class="fc bfc" id="L119" title="All 4 branches covered.">				if (&quot;System&quot;.equals(group.getGroupName()) &amp;&amp; group.getParentGroupId()&lt;1) {</span>
					//globalny system adresar ma typicky prazdne domenove meno, ak existuje lokalny system nechceme ten globalny mat v zozname
<span class="fc bfc" id="L121" title="All 2 branches covered.">					if (Tools.isEmpty(group.getDomainName())) {</span>
<span class="fc" id="L122">						globalSystem = group;</span>
<span class="fc" id="L123">						continue;</span>
					}
<span class="fc" id="L125">					else hasLocalSystem = true;</span>
				}

<span class="fc" id="L128">				filtered.add(group);</span>
			}
<span class="fc" id="L130">		}</span>

<span class="pc bpc" id="L132" title="1 of 4 branches missed.">		if (hasLocalSystem==false &amp;&amp; globalSystem!=null) filtered.add(globalSystem);</span>

<span class="fc" id="L134">		return filtered;</span>
	}

	/**
	 * Vrati zoznam dostupnych sablon
	 * @param recursive - ak je true vratia sa aj sablony z podadresarov
	 * @return
	 */
    public List&lt;TemplateDetails&gt; getTemplates(boolean recursive) {

<span class="fc" id="L144">		List&lt;TemplateDetails&gt; allTemplates = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L145">		allTemplates.addAll(getTemplates(-1, recursive));</span>
<span class="fc" id="L146">		List&lt;TemplateDetails&gt; templates = TemplatesDB.filterDeviceTemplates(allTemplates);</span>

<span class="fc" id="L148">        return templates;</span>
	}

	/**
	 * Vrati fiktivny korenovy adresar, je potrebny pre zobrazenie v stromovej strukture
	 * v editore ked je mozne vybrat aj korenovy adresar
	 * @return
	 */
	public static GroupDetails getRootGroup() {
<span class="fc" id="L157">		GroupEditorField groupEditorField = new GroupEditorField();</span>

		//Set root parent group details into group editor field
<span class="fc" id="L160">		groupEditorField.setParentGroupDetails(null);</span>

		// Create default root group and set editorFileds
<span class="fc" id="L163">		GroupDetails groupDetails = new GroupDetails();</span>
<span class="fc" id="L164">		groupDetails.setGroupId(0);</span>
<span class="fc" id="L165">		Prop prop = Prop.getInstance();</span>
<span class="fc" id="L166">		groupDetails.setGroupName(prop.getText(&quot;stat_settings.group_id&quot;));</span>
<span class="fc" id="L167">		groupDetails.setFullPath(&quot;/&quot;);</span>
<span class="fc" id="L168">		groupDetails.setEditorFields(groupEditorField);</span>

<span class="fc" id="L170">		return groupDetails;</span>
	}

	/**
	 * Vrati GroupDetails objekt podla zadaneho groupId
	 * @param groupId
	 * @return
	 */
	public static GroupDetails getGroup(int groupId) {
<span class="fc bfc" id="L179" title="All 2 branches covered.">		if (groupId == 0) {</span>
<span class="fc" id="L180">			return getRootGroup();</span>
		} else {
<span class="fc" id="L182">			return GroupsDB.getInstance().getGroup(groupId);</span>
		}
	}

	/**
	 * Vrati DocDetails z cache (BasicDoc), je mozne zadat aj -1 pre vratenie cisteho dokumentu
	 * @param docId
	 * @return
	 */
	public static DocDetails getBasicDoc(int docId) {
		DocDetails doc;
<span class="fc bfc" id="L193" title="All 2 branches covered.">		if (docId &lt; 1) {</span>
<span class="fc" id="L194">			doc = new DocDetails();</span>
<span class="fc" id="L195">            doc.setDocId(0);</span>
<span class="fc" id="L196">            doc.setEditorFields(null);</span>
<span class="fc" id="L197">            doc.setTitle(Prop.getInstance().getText(&quot;editor.json.pathNotSet&quot;));</span>
		} else {
<span class="fc" id="L199">			doc = DocDB.getInstance().getBasicDocDetails(docId, true);</span>
		}
<span class="fc" id="L201">		return doc;</span>
	}

	/**
	 * Vrati zoznam hlaviciek pre zobrazenie v DT/e
	 * @param addFromTemplateAndEmptyToSelect
	 * @return
	 */
    public List&lt;DocDetails&gt; getHeaderList(boolean addFromTemplateAndEmptyToSelect) {
		List&lt;DocDetails&gt; docs;
<span class="fc" id="L211">		GroupDetails localSystem = getLocalSystemGroup();</span>
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">		if (localSystem != null){</span>
<span class="fc" id="L213">			docs = getBasicDocDetailsByGroupRecursive(localSystem.getGroupId(), true);</span>
		} else {
<span class="nc" id="L215">			docs = DocDB.getInstance().getDocByGroup(Constants.getInt(&quot;headerFooterGroupId&quot;));</span>
		}
<span class="fc bfc" id="L217" title="All 2 branches covered.">		if (addFromTemplateAndEmptyToSelect) return addFromTemlateAndEmptyDoc(docs);</span>
<span class="fc" id="L218">		return docs;</span>
    }

	/**
	 * Vrati zoznam menu pre zobrazenie v DT/e
	 * @param addFromTemplateAndEmptyToSelect
	 * @return
	 */
    public List&lt;DocDetails&gt; getMenuList(boolean addFromTemplateAndEmptyToSelect) {
		List&lt;DocDetails&gt; docs;
<span class="fc" id="L228">		GroupDetails localSystem = getLocalSystemGroup();</span>
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">		if (localSystem != null){</span>
<span class="fc" id="L230">			docs = getBasicDocDetailsByGroupRecursive(localSystem.getGroupId(), true);</span>
		} else {
<span class="nc" id="L232">			docs = DocDB.getInstance().getDocByGroup(Constants.getInt(&quot;menuGroupId&quot;));</span>
		}
<span class="fc bfc" id="L234" title="All 2 branches covered.">		if (addFromTemplateAndEmptyToSelect) return addFromTemlateAndEmptyDoc(docs);</span>
<span class="fc" id="L235">		return docs;</span>
	}

	/**
	 * Vrati zoznam hlaviciek/paticiek pre zobrazenie v DT/e
	 * @param addFromTemplateAndEmptyToSelect
	 * @return
	 */
	public List&lt;DocDetails&gt; getHeaderFooterMenuList(boolean addFromTemplateAndEmptyToSelect) {
		List&lt;DocDetails&gt; docs;
<span class="fc" id="L245">		GroupDetails localSystem = getLocalSystemGroup();</span>
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">		if (localSystem != null){</span>
<span class="fc" id="L247">			docs = getBasicDocDetailsByGroupRecursive(localSystem.getGroupId(), true);</span>
		} else {
<span class="nc" id="L249">			DocDB docDB = DocDB.getInstance();</span>
<span class="nc" id="L250">			docs = docDB.getDocByGroup(Constants.getInt(&quot;headerFooterGroupId&quot;));</span>
<span class="nc" id="L251">			docs.addAll(docDB.getDocByGroup(Constants.getInt(&quot;menuGroupId&quot;)));</span>
		}
<span class="fc bfc" id="L253" title="All 2 branches covered.">		if (addFromTemplateAndEmptyToSelect) return addFromTemlateAndEmptyDoc(docs);</span>
<span class="fc" id="L254">		return docs;</span>
	}

	private List&lt;DocDetails&gt; addFromTemlateAndEmptyDoc(List&lt;DocDetails&gt; list)
	{
<span class="fc" id="L259">		addEmptyDoc(list, -2);</span>
<span class="fc" id="L260">		addFromTemlateDoc(list);</span>
<span class="fc" id="L261">		return list;</span>
	}

	/**
	 * Do zoznamu DocDetails objektov prida na prvu poziciu fiktivny DocDetails
	 * s hodnotou &quot;Zo sablony&quot; a id -2
	 * @param list
	 * @return
	 */
    public List&lt;DocDetails&gt; addFromTemlateDoc(List&lt;DocDetails&gt; list)
	{
<span class="fc" id="L272">		DocDetails fromTemplate = new DocDetails();</span>
<span class="fc" id="L273">		fromTemplate.setDocId(-1);</span>
<span class="fc" id="L274">        fromTemplate.setTitle(prop.getText(&quot;editor.fromTemplate&quot;));</span>

<span class="fc" id="L276">		list.add(0, fromTemplate);</span>

<span class="fc" id="L278">		return list;</span>
    }

	/**
	 * Do zoznamu DocDetails objektov prida na prvu poziciu fiktivny DocDetails
	 * s hodnotou &quot;Ziadna&quot; a zadanym emptyDocId
	 * @param list
	 * @param emptyDocId - ID prazdneho dokumentu
	 * @return
	 */
	public List&lt;DocDetails&gt; addEmptyDoc(List&lt;DocDetails&gt; list, int emptyDocId)
	{
<span class="fc" id="L290">		DocDetails empty = new DocDetails();</span>
<span class="fc" id="L291">		empty.setDocId(emptyDocId);</span>
<span class="fc" id="L292">		empty.setTitle(prop.getText(&quot;editor.empyDoc&quot;));</span>

<span class="fc" id="L294">		list.add(0, empty);</span>

<span class="fc" id="L296">		return list;</span>
	}

	/**
	 * Ziska zoznam stranok z lokalneho system adresara vratane jeho podadresarov (PRVEJ UROVNE)
	 * @param groupId
	 * @param titleIncludePath - ak je true, bude vrateny objekt kopia povodneho a title bude upravene tak, ze obsahuje cestu (pre ciselniky)
	 * @return
	 */
	public static List&lt;DocDetails&gt; getBasicDocDetailsByGroupRecursive(int groupId, boolean titleIncludePath) {
<span class="fc" id="L306">		DocDB docDB = DocDB.getInstance();</span>
<span class="fc" id="L307">		List&lt;DocDetails&gt; localDocsInGroup = filterUnavailableDocs(docDB.getBasicDocDetailsByGroup(groupId, -1));</span>
<span class="fc" id="L308">		List&lt;GroupDetails&gt; subGroups = GroupsDB.getInstance().getGroups(groupId);</span>
<span class="fc" id="L309">		Prop propSystem = Prop.getInstance(Constants.getString(&quot;defaultLanguage&quot;));</span>
<span class="fc" id="L310">        String trashDirName = propSystem.getText(&quot;config.trash_dir&quot;);</span>
<span class="fc bfc" id="L311" title="All 2 branches covered.">		for (GroupDetails subGroup : subGroups) {</span>
			//trash preskakujeme
<span class="pc bpc" id="L313" title="1 of 2 branches missed.">			if (trashDirName.equals(subGroup.getGroupName())) continue;</span>

<span class="fc" id="L315">			List&lt;DocDetails&gt; subDocs = docDB.getBasicDocDetailsByGroup(subGroup.getGroupId(), -1);</span>
<span class="fc bfc" id="L316" title="All 2 branches covered.">			for (DocDetails subDoc : subDocs) {</span>
<span class="fc bfc" id="L317" title="All 2 branches covered.">				if (subDoc.isAvailable()==false) continue;</span>

<span class="fc bfc" id="L319" title="All 2 branches covered.">				if (titleIncludePath) {</span>
					//upravime meno, aby obsahovalo aj meno adresara, aby bolo zrejme od kial pochadza
<span class="fc" id="L321">					DocDetails menuDoc = new DocDetails();</span>
<span class="fc" id="L322">					menuDoc.setDocId(subDoc.getDocId());</span>
<span class="fc" id="L323">					menuDoc.setTitle(subGroup.getGroupName()+&quot;/&quot;+subDoc.getTitle());</span>
<span class="fc" id="L324">					localDocsInGroup.add(menuDoc);</span>
<span class="fc" id="L325">				} else {</span>
<span class="fc" id="L326">					localDocsInGroup.add(subDoc);</span>
				}
<span class="fc" id="L328">			}</span>
<span class="fc" id="L329">		}</span>
<span class="fc" id="L330">		return localDocsInGroup;</span>
	}

	/**
	 * Vrati lokalny /System adresar
	 * @return
	 */
    private GroupDetails getLocalSystemGroup() {
<span class="pc bpc" id="L338" title="1 of 4 branches missed.">		if (localSystemGroup == null &amp;&amp; Constants.getBoolean(&quot;templatesUseDomainLocalSystemFolder&quot;)) {</span>
<span class="fc" id="L339">			localSystemGroup = GroupsDB.getInstance().getLocalSystemGroup();</span>
		}

<span class="fc" id="L342">		return localSystemGroup;</span>
	}

	/**
	 * Vrati nastaveny GroupDetails objekt
	 * @return
	 */
	public GroupDetails getGroup() {
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">		if (groupId &gt; 0) {</span>
<span class="fc" id="L351">			return GroupsDB.getInstance().getGroup(groupId);</span>
		}

<span class="nc" id="L354">		return null;</span>
	}

	/**
	 * Vrati ciselnik pre moznost interny adresar
	 * @return
	 */
	public List&lt;LabelValueDetails&gt; getOptionsInternal() {
<span class="fc" id="L362">		List&lt;LabelValueDetails&gt; list = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L363">		list.add(new LabelValueDetails(prop.getText(&quot;editor.available-public&quot;), &quot;false&quot;));</span>
<span class="fc" id="L364">		list.add(new LabelValueDetails(prop.getText(&quot;editor.notavailable-notpublic&quot;), &quot;true&quot;));</span>
<span class="fc" id="L365">		return list;</span>
	}

	/**
	 * Vrati ciselnik pre zoznam sablon
	 */
	public List&lt;LabelValueDetails&gt; getOptionsTemplates(UserDetails currentUser, GroupDetails group) {
<span class="fc" id="L372">		TemplatesDB templatesDB = TemplatesDB.getInstance();</span>
		List&lt;TemplateDetails&gt; allTemps;
<span class="pc bpc" id="L374" title="1 of 2 branches missed.">		if (group != null) allTemps = templatesDB.getTemplates(group.getGroupId(), group.getTempId());</span>
<span class="nc" id="L375">		else allTemps = templatesDB.getTemplatesSaved();</span>

<span class="fc" id="L377">		List&lt;TemplateDetails&gt; templateDetailsList = TemplatesDB.filterTemplatesByUser(currentUser, allTemps);</span>
<span class="fc" id="L378">		List&lt;LabelValueDetails&gt; templateNames = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L380">		templateDetailsList.forEach(templateDetails -&gt;</span>
<span class="fc" id="L381">			templateNames.add(new LabelValueDetails(templateDetails.getTempName(), String.valueOf(templateDetails.getTempId())))</span>
		);

<span class="fc" id="L384">		return templateNames;</span>
	}

	/**
	 * Vrati ciselnik pre vyber jazyka
	 */
	public List&lt;LabelValueDetails&gt; getOptionsLanguages(HttpServletRequest request) {
<span class="fc" id="L391">		LayoutService ls = new LayoutService(request);</span>
<span class="fc" id="L392">		List&lt;LabelValueDetails&gt; incompleteLanguages = ls.getLanguages(false, true);</span>
<span class="fc" id="L393">		List&lt;LabelValueDetails&gt; finalLanguages = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L395">		finalLanguages.add(new LabelValueDetails(prop.getText(&quot;groupedit.lng.default&quot;), &quot;&quot;));</span>
<span class="fc" id="L396">		finalLanguages.addAll(incompleteLanguages);</span>

<span class="fc" id="L398">		return finalLanguages;</span>
	}

	/**
	 * Vrati ciselnik pre vyber novej stranky
	 * @return
	 */
	public List&lt;LabelValueDetails&gt; getOptionsNewPageHTMLCode() {
<span class="fc" id="L406">		List&lt;LabelValueDetails&gt; list = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L407">		list.add(new LabelValueDetails(prop.getText(&quot;groupedit.new_page_template.empty&quot;), &quot;-1&quot;));</span>
<span class="fc" id="L408">		DocDB docDB = DocDB.getInstance();</span>
<span class="fc" id="L409">		List&lt;DocDetails&gt; pageTemps = docDB.getDocByGroup(Constants.getInt(&quot;tempGroupId&quot;));</span>
<span class="fc bfc" id="L410" title="All 2 branches covered.">		for (DocDetails pageTemp : pageTemps) {</span>
<span class="fc" id="L411">			list.add(new LabelValueDetails(pageTemp.getTitle(), String.valueOf(pageTemp.getDocId())));</span>
<span class="fc" id="L412">		}</span>
<span class="fc" id="L413">		return list;</span>
	}

	/**
	 * Vrati ciselnik pre moznosti navigacnej listy
	 * @param isLogged
	 * @return
	 */
	public List&lt;LabelValueDetails&gt; getOptionsNavbar(boolean isLogged) {
<span class="fc" id="L422">		List&lt;LabelValueDetails&gt; list = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L423" title="All 2 branches covered.">		if (isLogged) list.add(new LabelValueDetails(prop.getText(&quot;groupedit.menu_type_same_as_normal&quot;), &quot;null&quot;));</span>
<span class="fc" id="L424">		else list.add(new LabelValueDetails(prop.getText(&quot;editor.navbar.same_as_menu&quot;), &quot;null&quot;));</span>

<span class="fc" id="L426">		list.add(new LabelValueDetails(prop.getText(&quot;groupedit.menu_type_onlydefault&quot;), String.valueOf(GroupDetails.MENU_TYPE_ONLYDEFAULT)));</span>
<span class="fc" id="L427">		list.add(new LabelValueDetails(prop.getText(&quot;groupedit.menu_type_hidden&quot;), String.valueOf(GroupDetails.MENU_TYPE_HIDDEN)));</span>
		//list.add(new LabelValueDetails(prop.getText(&quot;groupedit.menu_type_nosub&quot;), String.valueOf(GroupDetails.MENU_TYPE_NOSUB)));
		//list.add(new LabelValueDetails(prop.getText(&quot;groupedit.menu_type_normal&quot;), String.valueOf(GroupDetails.MENU_TYPE_NORMAL)));
<span class="fc" id="L430">		return list;</span>
	}

	/**
	 * Vrati ciselnik pre moznost mapy stranok
	 * @param isLogged
	 * @return
	 */
	public List&lt;LabelValueDetails&gt; getOptionsSitemap(boolean isLogged) {
<span class="fc" id="L439">		List&lt;LabelValueDetails&gt; list = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L440" title="All 2 branches covered.">		if (isLogged) list.add(new LabelValueDetails(prop.getText(&quot;groupedit.menu_type_same_as_normal&quot;), &quot;null&quot;));</span>
<span class="fc" id="L441">		else list.add(new LabelValueDetails(prop.getText(&quot;editor.navbar.same_as_menu&quot;), &quot;null&quot;));</span>

<span class="fc" id="L443">		list.add(new LabelValueDetails(prop.getText(&quot;groupedit.menu_type_onlydefault&quot;), String.valueOf(GroupDetails.MENU_TYPE_ONLYDEFAULT)));</span>
<span class="fc" id="L444">		list.add(new LabelValueDetails(prop.getText(&quot;groupedit.menu_type_hidden&quot;), String.valueOf(GroupDetails.MENU_TYPE_HIDDEN)));</span>
<span class="fc" id="L445">		list.add(new LabelValueDetails(prop.getText(&quot;groupedit.menu_type_nosub&quot;), String.valueOf(GroupDetails.MENU_TYPE_NOSUB)));</span>
<span class="fc" id="L446">		list.add(new LabelValueDetails(prop.getText(&quot;groupedit.menu_type_normal&quot;), String.valueOf(GroupDetails.MENU_TYPE_NORMAL)));</span>
<span class="fc" id="L447">		return list;</span>
	}

	/**
	 * Vrati ciselnik pre sposob zobrazenia v menu
	 * @param isLogged
	 * @return
	 */
	public List&lt;LabelValueDetails&gt; getMenuType(boolean isLogged) {
<span class="fc" id="L456">		List&lt;LabelValueDetails&gt; list = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L457" title="All 2 branches covered.">		if (isLogged) list.add(new LabelValueDetails(prop.getText(&quot;groupedit.menu_type_same_as_normal&quot;), &quot;-1&quot;));</span>
<span class="fc" id="L458">		list.add(new LabelValueDetails(prop.getText(&quot;groupedit.menu_type_onlydefault&quot;), String.valueOf(GroupDetails.MENU_TYPE_ONLYDEFAULT)));</span>
<span class="fc" id="L459">		list.add(new LabelValueDetails(prop.getText(&quot;groupedit.menu_type_hidden&quot;), String.valueOf(GroupDetails.MENU_TYPE_HIDDEN)));</span>
<span class="fc" id="L460">		list.add(new LabelValueDetails(prop.getText(&quot;groupedit.menu_type_nosub&quot;), String.valueOf(GroupDetails.MENU_TYPE_NOSUB)));</span>
<span class="fc" id="L461">		list.add(new LabelValueDetails(prop.getText(&quot;groupedit.menu_type_normal&quot;), String.valueOf(GroupDetails.MENU_TYPE_NORMAL)));</span>
<span class="fc" id="L462">		return list;</span>
	}

	/**
	 * Vrati zoznam PerexGroupBean objektov
	 * @param recursive - ak je nastavene na true vrati aj PerexGroupBean z podadresarov
	 * @return
	 */
	public List&lt;PerexGroupBean&gt; getPerexGroups(boolean recursive) {
<span class="fc" id="L471">		List&lt;PerexGroupBean&gt; perexGroups = DocDB.getInstance().getPerexGroups(groupId, recursive);</span>
<span class="fc" id="L472">		return perexGroups;</span>
	}

	/**
	 * Pri zmene atributu nastavi jeho hodnotu do databazy dynamickym SQL prikazom
	 * @param groupId - ID adresara
	 * @param attributeName - meno DB stlpca
	 * @param attributeValue - hodnota
	 */
	public void  setAttributeToSubgroups(int groupId, String attributeName, Object attributeValue){
<span class="fc" id="L482">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="fc" id="L483">        Connection db_conn = DBPool.getConnection();</span>
<span class="fc" id="L484">        PreparedStatement ps = null;</span>
<span class="fc" id="L485">        String groupIds = groupsDB.getSubgroupsIds(groupId);</span>

<span class="fc" id="L487">        Adminlog.add(Adminlog.TYPE_GROUP, &quot;Force &quot;+DB.removeSlashes(attributeName)+&quot; to subgroups: &quot; + groupIds + &quot; value=&quot; + attributeValue, groupId, -1);</span>

        try {
<span class="fc" id="L490">			ps = db_conn.prepareStatement(&quot;UPDATE groups SET &quot; + DB.removeSlashes(attributeName) + &quot;=? WHERE group_id IN (&quot; + groupIds + &quot;)&quot;);</span>

<span class="fc bfc" id="L492" title="All 2 branches covered.">			if (attributeValue instanceof String) ps.setString(1, (String)attributeValue);</span>
<span class="fc bfc" id="L493" title="All 2 branches covered.">			else if (attributeValue instanceof Integer) ps.setInt(1, ((Integer)attributeValue).intValue());</span>
<span class="fc bfc" id="L494" title="All 2 branches covered.">			else if (attributeValue instanceof Boolean) ps.setBoolean(1, ((Boolean)attributeValue).booleanValue());</span>
<span class="fc" id="L495">			else ps.setObject(1, attributeValue);</span>

<span class="fc" id="L497">            ps.execute();</span>
<span class="nc" id="L498">        } catch (Exception ex) {</span>
<span class="nc" id="L499">            Logger.error(WebpagesService.class, ex);</span>
        } finally {
            try {
<span class="pc bpc" id="L502" title="1 of 2 branches missed.">                if (ps != null)</span>
<span class="fc" id="L503">                    ps.close();</span>
<span class="pc bpc" id="L504" title="1 of 2 branches missed.">                if (db_conn != null)</span>
<span class="fc" id="L505">                    db_conn.close();</span>
<span class="nc" id="L506">            } catch (Exception ex) {</span>
<span class="nc" id="L507">                Logger.error(WebpagesService.class, ex);</span>
<span class="fc" id="L508">            }</span>
		  }

		  //mame zmeny je najlepsie refreshnut celu GroupsDB
<span class="fc" id="L512">		  GroupsDB.getInstance(true);</span>
<span class="fc" id="L513">    }</span>

	/**
	 * Pregeneruje URL adresy stranok v zadanom adresari
	 * @param rootGroupId
	 * @param user
	 * @param request
	 * @param onlyChangeUrlInheritGroup //Default false, ak je true bude vykonane pregenerovanie iba pre tie kt. maju urlInheritGroup = true
	 */
	public static void regenerateUrl(int rootGroupId, Identity user, HttpServletRequest request, boolean onlyChangeUrlInheritGroup)
	{
		//ziskaj zoznam stranok v adresari
<span class="fc" id="L525">		List&lt;DocDetails&gt; docs = DocDB.getInstance().getDocByGroup(rootGroupId);</span>
		EditorForm ef;
<span class="fc bfc" id="L527" title="All 2 branches covered.">		for (DocDetails doc : docs)</span>
		{

<span class="pc bpc" id="L530" title="1 of 2 branches missed.">			if(onlyChangeUrlInheritGroup) {</span>
				//Ak ma doc urlInheritGroup != true preskoc tento doc a nepregeneruj url
<span class="fc bfc" id="L532" title="All 4 branches covered.">				if(Boolean.TRUE.equals(doc.getUrlInheritGroup())==false &amp;&amp; Boolean.TRUE.equals(doc.getGenerateUrlFromTitle())==false) {</span>
<span class="fc" id="L533">					continue;</span>
				}
			}

<span class="fc" id="L537">			ef = EditorDB.getEditorForm(request, doc.getDocId(), -1, rootGroupId);</span>
			//out.println(&quot;&lt;strong&gt;&quot;+ef.getTitle()+&quot;&lt;/strong&gt; [docid:&quot;+ef.getDocId()+&quot;] - &quot;+ef.getVirtualPath());

<span class="pc bpc" id="L540" title="1 of 2 branches missed.">			if (ef.getVirtualPath().contains(&quot;*&quot;))</span>
			{
				//out.println(&quot; skipping (contains *)&lt;br/&gt;&quot;);
<span class="nc" id="L543">				continue;</span>
			}

<span class="fc" id="L546">			ef.setVirtualPath(&quot;&quot;);</span>

<span class="fc bfc" id="L548" title="All 2 branches covered.">			if (Boolean.TRUE.equals(doc.getUrlInheritGroup())) ef.setVirtualPath(doc.getEditorVirtualPath());</span>

			//nastav aktualneho usera
<span class="fc" id="L551">			ef.setAuthorId(user.getUserId());</span>
<span class="fc" id="L552">			ef.setPublish(&quot;1&quot;);</span>

<span class="fc" id="L554">			EditorDB.saveEditorForm(ef, request);</span>

			//out.println(&quot; -&gt; &quot; + ef.getVirtualPath()+&quot;&lt;br&gt;&quot;);

<span class="fc" id="L558">			EditorDB.cleanSessionData(request);</span>

			//out.flush();
<span class="fc" id="L561">		}</span>

		//out.flush();

		//rekurzivne sa zavolaj na podadresare
<span class="fc" id="L566">		List&lt;GroupDetails&gt; subGroups = GroupsDB.getInstance().getGroups(rootGroupId);</span>
<span class="pc bpc" id="L567" title="1 of 2 branches missed.">		for (GroupDetails group : subGroups)</span>
		{
<span class="nc" id="L569">			regenerateUrl(group.getGroupId(), user, request, onlyChangeUrlInheritGroup);</span>
<span class="nc" id="L570">		}</span>
		//out.flush();
<span class="fc" id="L572">	}</span>

	/**
	 * Zo zoznamu DocDetails odstrani objekty, ktore nie su dostupne na zobrazenie (available=false)
	 * @param original
	 * @return
	 */
	private static List&lt;DocDetails&gt; filterUnavailableDocs(List&lt;DocDetails&gt; original) {
<span class="fc" id="L580">		List&lt;DocDetails&gt; filtered = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L581" title="All 2 branches covered.">		for (DocDetails doc : original) {</span>
<span class="pc bpc" id="L582" title="1 of 2 branches missed.">			if (doc.isAvailable()==false) continue;</span>
<span class="fc" id="L583">			filtered.add(doc);</span>
<span class="fc" id="L584">		}</span>
<span class="fc" id="L585">		return filtered;</span>
	}

	/**
	 * Return list of groups (from this domain) that use specific template.
	 * @param tempId id of template that group must use
	 * @return list of groups
	 */
	public List&lt;GroupDetails&gt; getGroupsByTemplateId(int tempId) {

<span class="nc" id="L595">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="nc" id="L596">		List&lt;GroupDetails&gt; result = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L598" title="All 2 branches missed.">		for(GroupDetails group : groupsDB.getGroupsAll()) {</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">			if(group.getTempId() == tempId)</span>
<span class="nc" id="L600">				result.add(group);</span>
<span class="nc" id="L601">		}</span>

<span class="nc" id="L603">		return filterGroupsByCurrentDomain(result);</span>
	}

	/**
	 * Vrati zoznam adresarov podla zadanej skupiny pouzivatelov
	 * @param userGroupId
	 * @return
	 */
	public List&lt;GroupDetails&gt; getGroupsByPasswordProtected(int userGroupId) {

<span class="fc" id="L613">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="fc" id="L614">		List&lt;GroupDetails&gt; result = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L616" title="All 2 branches covered.">		for(GroupDetails group : groupsDB.getGroupsAll()) {</span>

			//Its string of user_groups ids, separated by column
<span class="fc" id="L619">			String passwordProtected = group.getPasswordProtected();</span>
<span class="fc bfc" id="L620" title="All 2 branches covered.">			if (Tools.isEmpty(passwordProtected)) continue;</span>

			//Split string to get ids
<span class="fc" id="L623">			String[] idsArray = passwordProtected.split(&quot;,&quot;);</span>

			//Loop array of ids, and if id from passwordProtected if same as userGroupId push group to result list
<span class="fc bfc" id="L626" title="All 2 branches covered.">			for(int i = 0; i &lt; idsArray.length; i++) {</span>

<span class="fc bfc" id="L628" title="All 2 branches covered.">				if(Integer.parseInt(idsArray[i]) == userGroupId) {</span>
<span class="fc" id="L629">					result.add(group);</span>
				}
			}
<span class="fc" id="L632">		}</span>

<span class="fc" id="L634">		return filterGroupsByCurrentDomain(result);</span>
	}

	/**
	 * Vrati JPA podmienku pre ziskanie naposledy upravenych stranok
	 * @param userId
	 * @return
	 */
	private static Specification&lt;DocDetails&gt; getRecentPagesConditions(int userId) {
<span class="fc" id="L643">		return (Specification&lt;DocDetails&gt;) (root, query, builder) -&gt; {</span>
<span class="fc" id="L644">			final List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L646">			int domainId = CloudToolsForCore.getDomainId();</span>
<span class="fc" id="L647">			Prop propSystem = Prop.getInstance(Constants.getString(&quot;defaultLanguage&quot;));</span>
<span class="fc" id="L648">			String trashDirName = propSystem.getText(&quot;config.trash_dir&quot;);</span>

<span class="fc" id="L650">			predicates.add(builder.equal(root.get(&quot;authorId&quot;), userId));</span>
<span class="fc" id="L651">			predicates.add(builder.notLike(root.get(&quot;virtualPath&quot;), &quot;/files/%&quot;));</span>
			//toto uz nedavame, chceme zobrazit aj rozpracovane/vypnute stranky predicates.add(builder.isTrue(root.get(&quot;available&quot;)));

<span class="pc bpc" id="L654" title="1 of 2 branches missed.">			if (InitServlet.isTypeCloud()) predicates.add(builder.equal(root.get(&quot;rootGroupL1&quot;), domainId));</span>
<span class="pc bpc" id="L655" title="1 of 2 branches missed.">			else if (domainId &gt; 0) {</span>
				//ziskaj zoznam ROOT adresarov v zadanej domene
<span class="fc" id="L657">				GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="fc" id="L658">				GroupDetails domainGroup = groupsDB.getGroup(domainId);</span>
<span class="pc bpc" id="L659" title="2 of 4 branches missed.">				if (domainGroup != null &amp;&amp; Tools.isNotEmpty(domainGroup.getDomainName())) {</span>
<span class="fc" id="L660">					List&lt;GroupDetails&gt; rootGroups = groupsDB.getGroups(0);</span>
<span class="fc" id="L661">					List&lt;Integer&gt; groupIds = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L662" title="All 2 branches covered.">					for (GroupDetails rootGroup : rootGroups) {</span>
<span class="fc bfc" id="L663" title="All 2 branches covered.">						if (rootGroup.getDomainName().equalsIgnoreCase(domainGroup.getDomainName())==false) continue;</span>

<span class="fc" id="L665">						groupIds.add(rootGroup.getGroupId());</span>
<span class="fc" id="L666">					}</span>
<span class="pc bpc" id="L667" title="1 of 2 branches missed.">					if (groupIds.isEmpty()==false) {</span>
<span class="fc" id="L668">						predicates.add(root.get(&quot;rootGroupL1&quot;).in(groupIds));</span>
					}

					//Vylúč všetky kôš adresáre
<span class="fc" id="L672">					List&lt;Integer&gt; groupIdsTrash = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L673" title="All 2 branches covered.">					for (GroupDetails group : groupsDB.getGroupsAll()) {</span>
<span class="fc bfc" id="L674" title="All 2 branches covered.">						if (trashDirName.equals(group.getFullPath())==false) continue;</span>

<span class="fc" id="L676">						groupIdsTrash.add(group.getGroupId());</span>
<span class="fc" id="L677">					}</span>
<span class="pc bpc" id="L678" title="1 of 2 branches missed.">					if (groupIdsTrash.isEmpty()==false) {</span>
<span class="fc" id="L679">						predicates.add(builder.not(root.get(&quot;groupId&quot;).in(groupIdsTrash)));</span>
<span class="fc" id="L680">						predicates.add(builder.not(root.get(&quot;rootGroupL2&quot;).in(groupIdsTrash)));</span>
					}
				}
			}
			//Set order
<span class="fc" id="L685">			query.orderBy(builder.desc(root.get(&quot;dateCreated&quot;)));</span>

<span class="fc" id="L687">			return builder.and(predicates.toArray(new Predicate[predicates.size()]));</span>
		};
	}

	/**
	 * Vrati JPA podmienku pre zobrazenie podla zadaneho groupId a pripadne rekurzivneho zobrazenia
	 * @param groupId
	 * @param recursive
	 * @return
	 */
	public static List&lt;Predicate&gt; getGroupIdCondition(int groupId, boolean recursive, Root&lt;DocDetails&gt; root, CriteriaBuilder builder) {
<span class="nc" id="L698">		final List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L700" title="All 2 branches missed.">		if (recursive) {</span>
<span class="nc" id="L701">			GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="nc" id="L702">			List&lt;GroupDetails&gt; subGroups = groupsDB.getGroupsTree(groupId, true, true);</span>
<span class="nc" id="L703">			List&lt;Integer&gt; groupIds = subGroups.stream().map(GroupDetails::getGroupId).collect(Collectors.toList());</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">			if (groupIds.size()==1) {</span>
				//ak sa jedna o posledny uzol daj to ako klasicku where kvoli efektivite
<span class="nc" id="L706">				predicates.add(builder.equal(root.get(&quot;groupId&quot;), groupIds.get(0)));</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">			} else if (groupIds.isEmpty()==false) {</span>
<span class="nc" id="L708">				predicates.add(root.get(&quot;groupId&quot;).in(groupIds));</span>
			}
<span class="nc bnc" id="L710" title="All 2 branches missed.">		} else if (groupId&gt;0)  {</span>
<span class="nc" id="L711">			predicates.add(builder.equal(root.get(&quot;groupId&quot;), groupId));</span>
		}
<span class="nc" id="L713">		return predicates;</span>
	}

	/**
	 * Vykona nastavenie EditorFields atributov pred vratenim z REST rozhrania
	 * @param entity
	 * @param action
	 * @param request
	 * @return
	 */
    public static DocBasic processFromEntity(DocBasic entity, ProcessItemAction action,  HttpServletRequest request, boolean addFields) {

<span class="fc" id="L725">        int groupId = Tools.getIntValue(request.getParameter(&quot;groupId&quot;), Constants.getInt(&quot;rootGroupId&quot;));</span>

<span class="pc bpc" id="L727" title="1 of 4 branches missed.">        if (ProcessItemAction.GETONE.equals(action) &amp;&amp; entity==null) {</span>
<span class="nc" id="L728">            entity = new DocDetails();</span>
        }

<span class="pc bpc" id="L731" title="1 of 2 branches missed.">        if(entity != null) {</span>

<span class="fc bfc" id="L733" title="All 2 branches covered.">			if (ProcessItemAction.GETONE.equals(action)==false) entity.setData(DATA_NOT_LOADED);</span>

			//Get doc author
<span class="fc" id="L736">			UserDetails user = UsersDB.getUser(entity.getAuthorId());</span>
<span class="fc bfc" id="L737" title="All 2 branches covered.">			if (user != null) {</span>
<span class="fc" id="L738">				entity.setAuthorName(user.getFullName());</span>
<span class="fc" id="L739">				entity.setAuthorEmail(user.getEmail());</span>
<span class="fc" id="L740">				entity.setAuthorPhoto(user.getPhoto());</span>
			} else {
<span class="fc" id="L742">				entity.setAuthorName(&quot;&quot;);</span>
<span class="fc" id="L743">				entity.setAuthorEmail(&quot;&quot;);</span>
<span class="fc" id="L744">				entity.setAuthorPhoto(&quot;&quot;);</span>
			}

<span class="fc bfc" id="L747" title="All 2 branches covered.">			if(groupId == Constants.getInt(&quot;systemPagesRecentPages&quot;)) {</span>
				//There is no need edit for this doc's
			} else {
<span class="fc" id="L750">				boolean linkTypeHtml = false;</span>
<span class="pc bpc" id="L751" title="1 of 2 branches missed.">				if (Constants.getInt(&quot;linkType&quot;) == Constants.LINK_TYPE_HTML) {</span>
<span class="fc" id="L752">					linkTypeHtml = true;</span>
				}

<span class="pc bpc" id="L755" title="1 of 2 branches missed.">				if (linkTypeHtml) {</span>
<span class="fc" id="L756">					entity.setDocLink(entity.getVirtualPath());</span>
				}

				//toto nerobime, lebo tam ma byt skutocne hodnota z DB entity.setNavbar(groupsDB.getNavbarNoHref(entity.getGroupId()));
			}

<span class="fc" id="L762">            DocEditorFields def = entity.getEditorFields();</span>
<span class="fc bfc" id="L763" title="All 2 branches covered.">			if (def == null) def = new DocEditorFields();</span>
<span class="fc" id="L764">			boolean loadSubQueries = ProcessItemAction.GETONE.equals(action);</span>
<span class="fc" id="L765">			def.fromDocDetails(entity, loadSubQueries, addFields);</span>
<span class="fc" id="L766">			entity.setEditorFields(def);</span>
        }
<span class="fc" id="L768">        return entity;</span>
    }

	/**
	 * Vrati Templates dostupne pre dane groupId
	 */
	public List&lt;TemplateDetails&gt; getTemplates(int mustHaveTempId, boolean recursive)
	{
		//najskor potrebujeme zoznam parent skupin
<span class="fc" id="L777">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="fc" id="L778">		List&lt;GroupDetails&gt; parentGroups = groupsDB.getParentGroups(groupId);</span>

<span class="fc" id="L780">		List&lt;TemplateDetails&gt; allTemps = TemplatesDB.getInstance().getTemplates();</span>

<span class="fc" id="L782">	   Set&lt;TemplateDetails&gt; ret = new HashSet&lt;&gt; ();</span>

	   //Loop all Templates and for each one call isGroupAvailable method (method will return true if this Template is availaible)
<span class="fc bfc" id="L785" title="All 2 branches covered.">	   for (TemplateDetails temp : allTemps) {</span>

<span class="fc bfc" id="L787" title="All 2 branches covered.">		  if (temp.getTempId()&lt;1) continue;</span>

		  //List of Group Ids where temp is available
<span class="fc" id="L790">		  int[] tempAvailableGroups = temp.getAvailableGroupsInt();</span>

		  //isGroupAvailable param &quot;recursive&quot; is set for getting Templates for child (all subfolders - if recursive is true)
<span class="pc bpc" id="L793" title="2 of 8 branches missed.">		  if (tempAvailableGroups.length == 0 || groupId == -1 || temp.getTempId() == mustHaveTempId || isGroupAvailable(tempAvailableGroups, parentGroups, recursive)) {</span>
<span class="fc" id="L794">			  ret.add(temp);</span>
		  }
<span class="fc" id="L796">	   }</span>

<span class="pc bpc" id="L798" title="1 of 2 branches missed.">	   if (ret.isEmpty()) {</span>
<span class="nc" id="L799">		   ret.add(allTemps.get(0));</span>
	   }

<span class="fc" id="L802">	   List&lt;TemplateDetails&gt; sortedRet = ret.stream().sorted((e1, e2) -&gt; e1.getTempName().compareTo(e2.getTempName())).collect(Collectors.toList());</span>

<span class="fc" id="L804">	   return (new ArrayList&lt;TemplateDetails&gt;(sortedRet));</span>
	}

	/**
	 * availableGroups - array of int Ids represent in which groups is Template available
	 * groups - list of parent groups of actual selected group in jsTree
	 * recursive - True (check if Template is available not only for parent groups but also for child group (konjuction) of selected group in jsTree)
	 */
	private boolean isGroupAvailable(int[] availableGroups, List&lt;GroupDetails&gt; groups, boolean recursive)
	{
		//check availability for parent groups
<span class="fc bfc" id="L815" title="All 2 branches covered.">		for (int availableGroupId : availableGroups) {</span>
<span class="fc bfc" id="L816" title="All 2 branches covered.">			for (GroupDetails group : groups) {</span>
<span class="fc bfc" id="L817" title="All 2 branches covered.">				if (group.getGroupId() == availableGroupId) return true;</span>
<span class="fc" id="L818">			}</span>
		}

		//check availability for child groups
<span class="fc bfc" id="L822" title="All 2 branches covered.">		if(recursive) {</span>

<span class="fc" id="L824">			GroupsDB groupsDB = GroupsDB.getInstance();</span>

<span class="fc bfc" id="L826" title="All 2 branches covered.">			for (int availableGroupId : availableGroups) {</span>

<span class="fc" id="L828">				int[] tmpParentGroupIds = Tools.getTokensInt(groupsDB.getParents(availableGroupId), &quot;,&quot;);</span>

<span class="fc bfc" id="L830" title="All 2 branches covered.">				for(int tmpParentGroupId : tmpParentGroupIds) {</span>
<span class="fc bfc" id="L831" title="All 2 branches covered.">					if(tmpParentGroupId == groupId) return true;</span>
				}
			}
		}

<span class="fc" id="L836">		return false;</span>
	}

	/**
	 * Vrati zoznam web stranok podla zadanych kriterii v options objekte pre pouzitie v DT
	 * @param options
	 * @return
	 */
    public static DatatablePageImpl&lt;DocDetails&gt; getAllItems(GetAllItemsDocOptions options) {

<span class="fc" id="L846">        Page&lt;DocDetails&gt; page = null;</span>

<span class="fc" id="L848">        Prop prop = Prop.getInstance(options.getRequest());</span>
<span class="fc" id="L849">        WebpagesService ws = new WebpagesService(options.getGroupId(), options.getCurrentUser(), prop, options.getRequest());</span>

<span class="fc bfc" id="L851" title="All 2 branches covered.">		if(&quot;true&quot;.equals(options.getRequest().getParameter(&quot;isABtestingVersion&quot;)) ) {</span>
			//Check perms with combination with ABTesting version
<span class="pc bpc" id="L853" title="1 of 2 branches missed.">			if(options.getCurrentUser().isEnabledItem(&quot;cmp_abtesting&quot;)) {</span>
<span class="fc" id="L854">				Set&lt;DocDetails&gt; mainWebPages = new HashSet&lt;&gt;();</span>
<span class="fc" id="L855">				List&lt;DocDetails&gt; allBasicDoc = DocDB.getInstance().getBasicDocDetailsAll();</span>
<span class="pc bpc" id="L856" title="1 of 2 branches missed.">				if(allBasicDoc != null) {</span>
<span class="fc" id="L857">					List&lt;String&gt; allDomains = GroupsDB.getInstance().getAllDomainsList();</span>
<span class="fc" id="L858">					DocDB docDB = DocDB.getInstance();</span>
<span class="fc bfc" id="L859" title="All 2 branches covered.">					for(DocDetails dd : allBasicDoc)</span>
<span class="fc bfc" id="L860" title="All 2 branches covered.">						if(!ABTesting.getAllVariantsDocIds(dd, allDomains, docDB).isEmpty()) mainWebPages.add(dd);</span>
				}

				//Editor fields need to be nullified, or status icons will be stacking
<span class="fc bfc" id="L864" title="All 2 branches covered.">				for(DocDetails dd : mainWebPages) dd.setEditorFields(null);</span>

<span class="fc" id="L866">				page = new DatatablePageImpl&lt;&gt;(new ArrayList&lt;&gt;(mainWebPages));</span>
<span class="fc" id="L867">			} else {</span>
				//User has no right to request data in ABTesting mode
<span class="nc" id="L869">				page = new DatatablePageImpl&lt;&gt;(new ArrayList&lt;&gt;());</span>
			}
<span class="fc bfc" id="L871" title="All 2 branches covered.">		} else if(&quot;true&quot;.equals(options.getRequest().getParameter(&quot;isBlogVersion&quot;))) {</span>
			//BLOG VERSION
<span class="fc" id="L873">			List&lt;Integer&gt; allGroupIds = getBloggerDataList(options.getCurrentUser(), Tools.getIntValue(options.getRequest().getParameter(&quot;groupId&quot;), -1));</span>
<span class="pc bpc" id="L874" title="2 of 4 branches missed.">			if(allGroupIds == null || allGroupIds.isEmpty()) page = new DatatablePageImpl&lt;&gt;(new ArrayList&lt;&gt;());</span>
<span class="fc" id="L875">			else page = options.getDocDetailsRepository().findAllByGroupIdIn(allGroupIds.toArray(new Integer[0]), options.getPageable());</span>
<span class="fc bfc" id="L876" title="All 2 branches covered.">		} else if(options.getGroupId() == Constants.getInt(&quot;systemPagesRecentPages&quot;)) {</span>
<span class="fc" id="L877">			Specification&lt;DocDetails&gt; spec = WebpagesService.getRecentPagesConditions(options.getUserId());</span>
			//Combine spec (recent pages) with columnsSpecification (serch throu columns)
<span class="fc bfc" id="L879" title="All 2 branches covered.">			if(options.getColumnsSpecification() != null) {</span>
<span class="fc" id="L880">				spec = spec.and(options.getColumnsSpecification());</span>
			}
<span class="fc" id="L882">			page = ((JpaSpecificationExecutor&lt;DocDetails&gt;)options.getDocDetailsRepository()).findAll(spec, options.getPageable());</span>
<span class="fc bfc" id="L883" title="All 2 branches covered.">		} else if(options.isUserGroupIdRequested()) {</span>
            //chceme vratit stranky podla zadaneho ID skupiny pouzivatelov, pouziva sa na zoznam stranok s danou skupinou
<span class="fc" id="L885">            page = options.getDocDetailsRepository().findAllByPasswordProtectedLike(&quot;&quot;+options.getUserGroupId(), options.getUserGroupId()+&quot;,%&quot;, &quot;%,&quot;+options.getUserGroupId(), &quot;%,&quot; + options.getUserGroupId() + &quot;,%&quot;, options.getPageable());</span>
<span class="pc bpc" id="L886" title="1 of 2 branches missed.">        } else if(options.isTempIdRequested()) {</span>
			//We want to return web pages that use specific template (by tempId)
<span class="nc" id="L888">			page = options.getDocDetailsRepository().findAllByTempId(options.getTempId(), options.getPageable());</span>
<span class="fc bfc" id="L889" title="All 2 branches covered.">		} else if(&quot;true&quot;.equals(options.getRequest().getParameter(&quot;auditVersion&quot;))) {</span>
			/** We want all web pages sorted by date of change **/

<span class="fc bfc" id="L892" title="All 2 branches covered.">			if(!options.getCurrentUser().isEnabledItem(&quot;cmp_adminlog&quot;)) throw new IllegalArgumentException(&quot;Access is denied&quot;);</span>
<span class="fc" id="L893">			page = options.getDocDetailsRepository().findAllByOrderByDateCreatedDesc(options.getPageable());</span>
		} else {
<span class="fc bfc" id="L895" title="All 2 branches covered.">			if (GroupsDB.isGroupEditable(options.getCurrentUser(), options.getGroupId())) {</span>
<span class="fc" id="L896">				Map&lt;String, String&gt; params = new HashMap&lt;&gt;();</span>
<span class="pc bpc" id="L897" title="1 of 2 branches missed.">				if (options.getRequest()!=null) {</span>
<span class="fc" id="L898">					params.putAll(DatatableRestControllerV2.getParamsMap(options.getRequest()));</span>
				}
				//override groupId from options
<span class="fc" id="L901">				params.put(&quot;groupId&quot;, &quot;&quot; + options.getGroupId());</span>

				@SuppressWarnings(&quot;java:S1602&quot;)
<span class="fc" id="L904">				Specification&lt;DocDetails&gt; spec = (Specification&lt;DocDetails&gt;) (root, query, builder) -&gt; {</span>

<span class="fc" id="L906">					final List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L908">					addSpecSearch(params, predicates, root, builder, options.getCurrentUser());</span>

<span class="fc" id="L910">					return builder.and(predicates.toArray(new Predicate[predicates.size()]));</span>
				};

<span class="fc" id="L913">				page = options.getDocDetailsRepository().findAll(spec, options.getPageable());</span>
<span class="fc" id="L914">			} else {</span>
				//pridaj stranky ak ma specialne nastavene z tohto adresara
<span class="pc bpc" id="L916" title="1 of 2 branches missed.">				if (Tools.isNotEmpty(options.getCurrentUser().getEditablePages())) {</span>
<span class="fc" id="L917">					List&lt;DocDetails&gt; docs = UserTools.getEditablePages(options.getCurrentUser().getEditablePages());</span>
<span class="fc" id="L918">					List&lt;DocDetails&gt; availableDocs = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L919" title="All 2 branches covered.">            		for (DocDetails doc : docs) {</span>
<span class="fc bfc" id="L920" title="All 2 branches covered.">						if (doc.getGroupId() == options.getGroupId()) availableDocs.add(doc);</span>
<span class="fc" id="L921">					}</span>
<span class="fc bfc" id="L922" title="All 2 branches covered.">					if (availableDocs.isEmpty()==false) page = new DatatablePageImpl&lt;&gt;(availableDocs);</span>
				}
			}
		}

        DatatablePageImpl&lt;DocDetails&gt; pageImpl;

<span class="fc bfc" id="L929" title="All 2 branches covered.">		if (page != null) pageImpl = new DatatablePageImpl&lt;&gt;(page);</span>
<span class="fc" id="L930">		else pageImpl = new DatatablePageImpl&lt;&gt;(new ArrayList&lt;&gt;());</span>

<span class="fc" id="L932">        pageImpl.addOptions(&quot;tempId&quot;, ws.getTemplates(options.isRecursiveSubfolders()), &quot;tempName&quot;, &quot;tempId&quot;, true);</span>
<span class="fc" id="L933">        pageImpl.addOptions(&quot;menuDocId,rightMenuDocId&quot;, ws.getMenuList(true), &quot;title&quot;, &quot;docId&quot;, false);</span>
<span class="fc" id="L934">        pageImpl.addOptions(&quot;headerDocId,footerDocId&quot;, ws.getHeaderList(true), &quot;title&quot;, &quot;docId&quot;, false);</span>
<span class="fc" id="L935">		pageImpl.addOptions(&quot;tempFieldADocId,tempFieldBDocId,tempFieldCDocId,tempFieldDDocId&quot;, ws.getHeaderFooterMenuList(true), &quot;title&quot;, &quot;docId&quot;, false);</span>
<span class="fc" id="L936">        pageImpl.addOptions(&quot;editorFields.emails&quot;, UserGroupsDB.getInstance().getUserGroupsByTypeId(UserGroupDetails.TYPE_EMAIL), &quot;userGroupName&quot;, &quot;userGroupId&quot;, false);</span>
<span class="fc" id="L937">        pageImpl.addOptions(&quot;editorFields.permisions&quot;, UserGroupsDB.getInstance().getUserGroupsByTypeId(UserGroupDetails.TYPE_PERMS), &quot;userGroupName&quot;, &quot;userGroupId&quot;, false);</span>
<span class="fc" id="L938">        pageImpl.addOptions(&quot;perexGroups&quot;, ws.getPerexGroups(options.isRecursiveSubfolders()), &quot;perexGroupName&quot;, &quot;perexGroupId&quot;, false);</span>

		//optiony pre ikonu
<span class="fc" id="L941">		pageImpl.addOptions(&quot;editorFields.statusIcons&quot;, getStatusIconOptions(options, prop), &quot;label&quot;, &quot;value&quot;, false);</span>

		//attributes group
<span class="pc bpc" id="L944" title="1 of 2 branches missed.">		if (options.getDocAtrDefRepository()!=null) {</span>
<span class="fc" id="L945">			pageImpl.addOptions(&quot;editorFields.attrGroup&quot;, options.getDocAtrDefRepository().findDistinctGroups(CloudToolsForCore.getDomainId()) , &quot;&quot;, &quot;&quot;, false);</span>
		}

<span class="fc" id="L948">		boolean addFields = true;</span>
<span class="fc bfc" id="L949" title="All 2 branches covered.">        for (DocDetails entity : pageImpl.getContent()) {</span>
<span class="fc" id="L950">			WebpagesService.processFromEntity(entity, ProcessItemAction.GETALL, options.getRequest(), addFields);</span>
<span class="fc" id="L951">			addFields = false;</span>
<span class="fc" id="L952">		}</span>

<span class="fc" id="L954">        return pageImpl;</span>
    }

	private static List&lt;Integer&gt; getBloggerDataList(Identity currentUser, int selectedGroupId) {
<span class="fc bfc" id="L958" title="All 2 branches covered.">		if(BlogService.isUserBloggerAdmin(currentUser)) {</span>
			//It's admin with perms cmp_blog &amp;&amp; cmp_blog_admin -&gt; return all bloggers web pages
<span class="fc" id="L960">			List&lt;Integer&gt; allGroupIds = BlogService.getAllBloggersGroupIds();</span>

<span class="pc bpc" id="L962" title="1 of 2 branches missed.">			if(selectedGroupId == -1) //Docs from all bloggers groups</span>
<span class="fc" id="L963">				return allGroupIds;</span>
<span class="nc bnc" id="L964" title="All 2 branches missed.">			else if(allGroupIds.contains(selectedGroupId)) //Docs from specific blogger group</span>
<span class="nc" id="L965">				return Arrays.asList(selectedGroupId);</span>
<span class="pc bpc" id="L966" title="1 of 2 branches missed.">		} else if(BlogService.isUserBlogger( currentUser )) {</span>
			//It's blogger -&gt; return only his web pages
<span class="fc" id="L968">			int rootGroupId = Tools.getTokensInt(currentUser.getEditableGroups(), &quot;,&quot;)[0];</span>

			//Get groups tree from user editable root group
<span class="fc" id="L971">			List&lt;GroupDetails&gt; groupsTree = GroupsDB.getInstance().getGroupsTree(rootGroupId, true, true);</span>
<span class="fc" id="L972">			List&lt;Integer&gt; groupIds = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L973" title="All 2 branches covered.">			for(GroupDetails group : groupsTree) groupIds.add(group.getGroupId());</span>

<span class="fc bfc" id="L975" title="All 2 branches covered.">			if(selectedGroupId == -1)</span>
<span class="fc" id="L976">				return groupIds;</span>
<span class="pc bpc" id="L977" title="1 of 2 branches missed.">			else if(groupIds.contains(selectedGroupId))</span>
<span class="fc" id="L978">				return Arrays.asList(selectedGroupId);</span>
		}

		//User has no right or specific groupId is not from his groups tree (or not from any blogger group tree)
<span class="nc" id="L982">		return null;</span>
	}

	/**
	 * Vrati option pre DT so zoznamom stavovych ikon
	 * riesi kontrolu prav na app abtesting (ikony sa zobrazia len ak ma pouzivatel pravo)
	 * @param options
	 * @param prop
	 * @return
	 */
	private static List&lt;LabelValue&gt; getStatusIconOptions(GetAllItemsDocOptions options, Prop prop) {
<span class="fc" id="L993">		List&lt;LabelValue&gt; icons = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L995">		icons.add(new LabelValue(&quot;&lt;i class=\&quot;ti ti-star\&quot;&gt;&lt;/i&gt; &quot;+prop.getText(&quot;editor.main_site&quot;), &quot;searchDefaultPage&quot;));</span>
<span class="fc" id="L996">		icons.add(new LabelValue(&quot;&lt;i class=\&quot;ti ti-map-pin\&quot;&gt;&lt;/i&gt; &quot;+prop.getText(&quot;webpages.icons.showInMenu&quot;), &quot;showInMenu:true&quot;));</span>
<span class="fc" id="L997">		icons.add(new LabelValue(&quot;&lt;i class=\&quot;ti ti-map-pin-off\&quot;&gt;&lt;/i&gt; &quot;+prop.getText(&quot;webpages.icons.notShowInMenu&quot;), &quot;showInMenu:false&quot;));</span>
<span class="fc" id="L998">		icons.add(new LabelValue(&quot;&lt;i class=\&quot;ti ti-lock\&quot;&gt;&lt;/i&gt; &quot;+prop.getText(&quot;webpages.icons.onlyForLogged&quot;), &quot;passwordProtected:notEmpty&quot;));</span>
<span class="fc" id="L999">		icons.add(new LabelValue(&quot;&lt;span style=\&quot;color: #FF4B58\&quot;&gt;&quot;+prop.getText(&quot;webpages.icons.disabled&quot;)+&quot;&lt;/span&gt;&quot;, &quot;available:false&quot;));</span>
<span class="fc" id="L1000">		icons.add(new LabelValue(&quot;&lt;i class=\&quot;ti ti-external-link\&quot;&gt;&lt;/i&gt; &quot;+prop.getText(&quot;webpages.icons.externalLink&quot;), &quot;externalLink:notEmpty&quot;));</span>
<span class="fc" id="L1001">		icons.add(new LabelValue(&quot;&lt;i class=\&quot;ti ti-eye-off\&quot;&gt;&lt;/i&gt; &quot;+prop.getText(&quot;webpages.icons.notSearchable&quot;), &quot;searchable:false&quot;));</span>

<span class="fc bfc" id="L1003" title="All 2 branches covered.">		if (options.getCurrentUser().isEnabledItem(&quot;cmp_abtesting&quot;)) {</span>
<span class="fc" id="L1004">			icons.add(new LabelValue(&quot;&lt;i class=\&quot;ti ti-a-b\&quot;&gt;&lt;/i&gt; &quot;+prop.getText(&quot;webpages.icons.avariant&quot;), &quot;virtualPath:!%&quot;+Constants.getString(&quot;ABTestingName&quot;)+&quot;%&quot;));</span>
<span class="fc" id="L1005">			icons.add(new LabelValue(&quot;&lt;i class=\&quot;ti ti-a-b\&quot;&gt;&lt;/i&gt; &quot;+prop.getText(&quot;webpages.icons.bvariant&quot;), &quot;virtualPath:%&quot;+Constants.getString(&quot;ABTestingName&quot;)+&quot;%&quot;));</span>
		}

<span class="fc" id="L1008">		return icons;</span>
	}

	/**
	 * Vrati DocDetails (ako docDB.getBasicDocDetails) zo zadanej URL adresy
	 * Ta moze byt v tvare:
	 * http://domena.sk/adresar/stranka.html?nejakyParameter=aaa
	 * http://domena.sk/showdoc.do?docid=xxx&amp;nejakyParameter=aaa
	 * /adresar/stranka.html
	 * /showdoc.do?docid=xxx
	 * @param url
	 * @return
	 */
	public static DocDetails getBasicDocFromUrl(String url) {
<span class="fc" id="L1022">		DocDetails doc = null;</span>
		try {
<span class="fc bfc" id="L1024" title="All 2 branches covered.">			if (Tools.isNotEmpty(url)) {</span>
<span class="pc bpc" id="L1025" title="1 of 2 branches missed.">				if (url.startsWith(&quot;http&quot;)==false) {</span>
<span class="nc" id="L1026">					url = &quot;http://&quot;+CloudToolsForCore.getDomainName()+url;</span>
				}
<span class="fc" id="L1028">				DocDB docDB = DocDB.getInstance();</span>
<span class="fc" id="L1029">				int to = url.indexOf(&quot;/&quot;, 8);</span>
<span class="pc bpc" id="L1030" title="1 of 2 branches missed.">				if (to==-1) to = url.indexOf(&quot;:&quot;, 8);</span>
<span class="pc bpc" id="L1031" title="1 of 2 branches missed.">				if (to==-1) to = url.indexOf(&quot;?&quot;, 8);</span>

<span class="fc" id="L1033">				String domainName = url.substring(url.indexOf(&quot;://&quot;)+3, to);</span>
<span class="fc" id="L1034">				int portDelimiter = domainName.indexOf(&quot;:&quot;);</span>
<span class="pc bpc" id="L1035" title="1 of 2 branches missed.">				if (portDelimiter &gt; 0) domainName = domainName.substring(0, portDelimiter);</span>

<span class="fc" id="L1037">				to = url.indexOf(&quot;/&quot;, 8);</span>
<span class="fc" id="L1038">				String path = &quot;/&quot;;</span>
<span class="pc bpc" id="L1039" title="1 of 2 branches missed.">				if (to&gt;0) path = url.substring(to);</span>
<span class="fc" id="L1040">				path = Tools.replace(path, &quot;//&quot;, &quot;/&quot;);</span>

<span class="fc" id="L1042">				int docId = -1;</span>
<span class="pc bpc" id="L1043" title="1 of 2 branches missed.">				if (path.startsWith(&quot;/showdoc.do&quot;)) {</span>
<span class="nc" id="L1044">					docId = Tools.getIntValue(Tools.getParameterFromUrl(path, &quot;docid&quot;), -1);</span>
				} else {
<span class="fc" id="L1046">					String pathNoParams = path;</span>
<span class="fc" id="L1047">					int i = pathNoParams.indexOf(&quot;?&quot;);</span>
<span class="pc bpc" id="L1048" title="1 of 2 branches missed.">					if (i&gt;0) pathNoParams = pathNoParams.substring(0, i);</span>

<span class="fc" id="L1050">					docId = docDB.getDocIdFromURLImpl(pathNoParams, domainName);</span>
				}
<span class="pc bpc" id="L1052" title="1 of 2 branches missed.">				if (docId &gt; 0) {</span>
<span class="fc" id="L1053">					doc = docDB.getBasicDocDetails(docId, false);</span>
				}
			}
<span class="nc" id="L1056">		} catch (Exception e) {</span>
<span class="nc" id="L1057">			Logger.error(WebpagesService.class, e);</span>
<span class="fc" id="L1058">		}</span>
<span class="fc" id="L1059">		return doc;</span>
	}

	/**
	 * Overi, ci zadany pouzivatel ma zapnute zobrazovanie web stranok v stromovej strukture
	 * @param user
	 * @return
	 */
	public static boolean isTreeShowPages(UserDetails user) {
		//ak je zapnute zobrazenie zoznamu stranok pre novu stranku musim spravit reload
        //ostatne ako zmena adresara vyvolava reload uz standardne
<span class="fc" id="L1070">        AdminSettingsService ass = new AdminSettingsService(user);</span>
<span class="fc" id="L1071">        return ass.getJsonBooleanValue(&quot;jstreeSettings_web-pages-list&quot;, &quot;showPages&quot;);</span>
	}

	public static int getUserFirstEditableGroup(Identity user)
	{
<span class="fc" id="L1076">		int[] editableGroups = Tools.getTokensInt(user.getEditableGroups(), &quot;,&quot;);</span>
<span class="pc bpc" id="L1077" title="2 of 4 branches missed.">		if (editableGroups!=null &amp;&amp; editableGroups.length&gt;0)</span>
		{
<span class="pc bpc" id="L1079" title="1 of 2 branches missed.">			for (int groupId : editableGroups)</span>
			{
<span class="pc bpc" id="L1081" title="1 of 2 branches missed.">				if (groupId &gt; 0)</span>
				{
<span class="fc" id="L1083">					return groupId;</span>
				}
			}
		}
<span class="nc" id="L1087">		return -1;</span>
	}

	/**
	 * Vrati posledne zapamatane groupId pre daneho pouzivatela, alebo prve jeho nastavene podla prav, alebo defaultne
	 * @param user
	 * @param request
	 * @return
	 */
	public static int getUserLastGroupId(Identity user, HttpServletRequest request)
	{
<span class="nc" id="L1098">		HttpSession session = request.getSession();</span>

<span class="nc" id="L1100">		int group_id = Constants.getInt(&quot;rootGroupId&quot;);</span>

<span class="nc" id="L1102">		int groupId = getUserFirstEditableGroup(user);</span>
<span class="nc bnc" id="L1103" title="All 2 branches missed.">		if (groupId &gt; 0)</span>
		{
<span class="nc" id="L1105">			group_id = groupId;</span>
		}

		try
		{
<span class="nc bnc" id="L1110" title="All 2 branches missed.">			if (request.getParameter(&quot;groupid&quot;) != null)</span>
			{
<span class="nc" id="L1112">				group_id = Integer.parseInt(request.getParameter(&quot;groupid&quot;));</span>
			}
			else
			{
				//skus ziskat data zo session
<span class="nc bnc" id="L1117" title="All 2 branches missed.">				if (session.getAttribute(Constants.SESSION_GROUP_ID) != null)</span>
				{
<span class="nc" id="L1119">					group_id = Integer.parseInt((String) session.getAttribute(Constants.SESSION_GROUP_ID));</span>
				}

			}
		}
<span class="nc" id="L1124">		catch (Exception ex)</span>
		{

<span class="nc" id="L1127">		}</span>

<span class="nc" id="L1129">		return group_id;</span>
	}

	/**
	 * Add special conditions to search query based on request parameters
	 */
	public static void addSpecSearch(Map&lt;String, String&gt; params, List&lt;Predicate&gt; predicates, Root&lt;DocDetails&gt; root, CriteriaBuilder builder, Identity user) {

<span class="fc" id="L1137">        SpecSearch&lt;DocDetails&gt; specSearch = new SpecSearch&lt;&gt;();</span>
<span class="fc" id="L1138">        GroupsDB groupsDB = GroupsDB.getInstance();</span>

		//remove groupId predicate which was auto binded, it will be set later in this method depending on recursive attribute
<span class="fc" id="L1141">		JpaTools.removePredicateWithName(&quot;groupId&quot;, predicates);</span>

        //vyhladanie na zaklade Meno autora, hladane v DB tabulke nasledne v stlpci authorId
<span class="fc" id="L1144">        String searchAuthorName = params.get(&quot;searchAuthorName&quot;);</span>
<span class="fc bfc" id="L1145" title="All 2 branches covered.">        if (searchAuthorName != null) {</span>
<span class="fc" id="L1146">            specSearch.addSpecSearchUserFullName(searchAuthorName, &quot;authorId&quot;, predicates, root, builder);</span>
        }

<span class="fc" id="L1149">        String permissions = params.get(&quot;searchEditorFields.permisions&quot;);</span>
<span class="pc bpc" id="L1150" title="1 of 2 branches missed.">        if (permissions!=null) {</span>
<span class="nc" id="L1151">            specSearch.addSpecSearchPasswordProtected(permissions, &quot;passwordProtected&quot;, predicates, root, builder);</span>
        }
<span class="fc" id="L1153">        String emails = params.get(&quot;searchEditorFields.emails&quot;);</span>
<span class="fc bfc" id="L1154" title="All 2 branches covered.">        if (emails!=null) {</span>
<span class="fc" id="L1155">            specSearch.addSpecSearchPasswordProtected(emails, &quot;passwordProtected&quot;, predicates, root, builder);</span>
        }
<span class="fc" id="L1157">        int userGroupId = Tools.getIntValue(params.get(&quot;userGroupId&quot;), -1);</span>
<span class="fc bfc" id="L1158" title="All 2 branches covered.">        if (userGroupId&gt;0) {</span>
<span class="fc" id="L1159">            specSearch.addSpecSearchPasswordProtected(userGroupId, &quot;passwordProtected&quot;, predicates, root, builder);</span>
        }

<span class="fc" id="L1162">		String groupIdListParam = params.get(&quot;groupIdList&quot;);</span>
<span class="fc bfc" id="L1163" title="All 4 branches covered.">		if (Tools.isEmpty(groupIdListParam) &amp;&amp; Tools.isNotEmpty(params.get(&quot;groupId&quot;))) {</span>
<span class="fc" id="L1164">			groupIdListParam = params.get(&quot;groupId&quot;);</span>
<span class="fc bfc" id="L1165" title="All 2 branches covered.">			if (&quot;true&quot;.equals(params.get(&quot;recursive&quot;))) groupIdListParam+=&quot;*&quot;;</span>
		}

<span class="fc bfc" id="L1168" title="All 2 branches covered.">		if(Boolean.TRUE.equals( Tools.getBooleanValue(params.get(&quot;isBlogVersion&quot;), false) )) {</span>
<span class="fc" id="L1169">			List&lt;Integer&gt; bloggersGroupIds = getBloggerDataList(user, Tools.getIntValue(params.get(&quot;groupId&quot;), -1));</span>
<span class="pc bpc" id="L1170" title="1 of 2 branches missed.">			if(bloggersGroupIds != null)</span>
<span class="fc" id="L1171">				predicates.add(root.get(&quot;groupId&quot;).in(bloggersGroupIds));</span>
<span class="fc" id="L1172">		} else {</span>
<span class="fc" id="L1173">			String[] groupIdListArray = Tools.getTokens(groupIdListParam, &quot;,&quot;, true);</span>
			int groupId;
<span class="fc bfc" id="L1175" title="All 2 branches covered.">			if (groupIdListArray.length&gt;0) {</span>
<span class="fc" id="L1176">				List&lt;Integer&gt; groupIds = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L1177" title="All 2 branches covered.">				for (String id : groupIdListArray) {</span>
<span class="pc bpc" id="L1178" title="1 of 4 branches missed.">					if (id.endsWith(&quot;*&quot;) &amp;&amp; id.length()&gt;1) {</span>

<span class="fc" id="L1180">						groupId = Tools.getIntValue(id.substring(0, id.length()-1), -1);</span>
<span class="fc" id="L1181">						GroupDetails baseGroup = groupsDB.getGroup(groupId);</span>
						//to filter FullTextIndex of files
<span class="fc" id="L1183">						final boolean baseGroupIsFiles = baseGroup.getFullPath().contains(&quot;/files&quot;);</span>
<span class="fc" id="L1184">						List&lt;GroupDetails&gt; subGroups = groupsDB.getGroupsTree(groupId, true, true);</span>

<span class="fc" id="L1186">						groupIds.addAll(subGroups.stream()</span>
<span class="pc bpc" id="L1187" title="1 of 4 branches missed.">							.filter(g -&gt; baseGroupIsFiles || !g.getFullPath().contains(&quot;/files&quot;))</span>
<span class="fc" id="L1188">							.map(g -&gt; g.getGroupId())</span>
<span class="fc" id="L1189">							.collect(Collectors.toList()));</span>

<span class="fc" id="L1191">					} else {</span>

<span class="fc" id="L1193">						groupIds.add(Tools.getIntValue(id, -1));</span>

					}
				}
<span class="fc bfc" id="L1197" title="All 2 branches covered.">				if (groupIds.size()==1) {</span>
<span class="fc" id="L1198">					predicates.add(builder.equal(root.get(&quot;groupId&quot;), groupIds.get(0)));</span>
<span class="pc bpc" id="L1199" title="1 of 2 branches missed.">				} else if (groupIds.size()&gt;1) {</span>
<span class="fc" id="L1200">					predicates.add(root.get(&quot;groupId&quot;).in(groupIds));</span>
				}

				//filter iba hlavnych stranok adresarov
<span class="fc" id="L1204">				String searchStatusIcon = params.get(&quot;searchEditorFields.statusIcons&quot;);</span>
<span class="pc bpc" id="L1205" title="1 of 4 branches missed.">				if (&quot;searchDefaultPage&quot;.equals(searchStatusIcon) &amp;&amp; groupIds.size()&gt;0) {</span>
					//ziskaj zoznam default_doc_id pre zvolene adresare
<span class="fc" id="L1207">					String ids = groupIds.stream().map(String::valueOf).collect(Collectors.joining(&quot;,&quot;));</span>
<span class="fc" id="L1208">					List&lt;Integer&gt; defaultDocIds = (new SimpleQuery()).forListInteger(&quot;SELECT DISTINCT default_doc_id FROM groups WHERE group_id IN (&quot;+ids+&quot;)&quot;);</span>
					//pridaj to ako predikat
<span class="fc" id="L1210">					predicates.add(root.get(&quot;id&quot;).in(defaultDocIds));</span>
				}
			}
		}
<span class="fc" id="L1214">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>