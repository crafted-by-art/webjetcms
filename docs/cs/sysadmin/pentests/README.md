# Bezpečnostní testy

Zabezpečení systému WebJET CMS závisí na jeho správné konfiguraci a správném nastavení přístupových práv. Informace na této stránce je třeba nastavit před uvedením do produkčního provozu a následně kontrolovat alespoň jednou za čtvrt roku a vždy před provedením bezpečnostních testů.

## Nastavení systému

### Skupiny práv

Prostřednictvím WebJET CMS je také možné modifikovat programové soubory, proto je nutné před penetračním testováním nastavit omezení oprávnění. Doporučujeme vytvořit následující [skupiny práv](../../admin/users/perm-groups.md). **Jiné skupiny uživatelů nebo přímo uživatelé by neměli mít níže uvedená jednotková práva**.

**Správa uživatelů**

Skupina obsahuje oprávnění, která umožňují měnit oprávnění. Uživatel s takovou skupinou práv musí být dostatečně obezřetný, aby věděl, že má nejvyšší možnosti oprávnění (protože může nastavit práva pro sebe nebo pro ostatní uživatele).

Uživatel s tímto oprávněním může ohrozit celý systém (např. může nastavit oprávnění tak, aby mohl odstranit všechny webové stránky nebo všechny soubory).

Nastavte následující práva pro skupinu práv:
- správa administrátorů - právo umožňuje nastavit oprávnění uživatelů v administraci.
- Skupiny práv - právo umožňuje nastavit oprávnění pro skupiny.

**Programátor**

Výchozí nastavení by mělo být takové, že uživatelé (editoři) nemohou nahrávat a upravovat soubory programu. Programátor však často potřebuje provést rychlou změnu (`hotfix`) programového kódu, a proto musí upravit i programové soubory. Současně má přidána práva upravovat všechny konfigurační proměnné a editovat všechny texty překladu.

Uživatel s tímto oprávněním může ohrozit celý systém (např. nahrát škodlivý kód, který může na serveru provést jakoukoli operaci, včetně odstranění souborů na serveru nebo úplného vymazání databáze).

- Neomezené nahrávání souborů (přípony a velikosti)
- Konfigurace - zobrazení všech proměnných
- Úprava textu - zobrazení všech textů

Poznámka: seznam konfiguračních proměnných bez oprávnění "Konfigurace - zobrazit všechny proměnné" je nastaven v proměnné conf. `configEnabledKeys`, seznam překladových klíčů bez oprávnění "Úprava textu - zobrazení všech textů" v konf. proměnné `propertiesEnabledKeys`. HTML kód je také filtrován v překladových klíčích, pravidla jsou popsána níže v části `Stored XSS cez úpravu prekladových kľúčov`.

Kromě oprávnění je třeba povolit přístup k adresářům souborového systému pro zápis:
- `/apps` - obsahuje kód aplikace
- `/components` - obsahuje kód aplikace
- `/templates` - obsahuje šablony designu

Pokud je prostředí nasazeno přímo z úložiště GIT a nepředpokládáte, že bude spuštěno. `hot-fixov` přímo přes WebJET CMS, nemusíte nastavovat výše uvedená práva pro zápis do souborového systému. Navíc pro tento případ doporučujeme nastavit práva pro zápis do souborového systému pouze pro adresáře (ostatní adresáře a soubory mají práva pouze pro čtení):
- `/images` - obsahuje obrázky nahrané editory CMS
- `/files` - obsahuje soubory nahrané editory CMS
- `/shared` - obsahuje obrázky a soubory nahrané editory CMS a sdílené mezi doménami.
- `/WEB-INF/tmp` - obsahuje dočasné soubory CMS
- `/WEB-INF/imgcache` - obsahuje vygenerované náhledy obrázků a výřezy pro použití prostřednictvím `/thumb` předpona
- `/WEB-INF/formfiles` - obsahuje soubory nahrané prostřednictvím formulářů na webových stránkách vytvořených pomocí aplikace Formuláře.

### Konfigurace

Nastavte a zkontrolujte následující konfigurační proměnné (v nabídce Nastavení->Správa konfigurace):
- `defaultDisableUpload=true` - aktivuje režim, ve kterém má uživatel práva souborového systému pouze pro nakonfigurované adresáře. Pokud nejsou nastaveny žádné adresáře, nemá práva zápisu do žádného adresáře.
- `emailProtectionSenderEmail` - nastavit vhodný typ e-mailové adresy `noreply@domena.sk`, která se používá jako e-mailová adresa odesílaných e-mailů (původní hodnota je nastavena na `Reply-To` e-mailové hlavičky).
- `adminEnabledIPs` - obsahuje čárkou oddělený seznam IP adres, ze kterých je přístup k serveru `/admin` díly.
- `multidomainAdminHost` - umožňuje nastavit samostatnou doménovou adresu pro přístup k `/admin` díly, např. `cms.domena.sk`. Po nastavení bude hovor `/admin` adresy na jiných doménách vrátí chybu 404 - Stránka neexistuje.
- `serverBeyoundProxy` - pokud je aplikační server za Load Balancerem / proxy serverem, je třeba nastavit hodnotu na `true` (jinak nastavte hodnotu `false`). Load Balancer pak musí v hlavičce HTTP odeslat následující údaje `x-forwarded-for` IP adresa návštěvníka webové stránky a v záhlaví. `x-forwarded-proto` protokol (`http` nebo `https`). Při auditu (např. po vyplnění formuláře na webových stránkách) ověřte, zda je IP adresa návštěvníka webových stránek správně zaznamenána.
- `serverName` - výchozí nastavení `unknown` - nastaví hodnotu hlavičky HTTP `Server` pro odpověď HTTP. Pokud máte za Load Balancerem/proxy serverem aplikační server, ověřte hodnotu této hlavičky v odpovědi HTTP a případně ji nastavte na vhodnou neznámou hodnotu na Load Balanceru/proxy serveru.

Omezení pro nahrané soubory ze strany editorů v administraci:
- `FCKConfig.UploadMaxSize[Default][image]` - výchozí 0 - limit velikosti v kB pro nahrávání **Obrázky**, doporučujeme nastavit hodnotu 10000 pro nahrávání max. 10 MB obrázku.
- `FCKConfig.UploadMaxSize[Basic][image]` - výchozí 2048 - limit velikosti v kB pro nahrávání **Obrázky** pro uživatele, kteří **nemají v editoru správnou nabídku Kompletní**
- `FCKConfig.UploadMaxSize[Default][file]` - výchozí 0 - limit velikosti v kB pro nahrávání **soubory**, doporučujeme nastavit hodnotu 50000 pro nahrávání max. 50 MB souboru.
- `FCKConfig.UploadMaxSize[Basic][file]` - výchozí 2048 - limit velikosti v kB pro nahrávání **soubory** pro uživatele, kteří **nemají v editoru správnou nabídku Kompletní**
- `FCKConfig.UploadFileTypes[Default][image]` - výchozí prázdný = bez omezení - typ omezení **Obrázky**, doporučujeme nastavit na `jpg,jpeg,png,gif,svg,mp3,mp4`. Je třeba zvážit možnost povolení přípony SVG, viz potenciální riziko níže v bloku. `Stored XSS cez SVG obrázok`.
- `FCKConfig.UploadFileTypes[Basic][image]` - výchozí nastavení `jpg,jpeg,png,gif,mp4` - typové limity **Obrázky** pro uživatele, kteří **nemají v editoru správnou nabídku Kompletní**
- `FCKConfig.UploadFileTypes[Default][file]` - výchozí prázdný = bez omezení - typ omezení **soubory**, doporučujeme nastavit na `pdf,docx,xlsx,pptx,ppsx,zip,rtf`
- `FCKConfig.UploadFileTypes[Basic][file]` - výchozí nastavení `doc,docx,xls,xlsx,pdf,zip,rtf` - typové limity **soubory** pro uživatele, kteří **nemají v editoru správnou nabídku Kompletní**

Můžete také zkontrolovat následující konfigurační proměnné:
- `overviewJsonUrl` - definuje adresu URL, ze které se načítá seznam novinek v systému WebJET. Pokud uživatelé nemají přístup k internetu z prohlížeče, můžete tuto hodnotu nastavit na hodnotu `/admin/v9/json/` pro čtení z místní instance. V nových verzích systému WebJET CMS se však uživatelům novinky nezobrazí.

### Hlavičky HTTP

V aplikaci Konfigurace můžete nastavit hodnoty záhlaví zabezpečení:
- `contentSecurityPolicy` - nastavení záhlaví `Content-Security-Policy`. Omezení, jak má stránka načítat různé zdroje. Pokud máte certifikát httpS, můžete jej nastavit na: `default-src 'none'; script-src https: blob: data: 'unsafe-inline' 'unsafe-eval'; worker-src https: blob:; child-src https: blob:; style-src https: data: 'unsafe-inline' 'unsafe-eval'; img-src https: data: 'unsafe-inline'; font-src https: data:; object-src blob: 'self'; base-uri 'none'; frame-ancestors 'self'; connect-src blob: 'self'; frame-src 'self'`. Ve výchozím nastavení prázdné (záhlaví není nastaveno).
- `contentSecurityPolicySvg` - specifické omezení pro obrázky SVG kvůli jejich odlišnému zpracování v prohlížeči Internet Explorer.
- `featurePolicyHeader` - Hodnota hlavičky HTTP `Feature-Policy/Permissions-Policy` (např: `microphone 'none'; geolocation 'none'`), více na: https://developer.mozilla.org/en-US/docs/Web/HTTP/Feature\_Policy. Ve výchozím nastavení prázdné.
- `refererPolicy` - Nastavení hlavičky HTTP `Referrer-Policy`, doporučujeme nastavit na `same-origin`. Výchozí `same-origin`.
- `serverName` - hodnota záhlaví `Server` v odpovědích HTTP. Výchozí `unknown`. Nelze ji nastavit na prázdnou hodnotu, protože pak aplikační server vloží tuto hlavičku.
- `strictTransportSecurity` - ve výchozím nastavení prázdný - nastaví hlavičku HTTP [Přísný transport a zabezpečení](https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security) v odpovědích HTTP, který zajišťuje přesměrování požadavků HTTP na zabezpečený httpS, doporučujeme nastavit na: `max-age=31536000 ; includeSubDomains`. Vyžaduje, aby byl aplikační server přístupný prostřednictvím zabezpečeného protokolu httpS.
- `xContentTypeOptions` - hodnota záhlaví `X-Content-Type-Options` nastavit určování typů souborů podle obsahu (bez ohledu na přípony). Výchozí `nosniff`.
- `xFrameOptions` - hodnota záhlaví `X-Frame-Options` pro ochranu před útokem CSRF. Výchozí `SAMEORIGIN`.
- `xRobotsTagValue` - hodnota záhlaví `X-Robots-Tag` pro adresy URL nastavené v proměnné `xRobotsTagUrls`. Výchozí `noindex, nofollow`.
- `xRobotsTagUrls` - seznam začátků adres URL oddělených čárkami pro nastavení hlavičky `X-Robots-Tag`. Pokud seznam obsahuje hodnotu `NOT_SEARCHABLE_PAGE` záhlaví je nastaveno i pro stránky s vypnutým vyhledáváním. Výchozí `/components/,NOT_SEARCHABLE_PAGE`.
- `xXssProtection` - hodnota záhlaví `X-XSS-Protection` pro ochranu před útokem XSS. Výchozí `1; mode=block`.

Nastavení záhlaví `Access-Control` pro přístup ke službám REST z jiných serverů:
- `accessControlAllowOriginValue` - hodnota záhlaví `Access-Control-Allow-Origin` pro URL set v proměnné `accessControlAllowOriginUrls`. V hodnotě můžete použít makro (viz níže). Ve výchozím nastavení nastaveno na `{HTTP_PROTOCOL}://{SERVER_NAME}:{HTTP_PORT}`.
- `accessControlAllowOriginUrls` - seznam začátků adres URL oddělených čárkami pro nastavení hlavičky `Access-Control-Allow-Origin`. Výchozí nastavení je `/rest/,/private/rest/,/admin/rest/`.
- `accessControlAllowHeaders` - hodnota nastavení záhlaví `Access-Control-Allow-Headers`, se nastavuje pouze při generování záhlaví. `Access-Control-Allow-Origin`. Výchozí `Origin, Accept, X-Requested-With, Content-Type, Access-Control-Request-Method, Access-Control-Request-Headers, x-csrf-token`.
- `accessControlAllowMethods` - hodnota nastavení záhlaví `Access-Control-Allow-Methods`, se nastavuje pouze při generování záhlaví. `Access-Control-Allow-Origin`. Výchozí `HEAD,POST,GET,OPTIONS,PUT`.
- `accessControlMaxAge` - hodnota nastavení záhlaví `Access-Control-Max-Age`, se nastavuje pouze při generování záhlaví. `Access-Control-Allow-Origin`. Výchozí `1800`.
- `accessControlAllowedOrigins` - pokud není prázdný, vyžaduje v požadavku hlavičku `origin` jehož hodnota musí být v tomto seznamu (seznam oddělený čárkou nebo novým řádkem). Nastavuje se pouze při generování záhlaví `Access-Control-Allow-Origin`. Ve výchozím nastavení prázdné.

Pokud potřebujete nastavit jinou hlavičku HTTP, můžete použít aplikaci [Hlavičky HTTP](../../admin/settings/response-header/README.md) v části Nastavení.

V hodnotě můžete použít makro `{HTTP_PROTOCOL}, {SERVER_NAME}/{DOMAIN_NAME}/{DOMAIN_ALIAS}, {HTTP_PORT}`, která bude nahrazena hodnotou získanou na serveru. `SERVER_NAME` je název domény z `request.getServerName()`, `DOMAIN_NAME` a `DOMAIN_ALIAS` jsou hodnoty domény nebo aliasu nastavené na webové stránce. Hodnota `{INSTALL_NAME}` představuje název instalace. Hodnota `{HEADER_ORIGIN}` obsahuje hodnotu hlavičky HTTP `origin`.

Ve starších instalacích bylo také možné nastavit hlavičky HTTP pomocí proměnné conf. `responseHeaders` ve kterém můžete nastavit hlavičku pro prefix adresy URL (začátek adresy URL). Na každém řádku zadáte hodnotu ve formátu: `url-prefix:hlavička:hodnota`, například:

```
/admin:X-Accel-Buffering:no
/rest/calculators/:Access-Control-Allow-Origin:*
/rest/calculators/:Access-Control-Allow-Headers:origin,x-requested-with,access-control-request-headers,content-type,access-control-request-method,accept,x-csrf-token
/rest/calculators/:Access-Control-Allow-Methods:GET,OPTIONS
```

Hodnoty nastavené prostřednictvím konfigurační proměnné `responseHeaders` jsou globální bez ohledu na aktuální doménu.

### Pravidla pro zadávání hesel

Pravidla hesla lze nastavit pomocí následujících konfiguračních proměnných (výchozí hodnota je uvedena v závorce vedle proměnné):
- `passwordAdminMinLength` - Určuje minimální délku hesla pro správce (5).
- `passwordAdminMinCountOfSpecialSigns` - Určuje minimální počet výskytů speciálních znaků v hesle správce (0).
- `passwordAdminMinUpperCaseLetters` - Určuje minimální počet výskytů velkých písmen v hesle správce (1).
- `passwordAdminMinLowerCaseLetters` - Určuje minimální počet výskytů malých písmen v hesle správce (0).
- `passwordAdminMinCountOfDigits` - Určuje minimální počet výskytů čísel v hesle pro správce (1).
- `passwordAdminExpiryDays` - Určuje počet dní platnosti hesla pro správce. Po uplynutí této doby bude uživatel vyzván ke změně hesla. Hodnota 0 znamená, že platnost hesla (0) se nekontroluje.

Podobně lze nastavit pravidla hesla pro přihlášení do zabezpečené oblasti webu (nikoliv do administrace), proměnné jsou stejné, ale neobsahují výraz `Admin`. Název proměnné je tedy např. `passwordMinUpperCaseLetters`.

Nastavením konfigurační proměnné `isGoogleAuthRequiredForAdmin` na adrese `true` bude pro přístup k `/admin` části vyžadovaly dvoufaktorové ověření. Každý uživatel si ho musí předem nastavit v administraci kliknutím na své jméno vpravo nahoře a výběrem možnosti **Dvoufázové ověření** nebo otevřením stránky `/admin/2factorauth.jsp`.

Doporučujeme nastavit dvoufaktorové ověřování alespoň pro všechny účty, které lze použít ke správě uživatelských účtů a oprávnění a k nastavení konfigurace systému.

WebJET při změně hesla kontroluje historii a nedovolí opakované použití stejného hesla. To je ovlivněno následujícími konfiguračními proměnnými:
- `passwordHistoryLength` - počet použitých uživatelských hesel, která jsou pamatována v historii (ve výchozím nastavení 6).
- `passwordHistoryEnabled` - pokud je nastavena na `true` historie hesel je kontrolována v databázi a není povoleno měnit heslo, které bylo použito v minulosti (ve výchozím nastavení). `true`).

Při žádosti o změnu hesla se používají následující proměnné:
- `passwordResetValidityInMinutes` - časová platnost v minutách pro odeslaný odkaz na změnu hesla (výchozí 30).
- `changePasswordPageUrl` - adresa stránky pro změnu hesla (výchozí `/components/user/change_password.jsp`).

### Blokování přihlášení

Po nesprávné kombinaci uživatelského jména a hesla WebJET zablokuje další přihlášení ze stejné IP adresy. Je možné nastavit následující konfigurační proměnné:
- `logonBlockedDelay` - Doba v sekundách, po kterou se nebude možné znovu přihlásit po zadání nesprávného jména/hesla (výchozí 10).
- `logonBlockedAfterUnsuccessCount` - počet neúspěšných přihlášení, po kterých se prodleva definovaná v položce `logonLoginBlockedDelay` (výchozí hodnota 5).
- `logonLoginBlockedDelay` - dobu v sekundách, po kterou se nebude možné po zadání špatného hesla znovu přihlásit, a `logonBlockedAfterUnsuccessCount` počet neúspěšných přihlášení pro zadané přihlašovací jméno (výchozí 60).

Ve výchozím nastavení je tedy použita hodnota 10 sekund (`logonBlockedDelay`), pokud je zadán více než pětkrát za sebou (`logonBlockedAfterUnsuccessCount`) se použije zpoždění 60 sekund (`logonLoginBlockedDelay`).

Během doby uzamčení přihlášení se počítadlo neúspěšných pokusů stále nezvyšuje a čas se neprodlužuje, protože se vůbec nevolá přihlašovací kód.

### Algoritmus hashování hesel

Z verze `2022.40` algoritmus BCrypt se v implementaci používá k hašování hesel. `org.springframework.security.crypto.bcrypt.BCrypt`.

Možné nastavení:
- `bcryptSaltRounds` (výchozí 12) - log2 počtu opakování převrácení
- `passwordHashAlgorithm` (výchozí nastavení `bcrypt`) - název hashovacího algoritmu, možné hodnoty `bcrypt` nebo `sha-512`.

Dřívější verze používaly algoritmus `SHA-512` se 100 opakováními. Starší hodnoty hash hesel se při změně hesla uživatele změní na algoritmus bcrypt. Chcete-li změnu algoritmu vynutit, můžete nastavit proměnnou conf. `passwordAdminExpiryDays` na nenulovou hodnotu, což uživatele po přihlášení vyzve ke změně hesla.

### Přihlášení do správy

Přihlašování do administrace je rovněž ovlivněno výše uvedenými konfiguračními proměnnými:
- `adminEnabledIPs` - obsahuje čárkou oddělený seznam IP adres, ze kterých je přístup k serveru `/admin` díly.
- `multidomainAdminHost` - umožňuje nastavit samostatnou doménovou adresu pro přístup k `/admin` díly, např. `cms.domena.sk`. Po nastavení bude hovor `/admin` adresy na jiných doménách vrátí chybu 404 - Stránka neexistuje.
- `isGoogleAuthRequiredForAdmin` - zapnutí dvoufaktorového ověřování při přihlašování do správy. `/admin`.
- `clusterMyNodeType` - v případě clusteru nastaví režim uzlu pouze uzly nastavené na hodnotu `full` obsahují administraci a umožňují přihlášení.
- `auditDontLogUsrlogon` - po nastavení na `true` přihlášení běžných uživatelů (neadministrátorů) nebudou kontrolována. Vhodné pro velmi zatížený intranet, kde zbytečně zahlcuje audit (ve výchozím nastavení `false`).

Uživatel, který se úspěšně autorizuje, musí navíc splňovat následující kritéria:
- `Schválený používateľ` - na účtu musí být tato možnost vybrána.
- `Začiatok platnosti` - pokud zadaná hodnota musí být starší než aktuální datum.
- `Koniec platnosti` - pokud zadaná hodnota musí být větší než aktuální datum.
- `Povoliť vstup do admin sekcie (správa web sídla)` - Účet musí mít tuto možnost povolenou, jinak není přístup do administrace možný.

V případě speciálních požadavků na přihlašování a ověřování uživatelů je možné implementovat vlastní přihlašovací třídu v jazyce Java a nastavit ji pomocí proměnné conf. `adminLogonMethod`. Zadaná třída Java se pak použije místo standardního přihlášení.

Při přihlášení s nesprávnými údaji [blokuje přihlášení](#blokování-přihlášení).

### Ověřování proti serveru LDAP

Při ověřování uživatele proti serveru LDAP lze nastavit následující konfigurační proměnné:
- `ldapProviderUrl` - Adresa URL serveru LDAP pro přihlášení do LDAP ve tvaru `ldap://ldap.local:389/DC=firma,DC=com??base`.
- `ldapPassword` - přihlašovací jméno technického uživatele pro načítání dat LDAP.
- `ldapUsername` - přihlašovací heslo technického uživatele pro načtení dat LDAP.
- `ldapUseSslProtocol` - používá při komunikaci se serverem LDAP protokol SSL. Na portu 636 serveru LDAP musí být povolen protokol SSL. Pokud se používá ldapS://, ponechte hodnotu false.
- `NTLMForbiddenURL` - URL adresy odepřeného přístupu (ve výchozím nastavení `/500.jsp`).
- `NTLMDomainController` - název řadiče domény.
- `ldapDomainAppend` - pokud je nutné přihlásit se celou doménou, je možné zadat její doplnění k zadanému přihlašovacímu jménu uživatele.
- `ldapSecurityPrincipalDn` - nastaví speciální `SECURITY_PRINCIPAL` Např. `cn=!USERNAME!,dc=ad,dc=interway,dc=sk` s tím, že `!USERNAME!` je nahrazen přihlašovacím jménem. Pokud je prázdné, použije se `ldapUsername+ldapDomainAppend`.
- `ldapFilter` - přihlašovací filtr pro přihlášení LDAP, pomocí kterého se vyhledává účet (výchozí hodnota `(&(objectClass=Person) (&(sAMAccountName=!USERNAME!)))`).
- `basicNtlmLogonAttrs` - Seznam atributů, které se mají načíst ze serveru LDAP při přihlašování. Pokud je prázdný, ověří se pouze přihlášení a uživatel se neaktualizuje podle hodnot na serveru LDAP. Výchozí `mail,title,givenName,sn,streetAddress,l,postalCode,co,company,telephoneNumber,mobile,description,memberOf,distinguishedName,thumbnailPhoto`.
- `ntlmDefaultUserPhoto` - pokud je nastavena na neprázdnou hodnotu a uživatel nemá fotografii v LDAP, nastaví fotografii na zadanou adresu URL.

Nastavení práv:

Po přihlášení se název uživatelské skupiny a práva skupiny automaticky porovnají se skupinami v LDAP (atribut `memberOf`). Pokud jméno odpovídá skupině ve WebJET, je uživatel přiřazen. Kromě toho je možné nastavit:
- `NTLMAdminGroupName` - Název skupiny LDAP, která identifikuje, že účet má administrátorský přístup (např. WebJETAdmins).
- `passwordProtectedAutoId` - Čárkou oddělený seznam ID uživatelských skupin, které budou uživateli automaticky přiřazeny po úspěšném přihlášení.

### Konfigurace aplikačního serveru Tomcat

Předpokládáme, že webové stránky/aplikace budou přístupné prostřednictvím zabezpečeného protokolu httpS. Proto je nutné nastavit atribut `secure="true"`, [Konektor HTTP/AJP](https://tomcat.apache.org/tomcat-9.0-doc/config/http.html) aby byl soubor cookie relace přístupný pouze prostřednictvím zabezpečeného protokolu httpS. Nastavení provedete v souboru `tomcat/conf/server.xml`. Atribut `useBodyEncodingForURI="true"` nastaví pro adresu URL stejné kódování znaků, jaké se používá pro tělo stránky.

```xml
<Connector
    ...
    secure="true"
    useBodyEncodingForURI="true"
    ...
/>
```

pokud použijete nezabezpečený protokol HTTP, prohlížeč soubor cookie relace nepřijme a relace se neudrží (to se projeví opakovaným zobrazením přihlašovacího okna, jakmile zadáte správné přihlašovací údaje).

Vyhnutí se zobrazení verze aplikačního serveru při zobrazení chyby `Tomcat` a `Stack Trace` je třeba v souboru server.xml `<Host` prvek přidat konfiguraci [ErrorReportValve](https://tomcat.apache.org/tomcat-9.0-doc/config/valve.html#Error_Report_Valve):

```xml
<Host ...>
    <Valve className="org.apache.catalina.valves.ErrorReportValve"
        showReport="false"
        showServerInfo="false" />
</Host>
```

v případě potřeby můžete také vytvořit statickou html stránku v kódování. `utf-8` s chybovou zprávou a nakonfigurujte ji jako:

```xml
<Valve className="org.apache.catalina.valves.ErrorReportValve"
    errorCode.400="webapps/error400.html"
    errorCode.0="webapps/errorOthers.html"
    showReport="false"
    showServerInfo="false" />
```

### Oznámení o změnách

Doporučujeme nastavit zasílání oznámení bezpečnostnímu technikovi pro následující typy událostí:
- `CONF_UPDATE` a `CONF_DELETE` - změna/odstranění konfigurační proměnné
- `PROP_UPDATE` a `PROP_DELETE` - změna/odstranění překladového klíče (kód JavaScriptu lze vložit také prostřednictvím překladového klíče).

Oznámení můžete nastavit v administraci v části Audit->Oznámení. Bezpečnostní technik bude o těchto změnách informován a v případě podezření na útok může reagovat.

### Zabezpečení serveru

Důležité je také zabezpečení samotného serveru a použitého softwaru. Aktualizujte software na nejnovější podporované verze. Na serveru je také vhodné nainstalovat antivirový program, který bude kontrolovat nahrávané soubory a v případě, že v některém souboru zjistí virus, zabrání přístupu k tomuto souboru.

## Nastavení WAF

Pokud je aplikační server předdefinován `Web Application Firewall/WAF` je třeba nastavit **výjimky pro správu**. Některé požadavky HTTP v administraci mohou být detekovány jako útok XSS/SQL Injection, protože požadavek HTTP může odesílat kód JavaScript nebo příkaz SQL. Příkladem je ukládání webové stránky, kdy může být potřebný kód JavaScriptu vložen do pole kódu HTML v záhlaví, nebo ukládání záznamů v aplikaci Skripty, kde je kód JavaScriptu vložen přímo.

Ideálním řešením je použití clusterového řešení s vyhrazeným uzlem CMS v místní síti, který není přístupný z vnějšího prostředí. V takovém případě lze WAF pro uzel CMS vynechat.

Správa používá služby REST začínající na adrese URL `/admin/rest`, viz doporučení pro [Pravidla URL](../../custom-apps/spring/rest-url.md#pravidla-pro-url-adresy). V systému WAF je třeba nastavit výjimky pro adresy URL začínající na:
- `/admin/rest/web-pages` - ukládání webových stránek
- `/admin/rest/components/insert-script` - Skripty aplikací
- `/admin/v9/settings/translation-keys` - překladové klíče - v některých případech může být nutné vložit do překladového klíče kód HTML.
- `/admin/rest/settings/configuration` - konfigurace, platí podobně jako u překladových klíčů
- `/admin/searchall.jsp` - vyhledávání v administraci, může být nutné vyhledat výraz HTML/JavaScript.
- `/admin/replaceall.jsp` - nahrazení výrazu v administraci, podobně jako při hledání
- `/admin/updatedb.jsp` - provedení zadaného příkazu SQL

Ostatní adresy URL by měly být nastaveny na základě používaných aplikací.

## Řešení zjištění zabezpečení

- `Sensitive Data Exposure`

Prostřednictvím chybových odpovědí serveru bylo možné zjistit typ a verzi použitého webového serveru.

Řešení: Ověřte nastavení hlavičky HTTP `Server`, ve WebJETu lze přebudovat v konfigurační proměnné `serverName`, viz výše.

- `RCE via uploaded JSP file`

WebJET CMS umožňuje nahrávání libovolných souborů, včetně souborů JSP, které umožňují spouštění libovolných příkazů na běžícím serveru.

Chybě lze zabránit nastavením práv pro nahrávání souborů nebo úplným zamezením zápisu souborů programu.

Řešení: upravte nastavení práv pro nahrávání souborů pomocí konfiguračních proměnných `FCKConfig.Upload*`, viz výše.

- `MaliciousFileUpload`

Server nemá antivirovou kontrolu, takže je možné na něj nahrát škodlivé soubory.

Řešení: Nainstalujte na server antivirový program.

- `Missing Secure cookie flag`

Soubor cookie relace (`JSESSIONID`) nemá nastaven atribut zabezpečení `Secure`.

Řešení: kontrola a nastavení `secure` atribut v souboru [server.xml](https://tomcat.apache.org/tomcat-9.0-doc/config/http.html) Aplikační server Tomcat, viz výše.
- `Missing HTTP Strict Transport Security policy`

Aplikace nenastavuje hlavičku HTTP `Strict Transport Security`.

Řešení: hodnota [Záhlaví Strict Transport Security](https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security) lze nastavit v konfigurační proměnné `strictTransportSecurity=max-age=31536000 ; includeSubDomains`, viz. výše.
- `Stored XSS cez SVG obrázok`

Soubor SVG umožňuje vložit do těla JavaScript kód, v případě přímého zobrazení takového souboru v prohlížeči se kód JavaScript spustí (v případě standardního vložení přes aplikaci). `img` kód se neprovede a zobrazení je bezpečné).

Řešení: Omezte možnost nahrávat soubory SVG, viz nastavení práv výše. Jako ochranu WebJET CMS generuje hlavičku HTTP pro soubory SVG `Content-Security-Policy` s hodnotou `default-src 'self'` který [zabraňuje spuštění kódu javascript](https://github.com/digininja/svg_xss) při přímém zobrazení obrázku. Hodnotu lze nastavit pomocí konfigurační proměnné `contentSecurityPolicySvg`.

Pro ověření chování vytvořte soubor SVG s následujícím obsahem, nahrajte jej do systému WebJET CMS, vložte jej do testovací stránky a ověřte její zobrazení a (ne)provedení útoku XSS:

```xml
<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" baseProfile="full" xmlns="http://www.w3.org/2000/svg"> <polygon id="triangle" points="0,0 0,100 100,0" fill="#3e70b7"
stroke="#004400"/>
<script type="text/javascript">
alert("SVG XSS");
</script>
</svg>
```
- `Stored XSS` úpravou překladových klíčů

Prostřednictvím překladových textů je editor schopen provést útok typu `Cross Site Scripting` proti ostatním návštěvníkům stránek nebo jiným správcům.

Překladové klávesy se používají také k vkládání kódu HTML (např. odkaz na podmínky v kalkulačce, tučné písmo, nastavení stylů CSS), takže tato aplikace technicky umožňuje vkládat také kód HTML/JavaScript (to je vlastnost, nikoli chyba). Všimněte si, že editor může vkládat kód JavaScriptu i přímo v editoru stránky, není žádný zásadní důvod mu bránit i v úpravě překladových klíčů.

Řešení: Minimalizujte počet uživatelů s přístupem k aplikaci Překlad textu. Uživatelé, kteří nemají oprávnění "Upravovat texty - zobrazit všechny texty", mají zároveň omezené možnosti úprav. Mohou upravovat pouze vybrané klíče (nastavené prostřednictvím konf. proměnné). `propertiesEnabledKeys`) a zároveň je upravená hodnota filtrována a umožňuje pouze definované značky a atributy HTML. Ty se nastavují v proměnné conf. `propAllowedTags` kde jsou ve výchozím nastavení povoleny značky `p,div,a,sub,sup,br,strong` a atributy v proměnné conf. `propAllowedAttrs` kde jsou ve výchozím nastavení povoleny atributy `href,src,style,class,rel`. Pokud chcete uživatelům bez oprávnění "Upravovat texty - zobrazovat všechny texty" zcela zamezit vkládání kódu HTML, můžete nastavit proměnnou conf. `propAllowedTags` na prázdnou hodnotu (nebo znak `-`). Nastavením na znak `*` ochrana je vypnutá.

Jako další ochranu doporučujeme nastavit oznámení při změně na bezpečnostního inženýra, viz výše.

- `Insecure Deserialization`

Import webové stránky obsahuje dokumenty .xml se serializovanými objekty java. Tyto dokumenty .xml však mohou být upraveny a obsluhovány vlastními serializovanými objekty java typu `<object class="java.lang.Runtime" method="getRuntime">` které provedou zadanou operaci přímo na serveru.

Pro úspěšné zneužití je nutné upravit proměnnou conf. `XMLDecoderAllowedClasses` který obsahuje seznam povolených deserializovaných objektů, a přidejte tam hodnotu `java.lang.Runtime`.

Řešení: Běžný uživatel nesmí mít oprávnění k úpravě konfiguračních proměnných, ty by měla upravovat pouze k tomu určená osoba. Jako dodatečnou ochranu jsme přímo do kódu (bez možnosti editace tohoto seznamu) přidali nepovolené typy objektů, které nelze přidat (povolit) prostřednictvím konfigurace.

- `Cookies: Set the 'SameSite' flag as a counter measure to cross-site request forgery`

Pro `cookies` lze nastavit atribut [SameSite](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie/SameSite) zabránit odesílání souborů cookie při útoku CSRF (zabránit odesílání souborů cookie do jiných domén).

V současné době v `servlet-api` podpora pro nastavení této hodnoty ve verzi 5.x se chystá, což může znamenat dlouhé čekání na přímou programátorskou podporu. Při použití Apache Tomcat je však možné tuto hodnotu nastavit v konfiguraci pomocí příkazu [CookieProcessor](https://tomcat.apache.org/tomcat-8.5-doc/config/cookie-processor.html), což ve standardní implementaci umožňuje nastavit hodnotu:

```xml
<Context>
    ...
    <CookieProcessor sameSiteCookies="strict"/>
</Context>
```
