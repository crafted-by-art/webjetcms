<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PropImportExportAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.i18n</a> &gt; <span class="el_source">PropImportExportAction.java</span></div><h1>PropImportExportAction.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.i18n;

import java.io.InputStream;

import com.fasterxml.jackson.databind.ObjectMapper;

import net.sourceforge.stripes.action.ActionBeanContext;
import net.sourceforge.stripes.action.DefaultHandler;
import net.sourceforge.stripes.action.FileBean;
import net.sourceforge.stripes.action.ForwardResolution;
import net.sourceforge.stripes.action.Resolution;
import net.sourceforge.stripes.validation.Validate;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.system.stripes.WebJETActionBean;
import sk.iway.iwcm.users.UsersDB;

/**
 *  PropImportExportAction.java
 *
 *@Title        webjet7
 *@Company      Interway s.r.o. (www.interway.sk)
 *@Copyright    Interway s.r.o. (c) 2001-2012
 *@author       $Author: Marián Halaš $
 *@version      $Revision: 1.3 $
 *@created      Date: 6.2.2012 13:35:13
 *@modified     $Date: 2004/08/16 06:26:11 $
 */
<span class="nc" id="L29">public class PropImportExportAction extends WebJETActionBean</span>
{

	@Validate(on={&quot;importAct&quot;},required=true)
	private FileBean propFile;
	private String language;
	private String prefix;
	private String filterPrefix;
	private boolean onlyNewKeys;

	public FileBean getPropFile()
	{
<span class="nc" id="L41">		return propFile;</span>
	}

	public void setPropFile(FileBean propFile)
	{
<span class="nc" id="L46">		this.propFile = propFile;</span>
<span class="nc" id="L47">	}</span>


	@Override
	public void setContext(ActionBeanContext context)
	{
<span class="nc" id="L53">		super.setContext(context);</span>
<span class="nc" id="L54">		setLanguage(context.getRequest().getParameter(&quot;lng&quot;));</span>
<span class="nc" id="L55">	}</span>


	@DefaultHandler
	public Resolution defaultAction() {
<span class="nc" id="L60">		return (new ForwardResolution(RESOLUTION_CONTINUE));</span>
	}

	public Resolution importAct()
	{
<span class="nc bnc" id="L65" title="All 2 branches missed.">		if (isAdminLogged()==false) return new ForwardResolution(RESOLUTION_NOT_LOGGED);</span>
<span class="nc" id="L66">		Identity user = UsersDB.getCurrentUser(getRequest());</span>
<span class="nc bnc" id="L67" title="All 4 branches missed.">		if (user==null || user.isDisabledItem(&quot;edit_text&quot;)) return new ForwardResolution(RESOLUTION_NOT_LOGGED);</span>

<span class="nc" id="L69">		Logger.debug(getClass(), &quot;Importing custom properties for language: &quot; + getLanguage());</span>
<span class="nc" id="L70">		IwayProperties iwprop = new IwayProperties();</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">		if(propFile != null){</span>
			try {
<span class="nc bnc" id="L73" title="All 8 branches missed.">				if(propFile.getFileName().endsWith(&quot;.properties&quot;) || propFile.getFileName().endsWith(&quot;.txt&quot;) || propFile.getFileName().endsWith(&quot;.json&quot;) || propFile.getContentType().contains(&quot;text&quot;)) {</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">					if(propFile.getFileName().endsWith(&quot;.json&quot;))</span>
<span class="nc" id="L75">						iwprop = loadJsonFile(propFile);</span>
					else
<span class="nc" id="L77">						iwprop.load(propFile);</span>

					//save to DB
					//find if the is already one, if is, update, else insert
<span class="nc" id="L81">					PropDB.save(getCurrentUser(), iwprop,getLanguage(), prefix, filterPrefix, onlyNewKeys);</span>
<span class="nc" id="L82">					getRequest().setAttribute(&quot;saveOk&quot;,&quot;ok&quot;);</span>
				} else {
<span class="nc" id="L84">					Logger.debug(getClass(),&quot;Import failed. File &quot; + propFile.getFileName() + &quot; is not text.&quot;);</span>
<span class="nc" id="L85">					getRequest().setAttribute(&quot;message&quot;, Prop.getInstance().getText(&quot;admin.conf_editor.notText&quot;));</span>
				}
			}
<span class="nc" id="L88">			catch (Exception e)</span>
			{
<span class="nc" id="L90">				Logger.debug(getClass(), &quot;Failed to load properties from fileBean. cause: &quot; + e.getMessage());</span>
<span class="nc" id="L91">				sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L92">				getRequest().setAttribute(&quot;saveFail&quot;,&quot;fail&quot;);</span>
<span class="nc" id="L93">			}</span>
		}

<span class="nc" id="L96">		Prop.getInstance(true);</span>

<span class="nc" id="L98">		 return new ForwardResolution(RESOLUTION_CONTINUE);</span>
  }

	public void setLanguage(String language)
	{
<span class="nc" id="L103">		this.language = language;</span>
<span class="nc" id="L104">	}</span>

	public String getLanguage()
	{
<span class="nc" id="L108">		return language;</span>
	}

	private IwayProperties loadJsonFile(FileBean propFile)
   {
<span class="nc" id="L113">		IwayProperties iwprop = null;</span>

		try
		{
<span class="nc" id="L117">	   	InputStream is = propFile.getInputStream();</span>
<span class="nc" id="L118">	   	iwprop = new ObjectMapper().readValue(is, IwayProperties.class);</span>
<span class="nc" id="L119">	   	is.close();</span>
		}
<span class="nc" id="L121">		catch(Exception e){sk.iway.iwcm.Logger.error(e);}</span>

<span class="nc" id="L123">		return iwprop;</span>
   }

	public String getPrefix()
	{
<span class="nc" id="L128">		return prefix;</span>
	}

	public void setPrefix(String prefix)
	{
<span class="nc" id="L133">		this.prefix = prefix;</span>
<span class="nc" id="L134">	}</span>

	public boolean isOnlyNewKeys()
	{
<span class="nc" id="L138">		return onlyNewKeys;</span>
	}

	public void setOnlyNewKeys(boolean onlyNewKeys)
	{
<span class="nc" id="L143">		this.onlyNewKeys = onlyNewKeys;</span>
<span class="nc" id="L144">	}</span>

	public String getFilterPrefix()
	{
<span class="nc" id="L148">		return filterPrefix;</span>
	}

	public void setFilterPrefix(String filterPrefix)
	{
<span class="nc" id="L153">		this.filterPrefix = filterPrefix;</span>
<span class="nc" id="L154">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>