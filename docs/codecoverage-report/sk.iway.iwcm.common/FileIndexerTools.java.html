<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileIndexerTools.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.common</a> &gt; <span class="el_source">FileIndexerTools.java</span></div><h1>FileIndexerTools.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.common;

import java.io.BufferedInputStream;
import java.io.File;
import java.io.UnsupportedEncodingException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import java.util.StringTokenizer;

import sk.iway.Password;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.FileTools;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.RequestBean;
import sk.iway.iwcm.SetCharacterEncodingFilter;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.components.file_archiv.FileArchivatorBean;
import sk.iway.iwcm.components.file_archiv.FileArchivatorDB;
import sk.iway.iwcm.doc.DocDB;
import sk.iway.iwcm.doc.DocDetails;
import sk.iway.iwcm.doc.GroupDetails;
import sk.iway.iwcm.doc.GroupsDB;
import sk.iway.iwcm.doc.TemplateDetails;
import sk.iway.iwcm.doc.TemplatesDB;
import sk.iway.iwcm.findexer.Excel;
import sk.iway.iwcm.findexer.FileIndexer;
import sk.iway.iwcm.findexer.PDF;
import sk.iway.iwcm.findexer.PoiExtractor;
import sk.iway.iwcm.findexer.Rtf;
import sk.iway.iwcm.findexer.Word;
import sk.iway.iwcm.io.IwcmFile;
import sk.iway.iwcm.io.IwcmFsDB;
import sk.iway.iwcm.io.IwcmInputStream;
import sk.iway.iwcm.system.zip.ZipEntry;
import sk.iway.iwcm.system.zip.ZipInputStream;
import sk.iway.iwcm.users.UserDetails;

public class FileIndexerTools {

    private FileIndexerTools() {
        //Utility class
    }

    /**
     * Vymazanie suboru z indexu
     * @param url
     * @return
     */
    public static boolean deleteIndexedFile(String url)
    {

        try
        {
<span class="nc" id="L59">            TemplatesDB tempDB = TemplatesDB.getInstance();</span>
<span class="nc" id="L60">            TemplateDetails temp = tempDB.getTemplate(&quot;files&quot;);</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">            if (temp == null)</span>
            {
<span class="nc" id="L63">                temp = tempDB.getTemplates().get(0);</span>
            }

            //vymaz Stranku s tymto suborom
<span class="nc" id="L67">            StringTokenizer st = new StringTokenizer(getUrlForGroupsTokenize(url), &quot;/&quot;);</span>
<span class="nc" id="L68">            int parentDirId = 0;</span>
            String dirName;
<span class="nc" id="L70">            GroupsDB groupsDB = GroupsDB.getInstance();</span>
            GroupDetails group;
<span class="nc bnc" id="L72" title="All 2 branches missed.">            while (st.hasMoreTokens())</span>
            {
<span class="nc" id="L74">                dirName = st.nextToken();</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">                if (st.hasMoreTokens())</span>
                {
                    //je to skutocne adresar
<span class="nc" id="L78">                    group = findGroup(groupsDB.getGroupsAll(), parentDirId, dirName);</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">                    if (group == null)</span>
                    {
                        //adresar neexistuje, takze to nie je indexovane
<span class="nc" id="L82">                        return(true);</span>
                    }
<span class="nc" id="L84">                    parentDirId = group.getGroupId();</span>
                }
                else
                {
<span class="nc" id="L88">                    int docId = getFileDocId(dirName, parentDirId);</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">                    if (docId &lt; 1) docId = DocDB.getInstance().getDocIdFromURLImpl(url+&quot;.html&quot;, null);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">                    if (docId &gt; 0)</span>
                    {
<span class="nc" id="L92">                        DocDB.deleteDoc(docId, null);</span>
<span class="nc" id="L93">                        return(true);</span>
                    }
<span class="nc" id="L95">                }</span>
            }
        }
<span class="nc" id="L98">        catch (Exception ex)</span>
        {
<span class="nc" id="L100">            sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L101">        }</span>

<span class="nc" id="L103">        return(false);</span>
    }

    /**
     * najde adresar
     * @param groups - array list adresarov
     * @param parentGroupId - id rodicovskeho adresara
     * @param name - meno adresara
     * @return
     */
    public static GroupDetails findGroup(List&lt;GroupDetails&gt; groups, int parentGroupId, String name)
    {
<span class="fc" id="L115">        String domainName = null;</span>
<span class="fc" id="L116">        RequestBean rb = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">        if (rb != null) domainName = rb.getDomain();</span>
<span class="fc" id="L118">        GroupDetails bestMatch = null;</span>
<span class="fc" id="L119">        GroupDetails anyGroup = null;</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">        for (GroupDetails group : groups)</span>
        {
<span class="fc bfc" id="L122" title="All 4 branches covered.">            if (group.getParentGroupId() == parentGroupId &amp;&amp; group.getGroupName().equals(name))</span>
            {
<span class="fc" id="L124">                anyGroup = group;</span>

                //ak este nemame pouzi verziu bez domenoveho mena
<span class="pc bpc" id="L127" title="2 of 4 branches missed.">                if (bestMatch == null &amp;&amp; Tools.isEmpty(group.getDomainName())) bestMatch = group;</span>
                //ak mame aj domenove meno, pouzi verziu s domenovym menom
<span class="pc bpc" id="L129" title="2 of 4 branches missed.">                if (domainName != null &amp;&amp; domainName.equals(group.getDomainName())) {</span>
<span class="fc" id="L130">                    bestMatch = group;</span>
<span class="fc" id="L131">                    break;</span>
                }
            }
<span class="fc" id="L134">        }</span>

<span class="pc bpc" id="L136" title="1 of 2 branches missed.">        if (bestMatch == null) bestMatch = anyGroup;</span>

<span class="fc" id="L138">        return (bestMatch);</span>
    }

    /**
     * Najde docId pre zadany subor v danom adresari
     * @param fileName - nazov suboru (title stranky)
     * @param dirId - id adresara, v ktorom sa to nachadza
     * @return
     */
    public static int getFileDocId(String fileName, int dirId)
    {
<span class="fc" id="L149">        int docId = -1;</span>
<span class="fc" id="L150">        Connection db_conn = null;</span>
<span class="fc" id="L151">        PreparedStatement ps = null;</span>
<span class="fc" id="L152">        ResultSet rs = null;</span>
        try
        {
<span class="fc" id="L155">            db_conn = DBPool.getConnection();</span>
<span class="fc" id="L156">            ps = db_conn.prepareStatement(&quot;SELECT doc_id FROM documents WHERE title=? AND group_id=?&quot;);</span>
<span class="fc" id="L157">            ps.setString(1, fileName);</span>
<span class="fc" id="L158">            ps.setInt(2, dirId);</span>
<span class="fc" id="L159">            rs = ps.executeQuery();</span>
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">            if (rs.next())</span>
            {
<span class="fc" id="L162">                docId = rs.getInt(&quot;doc_id&quot;);</span>
            }
<span class="fc" id="L164">            rs.close();</span>
<span class="fc" id="L165">            ps.close();</span>
<span class="fc" id="L166">            db_conn.close();</span>
<span class="fc" id="L167">            rs = null;</span>
<span class="fc" id="L168">            ps = null;</span>
<span class="fc" id="L169">            db_conn = null;</span>
        }
<span class="nc" id="L171">        catch (Exception ex)</span>
        {
<span class="nc" id="L173">            sk.iway.iwcm.Logger.error(ex);</span>
        }
        finally
        {
            try
            {
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">                if (rs != null)</span>
<span class="nc" id="L180">                    rs.close();</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">                if (ps != null)</span>
<span class="nc" id="L182">                    ps.close();</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">                if (db_conn != null)</span>
<span class="nc" id="L184">                    db_conn.close();</span>
            }
<span class="nc" id="L186">            catch (Exception ex2)</span>
            {
<span class="fc" id="L188">            }</span>
        }

<span class="fc" id="L191">        return(docId);</span>
    }

    /**
     * Ziska URL pre adresarovu strukturu, ktoru chceme vytvorit
     * @param url
     * @return
     */
    public static String getUrlForGroupsTokenize(String url)
    {
        //vytvor Stranku s tymto suborom
<span class="fc" id="L202">        String urlForTokenize = url;</span>
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">        if (Constants.getBoolean(&quot;enableStaticFilesExternalDir&quot;))</span>
        {
<span class="fc" id="L205">            int domainId = CloudToolsForCore.getDomainId();</span>
<span class="fc" id="L206">            GroupDetails domainRootGroup = GroupsDB.getInstance().getGroup(domainId);</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">            if (domainRootGroup!=null)</span>
            {
                ///files adresar vytvarame v domenovom foldri
<span class="fc" id="L210">                urlForTokenize = &quot;/&quot; + domainRootGroup.getGroupName() + url;</span>
            }
        }
<span class="fc" id="L213">        return urlForTokenize;</span>
    }

    public static void indexFile(String url, UserDetails user)
    {
<span class="nc" id="L218">        indexFile(null, url, user);</span>
<span class="nc" id="L219">    }</span>

    public static void indexFile(FileArchivatorBean fileArchivatorBean,String url, UserDetails user)
    {
<span class="nc" id="L223">        Logger.debug(FileIndexerTools.class,&quot;fileArchivatorBean: &quot;+fileArchivatorBean+&quot;, url: &quot;+url+&quot; user: &quot;+user);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">        if (!url.startsWith(&quot;/files/&quot;))</span>
        {
<span class="nc" id="L226">            return;</span>
        }
        try
        {
<span class="nc" id="L230">            String realPath = Tools.getRealPath(url);</span>
<span class="nc" id="L231">            Logger.debug(FileIndexerTools.class,&quot;realPath: &quot;+realPath);</span>
<span class="nc" id="L232">            String data = null;</span>

<span class="nc bnc" id="L234" title="All 2 branches missed.">            if (url.indexOf('.')==-1)</span>
            {
<span class="nc" id="L236">                return;</span>
            }

<span class="nc" id="L239">            String ext = url.substring(url.lastIndexOf('.')).toLowerCase();</span>

            try
            {
<span class="nc" id="L243">                data = getData(url, realPath, data, ext);</span>
            }
<span class="nc" id="L245">            catch (Exception ex)</span>
            {
<span class="nc" id="L247">                sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L248">            }</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">            Logger.debug(FileIndexerTools.class,&quot;data: &quot;+(data != null ? data.length() : &quot;-&quot;));</span>

<span class="nc bnc" id="L251" title="All 4 branches missed.">            if (data != null &amp;&amp; data.trim().length() &gt; 4)</span>
            {
                //mame text, mozeme zaindexovat

                //	uprav data tak, aby neobsahoval haluzne znaky

<span class="nc" id="L257">                Logger.println(FileIndexer.class,&quot;done, size=&quot;+data.length());</span>

<span class="nc" id="L259">                StringTokenizer st = new StringTokenizer(getUrlForGroupsTokenize(url), &quot;/&quot;);</span>
<span class="nc" id="L260">                int parentDirId = 0;</span>
<span class="nc" id="L261">                int parentTempId = 1;</span>
                String dirName;
<span class="nc" id="L263">                GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="nc" id="L264">                GroupDetails group = null;</span>
<span class="nc" id="L265">                int level = 0;</span>
<span class="nc" id="L266">                int sortPriority = Constants.getInt(&quot;fileIndexerSortPriority&quot;);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">                while (st.hasMoreTokens())</span>
                {
<span class="nc" id="L269">                    level++;</span>
<span class="nc" id="L270">                    dirName = st.nextToken();</span>

<span class="nc bnc" id="L272" title="All 4 branches missed.">                    if ((Constants.getBoolean(&quot;multiDomainEnabled&quot;)==false &amp;&amp; level &gt; 1) ||</span>
<span class="nc bnc" id="L273" title="All 4 branches missed.">                            (Constants.getBoolean(&quot;multiDomainEnabled&quot;)==true  &amp;&amp; level &gt; 2))</span>
                    {
                        //automaticke navysovanie priority
<span class="nc" id="L276">                        sortPriority = sortPriority * 10;</span>
                    }

<span class="nc bnc" id="L279" title="All 2 branches missed.">                    if (st.hasMoreTokens())</span>
                    {
<span class="nc" id="L281">                        Logger.debug(FileIndexerTools.class,&quot;dirName: &quot;+dirName);</span>
                        //je to skutocne adresar
<span class="nc" id="L283">                        boolean changed = false;</span>
<span class="nc" id="L284">                        group = findGroup(groupsDB.getGroupsAll(), parentDirId, dirName);</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">                        if (group == null)</span>
                        {
                            //vytvor adresar
<span class="nc" id="L288">                            group = new GroupDetails();</span>
<span class="nc" id="L289">                            changed = true;</span>
                        }
<span class="nc bnc" id="L291" title="All 4 branches missed.">                        if (changed || group.getGroupName().equals(dirName)==false ||</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">                                group.getSortPriority()!=sortPriority)</span>
                        {
<span class="nc bnc" id="L294" title="All 4 branches missed.">                            if (level==1 &amp;&amp; Constants.getBoolean(&quot;enableStaticFilesExternalDir&quot;))</span>
                            {
                                //je to root, s nim nerobime nic
                            }
                            else
                            {
<span class="nc" id="L300">                                group.setGroupName(dirName);</span>
<span class="nc" id="L301">                                group.setNavbar(dirName);</span>
<span class="nc" id="L302">                                group.setParentGroupId(parentDirId);</span>
<span class="nc" id="L303">                                group.setSortPriority(sortPriority);</span>
<span class="nc" id="L304">                                group.setTempId(parentTempId);</span>
<span class="nc" id="L305">                                group.setMenuType(GroupDetails.MENU_TYPE_HIDDEN);</span>

<span class="nc bnc" id="L307" title="All 6 branches missed.">                                if (level==2 &amp;&amp; Constants.getBoolean(&quot;multiDomainEnabled&quot;) &amp;&amp; Constants.getBoolean(&quot;enableStaticFilesExternalDir&quot;)==false)</span>
                                {
                                    //aby sa nam multidomain subfolder nezobrazoval v ceste
<span class="nc" id="L310">                                    group.setNavbar(&quot;&amp;nbsp;&quot;);</span>
<span class="nc" id="L311">                                    group.setUrlDirName(dirName);</span>
                                }

<span class="nc" id="L314">                                groupsDB.setGroup(group);</span>
<span class="nc" id="L315">                                GroupsDB.getInstance(true);</span>
                            }
                        }

<span class="nc" id="L319">                        parentDirId = group.getGroupId();</span>
<span class="nc" id="L320">                        parentTempId = group.getTempId();</span>
<span class="nc" id="L321">                    }</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">                    else if (group != null)</span>
                    {
<span class="nc" id="L324">                        String title = dirName;</span>
<span class="nc" id="L325">                        FileArchivatorBean fab = FileArchivatorDB.getByUrl(url);</span>
<span class="nc" id="L326">                        String domain = null;</span>
                        //pre FA mam domeny, preco to nevyuzit pri hladani docID
<span class="nc bnc" id="L328" title="All 4 branches missed.">                        if(fab != null &amp;&amp; fab.getId() &gt; 0)</span>
                        {
<span class="nc" id="L330">                            title = fab.getVirtualFileName();</span>
<span class="nc" id="L331">                            domain = GroupsDB.getInstance().getDomain(fab.getDomainId());</span>
                        }

<span class="nc" id="L334">                        IwcmFile f = new IwcmFile(realPath);</span>
<span class="nc" id="L335">                        long length = f.length();</span>

                        //uz sme na konci, dirName je uz fileName
<span class="nc" id="L338">                        Logger.println(FileIndexer.class,&quot;Vytvaram stranku: &quot; + dirName);</span>
<span class="nc" id="L339">                        DocDB docDB = DocDB.getInstance();</span>

<span class="nc" id="L341">                        int docId = DocDB.getInstance().getDocIdFromURLImpl(url+&quot;.html&quot;, domain);</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">                        if (docId &lt; 1) docId = getFileDocId(dirName, group.getGroupId());</span>

<span class="nc" id="L344">                        group = groupsDB.getGroup(parentDirId);</span>

<span class="nc" id="L346">                        DocDetails doc = docDB.getDoc(docId);</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">                        if (doc == null)</span>
                        {
<span class="nc" id="L349">                            doc = new DocDetails();</span>
                        }

                        //suborom nastavujem rovnaku pripritu ako je priorita adresara
<span class="nc" id="L353">                        doc.setGroupId(parentDirId);</span>
<span class="nc" id="L354">                        doc.setAuthorId(user.getUserId());</span>
<span class="nc" id="L355">                        doc.setSortPriority(group.getSortPriority());</span>
<span class="nc" id="L356">                        doc.setTitle(title);</span>
<span class="nc" id="L357">                        doc.setData(data);</span>
<span class="nc" id="L358">                        doc.setExternalLink(url);</span>
<span class="nc" id="L359">                        doc.setVirtualPath(url+&quot;.html&quot;);</span>
<span class="nc" id="L360">                        doc.setNavbar(title +  &quot; (&quot;+Tools.formatFileSize(length)+&quot;)&quot;);</span>
<span class="nc" id="L361">                        doc.setAuthorId(user.getUserId());</span>

<span class="nc bnc" id="L363" title="All 4 branches missed.">                        boolean searchable = fab == null || fab.getShowFile();</span>
<span class="nc" id="L364">                        doc.setSearchable(searchable);</span>
<span class="nc" id="L365">                        doc.setAvailable(searchable);</span>

<span class="nc" id="L367">                        doc.setCacheable(false);</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">                        if (group!=null) doc.setTempId(group.getTempId());</span>
<span class="nc" id="L369">                        DocDB.saveDoc(doc);</span>
<span class="nc" id="L370">                        docDB.updateInternalCaches(doc.getDocId());</span>
<span class="nc" id="L371">                    }</span>
                }
            }
        }
<span class="nc" id="L375">        catch (Exception ex)</span>
        {
<span class="nc" id="L377">            sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L378">        }</span>
<span class="nc" id="L379">    }</span>

    /**
     * @param url
     * @param data
     * @return
     * @throws UnsupportedEncodingException
     */
    public static String cleanText(String url, String data)
            throws UnsupportedEncodingException {

<span class="fc bfc" id="L390" title="All 2 branches covered.">        if (data == null)</span>
        {
<span class="fc" id="L392">            return data;</span>
        }

<span class="fc" id="L395">        byte[] buff = data.getBytes(Constants.FILE_ENCODING);</span>
<span class="fc" id="L396">        int size = buff.length;</span>
        int i;
<span class="fc" id="L398">        boolean replaced = false;</span>
<span class="fc bfc" id="L399" title="All 2 branches covered.">        for (i=0; i&lt;size; i++)</span>
        {
<span class="pc bpc" id="L401" title="6 of 8 branches missed.">            if (buff[i]&gt;0 &amp;&amp; buff[i]&lt;32 &amp;&amp; buff[i]!=10 &amp;&amp; buff[i]!=13)</span>
            {
<span class="nc" id="L403">                replaced = true;</span>
<span class="nc" id="L404">                buff[i] = ' ';</span>
            }
        }
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">        if (replaced)</span>
        {
<span class="nc" id="L409">            Logger.println(FileIndexer.class,&quot;FileIndexer: replacing bad data in &quot; + url);</span>
<span class="nc" id="L410">            data = new String(buff, Constants.FILE_ENCODING);</span>
        }

        //uprav rozdelenia slov na konci riadkov (hlavne z PDF)
<span class="fc" id="L414">        data = Tools.replace(data, &quot;\r&quot;, &quot;&quot;);</span>
        //dlha pomlcka za kratku - orpava kodovania na windows-1250
<span class="fc" id="L416">        data = Tools.replace(data, &quot;–&quot;, &quot;-&quot;);</span>
<span class="fc" id="L417">        data = Tools.replace(data, &quot;- \n&quot;, &quot;&quot;);</span>
<span class="fc" id="L418">        data = Tools.replace(data, &quot;-\n&quot;, &quot;&quot;);</span>

<span class="fc" id="L420">        data = Tools.replace(data, &quot;\n&quot;, &quot; &lt;br&gt;\n&quot;);</span>
<span class="fc" id="L421">        data = Tools.replace(data, &quot;FORMTEXT&quot;, &quot;&quot;);</span>
<span class="fc" id="L422">        data = Tools.replace(data, &quot;FORMCHECKBOX&quot;, &quot;&quot;);</span>
<span class="fc" id="L423">        return data;</span>
    }

    /**
     * @param url
     * @param realPath
     * @param data
     * @param ext
     * @return
     */
    public static String getData(String url, String realPath, String data, String ext)
    {
<span class="fc" id="L435">        int maxFileSize = Constants.getInt(&quot;fileIndexerMaxFileSize&quot;);</span>
        //BHR: typy suborov pre ktore nechceme indexovat obsah, napr, zip, rar a pod., sluzi napr ak ho chceme mat indexovany len kvoli statistike zobrazeni
<span class="fc" id="L437">        String fileIndexerNoDataFileExtension = Constants.getString(&quot;fileIndexerNoDataFileExtension&quot;);</span>

<span class="fc" id="L439">        IwcmFile file = new IwcmFile(realPath);</span>

<span class="pc bpc" id="L441" title="2 of 4 branches missed.">        if (maxFileSize &lt; 1 || file.length() &lt; maxFileSize )</span>
        {
<span class="pc bpc" id="L443" title="2 of 4 branches missed.">            if(fileIndexerNoDataFileExtension != null &amp;&amp; Arrays.stream(Tools.getTokens(fileIndexerNoDataFileExtension,&quot;,&quot;)).anyMatch(ext::equals))</span>
            {
<span class="nc" id="L445">                data = &quot;&lt;p&gt;&quot;+ FileTools.getFileNameWithoutExtension(url)+&quot;&lt;/p&gt;&quot;;</span>
            }
            else
            {
<span class="pc bpc" id="L449" title="3 of 6 branches missed.">                if (&quot;.doc&quot;.equals(ext) || &quot;.docx&quot;.equals(ext) || &quot;.dot&quot;.equals(ext) ||</span>
<span class="pc bpc" id="L450" title="3 of 6 branches missed.">                &quot;.xls&quot;.equals(ext) || &quot;.xlsx&quot;.equals(ext) || &quot;.xlt&quot;.equals(ext) ||</span>
<span class="pc bpc" id="L451" title="5 of 10 branches missed.">                &quot;.ppt&quot;.equals(ext) || &quot;.pptx&quot;.equals(ext) || &quot;.pot&quot;.equals(ext) || &quot;.pps&quot;.equals(ext) || &quot;.ppsx&quot;.equals(ext))</span>
                {
<span class="nc" id="L453">                    data = PoiExtractor.getText(realPath);</span>
                }
<span class="pc bpc" id="L455" title="1 of 2 branches missed.">                else if (&quot;.doc&quot;.equals(ext))</span>
                {
<span class="nc" id="L457">                    data = Word.getText(realPath);</span>
                }
<span class="pc bpc" id="L459" title="1 of 2 branches missed.">                else if (&quot;.xls&quot;.equals(ext))</span>
                {
<span class="nc" id="L461">                    data = Excel.getText(realPath);</span>
                }
<span class="pc bpc" id="L463" title="1 of 2 branches missed.">                else if (&quot;.pdf&quot;.equals(ext))</span>
                {
<span class="nc" id="L465">                    data = PDF.getText(realPath);</span>
                }
<span class="pc bpc" id="L467" title="1 of 2 branches missed.">                else if (&quot;.rtf&quot;.equals(ext))</span>
                {
<span class="nc" id="L469">                    data = Rtf.getText(realPath);</span>
                }
<span class="pc bpc" id="L471" title="2 of 6 branches missed.">                else if (&quot;.txt&quot;.equals(ext) || &quot;.csv&quot;.equals(ext) || &quot;.xml&quot;.equals(ext))</span>
                {
<span class="fc" id="L473">                    data = FileTools.readFileContent(url);</span>
                }
<span class="pc bpc" id="L475" title="1 of 2 branches missed.">                else if(&quot;.zip&quot;.equals(ext))</span>
                {
<span class="nc" id="L477">                    data = getArchiveData(url, realPath, ext);</span>
                }
            }
        }
        else
        {
<span class="nc" id="L483">            data = &quot;&lt;p&gt;&quot;+ FileTools.getFileNameWithoutExtension(url)+&quot;&lt;/p&gt;&quot;;</span>
        }

<span class="pc bpc" id="L486" title="1 of 4 branches missed.">        if (Tools.isEmpty(data) &amp;&amp; Constants.getBoolean(&quot;fileIndexerIndexAllFiles&quot;))</span>
        {
<span class="nc bnc" id="L488" title="All 2 branches missed.">            if(url.startsWith(&quot;/files/&quot;))</span>
<span class="nc" id="L489">                data = &quot;&lt;p&gt;&lt;a href='&quot;+url+&quot;'&gt;&quot;+url+&quot;&lt;/p&gt;&quot;;</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">            else if(url.startsWith(&quot;/WEB-INF/&quot;))</span>
<span class="nc" id="L491">                data = &quot;&lt;p&gt;&quot;+ FileTools.getFileNameWithoutExtension(url)+&quot;&lt;/p&gt;&quot;;</span>
        }

        try {
<span class="fc" id="L495">            data = cleanText(url, data);</span>
<span class="nc" id="L496">        } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L497">            sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L498">        }</span>

<span class="fc" id="L500">        return data;</span>
    }

    private static String getArchiveData(String zipUrl, String realPath, String ext)
    {
<span class="nc" id="L505">        String data = &quot;&quot;;</span>

<span class="nc" id="L507">        String tempUrl = &quot;/WEB-INF/tmp/fileindexer/&quot;+ Password.generatePassword(5)+(new Date().getTime())+&quot;/&quot;;</span>
<span class="nc" id="L508">        String realTempUrl = Tools.getRealPath(tempUrl);</span>
        try
        {
<span class="nc bnc" id="L511" title="All 2 branches missed.">            if(&quot;.zip&quot;.equals(ext))</span>
            {
<span class="nc" id="L513">                IwcmInputStream fis = new IwcmInputStream(realPath);</span>
<span class="nc" id="L514">                ZipInputStream zis = new ZipInputStream(new BufferedInputStream(fis));</span>
                ZipEntry entry;

<span class="nc bnc" id="L517" title="All 2 branches missed.">                while((entry = zis.getNextEntry()) != null)</span>
                {
<span class="nc" id="L519">                    Logger.debug(FileIndexer.class, &quot;Extracting: &quot;+entry);</span>

<span class="nc" id="L521">                    String url = tempUrl;</span>

<span class="nc" id="L523">                    url += entry.getName();</span>

<span class="nc" id="L525">                    final String fullEntryPath = Tools.getRealPath(url);</span>

<span class="nc bnc" id="L527" title="All 2 branches missed.">                    if(entry.getName().endsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L528">                        new IwcmFile(fullEntryPath).mkdirs();</span>
<span class="nc" id="L529">                        continue;</span>
                    }
                    else
                    {
<span class="nc" id="L533">                        IwcmFile f = new IwcmFile(fullEntryPath);</span>
<span class="nc" id="L534">                        IwcmFile parent = f.getParentFile();</span>
<span class="nc" id="L535">                        parent.mkdirs();</span>
                    }

<span class="nc" id="L538">                    IwcmFsDB.writeFiletoDest(zis, new File(fullEntryPath), (int)entry.getSize(), false);</span>
<span class="nc" id="L539">                }</span>
<span class="nc" id="L540">                zis.close();</span>
            }
            /*else if(&quot;.rar&quot;.equals(ext))
            {
                File rarFile=new File(realTempUrl);
                if(rarFile.mkdirs() == false)
                    throw new SecurityException(&quot;Unable to create dirs: &quot;+realTempUrl);
                rarFile=new File(realPath);
                final ReadOnlyAccessFile readOnlyAccessFile = new ReadOnlyAccessFile(rarFile);

                final Archive archive = new Archive(readOnlyAccessFile);
                final List&lt;FileHeader&gt; fileHeaders = archive.getFileHeaders();
                for (FileHeader fileHeader : fileHeaders)
                {
                    final String fileNameString = fileHeader.getFileNameString();
                    //write the files to the disk
                    Logger.println(FileIndexer.class,&quot;Unrarring: &quot; + fileNameString);

                    IwcmFile outFile = new IwcmFile(realTempUrl, fileNameString);

                    final IwcmFile parentFolder = outFile.getParentFile();

                    parentFolder.mkdirs();
                    IwcmOutputStream outStream=new IwcmOutputStream(outFile.getAbsolutePath());
                    archive.extractFile(fileHeader,outStream);
                    outStream.close();
                }
                readOnlyAccessFile.close();
            }*/
<span class="nc" id="L569">            IwcmFile tempDir = new IwcmFile(realTempUrl);</span>
<span class="nc" id="L570">            data = getTempDirData(tempDir);</span>
        }
<span class="nc" id="L572">        catch (Exception e)</span>
        {
<span class="nc" id="L574">            sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L575">        }</span>

<span class="nc" id="L577">        return data;</span>
    }

    private static String getTempDirData(IwcmFile dir)
    {
<span class="nc" id="L582">        StringBuilder data=new StringBuilder();</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">        if(dir.isDirectory())</span>
        {
<span class="nc bnc" id="L585" title="All 2 branches missed.">            for(IwcmFile file : dir.listFiles())</span>
            {
<span class="nc bnc" id="L587" title="All 2 branches missed.">                if(file.isDirectory())</span>
                {
<span class="nc" id="L589">                    data.append(getTempDirData(file));</span>
                }
                else
                {
<span class="nc" id="L593">                    String url = file.getVirtualPath();</span>

<span class="nc bnc" id="L595" title="All 2 branches missed.">                    if (url.indexOf('.') &gt; -1)</span>
                    {
<span class="nc" id="L597">                        String ext = url.substring(url.lastIndexOf('.')).toLowerCase();</span>
<span class="nc" id="L598">                        data.append(getData(url, file.getAbsolutePath(), data.toString(), ext)).append('\n');</span>
                    }
                }
<span class="nc" id="L601">                file.delete();</span>
            }
        }
<span class="nc" id="L604">        dir.delete();</span>
<span class="nc" id="L605">        return data.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>